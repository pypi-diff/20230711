# Comparing `tmp/grizli-1.8.9.tar.gz` & `tmp/grizli-1.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "grizli-1.8.9.tar", last modified: Tue May 16 09:47:28 2023, max compression
+gzip compressed data, was "grizli-1.9.tar", last modified: Tue Jul 11 20:02:22 2023, max compression
```

## Comparing `grizli-1.8.9.tar` & `grizli-1.9.tar`

### file list

```diff
@@ -1,206 +1,211 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.667017 grizli-1.8.9/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.595017 grizli-1.8.9/.github/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.603017 grizli-1.8.9/.github/workflows/
--rw-r--r--   0 runner    (1001) docker     (123)     1594 2023-05-16 09:47:13.000000 grizli-1.8.9/.github/workflows/publish-to-pypi.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1742 2023-05-16 09:47:13.000000 grizli-1.8.9/.github/workflows/python-package-ero.yml
--rw-r--r--   0 runner    (1001) docker     (123)      926 2023-05-16 09:47:13.000000 grizli-1.8.9/.github/workflows/python-package-with-jwst.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1797 2023-05-16 09:47:13.000000 grizli-1.8.9/.github/workflows/python-package.yml
--rw-r--r--   0 runner    (1001) docker     (123)      936 2023-05-16 09:47:13.000000 grizli-1.8.9/.gitignore
--rw-r--r--   0 runner    (1001) docker     (123)      556 2023-05-16 09:47:13.000000 grizli-1.8.9/.readthedocs.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1094 2023-05-16 09:47:13.000000 grizli-1.8.9/.travis.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1089 2023-05-16 09:47:13.000000 grizli-1.8.9/CHANGES.rst
--rw-r--r--   0 runner    (1001) docker     (123)     1180 2023-05-16 09:47:13.000000 grizli-1.8.9/CITATION.cff
--rw-r--r--   0 runner    (1001) docker     (123)     1084 2023-05-16 09:47:13.000000 grizli-1.8.9/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-05-16 09:47:28.667017 grizli-1.8.9/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6095 2023-05-16 09:47:13.000000 grizli-1.8.9/README.rst
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.607017 grizli-1.8.9/docs/
--rw-r--r--   0 runner    (1001) docker     (123)     4581 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/Makefile
--rw-r--r--   0 runner    (1001) docker     (123)      111 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/README.rst
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.607017 grizli-1.8.9/docs/_static/
--rw-r--r--   0 runner    (1001) docker     (123)     4286 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_static/grizli.ico
--rw-r--r--   0 runner    (1001) docker     (123)      986 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_static/grizli_favico.png
--rw-r--r--   0 runner    (1001) docker     (123)    35735 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_static/grizli_favico_large.png
--rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_static/grizli_logo.pdf
--rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_static/grizli_logo.png
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.595017 grizli-1.8.9/docs/_templates/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.607017 grizli-1.8.9/docs/_templates/autosummary/
--rw-r--r--   0 runner    (1001) docker     (123)      250 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_templates/autosummary/base.rst
--rw-r--r--   0 runner    (1001) docker     (123)      251 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_templates/autosummary/class.rst
--rw-r--r--   0 runner    (1001) docker     (123)      252 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/_templates/autosummary/module.rst
--rw-r--r--   0 runner    (1001) docker     (123)       75 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/changelog.rst
--rw-r--r--   0 runner    (1001) docker     (123)     6794 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/conf.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.611017 grizli-1.8.9/docs/grizli/
--rw-r--r--   0 runner    (1001) docker     (123)       86 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/basic.rst
--rw-r--r--   0 runner    (1001) docker     (123)   851247 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/ceers-sm.field.jpg
--rw-r--r--   0 runner    (1001) docker     (123)    98779 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/image-release-v6.md
--rw-r--r--   0 runner    (1001) docker     (123)    65882 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/image-release-v6.rst
--rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/index.rst
--rw-r--r--   0 runner    (1001) docker     (123)     7704 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/install.rst
--rw-r--r--   0 runner    (1001) docker     (123)      676 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli/prep.rst
--rw-r--r--   0 runner    (1001) docker     (123)    38260 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/grizli-for-dummies.rst
--rw-r--r--   0 runner    (1001) docker     (123)     6655 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/index.rst
--rw-r--r--   0 runner    (1001) docker     (123)     4549 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/make.bat
--rw-r--r--   0 runner    (1001) docker     (123)      154 2023-05-16 09:47:13.000000 grizli-1.8.9/docs/rtd-pip-requirements
--rw-r--r--   0 runner    (1001) docker     (123)      189 2023-05-16 09:47:13.000000 grizli-1.8.9/environment.yml
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.611017 grizli-1.8.9/examples/
--rw-r--r--   0 runner    (1001) docker     (123)      257 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/README.md
--rw-r--r--   0 runner    (1001) docker     (123)     6880 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/demo.py
--rw-r--r--   0 runner    (1001) docker     (123)    20658 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/grizli_demo_0.pdf
--rw-r--r--   0 runner    (1001) docker     (123)   100981 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/grizli_demo_1.pdf
--rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/grizli_logo.pdf
--rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-05-16 09:47:13.000000 grizli-1.8.9/examples/grizli_logo.png
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.619017 grizli-1.8.9/grizli/
--rw-r--r--   0 runner    (1001) docker     (123)      748 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.623017 grizli-1.8.9/grizli/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      137 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    46017 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/aws_drizzler.py
--rw-r--r--   0 runner    (1001) docker     (123)   131901 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/db.py
--rw-r--r--   0 runner    (1001) docker     (123)    45124 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/field_tiles.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     9609 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/fit_redshift_lambda.py
--rw-r--r--   0 runner    (1001) docker     (123)    32497 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/lambda_handler.py
--rw-r--r--   0 runner    (1001) docker     (123)    56360 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/tile_mosaic.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    75867 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/aws/visit_processor.py
--rw-r--r--   0 runner    (1001) docker     (123)    40400 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    19411 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/combine.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.631017 grizli-1.8.9/grizli/data/
--rw-r--r--   0 runner    (1001) docker     (123)     9269 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/auto_script_defaults.yml
--rw-r--r--   0 runner    (1001) docker     (123)      107 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/db.yml
--rw-r--r--   0 runner    (1001) docker     (123)     3639 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/gaia_dr2_vizier_columns.txt
--rw-r--r--   0 runner    (1001) docker     (123)    20160 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/hst_encircled_energy.fits
--rw-r--r--   0 runner    (1001) docker     (123)    11962 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/jwst_bp_info.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1167 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nircam_wisp.yml
--rw-r--r--   0 runner    (1001) docker     (123)    47343 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    39840 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    17258 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16916 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16627 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16943 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    35486 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    18003 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16764 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16962 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16851 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    22659 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)     5043 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/photom_correction.yml
--rw-r--r--   0 runner    (1001) docker     (123)    97707 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/sep_catalog_junk.pkl
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.635017 grizli-1.8.9/grizli/data/templates/
--rw-r--r--   0 runner    (1001) docker     (123)    94256 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/FeII_VeronCetty2004.txt
--rw-r--r--   0 runner    (1001) docker     (123)      654 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/README
--rw-r--r--   0 runner    (1001) docker     (123)   221907 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/alf_SSP.dat
--rw-r--r--   0 runner    (1001) docker     (123)    48158 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/cvd12_t11_solar_Chabrier.dat
--rw-r--r--   0 runner    (1001) docker     (123)    51300 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/eazy_intermediate.dat
--rw-r--r--   0 runner    (1001) docker     (123)    44824 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/erb2010.dat
--rw-r--r--   0 runner    (1001) docker     (123)    31746 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/erb2010_continuum.dat
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.647017 grizli-1.8.9/grizli/data/templates/fsps/
--rw-r--r--   0 runner    (1001) docker     (123)      591 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param
--rw-r--r--   0 runner    (1001) docker     (123)    11520 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits
--rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat
--rw-r--r--   0 runner    (1001) docker     (123)      687 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param
--rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat
--rw-r--r--   0 runner    (1001) docker     (123)   143958 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/fsps_starburst_lines.txt
--rw-r--r--   0 runner    (1001) docker     (123)    12636 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/post_starburst.dat
--rw-r--r--   0 runner    (1001) docker     (123)   557728 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/quasar_lines.txt
--rw-r--r--   0 runner    (1001) docker     (123)   382216 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/red_blue_continuum.txt
--rw-r--r--   0 runner    (1001) docker     (123)   381266 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/red_blue_continuum_noLya.txt
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.655017 grizli-1.8.9/grizli/data/templates/stars/
--rw-r--r--   0 runner    (1001) docker     (123)   173069 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/L1.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)   145419 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/L3.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)    26044 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/L6.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)   159659 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/M6.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)   166768 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/M8.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)    57965 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/T2.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)    55327 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/T6.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)     8115 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/T7.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)  3193920 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits
--rw-r--r--   0 runner    (1001) docker     (123)    83291 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/carbon_star.txt
--rw-r--r--   0 runner    (1001) docker     (123)      175 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/templates/stars/stars_settl.param
--rw-r--r--   0 runner    (1001) docker     (123)   299891 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/visit_alignment.txt
--rw-r--r--   0 runner    (1001) docker     (123)    54096 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    23739 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)     1057 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/data/wfc3ir_ee.txt
--rw-r--r--   0 runner    (1001) docker     (123)     5521 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/ds9.py
--rw-r--r--   0 runner    (1001) docker     (123)    17575 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/fake_image.py
--rw-r--r--   0 runner    (1001) docker     (123)   185637 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/fitting.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.655017 grizli-1.8.9/grizli/galfit/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/galfit/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    15242 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/galfit/deconvolve.py
--rw-r--r--   0 runner    (1001) docker     (123)    25223 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/galfit/galfit.py
--rw-r--r--   0 runner    (1001) docker     (123)     4926 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/galfit/gfutils.py
--rw-r--r--   0 runner    (1001) docker     (123)    16595 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/galfit/psf.py
--rw-r--r--   0 runner    (1001) docker     (123)    39980 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/grismconf.py
--rw-r--r--   0 runner    (1001) docker     (123)    35836 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/jwst_level1.py
--rw-r--r--   0 runner    (1001) docker     (123)    77490 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/jwst_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   203738 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/model.py
--rw-r--r--   0 runner    (1001) docker     (123)   203978 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/multifit.py
--rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/nbutils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.659017 grizli-1.8.9/grizli/pipeline/
--rw-r--r--   0 runner    (1001) docker     (123)     1147 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   223351 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/auto_script.py
--rw-r--r--   0 runner    (1001) docker     (123)     8267 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/default_params.py
--rw-r--r--   0 runner    (1001) docker     (123)    32411 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/photoz.py
--rw-r--r--   0 runner    (1001) docker     (123)     6729 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/reprocess.py
--rw-r--r--   0 runner    (1001) docker     (123)     1485 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/run_MPI.py
--rw-r--r--   0 runner    (1001) docker     (123)     8973 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/pipeline/summary.py
--rw-r--r--   0 runner    (1001) docker     (123)   248025 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/prep.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    49392 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/stack.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.659017 grizli-1.8.9/grizli/tests/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.663017 grizli-1.8.9/grizli/tests/data/
--rw-r--r--   0 runner    (1001) docker     (123)     1576 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/fit_args.npy
--rw-r--r--   0 runner    (1001) docker     (123)   812160 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/j033216m2743_00152.beams.fits
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.667017 grizli-1.8.9/grizli/tests/data/jwst-headers/
--rw-r--r--   0 runner    (1001) docker     (123)      116 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/README.rst
--rw-r--r--   0 runner    (1001) docker     (123)    28024 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47863 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47877 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47996 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47827 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)      546 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/jwst-headers/strip_data.py
--rw-r--r--   0 runner    (1001) docker     (123)   509760 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/niriss_jw01324001001_test.beams.fits
--rw-r--r--   0 runner    (1001) docker     (123)  1120244 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/data/wfc3-parse-test.tar.gz
--rw-r--r--   0 runner    (1001) docker     (123)     2800 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_autoscript.py
--rw-r--r--   0 runner    (1001) docker     (123)      832 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_cutils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2478 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_fits.py
--rw-r--r--   0 runner    (1001) docker     (123)     1895 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_grismconf.py
--rw-r--r--   0 runner    (1001) docker     (123)     8532 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_jwst.py
--rw-r--r--   0 runner    (1001) docker     (123)     8525 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/tests/test_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   298264 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.667017 grizli-1.8.9/grizli/utils_c/
--rw-r--r--   0 runner    (1001) docker     (123)      178 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/utils_c/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   334421 2023-05-16 09:47:27.000000 grizli-1.8.9/grizli/utils_c/disperse.c
--rw-r--r--   0 runner    (1001) docker     (123)     4083 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/utils_c/disperse.pyx
--rw-r--r--   0 runner    (1001) docker     (123)   659013 2023-05-16 09:47:27.000000 grizli-1.8.9/grizli/utils_c/interp.c
--rw-r--r--   0 runner    (1001) docker     (123)    16229 2023-05-16 09:47:13.000000 grizli-1.8.9/grizli/utils_c/interp.pyx
--rw-r--r--   0 runner    (1001) docker     (123)      160 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli/version.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-16 09:47:28.619017 grizli-1.8.9/grizli.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6377 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)      423 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        7 2023-05-16 09:47:28.000000 grizli-1.8.9/grizli.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)      229 2023-05-16 09:47:13.000000 grizli-1.8.9/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)     1765 2023-05-16 09:47:28.667017 grizli-1.8.9/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)      841 2023-05-16 09:47:13.000000 grizli-1.8.9/setup.py
--rw-r--r--   0 runner    (1001) docker     (123)    13630 2023-05-16 09:47:13.000000 grizli-1.8.9/test_pipeline_hst.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.779851 grizli-1.9/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.719851 grizli-1.9/.github/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.727851 grizli-1.9/.github/workflows/
+-rw-r--r--   0 runner    (1001) docker     (123)     1594 2023-07-11 20:02:07.000000 grizli-1.9/.github/workflows/publish-to-pypi.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1742 2023-07-11 20:02:07.000000 grizli-1.9/.github/workflows/python-package-ero.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      926 2023-07-11 20:02:07.000000 grizli-1.9/.github/workflows/python-package-with-jwst.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1797 2023-07-11 20:02:07.000000 grizli-1.9/.github/workflows/python-package.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      936 2023-07-11 20:02:07.000000 grizli-1.9/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (123)      556 2023-07-11 20:02:07.000000 grizli-1.9/.readthedocs.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1094 2023-07-11 20:02:07.000000 grizli-1.9/.travis.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1089 2023-07-11 20:02:07.000000 grizli-1.9/CHANGES.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     1180 2023-07-11 20:02:07.000000 grizli-1.9/CITATION.cff
+-rw-r--r--   0 runner    (1001) docker     (123)     1084 2023-07-11 20:02:07.000000 grizli-1.9/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     6825 2023-07-11 20:02:22.779851 grizli-1.9/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6095 2023-07-11 20:02:07.000000 grizli-1.9/README.rst
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.727851 grizli-1.9/docs/
+-rw-r--r--   0 runner    (1001) docker     (123)     4581 2023-07-11 20:02:07.000000 grizli-1.9/docs/Makefile
+-rw-r--r--   0 runner    (1001) docker     (123)      111 2023-07-11 20:02:07.000000 grizli-1.9/docs/README.rst
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.727851 grizli-1.9/docs/_static/
+-rw-r--r--   0 runner    (1001) docker     (123)     4286 2023-07-11 20:02:07.000000 grizli-1.9/docs/_static/grizli.ico
+-rw-r--r--   0 runner    (1001) docker     (123)      986 2023-07-11 20:02:07.000000 grizli-1.9/docs/_static/grizli_favico.png
+-rw-r--r--   0 runner    (1001) docker     (123)    35735 2023-07-11 20:02:07.000000 grizli-1.9/docs/_static/grizli_favico_large.png
+-rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-07-11 20:02:07.000000 grizli-1.9/docs/_static/grizli_logo.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-07-11 20:02:07.000000 grizli-1.9/docs/_static/grizli_logo.png
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.719851 grizli-1.9/docs/_templates/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.727851 grizli-1.9/docs/_templates/autosummary/
+-rw-r--r--   0 runner    (1001) docker     (123)      250 2023-07-11 20:02:07.000000 grizli-1.9/docs/_templates/autosummary/base.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      251 2023-07-11 20:02:07.000000 grizli-1.9/docs/_templates/autosummary/class.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      252 2023-07-11 20:02:07.000000 grizli-1.9/docs/_templates/autosummary/module.rst
+-rw-r--r--   0 runner    (1001) docker     (123)       75 2023-07-11 20:02:07.000000 grizli-1.9/docs/changelog.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     6794 2023-07-11 20:02:07.000000 grizli-1.9/docs/conf.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.731851 grizli-1.9/docs/grizli/
+-rw-r--r--   0 runner    (1001) docker     (123)       86 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/basic.rst
+-rw-r--r--   0 runner    (1001) docker     (123)   851247 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/ceers-sm.field.jpg
+-rw-r--r--   0 runner    (1001) docker     (123)    98779 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/image-release-v6.md
+-rw-r--r--   0 runner    (1001) docker     (123)    65882 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/image-release-v6.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/index.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     7704 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/install.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      676 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli/prep.rst
+-rw-r--r--   0 runner    (1001) docker     (123)    38260 2023-07-11 20:02:07.000000 grizli-1.9/docs/grizli-for-dummies.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     6655 2023-07-11 20:02:07.000000 grizli-1.9/docs/index.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     4549 2023-07-11 20:02:07.000000 grizli-1.9/docs/make.bat
+-rw-r--r--   0 runner    (1001) docker     (123)      154 2023-07-11 20:02:07.000000 grizli-1.9/docs/rtd-pip-requirements
+-rw-r--r--   0 runner    (1001) docker     (123)      189 2023-07-11 20:02:07.000000 grizli-1.9/environment.yml
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.731851 grizli-1.9/examples/
+-rw-r--r--   0 runner    (1001) docker     (123)      257 2023-07-11 20:02:07.000000 grizli-1.9/examples/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)     6880 2023-07-11 20:02:07.000000 grizli-1.9/examples/demo.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20658 2023-07-11 20:02:07.000000 grizli-1.9/examples/grizli_demo_0.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)   100981 2023-07-11 20:02:07.000000 grizli-1.9/examples/grizli_demo_1.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-07-11 20:02:07.000000 grizli-1.9/examples/grizli_logo.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-07-11 20:02:07.000000 grizli-1.9/examples/grizli_logo.png
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.735851 grizli-1.9/grizli/
+-rw-r--r--   0 runner    (1001) docker     (123)      748 2023-07-11 20:02:07.000000 grizli-1.9/grizli/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.739851 grizli-1.9/grizli/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      137 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    46339 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/aws_drizzler.py
+-rw-r--r--   0 runner    (1001) docker     (123)   131901 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/db.py
+-rw-r--r--   0 runner    (1001) docker     (123)    45124 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/field_tiles.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     9609 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/fit_redshift_lambda.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32480 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/lambda_handler.py
+-rw-r--r--   0 runner    (1001) docker     (123)    56360 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/tile_mosaic.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    89873 2023-07-11 20:02:07.000000 grizli-1.9/grizli/aws/visit_processor.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40400 2023-07-11 20:02:07.000000 grizli-1.9/grizli/catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19411 2023-07-11 20:02:07.000000 grizli-1.9/grizli/combine.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.747851 grizli-1.9/grizli/data/
+-rw-r--r--   0 runner    (1001) docker     (123)     9295 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/auto_script_defaults.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      107 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/db.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     3639 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/gaia_dr2_vizier_columns.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    20160 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/hst_encircled_energy.fits
+-rw-r--r--   0 runner    (1001) docker     (123)    11962 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/jwst_bp_info.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1167 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nircam_wisp.yml
+-rw-r--r--   0 runner    (1001) docker     (123)   126417 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nis_badpix_20230710.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)   132526 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_20230710_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)   108369 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_20230710_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47343 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    39840 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    48187 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_230701_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    40431 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_badpix_230701_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    17258 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16916 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16627 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16943 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    35486 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    18003 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16764 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16962 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16851 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    22659 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     5043 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/photom_correction.yml
+-rw-r--r--   0 runner    (1001) docker     (123)    97707 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/sep_catalog_junk.pkl
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.751851 grizli-1.9/grizli/data/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)    94256 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/FeII_VeronCetty2004.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      654 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/README
+-rw-r--r--   0 runner    (1001) docker     (123)   221907 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/alf_SSP.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    48158 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/cvd12_t11_solar_Chabrier.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    51300 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/eazy_intermediate.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    44824 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/erb2010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    31746 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/erb2010_continuum.dat
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.759851 grizli-1.9/grizli/data/templates/fsps/
+-rw-r--r--   0 runner    (1001) docker     (123)      591 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param
+-rw-r--r--   0 runner    (1001) docker     (123)    11520 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits
+-rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat
+-rw-r--r--   0 runner    (1001) docker     (123)      687 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param
+-rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   143958 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/fsps_starburst_lines.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    12636 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/post_starburst.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   557728 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/quasar_lines.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   382216 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/red_blue_continuum.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   381266 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/red_blue_continuum_noLya.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.767851 grizli-1.9/grizli/data/templates/stars/
+-rw-r--r--   0 runner    (1001) docker     (123)   173069 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/L1.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   145419 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/L3.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    26044 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/L6.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   159659 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/M6.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   166768 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/M8.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    57965 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/T2.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    55327 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/T6.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     8115 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/T7.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)  3193920 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits
+-rw-r--r--   0 runner    (1001) docker     (123)    83291 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/carbon_star.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      175 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/templates/stars/stars_settl.param
+-rw-r--r--   0 runner    (1001) docker     (123)   299891 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/visit_alignment.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    54096 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    23739 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     1057 2023-07-11 20:02:07.000000 grizli-1.9/grizli/data/wfc3ir_ee.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     5521 2023-07-11 20:02:07.000000 grizli-1.9/grizli/ds9.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17575 2023-07-11 20:02:07.000000 grizli-1.9/grizli/fake_image.py
+-rw-r--r--   0 runner    (1001) docker     (123)   185637 2023-07-11 20:02:07.000000 grizli-1.9/grizli/fitting.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.767851 grizli-1.9/grizli/galfit/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:07.000000 grizli-1.9/grizli/galfit/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15242 2023-07-11 20:02:07.000000 grizli-1.9/grizli/galfit/deconvolve.py
+-rw-r--r--   0 runner    (1001) docker     (123)    25223 2023-07-11 20:02:07.000000 grizli-1.9/grizli/galfit/galfit.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4926 2023-07-11 20:02:07.000000 grizli-1.9/grizli/galfit/gfutils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16595 2023-07-11 20:02:07.000000 grizli-1.9/grizli/galfit/psf.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40681 2023-07-11 20:02:07.000000 grizli-1.9/grizli/grismconf.py
+-rw-r--r--   0 runner    (1001) docker     (123)    35836 2023-07-11 20:02:07.000000 grizli-1.9/grizli/jwst_level1.py
+-rw-r--r--   0 runner    (1001) docker     (123)    77490 2023-07-11 20:02:07.000000 grizli-1.9/grizli/jwst_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   203738 2023-07-11 20:02:07.000000 grizli-1.9/grizli/model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   204523 2023-07-11 20:02:07.000000 grizli-1.9/grizli/multifit.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-07-11 20:02:07.000000 grizli-1.9/grizli/nbutils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.767851 grizli-1.9/grizli/pipeline/
+-rw-r--r--   0 runner    (1001) docker     (123)     1147 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   225369 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/auto_script.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8267 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/default_params.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32411 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/photoz.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6729 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/reprocess.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1485 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/run_MPI.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8973 2023-07-11 20:02:07.000000 grizli-1.9/grizli/pipeline/summary.py
+-rw-r--r--   0 runner    (1001) docker     (123)   259968 2023-07-11 20:02:07.000000 grizli-1.9/grizli/prep.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    49392 2023-07-11 20:02:07.000000 grizli-1.9/grizli/stack.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.771851 grizli-1.9/grizli/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.771851 grizli-1.9/grizli/tests/data/
+-rw-r--r--   0 runner    (1001) docker     (123)     1576 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/fit_args.npy
+-rw-r--r--   0 runner    (1001) docker     (123)   812160 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/j033216m2743_00152.beams.fits
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.775851 grizli-1.9/grizli/tests/data/jwst-headers/
+-rw-r--r--   0 runner    (1001) docker     (123)      116 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/README.rst
+-rw-r--r--   0 runner    (1001) docker     (123)    28024 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47863 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47877 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47996 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47827 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)      546 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/jwst-headers/strip_data.py
+-rw-r--r--   0 runner    (1001) docker     (123)   509760 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/niriss_jw01324001001_test.beams.fits
+-rw-r--r--   0 runner    (1001) docker     (123)  1120244 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/data/wfc3-parse-test.tar.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     2800 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_autoscript.py
+-rw-r--r--   0 runner    (1001) docker     (123)      832 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_cutils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2478 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_fits.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1895 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_grismconf.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8532 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_jwst.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8525 2023-07-11 20:02:07.000000 grizli-1.9/grizli/tests/test_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   304261 2023-07-11 20:02:07.000000 grizli-1.9/grizli/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.779851 grizli-1.9/grizli/utils_c/
+-rw-r--r--   0 runner    (1001) docker     (123)      178 2023-07-11 20:02:07.000000 grizli-1.9/grizli/utils_c/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   335228 2023-07-11 20:02:21.000000 grizli-1.9/grizli/utils_c/disperse.c
+-rw-r--r--   0 runner    (1001) docker     (123)     4083 2023-07-11 20:02:07.000000 grizli-1.9/grizli/utils_c/disperse.pyx
+-rw-r--r--   0 runner    (1001) docker     (123)   659882 2023-07-11 20:02:21.000000 grizli-1.9/grizli/utils_c/interp.c
+-rw-r--r--   0 runner    (1001) docker     (123)    16229 2023-07-11 20:02:07.000000 grizli-1.9/grizli/utils_c/interp.pyx
+-rw-r--r--   0 runner    (1001) docker     (123)      155 2023-07-11 20:02:22.000000 grizli-1.9/grizli/version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-11 20:02:22.739851 grizli-1.9/grizli.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     6825 2023-07-11 20:02:22.000000 grizli-1.9/grizli.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6609 2023-07-11 20:02:22.000000 grizli-1.9/grizli.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-11 20:02:22.000000 grizli-1.9/grizli.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      430 2023-07-11 20:02:22.000000 grizli-1.9/grizli.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        7 2023-07-11 20:02:22.000000 grizli-1.9/grizli.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      229 2023-07-11 20:02:07.000000 grizli-1.9/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)     1772 2023-07-11 20:02:22.779851 grizli-1.9/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)      841 2023-07-11 20:02:07.000000 grizli-1.9/setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13630 2023-07-11 20:02:07.000000 grizli-1.9/test_pipeline_hst.py
```

### Comparing `grizli-1.8.9/.github/workflows/publish-to-pypi.yml` & `grizli-1.9/.github/workflows/publish-to-pypi.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.github/workflows/python-package-ero.yml` & `grizli-1.9/.github/workflows/python-package-ero.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.github/workflows/python-package-with-jwst.yml` & `grizli-1.9/.github/workflows/python-package-with-jwst.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.github/workflows/python-package.yml` & `grizli-1.9/.github/workflows/python-package.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.gitignore` & `grizli-1.9/.gitignore`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.readthedocs.yml` & `grizli-1.9/.readthedocs.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/.travis.yml` & `grizli-1.9/.travis.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/CHANGES.rst` & `grizli-1.9/CHANGES.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/CITATION.cff` & `grizli-1.9/CITATION.cff`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/LICENSE.txt` & `grizli-1.9/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/PKG-INFO` & `grizli-1.9/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: grizli
-Version: 1.8.9
+Version: 1.9
 Summary: Grism redshift and line analysis software
 Home-page: https://github.com/gbrammer/grizli
 Author: G. Brammer
 Author-email: gbrammer@gmail.com
 License: MIT
 Project-URL: Documentation, https://grizli.readthedocs.io/
 Project-URL: Source, https://github.com/gbrammer/grizli
```

### Comparing `grizli-1.8.9/README.rst` & `grizli-1.9/README.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/Makefile` & `grizli-1.9/docs/Makefile`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/_static/grizli.ico` & `grizli-1.9/docs/_static/grizli.ico`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/_static/grizli_favico.png` & `grizli-1.9/docs/_static/grizli_favico.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/_static/grizli_favico_large.png` & `grizli-1.9/docs/_static/grizli_favico_large.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/_static/grizli_logo.pdf` & `grizli-1.9/docs/_static/grizli_logo.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/_static/grizli_logo.png` & `grizli-1.9/docs/_static/grizli_logo.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/conf.py` & `grizli-1.9/docs/conf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/ceers-sm.field.jpg` & `grizli-1.9/docs/grizli/ceers-sm.field.jpg`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/image-release-v6.md` & `grizli-1.9/docs/grizli/image-release-v6.md`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/image-release-v6.rst` & `grizli-1.9/docs/grizli/image-release-v6.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/index.rst` & `grizli-1.9/docs/grizli/index.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/install.rst` & `grizli-1.9/docs/grizli/install.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli/prep.rst` & `grizli-1.9/docs/grizli/prep.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/grizli-for-dummies.rst` & `grizli-1.9/docs/grizli-for-dummies.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/index.rst` & `grizli-1.9/docs/index.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/docs/make.bat` & `grizli-1.9/docs/make.bat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/examples/demo.py` & `grizli-1.9/examples/demo.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/examples/grizli_demo_0.pdf` & `grizli-1.9/examples/grizli_demo_0.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/examples/grizli_demo_1.pdf` & `grizli-1.9/examples/grizli_demo_1.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/examples/grizli_logo.pdf` & `grizli-1.9/examples/grizli_logo.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/examples/grizli_logo.png` & `grizli-1.9/examples/grizli_logo.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/__init__.py` & `grizli-1.9/grizli/__init__.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/aws/aws_drizzler.py` & `grizli-1.9/grizli/aws/aws_drizzler.py`

 * *Files 0% similar despite different names*

```diff
@@ -778,15 +778,22 @@
         print('\n\n###\nMake filter: {0}'.format(filt))
 
         if include_ir_psf:
             clean_i = False
         else:
             clean_i = remove
 
-        status = utils.drizzle_from_visit(visits[0], h, pixfrac=pixfrac, kernel=kernel, clean=clean_i, include_saturated=include_saturated, skip=skip, dryrun=dryrun)
+        status = utils.drizzle_from_visit(visits[0],
+                                          h,
+                                          pixfrac=pixfrac, kernel=kernel, 
+                                          clean=clean_i, 
+                                          include_saturated=include_saturated,
+                                          weight_type='median_err',
+                                          skip=skip,
+                                          dryrun=dryrun)
 
         if dryrun:
             filt_dict[filt] = status
             continue
 
         elif status is not None:
             sci, wht, outh, filt_dict[filt], wcs_tab = status
```

### Comparing `grizli-1.8.9/grizli/aws/db.py` & `grizli-1.9/grizli/aws/db.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/aws/field_tiles.py` & `grizli-1.9/grizli/aws/field_tiles.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/aws/fit_redshift_lambda.py` & `grizli-1.9/grizli/aws/fit_redshift_lambda.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/aws/lambda_handler.py` & `grizli-1.9/grizli/aws/lambda_handler.py`

 * *Files 1% similar despite different names*

```diff
@@ -772,15 +772,15 @@
     else:
         # Normal galaxy redshift fit
         res = fitting.run_all_parallel(id, get_output_data=True,
                                        fit_only_beams=True, fit_beams=False,
                                        args_file=args_file,
                                        **event_kwargs)
         
-        if root in ('fresco-gds-med', 'fresco-gdn-med'):
+        if root.startswith('fresco-g'):
             try:
                 mb, tfit = res[0], res[3]
                 # 1D for FRESCO
                 fig1 = mb.oned_figure(bin=2, tfit=tfit,
                                       show_rest=False, minor=0.1,
                                       figsize=(9,3), median_filter_kwargs=None,
                                       ylim_percentile=0.1)
```

### Comparing `grizli-1.8.9/grizli/aws/tile_mosaic.py` & `grizli-1.9/grizli/aws/tile_mosaic.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/aws/visit_processor.py` & `grizli-1.9/grizli/aws/visit_processor.py`

 * *Files 10% similar despite different names*

```diff
@@ -1310,18 +1310,21 @@
     kws['visit_prep_args']['reference_catalogs'] = ref_catalogs
     if filters is None:
         kws['filters'] = [f.split('-')[0] 
                           for f in np.unique(tab['filter']).tolist()]            
     else:
         kws['filters'] = filters
     
-    if True:
+    # Negative values of visit_split_shift override keyword args
+    if kws['parse_visits_args']['visit_split_shift'] > 0:
         kws['parse_visits_args']['max_dt'] = max_dt
         kws['parse_visits_args']['visit_split_shift'] = visit_split_shift
         kws['parse_visits_args']['combine_same_pa'] = combine_same_pa
+    else:
+        kws['parse_visits_args']['visit_split_shift'] *= -1
         
     if ('_f4' in assoc) | ('_f3' in assoc) | ('_f2' in assoc) & (blue_align_params is not None):        
         for k in blue_align_params:
             kws['visit_prep_args'][k] = blue_align_params[k]
     
     for k in prep_args:
         kws['visit_prep_args'][k] = prep_args[k]
@@ -1348,15 +1351,18 @@
                              align_simple=True)
                            
             for k in miri_prep:
                 if k not in prep_args:
                     kws['visit_prep_args'][k] = miri_prep[k]
                     
             break
-               
+    
+    ## Full parameter file as executed
+    auto_script.write_params_to_yml(kws, output_file=f'{assoc}.run.yaml')
+    
     ######## 
     auto_script.go(assoc, **kws)
     ########
     
     failed = glob.glob('*failed')
     
     if len(failed) > 0:
@@ -1706,34 +1712,123 @@
                                     get_hdu=True)
         header = _hdu.header
         wcs = pywcs.WCS(header)
         
     return header, wcs, SQL, res
 
 
-def cutout_mosaic(rootname='gds', product='{rootname}-{f}', ra=53.1615666, dec=-27.7910651, size=5*60, theta=0., filters=['F160W'], ir_scale=0.1, ir_wcs=None, res=None, half_optical=True, kernel='point', pixfrac=0.33, make_figure=True, skip_existing=True, clean_flt=True, gzip_output=True, s3output='s3://grizli-v2/HST/Pipeline/Mosaic/', split_uvis=True, extra_query='', extra_wfc3ir_badpix=True, fix_niriss=True, scale_nanojy=10, verbose=True, niriss_ghost_kwargs={}, scale_photom=True, calc_wcsmap=False, **kwargs):
+def cutout_mosaic(rootname='gds', product='{rootname}-{f}', ra=53.1615666, dec=-27.7910651, size=5*60, theta=0., filters=['F160W'], ir_scale=0.1, ir_wcs=None, res=None, half_optical=True, kernel='point', pixfrac=0.33, make_figure=True, skip_existing=True, clean_flt=True, gzip_output=True, s3output='s3://grizli-v2/HST/Pipeline/Mosaic/', split_uvis=True, extra_query='', extra_wfc3ir_badpix=True, fix_niriss=True, scale_nanojy=10, verbose=True, weight_type='err', rnoise_percentile=99, get_dbmask=True, niriss_ghost_kwargs={}, scale_photom=True, calc_wcsmap=False, make_exptime_map=False, expmap_sample_factor=4, keep_expmap_small=True, **kwargs):
     """
     Make mosaic from exposures defined in the exposure database
     
     Parameters
     ----------
+    rootname : str
+        Output file rootname
+    
+    product : str
+        File name structure that will be parsed with ``product.format(rootname, f)``,
+        where ``f`` is the filter name
+    
+    ra, dec : float
+        Cutout center in decimal degrees
+    
+    size : float
+        Cutout size in arcsec
+    
+    theta : float
+        Position angle of the output WCS
+    
+    filters : list
+        List of filter names to use for the mosaic.
+    
+    ir_scale : float
+        Pixel scale in arcsec
+    
+    ir_wcs : `~astropy.wcs.WCS`
+        Specify the output WCS explicitly rather than deriving from
+        ``ra, dec, size, theta``.
+    
+    res : None, `~astropy.table.Table`
+        Explicit list of exposure file metadata, e.g., from 
+        `~grizli.aws.visit_processor.res_query_from_local`.  If not specified, the 
+        grizli-processed exposures that overlap with the requested cutout WCS will be
+        determined by querying the `grizli` database (`~grizli.aws.db`).
+    
+    half_optical : bool
+        Use WCS with pixels 2x smaller than defined in `ir_wcs` for ACS/WFC, WFC3/UVIS,
+        NIRCam and NIRISS filters.
+    
+    kernel, pixfrac : str, float
+        Drizzle parameters
+    
+    skip_existing : bool
+        Skip `product` combinations already found in the working directory
+    
+    clean_flt : bool
+        Remove exposures one-by-one after they have been added to the cutout / mosaic.
+    
+    gzip_output : bool
+        Compress the output files after completion
+    
+    s3output : str
+        Path name of an AWS S3 bucket where products will be sent upon completion
+    
+    split_uvis : bool
+        Make separate mosaics for ACS/WFC and WFC3/UVIS filters with the same name
+    
+    extra_query : str
+        Extra SQL query criteria added to the DB query if ``res`` not provided
+    
+    extra_wfc3ir_badpix : str
+        Add additional bad pixel mask for WFC3/IR and NIRCam from the bad pixel files 
+        provided in `grizli.data`.
+    
+    fix_niriss : bool
+        Separate filter names for NIRISS
+    
+    scale_nanojy : bool
+        Photometric scale of the output image, i.e., a pixel value of one corresponds
+        to a flux density of `scale_nanojy` nJy per pix.
+    
+    verbose : bool
+        Verbose messaging
+    
+    weight_type : 'jwst', 'median_err', 'err'
+        Drizzle weight strategy (see `~grizli.utils.drizzle_from_visit`)
+    
+    rnoise_percentile : float
+        See `~grizli.utils.drizzle_from_visit`
+    
+    niriss_ghost_kwargs : dict
+        Parameters of the NIRISS ghost flagging
+    
+    scale_photom : bool
+        See `~grizli.utils.drizzle_from_visit`
+    
+    calc_wcsmap : bool
+        See `~grizli.utils.drizzle_from_visit`
     
     Returns
     -------
+    Image mosaic files with the requested WCS and filters
+    
     """
     import os
     import glob
     import matplotlib.pyplot as plt
     import astropy.io.fits as pyfits
     
     import boto3
     
     from grizli import utils
     from mastquery import overlaps
     
+    ORIG_LOGFILE = utils.LOGFILE
+    
     utils.set_warnings()
     
     # out_h, ir_wcs, res = query_exposures(ra=ra, dec=dec,
     #                                      size=size,
     #                                      pixel_scale=pixel_scale,
     #                                      theta=theta,
     #                                      filters=filters,
@@ -1796,19 +1891,22 @@
             
     uniq_filts = utils.Unique(file_filters, verbose=False)
     
     for f in uniq_filts.values:
         
         visit = {'product':product.format(rootname=rootname, f=f).lower()}
         
+        utils.LOGFILE = f"{visit['product']}.log.txt"
+        
         if (len(glob.glob(visit['product'] + '*fits*')) > 0) & skip_existing:
             print('Skip ' + visit['product'])
             continue
             
-        print('============', visit['product'], '============')
+        msg = '============ ' + visit['product'] + '============'
+        utils.log_comment(utils.LOGFILE, msg, verbose=verbose)
         
         if 'clear' in f:
             ftest = f.lower().replace('clear-','').replace('-clear','')
         else:
             ftest = f.lower()
         
         if ftest in ['f098m','f105w','f110w','f125w',
@@ -1836,14 +1934,15 @@
         
         ds = res[fi]['dataset']
         ex = res[fi]['extension']
         assoc = res[fi]['assoc']
         ffp = res[fi]['footprint']
         expt = res[fi]['exptime'].sum()
         
+        
         if make_figure:
             fig, ax = plt.subplots(1,1,figsize=(6,6))
             ax.scatter(*fp.T, marker='.', color='r')
             sr = utils.SRegion(fp)
             for p in sr.get_patch(alpha=0.8, ec='r', fc='None',zorder=100):
                 ax.add_patch(p)
 
@@ -1884,15 +1983,17 @@
                            
         _ = utils.drizzle_from_visit(visit, visit['reference'], 
                                      pixfrac=pixfrac, 
                                      kernel=kernel, clean=clean_flt, 
                                      extra_wfc3ir_badpix=extra_wfc3ir_badpix,
                                      verbose=verbose,
                                      scale_photom=scale_photom,
+                                     get_dbmask=get_dbmask,
                                      niriss_ghost_kwargs=niriss_ghost_kwargs,
+                                     weight_type=weight_type,
                                      calc_wcsmap=calc_wcsmap)
                              
         outsci, outwht, header, flist, wcs_tab = _
         
         wcs_tab.write('{0}_wcs.csv'.format(visit['product']), overwrite=True)
         
         if is_optical:
@@ -1907,58 +2008,374 @@
         #                          'Inverse sensitivity from PHOTFLAM, Jy/DN')
             
         if scale_nanojy is not None:
             to_njy = scale_nanojy/(header['PHOTFNU']*1.e9)
             msg = f'Scale PHOTFNU x {to_njy:.3f} to {scale_nanojy:.1f} nJy'
             utils.log_comment(utils.LOGFILE, msg, verbose=verbose)
             
+            header['OPHOTFNU'] = header['PHOTFNU'], 'Original PHOTFNU before scaling'
             header['PHOTFNU'] *= to_njy
             header['PHOTFLAM'] *= to_njy
             header['BUNIT'] = f'{scale_nanojy:.1f}*nanoJansky'
             outsci *= 1./to_njy
             outwht *= to_njy**2
         else:
             #pass
             to_njy = header['PHOTFNU']*1.e9
             header['BUNIT'] = f'{to_njy:.3f}*nanoJansky'
-            
-        pyfits.writeto('{0}_{1}_sci.fits'.format(visit['product'], drz),
+        
+        sci_file = '{0}_{1}_sci.fits'.format(visit['product'], drz)
+        pyfits.writeto(sci_file,
                        data=outsci, header=header, 
                        overwrite=True)
     
         pyfits.writeto('{0}_{1}_wht.fits'.format(visit['product'], drz),
                       data=outwht, header=header, 
                       overwrite=True)
-
+        
+        if make_exptime_map:
+            matched_exptime_map(sci_file, sample_factor=expmap_sample_factor,
+                                keep_small=keep_expmap_small,
+                                output_type='file', verbose=True)
+    
     if s3output:
         files = []
         for f in uniq_filts.values:
             prod = product.format(rootname=rootname, f=f).lower()
             
             if gzip_output:
                 print(f'gzip --force {prod}*fits')
                 os.system(f'gzip --force {prod}*fits')
 
             files += glob.glob(f'{prod}*fits*')
             files += glob.glob(f'{prod}*_fp.png')
             files += glob.glob(f'{prod}*wcs.csv')
+            files += glob.glob(f'{prod}*log.txt')
         
         
         for file in files:
             #os.system(f'aws s3 cp {file} {s3output}')
             bucket = s3output.split('s3://')[-1].split('/')[0]
             path = '/'.join(s3output.split('s3://')[-1].strip('/').split('/')[1:])
             object_name = f'{path}/{file}'
             print(f'{file} > s3://{bucket}/{object_name}')
             db.upload_file(file, bucket, object_name=object_name)
     
     return res
+
+
+def matched_exptime_map(ref_file, sample_factor=4, keep_small=True, output_type='file', verbose=True):
+    """
+    Make an exposure time map by querying footprints from the exposure database
+    
+    Parameters
+    ----------
+    ref_file : str
+        Reference mosaic file.  Needs a valid WCS and header keywords that can be
+        parsed with `~grizli.utils.parse_filter_from_header`.
     
+    sample_factor : int
+        Undersampling factor
+    
+    keep_small : bool
+        Store the output on the undersampled grid
+    
+    output_type : str
+        Output behavior:
+        
+        - ``file`` write a file `ref_file.replace('sci.fits','exp.fits')` if 
+          `ref_file.endswith('sci.fits*')`
+        
+        - ``hdu``: get a `~astropy.io.fits.ImageHDU` object
+        
+        - ``array``: return a 2D array
+    
+    Returns
+    -------
+    output : see ``output_type``
+    
+    """
+    import astropy.io.fits as pyfits
+    import astropy.wcs as pywcs
+    import astropy.units as u
+    
+    from tqdm import tqdm
+    import scipy.ndimage as nd
+
+    with pyfits.open(ref_file) as im:
+
+        filter_key = utils.parse_filter_from_header(im[0].header)
+        wcs = pywcs.WCS(im[0].header)
+        header = im[0].header.copy()
+        
+        if ('FLT00001' in header) & ('NDRIZIM' in header):
+            added_files = []
+            for i in range(header['NDRIZIM']):
+                k = f'FLT{i+1:05d}'
+                if k in header:
+                    added_files.append('_'.join(header[k].split('_')[:-1]))
+                    
+            if len(added_files) == 0:
+                added_files = None
+                
+    wsr = utils.SRegion(wcs.calc_footprint())
+
+    exp = db.SQL(f"""SELECT dataset, footprint, exptime, filter, sciext
+    FROM exposure_files
+    WHERE filter = '{filter_key}'
+    AND polygon(footprint) && polygon('{wsr.polystr()[0]}')
+    """)
+        
+    NX = header['NAXIS1']
+    NY = header['NAXIS2']
+    yp, xp = np.indices((NY//sample_factor, NX//sample_factor))*sample_factor
+    sh = xp.shape
+
+    msg = f'matched_exptime_map: {ref_file}, sample_factor={sample_factor}\n'
+    msg += f'matched_exptime_map: ({NY},{NX}) > ({sh[0]}, {sh[1]})\n'
+    msg += f'matched_exptime_map: {len(exp)} exposures in {filter_key}'
+    
+    utils.log_comment(utils.LOGFILE, msg, verbose=verbose)
+
+    rr, dd = wcs.all_pix2world(xp.flatten(), yp.flatten(), 0)
+    coo = np.array([rr, dd]).T
+
+    expm = np.zeros(coo.shape[0], dtype=np.uint32)
+    
+    added = []
+    
+    for footprint, exptime, ds, ext in tqdm(zip(exp['footprint'], exp['exptime'], 
+                                                exp['dataset'], exp['sciext'])):
+        if added_files is not None:
+            if (ds not in added_files) | ((ds,ext) in added):
+                continue
+        
+        added.append((ds,ext))
+        
+        sr = utils.SRegion(footprint)
+        in_fp = sr.path[0].contains_points(coo) #.reshape(sh)
+
+            
+        expm[in_fp] += np.uint32(exptime) # *in_fp
+        
+    ### Put back in original scale
+    if keep_small:
+        full_expm = expm.reshape(sh)
+        
+        header['CRPIX1'] /= sample_factor
+        header['CRPIX2'] /= sample_factor
+        for i in [1,2]:
+            for j in [1,2]:
+                k = f'CD{i}_{j}'
+                if k in header:
+                    header[k] *= sample_factor
+        
+    else:
+        
+        full_expm = np.zeros((NY, NX), dtype=np.uint32)
+
+        for i, (xi, yi) in enumerate(zip(xp.flatten(), yp.flatten())):
+            full_expm[yi, xi] = expm[i]
+
+        if sample_factor > 1:
+            full_expm = nd.maximum_filter(full_expm, sample_factor)
+    
+    header['BUNIT'] = 'second'
+    header['SAMPLE'] = sample_factor, 'Sampling factor'
+    header['NXORIG'] = NX
+    header['NYORIG'] = NY
+        
+    mosaic_pscale = utils.get_wcs_pscale(wcs)
+    
+    if 'PIXAR_SR' in header:
+        orig_pscale = np.sqrt((header['PIXAR_SR']*u.steradian).to(u.arcsec**2)).value
+    else:
+        # ToDo: HST pixel scales
+        if 'DETECTOR' in header:
+            if header['DETECTOR'] == 'IR':
+                orig_pscale = 0.128
+            elif header['DETECTOR'] == 'WFC':
+                orig_pscale = 0.05
+            elif header['DETECTOR'] == 'UVIS':
+                orig_pscale = 0.04
+            else:
+                orig_pscale = 0.128
+        else:
+            orig_pscale = 0.128
+            
+    #pscale_ratio = orig_pscale/mosaic_pscale
+    
+    header['MOSPSCL'] = mosaic_pscale, 'Mosaic pixel scale arcsec'
+    header['ORIGPSCL'] = orig_pscale, 'Original detector pixel scale arcsec'
+    
+    phot_scale = 1.
+    
+    if 'PHOTMJSR' in header:
+        phot_scale /= header['PHOTMJSR']
+    
+    if 'PHOTSCAL' in header:
+        phot_scale /= header['PHOTSCAL']
+    
+    if 'OPHOTFNU' in header:
+        phot_scale *= header['OPHOTFNU'] / header['PHOTFNU']
+        
+    header['DNTOEPS'] = ((orig_pscale/mosaic_pscale)**2 * phot_scale,
+                         'Inverse flux conversion back to e per second')
+    
+    if output_type == 'array':
+        return full_expm
+    
+    hdu = pyfits.ImageHDU(header=header, data=full_expm)
+    
+    if '_sci.fits' in ref_file:
+        output_file = ref_file.replace('_sci.fits','_exp.fits')
+    else:
+        output_type = 'hdu'
+        
+    if output_type == 'hdu':
+        return hdu
+    else:
+        msg = f'matched_exptime_map: write to {output_file}'
+        utils.log_comment(utils.LOGFILE, msg, verbose=verbose)
+        
+        pyfits.writeto(output_file, data=full_expm, header=header, overwrite=True)
+        return output_file
+
+
+def show_epochs_filter(ra, dec, size=4, filter='F444W-CLEAR', cleanup=True, vmax=0.2, cmap='magma_r'):
+    """
+    Make a figure showing cutouts around a particular position for all exposures 
+    covering that point
+    """
+    import glob
+    import numpy as np
+    
+    import matplotlib.pyplot as plt
+    import astropy.io.fits as pyfits
+    import astropy.wcs as pywcs
+    
+    cut = cutout_mosaic('tmp-epoch', ra=ra, dec=dec, ir_scale=0.065,
+                                        size=size,
+                                        s3output=None,
+                                        gzip_output=False,
+                                        filters=[filter],
+                                        clean_flt=False,
+                                        skip_existing=False,
+                                       )
+                                    
+    files = []
+    for d in cut['dataset']:
+        files += glob.glob(f'{d}*fits')
+
+    files = np.unique(files).tolist()
+    
+    info = utils.get_flt_info(files=files)
+    
+    so = np.argsort(info['EXPSTART'])
+    
+    ys = 2
+    N = len(info)
+    
+    sci_list = []
+    wht_list = []
+    wcs_list = []
+    for file in files:
+        with pyfits.open(file) as im:
+            sci_list.append(im['SCI'].data - im['SCI'].header['MDRIZSKY'])
+            wht_list.append(1./im['ERR'].data**2)
+            wcs_list.append(pywcs.WCS(im['SCI'].header, relax=True))
+            
+    pscale = utils.get_wcs_pscale(wcs_list[0])
+    
+    # Set a pixel in detector space that will show up in the stack
+    xp, yp = np.squeeze(np.cast[int](wcs_list[0].all_world2pix([ra], [dec], 0)
+                                     + size/5/pscale))
+    try:
+        for i in range(N):
+            sci_list[i][yp, xp] = 10000
+    except IndexError:
+        pass
+    
+    # Undersample so can drizzle with point kernel
+    pscale *= 1.3
+    outh, outw = utils.make_wcsheader(ra=ra, dec=dec,
+                                      size=size, pixscale=pscale,
+                                      get_hdu=False)
+
+    for w in wcs_list:
+        w.pscale = utils.get_wcs_pscale(w)
+    
+    # Separate drizzle
+    thumbs = [utils.drizzle_array_groups(sci_list[i:i+1], wht_list[i:i+1],
+                                        wcs_list[i:i+1], outputwcs=outw,
+                                        kernel='point', pixfrac=1,
+                                       )[0]
+              for i in range(len(files))]
+    
+    # Mask bad pixels
+    for i in range(N):
+        msk = ~np.isfinite(sci_list[i] + wht_list[i])
+        sci_list[i][msk] = -100
+        wht_list[i][msk] = 0
+    
+    # Full drizzle
+    full = utils.drizzle_array_groups(sci_list,
+                                      wht_list,
+                                        wcs_list, outputwcs=outw,
+                                        kernel='point', pixfrac=1,
+                                       )[0]
+    
+    plt.rcParams['xtick.direction'] = 'in'
+    plt.rcParams['ytick.direction'] = 'in'
+    
+    fig, axes = plt.subplots(1,N+1, figsize=(2.5*(N+1), 2.5),
+                             sharex=True, sharey=True)
+    
+    kws = dict(vmin=-0.1*vmax, vmax=vmax, cmap=cmap, origin='lower')
+    
+    fs = 7
+    
+    for i in range(N):
+        axes[i].imshow(thumbs[i], **kws)
+        label = f"{info['DATE-OBS'][i]}   {info['TIME-OBS'][i][:-4]}"
+        label += '\n' + f"{files[i].split('_rate')[0]}"
+        axes[i].text(0.5, 0.05, label,
+                     ha='center', va='bottom', transform=axes[i].transAxes,
+                     fontsize=fs, color='k', bbox=dict(fc='w', alpha=0.8, ec='None'),
+                    )
+        
+    axes[N].imshow(full, **kws)
+    axes[N].text(0.5, 0.05, filter,
+                     ha='center', va='bottom', transform=axes[N].transAxes,
+                     fontsize=fs, color='k', bbox=dict(fc='w', alpha=0.8, ec='None'),
+                )
+    
+    sh = full.shape
+    for ax in axes:
+        ax.set_xticks((-0.5, sh[0]-0.5))
+        ax.set_yticks(ax.get_xticks())
+        ax.set_xticklabels([])
+        ax.set_yticklabels([])
+        
+    fig.tight_layout(pad=0)
+    fig.tight_layout(pad=0.5)
+
+    if cleanup:
+        for file in files:
+            if os.path.exists(file):
+                os.remove(file)
+
+        xfiles = glob.glob('tmp-epoch*')
+        for file in xfiles:
+            os.remove(file)
+            
+    return fig
+
 
-def make_mosaic(jname='', ds9=None, skip_existing=True, ir_scale=0.1, half_optical=False, pad=16, kernel='point', pixfrac=0.33, sync=True, ir_wcs=None):
+def make_mosaic(jname='', ds9=None, skip_existing=True, ir_scale=0.1, half_optical=False, pad=16, kernel='point', pixfrac=0.33, sync=True, ir_wcs=None, weight_type='median_err'):
     """
     Make mosaics from all exposures in a group of associations
     """
     import os
     import glob
     from grizli.pipeline import auto_script
     
@@ -2127,15 +2544,17 @@
         elif f[1] > '1':
             groups[f]['reference'] = opt_wcs
         else:
             groups[f]['reference'] = ir_wcs
             
         _ = utils.drizzle_from_visit(groups[f], groups[f]['reference'], 
                                      pixfrac=pixfrac, 
-                                     kernel=kernel, clean=False)
+                                     kernel=kernel, clean=False,
+                                     weight_type=weight_type,
+                                     )
                              
         outsci, outwht, header, flist, wcs_tab = _
     
         pyfits.writeto(groups[f]['product']+'_drz_sci.fits',
                        data=outsci, header=header, 
                        overwrite=True)
```

### Comparing `grizli-1.8.9/grizli/catalog.py` & `grizli-1.9/grizli/catalog.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/combine.py` & `grizli-1.9/grizli/combine.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/auto_script_defaults.yml` & `grizli-1.9/grizli/data/auto_script_defaults.yml`

 * *Files 1% similar despite different names*

```diff
@@ -98,19 +98,20 @@
     align_min_flux_radius: 1.
     catalog_mask_pad: 0.05
     match_catalog_density: False
     skymethod: localmin
     drizzle_params: {}
     single_image_CRs: True
     run_tweak_align: True
-    tweak_threshold: 1.5
+    tweak_threshold: 3.0
     tweak_fit_order: -1
     tweak_max_dist: 100
     tweak_n_min: 10
     tweak_ref_exp: 0
+    tweak_mosaic_iters: 2
     align_simple: False
     align_clip: 120
     column_average: True
     sky_iter: 10
     iter_atol: 0.0001
     imaging_bkg_params:
         bh: 256
```

### Comparing `grizli-1.8.9/grizli/data/gaia_dr2_vizier_columns.txt` & `grizli-1.9/grizli/data/gaia_dr2_vizier_columns.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/hst_encircled_energy.fits` & `grizli-1.9/grizli/data/hst_encircled_energy.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/jwst_bp_info.yml` & `grizli-1.9/grizli/data/jwst_bp_info.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nircam_wisp.yml` & `grizli-1.9/grizli/data/nircam_wisp.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz` & `grizli-1.9/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz` & `grizli-1.9/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz` & `grizli-1.9/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/photom_correction.yml` & `grizli-1.9/grizli/data/photom_correction.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/sep_catalog_junk.pkl` & `grizli-1.9/grizli/data/sep_catalog_junk.pkl`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/FeII_VeronCetty2004.txt` & `grizli-1.9/grizli/data/templates/FeII_VeronCetty2004.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/README` & `grizli-1.9/grizli/data/templates/README`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/alf_SSP.dat` & `grizli-1.9/grizli/data/templates/alf_SSP.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/cvd12_t11_solar_Chabrier.dat` & `grizli-1.9/grizli/data/templates/cvd12_t11_solar_Chabrier.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/eazy_intermediate.dat` & `grizli-1.9/grizli/data/templates/eazy_intermediate.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/erb2010.dat` & `grizli-1.9/grizli/data/templates/erb2010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/erb2010_continuum.dat` & `grizli-1.9/grizli/data/templates/erb2010_continuum.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat` & `grizli-1.9/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/fsps_starburst_lines.txt` & `grizli-1.9/grizli/data/templates/fsps_starburst_lines.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/post_starburst.dat` & `grizli-1.9/grizli/data/templates/post_starburst.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/quasar_lines.txt` & `grizli-1.9/grizli/data/templates/quasar_lines.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/red_blue_continuum.txt` & `grizli-1.9/grizli/data/templates/red_blue_continuum.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/red_blue_continuum_noLya.txt` & `grizli-1.9/grizli/data/templates/red_blue_continuum_noLya.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/L1.0.txt` & `grizli-1.9/grizli/data/templates/stars/L1.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/L3.5.txt` & `grizli-1.9/grizli/data/templates/stars/L3.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/L6.0.txt` & `grizli-1.9/grizli/data/templates/stars/L6.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/M6.5.txt` & `grizli-1.9/grizli/data/templates/stars/M6.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/M8.0.txt` & `grizli-1.9/grizli/data/templates/stars/M8.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/T2.0.txt` & `grizli-1.9/grizli/data/templates/stars/T2.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/T6.0.txt` & `grizli-1.9/grizli/data/templates/stars/T6.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/T7.5.txt` & `grizli-1.9/grizli/data/templates/stars/T7.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits` & `grizli-1.9/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/templates/stars/carbon_star.txt` & `grizli-1.9/grizli/data/templates/stars/carbon_star.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/visit_alignment.txt` & `grizli-1.9/grizli/data/visit_alignment.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz` & `grizli-1.9/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz` & `grizli-1.9/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/data/wfc3ir_ee.txt` & `grizli-1.9/grizli/data/wfc3ir_ee.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/ds9.py` & `grizli-1.9/grizli/ds9.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/fake_image.py` & `grizli-1.9/grizli/fake_image.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/fitting.py` & `grizli-1.9/grizli/fitting.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/galfit/deconvolve.py` & `grizli-1.9/grizli/galfit/deconvolve.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/galfit/galfit.py` & `grizli-1.9/grizli/galfit/galfit.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/galfit/gfutils.py` & `grizli-1.9/grizli/galfit/gfutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/galfit/psf.py` & `grizli-1.9/grizli/galfit/psf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/grismconf.py` & `grizli-1.9/grizli/grismconf.py`

 * *Files 2% similar despite different names*

```diff
@@ -597,17 +597,27 @@
         fi = grism
         gr = filter[-1] # R, C
         # conf_file = os.path.join(GRIZLI_PATH,
         #             f'CONF/GRISM_NIRCAM/gNIRCAM.{fi}.mod{module}.{gr}.conf')
         #
         # conf_file = os.path.join(GRIZLI_PATH,
         #             f'CONF/GRISM_NIRCAM/V2/NIRCAM_{fi}_mod{module}_{gr}.conf')
-
+        
+        # NIRCam preference: 8.5 > 8 > 4
+        
         conf_file = os.path.join(GRIZLI_PATH,
-                    f'CONF/GRISM_NIRCAM/V4/NIRCAM_{fi}_mod{module}_{gr}.conf')
+                    f'CONF/GRISM_NIRCAM/V8.5/NIRCAM_{fi}_mod{module}_{gr}.conf')
+        
+        if not os.path.exists(conf_file):
+            conf_file = conf_file.replace('V8.5/', 'V8/')        
+
+        if not os.path.exists(conf_file):
+            conf_file = conf_file.replace('V8/', 'V4/')        
+        
+        print(f'xxx conf_file: {conf_file}')
         
     elif instrume == 'NIRCAMA':
         fi = grism
         gr = filter[-1] # R, C
         conf_file = os.path.join(GRIZLI_PATH,
                     f'CONF/GRISM_NIRCAM/gNIRCAM.{fi}.modA.{gr}.conf')
 
@@ -947,15 +957,15 @@
                       'c0_1': -0.0011862122093603026,
                       'c0_2': 4.1403439215806165e-07,
                       'c1_1': 1.6558275336712723e-07
                      }
             
             poly = Polynomial2D(degree=2, **coeffs)
             trace_dy += poly(x, y)
-            #print(f'polynomial offset: {poly(x,y):.3f}')
+            # print(f'polynomial offset: {poly(x,y):.3f}')
             
         elif 'V4/NIRCAM_F444W_modA_R.conf' in self.conf_file:
             trace_dy += -2.5
             
             # Shifts derived from FRESCO
             coeffs = {'c0_0': 0.34191256988768415,
                       'c1_0': -0.0003378232293429956,
@@ -963,15 +973,19 @@
                       'c0_1': -7.063720696711682e-05,
                       'c0_2': 2.5217177632321527e-08,
                       'c1_1': -1.4345820074275903e-07
                       }
 
             poly = Polynomial2D(degree=2, **coeffs)
             trace_dy += poly(x, y)
-            #print(f'polynomial offset: {poly(x,y):.3f}')
+            # print(f'polynomial offset: {poly(x,y):.3f}')
+            
+        elif ('V8/NIRCAM' in self.conf_file) | ('V8.5/NIRCAM' in self.conf_file):
+            #print('V8: do nothing')
+            pass
             
         elif os.path.basename(self.conf_file) == 'NIRCAM_F444W_modA_R.conf':
             trace_dy += -2.5
         elif os.path.basename(self.conf_file) == 'NIRCAM_F444W_modA_C.conf':
             trace_dy += -0.1
             
         wave = self.conf.DISPL(self.order_names[beam], *x0, t)
@@ -1067,14 +1081,20 @@
         conf.get_beams()
     elif 'V2/NIRCAM' in conf_file:
         conf = TransformGrismconf(conf_file)
         conf.get_beams()
     elif 'V4/NIRCAM' in conf_file:
         conf = TransformGrismconf(conf_file)
         conf.get_beams()
+    elif 'V8/NIRCAM' in conf_file:
+        conf = TransformGrismconf(conf_file)
+        conf.get_beams()
+    elif 'V8.5/NIRCAM' in conf_file:
+        conf = TransformGrismconf(conf_file)
+        conf.get_beams()
     else:
         conf = aXeConf(conf_file)
         conf.get_beams()
     
     # Preliminary hacks for on-sky NIRISS
     if 'GR150' in conf_file:
         if 0:
```

### Comparing `grizli-1.8.9/grizli/jwst_level1.py` & `grizli-1.9/grizli/jwst_level1.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/jwst_utils.py` & `grizli-1.9/grizli/jwst_utils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/model.py` & `grizli-1.9/grizli/model.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/multifit.py` & `grizli-1.9/grizli/multifit.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 """Functionality for manipulating multiple grism exposures simultaneously
 """
 
 import os
 import time
+import traceback
 import glob
 from collections import OrderedDict
 import multiprocessing as mp
 from . import prep
 
 import scipy.ndimage as nd
 import numpy as np
@@ -625,15 +626,16 @@
 
         t1_pool = time.time()
         if verbose:
             print('Models computed - {0:.2f} sec.'.format(t1_pool - t0_pool))
 
     def get_beams(self, id, size=10, center_rd=None, beam_id='A',
                   min_overlap=0.1, min_valid_pix=10, min_mask=0.01,
-                  min_sens=0.08, mask_resid=True, get_slice_header=True):
+                  min_sens=0.08, mask_resid=True, get_slice_header=True,
+                  show_exception=False):
         """Extract 2D spectra "beams" from the GroupFLT exposures.
 
         Parameters
         ----------
         id : int
             Catalog ID of the object to extract.
 
@@ -684,14 +686,17 @@
                 out_beam = model.BeamCutout(flt=flt, beam=beam[beam_id],
                                         conf=flt.conf, min_mask=min_mask,
                                         min_sens=min_sens,
                                         mask_resid=mask_resid,
                                         get_slice_header=get_slice_header)
             except:
                 #print('Except: get_beams')
+                if show_exception:
+                    utils.log_exception(utils.LOGFILE, traceback)
+                    
                 continue
 
             valid = (out_beam.grism['SCI'] != 0)
             valid &= out_beam.fit_mask.reshape(out_beam.sh)
             hasdata = (valid.sum(axis=0) > 0).sum()
             if hasdata*1./out_beam.model.shape[1] < min_overlap:
                 continue
@@ -4814,15 +4819,15 @@
     grism_wht = pyfits.ImageHDU(data=outwht, header=h, name='WHT')
 
     hdul = pyfits.HDUList([p, grism_sci, grism_wht])
 
     return hdul
 
 
-def drizzle_to_wavelength(beams, wcs=None, ra=0., dec=0., wave=1.e4, size=5, pixscale=0.1, pixfrac=0.6, kernel='square', theta=0., direct_extension='REF', fcontam=0.2, ds9=None):
+def drizzle_to_wavelength(beams, wcs=None, ra=0., dec=0., wave=1.e4, size=5, pixscale=0.1, pixfrac=0.6, kernel='square', theta=0., direct_extension='REF', fcontam=0.2, custom_key=None, ds9=None):
     """Drizzle a cutout at a specific wavelength from a list of `~grizli.model.BeamCutout` objects
 
     Parameters
     ----------
     beams : list of `~.model.BeamCutout` objects.
 
     wcs : `~astropy.wcs.WCS` or None
@@ -4849,15 +4854,19 @@
     
     direct_extension : str, ('SCI' or 'REF')
         Extension of ``self.direct.data`` do drizzle for the thumbnail
 
     fcontam: float
         Factor by which to scale the contamination arrays and add to the
         pixel variances.
-
+    
+    custom_key : str
+        Key of `beam.grism.data` dictionary to use as the science array for the 
+        drizzled output
+    
     ds9 : `~grizli.ds9.DS9`, optional
         Display each step of the drizzling to an open DS9 window
 
     Returns
     -------
     hdu : `~astropy.io.fits.HDUList`
         FITS HDUList with the drizzled thumbnail, line and continuum
@@ -4961,30 +4970,35 @@
                 if wcs_ext is not None:
                     wcs_ext.crpix[j] = beam_wcs.wcs.crpix[j]
 
         # ACS requires additional wcs attributes
         ACS_CRPIX = [4096/2, 2048/2]
         dx_crpix = beam_wcs.wcs.crpix[0] - ACS_CRPIX[0]
         dy_crpix = beam_wcs.wcs.crpix[1] - ACS_CRPIX[1]
-        for wcs_ext in [beam_wcs.cpdis1, beam_wcs.cpdis2, beam_wcs.det2im1, beam_wcs.det2im2]:
+        for wcs_ext in [beam_wcs.cpdis1, beam_wcs.cpdis2,
+                        beam_wcs.det2im1, beam_wcs.det2im2]:
             if wcs_ext is not None:
                 wcs_ext.crval[0] += dx_crpix
                 wcs_ext.crval[1] += dy_crpix
 
-        beam_data = beam.grism.data['SCI'] - beam.contam
-        if hasattr(beam, 'background'):
-            beam_data -= beam.background
-
-        if hasattr(beam, 'extra_lines'):
-            beam_data -= beam.extra_lines
-
-        beam_continuum = beam.beam.model*1
-        if hasattr(beam.beam, 'pscale_array'):
-            beam_continuum *= beam.beam.pscale_array
+        if custom_key is None:
+            beam_data = beam.grism.data['SCI'] - beam.contam
+            if hasattr(beam, 'background'):
+                beam_data -= beam.background
+        
+            if hasattr(beam, 'extra_lines'):
+                beam_data -= beam.extra_lines
 
+            beam_continuum = beam.beam.model*1
+            if hasattr(beam.beam, 'pscale_array'):
+                beam_continuum *= beam.beam.pscale_array
+        else:
+            beam_data = beam.grism.data[custom_key]*1
+            beam_continuum = beam_data * 0
+        
         # Downweight contamination
         if fcontam > 0:
             # wht = 1/beam.ivar + (fcontam*beam.contam)**2
             # wht = np.cast[np.float32](1/wht)
             # wht[~np.isfinite(wht)] = 0.
 
             contam_weight = np.exp(-(fcontam*np.abs(beam.contam)*np.sqrt(beam.ivar)))
```

### Comparing `grizli-1.8.9/grizli/nbutils.py` & `grizli-1.9/grizli/nbutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/__init__.py` & `grizli-1.9/grizli/pipeline/__init__.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/auto_script.py` & `grizli-1.9/grizli/pipeline/auto_script.py`

 * *Files 1% similar despite different names*

```diff
@@ -11,15 +11,15 @@
 
 import yaml
 
 import numpy as np
 import astropy.io.fits as pyfits
 import astropy.wcs as pywcs
 
-from .. import prep, utils
+from .. import prep, utils, GRIZLI_PATH
 from .. import catalog as grizli_catalog
 
 from .default_params import UV_N_FILTERS, UV_M_FILTERS, UV_W_FILTERS
 from .default_params import OPT_N_FILTERS, OPT_M_FILTERS, OPT_W_FILTERS
 from .default_params import IR_N_FILTERS, IR_M_FILTERS, IR_W_FILTERS
 from .default_params import ALL_IMAGING_FILTERS, VALID_FILTERS
 from .default_params import UV_GRISMS, OPT_GRISMS, IR_GRISMS, GRIS_REF_FILTERS
@@ -247,14 +247,68 @@
     
     if 'thumbs' not in xpaths:
         xpaths['thumbs'] = extract
         
     return xpaths
 
 
+MIRI_FLAT_ROUND = {'F560W' : 8,
+    'F770W':4,
+    'F1000W': 5,
+    'F1280W': 5,
+    'F1500W': 8,
+    'F1800W': 5,
+    'F2100W': 4,}
+
+def get_miri_flat_by_date(file, tsplit=MIRI_FLAT_ROUND, verbose=True):
+    """
+    MIRI flats computed by date
+    
+    Flat-files defined by
+        >>> tkey = np.round(t_min/tsplit[FILTER])
+        >>> file = f'miri-{FILTER}-{tkey}_skyflat.fits'
+    
+    """
+    # try:
+    #     from .. import GRIZLI_PATH
+    # except ImportError:
+    #     from grizli import utils, GRIZLI_PATH
+
+    tsplit = {'F770W':4,
+              'F1800W': 5,
+              'F560W' : 8,
+              'F1280W': 5,
+              'F1500W': 8,
+              'F1000W': 5,
+              'F2100W': 4,
+              }
+    
+    with pyfits.open(file) as im:
+        t_min = im[0].header['EXPSTART']
+        filt = im[0].header['FILTER']
+    
+    tkey = '{0:.0f}'.format(np.round(t_min/tsplit[filt]))
+    flat_key = f'miri-{filt.lower()}-{tkey}_skyflat.fits'
+    
+    flat_file = None
+    
+    for path in [os.path.join(GRIZLI_PATH,'CONF'),
+                 '/mnt/efs/fs1/telescopes/MiriDateFlats']:
+        flat_file_i = os.path.join(path, flat_key)
+        if os.path.exists(flat_file_i):
+            flat_file = flat_file_i
+            break
+    
+    msg = f'get_miri_flat_by_date: {file}  {flat_key}  - {flat_file}'
+    utils.log_comment(utils.LOGFILE, msg, show_date=False,
+                          verbose=verbose)
+        
+    return flat_file
+
+
 def go(root='j010311+131615', 
        HOME_PATH='$PWD',
        RAW_PATH=None, PREP_PATH=None, PERSIST_PATH=None, EXTRACT_PATH=None,
        CRDS_CONTEXT=None,
        filters=args['filters'],
        fetch_files_args=args['fetch_files_args'],
        global_miri_skyflat=False,
@@ -429,34 +483,40 @@
                                 filters=filters, **fetch_files_args)
     else:
         os.chdir(PATHS['prep'])
     
     if global_miri_skyflat:
         os.chdir(PATHS['raw'])
         files = glob.glob('*mirimage*rate.fits')
-
+                
         if len(files) > 0:
+            
             files.sort()
             
-            msg = f"{root} : global_miri_skyflat N={len(files)}"
-            utils.log_comment(utils.LOGFILE, msg, show_date=False,
-                              verbose=True)
+            skyfile = get_miri_flat_by_date(files[0])
             
-            os.chdir(PATHS['prep'])
-            for file in files:
-                prep.fresh_flt_file(file, use_skyflats=False)
-            
-            prep.make_visit_average_flat({'product':root,
-                                          'files':files},
-                                          dilate=1, apply=False)
+            if skyfile is None:
+                
+                msg = f"{root} : global_miri_skyflat N={len(files)}"
+                utils.log_comment(utils.LOGFILE, msg, show_date=False,
+                                  verbose=True)
+            
+                os.chdir(PATHS['prep'])
+                for file in files:
+                    prep.fresh_flt_file(file, use_skyflats=False)
+            
+                prep.make_visit_average_flat({'product':root,
+                                              'files':files},
+                                              dilate=1, apply=False)
+                
+                skyfile = os.path.join(PATHS['prep'], f'{root}_skyflat.fits')
             
             visit_prep_args['miri_skyflat'] = False
             visit_prep_args['use_skyflats'] = False
-            visit_prep_args['miri_skyfile'] = os.path.join(PATHS['prep'],
-                                                      f'{root}_skyflat.fits')
+            visit_prep_args['miri_skyfile'] = skyfile
             
     if is_dash & run_prepare_dash:
         from wfc3dash import process_raw
         os.chdir(PATHS['raw'])
         process_raw.run_all()
 
     files = glob.glob(os.path.join(PATHS['raw'], '*_fl*fits'))
@@ -1738,20 +1798,34 @@
                 if not has_match:
                     combined.append(copy.deepcopy(visit))
 
         visits = combined
         print('** Combine Singles: **')
         for i, visit in enumerate(visits):
             print('{0} {1} {2}'.format(i, visit['product'], len(visit['files'])))
+    
     all_groups = utils.parse_grism_associations(visits, info)
+    
+    # JWST PASSAGE    
+    if (len(all_groups) > 0) & ('jw01571' in files[0]):
+        for v in visits:
+            if 'clear' in v['product']:
+                print('PASSAGE direct: ', v['product'])
+                direct = v
+        
+        for g in all_groups:
+            if g['direct'] is None:
+                g['direct'] = direct
+    
     print('\n == Grism groups ==\n')
     valid_groups = []
     for g in all_groups:
         try:
-            print(g['direct']['product'], len(g['direct']['files']), g['grism']['product'], len(g['grism']['files']))
+            print(g['direct']['product'], len(g['direct']['files']), 
+                  g['grism']['product'], len(g['grism']['files']))
             valid_groups.append(g)
         except:
             pass
 
     all_groups = valid_groups
 
     #np.save('{0}_visits.npy'.format(field_root), [visits, all_groups, info])
```

### Comparing `grizli-1.8.9/grizli/pipeline/default_params.py` & `grizli-1.9/grizli/pipeline/default_params.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/photoz.py` & `grizli-1.9/grizli/pipeline/photoz.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/reprocess.py` & `grizli-1.9/grizli/pipeline/reprocess.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/run_MPI.py` & `grizli-1.9/grizli/pipeline/run_MPI.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/pipeline/summary.py` & `grizli-1.9/grizli/pipeline/summary.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/prep.py` & `grizli-1.9/grizli/prep.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """
 Align direct images & make mosaics
 """
 import os
 import inspect
 import gc
 import warnings
+import shutil
 
 from collections import OrderedDict
 import glob
 import traceback
 
 import yaml
 import numpy as np
@@ -107,15 +108,14 @@
         Apply exposure region mask (like ``_flt.01.mask.reg``) if it exists.
 
     Returns
     -------
     Nothing, but copies the file from ``path`` to ``./``.
 
     """
-    import shutil
     try:
         from astroscrappy import detect_cosmics
         has_scrappy = True
     except ImportError:
         has_scrappy = False
 
     local_file = os.path.basename(file)
@@ -248,25 +248,32 @@
                 orig_file['DQ'].data |= new_bp[0].data
                 extra_msg += ' / wfc3ir_dark_badpix_2019.01.12.fits'
     
     logstr = '# {0} -> {1} {2}'
     logstr = logstr.format(orig_file.filename(), local_file, extra_msg)
     utils.log_comment(utils.LOGFILE, logstr, verbose=verbose)
     
+    isACS = head['DETECTOR'] in ['UVIS','WFC']
+    
     ####
     # JWST
+    isJWST = False
+    
     if 'TELESCOP' in orig_file[0].header:
         if orig_file[0].header['TELESCOP'] == 'JWST':
+            isJWST = True
+            
             orig_file.writeto(local_file, overwrite=True)
             status = jwst_utils.initialize_jwst_image(local_file, 
                                       oneoverf_correction=oneoverf_correction,
                                       oneoverf_kwargs=oneoverf_kwargs, 
                                       use_skyflats=use_skyflats)            
             orig_file = pyfits.open(local_file)
             
+            
     # if filter in ['GR150C', 'GR150R']: 
     #     if (head['FILTER'] == 'GR150C') & (head['PUPIL'] == 'F115W'):        
     #         flat_file = os.path.join(os.getenv('jref'), 'jwst_niriss_flat_0202.fits')
     #     if (head['FILTER'] == 'GR150C') & (head['PUPIL'] == 'F150W'):        
     #         flat_file = os.path.join(os.getenv('jref'), 'jwst_niriss_flat_0187.fits')
     #     if (head['FILTER'] == 'GR150C') & (head['PUPIL'] == 'F200W'):        
     #         flat_file = os.path.join(os.getenv('jref'), 'jwst_niriss_flat_0204.fits')
@@ -340,17 +347,18 @@
         for ext in [1, 2, 3, 4]:
             mask = pfl[ext].data > 1.3
             c1m[ext].data[mask] |= 2
 
         c1m.flush()
 
     orig_file.writeto(local_file, overwrite=True)
-
+    
     if mask_regions:
         apply_region_mask(local_file, dq_value=1024)
+        apply_region_mask_from_db(local_file, dq_value=1024)
     
     # Flush objects
     orig_file.close()
     del(orig_file)
     
     for _iter in range(3):
         gc.collect()
@@ -454,14 +462,109 @@
             flt['ERR'].data = np.sqrt(flt['ERR'].data**2+pers_data**2)
             flt[0].header['SUBPERS'] = (True, 'Persistence model subtracted')
 
     flt.flush()
     flt.close()
 
 
+def region_mask_from_ds9(ext=1):
+    """
+    Get a region masks from a local DS9 window and make a table that can be sent to the
+    `exposure_region_mask` database table.
+    """
+    import time
+    
+    from .aws import db
+    from .ds9 import DS9
+    
+    d = DS9()
+    rows = []
+
+    dataset = os.path.basename(d.get('file'))
+    dataset = dataset.split('[')[0]
+    
+    regs = d.get('regions').split()
+    for reg in regs:
+        if reg.startswith('polygon'):
+            sr = utils.SRegion(reg, wrap=False)
+            rows.append([dataset, ext, sr.polystr()[0], time.time()])
+    
+    tab = utils.GTable(rows=rows, names=['dataset','ext','region','time'])
+    
+    if False:
+        db.send_to_database('exposure_region_mask', tab,
+                            if_exists='append')
+                            
+    return tab
+
+
+def apply_region_mask_from_db(flt_file, dq_value=1024, verbose=True, in_place=True):
+    """
+    Query the `exposure_region_mask` table and apply masks 
+    
+    Parameters
+    ----------
+    flt_file : str
+        Image filename
+    
+    dq_value : int
+        Value to "OR" into the DQ extension
+    
+    verbose : bool
+        Messaging
+    
+    in_place : bool
+        Apply to DQ extension and resave `flt_file`
+    
+    Returns
+    -------
+    region_mask : array-like
+        If a region mask for `flt_file` is found in the database, return a mask array
+        derived from the database footprint.  Otherwise, return ``None``.
+    
+    """
+    try:
+        from .aws import db
+    except ImportError:
+        return False
+    
+    try:
+        masks = db.SQL(f"""select * from exposure_region_mask
+    where dataset = '{os.path.basename(flt_file)}'
+    """)
+    except:
+        logstr = f'# prep.apply_region_mask_from_db: query failed'
+        utils.log_comment(utils.LOGFILE, logstr, verbose=verbose)
+        
+        return None
+    
+    if len(masks) == 0:
+        return None
+        
+    with pyfits.open(flt_file, mode='update') as im:
+        sh = im['DQ'].data.shape
+        yp, xp = np.indices(sh)
+        coo = np.array([xp.flatten(), yp.flatten()]).T
+        region_mask = np.zeros(sh, dtype=bool)
+        
+        for reg, ext in zip(masks['region'], masks['ext']):
+            logstr = f'# prep.apply_region_mask_from_db: {flt_file}[{ext}] mask {reg}'
+            utils.log_comment(utils.LOGFILE, logstr, verbose=verbose)
+            
+            sr = utils.SRegion(reg, wrap=False)
+            region_mask |= sr.path[0].contains_points(coo).reshape(sh)
+        
+        if in_place:
+            
+            im['DQ',ext].data |= (region_mask*dq_value).astype(im['DQ',ext].data.dtype)
+            im.flush()
+    
+    return region_mask
+
+
 def apply_region_mask(flt_file, dq_value=1024, verbose=True):
     """Apply DQ mask from a DS9 region file
 
     Parameters
     ----------
     flt_file : str
         Filename of a FLT exposure. The function searches for region files
@@ -3515,14 +3618,15 @@
 
         drz = utils.drizzle_from_visit(visit, drz_wcs,
                                        kernel='square',
                                        pixfrac=1.0,
                                        clean=False,
                                        verbose=False,
                                        scale_photom=False,
+                                       weight_type='median_err',
                                       )
         drz_h = drz[2]
 
         drz_h['PA_APER'] = pa_aper, 'PA_APER used for reference'
         drz_h['BKGANGLE'] = (','.join([f'{a:.1f}' for a in angles]), 
                              'Background angles')
         drz_h['NITANGLE'] = niter, 'Number of iterations for angle subtraction'
@@ -3973,14 +4077,15 @@
                                tweak_fit_order=-1,
                                skip_direct=False,
                                fix_stars=False,
                                tweak_max_dist=100.,
                                tweak_n_min=10,
                                tweak_threshold=1.5,
                                tweak_ref_exp=0,
+                               tweak_mosaic_iters=0,
                                align_simple=True,
                                single_image_CRs=True,
                                skymethod='localmin',
                                drizzle_params={},
                                iter_atol=1.e-4,
                                static_mask=False,
                                imaging_bkg_params=None,
@@ -4049,15 +4154,16 @@
     utils.log_function_arguments(utils.LOGFILE, frame,
                                  'prep.process_direct_grism_visit')
 
     #from stsci.tools import asnutil
     from stwcs import updatewcs
     from drizzlepac import updatehdr
     from drizzlepac.astrodrizzle import AstroDrizzle
-
+    from .aws import visit_processor
+    
     #################
     # Direct image processing
     #################
 
     # Copy FLT files from ../RAW
     isACS = '_flc' in direct['files'][0]  # Also UVIS
     isWFPC2 = '_c0' in direct['files'][0]
@@ -4187,18 +4293,56 @@
             tweak_align(direct_group=direct,
                         grism_group=grism,
                         max_dist=tweak_max_dist,
                         n_min=tweak_n_min,
                         key=' ',
                         drizzle=False,
                         ref_exp=tweak_ref_exp,
-                        threshold=tweak_threshold, fit_order=tweak_fit_order)
+                        threshold=tweak_threshold,
+                        fit_order=tweak_fit_order)
+            
+            ## Iterate the tweak correction
+            if tweak_mosaic_iters > 0:
+                tweak_kwargs = dict(max_dist=tweak_max_dist,
+                        n_min=tweak_n_min,
+                        key=' ',
+                        drizzle=False,
+                        ref_exp=tweak_ref_exp,
+                        threshold=tweak_threshold,
+                        fit_order=tweak_fit_order
+                        )
+                
+                # Reset JWST headers
+                if isJWST:
+                    for file in direct['files']:
+                        _ = jwst_utils.set_jwst_to_hst_keywords(file, reset=True)
+                    if 'files' in grism:
+                        for file in grism['files']:
+                            _ = jwst_utils.set_jwst_to_hst_keywords(file, reset=True)
+
+                iterate_tweak_align(direct, grism,
+                                    cat_threshold=7,
+                                    cleanup=True,
+                                    niter=tweak_mosaic_iters, 
+                                    tweak_kwargs=tweak_kwargs,
+                                    verbose=True)
+                
+                # Set back to pseudo-HST headers
+                if isJWST:
+                    for file in direct['files']:
+                        _ = jwst_utils.set_jwst_to_hst_keywords(file)
+                    if 'files' in grism:
+                        for file in grism['files']:
+                            _ = jwst_utils.set_jwst_to_hst_keywords(file)
 
         if (isACS) & (len(direct['files']) == 1) & single_image_CRs:
-            find_single_image_CRs(direct, simple_mask=False, with_ctx_mask=False, run_lacosmic=True)
+            find_single_image_CRs(direct,
+                                  simple_mask=False,
+                                  with_ctx_mask=False, 
+                                  run_lacosmic=True)
 
         # Get reference astrometry from GAIA, PS1, SDSS, WISE, etc.
         if radec is None:
             with pyfits.open(direct['files'][0]) as im:
                 _h0 = im[0].header
                 _h1 = im[1].header
                 
@@ -4502,15 +4646,17 @@
                                      include_saturated=True, 
                                      keep_bits=None,
                                      dryrun=False,
                                      skip=None,
                                      extra_wfc3ir_badpix=True,
                                      verbose=False,
                                      scale_photom=False,
-                                     calc_wcsmap=False)
+                                     weight_type='jwst',
+                                     calc_wcsmap=False,
+                                     )
                        
         _sci, _wht, _hdr, _files, _info = _
         _drcfile = glob.glob(f"{direct['product']}_dr*sci.fits")[0]
         _whtfile = _drcfile.replace('_sci.fits','_wht.fits')
         pyfits.PrimaryHDU(data=_sci, header=_hdr).writeto(_drcfile,
                                                           overwrite=True)
         pyfits.PrimaryHDU(data=_wht, header=_hdr).writeto(_whtfile,
@@ -4692,15 +4838,15 @@
             for e in ext:
                 flt['SCI', e].header['DFILTER'] = (direct_filter,
                                                    'Direct imaging filter')
             
             flt.flush()
 
 
-def tweak_align(direct_group={}, grism_group={}, max_dist=1., n_min=10, key=' ', threshold=3, drizzle=False, fit_order=-1, ref_exp=0):
+def tweak_align(direct_group={}, grism_group={}, max_dist=1., n_min=10, key=' ', threshold=3, drizzle=False, fit_order=-1, ref_exp=0, flux_radius=[0.5, 5], master_radec=None, make_figures=True):
     """Intra-visit shift alignment
     
     Parameters
     ----------
     direct_group : dict
         Visit info (`product`, `files`) for direct images
     
@@ -4717,16 +4863,20 @@
         Run `AstroDrizzle` after performing the alignment
     
     fit_order : int
         If > 0, then fit a polynomial to the derived shifts rather than 
         using the shifts themselves, e.g., for DASH imaging
     
     ref_exp : int
-        Index of the exposure to use as the reference for the tweak shifts
-        
+        Index of the exposure to use as the reference for the tweak shifts.  If < 0,
+        then use the exposure with the longest exposure time.
+    
+    flux_radius, master_radec, make_figures : float, str, bool
+        See `~grizli.prep.tweak_flt`
+    
     Returns
     -------
     Nothing, but updates WCS of direct and (optionally) grism exposures
     
     """
     frame = inspect.currentframe()
     utils.log_function_arguments(utils.LOGFILE, frame,
@@ -4738,19 +4888,35 @@
     if len(direct_group['files']) < 2:
         logstr = '# ! {0}: Only one direct image found, can\'t compute shifts'
         logstr = logstr.format(direct_group['product'])
 
         utils.log_comment(utils.LOGFILE, logstr, verbose=True)
         return True
 
-    wcs_ref, shift_dict = tweak_flt(files=direct_group['files'],
-                                    max_dist=max_dist, threshold=threshold,
-                                    verbose=True, ref_exp=ref_exp)
-
-    grism_matches = find_direct_grism_pairs(direct=direct_group, grism=grism_group, check_pixel=[507, 507], toler=0.1, key=key)
+    wcs_ref, shift_dict, cats, fig = tweak_flt(files=direct_group['files'],
+                                               max_dist=max_dist,
+                                               threshold=threshold,
+                                               verbose=True,
+                                               ref_exp=ref_exp,
+                                               master_radec=master_radec,
+                                               min_flux_radius=flux_radius[0],
+                                               max_flux_radius=flux_radius[1],
+                                               make_figures=make_figures,
+                                          )
+    
+    if fig is not None:
+        ax = fig.axes[0]
+        ax.set_title(direct_group['product'])
+        fig.savefig('{0}_shifts.png'.format(direct_group['product']))
+        
+    grism_matches = find_direct_grism_pairs(direct=direct_group,
+                                            grism=grism_group, check_pixel=[507, 507], 
+                                            toler=0.1,
+                                            key=key)
+    
     logstr = '\ngrism_matches = {0}\n'.format(grism_matches)
     utils.log_comment(utils.LOGFILE, logstr, verbose=True)
 
     fp = open('{0}_shifts.log'.format(direct_group['product']), 'w')
     fp.write('# flt xshift yshift rot scale N rmsx rmsy\n')
     fp.write('# fit_order: {0}\n'.format(fit_order))
 
@@ -4836,14 +5002,110 @@
         os.remove(skyfile)
         
     clean_drizzle(grism_group['product'])
 
     return True
 
 
+def iterate_tweak_align(direct, grism, cat_threshold=7, cleanup=True, niter=3, tweak_kwargs={}, max_ref_sources=150, verbose=True):
+    """
+    Iterate `~grizli.prep.tweak_align` aligning exposures to a mosaic created from 
+    those exposures
+    
+    Parameters
+    ----------
+    direct : dict
+        Visit dictionary
+    
+    Returns
+    -------
+    Nothing
+    """
+    from .aws import visit_processor
+    
+    if False:
+        tweak_kwargs = dict(max_dist=tweak_max_dist,
+                n_min=tweak_n_min,
+                key=' ',
+                drizzle=False,
+                ref_exp=tweak_ref_exp,
+                threshold=tweak_threshold,
+                fit_order=tweak_fit_order
+                )
+    
+    # Copies
+    if not os.path.exists('TweakBackup'):
+        print('# iterate_tweak_align: make copies to ./TweakBackup')
+        
+        os.mkdir('TweakBackup')
+
+    for file in direct['files']:
+        shutil.copy(file, './TweakBackup')
+
+    # Mosaic parameters
+    _res = visit_processor.res_query_from_local(files=direct['files'])
+    _hdu = utils.make_maximal_wcs(direct['files'], pixel_scale=None,
+                                  get_hdu=True, pad=4, verbose=False)
+    _wcs = pywcs.WCS(_hdu.header)
+    
+    tmp_root = f"tweak_{direct['product']}"
+    
+    for iter_i in range(niter):
+        
+        logstr = f'# prep.iterate_tweak_align: iteration {iter_i}'
+        utils.log_comment(utils.LOGFILE, logstr, verbose=verbose)
+        
+        tmp_root_i = f"{tmp_root}_{iter_i}"
+        
+        _ = visit_processor.cutout_mosaic(rootname=tmp_root_i, 
+                                      product='{rootname}',
+                                      ir_wcs=_wcs, half_optical=False,
+                                      kernel='square', pixfrac=0.8,
+                                      res=_res,
+                                      clean_flt=False,
+                                      gzip_output=False,
+                                      skip_existing=False,
+                                      s3output=None,
+                                      verbose=False)
+        
+        cat = make_SEP_catalog(tmp_root_i,
+                               threshold=cat_threshold,
+                               verbose=False)
+        ok = cat['MASK_APER_0'] == 0
+
+        print(ok.sum())
+        so = np.argsort(cat['MAG_AUTO'][ok])[:max_ref_sources]
+
+        table_to_radec(cat[ok][so], f"{tmp_root_i}.radec")
+        
+        # Derive shifts from original files
+        for file in direct['files']:
+            shutil.copy(f'./TweakBackup/{file}', './')
+        
+        # Do alignment and update exposure WCS
+        tweak_align(direct_group=direct,
+                    grism_group=grism,
+                    master_radec=f"{tmp_root_i}.radec",
+                    **tweak_kwargs)
+    
+    if cleanup:
+        
+        print('# iterate_tweak_align: remove ./TweakBackup')
+        
+        for file in direct['files']:
+            os.remove(f'./TweakBackup/{file}')
+            
+        os.rmdir('./TweakBackup')
+
+        files = glob.glob(f'{tmp_root}*')
+        for file in files:
+            print(f'# remove {file}')
+            os.remove(file)
+
+
 def get_visit_radec_from_database(visit, nmax=200):
     """
     Get reference astrometry from grizli database
     
     Parameters
     ----------
     visit : dict
@@ -5009,51 +5271,77 @@
     sci.close()
 
 
 MATCH_KWS = dict(maxKeep=10, auto_keep=3, auto_transform=None, auto_limit=3,
                  size_limit=[5, 1800], ignore_rot=True, ignore_scale=True, 
                  ba_max=0.9)
                                 
-def tweak_flt(files=[], max_dist=0.4, threshold=3, verbose=True, tristars_kwargs=MATCH_KWS, ref_exp=0, use_sewpy=False):
+def tweak_flt(files=[], max_dist=0.4, threshold=3, min_flux_radius=0.5, max_flux_radius=5, max_pixels=1.0, max_nmask=0, verbose=True, tristars_kwargs=MATCH_KWS, ref_exp=0, use_sewpy=False, master_radec=None, make_figures=False):
     """Refine shifts of FLT files
     
     Parameters
     ----------
     files : list
         List of flt filenames
     
     max_dist : float
         Maximum shift distance to allow
     
     threshold : float
         Source detection threshold for `sep.extract`
     
+    min_flux_radius, max_flux_radius : float
+        Range of ``FLUX_RADIUS`` values to allow
+    
+    max_pixels : float
+        Maximum pixel offset relative to median to allow for sources in each 
+        exposure catalog
+    
+    max_nmask : float
+        Maximum value of ``MASK_APER_0`` to allow, i.e., to remove sources with central
+        saturated pixels
+    
     verbose : bool
         Status messages
     
     tristars_kwargs : dict
         Keyword arguments for `tristars.match.match_catalog_tri`
     
     ref_exp : int
-        Index of the exposure to use as the reference for the tweak shifts
+        Index of the exposure to use as the reference for the tweak shifts.  If < 0, 
+        then use the exposure with the longest integration time.
     
     use_sewpy : bool
         Use `sewpy` for source detection (deprecated)
     
+    master_radec : str
+        Filename of a list of reference ``(ra,dec)`` positions to match.  If not
+        provided, then align to the first exposure of the list
+    
+    make_figures : int, bool
+        If True, then make a diagnostic figure with the shift residuals.
+        If 2, then make individual `tristars` match figures as well.
+    
     Returns
     -------
     ref_wcs : `~astropy.wcs.WCS`
         Reference WCS (WCS of the first file in `files`)
     
     shift_dict : dict
         Shift dictionary with keys from `files` and values like
         ``[xshift, yshift, rot, scale, N, rms]``.  Note that only shifts are 
         fit, so `rot = 0.` and `scale = 1.`.  ``N`` is the number of sources
         used for the fit.
         
+    cats : list
+        List of tuples of the catalog and WCS derived from each exposure
+    
+    fig : None, Figure
+        Returns the figure object if ``make_figures`` tests True
+    
     """
     import scipy.spatial
 
     try:
         import tristars
         from tristars.match import match_catalog_tri, match_diagnostic_plot
     except:
@@ -5068,32 +5356,37 @@
         sewpy = None
         use_sewpy = False
 
     # Make FLT catalogs
     cats = []
     logstr = '### Tweak alignment (use_sewpy={0}) '.format(use_sewpy)
     utils.log_comment(utils.LOGFILE, logstr, verbose=True)
-
+    
+    exptime = np.zeros(len(files))
+    
     for i, file in enumerate(files):
         root = file.split('.fits')[0]
 
         im = pyfits.open(file)
         try:
             ok = im['DQ', 1].data == 0
         except:
             ok = np.isfinite(im['SCI', 1].data)
-
+        
+        if 'EXPTIME' in im[0].header:
+            exptime[i] = im[0].header['EXPTIME']
+            
         sci = im['SCI', 1].data*ok - np.nanmedian(im['SCI', 1].data[ok])
 
         header = im['SCI', 1].header.copy()
 
         for k in ['PHOTFNU', 'PHOTFLAM', 'PHOTPLAM', 'FILTER']:
             if k in im[0].header:
                 header[k] = im[0].header[k]
-
+        
         hst_filter = utils.parse_filter_from_header(im[0].header)
         header['FILTER'] = hst_filter
 
         pyfits.writeto('{0}_xsci.fits'.format(root), data=sci,
                        header=header,
                        overwrite=True)
 
@@ -5138,66 +5431,106 @@
 
         for ext in ['_xsci', '_xrms', '_xwht', '_bkg', '_seg', '.cat']:
             file = '{0}{1}.fits'.format(root, ext)
             if os.path.exists(file):
                 os.remove(file)
         
         im.close()
+    
+    if ref_exp < 0:
+        if exptime.max() > 0:
+            ref_exp = np.argmax(exptime)
+        else:
+            ref_exp = 0
         
-    if ref_exp < len(cats):
+        c0, wcs_0 = cats[ref_exp]
+        
+    elif ref_exp < len(cats):
         c0, wcs_0 = cats[ref_exp]
     else:
         c0, wcs_0 = cats[0]
     
-    not_CR = c0['FLUX_RADIUS'] > 1.5
+    not_CR = c0['FLUX_RADIUS'] > min_flux_radius
+    not_CR &= c0['FLUX_RADIUS'] < max_flux_radius
+    not_CR &= c0['MASK_APER_0'] <= max_nmask
+    
     c0 = c0[not_CR]
 
-    xy_0 = np.array([c0['X_IMAGE'], c0['Y_IMAGE']]).T
+    if master_radec is None:
+        xy_0 = np.array([c0['X_IMAGE'], c0['Y_IMAGE']]).T
+    else:
+        logstr = f'### reference sources from {master_radec}'
+        utils.log_comment(utils.LOGFILE, logstr, verbose=True)
+        
+        rd_ref = np.loadtxt(master_radec)
+        xy_0 = np.array(wcs_0.all_world2pix(rd_ref[:,0], rd_ref[:,1], 1)).T
+        
     tree = scipy.spatial.cKDTree(xy_0, 10)
-
+    
+    if make_figures:
+        fig, ax = plt.subplots(1,1,figsize=(5,5))
+    else:
+        fig = None
+        
     try:
         # Use Tristars for matching
 
         # First 100
         NMAX = 100
         if len(xy_0) > NMAX:
-            so = np.argsort(c0['MAG_AUTO'])
-            xy_0 = xy_0[so[:NMAX], :]
-
+            if master_radec is None:
+                so = np.argsort(c0['MAG_AUTO'])
+                xy_0 = xy_0[so[:NMAX], :]
+        
         shift_dict = OrderedDict()
         for i in range(0, len(files)):
             c_ii, wcs_i = cats[i]
 
-            not_CR = c_ii['FLUX_RADIUS'] > 1.5
+            not_CR = c_ii['FLUX_RADIUS'] > min_flux_radius
+            not_CR &= c_ii['FLUX_RADIUS'] < max_flux_radius
+            not_CR &= c_ii['MASK_APER_0'] <= max_nmask
+            
             c_i = c_ii[not_CR]
 
             # SExtractor doesn't do SIP WCS?
             rd = np.array(wcs_i.all_pix2world(c_i['X_IMAGE'], c_i['Y_IMAGE'], 1))
             xy = np.array(wcs_0.all_world2pix(rd.T, 1))
 
             if len(xy) > NMAX:
                 so = np.argsort(c_i['MAG_AUTO'])
                 xy = xy[so[:NMAX], :]
 
             pair_ix = match_catalog_tri(xy, xy_0, **tristars_kwargs)
 
-            # if False:
-            #     match_diagnostic_plot(xy, xy_0, pair_ix, tf=None, 
-            #                           new_figure=False)
-
+            if make_figures > 1:
+                match_diagnostic_plot(xy, xy_0, pair_ix, tf=None,
+                                      new_figure=True)
+                
             dr = xy[pair_ix[:, 0], :] - xy_0[pair_ix[:, 1], :]
+            
             ok = dr.max(axis=1) < 1000
+            
+            dx = np.median(dr[ok, :], axis=0)
+            
+            ok &= np.sqrt(((dr-dx)**2).sum(axis=1)) < max_pixels
+            
             dx = np.median(dr[ok, :], axis=0)
             rms = np.std(dr[ok, :], axis=0)/np.sqrt(ok.sum())
-
+            
+            if make_figures:
+                ax.scatter(*(dr[ok,:] - dx).T, alpha=0.5, label=files[i])
+                
             shift_dict[files[i]] = [dx[0], dx[1], 0.0, 1.0, ok.sum(), rms]
-
+            
             lstr = "# tw {0} [{1:6.3f}, {2:6.3f}]  [{3:6.3f}, {4:6.3f}] N={5}"
             lstr = lstr.format(files[i], dx[0], dx[1], rms[0], rms[1],
                                    ok.sum())
+            
+            lstr += f' Ntot={len(c_i)}'
+            
             utils.log_comment(utils.LOGFILE, lstr, verbose=verbose)
 
     except:
         utils.log_exception(utils.LOGFILE, traceback)
         utils.log_comment(utils.LOGFILE, "# !! `tweak_flt` tristars failed")
 
         shift_dict = OrderedDict()
@@ -5225,17 +5558,27 @@
             rms = np.std(dr[ok, :], axis=0)/np.sqrt(ok.sum())
 
             shift_dict[files[i]] = [dx[0], dx[1], 0.0, 1.0, ok.sum(), rms]
 
             lstr = '# tw {0} {1} {2} N={3}'
             lstr = logstr.format(files[i], dx, rms, ok.sum())
             utils.log_comment(utils.LOGFILE, logstr, verbose=verbose)
-
+    
+    if make_figures:
+        ax.set_xlim(-1.5*max_pixels,1.5*max_pixels)
+        ax.set_ylim(-1.5*max_pixels,1.5*max_pixels)
+        ax.set_xlabel(r'$\Delta x$, pixels')
+        ax.set_xlabel(r'$\Delta y$, pixels')
+        fig.tight_layout(pad=1)
+        
+        ax.grid()
+        
     wcs_ref = cats[0][1]
-    return wcs_ref, shift_dict
+    
+    return wcs_ref, shift_dict, cats, fig
 
 
 def apply_tweak_shifts(wcs_ref, shift_dict, grism_matches={}, verbose=True, log=True):
     """
     Apply derived shifts to exposure WCS
     
     Parameters
@@ -5269,15 +5612,19 @@
         utils.log_function_arguments(utils.LOGFILE, frame,
                                      'prep.apply_tweak_shifts')
 
     hdu = wcs_ref.to_fits(relax=True)
     file0 = list(shift_dict.keys())[0].split('.fits')[0]
     tweak_file = '{0}_tweak_wcs.fits'.format(file0)
     hdu.writeto(tweak_file, overwrite=True)
+    
     for file in shift_dict:
+        if not os.path.exists(file):
+            continue
+        
         xyscale = shift_dict[file][:2]+[0., 1]
         update_wcs_fits_log(file, wcs_ref, xyscale=xyscale, initialize=True,
                             replace=('.fits', '.wcslog.fits'),
                             wcsname='SHIFT')
 
         updatehdr.updatewcs_with_shift(file, tweak_file,
                                         xsh=shift_dict[file][0],
```

### Comparing `grizli-1.8.9/grizli/stack.py` & `grizli-1.9/grizli/stack.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/fit_args.npy` & `grizli-1.9/grizli/tests/data/fit_args.npy`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/j033216m2743_00152.beams.fits` & `grizli-1.9/grizli/tests/data/j033216m2743_00152.beams.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz` & `grizli-1.9/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz` & `grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz` & `grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz` & `grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz` & `grizli-1.9/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/jwst-headers/strip_data.py` & `grizli-1.9/grizli/tests/data/jwst-headers/strip_data.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/niriss_jw01324001001_test.beams.fits` & `grizli-1.9/grizli/tests/data/niriss_jw01324001001_test.beams.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/data/wfc3-parse-test.tar.gz` & `grizli-1.9/grizli/tests/data/wfc3-parse-test.tar.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_autoscript.py` & `grizli-1.9/grizli/tests/test_autoscript.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_cutils.py` & `grizli-1.9/grizli/tests/test_cutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_fits.py` & `grizli-1.9/grizli/tests/test_fits.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_grismconf.py` & `grizli-1.9/grizli/tests/test_grismconf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_jwst.py` & `grizli-1.9/grizli/tests/test_jwst.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/tests/test_utils.py` & `grizli-1.9/grizli/tests/test_utils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/utils.py` & `grizli-1.9/grizli/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -5794,12849 +5794,13224 @@
 00016a10: 2020 2069 6620 7365 6c66 2e65 7272 2069     if self.err i
 00016a20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
 00016a30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
 00016a40: 726e 2074 656d 705f 666c 7578 2c20 7465  rn temp_flux, te
 00016a50: 6d70 5f65 7272 0a20 2020 2020 2020 2020  mp_err.         
 00016a60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
 00016a70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00016a80: 7465 6d70 5f66 6c75 780a 0a0a 6465 6620  temp_flux...def 
-00016a90: 6c6f 6164 5f74 656d 706c 6174 6573 2866  load_templates(f
-00016aa0: 7768 6d3d 3430 302c 206c 696e 655f 636f  whm=400, line_co
-00016ab0: 6d70 6c65 7865 733d 5472 7565 2c20 7374  mplexes=True, st
-00016ac0: 6172 733d 4661 6c73 652c 0a20 2020 2020  ars=False,.     
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00016ae0: 6c6c 5f6c 696e 655f 6c69 7374 3d44 4546  ll_line_list=DEF
-00016af0: 4155 4c54 5f4c 494e 455f 4c49 5354 2c20  AULT_LINE_LIST, 
-00016b00: 636f 6e74 696e 7575 6d5f 6c69 7374 3d4e  continuum_list=N
-00016b10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00016b20: 2020 2020 2020 2020 6673 7073 5f74 656d          fsps_tem
-00016b30: 706c 6174 6573 3d46 616c 7365 2c20 616c  plates=False, al
-00016b40: 665f 7465 6d70 6c61 7465 3d46 616c 7365  f_template=False
-00016b50: 2c20 6c6f 7265 6e74 7a3d 4661 6c73 6529  , lorentz=False)
-00016b60: 3a0a 2020 2020 2222 2247 656e 6572 6174  :.    """Generat
-00016b70: 6520 6120 6c69 7374 206f 6620 7465 6d70  e a list of temp
-00016b80: 6c61 7465 7320 666f 7220 6669 7474 696e  lates for fittin
-00016b90: 6720 746f 2074 6865 2067 7269 736d 2073  g to the grism s
-00016ba0: 7065 6374 7261 0a0a 2020 2020 5468 6520  pectra..    The 
-00016bb0: 6469 6666 6572 656e 7420 7365 7473 206f  different sets o
-00016bc0: 6620 636f 6e74 696e 7575 6d20 7465 6d70  f continuum temp
-00016bd0: 6c61 7465 7320 6172 6520 7374 6f72 6564  lates are stored
-00016be0: 2069 6e0a 0a20 2020 2020 2020 203e 3e3e   in..        >>>
-00016bf0: 2074 656d 705f 6469 7220 3d20 6f73 2e70   temp_dir = os.p
-00016c00: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
-00016c10: 5041 5448 2c20 2774 656d 706c 6174 6573  PATH, 'templates
-00016c20: 2729 0a0a 2020 2020 5061 7261 6d65 7465  ')..    Paramete
-00016c30: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00016c40: 2d0a 2020 2020 6677 686d 203a 2066 6c6f  -.    fwhm : flo
-00016c50: 6174 0a20 2020 2020 2020 2046 5748 4d20  at.        FWHM 
-00016c60: 6f66 2061 2047 6175 7373 6961 6e2c 2069  of a Gaussian, i
-00016c70: 6e20 6b6d 2f73 2c20 7468 6174 2069 7320  n km/s, that is 
-00016c80: 636f 6e76 6f6c 7665 6420 7769 7468 2074  convolved with t
-00016c90: 6865 2065 6d69 7373 696f 6e0a 2020 2020  he emission.    
-00016ca0: 2020 2020 6c69 6e65 2074 656d 706c 6174      line templat
-00016cb0: 6573 2e20 2049 6620 746f 6f20 6e61 7272  es.  If too narr
-00016cc0: 6f77 2c20 7468 656e 2063 616e 2073 6565  ow, then can see
-00016cd0: 2070 6978 656c 2065 6666 6563 7473 2069   pixel effects i
-00016ce0: 6e20 7468 650a 2020 2020 2020 2020 6669  n the.        fi
-00016cf0: 7473 2061 7320 6120 6675 6e63 7469 6f6e  ts as a function
-00016d00: 206f 6620 7265 6473 6869 6674 2e0a 0a20   of redshift... 
-00016d10: 2020 206c 696e 655f 636f 6d70 6c65 7865     line_complexe
-00016d20: 7320 3a20 626f 6f6c 0a20 2020 2020 2020  s : bool.       
-00016d30: 2047 656e 6572 6174 6520 6c69 6e65 2063   Generate line c
-00016d40: 6f6d 706c 6578 2074 656d 706c 6174 6573  omplex templates
-00016d50: 2077 6974 6820 6669 7865 6420 666c 7578   with fixed flux
-00016d60: 2072 6174 696f 7320 7261 7468 6572 2074   ratios rather t
-00016d70: 6861 6e0a 2020 2020 2020 2020 696e 6469  han.        indi
-00016d80: 7669 6475 616c 206c 696e 6573 2e20 5468  vidual lines. Th
-00016d90: 6973 2069 7320 7573 6566 756c 2066 6f72  is is useful for
-00016da0: 2074 6865 2072 6564 7368 6966 7420 6669   the redshift fi
-00016db0: 7473 2077 6865 7265 2074 6865 7265 0a20  ts where there. 
-00016dc0: 2020 2020 2020 2077 6f75 6c64 2062 6520         would be 
-00016dd0: 7265 6473 6869 6674 2064 6567 656e 6572  redshift degener
-00016de0: 6163 6965 7320 6966 2074 6865 206c 696e  acies if the lin
-00016df0: 6520 666c 7578 6573 2066 6f72 2069 6e64  e fluxes for ind
-00016e00: 6976 6964 7561 6c0a 2020 2020 2020 2020  ividual.        
-00016e10: 6c69 6e65 7320 7765 7265 2061 6c6c 6f77  lines were allow
-00016e20: 6564 2074 6f20 7661 7279 2063 6f6d 706c  ed to vary compl
-00016e30: 6574 656c 7920 6672 6565 6c79 2e20 5365  etely freely. Se
-00016e40: 6520 7468 6520 6c69 7374 206f 660a 2020  e the list of.  
-00016e50: 2020 2020 2020 6176 6169 6c61 626c 6520        available 
-00016e60: 6c69 6e65 7320 616e 6420 6c69 6e65 2067  lines and line g
-00016e70: 726f 7570 7320 696e 0a20 2020 2020 2020  roups in.       
-00016e80: 2060 7e67 7269 7a6c 692e 7574 696c 732e   `~grizli.utils.
-00016e90: 6765 745f 6c69 6e65 5f77 6176 656c 656e  get_line_wavelen
-00016ea0: 6774 6873 602e 2043 7572 7265 6e74 6c79  gths`. Currently
-00016eb0: 2c0a 2020 2020 2020 2020 606c 696e 655f  ,.        `line_
-00016ec0: 636f 6d70 6c65 7865 733d 5472 7565 6020  complexes=True` 
-00016ed0: 6765 6e65 7261 7465 7320 7468 6520 666f  generates the fo
-00016ee0: 6c6c 6f77 696e 6720 6772 6f75 7073 3a0a  llowing groups:.
-00016ef0: 0a20 2020 2020 2020 2020 2020 2048 612b  .            Ha+
-00016f00: 4e49 492b 5349 492b 5349 4949 2b48 650a  NII+SII+SIII+He.
-00016f10: 2020 2020 2020 2020 2020 2020 4f49 4949              OIII
-00016f20: 2b48 620a 2020 2020 2020 2020 2020 2020  +Hb.            
-00016f30: 4f49 492b 4e65 0a0a 2020 2020 7374 6172  OII+Ne..    star
-00016f40: 7320 3a20 626f 6f6c 0a20 2020 2020 2020  s : bool.       
-00016f50: 2047 6574 2073 7465 6c6c 6172 2074 656d   Get stellar tem
-00016f60: 706c 6174 6573 2072 6174 6865 7220 7468  plates rather th
-00016f70: 616e 2067 616c 6178 6965 7320 2b20 6c69  an galaxies + li
-00016f80: 6e65 730a 0a20 2020 2066 756c 6c5f 6c69  nes..    full_li
-00016f90: 6e65 5f6c 6973 7420 3a20 4e6f 6e65 206f  ne_list : None o
-00016fa0: 7220 6c69 7374 0a20 2020 2020 2020 2046  r list.        F
-00016fb0: 756c 6c20 7365 7420 6f66 206c 696e 6573  ull set of lines
-00016fc0: 2074 6f20 7472 792e 2020 5468 6520 6465   to try.  The de
-00016fd0: 6661 756c 7420 6973 2073 6574 2069 6e20  fault is set in 
-00016fe0: 7468 6520 676c 6f62 616c 2076 6172 6961  the global varia
-00016ff0: 626c 650a 2020 2020 2020 2020 607e 6772  ble.        `~gr
-00017000: 697a 6c69 2e75 7469 6c73 2e44 4546 4155  izli.utils.DEFAU
-00017010: 4c54 5f4c 494e 455f 4c49 5354 602e 0a0a  LT_LINE_LIST`...
-00017020: 2020 2020 2020 2020 5468 6520 6675 6c6c          The full
-00017030: 206c 6973 7420 6f66 2069 6d70 6c65 6d65   list of impleme
-00017040: 6e74 6564 206c 696e 6573 2069 7320 696e  nted lines is in
-00017050: 2060 7e67 7269 7a6c 692e 7574 696c 732e   `~grizli.utils.
-00017060: 6765 745f 6c69 6e65 5f77 6176 656c 656e  get_line_wavelen
-00017070: 6774 6873 602e 0a0a 2020 2020 636f 6e74  gths`...    cont
-00017080: 696e 7575 6d5f 6c69 7374 203a 204e 6f6e  inuum_list : Non
-00017090: 6520 6f72 206c 6973 740a 2020 2020 2020  e or list.      
-000170a0: 2020 4f76 6572 7269 6465 2074 6865 2064    Override the d
-000170b0: 6566 6175 6c74 2063 6f6e 7469 6e75 756d  efault continuum
-000170c0: 2074 656d 706c 6174 6573 2069 6620 4e6f   templates if No
-000170d0: 6e65 2e0a 0a20 2020 2066 7370 735f 7465  ne...    fsps_te
-000170e0: 6d70 6c61 7465 7320 3a20 626f 6f6c 0a20  mplates : bool. 
-000170f0: 2020 2020 2020 2049 6620 5472 7565 2c20         If True, 
-00017100: 6765 7420 7468 6520 4653 5053 204e 4d46  get the FSPS NMF
-00017110: 2074 656d 706c 6174 6573 2e0a 0a20 2020   templates...   
-00017120: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00017130: 2d2d 2d2d 0a20 2020 2074 656d 705f 6c69  ----.    temp_li
-00017140: 7374 203a 2064 6963 7469 6f6e 6172 7920  st : dictionary 
-00017150: 6f66 2060 7e67 7269 7a6c 692e 7574 696c  of `~grizli.util
-00017160: 732e 5370 6563 7472 756d 5465 6d70 6c61  s.SpectrumTempla
-00017170: 7465 6020 6f62 6a65 6374 730a 2020 2020  te` objects.    
-00017180: 2020 2020 4f75 7470 7574 2074 656d 706c      Output templ
-00017190: 6174 6520 6c69 7374 0a0a 2020 2020 2222  ate list..    ""
-000171a0: 220a 0a20 2020 2069 6620 7374 6172 733a  "..    if stars:
-000171b0: 0a20 2020 2020 2020 2023 2074 656d 706c  .        # templ
-000171c0: 6174 6573 203d 2067 6c6f 622e 676c 6f62  ates = glob.glob
-000171d0: 2827 2573 2f74 656d 706c 6174 6573 2f50  ('%s/templates/P
-000171e0: 6963 6b6c 6573 5f73 7461 7273 2f65 7874  ickles_stars/ext
-000171f0: 2f2a 6461 7427 2025 2847 5249 5a4c 495f  /*dat' %(GRIZLI_
-00017200: 5041 5448 2929 0a20 2020 2020 2020 2023  PATH)).        #
-00017210: 2074 656d 706c 6174 6573 203d 205b 5d0a   templates = [].
-00017220: 2020 2020 2020 2020 2320 666f 7220 7420          # for t 
-00017230: 696e 2027 6f62 6166 676b 6d72 7727 3a0a  in 'obafgkmrw':.
-00017240: 2020 2020 2020 2020 2320 2020 2020 7465          #     te
-00017250: 6d70 6c61 7465 732e 6578 7465 6e64 2820  mplates.extend( 
-00017260: 676c 6f62 2e67 6c6f 6228 2725 732f 7465  glob.glob('%s/te
-00017270: 6d70 6c61 7465 732f 5069 636b 6c65 735f  mplates/Pickles_
-00017280: 7374 6172 732f 6578 742f 756b 2573 2a64  stars/ext/uk%s*d
-00017290: 6174 2720 2528 6f73 2e67 6574 656e 7628  at' %(os.getenv(
-000172a0: 2754 4852 4545 4448 5354 2729 2c20 7429  'THREEDHST'), t)
-000172b0: 2929 0a20 2020 2020 2020 2023 2074 656d  )).        # tem
-000172c0: 706c 6174 6573 2e65 7874 656e 6428 676c  plates.extend(gl
-000172d0: 6f62 2e67 6c6f 6228 2725 732f 7465 6d70  ob.glob('%s/temp
-000172e0: 6c61 7465 732f 5350 4558 2f73 7065 782d  lates/SPEX/spex-
-000172f0: 7072 6973 6d2d 4d2a 7478 7427 2025 286f  prism-M*txt' %(o
-00017300: 732e 6765 7465 6e76 2827 5448 5245 4544  s.getenv('THREED
-00017310: 4853 5427 2929 2929 0a20 2020 2020 2020  HST')))).       
-00017320: 2023 2074 656d 706c 6174 6573 2e65 7874   # templates.ext
-00017330: 656e 6428 676c 6f62 2e67 6c6f 6228 2725  end(glob.glob('%
-00017340: 732f 7465 6d70 6c61 7465 732f 5350 4558  s/templates/SPEX
-00017350: 2f73 7065 782d 7072 6973 6d2d 5b4c 545d  /spex-prism-[LT]
-00017360: 2a74 7874 2720 2528 6f73 2e67 6574 656e  *txt' %(os.geten
-00017370: 7628 2754 4852 4545 4448 5354 2729 2929  v('THREEDHST')))
-00017380: 290a 2020 2020 2020 2020 230a 2020 2020  ).        #.    
-00017390: 2020 2020 2320 2374 656d 706c 6174 6573      # #templates
-000173a0: 203d 2067 6c6f 622e 676c 6f62 2827 2f55   = glob.glob('/U
-000173b0: 7365 7273 2f62 7261 6d6d 6572 2f44 6f77  sers/brammer/Dow
-000173c0: 6e6c 6f61 6473 2f74 656d 706c 6174 6573  nloads/templates
-000173d0: 2f73 7065 782a 7478 7427 290a 2020 2020  /spex*txt').    
-000173e0: 2020 2020 2320 7465 6d70 6c61 7465 7320      # templates 
-000173f0: 3d20 676c 6f62 2e67 6c6f 6228 2762 7067  = glob.glob('bpg
-00017400: 732f 2a61 7363 6969 2729 0a20 2020 2020  s/*ascii').     
-00017410: 2020 2023 2069 6e66 6f20 3d20 6361 7449     # info = catI
-00017420: 4f2e 5461 626c 6528 2762 7067 732f 6270  O.Table('bpgs/bp
-00017430: 6773 2e69 6e66 6f27 290a 2020 2020 2020  gs.info').      
-00017440: 2020 2320 7479 7065 203d 206e 702e 6172    # type = np.ar
-00017450: 7261 7928 5b74 5b3a 325d 2066 6f72 2074  ray([t[:2] for t
-00017460: 2069 6e20 696e 666f 5b27 7479 7065 275d   in info['type']
-00017470: 5d29 0a20 2020 2020 2020 2023 2074 656d  ]).        # tem
-00017480: 706c 6174 6573 203d 205b 5d0a 2020 2020  plates = [].    
-00017490: 2020 2020 2320 666f 7220 7420 696e 2027      # for t in '
-000174a0: 4f42 4146 474b 4d27 3a0a 2020 2020 2020  OBAFGKM':.      
-000174b0: 2020 2320 2020 2020 7465 7374 203d 2074    #     test = t
-000174c0: 7970 6520 3d3d 2027 2d25 7327 2025 2874  ype == '-%s' %(t
-000174d0: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-000174e0: 736f 203d 206e 702e 6172 6773 6f72 7428  so = np.argsort(
-000174f0: 696e 666f 5b27 7479 7065 275d 5b74 6573  info['type'][tes
-00017500: 745d 290a 2020 2020 2020 2020 2320 2020  t]).        #   
-00017510: 2020 7465 6d70 6c61 7465 732e 6578 7465    templates.exte
-00017520: 6e64 2869 6e66 6f5b 2766 696c 6527 5d5b  nd(info['file'][
-00017530: 7465 7374 5d5b 736f 5d29 0a20 2020 2020  test][so]).     
-00017540: 2020 2023 0a20 2020 2020 2020 2023 2074     #.        # t
-00017550: 656d 705f 6c69 7374 203d 204f 7264 6572  emp_list = Order
-00017560: 6564 4469 6374 2829 0a20 2020 2020 2020  edDict().       
-00017570: 2023 2066 6f72 2074 656d 7020 696e 2074   # for temp in t
-00017580: 656d 706c 6174 6573 3a0a 2020 2020 2020  emplates:.      
-00017590: 2020 2320 2020 2020 2364 6174 6120 3d20    #     #data = 
-000175a0: 6e70 2e6c 6f61 6474 7874 2827 6270 6773  np.loadtxt('bpgs
-000175b0: 2f27 2b74 656d 702c 2075 6e70 6163 6b3d  /'+temp, unpack=
-000175c0: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
-000175d0: 2020 2020 6461 7461 203d 206e 702e 6c6f      data = np.lo
-000175e0: 6164 7478 7428 7465 6d70 2c20 756e 7061  adtxt(temp, unpa
-000175f0: 636b 3d54 7275 6529 0a20 2020 2020 2020  ck=True).       
-00017600: 2023 2020 2020 2023 6461 7461 5b30 5d20   #     #data[0] 
-00017610: 2a3d 2031 2e65 3420 2320 7370 6578 0a20  *= 1.e4 # spex. 
-00017620: 2020 2020 2020 2023 2020 2020 2073 636c         #     scl
-00017630: 203d 206e 702e 696e 7465 7270 2835 3530   = np.interp(550
-00017640: 302e 2c20 6461 7461 5b30 5d2c 2064 6174  0., data[0], dat
-00017650: 615b 315d 290a 2020 2020 2020 2020 2320  a[1]).        # 
-00017660: 2020 2020 6e61 6d65 203d 206f 732e 7061      name = os.pa
-00017670: 7468 2e62 6173 656e 616d 6528 7465 6d70  th.basename(temp
-00017680: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00017690: 2369 7820 3d20 696e 666f 5b27 6669 6c65  #ix = info['file
-000176a0: 275d 203d 3d20 7465 6d70 0a20 2020 2020  '] == temp.     
-000176b0: 2020 2023 2020 2020 2023 6e61 6d65 3d27     #     #name='
-000176c0: 2535 7320 2573 2720 2528 696e 666f 5b27  %5s %s' %(info['
-000176d0: 7479 7065 275d 5b69 785d 5b30 5d5b 313a  type'][ix][0][1:
-000176e0: 5d2c 2074 656d 702e 7370 6c69 7428 272e  ], temp.split('.
-000176f0: 6173 2729 5b30 5d29 0a20 2020 2020 2020  as')[0]).       
-00017700: 2023 2020 2020 2070 7269 6e74 286e 616d   #     print(nam
-00017710: 6529 0a20 2020 2020 2020 2023 2020 2020  e).        #    
-00017720: 2074 656d 705f 6c69 7374 5b6e 616d 655d   temp_list[name]
-00017730: 203d 2075 7469 6c73 2e53 7065 6374 7275   = utils.Spectru
-00017740: 6d54 656d 706c 6174 6528 7761 7665 3d64  mTemplate(wave=d
-00017750: 6174 615b 305d 2c0a 2020 2020 2020 2020  ata[0],.        
-00017760: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00017770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017780: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017790: 6c75 783d 6461 7461 5b31 5d2f 7363 6c29  lux=data[1]/scl)
-000177a0: 0a0a 2020 2020 2020 2020 2320 6e70 2e73  ..        # np.s
-000177b0: 6176 6528 2773 7461 7273 5f62 7067 732e  ave('stars_bpgs.
-000177c0: 6e70 7927 2c20 5b74 656d 705f 6c69 7374  npy', [temp_list
-000177d0: 5d29 0a0a 2020 2020 2020 2020 2320 7461  ])..        # ta
-000177e0: 6c6c 203d 206e 702e 6c6f 6164 286f 732e  ll = np.load(os.
-000177f0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
-00017800: 5f50 4154 482c 0a20 2020 2020 2020 2023  _PATH,.        #
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017830: 2020 2774 656d 706c 6174 6573 2f73 7461    'templates/sta
-00017840: 7273 2e6e 7079 2729 295b 305d 0a20 2020  rs.npy'))[0].   
-00017850: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
-00017860: 2072 6574 7572 6e20 7461 6c6c 0a20 2020   return tall.   
-00017870: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
-00017880: 2074 656d 705f 6c69 7374 203d 204f 7264   temp_list = Ord
-00017890: 6572 6564 4469 6374 2829 0a20 2020 2020  eredDict().     
-000178a0: 2020 2023 2066 6f72 206b 2069 6e20 7461     # for k in ta
-000178b0: 6c6c 3a0a 2020 2020 2020 2020 2320 2020  ll:.        #   
-000178c0: 2020 6966 206b 2e73 7461 7274 7377 6974    if k.startswit
-000178d0: 6828 2775 6b27 293a 0a20 2020 2020 2020  h('uk'):.       
-000178e0: 2023 2020 2020 2020 2020 2074 656d 705f   #         temp_
-000178f0: 6c69 7374 5b6b 5d20 3d20 7461 6c6c 5b6b  list[k] = tall[k
-00017900: 5d0a 2020 2020 2020 2020 230a 2020 2020  ].        #.    
-00017910: 2020 2020 2320 7265 7475 726e 2074 656d      # return tem
-00017920: 705f 6c69 7374 0a20 2020 2020 2020 2023  p_list.        #
-00017930: 0a20 2020 2020 2020 2023 2066 6f72 2074  .        # for t
-00017940: 2069 6e20 274d 4c54 273a 0a20 2020 2020   in 'MLT':.     
-00017950: 2020 2023 2020 2020 2066 6f72 206b 2069     #     for k i
-00017960: 6e20 7461 6c6c 3a0a 2020 2020 2020 2020  n tall:.        
-00017970: 2320 2020 2020 2020 2020 6966 206b 2e73  #         if k.s
-00017980: 7461 7274 7377 6974 6828 2773 7065 782d  tartswith('spex-
-00017990: 7072 6973 6d2d 272b 7429 3a0a 2020 2020  prism-'+t):.    
-000179a0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-000179b0: 2020 7465 6d70 5f6c 6973 745b 6b5d 203d    temp_list[k] =
-000179c0: 2074 616c 6c5b 6b5d 0a20 2020 2020 2020   tall[k].       
-000179d0: 2023 0a20 2020 2020 2020 2023 2072 6574   #.        # ret
-000179e0: 7572 6e20 7465 6d70 5f6c 6973 740a 0a20  urn temp_list.. 
-000179f0: 2020 2020 2020 2023 2072 6574 7572 6e20         # return 
-00017a00: 7465 6d70 5f6c 6973 740a 2020 2020 2020  temp_list.      
-00017a10: 2020 7465 6d70 6c61 7465 7320 3d20 5b27    templates = ['
-00017a20: 4d36 2e35 2e74 7874 272c 2027 4d38 2e30  M6.5.txt', 'M8.0
-00017a30: 2e74 7874 272c 2027 4c31 2e30 2e74 7874  .txt', 'L1.0.txt
-00017a40: 272c 2027 4c33 2e35 2e74 7874 272c 2027  ', 'L3.5.txt', '
-00017a50: 4c36 2e30 2e74 7874 272c 2027 5432 2e30  L6.0.txt', 'T2.0
-00017a60: 2e74 7874 272c 2027 5436 2e30 2e74 7874  .txt', 'T6.0.txt
-00017a70: 272c 2027 5437 2e35 2e74 7874 275d 0a20  ', 'T7.5.txt']. 
-00017a80: 2020 2020 2020 2074 656d 706c 6174 6573         templates
-00017a90: 203d 205b 2773 7461 7273 2f27 2b74 2066   = ['stars/'+t f
-00017aa0: 6f72 2074 2069 6e20 7465 6d70 6c61 7465  or t in template
-00017ab0: 735d 0a20 2020 2065 6c73 653a 0a20 2020  s].    else:.   
-00017ac0: 2020 2020 2023 2049 6e74 6572 6d65 6469       # Intermedi
-00017ad0: 6174 6520 616e 6420 7665 7279 206f 6c64  ate and very old
-00017ae0: 0a20 2020 2020 2020 2023 2074 656d 706c  .        # templ
-00017af0: 6174 6573 203d 205b 2774 656d 706c 6174  ates = ['templat
-00017b00: 6573 2f45 415a 595f 7631 2e30 5f6c 696e  es/EAZY_v1.0_lin
-00017b10: 6573 2f65 617a 795f 7631 2e30 5f73 6564  es/eazy_v1.0_sed
-00017b20: 335f 6e6f 6c69 6e65 732e 6461 7427 2c0a  3_nolines.dat',.
-00017b30: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-00017b40: 2020 2020 2020 2027 7465 6d70 6c61 7465         'template
-00017b50: 732f 6376 6431 325f 7431 315f 736f 6c61  s/cvd12_t11_sola
-00017b60: 725f 4368 6162 7269 6572 2e65 7874 656e  r_Chabrier.exten
-00017b70: 642e 736b 6970 3130 2e64 6174 275d 0a20  d.skip10.dat']. 
-00017b80: 2020 2020 2020 2074 656d 706c 6174 6573         templates
-00017b90: 203d 205b 2765 617a 795f 696e 7465 726d   = ['eazy_interm
-00017ba0: 6564 6961 7465 2e64 6174 272c 0a20 2020  ediate.dat',.   
-00017bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bc0: 2020 2763 7664 3132 5f74 3131 5f73 6f6c    'cvd12_t11_sol
-00017bd0: 6172 5f43 6861 6272 6965 722e 6461 7427  ar_Chabrier.dat'
-00017be0: 5d0a 0a20 2020 2020 2020 2023 2050 6f73  ]..        # Pos
-00017bf0: 7420 7374 6172 6275 7273 740a 2020 2020  t starburst.    
-00017c00: 2020 2020 2320 7465 6d70 6c61 7465 732e      # templates.
-00017c10: 6170 7065 6e64 2827 7465 6d70 6c61 7465  append('template
-00017c20: 732f 556c 7472 6156 4953 5441 2f65 617a  s/UltraVISTA/eaz
-00017c30: 795f 7631 2e31 5f73 6564 392e 6461 7427  y_v1.1_sed9.dat'
-00017c40: 290a 2020 2020 2020 2020 7465 6d70 6c61  ).        templa
-00017c50: 7465 732e 6170 7065 6e64 2827 706f 7374  tes.append('post
-00017c60: 5f73 7461 7262 7572 7374 2e64 6174 2729  _starburst.dat')
-00017c70: 0a0a 2020 2020 2020 2020 2320 5665 7279  ..        # Very
-00017c80: 2062 6c75 6520 636f 6e74 696e 7575 6d0a   blue continuum.
-00017c90: 2020 2020 2020 2020 2320 7465 6d70 6c61          # templa
-00017ca0: 7465 732e 6170 7065 6e64 2827 7465 6d70  tes.append('temp
-00017cb0: 6c61 7465 732f 596f 756e 6753 422f 6572  lates/YoungSB/er
-00017cc0: 6232 3031 305f 636f 6e74 696e 7575 6d2e  b2010_continuum.
-00017cd0: 6461 7427 290a 2020 2020 2020 2020 7465  dat').        te
-00017ce0: 6d70 6c61 7465 732e 6170 7065 6e64 2827  mplates.append('
-00017cf0: 6572 6232 3031 305f 636f 6e74 696e 7575  erb2010_continuu
-00017d00: 6d2e 6461 7427 290a 0a20 2020 2020 2020  m.dat')..       
-00017d10: 2023 2054 6573 7420 6e65 7720 7465 6d70   # Test new temp
-00017d20: 6c61 7465 730a 2020 2020 2020 2020 2320  lates.        # 
-00017d30: 7465 6d70 6c61 7465 7320 3d20 5b27 7465  templates = ['te
-00017d40: 6d70 6c61 7465 732f 6572 6232 3031 305f  mplates/erb2010_
-00017d50: 636f 6e74 696e 7575 6d2e 6461 7427 2c0a  continuum.dat',.
-00017d60: 2020 2020 2020 2020 2320 2774 656d 706c          # 'templ
-00017d70: 6174 6573 2f66 7370 732f 7477 6561 6b5f  ates/fsps/tweak_
-00017d80: 6673 7073 5f74 656d 705f 6b63 3133 5f31  fsps_temp_kc13_1
-00017d90: 325f 3030 362e 6461 7427 2c0a 2020 2020  2_006.dat',.    
-00017da0: 2020 2020 2320 2774 656d 706c 6174 6573      # 'templates
-00017db0: 2f66 7370 732f 7477 6561 6b5f 6673 7073  /fsps/tweak_fsps
-00017dc0: 5f74 656d 705f 6b63 3133 5f31 325f 3030  _temp_kc13_12_00
-00017dd0: 382e 6461 7427 5d0a 0a20 2020 2020 2020  8.dat']..       
-00017de0: 2069 6620 6673 7073 5f74 656d 706c 6174   if fsps_templat
-00017df0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00017e00: 2374 656d 706c 6174 6573 203d 205b 2774  #templates = ['t
-00017e10: 656d 706c 6174 6573 2f66 7370 732f 7477  emplates/fsps/tw
-00017e20: 6561 6b5f 6673 7073 5f74 656d 705f 6b63  eak_fsps_temp_kc
-00017e30: 3133 5f31 325f 307b 303a 3032 647d 2e64  13_12_0{0:02d}.d
-00017e40: 6174 272e 666f 726d 6174 2869 2b31 2920  at'.format(i+1) 
-00017e50: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
-00017e60: 3229 5d0a 2020 2020 2020 2020 2020 2020  2)].            
-00017e70: 7465 6d70 6c61 7465 7320 3d20 5b27 6673  templates = ['fs
-00017e80: 7073 2f66 7370 735f 5153 465f 3132 5f76  ps/fsps_QSF_12_v
-00017e90: 335f 6e6f 6c69 6e65 735f 307b 303a 3032  3_nolines_0{0:02
-00017ea0: 647d 2e64 6174 272e 666f 726d 6174 2869  d}.dat'.format(i
-00017eb0: 2b31 2920 666f 7220 6920 696e 2072 616e  +1) for i in ran
-00017ec0: 6765 2831 3229 5d0a 2020 2020 2020 2020  ge(12)].        
-00017ed0: 2020 2020 2374 656d 706c 6174 6573 203d      #templates =
-00017ee0: 205b 2766 7370 732f 6673 7073 5f51 5346   ['fsps/fsps_QSF
-00017ef0: 5f37 5f76 335f 6e6f 6c69 6e65 735f 307b  _7_v3_nolines_0{
-00017f00: 303a 3032 647d 2e64 6174 272e 666f 726d  0:02d}.dat'.form
-00017f10: 6174 2869 2b31 2920 666f 7220 6920 696e  at(i+1) for i in
-00017f20: 2072 616e 6765 2837 295d 0a0a 2020 2020   range(7)]..    
-00017f30: 2020 2020 6966 2061 6c66 5f74 656d 706c      if alf_templ
-00017f40: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00017f50: 2074 656d 706c 6174 6573 2e61 7070 656e   templates.appen
-00017f60: 6428 2761 6c66 5f53 5350 2e64 6174 2729  d('alf_SSP.dat')
-00017f70: 0a0a 2020 2020 2020 2020 6966 2063 6f6e  ..        if con
-00017f80: 7469 6e75 756d 5f6c 6973 7420 6973 206e  tinuum_list is n
-00017f90: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00017fa0: 2020 2020 2074 656d 706c 6174 6573 203d       templates =
-00017fb0: 2063 6f6e 7469 6e75 756d 5f6c 6973 740a   continuum_list.
-00017fc0: 0a20 2020 2074 656d 705f 6c69 7374 203d  .    temp_list =
-00017fd0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
-00017fe0: 2020 2066 6f72 2074 656d 7020 696e 2074     for temp in t
-00017ff0: 656d 706c 6174 6573 3a0a 2020 2020 2020  emplates:.      
-00018000: 2020 6461 7461 203d 206e 702e 6c6f 6164    data = np.load
-00018010: 7478 7428 6f73 2e70 6174 682e 6a6f 696e  txt(os.path.join
-00018020: 2847 5249 5a4c 495f 5041 5448 2c20 2774  (GRIZLI_PATH, 't
-00018030: 656d 706c 6174 6573 272c 2074 656d 7029  emplates', temp)
-00018040: 2c20 756e 7061 636b 3d54 7275 6529 0a20  , unpack=True). 
-00018050: 2020 2020 2020 2023 7363 6c20 3d20 6e70         #scl = np
-00018060: 2e69 6e74 6572 7028 3535 3030 2e2c 2064  .interp(5500., d
-00018070: 6174 615b 305d 2c20 6461 7461 5b31 5d29  ata[0], data[1])
-00018080: 0a20 2020 2020 2020 2073 636c 203d 2031  .        scl = 1
-00018090: 2e0a 2020 2020 2020 2020 6e61 6d65 203d  ..        name =
-000180a0: 2074 656d 7020 2023 206f 732e 7061 7468   temp  # os.path
-000180b0: 2e62 6173 656e 616d 6528 7465 6d70 290a  .basename(temp).
-000180c0: 2020 2020 2020 2020 7465 6d70 5f6c 6973          temp_lis
-000180d0: 745b 6e61 6d65 5d20 3d20 5370 6563 7472  t[name] = Spectr
-000180e0: 756d 5465 6d70 6c61 7465 2877 6176 653d  umTemplate(wave=
-000180f0: 6461 7461 5b30 5d2c 2066 6c75 783d 6461  data[0], flux=da
-00018100: 7461 5b31 5d2f 7363 6c2c 0a20 2020 2020  ta[1]/scl,.     
-00018110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018130: 2020 2020 2020 6e61 6d65 3d6e 616d 6529        name=name)
-00018140: 0a0a 2020 2020 2020 2020 7465 6d70 5f6c  ..        temp_l
-00018150: 6973 745b 6e61 6d65 5d2e 6e61 6d65 203d  ist[name].name =
-00018160: 206e 616d 650a 0a20 2020 2069 6620 7374   name..    if st
-00018170: 6172 733a 0a20 2020 2020 2020 2072 6574  ars:.        ret
-00018180: 7572 6e20 7465 6d70 5f6c 6973 740a 0a20  urn temp_list.. 
-00018190: 2020 2023 2045 6d69 7373 696f 6e20 6c69     # Emission li
-000181a0: 6e65 733a 0a20 2020 206c 696e 655f 7761  nes:.    line_wa
-000181b0: 7665 6c65 6e67 7468 732c 206c 696e 655f  velengths, line_
-000181c0: 7261 7469 6f73 203d 2067 6574 5f6c 696e  ratios = get_lin
-000181d0: 655f 7761 7665 6c65 6e67 7468 7328 290a  e_wavelengths().
-000181e0: 0a20 2020 2069 6620 6c69 6e65 5f63 6f6d  .    if line_com
-000181f0: 706c 6578 6573 3a0a 2020 2020 2020 2020  plexes:.        
-00018200: 236c 696e 655f 6c69 7374 203d 205b 2748  #line_list = ['H
-00018210: 612b 5349 4927 2c20 274f 4949 492b 4862  a+SII', 'OIII+Hb
-00018220: 2b48 6127 2c20 274f 4949 275d 0a20 2020  +Ha', 'OII'].   
-00018230: 2020 2020 2023 6c69 6e65 5f6c 6973 7420       #line_list 
-00018240: 3d20 5b27 4861 2b53 4949 272c 2027 4f49  = ['Ha+SII', 'OI
-00018250: 4949 2b48 6227 2c20 274f 4949 275d 0a20  II+Hb', 'OII']. 
-00018260: 2020 2020 2020 2023 6c69 6e65 5f6c 6973         #line_lis
-00018270: 7420 3d20 5b27 4861 2b4e 4949 2b53 4949  t = ['Ha+NII+SII
-00018280: 2b53 4949 492b 4865 2b50 6142 272c 2027  +SIII+He+PaB', '
-00018290: 4f49 4949 2b48 6227 2c20 274f 4949 2b4e  OIII+Hb', 'OII+N
-000182a0: 6527 2c20 274c 7961 2b43 4956 275d 0a20  e', 'Lya+CIV']. 
-000182b0: 2020 2020 2020 2023 6c69 6e65 5f6c 6973         #line_lis
-000182c0: 7420 3d20 5b27 4861 2b4e 4949 2b53 4949  t = ['Ha+NII+SII
-000182d0: 2b53 4949 492b 4865 2b50 6142 272c 2027  +SIII+He+PaB', '
-000182e0: 4f49 4949 2b48 622b 4867 2b48 6427 2c20  OIII+Hb+Hg+Hd', 
-000182f0: 274f 4949 2b4e 6527 2c20 274c 7961 2b43  'OII+Ne', 'Lya+C
-00018300: 4956 275d 0a20 2020 2020 2020 206c 696e  IV'].        lin
-00018310: 655f 6c69 7374 203d 205b 2748 612b 4e49  e_list = ['Ha+NI
-00018320: 492b 5349 492b 5349 4949 2b48 652b 5061  I+SII+SIII+He+Pa
-00018330: 4227 2c20 274f 4949 492b 4862 2b48 672b  B', 'OIII+Hb+Hg+
-00018340: 4864 272c 2027 4f49 492b 4e65 272c 2027  Hd', 'OII+Ne', '
-00018350: 4761 6c2d 5556 2d6c 696e 6573 275d 0a0a  Gal-UV-lines']..
-00018360: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00018370: 2020 6966 2066 756c 6c5f 6c69 6e65 5f6c    if full_line_l
-00018380: 6973 7420 6973 204e 6f6e 653a 0a20 2020  ist is None:.   
-00018390: 2020 2020 2020 2020 206c 696e 655f 6c69           line_li
-000183a0: 7374 203d 2044 4546 4155 4c54 5f4c 494e  st = DEFAULT_LIN
-000183b0: 455f 4c49 5354 0a20 2020 2020 2020 2065  E_LIST.        e
-000183c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000183d0: 206c 696e 655f 6c69 7374 203d 2066 756c   line_list = ful
-000183e0: 6c5f 6c69 6e65 5f6c 6973 740a 0a20 2020  l_line_list..   
-000183f0: 2020 2020 2023 6c69 6e65 5f6c 6973 7420       #line_list 
-00018400: 3d20 5b27 4861 272c 2027 5349 4927 5d0a  = ['Ha', 'SII'].
-00018410: 0a20 2020 2023 2055 7365 2046 5350 5320  .    # Use FSPS 
-00018420: 6772 6964 2066 6f72 206c 696e 6573 0a20  grid for lines. 
-00018430: 2020 2077 6176 655f 6772 6964 203d 204e     wave_grid = N
-00018440: 6f6e 650a 2020 2020 2320 6966 2066 7370  one.    # if fsp
-00018450: 735f 7465 6d70 6c61 7465 733a 0a20 2020  s_templates:.   
-00018460: 2023 2020 2020 2077 6176 655f 6772 6964   #     wave_grid
-00018470: 203d 2064 6174 615b 305d 0a20 2020 2023   = data[0].    #
-00018480: 2065 6c73 653a 0a20 2020 2023 2020 2020   else:.    #    
-00018490: 2077 6176 655f 6772 6964 203d 204e 6f6e   wave_grid = Non
-000184a0: 650a 0a20 2020 2066 6f72 206c 6920 696e  e..    for li in
-000184b0: 206c 696e 655f 6c69 7374 3a0a 2020 2020   line_list:.    
-000184c0: 2020 2020 7363 6c20 3d20 6c69 6e65 5f72      scl = line_r
-000184d0: 6174 696f 735b 6c69 5d2f 6e70 2e73 756d  atios[li]/np.sum
-000184e0: 286c 696e 655f 7261 7469 6f73 5b6c 695d  (line_ratios[li]
-000184f0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
-00018500: 696e 2072 616e 6765 286c 656e 2873 636c  in range(len(scl
-00018510: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00018520: 6966 2028 274f 3332 2720 696e 206c 6929  if ('O32' in li)
-00018530: 2026 2028 6e70 2e61 6273 286c 696e 655f   & (np.abs(line_
-00018540: 7761 7665 6c65 6e67 7468 735b 6c69 5d5b  wavelengths[li][
-00018550: 695d 2d32 3739 3929 203c 2032 293a 0a20  i]-2799) < 2):. 
-00018560: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00018570: 7768 6d5f 6920 3d20 3235 3030 0a20 2020  whm_i = 2500.   
-00018580: 2020 2020 2020 2020 2020 2020 206c 6f72               lor
-00018590: 656e 747a 5f69 203d 2054 7275 650a 2020  entz_i = True.  
-000185a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000185b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185c0: 6677 686d 5f69 203d 2066 7768 6d0a 2020  fwhm_i = fwhm.  
-000185d0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000185e0: 7265 6e74 7a5f 6920 3d20 6c6f 7265 6e74  rentz_i = lorent
-000185f0: 7a0a 0a20 2020 2020 2020 2020 2020 206c  z..            l
-00018600: 696e 655f 6920 3d20 5370 6563 7472 756d  ine_i = Spectrum
-00018610: 5465 6d70 6c61 7465 2877 6176 653d 7761  Template(wave=wa
-00018620: 7665 5f67 7269 642c 0a20 2020 2020 2020  ve_grid,.       
-00018630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018640: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00018650: 656e 7472 616c 5f77 6176 653d 6c69 6e65  entral_wave=line
-00018660: 5f77 6176 656c 656e 6774 6873 5b6c 695d  _wavelengths[li]
-00018670: 5b69 5d2c 0a20 2020 2020 2020 2020 2020  [i],.           
-00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018690: 2020 2020 2020 2020 2020 2066 6c75 783d             flux=
-000186a0: 4e6f 6e65 2c20 6677 686d 3d66 7768 6d5f  None, fwhm=fwhm_
-000186b0: 692c 2076 656c 6f63 6974 793d 5472 7565  i, velocity=True
-000186c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186e0: 2020 2020 2020 2020 6c6f 7265 6e74 7a3d          lorentz=
-000186f0: 6c6f 7265 6e74 7a5f 6929 0a0a 2020 2020  lorentz_i)..    
-00018700: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
-00018710: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00018720: 2020 206c 696e 655f 7465 6d70 203d 206c     line_temp = l
-00018730: 696e 655f 692a 7363 6c5b 695d 0a20 2020  ine_i*scl[i].   
-00018740: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00018750: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00018760: 696e 655f 7465 6d70 203d 206c 696e 655f  ine_temp = line_
-00018770: 7465 6d70 202b 206c 696e 655f 692a 7363  temp + line_i*sc
-00018780: 6c5b 695d 0a0a 2020 2020 2020 2020 6e61  l[i]..        na
-00018790: 6d65 203d 2027 6c69 6e65 207b 307d 272e  me = 'line {0}'.
-000187a0: 666f 726d 6174 286c 6929 0a20 2020 2020  format(li).     
-000187b0: 2020 206c 696e 655f 7465 6d70 2e6e 616d     line_temp.nam
-000187c0: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-000187d0: 2074 656d 705f 6c69 7374 5b6e 616d 655d   temp_list[name]
-000187e0: 203d 206c 696e 655f 7465 6d70 0a0a 2020   = line_temp..  
-000187f0: 2020 7265 7475 726e 2074 656d 705f 6c69    return temp_li
-00018800: 7374 0a0a 0a64 6566 206c 6f61 645f 6265  st...def load_be
-00018810: 7461 5f74 656d 706c 6174 6573 2877 6176  ta_templates(wav
-00018820: 653d 6e70 2e61 7261 6e67 6528 3430 302c  e=np.arange(400,
-00018830: 2032 2e35 6534 292c 2062 6574 6173 3d5b   2.5e4), betas=[
-00018840: 2d32 2c20 2d31 2c20 305d 293a 0a20 2020  -2, -1, 0]):.   
-00018850: 2022 2222 0a20 2020 2053 7465 702d 6675   """.    Step-fu
-00018860: 6e63 7469 6f6e 2074 656d 706c 6174 6573  nction templates
-00018870: 2077 6974 6820 665f 6c61 6d62 6461 207e   with f_lambda ~
-00018880: 2028 7761 7665 2f31 3231 362e 292a 2a62   (wave/1216.)**b
-00018890: 6574 610a 2020 2020 2222 220a 2020 2020  eta.    """.    
-000188a0: 636f 6e74 5f77 6176 6520 3d20 6e70 2e61  cont_wave = np.a
-000188b0: 7261 6e67 6528 3430 302c 2032 2e35 6534  range(400, 2.5e4
-000188c0: 290a 2020 2020 7430 203d 207b 7d0a 2020  ).    t0 = {}.  
-000188d0: 2020 666f 7220 6265 7461 2069 6e20 6265    for beta in be
-000188e0: 7461 733a 0a20 2020 2020 2020 206b 6579  tas:.        key
-000188f0: 203d 2027 6265 7461 207b 307d 272e 666f   = 'beta {0}'.fo
-00018900: 726d 6174 2862 6574 6129 0a20 2020 2020  rmat(beta).     
-00018910: 2020 2074 305b 6b65 795d 203d 2053 7065     t0[key] = Spe
-00018920: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
-00018930: 7665 3d63 6f6e 745f 7761 7665 2c20 666c  ve=cont_wave, fl
-00018940: 7578 3d28 636f 6e74 5f77 6176 652f 3132  ux=(cont_wave/12
-00018950: 3136 2e29 2a2a 6265 7461 290a 2020 2020  16.)**beta).    
-00018960: 7265 7475 726e 2074 300a 0a0a 6465 6620  return t0...def 
-00018970: 6c6f 6164 5f71 7561 7361 725f 7465 6d70  load_quasar_temp
-00018980: 6c61 7465 7328 6272 6f61 645f 6677 686d  lates(broad_fwhm
-00018990: 3d32 3530 302c 206e 6172 726f 775f 6677  =2500, narrow_fw
-000189a0: 686d 3d31 3230 302c 2062 726f 6164 5f6c  hm=1200, broad_l
-000189b0: 696e 6573 3d5b 2748 6549 2d35 3837 3727  ines=['HeI-5877'
-000189c0: 2c20 274d 6749 4927 2c20 274c 7961 272c  , 'MgII', 'Lya',
-000189d0: 2027 4349 562d 3135 3439 272c 2027 4349   'CIV-1549', 'CI
-000189e0: 4949 2d31 3930 3627 2c20 2743 4949 492d  II-1906', 'CIII-
-000189f0: 3139 3038 272c 2027 4f49 4949 2d31 3636  1908', 'OIII-166
-00018a00: 3327 2c20 2748 6549 492d 3136 3430 272c  3', 'HeII-1640',
-00018a10: 2027 5369 4956 2b4f 4956 2d31 3339 3827   'SiIV+OIV-1398'
-00018a20: 2c20 274e 4956 2d31 3438 3727 2c20 274e  , 'NIV-1487', 'N
-00018a30: 562d 3132 3430 272c 2027 5061 4227 2c20  V-1240', 'PaB', 
-00018a40: 2750 6147 275d 2c20 6e61 7272 6f77 5f6c  'PaG'], narrow_l
-00018a50: 696e 6573 3d5b 274e 4949 492d 3137 3530  ines=['NIII-1750
-00018a60: 272c 2027 4f49 4927 2c20 274f 4949 4927  ', 'OII', 'OIII'
-00018a70: 2c20 2753 4949 272c 2027 4f49 2d36 3330  , 'SII', 'OI-630
-00018a80: 3227 2c20 274f 4949 492d 3433 3633 272c  2', 'OIII-4363',
-00018a90: 2027 4e65 4949 492d 3338 3637 272c 2027   'NeIII-3867', '
-00018aa0: 4e65 5649 2d33 3432 3627 2c20 274e 6556  NeVI-3426', 'NeV
-00018ab0: 2d33 3334 3627 2c20 274f 4949 2d37 3332  -3346', 'OII-732
-00018ac0: 3527 2c20 2741 7249 4949 2d37 3133 3827  5', 'ArIII-7138'
-00018ad0: 2c20 2753 4949 4927 2c20 2748 6549 2d31  , 'SIII', 'HeI-1
-00018ae0: 3038 3327 5d2c 2069 6e63 6c75 6465 5f66  083'], include_f
-00018af0: 6569 693d 5472 7565 2c20 736c 6f70 6573  eii=True, slopes
-00018b00: 3d5b 2d32 2e38 2c20 302c 2032 2e38 5d2c  =[-2.8, 0, 2.8],
-00018b10: 2075 765f 6c69 6e65 5f63 6f6d 706c 6578   uv_line_complex
-00018b20: 3d54 7275 652c 2066 6978 6564 5f6e 6172  =True, fixed_nar
-00018b30: 726f 775f 6c69 6e65 733d 4661 6c73 652c  row_lines=False,
-00018b40: 2074 315f 6f6e 6c79 3d46 616c 7365 2c20   t1_only=False, 
-00018b50: 6e73 706c 696e 653d 3133 2c20 5273 706c  nspline=13, Rspl
-00018b60: 696e 653d 3330 2c20 6265 7461 733d 4e6f  ine=30, betas=No
-00018b70: 6e65 2c20 696e 636c 7564 655f 7265 6464  ne, include_redd
-00018b80: 656e 6564 5f62 616c 6d65 725f 6c69 6e65  ened_balmer_line
-00018b90: 733d 4661 6c73 6529 3a0a 2020 2020 2222  s=False):.    ""
-00018ba0: 220a 2020 2020 4d61 6b65 2074 656d 706c  ".    Make templ
-00018bb0: 6174 6573 2073 7569 7461 626c 6520 666f  ates suitable fo
-00018bc0: 7220 6669 7474 696e 6720 6272 6f61 642d  r fitting broad-
-00018bd0: 6c69 6e65 2071 7561 7361 7273 0a20 2020  line quasars.   
-00018be0: 2022 2222 0a0a 2020 2020 6672 6f6d 2063   """..    from c
-00018bf0: 6f6c 6c65 6374 696f 6e73 2069 6d70 6f72  ollections impor
-00018c00: 7420 4f72 6465 7265 6444 6963 740a 2020  t OrderedDict.  
-00018c10: 2020 696d 706f 7274 2073 6369 7079 2e6e    import scipy.n
-00018c20: 6469 6d61 6765 2061 7320 6e64 0a0a 2020  dimage as nd..  
-00018c30: 2020 7430 203d 204f 7264 6572 6564 4469    t0 = OrderedDi
-00018c40: 6374 2829 0a20 2020 2074 3120 3d20 4f72  ct().    t1 = Or
-00018c50: 6465 7265 6444 6963 7428 290a 0a20 2020  deredDict()..   
-00018c60: 2062 726f 6164 3120 3d20 6c6f 6164 5f74   broad1 = load_t
-00018c70: 656d 706c 6174 6573 2866 7768 6d3d 6272  emplates(fwhm=br
-00018c80: 6f61 645f 6677 686d 2c20 6c69 6e65 5f63  oad_fwhm, line_c
-00018c90: 6f6d 706c 6578 6573 3d46 616c 7365 2c20  omplexes=False, 
-00018ca0: 7374 6172 733d 4661 6c73 652c 2066 756c  stars=False, ful
-00018cb0: 6c5f 6c69 6e65 5f6c 6973 743d 5b27 4861  l_line_list=['Ha
-00018cc0: 272c 2027 4862 272c 2027 4867 272c 2027  ', 'Hb', 'Hg', '
-00018cd0: 4864 272c 2027 4837 272c 2027 4838 272c  Hd', 'H7', 'H8',
-00018ce0: 2027 4839 272c 2027 4831 3027 5d20 2b20   'H9', 'H10'] + 
-00018cf0: 6272 6f61 645f 6c69 6e65 732c 2063 6f6e  broad_lines, con
-00018d00: 7469 6e75 756d 5f6c 6973 743d 5b5d 2c20  tinuum_list=[], 
-00018d10: 6673 7073 5f74 656d 706c 6174 6573 3d46  fsps_templates=F
-00018d20: 616c 7365 2c20 616c 665f 7465 6d70 6c61  alse, alf_templa
-00018d30: 7465 3d46 616c 7365 2c20 6c6f 7265 6e74  te=False, lorent
-00018d40: 7a3d 5472 7565 290a 0a20 2020 206e 6172  z=True)..    nar
-00018d50: 726f 7731 203d 206c 6f61 645f 7465 6d70  row1 = load_temp
-00018d60: 6c61 7465 7328 6677 686d 3d34 3030 2c20  lates(fwhm=400, 
-00018d70: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
-00018d80: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
-00018d90: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
-00018da0: 743d 6e61 7272 6f77 5f6c 696e 6573 2c20  t=narrow_lines, 
-00018db0: 636f 6e74 696e 7575 6d5f 6c69 7374 3d5b  continuum_list=[
-00018dc0: 5d2c 2066 7370 735f 7465 6d70 6c61 7465  ], fsps_template
-00018dd0: 733d 4661 6c73 652c 2061 6c66 5f74 656d  s=False, alf_tem
-00018de0: 706c 6174 653d 4661 6c73 6529 0a0a 2020  plate=False)..  
-00018df0: 2020 6966 2066 6978 6564 5f6e 6172 726f    if fixed_narro
-00018e00: 775f 6c69 6e65 733a 0a20 2020 2020 2020  w_lines:.       
-00018e10: 2069 6620 7431 5f6f 6e6c 793a 0a20 2020   if t1_only:.   
-00018e20: 2020 2020 2020 2020 206e 6172 726f 7730           narrow0
-00018e30: 203d 206e 6172 726f 7731 0a20 2020 2020   = narrow1.     
-00018e40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018e50: 2020 2020 206e 6172 726f 7730 203d 206c       narrow0 = l
-00018e60: 6f61 645f 7465 6d70 6c61 7465 7328 6677  oad_templates(fw
-00018e70: 686d 3d6e 6172 726f 775f 6677 686d 2c20  hm=narrow_fwhm, 
-00018e80: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
-00018e90: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
-00018ea0: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
-00018eb0: 743d 5b27 5153 4f2d 4e61 7272 6f77 2d6c  t=['QSO-Narrow-l
-00018ec0: 696e 6573 275d 2c20 636f 6e74 696e 7575  ines'], continuu
-00018ed0: 6d5f 6c69 7374 3d5b 5d2c 2066 7370 735f  m_list=[], fsps_
-00018ee0: 7465 6d70 6c61 7465 733d 4661 6c73 652c  templates=False,
-00018ef0: 2061 6c66 5f74 656d 706c 6174 653d 4661   alf_template=Fa
-00018f00: 6c73 6529 0a0a 2020 2020 656c 7365 3a0a  lse)..    else:.
-00018f10: 2020 2020 2020 2020 6e61 7272 6f77 3020          narrow0 
-00018f20: 3d20 6c6f 6164 5f74 656d 706c 6174 6573  = load_templates
-00018f30: 2866 7768 6d3d 6e61 7272 6f77 5f66 7768  (fwhm=narrow_fwh
-00018f40: 6d2c 206c 696e 655f 636f 6d70 6c65 7865  m, line_complexe
-00018f50: 733d 4661 6c73 652c 2073 7461 7273 3d46  s=False, stars=F
-00018f60: 616c 7365 2c20 6675 6c6c 5f6c 696e 655f  alse, full_line_
-00018f70: 6c69 7374 3d6e 6172 726f 775f 6c69 6e65  list=narrow_line
-00018f80: 732c 2063 6f6e 7469 6e75 756d 5f6c 6973  s, continuum_lis
-00018f90: 743d 5b5d 2c20 6673 7073 5f74 656d 706c  t=[], fsps_templ
-00018fa0: 6174 6573 3d46 616c 7365 2c20 616c 665f  ates=False, alf_
-00018fb0: 7465 6d70 6c61 7465 3d46 616c 7365 290a  template=False).
-00018fc0: 0a20 2020 2069 6620 7431 5f6f 6e6c 793a  .    if t1_only:
-00018fd0: 0a20 2020 2020 2020 2062 726f 6164 3020  .        broad0 
-00018fe0: 3d20 6272 6f61 6431 0a20 2020 2065 6c73  = broad1.    els
-00018ff0: 653a 0a20 2020 2020 2020 2069 6620 7576  e:.        if uv
-00019000: 5f6c 696e 655f 636f 6d70 6c65 783a 0a20  _line_complex:. 
-00019010: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
-00019020: 6c69 6e65 5f6c 6973 7420 3d20 5b27 4261  line_list = ['Ba
-00019030: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
-00019040: 2041 763d 302e 3527 2c20 2751 534f 2d55   Av=0.5', 'QSO-U
-00019050: 562d 6c69 6e65 7327 5d0a 2020 2020 2020  V-lines'].      
-00019060: 2020 2020 2020 2362 726f 6164 3020 3d20        #broad0 = 
-00019070: 6c6f 6164 5f74 656d 706c 6174 6573 2866  load_templates(f
-00019080: 7768 6d3d 6272 6f61 645f 6677 686d 2c20  whm=broad_fwhm, 
-00019090: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
-000190a0: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
-000190b0: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
-000190c0: 743d 5b27 4261 6c6d 6572 2031 306b 4b20  t=['Balmer 10kK 
-000190d0: 2b20 4d67 4949 272c 2027 5153 4f2d 5556  + MgII', 'QSO-UV
-000190e0: 2d6c 696e 6573 275d 2c20 636f 6e74 696e  -lines'], contin
-000190f0: 7575 6d5f 6c69 7374 3d5b 5d2c 2066 7370  uum_list=[], fsp
-00019100: 735f 7465 6d70 6c61 7465 733d 4661 6c73  s_templates=Fals
-00019110: 652c 2061 6c66 5f74 656d 706c 6174 653d  e, alf_template=
-00019120: 4661 6c73 652c 206c 6f72 656e 747a 3d54  False, lorentz=T
-00019130: 7275 6529 0a20 2020 2020 2020 2065 6c73  rue).        els
-00019140: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00019150: 756c 6c5f 6c69 6e65 5f6c 6973 7420 3d20  ull_line_list = 
-00019160: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
-00019170: 4d67 4949 2041 763d 302e 3527 5d0a 2020  MgII Av=0.5'].  
+00016a80: 7465 6d70 5f66 6c75 780a 2020 2020 0a20  temp_flux.    . 
+00016a90: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00016aa0: 2064 6566 2065 617a 7928 7365 6c66 293a   def eazy(self):
+00016ab0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00016ac0: 2020 2020 2043 6f6e 7665 7274 2074 6f20       Convert to 
+00016ad0: 6065 617a 792e 7465 6d70 6c61 7465 2e54  `eazy.template.T
+00016ae0: 656d 706c 6174 6560 206f 626a 6563 740a  emplate` object.
+00016af0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00016b00: 2020 2020 696d 706f 7274 2065 617a 792e      import eazy.
+00016b10: 7465 6d70 6c61 7465 730a 2020 2020 2020  templates.      
+00016b20: 2020 7465 6d70 6c20 3d20 6561 7a79 2e74    templ = eazy.t
+00016b30: 656d 706c 6174 6573 2e54 656d 706c 6174  emplates.Templat
+00016b40: 6528 6172 7261 7973 3d28 7365 6c66 2e77  e(arrays=(self.w
+00016b50: 6176 652c 2073 656c 662e 666c 7578 292c  ave, self.flux),
+00016b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b80: 2020 2020 2020 2020 206e 616d 653d 7365           name=se
+00016b90: 6c66 2e6e 616d 6529 0a20 2020 2020 2020  lf.name).       
+00016ba0: 2072 6574 7572 6e20 7465 6d70 6c0a 0a0a   return templ...
+00016bb0: 6465 6620 6c6f 6164 5f74 656d 706c 6174  def load_templat
+00016bc0: 6573 2866 7768 6d3d 3430 302c 206c 696e  es(fwhm=400, lin
+00016bd0: 655f 636f 6d70 6c65 7865 733d 5472 7565  e_complexes=True
+00016be0: 2c20 7374 6172 733d 4661 6c73 652c 0a20  , stars=False,. 
+00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c00: 2020 6675 6c6c 5f6c 696e 655f 6c69 7374    full_line_list
+00016c10: 3d44 4546 4155 4c54 5f4c 494e 455f 4c49  =DEFAULT_LINE_LI
+00016c20: 5354 2c20 636f 6e74 696e 7575 6d5f 6c69  ST, continuum_li
+00016c30: 7374 3d4e 6f6e 652c 0a20 2020 2020 2020  st=None,.       
+00016c40: 2020 2020 2020 2020 2020 2020 6673 7073              fsps
+00016c50: 5f74 656d 706c 6174 6573 3d46 616c 7365  _templates=False
+00016c60: 2c20 616c 665f 7465 6d70 6c61 7465 3d46  , alf_template=F
+00016c70: 616c 7365 2c20 6c6f 7265 6e74 7a3d 4661  alse, lorentz=Fa
+00016c80: 6c73 6529 3a0a 2020 2020 2222 2247 656e  lse):.    """Gen
+00016c90: 6572 6174 6520 6120 6c69 7374 206f 6620  erate a list of 
+00016ca0: 7465 6d70 6c61 7465 7320 666f 7220 6669  templates for fi
+00016cb0: 7474 696e 6720 746f 2074 6865 2067 7269  tting to the gri
+00016cc0: 736d 2073 7065 6374 7261 0a0a 2020 2020  sm spectra..    
+00016cd0: 5468 6520 6469 6666 6572 656e 7420 7365  The different se
+00016ce0: 7473 206f 6620 636f 6e74 696e 7575 6d20  ts of continuum 
+00016cf0: 7465 6d70 6c61 7465 7320 6172 6520 7374  templates are st
+00016d00: 6f72 6564 2069 6e0a 0a20 2020 2020 2020  ored in..       
+00016d10: 203e 3e3e 2074 656d 705f 6469 7220 3d20   >>> temp_dir = 
+00016d20: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
+00016d30: 5a4c 495f 5041 5448 2c20 2774 656d 706c  ZLI_PATH, 'templ
+00016d40: 6174 6573 2729 0a0a 2020 2020 5061 7261  ates')..    Para
+00016d50: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00016d60: 2d2d 2d2d 2d0a 2020 2020 6677 686d 203a  -----.    fwhm :
+00016d70: 2066 6c6f 6174 0a20 2020 2020 2020 2046   float.        F
+00016d80: 5748 4d20 6f66 2061 2047 6175 7373 6961  WHM of a Gaussia
+00016d90: 6e2c 2069 6e20 6b6d 2f73 2c20 7468 6174  n, in km/s, that
+00016da0: 2069 7320 636f 6e76 6f6c 7665 6420 7769   is convolved wi
+00016db0: 7468 2074 6865 2065 6d69 7373 696f 6e0a  th the emission.
+00016dc0: 2020 2020 2020 2020 6c69 6e65 2074 656d          line tem
+00016dd0: 706c 6174 6573 2e20 2049 6620 746f 6f20  plates.  If too 
+00016de0: 6e61 7272 6f77 2c20 7468 656e 2063 616e  narrow, then can
+00016df0: 2073 6565 2070 6978 656c 2065 6666 6563   see pixel effec
+00016e00: 7473 2069 6e20 7468 650a 2020 2020 2020  ts in the.      
+00016e10: 2020 6669 7473 2061 7320 6120 6675 6e63    fits as a func
+00016e20: 7469 6f6e 206f 6620 7265 6473 6869 6674  tion of redshift
+00016e30: 2e0a 0a20 2020 206c 696e 655f 636f 6d70  ...    line_comp
+00016e40: 6c65 7865 7320 3a20 626f 6f6c 0a20 2020  lexes : bool.   
+00016e50: 2020 2020 2047 656e 6572 6174 6520 6c69       Generate li
+00016e60: 6e65 2063 6f6d 706c 6578 2074 656d 706c  ne complex templ
+00016e70: 6174 6573 2077 6974 6820 6669 7865 6420  ates with fixed 
+00016e80: 666c 7578 2072 6174 696f 7320 7261 7468  flux ratios rath
+00016e90: 6572 2074 6861 6e0a 2020 2020 2020 2020  er than.        
+00016ea0: 696e 6469 7669 6475 616c 206c 696e 6573  individual lines
+00016eb0: 2e20 5468 6973 2069 7320 7573 6566 756c  . This is useful
+00016ec0: 2066 6f72 2074 6865 2072 6564 7368 6966   for the redshif
+00016ed0: 7420 6669 7473 2077 6865 7265 2074 6865  t fits where the
+00016ee0: 7265 0a20 2020 2020 2020 2077 6f75 6c64  re.        would
+00016ef0: 2062 6520 7265 6473 6869 6674 2064 6567   be redshift deg
+00016f00: 656e 6572 6163 6965 7320 6966 2074 6865  eneracies if the
+00016f10: 206c 696e 6520 666c 7578 6573 2066 6f72   line fluxes for
+00016f20: 2069 6e64 6976 6964 7561 6c0a 2020 2020   individual.    
+00016f30: 2020 2020 6c69 6e65 7320 7765 7265 2061      lines were a
+00016f40: 6c6c 6f77 6564 2074 6f20 7661 7279 2063  llowed to vary c
+00016f50: 6f6d 706c 6574 656c 7920 6672 6565 6c79  ompletely freely
+00016f60: 2e20 5365 6520 7468 6520 6c69 7374 206f  . See the list o
+00016f70: 660a 2020 2020 2020 2020 6176 6169 6c61  f.        availa
+00016f80: 626c 6520 6c69 6e65 7320 616e 6420 6c69  ble lines and li
+00016f90: 6e65 2067 726f 7570 7320 696e 0a20 2020  ne groups in.   
+00016fa0: 2020 2020 2060 7e67 7269 7a6c 692e 7574       `~grizli.ut
+00016fb0: 696c 732e 6765 745f 6c69 6e65 5f77 6176  ils.get_line_wav
+00016fc0: 656c 656e 6774 6873 602e 2043 7572 7265  elengths`. Curre
+00016fd0: 6e74 6c79 2c0a 2020 2020 2020 2020 606c  ntly,.        `l
+00016fe0: 696e 655f 636f 6d70 6c65 7865 733d 5472  ine_complexes=Tr
+00016ff0: 7565 6020 6765 6e65 7261 7465 7320 7468  ue` generates th
+00017000: 6520 666f 6c6c 6f77 696e 6720 6772 6f75  e following grou
+00017010: 7073 3a0a 0a20 2020 2020 2020 2020 2020  ps:..           
+00017020: 2048 612b 4e49 492b 5349 492b 5349 4949   Ha+NII+SII+SIII
+00017030: 2b48 650a 2020 2020 2020 2020 2020 2020  +He.            
+00017040: 4f49 4949 2b48 620a 2020 2020 2020 2020  OIII+Hb.        
+00017050: 2020 2020 4f49 492b 4e65 0a0a 2020 2020      OII+Ne..    
+00017060: 7374 6172 7320 3a20 626f 6f6c 0a20 2020  stars : bool.   
+00017070: 2020 2020 2047 6574 2073 7465 6c6c 6172       Get stellar
+00017080: 2074 656d 706c 6174 6573 2072 6174 6865   templates rathe
+00017090: 7220 7468 616e 2067 616c 6178 6965 7320  r than galaxies 
+000170a0: 2b20 6c69 6e65 730a 0a20 2020 2066 756c  + lines..    ful
+000170b0: 6c5f 6c69 6e65 5f6c 6973 7420 3a20 4e6f  l_line_list : No
+000170c0: 6e65 206f 7220 6c69 7374 0a20 2020 2020  ne or list.     
+000170d0: 2020 2046 756c 6c20 7365 7420 6f66 206c     Full set of l
+000170e0: 696e 6573 2074 6f20 7472 792e 2020 5468  ines to try.  Th
+000170f0: 6520 6465 6661 756c 7420 6973 2073 6574  e default is set
+00017100: 2069 6e20 7468 6520 676c 6f62 616c 2076   in the global v
+00017110: 6172 6961 626c 650a 2020 2020 2020 2020  ariable.        
+00017120: 607e 6772 697a 6c69 2e75 7469 6c73 2e44  `~grizli.utils.D
+00017130: 4546 4155 4c54 5f4c 494e 455f 4c49 5354  EFAULT_LINE_LIST
+00017140: 602e 0a0a 2020 2020 2020 2020 5468 6520  `...        The 
+00017150: 6675 6c6c 206c 6973 7420 6f66 2069 6d70  full list of imp
+00017160: 6c65 6d65 6e74 6564 206c 696e 6573 2069  lemented lines i
+00017170: 7320 696e 2060 7e67 7269 7a6c 692e 7574  s in `~grizli.ut
+00017180: 696c 732e 6765 745f 6c69 6e65 5f77 6176  ils.get_line_wav
+00017190: 656c 656e 6774 6873 602e 0a0a 2020 2020  elengths`...    
+000171a0: 636f 6e74 696e 7575 6d5f 6c69 7374 203a  continuum_list :
+000171b0: 204e 6f6e 6520 6f72 206c 6973 740a 2020   None or list.  
+000171c0: 2020 2020 2020 4f76 6572 7269 6465 2074        Override t
+000171d0: 6865 2064 6566 6175 6c74 2063 6f6e 7469  he default conti
+000171e0: 6e75 756d 2074 656d 706c 6174 6573 2069  nuum templates i
+000171f0: 6620 4e6f 6e65 2e0a 0a20 2020 2066 7370  f None...    fsp
+00017200: 735f 7465 6d70 6c61 7465 7320 3a20 626f  s_templates : bo
+00017210: 6f6c 0a20 2020 2020 2020 2049 6620 5472  ol.        If Tr
+00017220: 7565 2c20 6765 7420 7468 6520 4653 5053  ue, get the FSPS
+00017230: 204e 4d46 2074 656d 706c 6174 6573 2e0a   NMF templates..
+00017240: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00017250: 202d 2d2d 2d2d 2d2d 0a20 2020 2074 656d   -------.    tem
+00017260: 705f 6c69 7374 203a 2064 6963 7469 6f6e  p_list : diction
+00017270: 6172 7920 6f66 2060 7e67 7269 7a6c 692e  ary of `~grizli.
+00017280: 7574 696c 732e 5370 6563 7472 756d 5465  utils.SpectrumTe
+00017290: 6d70 6c61 7465 6020 6f62 6a65 6374 730a  mplate` objects.
+000172a0: 2020 2020 2020 2020 4f75 7470 7574 2074          Output t
+000172b0: 656d 706c 6174 6520 6c69 7374 0a0a 2020  emplate list..  
+000172c0: 2020 2222 220a 0a20 2020 2069 6620 7374    """..    if st
+000172d0: 6172 733a 0a20 2020 2020 2020 2023 2074  ars:.        # t
+000172e0: 656d 706c 6174 6573 203d 2067 6c6f 622e  emplates = glob.
+000172f0: 676c 6f62 2827 2573 2f74 656d 706c 6174  glob('%s/templat
+00017300: 6573 2f50 6963 6b6c 6573 5f73 7461 7273  es/Pickles_stars
+00017310: 2f65 7874 2f2a 6461 7427 2025 2847 5249  /ext/*dat' %(GRI
+00017320: 5a4c 495f 5041 5448 2929 0a20 2020 2020  ZLI_PATH)).     
+00017330: 2020 2023 2074 656d 706c 6174 6573 203d     # templates =
+00017340: 205b 5d0a 2020 2020 2020 2020 2320 666f   [].        # fo
+00017350: 7220 7420 696e 2027 6f62 6166 676b 6d72  r t in 'obafgkmr
+00017360: 7727 3a0a 2020 2020 2020 2020 2320 2020  w':.        #   
+00017370: 2020 7465 6d70 6c61 7465 732e 6578 7465    templates.exte
+00017380: 6e64 2820 676c 6f62 2e67 6c6f 6228 2725  nd( glob.glob('%
+00017390: 732f 7465 6d70 6c61 7465 732f 5069 636b  s/templates/Pick
+000173a0: 6c65 735f 7374 6172 732f 6578 742f 756b  les_stars/ext/uk
+000173b0: 2573 2a64 6174 2720 2528 6f73 2e67 6574  %s*dat' %(os.get
+000173c0: 656e 7628 2754 4852 4545 4448 5354 2729  env('THREEDHST')
+000173d0: 2c20 7429 2929 0a20 2020 2020 2020 2023  , t))).        #
+000173e0: 2074 656d 706c 6174 6573 2e65 7874 656e   templates.exten
+000173f0: 6428 676c 6f62 2e67 6c6f 6228 2725 732f  d(glob.glob('%s/
+00017400: 7465 6d70 6c61 7465 732f 5350 4558 2f73  templates/SPEX/s
+00017410: 7065 782d 7072 6973 6d2d 4d2a 7478 7427  pex-prism-M*txt'
+00017420: 2025 286f 732e 6765 7465 6e76 2827 5448   %(os.getenv('TH
+00017430: 5245 4544 4853 5427 2929 2929 0a20 2020  REEDHST')))).   
+00017440: 2020 2020 2023 2074 656d 706c 6174 6573       # templates
+00017450: 2e65 7874 656e 6428 676c 6f62 2e67 6c6f  .extend(glob.glo
+00017460: 6228 2725 732f 7465 6d70 6c61 7465 732f  b('%s/templates/
+00017470: 5350 4558 2f73 7065 782d 7072 6973 6d2d  SPEX/spex-prism-
+00017480: 5b4c 545d 2a74 7874 2720 2528 6f73 2e67  [LT]*txt' %(os.g
+00017490: 6574 656e 7628 2754 4852 4545 4448 5354  etenv('THREEDHST
+000174a0: 2729 2929 290a 2020 2020 2020 2020 230a  ')))).        #.
+000174b0: 2020 2020 2020 2020 2320 2374 656d 706c          # #templ
+000174c0: 6174 6573 203d 2067 6c6f 622e 676c 6f62  ates = glob.glob
+000174d0: 2827 2f55 7365 7273 2f62 7261 6d6d 6572  ('/Users/brammer
+000174e0: 2f44 6f77 6e6c 6f61 6473 2f74 656d 706c  /Downloads/templ
+000174f0: 6174 6573 2f73 7065 782a 7478 7427 290a  ates/spex*txt').
+00017500: 2020 2020 2020 2020 2320 7465 6d70 6c61          # templa
+00017510: 7465 7320 3d20 676c 6f62 2e67 6c6f 6228  tes = glob.glob(
+00017520: 2762 7067 732f 2a61 7363 6969 2729 0a20  'bpgs/*ascii'). 
+00017530: 2020 2020 2020 2023 2069 6e66 6f20 3d20         # info = 
+00017540: 6361 7449 4f2e 5461 626c 6528 2762 7067  catIO.Table('bpg
+00017550: 732f 6270 6773 2e69 6e66 6f27 290a 2020  s/bpgs.info').  
+00017560: 2020 2020 2020 2320 7479 7065 203d 206e        # type = n
+00017570: 702e 6172 7261 7928 5b74 5b3a 325d 2066  p.array([t[:2] f
+00017580: 6f72 2074 2069 6e20 696e 666f 5b27 7479  or t in info['ty
+00017590: 7065 275d 5d29 0a20 2020 2020 2020 2023  pe']]).        #
+000175a0: 2074 656d 706c 6174 6573 203d 205b 5d0a   templates = [].
+000175b0: 2020 2020 2020 2020 2320 666f 7220 7420          # for t 
+000175c0: 696e 2027 4f42 4146 474b 4d27 3a0a 2020  in 'OBAFGKM':.  
+000175d0: 2020 2020 2020 2320 2020 2020 7465 7374        #     test
+000175e0: 203d 2074 7970 6520 3d3d 2027 2d25 7327   = type == '-%s'
+000175f0: 2025 2874 290a 2020 2020 2020 2020 2320   %(t).        # 
+00017600: 2020 2020 736f 203d 206e 702e 6172 6773      so = np.args
+00017610: 6f72 7428 696e 666f 5b27 7479 7065 275d  ort(info['type']
+00017620: 5b74 6573 745d 290a 2020 2020 2020 2020  [test]).        
+00017630: 2320 2020 2020 7465 6d70 6c61 7465 732e  #     templates.
+00017640: 6578 7465 6e64 2869 6e66 6f5b 2766 696c  extend(info['fil
+00017650: 6527 5d5b 7465 7374 5d5b 736f 5d29 0a20  e'][test][so]). 
+00017660: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00017670: 2023 2074 656d 705f 6c69 7374 203d 204f   # temp_list = O
+00017680: 7264 6572 6564 4469 6374 2829 0a20 2020  rderedDict().   
+00017690: 2020 2020 2023 2066 6f72 2074 656d 7020       # for temp 
+000176a0: 696e 2074 656d 706c 6174 6573 3a0a 2020  in templates:.  
+000176b0: 2020 2020 2020 2320 2020 2020 2364 6174        #     #dat
+000176c0: 6120 3d20 6e70 2e6c 6f61 6474 7874 2827  a = np.loadtxt('
+000176d0: 6270 6773 2f27 2b74 656d 702c 2075 6e70  bpgs/'+temp, unp
+000176e0: 6163 6b3d 5472 7565 290a 2020 2020 2020  ack=True).      
+000176f0: 2020 2320 2020 2020 6461 7461 203d 206e    #     data = n
+00017700: 702e 6c6f 6164 7478 7428 7465 6d70 2c20  p.loadtxt(temp, 
+00017710: 756e 7061 636b 3d54 7275 6529 0a20 2020  unpack=True).   
+00017720: 2020 2020 2023 2020 2020 2023 6461 7461       #     #data
+00017730: 5b30 5d20 2a3d 2031 2e65 3420 2320 7370  [0] *= 1.e4 # sp
+00017740: 6578 0a20 2020 2020 2020 2023 2020 2020  ex.        #    
+00017750: 2073 636c 203d 206e 702e 696e 7465 7270   scl = np.interp
+00017760: 2835 3530 302e 2c20 6461 7461 5b30 5d2c  (5500., data[0],
+00017770: 2064 6174 615b 315d 290a 2020 2020 2020   data[1]).      
+00017780: 2020 2320 2020 2020 6e61 6d65 203d 206f    #     name = o
+00017790: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+000177a0: 7465 6d70 290a 2020 2020 2020 2020 2320  temp).        # 
+000177b0: 2020 2020 2369 7820 3d20 696e 666f 5b27      #ix = info['
+000177c0: 6669 6c65 275d 203d 3d20 7465 6d70 0a20  file'] == temp. 
+000177d0: 2020 2020 2020 2023 2020 2020 2023 6e61         #     #na
+000177e0: 6d65 3d27 2535 7320 2573 2720 2528 696e  me='%5s %s' %(in
+000177f0: 666f 5b27 7479 7065 275d 5b69 785d 5b30  fo['type'][ix][0
+00017800: 5d5b 313a 5d2c 2074 656d 702e 7370 6c69  ][1:], temp.spli
+00017810: 7428 272e 6173 2729 5b30 5d29 0a20 2020  t('.as')[0]).   
+00017820: 2020 2020 2023 2020 2020 2070 7269 6e74       #     print
+00017830: 286e 616d 6529 0a20 2020 2020 2020 2023  (name).        #
+00017840: 2020 2020 2074 656d 705f 6c69 7374 5b6e       temp_list[n
+00017850: 616d 655d 203d 2075 7469 6c73 2e53 7065  ame] = utils.Spe
+00017860: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+00017870: 7665 3d64 6174 615b 305d 2c0a 2020 2020  ve=data[0],.    
+00017880: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00017890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178b0: 2020 2066 6c75 783d 6461 7461 5b31 5d2f     flux=data[1]/
+000178c0: 7363 6c29 0a0a 2020 2020 2020 2020 2320  scl)..        # 
+000178d0: 6e70 2e73 6176 6528 2773 7461 7273 5f62  np.save('stars_b
+000178e0: 7067 732e 6e70 7927 2c20 5b74 656d 705f  pgs.npy', [temp_
+000178f0: 6c69 7374 5d29 0a0a 2020 2020 2020 2020  list])..        
+00017900: 2320 7461 6c6c 203d 206e 702e 6c6f 6164  # tall = np.load
+00017910: 286f 732e 7061 7468 2e6a 6f69 6e28 4752  (os.path.join(GR
+00017920: 495a 4c49 5f50 4154 482c 0a20 2020 2020  IZLI_PATH,.     
+00017930: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00017940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017950: 2020 2020 2020 2774 656d 706c 6174 6573        'templates
+00017960: 2f73 7461 7273 2e6e 7079 2729 295b 305d  /stars.npy'))[0]
+00017970: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00017980: 2020 2023 2072 6574 7572 6e20 7461 6c6c     # return tall
+00017990: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+000179a0: 2020 2023 2074 656d 705f 6c69 7374 203d     # temp_list =
+000179b0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+000179c0: 2020 2020 2020 2023 2066 6f72 206b 2069         # for k i
+000179d0: 6e20 7461 6c6c 3a0a 2020 2020 2020 2020  n tall:.        
+000179e0: 2320 2020 2020 6966 206b 2e73 7461 7274  #     if k.start
+000179f0: 7377 6974 6828 2775 6b27 293a 0a20 2020  swith('uk'):.   
+00017a00: 2020 2020 2023 2020 2020 2020 2020 2074       #         t
+00017a10: 656d 705f 6c69 7374 5b6b 5d20 3d20 7461  emp_list[k] = ta
+00017a20: 6c6c 5b6b 5d0a 2020 2020 2020 2020 230a  ll[k].        #.
+00017a30: 2020 2020 2020 2020 2320 7265 7475 726e          # return
+00017a40: 2074 656d 705f 6c69 7374 0a20 2020 2020   temp_list.     
+00017a50: 2020 2023 0a20 2020 2020 2020 2023 2066     #.        # f
+00017a60: 6f72 2074 2069 6e20 274d 4c54 273a 0a20  or t in 'MLT':. 
+00017a70: 2020 2020 2020 2023 2020 2020 2066 6f72         #     for
+00017a80: 206b 2069 6e20 7461 6c6c 3a0a 2020 2020   k in tall:.    
+00017a90: 2020 2020 2320 2020 2020 2020 2020 6966      #         if
+00017aa0: 206b 2e73 7461 7274 7377 6974 6828 2773   k.startswith('s
+00017ab0: 7065 782d 7072 6973 6d2d 272b 7429 3a0a  pex-prism-'+t):.
+00017ac0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00017ad0: 2020 2020 2020 7465 6d70 5f6c 6973 745b        temp_list[
+00017ae0: 6b5d 203d 2074 616c 6c5b 6b5d 0a20 2020  k] = tall[k].   
+00017af0: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00017b00: 2072 6574 7572 6e20 7465 6d70 5f6c 6973   return temp_lis
+00017b10: 740a 0a20 2020 2020 2020 2023 2072 6574  t..        # ret
+00017b20: 7572 6e20 7465 6d70 5f6c 6973 740a 2020  urn temp_list.  
+00017b30: 2020 2020 2020 7465 6d70 6c61 7465 7320        templates 
+00017b40: 3d20 5b27 4d36 2e35 2e74 7874 272c 2027  = ['M6.5.txt', '
+00017b50: 4d38 2e30 2e74 7874 272c 2027 4c31 2e30  M8.0.txt', 'L1.0
+00017b60: 2e74 7874 272c 2027 4c33 2e35 2e74 7874  .txt', 'L3.5.txt
+00017b70: 272c 2027 4c36 2e30 2e74 7874 272c 2027  ', 'L6.0.txt', '
+00017b80: 5432 2e30 2e74 7874 272c 2027 5436 2e30  T2.0.txt', 'T6.0
+00017b90: 2e74 7874 272c 2027 5437 2e35 2e74 7874  .txt', 'T7.5.txt
+00017ba0: 275d 0a20 2020 2020 2020 2074 656d 706c  '].        templ
+00017bb0: 6174 6573 203d 205b 2773 7461 7273 2f27  ates = ['stars/'
+00017bc0: 2b74 2066 6f72 2074 2069 6e20 7465 6d70  +t for t in temp
+00017bd0: 6c61 7465 735d 0a20 2020 2065 6c73 653a  lates].    else:
+00017be0: 0a20 2020 2020 2020 2023 2049 6e74 6572  .        # Inter
+00017bf0: 6d65 6469 6174 6520 616e 6420 7665 7279  mediate and very
+00017c00: 206f 6c64 0a20 2020 2020 2020 2023 2074   old.        # t
+00017c10: 656d 706c 6174 6573 203d 205b 2774 656d  emplates = ['tem
+00017c20: 706c 6174 6573 2f45 415a 595f 7631 2e30  plates/EAZY_v1.0
+00017c30: 5f6c 696e 6573 2f65 617a 795f 7631 2e30  _lines/eazy_v1.0
+00017c40: 5f73 6564 335f 6e6f 6c69 6e65 732e 6461  _sed3_nolines.da
+00017c50: 7427 2c0a 2020 2020 2020 2020 2320 2020  t',.        #   
+00017c60: 2020 2020 2020 2020 2020 2027 7465 6d70             'temp
+00017c70: 6c61 7465 732f 6376 6431 325f 7431 315f  lates/cvd12_t11_
+00017c80: 736f 6c61 725f 4368 6162 7269 6572 2e65  solar_Chabrier.e
+00017c90: 7874 656e 642e 736b 6970 3130 2e64 6174  xtend.skip10.dat
+00017ca0: 275d 0a20 2020 2020 2020 2074 656d 706c  '].        templ
+00017cb0: 6174 6573 203d 205b 2765 617a 795f 696e  ates = ['eazy_in
+00017cc0: 7465 726d 6564 6961 7465 2e64 6174 272c  termediate.dat',
+00017cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017ce0: 2020 2020 2020 2763 7664 3132 5f74 3131        'cvd12_t11
+00017cf0: 5f73 6f6c 6172 5f43 6861 6272 6965 722e  _solar_Chabrier.
+00017d00: 6461 7427 5d0a 0a20 2020 2020 2020 2023  dat']..        #
+00017d10: 2050 6f73 7420 7374 6172 6275 7273 740a   Post starburst.
+00017d20: 2020 2020 2020 2020 2320 7465 6d70 6c61          # templa
+00017d30: 7465 732e 6170 7065 6e64 2827 7465 6d70  tes.append('temp
+00017d40: 6c61 7465 732f 556c 7472 6156 4953 5441  lates/UltraVISTA
+00017d50: 2f65 617a 795f 7631 2e31 5f73 6564 392e  /eazy_v1.1_sed9.
+00017d60: 6461 7427 290a 2020 2020 2020 2020 7465  dat').        te
+00017d70: 6d70 6c61 7465 732e 6170 7065 6e64 2827  mplates.append('
+00017d80: 706f 7374 5f73 7461 7262 7572 7374 2e64  post_starburst.d
+00017d90: 6174 2729 0a0a 2020 2020 2020 2020 2320  at')..        # 
+00017da0: 5665 7279 2062 6c75 6520 636f 6e74 696e  Very blue contin
+00017db0: 7575 6d0a 2020 2020 2020 2020 2320 7465  uum.        # te
+00017dc0: 6d70 6c61 7465 732e 6170 7065 6e64 2827  mplates.append('
+00017dd0: 7465 6d70 6c61 7465 732f 596f 756e 6753  templates/YoungS
+00017de0: 422f 6572 6232 3031 305f 636f 6e74 696e  B/erb2010_contin
+00017df0: 7575 6d2e 6461 7427 290a 2020 2020 2020  uum.dat').      
+00017e00: 2020 7465 6d70 6c61 7465 732e 6170 7065    templates.appe
+00017e10: 6e64 2827 6572 6232 3031 305f 636f 6e74  nd('erb2010_cont
+00017e20: 696e 7575 6d2e 6461 7427 290a 0a20 2020  inuum.dat')..   
+00017e30: 2020 2020 2023 2054 6573 7420 6e65 7720       # Test new 
+00017e40: 7465 6d70 6c61 7465 730a 2020 2020 2020  templates.      
+00017e50: 2020 2320 7465 6d70 6c61 7465 7320 3d20    # templates = 
+00017e60: 5b27 7465 6d70 6c61 7465 732f 6572 6232  ['templates/erb2
+00017e70: 3031 305f 636f 6e74 696e 7575 6d2e 6461  010_continuum.da
+00017e80: 7427 2c0a 2020 2020 2020 2020 2320 2774  t',.        # 't
+00017e90: 656d 706c 6174 6573 2f66 7370 732f 7477  emplates/fsps/tw
+00017ea0: 6561 6b5f 6673 7073 5f74 656d 705f 6b63  eak_fsps_temp_kc
+00017eb0: 3133 5f31 325f 3030 362e 6461 7427 2c0a  13_12_006.dat',.
+00017ec0: 2020 2020 2020 2020 2320 2774 656d 706c          # 'templ
+00017ed0: 6174 6573 2f66 7370 732f 7477 6561 6b5f  ates/fsps/tweak_
+00017ee0: 6673 7073 5f74 656d 705f 6b63 3133 5f31  fsps_temp_kc13_1
+00017ef0: 325f 3030 382e 6461 7427 5d0a 0a20 2020  2_008.dat']..   
+00017f00: 2020 2020 2069 6620 6673 7073 5f74 656d       if fsps_tem
+00017f10: 706c 6174 6573 3a0a 2020 2020 2020 2020  plates:.        
+00017f20: 2020 2020 2374 656d 706c 6174 6573 203d      #templates =
+00017f30: 205b 2774 656d 706c 6174 6573 2f66 7370   ['templates/fsp
+00017f40: 732f 7477 6561 6b5f 6673 7073 5f74 656d  s/tweak_fsps_tem
+00017f50: 705f 6b63 3133 5f31 325f 307b 303a 3032  p_kc13_12_0{0:02
+00017f60: 647d 2e64 6174 272e 666f 726d 6174 2869  d}.dat'.format(i
+00017f70: 2b31 2920 666f 7220 6920 696e 2072 616e  +1) for i in ran
+00017f80: 6765 2831 3229 5d0a 2020 2020 2020 2020  ge(12)].        
+00017f90: 2020 2020 7465 6d70 6c61 7465 7320 3d20      templates = 
+00017fa0: 5b27 6673 7073 2f66 7370 735f 5153 465f  ['fsps/fsps_QSF_
+00017fb0: 3132 5f76 335f 6e6f 6c69 6e65 735f 307b  12_v3_nolines_0{
+00017fc0: 303a 3032 647d 2e64 6174 272e 666f 726d  0:02d}.dat'.form
+00017fd0: 6174 2869 2b31 2920 666f 7220 6920 696e  at(i+1) for i in
+00017fe0: 2072 616e 6765 2831 3229 5d0a 2020 2020   range(12)].    
+00017ff0: 2020 2020 2020 2020 2374 656d 706c 6174          #templat
+00018000: 6573 203d 205b 2766 7370 732f 6673 7073  es = ['fsps/fsps
+00018010: 5f51 5346 5f37 5f76 335f 6e6f 6c69 6e65  _QSF_7_v3_noline
+00018020: 735f 307b 303a 3032 647d 2e64 6174 272e  s_0{0:02d}.dat'.
+00018030: 666f 726d 6174 2869 2b31 2920 666f 7220  format(i+1) for 
+00018040: 6920 696e 2072 616e 6765 2837 295d 0a0a  i in range(7)]..
+00018050: 2020 2020 2020 2020 6966 2061 6c66 5f74          if alf_t
+00018060: 656d 706c 6174 653a 0a20 2020 2020 2020  emplate:.       
+00018070: 2020 2020 2074 656d 706c 6174 6573 2e61       templates.a
+00018080: 7070 656e 6428 2761 6c66 5f53 5350 2e64  ppend('alf_SSP.d
+00018090: 6174 2729 0a0a 2020 2020 2020 2020 6966  at')..        if
+000180a0: 2063 6f6e 7469 6e75 756d 5f6c 6973 7420   continuum_list 
+000180b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000180c0: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+000180d0: 6573 203d 2063 6f6e 7469 6e75 756d 5f6c  es = continuum_l
+000180e0: 6973 740a 0a20 2020 2074 656d 705f 6c69  ist..    temp_li
+000180f0: 7374 203d 204f 7264 6572 6564 4469 6374  st = OrderedDict
+00018100: 2829 0a20 2020 2066 6f72 2074 656d 7020  ().    for temp 
+00018110: 696e 2074 656d 706c 6174 6573 3a0a 2020  in templates:.  
+00018120: 2020 2020 2020 6461 7461 203d 206e 702e        data = np.
+00018130: 6c6f 6164 7478 7428 6f73 2e70 6174 682e  loadtxt(os.path.
+00018140: 6a6f 696e 2847 5249 5a4c 495f 5041 5448  join(GRIZLI_PATH
+00018150: 2c20 2774 656d 706c 6174 6573 272c 2074  , 'templates', t
+00018160: 656d 7029 2c20 756e 7061 636b 3d54 7275  emp), unpack=Tru
+00018170: 6529 0a20 2020 2020 2020 2023 7363 6c20  e).        #scl 
+00018180: 3d20 6e70 2e69 6e74 6572 7028 3535 3030  = np.interp(5500
+00018190: 2e2c 2064 6174 615b 305d 2c20 6461 7461  ., data[0], data
+000181a0: 5b31 5d29 0a20 2020 2020 2020 2073 636c  [1]).        scl
+000181b0: 203d 2031 2e0a 2020 2020 2020 2020 6e61   = 1..        na
+000181c0: 6d65 203d 2074 656d 7020 2023 206f 732e  me = temp  # os.
+000181d0: 7061 7468 2e62 6173 656e 616d 6528 7465  path.basename(te
+000181e0: 6d70 290a 2020 2020 2020 2020 7465 6d70  mp).        temp
+000181f0: 5f6c 6973 745b 6e61 6d65 5d20 3d20 5370  _list[name] = Sp
+00018200: 6563 7472 756d 5465 6d70 6c61 7465 2877  ectrumTemplate(w
+00018210: 6176 653d 6461 7461 5b30 5d2c 2066 6c75  ave=data[0], flu
+00018220: 783d 6461 7461 5b31 5d2f 7363 6c2c 0a20  x=data[1]/scl,. 
+00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018250: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
+00018260: 616d 6529 0a0a 2020 2020 2020 2020 7465  ame)..        te
+00018270: 6d70 5f6c 6973 745b 6e61 6d65 5d2e 6e61  mp_list[name].na
+00018280: 6d65 203d 206e 616d 650a 0a20 2020 2069  me = name..    i
+00018290: 6620 7374 6172 733a 0a20 2020 2020 2020  f stars:.       
+000182a0: 2072 6574 7572 6e20 7465 6d70 5f6c 6973   return temp_lis
+000182b0: 740a 0a20 2020 2023 2045 6d69 7373 696f  t..    # Emissio
+000182c0: 6e20 6c69 6e65 733a 0a20 2020 206c 696e  n lines:.    lin
+000182d0: 655f 7761 7665 6c65 6e67 7468 732c 206c  e_wavelengths, l
+000182e0: 696e 655f 7261 7469 6f73 203d 2067 6574  ine_ratios = get
+000182f0: 5f6c 696e 655f 7761 7665 6c65 6e67 7468  _line_wavelength
+00018300: 7328 290a 0a20 2020 2069 6620 6c69 6e65  s()..    if line
+00018310: 5f63 6f6d 706c 6578 6573 3a0a 2020 2020  _complexes:.    
+00018320: 2020 2020 236c 696e 655f 6c69 7374 203d      #line_list =
+00018330: 205b 2748 612b 5349 4927 2c20 274f 4949   ['Ha+SII', 'OII
+00018340: 492b 4862 2b48 6127 2c20 274f 4949 275d  I+Hb+Ha', 'OII']
+00018350: 0a20 2020 2020 2020 2023 6c69 6e65 5f6c  .        #line_l
+00018360: 6973 7420 3d20 5b27 4861 2b53 4949 272c  ist = ['Ha+SII',
+00018370: 2027 4f49 4949 2b48 6227 2c20 274f 4949   'OIII+Hb', 'OII
+00018380: 275d 0a20 2020 2020 2020 2023 6c69 6e65  '].        #line
+00018390: 5f6c 6973 7420 3d20 5b27 4861 2b4e 4949  _list = ['Ha+NII
+000183a0: 2b53 4949 2b53 4949 492b 4865 2b50 6142  +SII+SIII+He+PaB
+000183b0: 272c 2027 4f49 4949 2b48 6227 2c20 274f  ', 'OIII+Hb', 'O
+000183c0: 4949 2b4e 6527 2c20 274c 7961 2b43 4956  II+Ne', 'Lya+CIV
+000183d0: 275d 0a20 2020 2020 2020 2023 6c69 6e65  '].        #line
+000183e0: 5f6c 6973 7420 3d20 5b27 4861 2b4e 4949  _list = ['Ha+NII
+000183f0: 2b53 4949 2b53 4949 492b 4865 2b50 6142  +SII+SIII+He+PaB
+00018400: 272c 2027 4f49 4949 2b48 622b 4867 2b48  ', 'OIII+Hb+Hg+H
+00018410: 6427 2c20 274f 4949 2b4e 6527 2c20 274c  d', 'OII+Ne', 'L
+00018420: 7961 2b43 4956 275d 0a20 2020 2020 2020  ya+CIV'].       
+00018430: 206c 696e 655f 6c69 7374 203d 205b 2748   line_list = ['H
+00018440: 612b 4e49 492b 5349 492b 5349 4949 2b48  a+NII+SII+SIII+H
+00018450: 652b 5061 4227 2c20 274f 4949 492b 4862  e+PaB', 'OIII+Hb
+00018460: 2b48 672b 4864 272c 2027 4f49 492b 4e65  +Hg+Hd', 'OII+Ne
+00018470: 272c 2027 4761 6c2d 5556 2d6c 696e 6573  ', 'Gal-UV-lines
+00018480: 275d 0a0a 2020 2020 656c 7365 3a0a 2020  ']..    else:.  
+00018490: 2020 2020 2020 6966 2066 756c 6c5f 6c69        if full_li
+000184a0: 6e65 5f6c 6973 7420 6973 204e 6f6e 653a  ne_list is None:
+000184b0: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+000184c0: 655f 6c69 7374 203d 2044 4546 4155 4c54  e_list = DEFAULT
+000184d0: 5f4c 494e 455f 4c49 5354 0a20 2020 2020  _LINE_LIST.     
+000184e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000184f0: 2020 2020 206c 696e 655f 6c69 7374 203d       line_list =
+00018500: 2066 756c 6c5f 6c69 6e65 5f6c 6973 740a   full_line_list.
+00018510: 0a20 2020 2020 2020 2023 6c69 6e65 5f6c  .        #line_l
+00018520: 6973 7420 3d20 5b27 4861 272c 2027 5349  ist = ['Ha', 'SI
+00018530: 4927 5d0a 0a20 2020 2023 2055 7365 2046  I']..    # Use F
+00018540: 5350 5320 6772 6964 2066 6f72 206c 696e  SPS grid for lin
+00018550: 6573 0a20 2020 2077 6176 655f 6772 6964  es.    wave_grid
+00018560: 203d 204e 6f6e 650a 2020 2020 2320 6966   = None.    # if
+00018570: 2066 7370 735f 7465 6d70 6c61 7465 733a   fsps_templates:
+00018580: 0a20 2020 2023 2020 2020 2077 6176 655f  .    #     wave_
+00018590: 6772 6964 203d 2064 6174 615b 305d 0a20  grid = data[0]. 
+000185a0: 2020 2023 2065 6c73 653a 0a20 2020 2023     # else:.    #
+000185b0: 2020 2020 2077 6176 655f 6772 6964 203d       wave_grid =
+000185c0: 204e 6f6e 650a 0a20 2020 2066 6f72 206c   None..    for l
+000185d0: 6920 696e 206c 696e 655f 6c69 7374 3a0a  i in line_list:.
+000185e0: 2020 2020 2020 2020 7363 6c20 3d20 6c69          scl = li
+000185f0: 6e65 5f72 6174 696f 735b 6c69 5d2f 6e70  ne_ratios[li]/np
+00018600: 2e73 756d 286c 696e 655f 7261 7469 6f73  .sum(line_ratios
+00018610: 5b6c 695d 290a 2020 2020 2020 2020 666f  [li]).        fo
+00018620: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+00018630: 2873 636c 2929 3a0a 2020 2020 2020 2020  (scl)):.        
+00018640: 2020 2020 6966 2028 274f 3332 2720 696e      if ('O32' in
+00018650: 206c 6929 2026 2028 6e70 2e61 6273 286c   li) & (np.abs(l
+00018660: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00018670: 6c69 5d5b 695d 2d32 3739 3929 203c 2032  li][i]-2799) < 2
+00018680: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00018690: 2020 2066 7768 6d5f 6920 3d20 3235 3030     fwhm_i = 2500
+000186a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000186b0: 206c 6f72 656e 747a 5f69 203d 2054 7275   lorentz_i = Tru
+000186c0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+000186d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000186e0: 2020 2020 6677 686d 5f69 203d 2066 7768      fwhm_i = fwh
+000186f0: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00018700: 2020 6c6f 7265 6e74 7a5f 6920 3d20 6c6f    lorentz_i = lo
+00018710: 7265 6e74 7a0a 0a20 2020 2020 2020 2020  rentz..         
+00018720: 2020 206c 696e 655f 6920 3d20 5370 6563     line_i = Spec
+00018730: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+00018740: 653d 7761 7665 5f67 7269 642c 0a20 2020  e=wave_grid,.   
+00018750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018770: 2020 2063 656e 7472 616c 5f77 6176 653d     central_wave=
+00018780: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00018790: 5b6c 695d 5b69 5d2c 0a20 2020 2020 2020  [li][i],.       
+000187a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000187c0: 6c75 783d 4e6f 6e65 2c20 6677 686d 3d66  lux=None, fwhm=f
+000187d0: 7768 6d5f 692c 2076 656c 6f63 6974 793d  whm_i, velocity=
+000187e0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000187f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018800: 2020 2020 2020 2020 2020 2020 6c6f 7265              lore
+00018810: 6e74 7a3d 6c6f 7265 6e74 7a5f 6929 0a0a  ntz=lorentz_i)..
+00018820: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00018830: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00018840: 2020 2020 2020 206c 696e 655f 7465 6d70         line_temp
+00018850: 203d 206c 696e 655f 692a 7363 6c5b 695d   = line_i*scl[i]
+00018860: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00018870: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018880: 2020 206c 696e 655f 7465 6d70 203d 206c     line_temp = l
+00018890: 696e 655f 7465 6d70 202b 206c 696e 655f  ine_temp + line_
+000188a0: 692a 7363 6c5b 695d 0a0a 2020 2020 2020  i*scl[i]..      
+000188b0: 2020 6e61 6d65 203d 2027 6c69 6e65 207b    name = 'line {
+000188c0: 307d 272e 666f 726d 6174 286c 6929 0a20  0}'.format(li). 
+000188d0: 2020 2020 2020 206c 696e 655f 7465 6d70         line_temp
+000188e0: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
+000188f0: 2020 2020 2074 656d 705f 6c69 7374 5b6e       temp_list[n
+00018900: 616d 655d 203d 206c 696e 655f 7465 6d70  ame] = line_temp
+00018910: 0a0a 2020 2020 7265 7475 726e 2074 656d  ..    return tem
+00018920: 705f 6c69 7374 0a0a 0a64 6566 206c 6f61  p_list...def loa
+00018930: 645f 6265 7461 5f74 656d 706c 6174 6573  d_beta_templates
+00018940: 2877 6176 653d 6e70 2e61 7261 6e67 6528  (wave=np.arange(
+00018950: 3430 302c 2032 2e35 6534 292c 2062 6574  400, 2.5e4), bet
+00018960: 6173 3d5b 2d32 2c20 2d31 2c20 305d 293a  as=[-2, -1, 0]):
+00018970: 0a20 2020 2022 2222 0a20 2020 2053 7465  .    """.    Ste
+00018980: 702d 6675 6e63 7469 6f6e 2074 656d 706c  p-function templ
+00018990: 6174 6573 2077 6974 6820 665f 6c61 6d62  ates with f_lamb
+000189a0: 6461 207e 2028 7761 7665 2f31 3231 362e  da ~ (wave/1216.
+000189b0: 292a 2a62 6574 610a 2020 2020 2222 220a  )**beta.    """.
+000189c0: 2020 2020 636f 6e74 5f77 6176 6520 3d20      cont_wave = 
+000189d0: 6e70 2e61 7261 6e67 6528 3430 302c 2032  np.arange(400, 2
+000189e0: 2e35 6534 290a 2020 2020 7430 203d 207b  .5e4).    t0 = {
+000189f0: 7d0a 2020 2020 666f 7220 6265 7461 2069  }.    for beta i
+00018a00: 6e20 6265 7461 733a 0a20 2020 2020 2020  n betas:.       
+00018a10: 206b 6579 203d 2027 6265 7461 207b 307d   key = 'beta {0}
+00018a20: 272e 666f 726d 6174 2862 6574 6129 0a20  '.format(beta). 
+00018a30: 2020 2020 2020 2074 305b 6b65 795d 203d         t0[key] =
+00018a40: 2053 7065 6374 7275 6d54 656d 706c 6174   SpectrumTemplat
+00018a50: 6528 7761 7665 3d63 6f6e 745f 7761 7665  e(wave=cont_wave
+00018a60: 2c20 666c 7578 3d28 636f 6e74 5f77 6176  , flux=(cont_wav
+00018a70: 652f 3132 3136 2e29 2a2a 6265 7461 290a  e/1216.)**beta).
+00018a80: 2020 2020 7265 7475 726e 2074 300a 0a0a      return t0...
+00018a90: 6465 6620 6c6f 6164 5f71 7561 7361 725f  def load_quasar_
+00018aa0: 7465 6d70 6c61 7465 7328 6272 6f61 645f  templates(broad_
+00018ab0: 6677 686d 3d32 3530 302c 206e 6172 726f  fwhm=2500, narro
+00018ac0: 775f 6677 686d 3d31 3230 302c 2062 726f  w_fwhm=1200, bro
+00018ad0: 6164 5f6c 696e 6573 3d5b 2748 6549 2d35  ad_lines=['HeI-5
+00018ae0: 3837 3727 2c20 274d 6749 4927 2c20 274c  877', 'MgII', 'L
+00018af0: 7961 272c 2027 4349 562d 3135 3439 272c  ya', 'CIV-1549',
+00018b00: 2027 4349 4949 2d31 3930 3627 2c20 2743   'CIII-1906', 'C
+00018b10: 4949 492d 3139 3038 272c 2027 4f49 4949  III-1908', 'OIII
+00018b20: 2d31 3636 3327 2c20 2748 6549 492d 3136  -1663', 'HeII-16
+00018b30: 3430 272c 2027 5369 4956 2b4f 4956 2d31  40', 'SiIV+OIV-1
+00018b40: 3339 3827 2c20 274e 4956 2d31 3438 3727  398', 'NIV-1487'
+00018b50: 2c20 274e 562d 3132 3430 272c 2027 5061  , 'NV-1240', 'Pa
+00018b60: 4227 2c20 2750 6147 275d 2c20 6e61 7272  B', 'PaG'], narr
+00018b70: 6f77 5f6c 696e 6573 3d5b 274e 4949 492d  ow_lines=['NIII-
+00018b80: 3137 3530 272c 2027 4f49 4927 2c20 274f  1750', 'OII', 'O
+00018b90: 4949 4927 2c20 2753 4949 272c 2027 4f49  III', 'SII', 'OI
+00018ba0: 2d36 3330 3227 2c20 274f 4949 492d 3433  -6302', 'OIII-43
+00018bb0: 3633 272c 2027 4e65 4949 492d 3338 3637  63', 'NeIII-3867
+00018bc0: 272c 2027 4e65 5649 2d33 3432 3627 2c20  ', 'NeVI-3426', 
+00018bd0: 274e 6556 2d33 3334 3627 2c20 274f 4949  'NeV-3346', 'OII
+00018be0: 2d37 3332 3527 2c20 2741 7249 4949 2d37  -7325', 'ArIII-7
+00018bf0: 3133 3827 2c20 2753 4949 4927 2c20 2748  138', 'SIII', 'H
+00018c00: 6549 2d31 3038 3327 5d2c 2069 6e63 6c75  eI-1083'], inclu
+00018c10: 6465 5f66 6569 693d 5472 7565 2c20 736c  de_feii=True, sl
+00018c20: 6f70 6573 3d5b 2d32 2e38 2c20 302c 2032  opes=[-2.8, 0, 2
+00018c30: 2e38 5d2c 2075 765f 6c69 6e65 5f63 6f6d  .8], uv_line_com
+00018c40: 706c 6578 3d54 7275 652c 2066 6978 6564  plex=True, fixed
+00018c50: 5f6e 6172 726f 775f 6c69 6e65 733d 4661  _narrow_lines=Fa
+00018c60: 6c73 652c 2074 315f 6f6e 6c79 3d46 616c  lse, t1_only=Fal
+00018c70: 7365 2c20 6e73 706c 696e 653d 3133 2c20  se, nspline=13, 
+00018c80: 5273 706c 696e 653d 3330 2c20 6265 7461  Rspline=30, beta
+00018c90: 733d 4e6f 6e65 2c20 696e 636c 7564 655f  s=None, include_
+00018ca0: 7265 6464 656e 6564 5f62 616c 6d65 725f  reddened_balmer_
+00018cb0: 6c69 6e65 733d 4661 6c73 6529 3a0a 2020  lines=False):.  
+00018cc0: 2020 2222 220a 2020 2020 4d61 6b65 2074    """.    Make t
+00018cd0: 656d 706c 6174 6573 2073 7569 7461 626c  emplates suitabl
+00018ce0: 6520 666f 7220 6669 7474 696e 6720 6272  e for fitting br
+00018cf0: 6f61 642d 6c69 6e65 2071 7561 7361 7273  oad-line quasars
+00018d00: 0a20 2020 2022 2222 0a0a 2020 2020 6672  .    """..    fr
+00018d10: 6f6d 2063 6f6c 6c65 6374 696f 6e73 2069  om collections i
+00018d20: 6d70 6f72 7420 4f72 6465 7265 6444 6963  mport OrderedDic
+00018d30: 740a 2020 2020 696d 706f 7274 2073 6369  t.    import sci
+00018d40: 7079 2e6e 6469 6d61 6765 2061 7320 6e64  py.ndimage as nd
+00018d50: 0a0a 2020 2020 7430 203d 204f 7264 6572  ..    t0 = Order
+00018d60: 6564 4469 6374 2829 0a20 2020 2074 3120  edDict().    t1 
+00018d70: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+00018d80: 0a20 2020 2062 726f 6164 3120 3d20 6c6f  .    broad1 = lo
+00018d90: 6164 5f74 656d 706c 6174 6573 2866 7768  ad_templates(fwh
+00018da0: 6d3d 6272 6f61 645f 6677 686d 2c20 6c69  m=broad_fwhm, li
+00018db0: 6e65 5f63 6f6d 706c 6578 6573 3d46 616c  ne_complexes=Fal
+00018dc0: 7365 2c20 7374 6172 733d 4661 6c73 652c  se, stars=False,
+00018dd0: 2066 756c 6c5f 6c69 6e65 5f6c 6973 743d   full_line_list=
+00018de0: 5b27 4861 272c 2027 4862 272c 2027 4867  ['Ha', 'Hb', 'Hg
+00018df0: 272c 2027 4864 272c 2027 4837 272c 2027  ', 'Hd', 'H7', '
+00018e00: 4838 272c 2027 4839 272c 2027 4831 3027  H8', 'H9', 'H10'
+00018e10: 5d20 2b20 6272 6f61 645f 6c69 6e65 732c  ] + broad_lines,
+00018e20: 2063 6f6e 7469 6e75 756d 5f6c 6973 743d   continuum_list=
+00018e30: 5b5d 2c20 6673 7073 5f74 656d 706c 6174  [], fsps_templat
+00018e40: 6573 3d46 616c 7365 2c20 616c 665f 7465  es=False, alf_te
+00018e50: 6d70 6c61 7465 3d46 616c 7365 2c20 6c6f  mplate=False, lo
+00018e60: 7265 6e74 7a3d 5472 7565 290a 0a20 2020  rentz=True)..   
+00018e70: 206e 6172 726f 7731 203d 206c 6f61 645f   narrow1 = load_
+00018e80: 7465 6d70 6c61 7465 7328 6677 686d 3d34  templates(fwhm=4
+00018e90: 3030 2c20 6c69 6e65 5f63 6f6d 706c 6578  00, line_complex
+00018ea0: 6573 3d46 616c 7365 2c20 7374 6172 733d  es=False, stars=
+00018eb0: 4661 6c73 652c 2066 756c 6c5f 6c69 6e65  False, full_line
+00018ec0: 5f6c 6973 743d 6e61 7272 6f77 5f6c 696e  _list=narrow_lin
+00018ed0: 6573 2c20 636f 6e74 696e 7575 6d5f 6c69  es, continuum_li
+00018ee0: 7374 3d5b 5d2c 2066 7370 735f 7465 6d70  st=[], fsps_temp
+00018ef0: 6c61 7465 733d 4661 6c73 652c 2061 6c66  lates=False, alf
+00018f00: 5f74 656d 706c 6174 653d 4661 6c73 6529  _template=False)
+00018f10: 0a0a 2020 2020 6966 2066 6978 6564 5f6e  ..    if fixed_n
+00018f20: 6172 726f 775f 6c69 6e65 733a 0a20 2020  arrow_lines:.   
+00018f30: 2020 2020 2069 6620 7431 5f6f 6e6c 793a       if t1_only:
+00018f40: 0a20 2020 2020 2020 2020 2020 206e 6172  .            nar
+00018f50: 726f 7730 203d 206e 6172 726f 7731 0a20  row0 = narrow1. 
+00018f60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00018f70: 2020 2020 2020 2020 206e 6172 726f 7730           narrow0
+00018f80: 203d 206c 6f61 645f 7465 6d70 6c61 7465   = load_template
+00018f90: 7328 6677 686d 3d6e 6172 726f 775f 6677  s(fwhm=narrow_fw
+00018fa0: 686d 2c20 6c69 6e65 5f63 6f6d 706c 6578  hm, line_complex
+00018fb0: 6573 3d46 616c 7365 2c20 7374 6172 733d  es=False, stars=
+00018fc0: 4661 6c73 652c 2066 756c 6c5f 6c69 6e65  False, full_line
+00018fd0: 5f6c 6973 743d 5b27 5153 4f2d 4e61 7272  _list=['QSO-Narr
+00018fe0: 6f77 2d6c 696e 6573 275d 2c20 636f 6e74  ow-lines'], cont
+00018ff0: 696e 7575 6d5f 6c69 7374 3d5b 5d2c 2066  inuum_list=[], f
+00019000: 7370 735f 7465 6d70 6c61 7465 733d 4661  sps_templates=Fa
+00019010: 6c73 652c 2061 6c66 5f74 656d 706c 6174  lse, alf_templat
+00019020: 653d 4661 6c73 6529 0a0a 2020 2020 656c  e=False)..    el
+00019030: 7365 3a0a 2020 2020 2020 2020 6e61 7272  se:.        narr
+00019040: 6f77 3020 3d20 6c6f 6164 5f74 656d 706c  ow0 = load_templ
+00019050: 6174 6573 2866 7768 6d3d 6e61 7272 6f77  ates(fwhm=narrow
+00019060: 5f66 7768 6d2c 206c 696e 655f 636f 6d70  _fwhm, line_comp
+00019070: 6c65 7865 733d 4661 6c73 652c 2073 7461  lexes=False, sta
+00019080: 7273 3d46 616c 7365 2c20 6675 6c6c 5f6c  rs=False, full_l
+00019090: 696e 655f 6c69 7374 3d6e 6172 726f 775f  ine_list=narrow_
+000190a0: 6c69 6e65 732c 2063 6f6e 7469 6e75 756d  lines, continuum
+000190b0: 5f6c 6973 743d 5b5d 2c20 6673 7073 5f74  _list=[], fsps_t
+000190c0: 656d 706c 6174 6573 3d46 616c 7365 2c20  emplates=False, 
+000190d0: 616c 665f 7465 6d70 6c61 7465 3d46 616c  alf_template=Fal
+000190e0: 7365 290a 0a20 2020 2069 6620 7431 5f6f  se)..    if t1_o
+000190f0: 6e6c 793a 0a20 2020 2020 2020 2062 726f  nly:.        bro
+00019100: 6164 3020 3d20 6272 6f61 6431 0a20 2020  ad0 = broad1.   
+00019110: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
+00019120: 6620 7576 5f6c 696e 655f 636f 6d70 6c65  f uv_line_comple
+00019130: 783a 0a20 2020 2020 2020 2020 2020 2066  x:.            f
+00019140: 756c 6c5f 6c69 6e65 5f6c 6973 7420 3d20  ull_line_list = 
+00019150: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
+00019160: 4d67 4949 2041 763d 302e 3527 2c20 2751  MgII Av=0.5', 'Q
+00019170: 534f 2d55 562d 6c69 6e65 7327 5d0a 2020  SO-UV-lines'].  
 00019180: 2020 2020 2020 2020 2020 2362 726f 6164            #broad
 00019190: 3020 3d20 6c6f 6164 5f74 656d 706c 6174  0 = load_templat
 000191a0: 6573 2866 7768 6d3d 6272 6f61 645f 6677  es(fwhm=broad_fw
 000191b0: 686d 2c20 6c69 6e65 5f63 6f6d 706c 6578  hm, line_complex
 000191c0: 6573 3d46 616c 7365 2c20 7374 6172 733d  es=False, stars=
 000191d0: 4661 6c73 652c 2066 756c 6c5f 6c69 6e65  False, full_line
 000191e0: 5f6c 6973 743d 5b27 4261 6c6d 6572 2031  _list=['Balmer 1
-000191f0: 306b 4b27 5d20 2b20 6272 6f61 645f 6c69  0kK'] + broad_li
-00019200: 6e65 732c 2063 6f6e 7469 6e75 756d 5f6c  nes, continuum_l
-00019210: 6973 743d 5b5d 2c20 6673 7073 5f74 656d  ist=[], fsps_tem
-00019220: 706c 6174 6573 3d46 616c 7365 2c20 616c  plates=False, al
-00019230: 665f 7465 6d70 6c61 7465 3d46 616c 7365  f_template=False
-00019240: 2c20 6c6f 7265 6e74 7a3d 5472 7565 290a  , lorentz=True).
-00019250: 0a20 2020 2020 2020 2069 6620 696e 636c  .        if incl
-00019260: 7564 655f 7265 6464 656e 6564 5f62 616c  ude_reddened_bal
-00019270: 6d65 725f 6c69 6e65 733a 0a20 2020 2020  mer_lines:.     
-00019280: 2020 2020 2020 206c 696e 655f 7761 7665         line_wave
-00019290: 6c65 6e67 7468 732c 206c 696e 655f 7261  lengths, line_ra
-000192a0: 7469 6f73 203d 2067 6574 5f6c 696e 655f  tios = get_line_
-000192b0: 7761 7665 6c65 6e67 7468 7328 290a 2020  wavelengths().  
-000192c0: 2020 2020 2020 2020 2020 6966 2027 4261            if 'Ba
-000192d0: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
-000192e0: 2041 763d 312e 3027 2069 6e20 6c69 6e65   Av=1.0' in line
-000192f0: 5f77 6176 656c 656e 6774 6873 3a0a 2020  _wavelengths:.  
-00019300: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00019310: 6c6c 5f6c 696e 655f 6c69 7374 202b 3d20  ll_line_list += 
-00019320: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
-00019330: 4d67 4949 275d 0a20 2020 2020 2020 2020  MgII'].         
-00019340: 2020 2020 2020 2066 756c 6c5f 6c69 6e65         full_line
-00019350: 5f6c 6973 7420 2b3d 205b 2742 616c 6d65  _list += ['Balme
-00019360: 7220 3130 6b4b 202b 204d 6749 4920 4176  r 10kK + MgII Av
-00019370: 3d31 2e30 275d 0a20 2020 2020 2020 2020  =1.0'].         
-00019380: 2020 2020 2020 2066 756c 6c5f 6c69 6e65         full_line
-00019390: 5f6c 6973 7420 2b3d 205b 2742 616c 6d65  _list += ['Balme
-000193a0: 7220 3130 6b4b 202b 204d 6749 4920 4176  r 10kK + MgII Av
-000193b0: 3d32 2e30 275d 0a0a 2020 2020 2020 2020  =2.0']..        
-000193c0: 6272 6f61 6430 203d 206c 6f61 645f 7465  broad0 = load_te
-000193d0: 6d70 6c61 7465 7328 6677 686d 3d62 726f  mplates(fwhm=bro
-000193e0: 6164 5f66 7768 6d2c 206c 696e 655f 636f  ad_fwhm, line_co
-000193f0: 6d70 6c65 7865 733d 4661 6c73 652c 2073  mplexes=False, s
-00019400: 7461 7273 3d46 616c 7365 2c20 6675 6c6c  tars=False, full
-00019410: 5f6c 696e 655f 6c69 7374 3d66 756c 6c5f  _line_list=full_
-00019420: 6c69 6e65 5f6c 6973 742c 2063 6f6e 7469  line_list, conti
-00019430: 6e75 756d 5f6c 6973 743d 5b5d 2c20 6673  nuum_list=[], fs
-00019440: 7073 5f74 656d 706c 6174 6573 3d46 616c  ps_templates=Fal
-00019450: 7365 2c20 616c 665f 7465 6d70 6c61 7465  se, alf_template
-00019460: 3d46 616c 7365 2c20 6c6f 7265 6e74 7a3d  =False, lorentz=
-00019470: 5472 7565 290a 0a20 2020 2020 2020 2066  True)..        f
-00019480: 6f72 206b 2069 6e20 6272 6f61 6430 3a0a  or k in broad0:.
-00019490: 2020 2020 2020 2020 2020 2020 7430 5b6b              t0[k
-000194a0: 5d20 3d20 6272 6f61 6430 5b6b 5d0a 0a20  ] = broad0[k].. 
-000194b0: 2020 2066 6f72 206b 2069 6e20 6272 6f61     for k in broa
-000194c0: 6431 3a0a 2020 2020 2020 2020 7431 5b6b  d1:.        t1[k
-000194d0: 5d20 3d20 6272 6f61 6431 5b6b 5d0a 0a20  ] = broad1[k].. 
-000194e0: 2020 2066 6f72 206b 2069 6e20 6e61 7272     for k in narr
-000194f0: 6f77 303a 0a20 2020 2020 2020 2074 305b  ow0:.        t0[
-00019500: 6b5d 203d 206e 6172 726f 7730 5b6b 5d0a  k] = narrow0[k].
-00019510: 0a20 2020 2066 6f72 206b 2069 6e20 6e61  .    for k in na
-00019520: 7272 6f77 313a 0a20 2020 2020 2020 2074  rrow1:.        t
-00019530: 315b 6b5d 203d 206e 6172 726f 7731 5b6b  1[k] = narrow1[k
-00019540: 5d0a 0a20 2020 2023 2046 6520 4949 0a20  ]..    # Fe II. 
-00019550: 2020 2069 6620 696e 636c 7564 655f 6665     if include_fe
-00019560: 6969 3a0a 2020 2020 2020 2020 6665 6969  ii:.        feii
-00019570: 5f77 6176 652c 2066 6569 695f 666c 7578  _wave, feii_flux
-00019580: 203d 206e 702e 6c6f 6164 7478 7428 6f73   = np.loadtxt(os
-00019590: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
-000195a0: 6669 6c65 5f5f 2920 2b20 272f 6461 7461  file__) + '/data
-000195b0: 2f74 656d 706c 6174 6573 2f46 6549 495f  /templates/FeII_
-000195c0: 5665 726f 6e43 6574 7479 3230 3034 2e74  VeronCetty2004.t
-000195d0: 7874 272c 2075 6e70 6163 6b3d 5472 7565  xt', unpack=True
-000195e0: 290a 0a20 2020 2020 2020 2023 2073 6d6f  )..        # smo
-000195f0: 6f74 6869 6e67 2c20 696e 2075 6e69 7473  othing, in units
-00019600: 206f 6620 696e 7075 7420 7665 6c6f 6369   of input veloci
-00019610: 7479 2072 6573 6f6c 7574 696f 6e0a 2020  ty resolution.  
-00019620: 2020 2020 2020 6665 6969 5f6b 6572 6e20        feii_kern 
-00019630: 3d20 6272 6f61 645f 6677 686d 2f32 2e33  = broad_fwhm/2.3
-00019640: 3534 382f 3735 2e0a 2020 2020 2020 2020  548/75..        
-00019650: 6665 6969 5f73 6d20 3d20 6e64 2e67 6175  feii_sm = nd.gau
-00019660: 7373 6961 6e5f 6669 6c74 6572 2866 6569  ssian_filter(fei
-00019670: 695f 666c 7578 2c20 6665 6969 5f6b 6572  i_flux, feii_ker
-00019680: 6e29 0a20 2020 2020 2020 2074 305b 2746  n).        t0['F
-00019690: 6549 492d 5643 3230 3034 275d 203d 2074  eII-VC2004'] = t
-000196a0: 315b 2746 6549 492d 5643 3230 3034 275d  1['FeII-VC2004']
-000196b0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
-000196c0: 6174 6528 7761 7665 3d66 6569 695f 7761  ate(wave=feii_wa
-000196d0: 7665 2c20 666c 7578 3d66 6569 695f 736d  ve, flux=feii_sm
-000196e0: 2c20 6e61 6d65 3d27 4665 4949 2d56 4332  , name='FeII-VC2
-000196f0: 3030 3427 290a 0a20 2020 2023 204c 696e  004')..    # Lin
-00019700: 6561 7220 636f 6e74 696e 7561 0a20 2020  ear continua.   
-00019710: 2023 2063 6f6e 745f 7761 7665 203d 206e   # cont_wave = n
-00019720: 702e 6172 616e 6765 2834 3030 2c20 322e  p.arange(400, 2.
-00019730: 3565 3429 0a20 2020 2023 2066 6f72 2073  5e4).    # for s
-00019740: 6c6f 7065 2069 6e20 736c 6f70 6573 3a0a  lope in slopes:.
-00019750: 2020 2020 2320 2020 2020 6b65 7920 3d20      #     key = 
-00019760: 2773 6c6f 7065 207b 307d 272e 666f 726d  'slope {0}'.form
-00019770: 6174 2873 6c6f 7065 290a 2020 2020 2320  at(slope).    # 
-00019780: 2020 2020 7430 5b6b 6579 5d20 3d20 7431      t0[key] = t1
-00019790: 5b6b 6579 5d20 3d20 5370 6563 7472 756d  [key] = Spectrum
-000197a0: 5465 6d70 6c61 7465 2877 6176 653d 636f  Template(wave=co
-000197b0: 6e74 5f77 6176 652c 2066 6c75 783d 2863  nt_wave, flux=(c
-000197c0: 6f6e 745f 7761 7665 2f36 3536 332e 292a  ont_wave/6563.)*
-000197d0: 2a73 6c6f 7065 290a 0a20 2020 2069 6620  *slope)..    if 
-000197e0: 5273 706c 696e 6520 6973 206e 6f74 204e  Rspline is not N
-000197f0: 6f6e 653a 0a20 2020 2020 2020 2077 7370  one:.        wsp
-00019800: 6c69 6e65 203d 206e 702e 6172 616e 6765  line = np.arange
-00019810: 2834 3230 302c 2032 2e35 6534 2c20 3130  (4200, 2.5e4, 10
-00019820: 290a 2020 2020 2020 2020 6466 5f73 706c  ).        df_spl
-00019830: 203d 206c 6f67 5f7a 6772 6964 287a 723d   = log_zgrid(zr=
-00019840: 5b77 7370 6c69 6e65 5b30 5d2c 2077 7370  [wspline[0], wsp
-00019850: 6c69 6e65 5b2d 315d 5d2c 2064 7a3d 312e  line[-1]], dz=1.
-00019860: 2f52 7370 6c69 6e65 290a 2020 2020 2020  /Rspline).      
-00019870: 2020 6273 706c 696e 6573 203d 2062 7370    bsplines = bsp
-00019880: 6c69 6e65 5f74 656d 706c 6174 6573 2877  line_templates(w
-00019890: 7370 6c69 6e65 2c20 6466 3d6c 656e 2864  spline, df=len(d
-000198a0: 665f 7370 6c29 2b32 2c20 6c6f 673d 5472  f_spl)+2, log=Tr
-000198b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000198c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198d0: 2020 2020 2020 2020 2063 6c69 703d 302e           clip=0.
-000198e0: 3030 3031 290a 0a20 2020 2020 2020 2066  0001)..        f
-000198f0: 6f72 206b 6579 2069 6e20 6273 706c 696e  or key in bsplin
-00019900: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00019910: 7430 5b6b 6579 5d20 3d20 7431 5b6b 6579  t0[key] = t1[key
-00019920: 5d20 3d20 6273 706c 696e 6573 5b6b 6579  ] = bsplines[key
-00019930: 5d0a 0a20 2020 2065 6c69 6620 6e73 706c  ]..    elif nspl
-00019940: 696e 6520 3e20 303a 0a20 2020 2020 2020  ine > 0:.       
-00019950: 2023 2053 706c 696e 6520 636f 6e74 696e   # Spline contin
-00019960: 7561 0a20 2020 2020 2020 2063 6f6e 745f  ua.        cont_
-00019970: 7761 7665 203d 206e 702e 6172 616e 6765  wave = np.arange
-00019980: 2835 3030 302c 2032 2e34 6534 290a 2020  (5000, 2.4e4).  
+000191f0: 306b 4b20 2b20 4d67 4949 272c 2027 5153  0kK + MgII', 'QS
+00019200: 4f2d 5556 2d6c 696e 6573 275d 2c20 636f  O-UV-lines'], co
+00019210: 6e74 696e 7575 6d5f 6c69 7374 3d5b 5d2c  ntinuum_list=[],
+00019220: 2066 7370 735f 7465 6d70 6c61 7465 733d   fsps_templates=
+00019230: 4661 6c73 652c 2061 6c66 5f74 656d 706c  False, alf_templ
+00019240: 6174 653d 4661 6c73 652c 206c 6f72 656e  ate=False, loren
+00019250: 747a 3d54 7275 6529 0a20 2020 2020 2020  tz=True).       
+00019260: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019270: 2020 2066 756c 6c5f 6c69 6e65 5f6c 6973     full_line_lis
+00019280: 7420 3d20 5b27 4261 6c6d 6572 2031 306b  t = ['Balmer 10k
+00019290: 4b20 2b20 4d67 4949 2041 763d 302e 3527  K + MgII Av=0.5'
+000192a0: 5d0a 2020 2020 2020 2020 2020 2020 2362  ].            #b
+000192b0: 726f 6164 3020 3d20 6c6f 6164 5f74 656d  road0 = load_tem
+000192c0: 706c 6174 6573 2866 7768 6d3d 6272 6f61  plates(fwhm=broa
+000192d0: 645f 6677 686d 2c20 6c69 6e65 5f63 6f6d  d_fwhm, line_com
+000192e0: 706c 6578 6573 3d46 616c 7365 2c20 7374  plexes=False, st
+000192f0: 6172 733d 4661 6c73 652c 2066 756c 6c5f  ars=False, full_
+00019300: 6c69 6e65 5f6c 6973 743d 5b27 4261 6c6d  line_list=['Balm
+00019310: 6572 2031 306b 4b27 5d20 2b20 6272 6f61  er 10kK'] + broa
+00019320: 645f 6c69 6e65 732c 2063 6f6e 7469 6e75  d_lines, continu
+00019330: 756d 5f6c 6973 743d 5b5d 2c20 6673 7073  um_list=[], fsps
+00019340: 5f74 656d 706c 6174 6573 3d46 616c 7365  _templates=False
+00019350: 2c20 616c 665f 7465 6d70 6c61 7465 3d46  , alf_template=F
+00019360: 616c 7365 2c20 6c6f 7265 6e74 7a3d 5472  alse, lorentz=Tr
+00019370: 7565 290a 0a20 2020 2020 2020 2069 6620  ue)..        if 
+00019380: 696e 636c 7564 655f 7265 6464 656e 6564  include_reddened
+00019390: 5f62 616c 6d65 725f 6c69 6e65 733a 0a20  _balmer_lines:. 
+000193a0: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+000193b0: 7761 7665 6c65 6e67 7468 732c 206c 696e  wavelengths, lin
+000193c0: 655f 7261 7469 6f73 203d 2067 6574 5f6c  e_ratios = get_l
+000193d0: 696e 655f 7761 7665 6c65 6e67 7468 7328  ine_wavelengths(
+000193e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000193f0: 2027 4261 6c6d 6572 2031 306b 4b20 2b20   'Balmer 10kK + 
+00019400: 4d67 4949 2041 763d 312e 3027 2069 6e20  MgII Av=1.0' in 
+00019410: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00019420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019430: 2020 6675 6c6c 5f6c 696e 655f 6c69 7374    full_line_list
+00019440: 202b 3d20 5b27 4261 6c6d 6572 2031 306b   += ['Balmer 10k
+00019450: 4b20 2b20 4d67 4949 275d 0a20 2020 2020  K + MgII'].     
+00019460: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+00019470: 6c69 6e65 5f6c 6973 7420 2b3d 205b 2742  line_list += ['B
+00019480: 616c 6d65 7220 3130 6b4b 202b 204d 6749  almer 10kK + MgI
+00019490: 4920 4176 3d31 2e30 275d 0a20 2020 2020  I Av=1.0'].     
+000194a0: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+000194b0: 6c69 6e65 5f6c 6973 7420 2b3d 205b 2742  line_list += ['B
+000194c0: 616c 6d65 7220 3130 6b4b 202b 204d 6749  almer 10kK + MgI
+000194d0: 4920 4176 3d32 2e30 275d 0a0a 2020 2020  I Av=2.0']..    
+000194e0: 2020 2020 6272 6f61 6430 203d 206c 6f61      broad0 = loa
+000194f0: 645f 7465 6d70 6c61 7465 7328 6677 686d  d_templates(fwhm
+00019500: 3d62 726f 6164 5f66 7768 6d2c 206c 696e  =broad_fwhm, lin
+00019510: 655f 636f 6d70 6c65 7865 733d 4661 6c73  e_complexes=Fals
+00019520: 652c 2073 7461 7273 3d46 616c 7365 2c20  e, stars=False, 
+00019530: 6675 6c6c 5f6c 696e 655f 6c69 7374 3d66  full_line_list=f
+00019540: 756c 6c5f 6c69 6e65 5f6c 6973 742c 2063  ull_line_list, c
+00019550: 6f6e 7469 6e75 756d 5f6c 6973 743d 5b5d  ontinuum_list=[]
+00019560: 2c20 6673 7073 5f74 656d 706c 6174 6573  , fsps_templates
+00019570: 3d46 616c 7365 2c20 616c 665f 7465 6d70  =False, alf_temp
+00019580: 6c61 7465 3d46 616c 7365 2c20 6c6f 7265  late=False, lore
+00019590: 6e74 7a3d 5472 7565 290a 0a20 2020 2020  ntz=True)..     
+000195a0: 2020 2066 6f72 206b 2069 6e20 6272 6f61     for k in broa
+000195b0: 6430 3a0a 2020 2020 2020 2020 2020 2020  d0:.            
+000195c0: 7430 5b6b 5d20 3d20 6272 6f61 6430 5b6b  t0[k] = broad0[k
+000195d0: 5d0a 0a20 2020 2066 6f72 206b 2069 6e20  ]..    for k in 
+000195e0: 6272 6f61 6431 3a0a 2020 2020 2020 2020  broad1:.        
+000195f0: 7431 5b6b 5d20 3d20 6272 6f61 6431 5b6b  t1[k] = broad1[k
+00019600: 5d0a 0a20 2020 2066 6f72 206b 2069 6e20  ]..    for k in 
+00019610: 6e61 7272 6f77 303a 0a20 2020 2020 2020  narrow0:.       
+00019620: 2074 305b 6b5d 203d 206e 6172 726f 7730   t0[k] = narrow0
+00019630: 5b6b 5d0a 0a20 2020 2066 6f72 206b 2069  [k]..    for k i
+00019640: 6e20 6e61 7272 6f77 313a 0a20 2020 2020  n narrow1:.     
+00019650: 2020 2074 315b 6b5d 203d 206e 6172 726f     t1[k] = narro
+00019660: 7731 5b6b 5d0a 0a20 2020 2023 2046 6520  w1[k]..    # Fe 
+00019670: 4949 0a20 2020 2069 6620 696e 636c 7564  II.    if includ
+00019680: 655f 6665 6969 3a0a 2020 2020 2020 2020  e_feii:.        
+00019690: 6665 6969 5f77 6176 652c 2066 6569 695f  feii_wave, feii_
+000196a0: 666c 7578 203d 206e 702e 6c6f 6164 7478  flux = np.loadtx
+000196b0: 7428 6f73 2e70 6174 682e 6469 726e 616d  t(os.path.dirnam
+000196c0: 6528 5f5f 6669 6c65 5f5f 2920 2b20 272f  e(__file__) + '/
+000196d0: 6461 7461 2f74 656d 706c 6174 6573 2f46  data/templates/F
+000196e0: 6549 495f 5665 726f 6e43 6574 7479 3230  eII_VeronCetty20
+000196f0: 3034 2e74 7874 272c 2075 6e70 6163 6b3d  04.txt', unpack=
+00019700: 5472 7565 290a 0a20 2020 2020 2020 2023  True)..        #
+00019710: 2073 6d6f 6f74 6869 6e67 2c20 696e 2075   smoothing, in u
+00019720: 6e69 7473 206f 6620 696e 7075 7420 7665  nits of input ve
+00019730: 6c6f 6369 7479 2072 6573 6f6c 7574 696f  locity resolutio
+00019740: 6e0a 2020 2020 2020 2020 6665 6969 5f6b  n.        feii_k
+00019750: 6572 6e20 3d20 6272 6f61 645f 6677 686d  ern = broad_fwhm
+00019760: 2f32 2e33 3534 382f 3735 2e0a 2020 2020  /2.3548/75..    
+00019770: 2020 2020 6665 6969 5f73 6d20 3d20 6e64      feii_sm = nd
+00019780: 2e67 6175 7373 6961 6e5f 6669 6c74 6572  .gaussian_filter
+00019790: 2866 6569 695f 666c 7578 2c20 6665 6969  (feii_flux, feii
+000197a0: 5f6b 6572 6e29 0a20 2020 2020 2020 2074  _kern).        t
+000197b0: 305b 2746 6549 492d 5643 3230 3034 275d  0['FeII-VC2004']
+000197c0: 203d 2074 315b 2746 6549 492d 5643 3230   = t1['FeII-VC20
+000197d0: 3034 275d 203d 2053 7065 6374 7275 6d54  04'] = SpectrumT
+000197e0: 656d 706c 6174 6528 7761 7665 3d66 6569  emplate(wave=fei
+000197f0: 695f 7761 7665 2c20 666c 7578 3d66 6569  i_wave, flux=fei
+00019800: 695f 736d 2c20 6e61 6d65 3d27 4665 4949  i_sm, name='FeII
+00019810: 2d56 4332 3030 3427 290a 0a20 2020 2023  -VC2004')..    #
+00019820: 204c 696e 6561 7220 636f 6e74 696e 7561   Linear continua
+00019830: 0a20 2020 2023 2063 6f6e 745f 7761 7665  .    # cont_wave
+00019840: 203d 206e 702e 6172 616e 6765 2834 3030   = np.arange(400
+00019850: 2c20 322e 3565 3429 0a20 2020 2023 2066  , 2.5e4).    # f
+00019860: 6f72 2073 6c6f 7065 2069 6e20 736c 6f70  or slope in slop
+00019870: 6573 3a0a 2020 2020 2320 2020 2020 6b65  es:.    #     ke
+00019880: 7920 3d20 2773 6c6f 7065 207b 307d 272e  y = 'slope {0}'.
+00019890: 666f 726d 6174 2873 6c6f 7065 290a 2020  format(slope).  
+000198a0: 2020 2320 2020 2020 7430 5b6b 6579 5d20    #     t0[key] 
+000198b0: 3d20 7431 5b6b 6579 5d20 3d20 5370 6563  = t1[key] = Spec
+000198c0: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+000198d0: 653d 636f 6e74 5f77 6176 652c 2066 6c75  e=cont_wave, flu
+000198e0: 783d 2863 6f6e 745f 7761 7665 2f36 3536  x=(cont_wave/656
+000198f0: 332e 292a 2a73 6c6f 7065 290a 0a20 2020  3.)**slope)..   
+00019900: 2069 6620 5273 706c 696e 6520 6973 206e   if Rspline is n
+00019910: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00019920: 2077 7370 6c69 6e65 203d 206e 702e 6172   wspline = np.ar
+00019930: 616e 6765 2834 3230 302c 2032 2e35 6534  ange(4200, 2.5e4
+00019940: 2c20 3130 290a 2020 2020 2020 2020 6466  , 10).        df
+00019950: 5f73 706c 203d 206c 6f67 5f7a 6772 6964  _spl = log_zgrid
+00019960: 287a 723d 5b77 7370 6c69 6e65 5b30 5d2c  (zr=[wspline[0],
+00019970: 2077 7370 6c69 6e65 5b2d 315d 5d2c 2064   wspline[-1]], d
+00019980: 7a3d 312e 2f52 7370 6c69 6e65 290a 2020  z=1./Rspline).  
 00019990: 2020 2020 2020 6273 706c 696e 6573 203d        bsplines =
 000199a0: 2062 7370 6c69 6e65 5f74 656d 706c 6174   bspline_templat
-000199b0: 6573 2863 6f6e 745f 7761 7665 2c20 6466  es(cont_wave, df
-000199c0: 3d6e 7370 6c69 6e65 2c20 6c6f 673d 5472  =nspline, log=Tr
-000199d0: 7565 290a 2020 2020 2020 2020 666f 7220  ue).        for 
-000199e0: 6b65 7920 696e 2062 7370 6c69 6e65 733a  key in bsplines:
-000199f0: 0a20 2020 2020 2020 2020 2020 2074 305b  .            t0[
-00019a00: 6b65 795d 203d 2074 315b 6b65 795d 203d  key] = t1[key] =
-00019a10: 2062 7370 6c69 6e65 735b 6b65 795d 0a0a   bsplines[key]..
-00019a20: 2020 2020 656c 6966 2062 6574 6173 2069      elif betas i
-00019a30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00019a40: 2020 2020 6274 656d 7020 3d20 6c6f 6164      btemp = load
-00019a50: 5f62 6574 615f 7465 6d70 6c61 7465 7328  _beta_templates(
-00019a60: 7761 7665 3d6e 702e 6172 616e 6765 2834  wave=np.arange(4
-00019a70: 3030 2c20 322e 3565 3429 2c20 6265 7461  00, 2.5e4), beta
-00019a80: 733d 6265 7461 7329 0a20 2020 2020 2020  s=betas).       
-00019a90: 2066 6f72 206b 6579 2069 6e20 6274 656d   for key in btem
-00019aa0: 703a 0a20 2020 2020 2020 2020 2020 2074  p:.            t
-00019ab0: 305b 6b65 795d 203d 2074 315b 6b65 795d  0[key] = t1[key]
-00019ac0: 203d 2062 7465 6d70 5b6b 6579 5d0a 0a20   = btemp[key].. 
-00019ad0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00019ae0: 2023 204f 6273 6572 7665 6420 6672 616d   # Observed fram
-00019af0: 6520 7374 6570 730a 2020 2020 2020 2020  e steps.        
-00019b00: 6f6e 6564 5220 3d20 2d6e 7370 6c69 6e65  onedR = -nspline
-00019b10: 0a20 2020 2020 2020 2077 6c69 6d20 3d20  .        wlim = 
-00019b20: 5b35 3030 302c 2031 3830 3030 2e30 5d0a  [5000, 18000.0].
-00019b30: 2020 2020 2020 2020 6269 6e5f 7374 6570          bin_step
-00019b40: 732c 2073 7465 705f 7465 6d70 6c20 3d20  s, step_templ = 
-00019b50: 7374 6570 5f74 656d 706c 6174 6573 2877  step_templates(w
-00019b60: 6c69 6d3d 776c 696d 2c20 523d 6f6e 6564  lim=wlim, R=oned
-00019b70: 522c 0a20 2020 2020 2020 2020 2020 2020  R,.             
-00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ba0: 2020 726f 756e 643d 3130 290a 2020 2020    round=10).    
-00019bb0: 2020 2020 666f 7220 6b65 7920 696e 2073      for key in s
-00019bc0: 7465 705f 7465 6d70 6c3a 0a20 2020 2020  tep_templ:.     
-00019bd0: 2020 2020 2020 2074 305b 6b65 795d 203d         t0[key] =
-00019be0: 2074 315b 6b65 795d 203d 2073 7465 705f   t1[key] = step_
-00019bf0: 7465 6d70 6c5b 6b65 795d 0a0a 2020 2020  templ[key]..    
-00019c00: 2320 7430 5b27 626c 7565 275d 203d 2074  # t0['blue'] = t
-00019c10: 315b 2762 6c75 6527 5d20 3d20 5370 6563  1['blue'] = Spec
-00019c20: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
-00019c30: 653d 636f 6e74 5f77 6176 652c 2066 6c75  e=cont_wave, flu
-00019c40: 783d 2863 6f6e 745f 7761 7665 2f36 3536  x=(cont_wave/656
-00019c50: 332e 292a 2a2d 322e 3829 0a20 2020 2023  3.)**-2.8).    #
-00019c60: 2074 305b 276d 6964 275d 203d 2074 315b   t0['mid'] = t1[
-00019c70: 276d 6964 275d 203d 2053 7065 6374 7275  'mid'] = Spectru
-00019c80: 6d54 656d 706c 6174 6528 7761 7665 3d63  mTemplate(wave=c
-00019c90: 6f6e 745f 7761 7665 2c20 666c 7578 3d28  ont_wave, flux=(
-00019ca0: 636f 6e74 5f77 6176 652f 3635 3633 2e29  cont_wave/6563.)
-00019cb0: 2a2a 3029 0a20 2020 2023 2074 305b 2772  **0).    # t0['r
-00019cc0: 6564 275d 203d 2074 315b 276d 6964 275d  ed'] = t1['mid']
-00019cd0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
-00019ce0: 6174 6528 7761 7665 3d63 6f6e 745f 7761  ate(wave=cont_wa
-00019cf0: 7665 2c20 666c 7578 3d28 636f 6e74 5f77  ve, flux=(cont_w
-00019d00: 6176 652f 3635 3633 2e29 2a2a 322e 3829  ave/6563.)**2.8)
-00019d10: 0a0a 2020 2020 7265 7475 726e 2074 302c  ..    return t0,
-00019d20: 2074 310a 0a0a 5048 4f45 4e49 585f 4c4f   t1...PHOENIX_LO
-00019d30: 4747 5f46 554c 4c20 3d20 5b33 2e30 2c20  GG_FULL = [3.0, 
-00019d40: 332e 352c 2034 2e30 2c20 342e 352c 2035  3.5, 4.0, 4.5, 5
-00019d50: 2e30 2c20 352e 355d 0a50 484f 454e 4958  .0, 5.5].PHOENIX
-00019d60: 5f4c 4f47 4720 3d20 5b34 2e30 2c20 342e  _LOGG = [4.0, 4.
-00019d70: 352c 2035 2e30 2c20 352e 355d 0a0a 5048  5, 5.0, 5.5]..PH
-00019d80: 4f45 4e49 585f 5445 4646 5f46 554c 4c20  OENIX_TEFF_FULL 
-00019d90: 3d20 5b34 3030 2e30 2c20 3432 302e 302c  = [400.0, 420.0,
-00019da0: 2034 3530 2e30 2c20 3530 302e 302c 2035   450.0, 500.0, 5
-00019db0: 3530 2e30 2c20 3630 302e 302c 2036 3530  50.0, 600.0, 650
-00019dc0: 2e30 2c20 3730 302e 302c 2037 3530 2e30  .0, 700.0, 750.0
-00019dd0: 2c20 3830 302e 302c 2038 3530 2e30 2c20  , 800.0, 850.0, 
-00019de0: 3930 302e 302c 2039 3530 2e30 2c20 3130  900.0, 950.0, 10
-00019df0: 3030 2e30 2c20 3130 3530 2e30 2c20 3131  00.0, 1050.0, 11
-00019e00: 3030 2e30 2c20 3131 3530 2e30 2c20 3132  00.0, 1150.0, 12
-00019e10: 3030 2e30 2c20 3132 3530 2e30 2c20 3133  00.0, 1250.0, 13
-00019e20: 3030 2e30 2c20 3133 3530 2e30 2c20 3134  00.0, 1350.0, 14
-00019e30: 3030 2e30 2c20 3134 3530 2e30 2c20 3135  00.0, 1450.0, 15
-00019e40: 3030 2e30 2c20 3135 3530 2e30 2c20 3136  00.0, 1550.0, 16
-00019e50: 3030 2e30 2c20 3136 3530 2e30 2c20 3137  00.0, 1650.0, 17
-00019e60: 3030 2e30 2c20 3137 3530 2e30 2c20 3138  00.0, 1750.0, 18
-00019e70: 3030 2e30 2c20 3138 3530 2e30 2c20 3139  00.0, 1850.0, 19
-00019e80: 3030 2e30 2c20 3139 3530 2e30 2c20 3230  00.0, 1950.0, 20
-00019e90: 3030 2e30 2c20 3231 3030 2e30 2c20 3232  00.0, 2100.0, 22
-00019ea0: 3030 2e30 2c20 3233 3030 2e30 2c20 3234  00.0, 2300.0, 24
-00019eb0: 3030 2e30 2c20 3235 3030 2e30 2c20 3236  00.0, 2500.0, 26
-00019ec0: 3030 2e30 2c20 3237 3030 2e30 2c20 3238  00.0, 2700.0, 28
-00019ed0: 3030 2e30 2c20 3239 3030 2e30 2c20 3330  00.0, 2900.0, 30
-00019ee0: 3030 2e30 2c20 3331 3030 2e30 2c20 3332  00.0, 3100.0, 32
-00019ef0: 3030 2e30 2c20 3333 3030 2e30 2c20 3334  00.0, 3300.0, 34
-00019f00: 3030 2e30 2c20 3335 3030 2e30 2c20 3336  00.0, 3500.0, 36
-00019f10: 3030 2e30 2c20 3337 3030 2e30 2c20 3338  00.0, 3700.0, 38
-00019f20: 3030 2e30 2c20 3339 3030 2e30 2c20 3430  00.0, 3900.0, 40
-00019f30: 3030 2e30 2c20 3431 3030 2e30 2c20 3432  00.0, 4100.0, 42
-00019f40: 3030 2e30 2c20 3433 3030 2e30 2c20 3434  00.0, 4300.0, 44
-00019f50: 3030 2e30 2c20 3435 3030 2e30 2c20 3436  00.0, 4500.0, 46
-00019f60: 3030 2e30 2c20 3437 3030 2e30 2c20 3438  00.0, 4700.0, 48
-00019f70: 3030 2e30 2c20 3439 3030 2e30 2c20 3530  00.0, 4900.0, 50
-00019f80: 3030 2e30 5d0a 0a50 484f 454e 4958 5f54  00.0]..PHOENIX_T
-00019f90: 4546 4620 3d20 5b34 3030 2e2c 2020 3432  EFF = [400.,  42
-00019fa0: 302e 2c20 3435 302e 2c20 3530 302e 2c20  0., 450., 500., 
-00019fb0: 2035 3530 2e2c 2036 3030 2e2c 2020 3635   550., 600.,  65
-00019fc0: 302e 2c20 3730 302e 2c20 2037 3530 2e2c  0., 700.,  750.,
-00019fd0: 0a20 2020 2020 2020 3830 302e 2c20 2038  .       800.,  8
-00019fe0: 3530 2e2c 2039 3030 2e2c 2039 3530 2e2c  50., 900., 950.,
-00019ff0: 2031 3030 302e 2c20 3130 3530 2e2c 2031   1000., 1050., 1
-0001a000: 3130 302e 2c20 3131 3530 2e2c 2031 3230  100., 1150., 120
-0001a010: 302e 2c0a 2020 2020 2020 2031 3330 302e  0.,.       1300.
-0001a020: 2c20 3134 3030 2e2c 2031 3530 302e 2c20  , 1400., 1500., 
-0001a030: 3136 3030 2e2c 2031 3730 302e 2c20 3138  1600., 1700., 18
-0001a040: 3030 2e2c 2031 3930 302e 2c20 3230 3030  00., 1900., 2000
-0001a050: 2e2c 2032 3130 302e 2c0a 2020 2020 2020  ., 2100.,.      
-0001a060: 2032 3230 302e 2c20 3233 3030 2e2c 2032   2200., 2300., 2
-0001a070: 3430 302e 2c20 3235 3030 2e2c 2032 3630  400., 2500., 260
-0001a080: 302e 2c20 3237 3030 2e2c 2032 3830 302e  0., 2700., 2800.
-0001a090: 2c20 3239 3030 2e2c 2033 3030 302e 2c0a  , 2900., 3000.,.
-0001a0a0: 2020 2020 2020 2033 3130 302e 2c20 3332         3100., 32
-0001a0b0: 3030 2e2c 2033 3330 302e 2c20 3334 3030  00., 3300., 3400
-0001a0c0: 2e2c 2033 3530 302e 2c20 3336 3030 2e2c  ., 3500., 3600.,
-0001a0d0: 2033 3730 302e 2c20 3338 3030 2e2c 2033   3700., 3800., 3
-0001a0e0: 3930 302e 2c20 3430 3030 2e2c 0a20 2020  900., 4000.,.   
-0001a0f0: 2020 2020 3432 3030 2e2c 2034 3430 302e      4200., 4400.
-0001a100: 2c20 3436 3030 2e2c 2034 3830 302e 2c20  , 4600., 4800., 
-0001a110: 3530 3030 2e2c 2035 3530 302e 2c20 3535  5000., 5500., 55
-0001a120: 3030 2c20 3630 3030 2e2c 2036 3530 302e  00, 6000., 6500.
-0001a130: 2c20 3730 3030 2e5d 0a0a 5048 4f45 4e49  , 7000.]..PHOENI
-0001a140: 585f 5a4d 4554 5f46 554c 4c20 3d20 5b2d  X_ZMET_FULL = [-
-0001a150: 322e 352c 202d 322e 302c 202d 312e 352c  2.5, -2.0, -1.5,
-0001a160: 202d 312e 302c 202d 302e 352c 202d 302e   -1.0, -0.5, -0.
-0001a170: 2c20 302e 355d 0a50 484f 454e 4958 5f5a  , 0.5].PHOENIX_Z
-0001a180: 4d45 5420 3d20 5b2d 312e 302c 202d 302e  MET = [-1.0, -0.
-0001a190: 352c 202d 302e 5d0a 0a0a 6465 6620 6c6f  5, -0.]...def lo
-0001a1a0: 6164 5f70 686f 656e 6978 5f73 7461 7273  ad_phoenix_stars
-0001a1b0: 286c 6f67 675f 6c69 7374 3d50 484f 454e  (logg_list=PHOEN
-0001a1c0: 4958 5f4c 4f47 472c 2074 6566 665f 6c69  IX_LOGG, teff_li
-0001a1d0: 7374 3d50 484f 454e 4958 5f54 4546 462c  st=PHOENIX_TEFF,
-0001a1e0: 207a 6d65 745f 6c69 7374 3d50 484f 454e   zmet_list=PHOEN
-0001a1f0: 4958 5f5a 4d45 542c 2061 6464 5f63 6172  IX_ZMET, add_car
-0001a200: 626f 6e5f 7374 6172 3d54 7275 652c 2066  bon_star=True, f
-0001a210: 696c 653d 2762 742d 7365 7474 6c5f 7434  ile='bt-settl_t4
-0001a220: 3030 2d37 3030 305f 6734 2e35 2e66 6974  00-7000_g4.5.fit
-0001a230: 7327 293a 0a20 2020 2022 2222 0a20 2020  s'):.    """.   
-0001a240: 204c 6f61 6420 5068 6f65 6e69 7820 7374   Load Phoenix st
-0001a250: 656c 6c61 7220 7465 6d70 6c61 7465 730a  ellar templates.
-0001a260: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
-0001a270: 2063 6f6c 6c65 6374 696f 6e73 2069 6d70   collections imp
-0001a280: 6f72 7420 4f72 6465 7265 6444 6963 740a  ort OrderedDict.
-0001a290: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001a2a0: 2066 726f 6d20 7572 6c6c 6962 2e72 6571   from urllib.req
-0001a2b0: 7565 7374 2069 6d70 6f72 7420 7572 6c72  uest import urlr
-0001a2c0: 6574 7269 6576 650a 2020 2020 6578 6365  etrieve.    exce
-0001a2d0: 7074 3a0a 2020 2020 2020 2020 6672 6f6d  pt:.        from
-0001a2e0: 2075 726c 6c69 6220 696d 706f 7274 2075   urllib import u
-0001a2f0: 726c 7265 7472 6965 7665 0a0a 2020 2020  rlretrieve..    
-0001a300: 2320 6669 6c65 3d27 6274 2d73 6574 746c  # file='bt-settl
-0001a310: 5f74 3430 302d 3530 3030 5f67 342e 352e  _t400-5000_g4.5.
-0001a320: 6669 7473 270a 2020 2020 2320 6669 6c65  fits'.    # file
-0001a330: 3d27 6274 2d73 6574 746c 5f74 3430 302d  ='bt-settl_t400-
-0001a340: 3335 3030 5f7a 302e 302e 6669 7473 270a  3500_z0.0.fits'.
-0001a350: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-0001a360: 2020 6864 7520 3d20 7079 6669 7473 2e6f    hdu = pyfits.o
-0001a370: 7065 6e28 6f73 2e70 6174 682e 6a6f 696e  pen(os.path.join
-0001a380: 2847 5249 5a4c 495f 5041 5448 2c20 2774  (GRIZLI_PATH, 't
-0001a390: 656d 706c 6174 6573 2f73 7461 7273 2f27  emplates/stars/'
-0001a3a0: 2c20 6669 6c65 2929 0a20 2020 2065 7863  , file)).    exc
-0001a3b0: 6570 743a 0a20 2020 2020 2020 2023 7572  ept:.        #ur
-0001a3c0: 6c20 3d20 2768 7474 7073 3a2f 2f73 332e  l = 'https://s3.
-0001a3d0: 616d 617a 6f6e 6177 732e 636f 6d2f 6772  amazonaws.com/gr
-0001a3e0: 697a 6c69 2f43 4f4e 4627 0a20 2020 2020  izli/CONF'.     
-0001a3f0: 2020 2023 7572 6c20 3d20 2768 7474 7073     #url = 'https
-0001a400: 3a2f 2f65 7264 612e 6b75 2e64 6b2f 7667  ://erda.ku.dk/vg
-0001a410: 7269 642f 4761 6272 6965 6c25 3230 4272  rid/Gabriel%20Br
-0001a420: 616d 6d65 722f 434f 4e46 270a 2020 2020  ammer/CONF'.    
-0001a430: 2020 2020 7572 6c20 3d20 2827 6874 7470      url = ('http
-0001a440: 733a 2f2f 7261 772e 6769 7468 7562 7573  s://raw.githubus
-0001a450: 6572 636f 6e74 656e 742e 636f 6d2f 6762  ercontent.com/gb
-0001a460: 7261 6d6d 6572 2f27 202b 0a20 2020 2020  rammer/' +.     
-0001a470: 2020 2020 2020 2020 2020 2767 7269 7a6c            'grizl
-0001a480: 692d 636f 6e66 6967 2f6d 6173 7465 7227  i-config/master'
-0001a490: 290a 0a20 2020 2020 2020 2070 7269 6e74  )..        print
-0001a4a0: 2827 4665 7463 6820 7b30 7d2f 7b31 7d27  ('Fetch {0}/{1}'
-0001a4b0: 2e66 6f72 6d61 7428 7572 6c2c 2066 696c  .format(url, fil
-0001a4c0: 6529 290a 0a20 2020 2020 2020 2023 6f73  e))..        #os
-0001a4d0: 2e73 7973 7465 6d28 2777 6765 7420 2d4f  .system('wget -O
-0001a4e0: 202f 746d 702f 7b31 7d20 7b30 7d2f 7b31   /tmp/{1} {0}/{1
-0001a4f0: 7d27 2e66 6f72 6d61 7428 7572 6c2c 2066  }'.format(url, f
-0001a500: 696c 6529 290a 2020 2020 2020 2020 7265  ile)).        re
-0001a510: 7320 3d20 7572 6c72 6574 7269 6576 6528  s = urlretrieve(
-0001a520: 277b 307d 2f7b 317d 272e 666f 726d 6174  '{0}/{1}'.format
-0001a530: 2875 726c 2c20 6669 6c65 292c 0a20 2020  (url, file),.   
-0001a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a550: 2020 2020 2020 2066 696c 656e 616d 653d         filename=
-0001a560: 6f73 2e70 6174 682e 6a6f 696e 2827 2f74  os.path.join('/t
-0001a570: 6d70 272c 2066 696c 6529 290a 0a20 2020  mp', file))..   
-0001a580: 2020 2020 2068 6475 203d 2070 7966 6974       hdu = pyfit
-0001a590: 732e 6f70 656e 286f 732e 7061 7468 2e6a  s.open(os.path.j
-0001a5a0: 6f69 6e28 272f 746d 702f 272c 2066 696c  oin('/tmp/', fil
-0001a5b0: 6529 290a 0a20 2020 2074 6162 203d 2047  e))..    tab = G
-0001a5c0: 5461 626c 652e 6772 6561 6428 6864 755b  Table.gread(hdu[
-0001a5d0: 315d 290a 2020 2020 6864 752e 636c 6f73  1]).    hdu.clos
-0001a5e0: 6528 290a 2020 2020 0a20 2020 2074 7374  e().    .    tst
-0001a5f0: 6172 7320 3d20 4f72 6465 7265 6444 6963  ars = OrderedDic
-0001a600: 7428 290a 2020 2020 4e20 3d20 7461 625b  t().    N = tab[
-0001a610: 2766 6c75 7827 5d2e 7368 6170 655b 315d  'flux'].shape[1]
-0001a620: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-0001a630: 6e67 6528 4e29 3a0a 2020 2020 2020 2020  nge(N):.        
-0001a640: 7465 6666 203d 2074 6162 2e6d 6574 615b  teff = tab.meta[
-0001a650: 2754 4546 467b 303a 3033 647d 272e 666f  'TEFF{0:03d}'.fo
-0001a660: 726d 6174 2869 295d 0a20 2020 2020 2020  rmat(i)].       
-0001a670: 206c 6f67 6720 3d20 7461 622e 6d65 7461   logg = tab.meta
-0001a680: 5b27 4c4f 4747 7b30 3a30 3364 7d27 2e66  ['LOGG{0:03d}'.f
-0001a690: 6f72 6d61 7428 6929 5d0a 2020 2020 2020  ormat(i)].      
-0001a6a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0001a6b0: 2020 206d 6574 203d 2074 6162 2e6d 6574     met = tab.met
-0001a6c0: 615b 275a 4d45 547b 303a 3033 647d 272e  a['ZMET{0:03d}'.
-0001a6d0: 666f 726d 6174 2869 295d 0a20 2020 2020  format(i)].     
-0001a6e0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0001a6f0: 2020 2020 2020 206d 6574 203d 2030 2e0a         met = 0..
-0001a700: 0a20 2020 2020 2020 2069 6620 286c 6f67  .        if (log
-0001a710: 6720 6e6f 7420 696e 206c 6f67 675f 6c69  g not in logg_li
-0001a720: 7374 2920 7c20 2874 6566 6620 6e6f 7420  st) | (teff not 
-0001a730: 696e 2074 6566 665f 6c69 7374 2920 7c20  in teff_list) | 
-0001a740: 286d 6574 206e 6f74 2069 6e20 7a6d 6574  (met not in zmet
-0001a750: 5f6c 6973 7429 3a0a 2020 2020 2020 2020  _list):.        
-0001a760: 2020 2020 2370 7269 6e74 2827 536b 6970      #print('Skip
-0001a770: 207b 307d 207b 317d 272e 666f 726d 6174   {0} {1}'.format
-0001a780: 286c 6f67 672c 2074 6566 6629 290a 2020  (logg, teff)).  
-0001a790: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0001a7a0: 7565 0a0a 2020 2020 2020 2020 6c61 6265  ue..        labe
-0001a7b0: 6c20 3d20 2762 742d 7365 7474 6c5f 747b  l = 'bt-settl_t{
-0001a7c0: 303a 3035 2e30 667d 5f67 7b31 3a33 2e31  0:05.0f}_g{1:3.1
-0001a7d0: 667d 5f6d 7b32 3a2e 3166 7d27 2e66 6f72  f}_m{2:.1f}'.for
-0001a7e0: 6d61 7428 7465 6666 2c20 6c6f 6767 2c20  mat(teff, logg, 
-0001a7f0: 6d65 7429 0a0a 2020 2020 2020 2020 7473  met)..        ts
-0001a800: 7461 7273 5b6c 6162 656c 5d20 3d20 5370  tars[label] = Sp
-0001a810: 6563 7472 756d 5465 6d70 6c61 7465 2877  ectrumTemplate(w
-0001a820: 6176 653d 7461 625b 2777 6176 6527 5d2c  ave=tab['wave'],
-0001a830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a850: 2020 2020 2020 2020 2020 666c 7578 3d74            flux=t
-0001a860: 6162 5b27 666c 7578 275d 5b3a 2c20 695d  ab['flux'][:, i]
-0001a870: 2c20 6e61 6d65 3d6c 6162 656c 290a 0a20  , name=label).. 
-0001a880: 2020 2069 6620 6164 645f 6361 7262 6f6e     if add_carbon
-0001a890: 5f73 7461 723a 0a20 2020 2020 2020 2063  _star:.        c
-0001a8a0: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
-0001a8b0: 6f69 6e28 4752 495a 4c49 5f50 4154 482c  oin(GRIZLI_PATH,
-0001a8c0: 2027 7465 6d70 6c61 7465 732f 7374 6172   'templates/star
-0001a8d0: 732f 6361 7262 6f6e 5f73 7461 722e 7478  s/carbon_star.tx
-0001a8e0: 7427 290a 2020 2020 2020 2020 7370 203d  t').        sp =
-0001a8f0: 2072 6561 645f 6361 7461 6c6f 6728 6366   read_catalog(cf
-0001a900: 696c 6529 0a20 2020 2020 2020 2069 6620  ile).        if 
-0001a910: 6164 645f 6361 7262 6f6e 5f73 7461 7220  add_carbon_star 
-0001a920: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0001a930: 2069 6d70 6f72 7420 7363 6970 792e 6e64   import scipy.nd
-0001a940: 696d 6167 6520 6173 206e 640a 2020 2020  image as nd.    
-0001a950: 2020 2020 2020 2020 6366 6c75 7820 3d20          cflux = 
-0001a960: 6e64 2e67 6175 7373 6961 6e5f 6669 6c74  nd.gaussian_filt
-0001a970: 6572 2873 705b 2766 6c75 7827 5d2c 2061  er(sp['flux'], a
-0001a980: 6464 5f63 6172 626f 6e5f 7374 6172 290a  dd_carbon_star).
-0001a990: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a9a0: 2020 2020 2020 2020 2020 6366 6c75 7820            cflux 
-0001a9b0: 3d20 7370 5b27 666c 7578 275d 0a0a 2020  = sp['flux']..  
-0001a9c0: 2020 2020 2020 7473 7461 7273 5b27 6274        tstars['bt
-0001a9d0: 2d73 6574 746c 5f74 3035 3030 305f 6730  -settl_t05000_g0
-0001a9e0: 2e30 5f6d 302e 3027 5d20 3d20 5370 6563  .0_m0.0'] = Spec
-0001a9f0: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
-0001aa00: 653d 7370 5b27 7761 7665 275d 2c20 666c  e=sp['wave'], fl
-0001aa10: 7578 3d63 666c 7578 2c20 6e61 6d65 3d27  ux=cflux, name='
-0001aa20: 6361 7262 6f6e 2d6c 616e 636f 6e32 3030  carbon-lancon200
-0001aa30: 3227 290a 0a20 2020 2072 6574 7572 6e20  2')..    return 
-0001aa40: 7473 7461 7273 0a0a 0a64 6566 206c 6f61  tstars...def loa
-0001aa50: 645f 7364 7373 5f70 6361 5f74 656d 706c  d_sdss_pca_templ
-0001aa60: 6174 6573 2866 696c 653d 2773 7045 6967  ates(file='spEig
-0001aa70: 656e 5153 4f2d 3535 3733 322e 6669 7473  enQSO-55732.fits
-0001aa80: 272c 2073 6d6f 6f74 683d 3330 3030 293a  ', smooth=3000):
-0001aa90: 0a20 2020 2022 2222 0a20 2020 204c 6f61  .    """.    Loa
-0001aaa0: 6420 5344 5353 2065 6967 656e 2074 656d  d SDSS eigen tem
-0001aab0: 706c 6174 6573 0a20 2020 2022 2222 0a20  plates.    """. 
-0001aac0: 2020 2066 726f 6d20 636f 6c6c 6563 7469     from collecti
-0001aad0: 6f6e 7320 696d 706f 7274 204f 7264 6572  ons import Order
-0001aae0: 6564 4469 6374 0a20 2020 2069 6d70 6f72  edDict.    impor
-0001aaf0: 7420 7363 6970 792e 6e64 696d 6167 6520  t scipy.ndimage 
-0001ab00: 6173 206e 640a 0a20 2020 2069 6d20 3d20  as nd..    im = 
-0001ab10: 7079 6669 7473 2e6f 7065 6e28 6f73 2e70  pyfits.open(os.p
-0001ab20: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
-0001ab30: 5041 5448 2c20 2774 656d 706c 6174 6573  PATH, 'templates
-0001ab40: 272c 2066 696c 6529 290a 2020 2020 6820  ', file)).    h 
-0001ab50: 3d20 696d 5b30 5d2e 6865 6164 6572 0a20  = im[0].header. 
-0001ab60: 2020 206c 6f67 5f77 6176 6520 3d20 6e70     log_wave = np
-0001ab70: 2e61 7261 6e67 6528 685b 274e 4158 4953  .arange(h['NAXIS
-0001ab80: 3127 5d29 2a68 5b27 434f 4546 4631 275d  1'])*h['COEFF1']
-0001ab90: 2b68 5b27 434f 4546 4630 275d 0a20 2020  +h['COEFF0'].   
-0001aba0: 2077 6176 6520 3d20 3130 2a2a 6c6f 675f   wave = 10**log_
-0001abb0: 7761 7665 0a0a 2020 2020 6e61 6d65 203d  wave..    name =
-0001abc0: 2066 696c 652e 7370 6c69 7428 272e 6669   file.split('.fi
-0001abd0: 7473 2729 5b30 5d0a 0a20 2020 2069 6620  ts')[0]..    if 
-0001abe0: 736d 6f6f 7468 203e 2030 3a0a 2020 2020  smooth > 0:.    
-0001abf0: 2020 2020 6476 5f69 6e20 3d20 685b 2743      dv_in = h['C
-0001ac00: 4f45 4646 3127 5d2a 332e 6535 0a20 2020  OEFF1']*3.e5.   
-0001ac10: 2020 2020 206e 203d 2073 6d6f 6f74 6820       n = smooth 
-0001ac20: 2f20 6476 5f69 6e0a 2020 2020 2020 2020  / dv_in.        
-0001ac30: 6461 7461 203d 206e 642e 6761 7573 7369  data = nd.gaussi
-0001ac40: 616e 5f66 696c 7465 7231 6428 696d 5b30  an_filter1d(im[0
-0001ac50: 5d2e 6461 7461 2c20 6e2c 2061 7869 733d  ].data, n, axis=
-0001ac60: 3129 2e61 7374 7970 6528 6e70 2e66 6c6f  1).astype(np.flo
-0001ac70: 6174 3634 290a 2020 2020 2020 2020 736b  at64).        sk
-0001ac80: 6970 203d 2069 6e74 286e 2f32 2e35 290a  ip = int(n/2.5).
-0001ac90: 2020 2020 2020 2020 7761 7665 203d 2077          wave = w
-0001aca0: 6176 655b 3a3a 736b 6970 5d0a 2020 2020  ave[::skip].    
-0001acb0: 2020 2020 6461 7461 203d 2064 6174 615b      data = data[
-0001acc0: 3a2c 203a 3a73 6b69 705d 0a20 2020 2065  :, ::skip].    e
-0001acd0: 6c73 653a 0a20 2020 2020 2020 2064 6174  lse:.        dat
-0001ace0: 6120 3d20 696d 5b30 5d2e 6461 7461 2e61  a = im[0].data.a
-0001acf0: 7374 7970 6528 6e70 2e66 6c6f 6174 3634  stype(np.float64
-0001ad00: 290a 0a20 2020 204e 203d 2068 5b27 4e41  )..    N = h['NA
-0001ad10: 5849 5332 275d 0a20 2020 2074 656d 705f  XIS2'].    temp_
-0001ad20: 6c69 7374 203d 204f 7264 6572 6564 4469  list = OrderedDi
-0001ad30: 6374 2829 0a20 2020 2066 6f72 2069 2069  ct().    for i i
-0001ad40: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
-0001ad50: 2020 2020 7465 6d70 5f6c 6973 745b 277b      temp_list['{
-0001ad60: 307d 207b 317d 272e 666f 726d 6174 286e  0} {1}'.format(n
-0001ad70: 616d 652c 2069 2b31 295d 203d 2053 7065  ame, i+1)] = Spe
-0001ad80: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
-0001ad90: 7665 3d77 6176 652c 2066 6c75 783d 6461  ve=wave, flux=da
-0001ada0: 7461 5b69 2c20 3a5d 290a 2020 2020 0a20  ta[i, :]).    . 
-0001adb0: 2020 2069 6d2e 636c 6f73 6528 290a 2020     im.close().  
-0001adc0: 2020 0a20 2020 2072 6574 7572 6e20 7465    .    return te
-0001add0: 6d70 5f6c 6973 740a 0a0a 6465 6620 6368  mp_list...def ch
-0001ade0: 6562 5f74 656d 706c 6174 6573 2877 6176  eb_templates(wav
-0001adf0: 652c 206f 7264 6572 3d36 2c20 6765 745f  e, order=6, get_
-0001ae00: 6d61 7472 6978 3d46 616c 7365 2c20 6c6f  matrix=False, lo
-0001ae10: 673d 4661 6c73 652c 2063 6c69 703d 312e  g=False, clip=1.
-0001ae20: 652d 342c 206d 696e 6d61 783d 4e6f 6e65  e-4, minmax=None
-0001ae30: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-0001ae40: 6865 6279 7368 6576 2070 6f6c 796e 6f6d  hebyshev polynom
-0001ae50: 6961 6c20 6261 7369 7320 6675 6e63 7469  ial basis functi
-0001ae60: 6f6e 730a 2020 2020 2222 220a 2020 2020  ons.    """.    
-0001ae70: 6672 6f6d 206e 756d 7079 2e70 6f6c 796e  from numpy.polyn
-0001ae80: 6f6d 6961 6c2e 6368 6562 7973 6865 7620  omial.chebyshev 
-0001ae90: 696d 706f 7274 2063 6865 6276 616c 2c20  import chebval, 
-0001aea0: 6368 6562 7661 6e64 6572 0a0a 2020 2020  chebvander..    
-0001aeb0: 6966 206d 696e 6d61 7820 6973 204e 6f6e  if minmax is Non
-0001aec0: 653a 0a20 2020 2020 2020 206d 6920 3d20  e:.        mi = 
-0001aed0: 7761 7665 2e6d 696e 2829 0a20 2020 2020  wave.min().     
-0001aee0: 2020 206d 6120 3d20 7761 7665 2e6d 6178     ma = wave.max
-0001aef0: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
-0001af00: 2020 2020 206d 692c 206d 6120 3d20 6e70       mi, ma = np
-0001af10: 2e73 7175 6565 7a65 286d 696e 6d61 7829  .squeeze(minmax)
-0001af20: 2a31 2e0a 0a20 2020 2069 6620 6c6f 673a  *1...    if log:
-0001af30: 0a20 2020 2020 2020 2078 6920 3d20 6e70  .        xi = np
-0001af40: 2e6c 6f67 2877 6176 6529 0a20 2020 2020  .log(wave).     
-0001af50: 2020 206d 6920 3d20 6e70 2e6c 6f67 286d     mi = np.log(m
-0001af60: 6929 0a20 2020 2020 2020 206d 6120 3d20  i).        ma = 
-0001af70: 6e70 2e6c 6f67 286d 6129 0a20 2020 2065  np.log(ma).    e
-0001af80: 6c73 653a 0a20 2020 2020 2020 2078 6920  lse:.        xi 
-0001af90: 3d20 7761 7665 2a31 0a20 2020 200a 2020  = wave*1.    .  
-0001afa0: 2020 7820 3d20 2878 692d 6d69 292a 322f    x = (xi-mi)*2/
-0001afb0: 286d 612d 6d69 292d 310a 0a20 2020 206e  (ma-mi)-1..    n
-0001afc0: 5f62 6173 6573 203d 206f 7264 6572 2b31  _bases = order+1
-0001afd0: 0a20 2020 200a 2020 2020 6261 7369 7320  .    .    basis 
-0001afe0: 3d20 6368 6562 7661 6e64 6572 2878 2c20  = chebvander(x, 
-0001aff0: 6f72 6465 7229 0a20 2020 2023 2062 6173  order).    # bas
-0001b000: 6973 203d 206e 702e 656d 7074 7928 2878  is = np.empty((x
-0001b010: 2e73 6861 7065 5b30 5d2c 206e 5f62 6173  .shape[0], n_bas
-0001b020: 6573 292c 2064 7479 7065 3d66 6c6f 6174  es), dtype=float
-0001b030: 290a 2020 2020 2320 0a20 2020 2023 2078  ).    # .    # x
-0001b040: 7220 3d20 6e70 2e61 7261 6e67 6528 6e5f  r = np.arange(n_
-0001b050: 6261 7365 7329 0a20 2020 2023 2066 6f72  bases).    # for
-0001b060: 2069 2069 6e20 7261 6e67 6528 6e5f 6261   i in range(n_ba
-0001b070: 7365 7329 3a0a 2020 2020 2320 2020 2020  ses):.    #     
-0001b080: 5f63 203d 2028 7872 203d 3d20 6929 2a31  _c = (xr == i)*1
-0001b090: 0a20 2020 2023 2020 2020 2023 7072 696e  .    #     #prin
-0001b0a0: 7428 5f63 2c20 7872 2c20 6929 0a20 2020  t(_c, xr, i).   
-0001b0b0: 2023 2020 2020 2062 6173 6973 5b3a 2c69   #     basis[:,i
-0001b0c0: 5d20 3d20 6368 6562 7661 6c28 782c 205f  ] = chebval(x, _
-0001b0d0: 6329 0a20 2020 2020 2020 200a 2020 2020  c).        .    
-0001b0e0: 2366 6f72 2069 2069 6e20 7261 6e67 6528  #for i in range(
-0001b0f0: 6e5f 6261 7365 7329 3a0a 2020 2020 6f75  n_bases):.    ou
-0001b100: 745f 6f66 5f72 616e 6765 203d 2028 7869  t_of_range = (xi
-0001b110: 203c 206d 6929 207c 2028 7869 203e 206d   < mi) | (xi > m
-0001b120: 6129 0a20 2020 2062 6173 6973 5b6f 7574  a).    basis[out
-0001b130: 5f6f 665f 7261 6e67 652c 3a5d 203d 2030  _of_range,:] = 0
-0001b140: 0a0a 2020 2020 6966 2067 6574 5f6d 6174  ..    if get_mat
-0001b150: 7269 783a 0a20 2020 2020 2020 2072 6574  rix:.        ret
-0001b160: 7572 6e20 6261 7369 730a 0a20 2020 2074  urn basis..    t
-0001b170: 656d 7020 3d20 4f72 6465 7265 6444 6963  emp = OrderedDic
-0001b180: 7428 290a 2020 2020 666f 7220 6920 696e  t().    for i in
-0001b190: 2072 616e 6765 286e 5f62 6173 6573 293a   range(n_bases):
-0001b1a0: 0a20 2020 2020 2020 206b 6579 203d 2066  .        key = f
-0001b1b0: 2763 6865 6220 6f7b 697d 270a 2020 2020  'cheb o{i}'.    
-0001b1c0: 2020 2020 7465 6d70 5b6b 6579 5d20 3d20      temp[key] = 
-0001b1d0: 5370 6563 7472 756d 5465 6d70 6c61 7465  SpectrumTemplate
-0001b1e0: 2877 6176 652c 2062 6173 6973 5b3a 2c69  (wave, basis[:,i
-0001b1f0: 5d29 0a20 2020 2020 2020 2074 656d 705b  ]).        temp[
-0001b200: 6b65 795d 2e6e 616d 6520 3d20 6b65 790a  key].name = key.
-0001b210: 0a20 2020 2072 6574 7572 6e20 7465 6d70  .    return temp
-0001b220: 0a20 2020 200a 6465 6620 6273 706c 696e  .    .def bsplin
-0001b230: 655f 7465 6d70 6c61 7465 7328 7761 7665  e_templates(wave
-0001b240: 2c20 6465 6772 6565 3d33 2c20 6466 3d36  , degree=3, df=6
-0001b250: 2c20 6765 745f 6d61 7472 6978 3d46 616c  , get_matrix=Fal
-0001b260: 7365 2c20 6c6f 673d 4661 6c73 652c 2063  se, log=False, c
-0001b270: 6c69 703d 312e 652d 342c 206d 696e 6d61  lip=1.e-4, minma
-0001b280: 783d 4e6f 6e65 293a 0a20 2020 2022 2222  x=None):.    """
-0001b290: 0a20 2020 2042 2d73 706c 696e 6520 6261  .    B-spline ba
-0001b2a0: 7369 7320 6675 6e63 7469 6f6e 732c 206d  sis functions, m
-0001b2b0: 6f64 656c 6564 2061 6674 6572 2060 7e70  odeled after `~p
-0001b2c0: 6174 7379 2e73 706c 696e 6573 600a 2020  atsy.splines`.  
-0001b2d0: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
-0001b2e0: 6369 7079 2e69 6e74 6572 706f 6c61 7465  cipy.interpolate
-0001b2f0: 2069 6d70 6f72 7420 7370 6c65 760a 0a20   import splev.. 
-0001b300: 2020 206f 7264 6572 203d 2064 6567 7265     order = degre
-0001b310: 652b 310a 2020 2020 6e5f 696e 6e65 725f  e+1.    n_inner_
-0001b320: 6b6e 6f74 7320 3d20 6466 202d 206f 7264  knots = df - ord
-0001b330: 6572 0a20 2020 2069 6e6e 6572 5f6b 6e6f  er.    inner_kno
-0001b340: 7473 203d 206e 702e 6c69 6e73 7061 6365  ts = np.linspace
-0001b350: 2830 2c20 312c 206e 5f69 6e6e 6572 5f6b  (0, 1, n_inner_k
-0001b360: 6e6f 7473 202b 2032 295b 313a 2d31 5d0a  nots + 2)[1:-1].
-0001b370: 0a20 2020 206e 6f72 6d5f 6b6e 6f74 7320  .    norm_knots 
-0001b380: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-0001b390: 2828 5b30 2c20 315d 202a 206f 7264 6572  (([0, 1] * order
-0001b3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3c0: 2020 696e 6e65 725f 6b6e 6f74 7329 290a    inner_knots)).
-0001b3d0: 2020 2020 6e6f 726d 5f6b 6e6f 7473 2e73      norm_knots.s
-0001b3e0: 6f72 7428 290a 0a20 2020 2069 6620 6c6f  ort()..    if lo
-0001b3f0: 673a 0a20 2020 2020 2020 2078 7370 6c20  g:.        xspl 
-0001b400: 3d20 6e70 2e6c 6f67 2877 6176 6529 0a20  = np.log(wave). 
-0001b410: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001b420: 2078 7370 6c20 3d20 7761 7665 2a31 0a0a   xspl = wave*1..
-0001b430: 2020 2020 6966 206d 696e 6d61 7820 6973      if minmax is
-0001b440: 204e 6f6e 653a 0a20 2020 2020 2020 206d   None:.        m
-0001b450: 6920 3d20 7873 706c 2e6d 696e 2829 0a20  i = xspl.min(). 
-0001b460: 2020 2020 2020 206d 6120 3d20 7873 706c         ma = xspl
-0001b470: 2e6d 6178 2829 0a20 2020 2065 6c73 653a  .max().    else:
-0001b480: 0a20 2020 2020 2020 206d 692c 206d 6120  .        mi, ma 
-0001b490: 3d20 6d69 6e6d 6178 0a0a 2020 2020 7769  = minmax..    wi
-0001b4a0: 6474 6820 3d20 6d61 2d6d 690a 2020 2020  dth = ma-mi.    
-0001b4b0: 616c 6c5f 6b6e 6f74 7320 3d20 6e6f 726d  all_knots = norm
-0001b4c0: 5f6b 6e6f 7473 2a77 6964 7468 2b6d 690a  _knots*width+mi.
-0001b4d0: 0a20 2020 206e 5f62 6173 6573 203d 206c  .    n_bases = l
-0001b4e0: 656e 2861 6c6c 5f6b 6e6f 7473 2920 2d20  en(all_knots) - 
-0001b4f0: 2864 6567 7265 6520 2b20 3129 0a20 2020  (degree + 1).   
-0001b500: 2062 6173 6973 203d 206e 702e 656d 7074   basis = np.empt
-0001b510: 7928 2878 7370 6c2e 7368 6170 655b 305d  y((xspl.shape[0]
-0001b520: 2c20 6e5f 6261 7365 7329 2c20 6474 7970  , n_bases), dtyp
-0001b530: 653d 666c 6f61 7429 0a0a 2020 2020 636f  e=float)..    co
-0001b540: 6566 7320 3d20 6e70 2e69 6465 6e74 6974  efs = np.identit
-0001b550: 7928 6e5f 6261 7365 7329 0a20 2020 2062  y(n_bases).    b
-0001b560: 6173 6973 203d 2073 706c 6576 2878 7370  asis = splev(xsp
-0001b570: 6c2c 2028 616c 6c5f 6b6e 6f74 732c 2063  l, (all_knots, c
-0001b580: 6f65 6673 2c20 6465 6772 6565 2929 0a0a  oefs, degree))..
-0001b590: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0001b5a0: 6765 286e 5f62 6173 6573 293a 0a20 2020  ge(n_bases):.   
-0001b5b0: 2020 2020 206f 7574 5f6f 665f 7261 6e67       out_of_rang
-0001b5c0: 6520 3d20 2878 7370 6c20 3c20 6d69 2920  e = (xspl < mi) 
-0001b5d0: 7c20 2878 7370 6c20 3e20 6d61 290a 2020  | (xspl > ma).  
-0001b5e0: 2020 2020 2020 6261 7369 735b 695d 5b6f        basis[i][o
-0001b5f0: 7574 5f6f 665f 7261 6e67 655d 203d 2030  ut_of_range] = 0
-0001b600: 0a0a 2020 2020 7761 7665 5f70 6561 6b20  ..    wave_peak 
-0001b610: 3d20 6e70 2e72 6f75 6e64 2877 6176 655b  = np.round(wave[
-0001b620: 6e70 2e61 7267 6d61 7828 6261 7369 732c  np.argmax(basis,
-0001b630: 2061 7869 733d 3129 5d29 0a0a 2020 2020   axis=1)])..    
-0001b640: 6d61 7876 616c 203d 206e 702e 6d61 7828  maxval = np.max(
-0001b650: 6261 7369 732c 2061 7869 733d 3129 0a20  basis, axis=1). 
-0001b660: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0001b670: 6528 6e5f 6261 7365 7329 3a0a 2020 2020  e(n_bases):.    
-0001b680: 2020 2020 6261 7369 735b 695d 5b62 6173      basis[i][bas
-0001b690: 6973 5b69 5d20 3c20 636c 6970 2a6d 6178  is[i] < clip*max
-0001b6a0: 7661 6c5b 695d 5d20 3d20 300a 0a20 2020  val[i]] = 0..   
-0001b6b0: 2069 6620 6765 745f 6d61 7472 6978 3a0a   if get_matrix:.
-0001b6c0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0001b6d0: 702e 7673 7461 636b 2862 6173 6973 292e  p.vstack(basis).
-0001b6e0: 540a 0a20 2020 2074 656d 7020 3d20 4f72  T..    temp = Or
-0001b6f0: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
-0001b700: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-0001b710: 5f62 6173 6573 293a 0a20 2020 2020 2020  _bases):.       
-0001b720: 206b 6579 203d 2027 6273 706c 207b 307d   key = 'bspl {0}
-0001b730: 207b 313a 2e30 667d 272e 666f 726d 6174   {1:.0f}'.format
-0001b740: 2869 2c20 7761 7665 5f70 6561 6b5b 695d  (i, wave_peak[i]
-0001b750: 290a 2020 2020 2020 2020 7465 6d70 5b6b  ).        temp[k
-0001b760: 6579 5d20 3d20 5370 6563 7472 756d 5465  ey] = SpectrumTe
-0001b770: 6d70 6c61 7465 2877 6176 652c 2062 6173  mplate(wave, bas
-0001b780: 6973 5b69 5d29 0a20 2020 2020 2020 2074  is[i]).        t
-0001b790: 656d 705b 6b65 795d 2e6e 616d 6520 3d20  emp[key].name = 
-0001b7a0: 6b65 790a 2020 2020 2020 2020 7465 6d70  key.        temp
-0001b7b0: 5b6b 6579 5d2e 7761 7665 5f70 6561 6b20  [key].wave_peak 
-0001b7c0: 3d20 7761 7665 5f70 6561 6b5b 695d 0a0a  = wave_peak[i]..
-0001b7d0: 2020 2020 7465 6d70 2e6b 6e6f 7473 203d      temp.knots =
-0001b7e0: 2061 6c6c 5f6b 6e6f 7473 0a20 2020 2074   all_knots.    t
-0001b7f0: 656d 702e 6465 6772 6565 203d 2064 6567  emp.degree = deg
-0001b800: 7265 650a 2020 2020 7465 6d70 2e78 7370  ree.    temp.xsp
-0001b810: 6c20 3d20 7873 706c 0a0a 2020 2020 7265  l = xspl..    re
-0001b820: 7475 726e 2074 656d 700a 0a0a 6465 6620  turn temp...def 
-0001b830: 6576 616c 5f62 7370 6c69 6e65 5f74 656d  eval_bspline_tem
-0001b840: 706c 6174 6573 2877 6176 652c 2062 7370  plates(wave, bsp
-0001b850: 6c2c 2063 6f65 6673 293a 0a20 2020 2066  l, coefs):.    f
-0001b860: 726f 6d20 7363 6970 792e 696e 7465 7270  rom scipy.interp
-0001b870: 6f6c 6174 6520 696d 706f 7274 2073 706c  olate import spl
-0001b880: 6576 0a0a 2020 2020 7873 706c 203d 206e  ev..    xspl = n
-0001b890: 702e 6c6f 6728 7761 7665 290a 2020 2020  p.log(wave).    
-0001b8a0: 6261 7369 7320 3d20 7370 6c65 7628 7873  basis = splev(xs
-0001b8b0: 706c 2c20 2862 7370 6c2e 6b6e 6f74 732c  pl, (bspl.knots,
-0001b8c0: 2063 6f65 6673 2c20 6273 706c 2e64 6567   coefs, bspl.deg
-0001b8d0: 7265 6529 290a 2020 2020 7265 7475 726e  ree)).    return
-0001b8e0: 206e 702e 6172 7261 7928 6261 7369 7329   np.array(basis)
-0001b8f0: 0a0a 0a64 6566 2073 706c 6974 5f73 706c  ...def split_spl
-0001b900: 696e 655f 7465 6d70 6c61 7465 2874 656d  ine_template(tem
-0001b910: 706c 2c20 7761 7665 6c65 6e67 7468 5f72  pl, wavelength_r
-0001b920: 616e 6765 3d5b 3530 3030 2c20 322e 3465  ange=[5000, 2.4e
-0001b930: 345d 2c20 5273 706c 696e 653d 3130 2c20  4], Rspline=10, 
-0001b940: 6c6f 673d 5472 7565 293a 0a20 2020 2022  log=True):.    "
-0001b950: 2222 0a20 2020 204d 756c 7469 706c 7920  "".    Multiply 
-0001b960: 6120 7369 6e67 6c65 2074 656d 706c 6174  a single templat
-0001b970: 6520 6279 2073 706c 696e 6520 6261 7365  e by spline base
-0001b980: 7320 746f 2065 6666 6563 7469 7665 6c79  s to effectively
-0001b990: 2067 656e 6572 6174 6520 610a 2020 2020   generate a.    
-0001b9a0: 7370 6c69 6e65 206d 756c 7469 706c 6963  spline multiplic
-0001b9b0: 6174 6976 6520 636f 7272 6563 7469 6f6e  ative correction
-0001b9c0: 2074 6861 7420 6361 6e20 6265 2066 6974   that can be fit
-0001b9d0: 2077 6974 6820 6c69 6e65 6172 206c 6561   with linear lea
-0001b9e0: 7374 0a20 2020 2073 7175 6172 6573 2e0a  st.    squares..
-0001b9f0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-0001ba00: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a      ----------..
-0001ba10: 2020 2020 7465 6d70 6c20 3a20 607e 6772      templ : `~gr
-0001ba20: 697a 6c69 2e75 7469 6c73 2e53 7065 6374  izli.utils.Spect
-0001ba30: 7275 6d54 656d 706c 6174 6560 0a20 2020  rumTemplate`.   
-0001ba40: 2020 2020 2054 656d 706c 6174 6520 746f       Template to
-0001ba50: 2073 706c 6974 2e0a 0a20 2020 2077 6176   split...    wav
-0001ba60: 656c 656e 6774 685f 7261 6e67 6520 3a20  elength_range : 
-0001ba70: 5b66 6c6f 6174 2c20 666c 6f61 745d 0a20  [float, float]. 
-0001ba80: 2020 2020 2020 204c 696d 6974 2074 6865         Limit the
-0001ba90: 2073 706c 696e 6573 2074 6f20 7468 6973   splines to this
-0001baa0: 2077 6176 656c 656e 6774 6820 7261 6e67   wavelength rang
-0001bab0: 650a 0a20 2020 2052 7370 6c69 6e65 203a  e..    Rspline :
-0001bac0: 2066 6c6f 6174 0a20 2020 2020 2020 2045   float.        E
-0001bad0: 6666 6563 7469 7665 2072 6573 6f6c 7574  ffective resolut
-0001bae0: 696f 6e2c 2052 3d64 6c61 6d62 6461 2f6c  ion, R=dlambda/l
-0001baf0: 616d 6264 612c 206f 6620 7468 6520 7370  ambda, of the sp
-0001bb00: 6c69 6e65 2063 6f72 7265 6374 696f 6e0a  line correction.
-0001bb10: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-0001bb20: 2e0a 0a20 2020 206c 6f67 203a 2062 6f6f  ...    log : boo
-0001bb30: 6c0a 2020 2020 2020 2020 4c6f 672d 7370  l.        Log-sp
-0001bb40: 6163 6564 2073 706c 696e 6573 0a0a 2020  aced splines..  
-0001bb50: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-0001bb60: 2d2d 2d2d 2d0a 0a20 2020 2073 7465 6d70  -----..    stemp
-0001bb70: 203a 2064 6963 740a 0a20 2020 2020 2020   : dict..       
-0001bb80: 2044 6963 7469 6f6e 6172 7920 6f66 2073   Dictionary of s
-0001bb90: 706c 696e 652d 636f 6d70 6f6e 656e 7420  pline-component 
-0001bba0: 7465 6d70 6c61 7465 732c 2077 6974 6820  templates, with 
-0001bbb0: 6164 6469 7469 6f6e 616c 2061 7474 7269  additional attri
-0001bbc0: 6275 7465 733a 0a0a 2020 2020 2020 2020  butes:..        
-0001bbd0: 2020 2020 7773 706c 696e 6520 3d20 7761      wspline = wa
-0001bbe0: 7665 6c65 6e67 7468 206f 6620 7468 6520  velength of the 
-0001bbf0: 7465 6d70 6c61 7465 7320 2f20 7370 6c69  templates / spli
-0001bc00: 6e65 2063 6f72 7265 6374 696f 6e0a 2020  ne correction.  
-0001bc10: 2020 2020 2020 2020 2020 7473 706c 696e            tsplin
-0001bc20: 6520 3d20 6d61 7472 6978 206f 6620 7468  e = matrix of th
-0001bc30: 6520 7370 6c69 6e65 2063 6f72 7265 6374  e spline correct
-0001bc40: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-0001bc50: 206b 6e6f 7473 2020 203d 2070 6561 6b20   knots   = peak 
-0001bc60: 7761 7665 6c65 6e67 6874 7320 6f66 2065  wavelenghts of e
-0001bc70: 6163 6820 7370 6c69 6e65 2063 6f6d 706f  ach spline compo
-0001bc80: 6e65 6e74 0a0a 2020 2020 2222 220a 2020  nent..    """.  
-0001bc90: 2020 6672 6f6d 2063 6f6c 6c65 6374 696f    from collectio
-0001bca0: 6e73 2069 6d70 6f72 7420 4f72 6465 7265  ns import Ordere
-0001bcb0: 6444 6963 740a 2020 2020 6672 6f6d 2067  dDict.    from g
-0001bcc0: 7269 7a6c 6920 696d 706f 7274 2075 7469  rizli import uti
-0001bcd0: 6c73 0a0a 2020 2020 6966 2046 616c 7365  ls..    if False
-0001bce0: 3a0a 2020 2020 2020 2020 7374 6172 7320  :.        stars 
-0001bcf0: 3d20 7574 696c 732e 6c6f 6164 5f74 656d  = utils.load_tem
-0001bd00: 706c 6174 6573 2873 7461 7273 3d54 7275  plates(stars=Tru
-0001bd10: 6529 0a20 2020 2020 2020 2074 656d 706c  e).        templ
-0001bd20: 203d 2073 7461 7273 5b27 7374 6172 732f   = stars['stars/
-0001bd30: 4c31 2e30 2e74 7874 275d 0a0a 2020 2020  L1.0.txt']..    
-0001bd40: 7773 706c 696e 6520 3d20 7465 6d70 6c2e  wspline = templ.
-0001bd50: 7761 7665 0a0a 2020 2020 636c 6970 203d  wave..    clip =
-0001bd60: 2028 7773 706c 696e 6520 3e20 7761 7665   (wspline > wave
-0001bd70: 6c65 6e67 7468 5f72 616e 6765 5b30 5d29  length_range[0])
-0001bd80: 2026 2028 7773 706c 696e 6520 3c20 7761   & (wspline < wa
-0001bd90: 7665 6c65 6e67 7468 5f72 616e 6765 5b31  velength_range[1
-0001bda0: 5d29 0a20 2020 2064 665f 7370 6c20 3d20  ]).    df_spl = 
-0001bdb0: 6c65 6e28 7574 696c 732e 6c6f 675f 7a67  len(utils.log_zg
-0001bdc0: 7269 6428 7a72 3d77 6176 656c 656e 6774  rid(zr=wavelengt
-0001bdd0: 685f 7261 6e67 652c 2064 7a3d 312e 2f52  h_range, dz=1./R
-0001bde0: 7370 6c69 6e65 2929 0a0a 2020 2020 7473  spline))..    ts
-0001bdf0: 706c 696e 6520 3d20 7574 696c 732e 6273  pline = utils.bs
-0001be00: 706c 696e 655f 7465 6d70 6c61 7465 7328  pline_templates(
-0001be10: 7773 706c 696e 655b 636c 6970 5d2c 2064  wspline[clip], d
-0001be20: 663d 6466 5f73 706c 2b32 2c20 6c6f 673d  f=df_spl+2, log=
-0001be30: 6c6f 672c 2063 6c69 703d 302e 3030 3031  log, clip=0.0001
-0001be40: 2c20 6765 745f 6d61 7472 6978 3d54 7275  , get_matrix=Tru
-0001be50: 6529 0a0a 2020 2020 6978 203d 206e 702e  e)..    ix = np.
-0001be60: 6172 676d 6178 2874 7370 6c69 6e65 2c20  argmax(tspline, 
-0001be70: 6178 6973 3d30 290a 2020 2020 6b6e 6f74  axis=0).    knot
-0001be80: 7320 3d20 7773 706c 696e 655b 636c 6970  s = wspline[clip
-0001be90: 5d5b 6978 5d0a 0a20 2020 204e 203d 2074  ][ix]..    N = t
-0001bea0: 7370 6c69 6e65 2e73 6861 7065 5b31 5d0a  spline.shape[1].
-0001beb0: 2020 2020 7374 656d 7020 3d20 4f72 6465      stemp = Orde
-0001bec0: 7265 6444 6963 7428 290a 2020 2020 666f  redDict().    fo
-0001bed0: 7220 6920 696e 2072 616e 6765 284e 293a  r i in range(N):
-0001bee0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
-0001bef0: 277b 307d 207b 313a 2e32 667d 272e 666f  '{0} {1:.2f}'.fo
-0001bf00: 726d 6174 2874 656d 706c 2e6e 616d 652c  rmat(templ.name,
-0001bf10: 206b 6e6f 7473 5b69 5d2f 312e 6534 290a   knots[i]/1.e4).
-0001bf20: 2020 2020 2020 2020 7374 656d 705b 6e61          stemp[na
-0001bf30: 6d65 5d20 3d20 7574 696c 732e 5370 6563  me] = utils.Spec
-0001bf40: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
-0001bf50: 653d 7773 706c 696e 655b 636c 6970 5d2c  e=wspline[clip],
-0001bf60: 2066 6c75 783d 7465 6d70 6c2e 666c 7578   flux=templ.flux
-0001bf70: 5b63 6c69 705d 2a74 7370 6c69 6e65 5b3a  [clip]*tspline[:
-0001bf80: 2c20 695d 2c20 6e61 6d65 3d6e 616d 6529  , i], name=name)
-0001bf90: 0a20 2020 2020 2020 2073 7465 6d70 5b6e  .        stemp[n
-0001bfa0: 616d 655d 2e6b 6e6f 7420 3d20 6b6e 6f74  ame].knot = knot
-0001bfb0: 735b 695d 0a0a 2020 2020 7374 656d 702e  s[i]..    stemp.
-0001bfc0: 7773 706c 696e 6520 3d20 7773 706c 696e  wspline = wsplin
-0001bfd0: 655b 636c 6970 5d0a 2020 2020 7374 656d  e[clip].    stem
-0001bfe0: 702e 7473 706c 696e 6520 3d20 7473 706c  p.tspline = tspl
-0001bff0: 696e 650a 2020 2020 7374 656d 702e 6b6e  ine.    stemp.kn
-0001c000: 6f74 7320 3d20 6b6e 6f74 730a 0a20 2020  ots = knots..   
-0001c010: 2072 6574 7572 6e20 7374 656d 700a 0a0a   return stemp...
-0001c020: 6465 6620 7374 6570 5f74 656d 706c 6174  def step_templat
-0001c030: 6573 2877 6c69 6d3d 5b35 3030 302c 2031  es(wlim=[5000, 1
-0001c040: 2e38 6534 5d2c 2062 696e 5f73 7465 7073  .8e4], bin_steps
-0001c050: 3d4e 6f6e 652c 2052 3d33 302c 2072 6f75  =None, R=30, rou
-0001c060: 6e64 3d31 302c 2072 6573 743d 4661 6c73  nd=10, rest=Fals
-0001c070: 652c 2073 7065 6369 616c 3d4e 6f6e 652c  e, special=None,
-0001c080: 206f 7264 6572 3d30 293a 0a20 2020 2022   order=0):.    "
-0001c090: 2222 0a20 2020 2053 7465 702d 6675 6e63  "".    Step-func
-0001c0a0: 7469 6f6e 2074 656d 706c 6174 6573 2066  tion templates f
-0001c0b0: 6f72 2065 6173 7920 6269 6e6e 696e 670a  or easy binning.
-0001c0c0: 2020 2020 2222 220a 2020 2020 6966 2073      """.    if s
-0001c0d0: 7065 6369 616c 203d 3d20 2744 6e34 3030  pecial == 'Dn400
-0001c0e0: 3027 3a0a 2020 2020 2020 2020 7265 7374  0':.        rest
-0001c0f0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001c100: 6269 6e5f 7374 6570 7320 3d20 6e70 2e68  bin_steps = np.h
-0001c110: 7374 6163 6b28 5b6e 702e 6172 616e 6765  stack([np.arange
-0001c120: 2838 3530 2c20 3338 3439 2c20 3130 3029  (850, 3849, 100)
-0001c130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c150: 5b33 3835 302c 2033 3935 302c 2034 3030  [3850, 3950, 400
-0001c160: 302c 2034 3130 305d 2c0a 2020 2020 2020  0, 4100],.      
-0001c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c180: 2020 2020 2020 2020 6e70 2e61 7261 6e67          np.arang
-0001c190: 6528 3432 3030 2c20 312e 3765 342c 2031  e(4200, 1.7e4, 1
-0001c1a0: 3030 295d 290a 0a20 2020 2065 6c69 6620  00)])..    elif 
-0001c1b0: 7370 6563 6961 6c20 3d3d 2027 4434 3030  special == 'D400
-0001c1c0: 3027 3a0a 2020 2020 2020 2020 7265 7374  0':.        rest
-0001c1d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001c1e0: 6269 6e5f 7374 6570 7320 3d20 6e70 2e68  bin_steps = np.h
-0001c1f0: 7374 6163 6b28 5b6e 702e 6172 616e 6765  stack([np.arange
-0001c200: 2838 3530 2c20 3337 3439 2c20 3230 3029  (850, 3749, 200)
-0001c210: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c230: 5b33 3735 302c 2033 3935 302c 2034 3035  [3750, 3950, 405
-0001c240: 302c 2034 3235 305d 2c0a 2020 2020 2020  0, 4250],.      
-0001c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c260: 2020 2020 2020 2020 6e70 2e61 7261 6e67          np.arang
-0001c270: 6528 3434 3530 2c20 312e 3765 342c 2032  e(4450, 1.7e4, 2
-0001c280: 3030 295d 290a 2020 2020 656c 6966 2073  00)]).    elif s
-0001c290: 7065 6369 616c 206e 6f74 2069 6e20 5b27  pecial not in ['
-0001c2a0: 4434 3030 3027 2c20 2744 6e34 3030 3027  D4000', 'Dn4000'
-0001c2b0: 2c20 4e6f 6e65 5d3a 0a20 2020 2020 2020  , None]:.       
-0001c2c0: 2070 7269 6e74 2827 7374 6570 5f74 656d   print('step_tem
-0001c2d0: 706c 6174 6573 3a20 7b30 7d20 6e6f 7420  plates: {0} not 
-0001c2e0: 7265 636f 676e 697a 6564 2028 6f70 7469  recognized (opti
-0001c2f0: 6f6e 7320 6172 6520 5c27 4434 3030 305c  ons are \'D4000\
-0001c300: 272c 205c 2744 6e34 3030 305c 272c 2061  ', \'Dn4000\', a
-0001c310: 6e64 204e 6f6e 6529 272e 666f 726d 6174  nd None)'.format
-0001c320: 2873 7065 6369 616c 2929 0a20 2020 2020  (special)).     
-0001c330: 2020 2072 6574 7572 6e20 7b7d 0a0a 2020     return {}..  
-0001c340: 2020 6966 2062 696e 5f73 7465 7073 2069    if bin_steps i
-0001c350: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001c360: 6269 6e5f 7374 6570 7320 3d20 6e70 2e72  bin_steps = np.r
-0001c370: 6f75 6e64 286c 6f67 5f7a 6772 6964 2877  ound(log_zgrid(w
-0001c380: 6c69 6d2c 2031 2e2f 5229 2f72 6f75 6e64  lim, 1./R)/round
-0001c390: 292a 726f 756e 640a 2020 2020 656c 7365  )*round.    else
-0001c3a0: 3a0a 2020 2020 2020 2020 776c 696d 203d  :.        wlim =
-0001c3b0: 205b 6269 6e5f 7374 6570 735b 305d 2c20   [bin_steps[0], 
-0001c3c0: 6269 6e5f 7374 6570 735b 2d31 5d5d 0a0a  bin_steps[-1]]..
-0001c3d0: 2020 2020 6473 203d 206e 702e 6469 6666      ds = np.diff
-0001c3e0: 2862 696e 5f73 7465 7073 290a 0a20 2020  (bin_steps)..   
-0001c3f0: 2078 7370 6563 203d 206e 702e 6172 616e   xspec = np.aran
-0001c400: 6765 2877 6c69 6d5b 305d 2d64 735b 305d  ge(wlim[0]-ds[0]
-0001c410: 2c20 776c 696d 5b31 5d2b 6473 5b2d 315d  , wlim[1]+ds[-1]
-0001c420: 290a 0a20 2020 2062 696e 5f6d 6964 203d  )..    bin_mid =
-0001c430: 2062 696e 5f73 7465 7073 5b3a 2d31 5d2b   bin_steps[:-1]+
-0001c440: 6473 2f32 2e0a 0a20 2020 2073 7465 705f  ds/2...    step_
-0001c450: 7465 6d70 6c20 3d20 7b7d 0a20 2020 2066  templ = {}.    f
-0001c460: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-0001c470: 6e28 6269 6e5f 7374 6570 7329 2d31 293a  n(bin_steps)-1):
-0001c480: 0a0a 2020 2020 2020 2020 7973 7065 6320  ..        yspec 
-0001c490: 3d20 2828 7873 7065 6320 3e3d 2062 696e  = ((xspec >= bin
-0001c4a0: 5f73 7465 7073 5b69 5d29 2026 2028 7873  _steps[i]) & (xs
-0001c4b0: 7065 6320 3c20 6269 6e5f 7374 6570 735b  pec < bin_steps[
-0001c4c0: 692b 315d 2929 2a31 0a0a 2020 2020 2020  i+1]))*1..      
-0001c4d0: 2020 666f 7220 6f20 696e 2072 616e 6765    for o in range
-0001c4e0: 286f 7264 6572 2b31 293a 0a20 2020 2020  (order+1):.     
-0001c4f0: 2020 2020 2020 206c 6162 656c 203d 2027         label = '
-0001c500: 7374 6570 207b 303a 2e30 667d 2d7b 313a  step {0:.0f}-{1:
-0001c510: 2e30 667d 207b 327d 272e 666f 726d 6174  .0f} {2}'.format
-0001c520: 2862 696e 5f73 7465 7073 5b69 5d2c 2062  (bin_steps[i], b
-0001c530: 696e 5f73 7465 7073 5b69 2b31 5d2c 206f  in_steps[i+1], o
-0001c540: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001c550: 2072 6573 743a 0a20 2020 2020 2020 2020   rest:.         
-0001c560: 2020 2020 2020 206c 6162 656c 203d 2027         label = '
-0001c570: 7227 2b6c 6162 656c 0a0a 2020 2020 2020  r'+label..      
-0001c580: 2020 2020 2020 666c 7578 203d 2028 2878        flux = ((x
-0001c590: 7370 6563 2d62 696e 5f6d 6964 5b69 5d29  spec-bin_mid[i])
-0001c5a0: 2f64 735b 695d 292a 2a6f 202a 2028 7973  /ds[i])**o * (ys
-0001c5b0: 7065 6320 3e20 3029 0a20 2020 2020 2020  pec > 0).       
-0001c5c0: 2020 2020 2073 7465 705f 7465 6d70 6c5b       step_templ[
-0001c5d0: 6c61 6265 6c5d 203d 2053 7065 6374 7275  label] = Spectru
-0001c5e0: 6d54 656d 706c 6174 6528 7761 7665 3d78  mTemplate(wave=x
-0001c5f0: 7370 6563 2c20 666c 7578 3d66 6c75 782c  spec, flux=flux,
-0001c600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c630: 2020 6e61 6d65 3d6c 6162 656c 290a 0a20    name=label).. 
-0001c640: 2020 2072 6574 7572 6e20 6269 6e5f 7374     return bin_st
-0001c650: 6570 732c 2073 7465 705f 7465 6d70 6c0a  eps, step_templ.
-0001c660: 0a0a 6465 6620 706f 6c79 6e6f 6d69 616c  ..def polynomial
-0001c670: 5f74 656d 706c 6174 6573 2877 6176 652c  _templates(wave,
-0001c680: 2072 6566 5f77 6176 653d 312e 6534 2c20   ref_wave=1.e4, 
-0001c690: 6f72 6465 723d 302c 206c 696e 653d 4661  order=0, line=Fa
-0001c6a0: 6c73 6529 3a0a 2020 2020 7465 6d70 203d  lse):.    temp =
-0001c6b0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
-0001c6c0: 2020 2069 6620 6c69 6e65 3a0a 2020 2020     if line:.    
-0001c6d0: 2020 2020 666f 7220 7369 676e 2069 6e20      for sign in 
-0001c6e0: 5b31 2c20 2d31 5d3a 0a20 2020 2020 2020  [1, -1]:.       
-0001c6f0: 2020 2020 206b 6579 203d 2027 706f 6c79       key = 'poly
-0001c700: 207b 307d 272e 666f 726d 6174 2873 6967   {0}'.format(sig
-0001c710: 6e29 0a20 2020 2020 2020 2020 2020 2074  n).            t
-0001c720: 656d 705b 6b65 795d 203d 2053 7065 6374  emp[key] = Spect
-0001c730: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
-0001c740: 2c20 7369 676e 2a28 7761 7665 2f72 6566  , sign*(wave/ref
-0001c750: 5f77 6176 652d 3129 2b31 290a 2020 2020  _wave-1)+1).    
-0001c760: 2020 2020 2020 2020 7465 6d70 5b6b 6579          temp[key
-0001c770: 5d2e 6e61 6d65 203d 206b 6579 0a0a 2020  ].name = key..  
-0001c780: 2020 2020 2020 7265 7475 726e 2074 656d        return tem
-0001c790: 700a 0a20 2020 2066 6f72 2069 2069 6e20  p..    for i in 
-0001c7a0: 7261 6e67 6528 6f72 6465 722b 3129 3a0a  range(order+1):.
-0001c7b0: 2020 2020 2020 2020 6b65 7920 3d20 2770          key = 'p
-0001c7c0: 6f6c 7920 7b30 7d27 2e66 6f72 6d61 7428  oly {0}'.format(
-0001c7d0: 6929 0a20 2020 2020 2020 2074 656d 705b  i).        temp[
-0001c7e0: 6b65 795d 203d 2053 7065 6374 7275 6d54  key] = SpectrumT
-0001c7f0: 656d 706c 6174 6528 7761 7665 2c20 2877  emplate(wave, (w
-0001c800: 6176 652f 7265 665f 7761 7665 2d31 292a  ave/ref_wave-1)*
-0001c810: 2a69 290a 2020 2020 2020 2020 7465 6d70  *i).        temp
-0001c820: 5b6b 6579 5d2e 6e61 6d65 203d 206b 6579  [key].name = key
-0001c830: 0a20 2020 2020 2020 2074 656d 705b 6b65  .        temp[ke
-0001c840: 795d 2e72 6566 5f77 6176 6520 3d20 7265  y].ref_wave = re
-0001c850: 665f 7761 7665 0a0a 2020 2020 7265 7475  f_wave..    retu
-0001c860: 726e 2074 656d 700a 0a0a 6465 6620 7370  rn temp...def sp
-0001c870: 6c69 745f 706f 6c79 5f74 656d 706c 6174  lit_poly_templat
-0001c880: 6528 7465 6d70 6c2c 2072 6566 5f77 6176  e(templ, ref_wav
-0001c890: 653d 312e 6534 2c20 6f72 6465 723d 3329  e=1.e4, order=3)
-0001c8a0: 3a0a 2020 2020 2222 220a 2020 2020 4d75  :.    """.    Mu
-0001c8b0: 6c74 6970 6c79 2061 2073 696e 676c 6520  ltiply a single 
-0001c8c0: 7465 6d70 6c61 7465 2062 7920 706f 6c79  template by poly
-0001c8d0: 6e6f 6d69 616c 2062 6173 6573 2074 6f20  nomial bases to 
-0001c8e0: 6566 6665 6374 6976 656c 7920 6765 6e65  effectively gene
-0001c8f0: 7261 7465 2061 0a20 2020 2070 6f6c 796e  rate a.    polyn
-0001c900: 6f6d 6961 6c20 6d75 6c74 6970 6c69 6361  omial multiplica
-0001c910: 7469 7665 2063 6f72 7265 6374 696f 6e20  tive correction 
-0001c920: 7468 6174 2063 616e 2062 6520 6669 7420  that can be fit 
-0001c930: 7769 7468 206c 696e 6561 7220 6c65 6173  with linear leas
-0001c940: 740a 2020 2020 7371 7561 7265 732e 0a0a  t.    squares...
-0001c950: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001c960: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0001c970: 2020 7465 6d70 6c20 3a20 607e 6772 697a    templ : `~griz
-0001c980: 6c69 2e75 7469 6c73 2e53 7065 6374 7275  li.utils.Spectru
-0001c990: 6d54 656d 706c 6174 6560 0a20 2020 2020  mTemplate`.     
-0001c9a0: 2020 2054 656d 706c 6174 6520 746f 2073     Template to s
-0001c9b0: 706c 6974 2e0a 0a20 2020 2072 6566 5f77  plit...    ref_w
-0001c9c0: 6176 6520 3a20 666c 6f61 740a 2020 2020  ave : float.    
-0001c9d0: 2020 2057 6176 656c 656e 6774 6820 7768     Wavelength wh
-0001c9e0: 6572 6520 746f 206e 6f72 6d61 6c69 7a65  ere to normalize
-0001c9f0: 2074 6865 2070 6f6c 796e 6f6d 6961 6c73   the polynomials
-0001ca00: 2e0a 0a20 2020 204f 7264 6572 203a 2069  ...    Order : i
-0001ca10: 6e74 0a20 2020 2020 2020 2050 6f6c 796e  nt.        Polyn
-0001ca20: 6f6d 6961 6c20 6f72 6465 722e 2020 5265  omial order.  Re
-0001ca30: 7475 726e 7320 6f72 6465 722b 3120 7465  turns order+1 te
-0001ca40: 6d70 6c61 7465 732e 0a0a 2020 2020 5265  mplates...    Re
-0001ca50: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0001ca60: 2d0a 2020 2020 7074 656d 7020 3a20 6469  -.    ptemp : di
-0001ca70: 6374 0a0a 2020 2020 2020 2020 4469 6374  ct..        Dict
-0001ca80: 696f 6e61 7279 206f 6620 706f 6c79 6e6f  ionary of polyno
-0001ca90: 6d69 616c 2d63 6f6d 706f 6e65 6e74 2074  mial-component t
-0001caa0: 656d 706c 6174 6573 2c20 7769 7468 2061  emplates, with a
-0001cab0: 6464 6974 696f 6e61 6c0a 2020 2020 2020  dditional.      
-0001cac0: 2020 6174 7472 6962 7574 6573 3a0a 0a20    attributes:.. 
-0001cad0: 2020 2020 2020 2020 2020 2072 6566 5f77             ref_w
-0001cae0: 6176 6520 3d20 7761 7665 6c65 6e67 7468  ave = wavelength
-0001caf0: 2077 6865 7265 2070 6f6c 796e 6f6d 6961   where polynomia
-0001cb00: 6c73 206e 6f72 6d61 6c69 7a65 640a 0a20  ls normalized.. 
-0001cb10: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
-0001cb20: 636f 6c6c 6563 7469 6f6e 7320 696d 706f  collections impo
-0001cb30: 7274 204f 7264 6572 6564 4469 6374 0a20  rt OrderedDict. 
-0001cb40: 2020 2066 726f 6d20 6772 697a 6c69 2069     from grizli i
-0001cb50: 6d70 6f72 7420 7574 696c 730a 0a20 2020  mport utils..   
-0001cb60: 2074 7370 6c69 6e65 203d 2070 6f6c 796e   tspline = polyn
-0001cb70: 6f6d 6961 6c5f 7465 6d70 6c61 7465 7328  omial_templates(
-0001cb80: 7465 6d70 6c2e 7761 7665 2c20 7265 665f  templ.wave, ref_
-0001cb90: 7761 7665 3d72 6566 5f77 6176 652c 0a20  wave=ref_wave,. 
-0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbc0: 2020 6f72 6465 723d 6f72 6465 722c 206c    order=order, l
-0001cbd0: 696e 653d 4661 6c73 6529 0a0a 2020 2020  ine=False)..    
-0001cbe0: 7074 656d 7020 3d20 4f72 6465 7265 6444  ptemp = OrderedD
-0001cbf0: 6963 7428 290a 0a20 2020 2066 6f72 2069  ict()..    for i
-0001cc00: 2c20 7420 696e 2065 6e75 6d65 7261 7465  , t in enumerate
-0001cc10: 2874 7370 6c69 6e65 293a 0a20 2020 2020  (tspline):.     
-0001cc20: 2020 206e 616d 6520 3d20 277b 307d 2070     name = '{0} p
-0001cc30: 6f6c 7920 7b31 7d27 2e66 6f72 6d61 7428  oly {1}'.format(
-0001cc40: 7465 6d70 6c2e 6e61 6d65 2c20 6929 0a20  templ.name, i). 
-0001cc50: 2020 2020 2020 2070 7465 6d70 5b6e 616d         ptemp[nam
-0001cc60: 655d 203d 2075 7469 6c73 2e53 7065 6374  e] = utils.Spect
-0001cc70: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
-0001cc80: 3d74 656d 706c 2e77 6176 652c 0a20 2020  =templ.wave,.   
-0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cca0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0001ccb0: 7578 3d74 656d 706c 2e66 6c75 782a 7473  ux=templ.flux*ts
-0001ccc0: 706c 696e 655b 745d 2e66 6c75 782c 0a20  pline[t].flux,. 
+000199b0: 6573 2877 7370 6c69 6e65 2c20 6466 3d6c  es(wspline, df=l
+000199c0: 656e 2864 665f 7370 6c29 2b32 2c20 6c6f  en(df_spl)+2, lo
+000199d0: 673d 5472 7565 2c0a 2020 2020 2020 2020  g=True,.        
+000199e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199f0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+00019a00: 703d 302e 3030 3031 290a 0a20 2020 2020  p=0.0001)..     
+00019a10: 2020 2066 6f72 206b 6579 2069 6e20 6273     for key in bs
+00019a20: 706c 696e 6573 3a0a 2020 2020 2020 2020  plines:.        
+00019a30: 2020 2020 7430 5b6b 6579 5d20 3d20 7431      t0[key] = t1
+00019a40: 5b6b 6579 5d20 3d20 6273 706c 696e 6573  [key] = bsplines
+00019a50: 5b6b 6579 5d0a 0a20 2020 2065 6c69 6620  [key]..    elif 
+00019a60: 6e73 706c 696e 6520 3e20 303a 0a20 2020  nspline > 0:.   
+00019a70: 2020 2020 2023 2053 706c 696e 6520 636f       # Spline co
+00019a80: 6e74 696e 7561 0a20 2020 2020 2020 2063  ntinua.        c
+00019a90: 6f6e 745f 7761 7665 203d 206e 702e 6172  ont_wave = np.ar
+00019aa0: 616e 6765 2835 3030 302c 2032 2e34 6534  ange(5000, 2.4e4
+00019ab0: 290a 2020 2020 2020 2020 6273 706c 696e  ).        bsplin
+00019ac0: 6573 203d 2062 7370 6c69 6e65 5f74 656d  es = bspline_tem
+00019ad0: 706c 6174 6573 2863 6f6e 745f 7761 7665  plates(cont_wave
+00019ae0: 2c20 6466 3d6e 7370 6c69 6e65 2c20 6c6f  , df=nspline, lo
+00019af0: 673d 5472 7565 290a 2020 2020 2020 2020  g=True).        
+00019b00: 666f 7220 6b65 7920 696e 2062 7370 6c69  for key in bspli
+00019b10: 6e65 733a 0a20 2020 2020 2020 2020 2020  nes:.           
+00019b20: 2074 305b 6b65 795d 203d 2074 315b 6b65   t0[key] = t1[ke
+00019b30: 795d 203d 2062 7370 6c69 6e65 735b 6b65  y] = bsplines[ke
+00019b40: 795d 0a0a 2020 2020 656c 6966 2062 6574  y]..    elif bet
+00019b50: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
+00019b60: 2020 2020 2020 2020 6274 656d 7020 3d20          btemp = 
+00019b70: 6c6f 6164 5f62 6574 615f 7465 6d70 6c61  load_beta_templa
+00019b80: 7465 7328 7761 7665 3d6e 702e 6172 616e  tes(wave=np.aran
+00019b90: 6765 2834 3030 2c20 322e 3565 3429 2c20  ge(400, 2.5e4), 
+00019ba0: 6265 7461 733d 6265 7461 7329 0a20 2020  betas=betas).   
+00019bb0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00019bc0: 6274 656d 703a 0a20 2020 2020 2020 2020  btemp:.         
+00019bd0: 2020 2074 305b 6b65 795d 203d 2074 315b     t0[key] = t1[
+00019be0: 6b65 795d 203d 2062 7465 6d70 5b6b 6579  key] = btemp[key
+00019bf0: 5d0a 0a20 2020 2065 6c73 653a 0a20 2020  ]..    else:.   
+00019c00: 2020 2020 2023 204f 6273 6572 7665 6420       # Observed 
+00019c10: 6672 616d 6520 7374 6570 730a 2020 2020  frame steps.    
+00019c20: 2020 2020 6f6e 6564 5220 3d20 2d6e 7370      onedR = -nsp
+00019c30: 6c69 6e65 0a20 2020 2020 2020 2077 6c69  line.        wli
+00019c40: 6d20 3d20 5b35 3030 302c 2031 3830 3030  m = [5000, 18000
+00019c50: 2e30 5d0a 2020 2020 2020 2020 6269 6e5f  .0].        bin_
+00019c60: 7374 6570 732c 2073 7465 705f 7465 6d70  steps, step_temp
+00019c70: 6c20 3d20 7374 6570 5f74 656d 706c 6174  l = step_templat
+00019c80: 6573 2877 6c69 6d3d 776c 696d 2c20 523d  es(wlim=wlim, R=
+00019c90: 6f6e 6564 522c 0a20 2020 2020 2020 2020  onedR,.         
+00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cc0: 2020 2020 2020 726f 756e 643d 3130 290a        round=10).
+00019cd0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+00019ce0: 696e 2073 7465 705f 7465 6d70 6c3a 0a20  in step_templ:. 
+00019cf0: 2020 2020 2020 2020 2020 2074 305b 6b65             t0[ke
+00019d00: 795d 203d 2074 315b 6b65 795d 203d 2073  y] = t1[key] = s
+00019d10: 7465 705f 7465 6d70 6c5b 6b65 795d 0a0a  tep_templ[key]..
+00019d20: 2020 2020 2320 7430 5b27 626c 7565 275d      # t0['blue']
+00019d30: 203d 2074 315b 2762 6c75 6527 5d20 3d20   = t1['blue'] = 
+00019d40: 5370 6563 7472 756d 5465 6d70 6c61 7465  SpectrumTemplate
+00019d50: 2877 6176 653d 636f 6e74 5f77 6176 652c  (wave=cont_wave,
+00019d60: 2066 6c75 783d 2863 6f6e 745f 7761 7665   flux=(cont_wave
+00019d70: 2f36 3536 332e 292a 2a2d 322e 3829 0a20  /6563.)**-2.8). 
+00019d80: 2020 2023 2074 305b 276d 6964 275d 203d     # t0['mid'] =
+00019d90: 2074 315b 276d 6964 275d 203d 2053 7065   t1['mid'] = Spe
+00019da0: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+00019db0: 7665 3d63 6f6e 745f 7761 7665 2c20 666c  ve=cont_wave, fl
+00019dc0: 7578 3d28 636f 6e74 5f77 6176 652f 3635  ux=(cont_wave/65
+00019dd0: 3633 2e29 2a2a 3029 0a20 2020 2023 2074  63.)**0).    # t
+00019de0: 305b 2772 6564 275d 203d 2074 315b 276d  0['red'] = t1['m
+00019df0: 6964 275d 203d 2053 7065 6374 7275 6d54  id'] = SpectrumT
+00019e00: 656d 706c 6174 6528 7761 7665 3d63 6f6e  emplate(wave=con
+00019e10: 745f 7761 7665 2c20 666c 7578 3d28 636f  t_wave, flux=(co
+00019e20: 6e74 5f77 6176 652f 3635 3633 2e29 2a2a  nt_wave/6563.)**
+00019e30: 322e 3829 0a0a 2020 2020 7265 7475 726e  2.8)..    return
+00019e40: 2074 302c 2074 310a 0a0a 5048 4f45 4e49   t0, t1...PHOENI
+00019e50: 585f 4c4f 4747 5f46 554c 4c20 3d20 5b33  X_LOGG_FULL = [3
+00019e60: 2e30 2c20 332e 352c 2034 2e30 2c20 342e  .0, 3.5, 4.0, 4.
+00019e70: 352c 2035 2e30 2c20 352e 355d 0a50 484f  5, 5.0, 5.5].PHO
+00019e80: 454e 4958 5f4c 4f47 4720 3d20 5b34 2e30  ENIX_LOGG = [4.0
+00019e90: 2c20 342e 352c 2035 2e30 2c20 352e 355d  , 4.5, 5.0, 5.5]
+00019ea0: 0a0a 5048 4f45 4e49 585f 5445 4646 5f46  ..PHOENIX_TEFF_F
+00019eb0: 554c 4c20 3d20 5b34 3030 2e30 2c20 3432  ULL = [400.0, 42
+00019ec0: 302e 302c 2034 3530 2e30 2c20 3530 302e  0.0, 450.0, 500.
+00019ed0: 302c 2035 3530 2e30 2c20 3630 302e 302c  0, 550.0, 600.0,
+00019ee0: 2036 3530 2e30 2c20 3730 302e 302c 2037   650.0, 700.0, 7
+00019ef0: 3530 2e30 2c20 3830 302e 302c 2038 3530  50.0, 800.0, 850
+00019f00: 2e30 2c20 3930 302e 302c 2039 3530 2e30  .0, 900.0, 950.0
+00019f10: 2c20 3130 3030 2e30 2c20 3130 3530 2e30  , 1000.0, 1050.0
+00019f20: 2c20 3131 3030 2e30 2c20 3131 3530 2e30  , 1100.0, 1150.0
+00019f30: 2c20 3132 3030 2e30 2c20 3132 3530 2e30  , 1200.0, 1250.0
+00019f40: 2c20 3133 3030 2e30 2c20 3133 3530 2e30  , 1300.0, 1350.0
+00019f50: 2c20 3134 3030 2e30 2c20 3134 3530 2e30  , 1400.0, 1450.0
+00019f60: 2c20 3135 3030 2e30 2c20 3135 3530 2e30  , 1500.0, 1550.0
+00019f70: 2c20 3136 3030 2e30 2c20 3136 3530 2e30  , 1600.0, 1650.0
+00019f80: 2c20 3137 3030 2e30 2c20 3137 3530 2e30  , 1700.0, 1750.0
+00019f90: 2c20 3138 3030 2e30 2c20 3138 3530 2e30  , 1800.0, 1850.0
+00019fa0: 2c20 3139 3030 2e30 2c20 3139 3530 2e30  , 1900.0, 1950.0
+00019fb0: 2c20 3230 3030 2e30 2c20 3231 3030 2e30  , 2000.0, 2100.0
+00019fc0: 2c20 3232 3030 2e30 2c20 3233 3030 2e30  , 2200.0, 2300.0
+00019fd0: 2c20 3234 3030 2e30 2c20 3235 3030 2e30  , 2400.0, 2500.0
+00019fe0: 2c20 3236 3030 2e30 2c20 3237 3030 2e30  , 2600.0, 2700.0
+00019ff0: 2c20 3238 3030 2e30 2c20 3239 3030 2e30  , 2800.0, 2900.0
+0001a000: 2c20 3330 3030 2e30 2c20 3331 3030 2e30  , 3000.0, 3100.0
+0001a010: 2c20 3332 3030 2e30 2c20 3333 3030 2e30  , 3200.0, 3300.0
+0001a020: 2c20 3334 3030 2e30 2c20 3335 3030 2e30  , 3400.0, 3500.0
+0001a030: 2c20 3336 3030 2e30 2c20 3337 3030 2e30  , 3600.0, 3700.0
+0001a040: 2c20 3338 3030 2e30 2c20 3339 3030 2e30  , 3800.0, 3900.0
+0001a050: 2c20 3430 3030 2e30 2c20 3431 3030 2e30  , 4000.0, 4100.0
+0001a060: 2c20 3432 3030 2e30 2c20 3433 3030 2e30  , 4200.0, 4300.0
+0001a070: 2c20 3434 3030 2e30 2c20 3435 3030 2e30  , 4400.0, 4500.0
+0001a080: 2c20 3436 3030 2e30 2c20 3437 3030 2e30  , 4600.0, 4700.0
+0001a090: 2c20 3438 3030 2e30 2c20 3439 3030 2e30  , 4800.0, 4900.0
+0001a0a0: 2c20 3530 3030 2e30 5d0a 0a50 484f 454e  , 5000.0]..PHOEN
+0001a0b0: 4958 5f54 4546 4620 3d20 5b34 3030 2e2c  IX_TEFF = [400.,
+0001a0c0: 2020 3432 302e 2c20 3435 302e 2c20 3530    420., 450., 50
+0001a0d0: 302e 2c20 2035 3530 2e2c 2036 3030 2e2c  0.,  550., 600.,
+0001a0e0: 2020 3635 302e 2c20 3730 302e 2c20 2037    650., 700.,  7
+0001a0f0: 3530 2e2c 0a20 2020 2020 2020 3830 302e  50.,.       800.
+0001a100: 2c20 2038 3530 2e2c 2039 3030 2e2c 2039  ,  850., 900., 9
+0001a110: 3530 2e2c 2031 3030 302e 2c20 3130 3530  50., 1000., 1050
+0001a120: 2e2c 2031 3130 302e 2c20 3131 3530 2e2c  ., 1100., 1150.,
+0001a130: 2031 3230 302e 2c0a 2020 2020 2020 2031   1200.,.       1
+0001a140: 3330 302e 2c20 3134 3030 2e2c 2031 3530  300., 1400., 150
+0001a150: 302e 2c20 3136 3030 2e2c 2031 3730 302e  0., 1600., 1700.
+0001a160: 2c20 3138 3030 2e2c 2031 3930 302e 2c20  , 1800., 1900., 
+0001a170: 3230 3030 2e2c 2032 3130 302e 2c0a 2020  2000., 2100.,.  
+0001a180: 2020 2020 2032 3230 302e 2c20 3233 3030       2200., 2300
+0001a190: 2e2c 2032 3430 302e 2c20 3235 3030 2e2c  ., 2400., 2500.,
+0001a1a0: 2032 3630 302e 2c20 3237 3030 2e2c 2032   2600., 2700., 2
+0001a1b0: 3830 302e 2c20 3239 3030 2e2c 2033 3030  800., 2900., 300
+0001a1c0: 302e 2c0a 2020 2020 2020 2033 3130 302e  0.,.       3100.
+0001a1d0: 2c20 3332 3030 2e2c 2033 3330 302e 2c20  , 3200., 3300., 
+0001a1e0: 3334 3030 2e2c 2033 3530 302e 2c20 3336  3400., 3500., 36
+0001a1f0: 3030 2e2c 2033 3730 302e 2c20 3338 3030  00., 3700., 3800
+0001a200: 2e2c 2033 3930 302e 2c20 3430 3030 2e2c  ., 3900., 4000.,
+0001a210: 0a20 2020 2020 2020 3432 3030 2e2c 2034  .       4200., 4
+0001a220: 3430 302e 2c20 3436 3030 2e2c 2034 3830  400., 4600., 480
+0001a230: 302e 2c20 3530 3030 2e2c 2035 3530 302e  0., 5000., 5500.
+0001a240: 2c20 3535 3030 2c20 3630 3030 2e2c 2036  , 5500, 6000., 6
+0001a250: 3530 302e 2c20 3730 3030 2e5d 0a0a 5048  500., 7000.]..PH
+0001a260: 4f45 4e49 585f 5a4d 4554 5f46 554c 4c20  OENIX_ZMET_FULL 
+0001a270: 3d20 5b2d 322e 352c 202d 322e 302c 202d  = [-2.5, -2.0, -
+0001a280: 312e 352c 202d 312e 302c 202d 302e 352c  1.5, -1.0, -0.5,
+0001a290: 202d 302e 2c20 302e 355d 0a50 484f 454e   -0., 0.5].PHOEN
+0001a2a0: 4958 5f5a 4d45 5420 3d20 5b2d 312e 302c  IX_ZMET = [-1.0,
+0001a2b0: 202d 302e 352c 202d 302e 5d0a 0a0a 6465   -0.5, -0.]...de
+0001a2c0: 6620 6c6f 6164 5f70 686f 656e 6978 5f73  f load_phoenix_s
+0001a2d0: 7461 7273 286c 6f67 675f 6c69 7374 3d50  tars(logg_list=P
+0001a2e0: 484f 454e 4958 5f4c 4f47 472c 2074 6566  HOENIX_LOGG, tef
+0001a2f0: 665f 6c69 7374 3d50 484f 454e 4958 5f54  f_list=PHOENIX_T
+0001a300: 4546 462c 207a 6d65 745f 6c69 7374 3d50  EFF, zmet_list=P
+0001a310: 484f 454e 4958 5f5a 4d45 542c 2061 6464  HOENIX_ZMET, add
+0001a320: 5f63 6172 626f 6e5f 7374 6172 3d54 7275  _carbon_star=Tru
+0001a330: 652c 2066 696c 653d 2762 742d 7365 7474  e, file='bt-sett
+0001a340: 6c5f 7434 3030 2d37 3030 305f 6734 2e35  l_t400-7000_g4.5
+0001a350: 2e66 6974 7327 293a 0a20 2020 2022 2222  .fits'):.    """
+0001a360: 0a20 2020 204c 6f61 6420 5068 6f65 6e69  .    Load Phoeni
+0001a370: 7820 7374 656c 6c61 7220 7465 6d70 6c61  x stellar templa
+0001a380: 7465 730a 2020 2020 2222 220a 2020 2020  tes.    """.    
+0001a390: 6672 6f6d 2063 6f6c 6c65 6374 696f 6e73  from collections
+0001a3a0: 2069 6d70 6f72 7420 4f72 6465 7265 6444   import OrderedD
+0001a3b0: 6963 740a 2020 2020 7472 793a 0a20 2020  ict.    try:.   
+0001a3c0: 2020 2020 2066 726f 6d20 7572 6c6c 6962       from urllib
+0001a3d0: 2e72 6571 7565 7374 2069 6d70 6f72 7420  .request import 
+0001a3e0: 7572 6c72 6574 7269 6576 650a 2020 2020  urlretrieve.    
+0001a3f0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+0001a400: 6672 6f6d 2075 726c 6c69 6220 696d 706f  from urllib impo
+0001a410: 7274 2075 726c 7265 7472 6965 7665 0a0a  rt urlretrieve..
+0001a420: 2020 2020 2320 6669 6c65 3d27 6274 2d73      # file='bt-s
+0001a430: 6574 746c 5f74 3430 302d 3530 3030 5f67  ettl_t400-5000_g
+0001a440: 342e 352e 6669 7473 270a 2020 2020 2320  4.5.fits'.    # 
+0001a450: 6669 6c65 3d27 6274 2d73 6574 746c 5f74  file='bt-settl_t
+0001a460: 3430 302d 3335 3030 5f7a 302e 302e 6669  400-3500_z0.0.fi
+0001a470: 7473 270a 0a20 2020 2074 7279 3a0a 2020  ts'..    try:.  
+0001a480: 2020 2020 2020 6864 7520 3d20 7079 6669        hdu = pyfi
+0001a490: 7473 2e6f 7065 6e28 6f73 2e70 6174 682e  ts.open(os.path.
+0001a4a0: 6a6f 696e 2847 5249 5a4c 495f 5041 5448  join(GRIZLI_PATH
+0001a4b0: 2c20 2774 656d 706c 6174 6573 2f73 7461  , 'templates/sta
+0001a4c0: 7273 2f27 2c20 6669 6c65 2929 0a20 2020  rs/', file)).   
+0001a4d0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+0001a4e0: 2023 7572 6c20 3d20 2768 7474 7073 3a2f   #url = 'https:/
+0001a4f0: 2f73 332e 616d 617a 6f6e 6177 732e 636f  /s3.amazonaws.co
+0001a500: 6d2f 6772 697a 6c69 2f43 4f4e 4627 0a20  m/grizli/CONF'. 
+0001a510: 2020 2020 2020 2023 7572 6c20 3d20 2768         #url = 'h
+0001a520: 7474 7073 3a2f 2f65 7264 612e 6b75 2e64  ttps://erda.ku.d
+0001a530: 6b2f 7667 7269 642f 4761 6272 6965 6c25  k/vgrid/Gabriel%
+0001a540: 3230 4272 616d 6d65 722f 434f 4e46 270a  20Brammer/CONF'.
+0001a550: 2020 2020 2020 2020 7572 6c20 3d20 2827          url = ('
+0001a560: 6874 7470 733a 2f2f 7261 772e 6769 7468  https://raw.gith
+0001a570: 7562 7573 6572 636f 6e74 656e 742e 636f  ubusercontent.co
+0001a580: 6d2f 6762 7261 6d6d 6572 2f27 202b 0a20  m/gbrammer/' +. 
+0001a590: 2020 2020 2020 2020 2020 2020 2020 2767                'g
+0001a5a0: 7269 7a6c 692d 636f 6e66 6967 2f6d 6173  rizli-config/mas
+0001a5b0: 7465 7227 290a 0a20 2020 2020 2020 2070  ter')..        p
+0001a5c0: 7269 6e74 2827 4665 7463 6820 7b30 7d2f  rint('Fetch {0}/
+0001a5d0: 7b31 7d27 2e66 6f72 6d61 7428 7572 6c2c  {1}'.format(url,
+0001a5e0: 2066 696c 6529 290a 0a20 2020 2020 2020   file))..       
+0001a5f0: 2023 6f73 2e73 7973 7465 6d28 2777 6765   #os.system('wge
+0001a600: 7420 2d4f 202f 746d 702f 7b31 7d20 7b30  t -O /tmp/{1} {0
+0001a610: 7d2f 7b31 7d27 2e66 6f72 6d61 7428 7572  }/{1}'.format(ur
+0001a620: 6c2c 2066 696c 6529 290a 2020 2020 2020  l, file)).      
+0001a630: 2020 7265 7320 3d20 7572 6c72 6574 7269    res = urlretri
+0001a640: 6576 6528 277b 307d 2f7b 317d 272e 666f  eve('{0}/{1}'.fo
+0001a650: 726d 6174 2875 726c 2c20 6669 6c65 292c  rmat(url, file),
+0001a660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a670: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+0001a680: 616d 653d 6f73 2e70 6174 682e 6a6f 696e  ame=os.path.join
+0001a690: 2827 2f74 6d70 272c 2066 696c 6529 290a  ('/tmp', file)).
+0001a6a0: 0a20 2020 2020 2020 2068 6475 203d 2070  .        hdu = p
+0001a6b0: 7966 6974 732e 6f70 656e 286f 732e 7061  yfits.open(os.pa
+0001a6c0: 7468 2e6a 6f69 6e28 272f 746d 702f 272c  th.join('/tmp/',
+0001a6d0: 2066 696c 6529 290a 0a20 2020 2074 6162   file))..    tab
+0001a6e0: 203d 2047 5461 626c 652e 6772 6561 6428   = GTable.gread(
+0001a6f0: 6864 755b 315d 290a 2020 2020 6864 752e  hdu[1]).    hdu.
+0001a700: 636c 6f73 6528 290a 2020 2020 0a20 2020  close().    .   
+0001a710: 2074 7374 6172 7320 3d20 4f72 6465 7265   tstars = Ordere
+0001a720: 6444 6963 7428 290a 2020 2020 4e20 3d20  dDict().    N = 
+0001a730: 7461 625b 2766 6c75 7827 5d2e 7368 6170  tab['flux'].shap
+0001a740: 655b 315d 0a20 2020 2066 6f72 2069 2069  e[1].    for i i
+0001a750: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
+0001a760: 2020 2020 7465 6666 203d 2074 6162 2e6d      teff = tab.m
+0001a770: 6574 615b 2754 4546 467b 303a 3033 647d  eta['TEFF{0:03d}
+0001a780: 272e 666f 726d 6174 2869 295d 0a20 2020  '.format(i)].   
+0001a790: 2020 2020 206c 6f67 6720 3d20 7461 622e       logg = tab.
+0001a7a0: 6d65 7461 5b27 4c4f 4747 7b30 3a30 3364  meta['LOGG{0:03d
+0001a7b0: 7d27 2e66 6f72 6d61 7428 6929 5d0a 2020  }'.format(i)].  
+0001a7c0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001a7d0: 2020 2020 2020 206d 6574 203d 2074 6162         met = tab
+0001a7e0: 2e6d 6574 615b 275a 4d45 547b 303a 3033  .meta['ZMET{0:03
+0001a7f0: 647d 272e 666f 726d 6174 2869 295d 0a20  d}'.format(i)]. 
+0001a800: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+0001a810: 2020 2020 2020 2020 2020 206d 6574 203d             met =
+0001a820: 2030 2e0a 0a20 2020 2020 2020 2069 6620   0...        if 
+0001a830: 286c 6f67 6720 6e6f 7420 696e 206c 6f67  (logg not in log
+0001a840: 675f 6c69 7374 2920 7c20 2874 6566 6620  g_list) | (teff 
+0001a850: 6e6f 7420 696e 2074 6566 665f 6c69 7374  not in teff_list
+0001a860: 2920 7c20 286d 6574 206e 6f74 2069 6e20  ) | (met not in 
+0001a870: 7a6d 6574 5f6c 6973 7429 3a0a 2020 2020  zmet_list):.    
+0001a880: 2020 2020 2020 2020 2370 7269 6e74 2827          #print('
+0001a890: 536b 6970 207b 307d 207b 317d 272e 666f  Skip {0} {1}'.fo
+0001a8a0: 726d 6174 286c 6f67 672c 2074 6566 6629  rmat(logg, teff)
+0001a8b0: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0001a8c0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+0001a8d0: 6c61 6265 6c20 3d20 2762 742d 7365 7474  label = 'bt-sett
+0001a8e0: 6c5f 747b 303a 3035 2e30 667d 5f67 7b31  l_t{0:05.0f}_g{1
+0001a8f0: 3a33 2e31 667d 5f6d 7b32 3a2e 3166 7d27  :3.1f}_m{2:.1f}'
+0001a900: 2e66 6f72 6d61 7428 7465 6666 2c20 6c6f  .format(teff, lo
+0001a910: 6767 2c20 6d65 7429 0a0a 2020 2020 2020  gg, met)..      
+0001a920: 2020 7473 7461 7273 5b6c 6162 656c 5d20    tstars[label] 
+0001a930: 3d20 5370 6563 7472 756d 5465 6d70 6c61  = SpectrumTempla
+0001a940: 7465 2877 6176 653d 7461 625b 2777 6176  te(wave=tab['wav
+0001a950: 6527 5d2c 0a20 2020 2020 2020 2020 2020  e'],.           
+0001a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a970: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0001a980: 7578 3d74 6162 5b27 666c 7578 275d 5b3a  ux=tab['flux'][:
+0001a990: 2c20 695d 2c20 6e61 6d65 3d6c 6162 656c  , i], name=label
+0001a9a0: 290a 0a20 2020 2069 6620 6164 645f 6361  )..    if add_ca
+0001a9b0: 7262 6f6e 5f73 7461 723a 0a20 2020 2020  rbon_star:.     
+0001a9c0: 2020 2063 6669 6c65 203d 206f 732e 7061     cfile = os.pa
+0001a9d0: 7468 2e6a 6f69 6e28 4752 495a 4c49 5f50  th.join(GRIZLI_P
+0001a9e0: 4154 482c 2027 7465 6d70 6c61 7465 732f  ATH, 'templates/
+0001a9f0: 7374 6172 732f 6361 7262 6f6e 5f73 7461  stars/carbon_sta
+0001aa00: 722e 7478 7427 290a 2020 2020 2020 2020  r.txt').        
+0001aa10: 7370 203d 2072 6561 645f 6361 7461 6c6f  sp = read_catalo
+0001aa20: 6728 6366 696c 6529 0a20 2020 2020 2020  g(cfile).       
+0001aa30: 2069 6620 6164 645f 6361 7262 6f6e 5f73   if add_carbon_s
+0001aa40: 7461 7220 3e20 313a 0a20 2020 2020 2020  tar > 1:.       
+0001aa50: 2020 2020 2069 6d70 6f72 7420 7363 6970       import scip
+0001aa60: 792e 6e64 696d 6167 6520 6173 206e 640a  y.ndimage as nd.
+0001aa70: 2020 2020 2020 2020 2020 2020 6366 6c75              cflu
+0001aa80: 7820 3d20 6e64 2e67 6175 7373 6961 6e5f  x = nd.gaussian_
+0001aa90: 6669 6c74 6572 2873 705b 2766 6c75 7827  filter(sp['flux'
+0001aaa0: 5d2c 2061 6464 5f63 6172 626f 6e5f 7374  ], add_carbon_st
+0001aab0: 6172 290a 2020 2020 2020 2020 656c 7365  ar).        else
+0001aac0: 3a0a 2020 2020 2020 2020 2020 2020 6366  :.            cf
+0001aad0: 6c75 7820 3d20 7370 5b27 666c 7578 275d  lux = sp['flux']
+0001aae0: 0a0a 2020 2020 2020 2020 7473 7461 7273  ..        tstars
+0001aaf0: 5b27 6274 2d73 6574 746c 5f74 3035 3030  ['bt-settl_t0500
+0001ab00: 305f 6730 2e30 5f6d 302e 3027 5d20 3d20  0_g0.0_m0.0'] = 
+0001ab10: 5370 6563 7472 756d 5465 6d70 6c61 7465  SpectrumTemplate
+0001ab20: 2877 6176 653d 7370 5b27 7761 7665 275d  (wave=sp['wave']
+0001ab30: 2c20 666c 7578 3d63 666c 7578 2c20 6e61  , flux=cflux, na
+0001ab40: 6d65 3d27 6361 7262 6f6e 2d6c 616e 636f  me='carbon-lanco
+0001ab50: 6e32 3030 3227 290a 0a20 2020 2072 6574  n2002')..    ret
+0001ab60: 7572 6e20 7473 7461 7273 0a0a 0a64 6566  urn tstars...def
+0001ab70: 206c 6f61 645f 7364 7373 5f70 6361 5f74   load_sdss_pca_t
+0001ab80: 656d 706c 6174 6573 2866 696c 653d 2773  emplates(file='s
+0001ab90: 7045 6967 656e 5153 4f2d 3535 3733 322e  pEigenQSO-55732.
+0001aba0: 6669 7473 272c 2073 6d6f 6f74 683d 3330  fits', smooth=30
+0001abb0: 3030 293a 0a20 2020 2022 2222 0a20 2020  00):.    """.   
+0001abc0: 204c 6f61 6420 5344 5353 2065 6967 656e   Load SDSS eigen
+0001abd0: 2074 656d 706c 6174 6573 0a20 2020 2022   templates.    "
+0001abe0: 2222 0a20 2020 2066 726f 6d20 636f 6c6c  "".    from coll
+0001abf0: 6563 7469 6f6e 7320 696d 706f 7274 204f  ections import O
+0001ac00: 7264 6572 6564 4469 6374 0a20 2020 2069  rderedDict.    i
+0001ac10: 6d70 6f72 7420 7363 6970 792e 6e64 696d  mport scipy.ndim
+0001ac20: 6167 6520 6173 206e 640a 0a20 2020 2069  age as nd..    i
+0001ac30: 6d20 3d20 7079 6669 7473 2e6f 7065 6e28  m = pyfits.open(
+0001ac40: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
+0001ac50: 5a4c 495f 5041 5448 2c20 2774 656d 706c  ZLI_PATH, 'templ
+0001ac60: 6174 6573 272c 2066 696c 6529 290a 2020  ates', file)).  
+0001ac70: 2020 6820 3d20 696d 5b30 5d2e 6865 6164    h = im[0].head
+0001ac80: 6572 0a20 2020 206c 6f67 5f77 6176 6520  er.    log_wave 
+0001ac90: 3d20 6e70 2e61 7261 6e67 6528 685b 274e  = np.arange(h['N
+0001aca0: 4158 4953 3127 5d29 2a68 5b27 434f 4546  AXIS1'])*h['COEF
+0001acb0: 4631 275d 2b68 5b27 434f 4546 4630 275d  F1']+h['COEFF0']
+0001acc0: 0a20 2020 2077 6176 6520 3d20 3130 2a2a  .    wave = 10**
+0001acd0: 6c6f 675f 7761 7665 0a0a 2020 2020 6e61  log_wave..    na
+0001ace0: 6d65 203d 2066 696c 652e 7370 6c69 7428  me = file.split(
+0001acf0: 272e 6669 7473 2729 5b30 5d0a 0a20 2020  '.fits')[0]..   
+0001ad00: 2069 6620 736d 6f6f 7468 203e 2030 3a0a   if smooth > 0:.
+0001ad10: 2020 2020 2020 2020 6476 5f69 6e20 3d20          dv_in = 
+0001ad20: 685b 2743 4f45 4646 3127 5d2a 332e 6535  h['COEFF1']*3.e5
+0001ad30: 0a20 2020 2020 2020 206e 203d 2073 6d6f  .        n = smo
+0001ad40: 6f74 6820 2f20 6476 5f69 6e0a 2020 2020  oth / dv_in.    
+0001ad50: 2020 2020 6461 7461 203d 206e 642e 6761      data = nd.ga
+0001ad60: 7573 7369 616e 5f66 696c 7465 7231 6428  ussian_filter1d(
+0001ad70: 696d 5b30 5d2e 6461 7461 2c20 6e2c 2061  im[0].data, n, a
+0001ad80: 7869 733d 3129 2e61 7374 7970 6528 6e70  xis=1).astype(np
+0001ad90: 2e66 6c6f 6174 3634 290a 2020 2020 2020  .float64).      
+0001ada0: 2020 736b 6970 203d 2069 6e74 286e 2f32    skip = int(n/2
+0001adb0: 2e35 290a 2020 2020 2020 2020 7761 7665  .5).        wave
+0001adc0: 203d 2077 6176 655b 3a3a 736b 6970 5d0a   = wave[::skip].
+0001add0: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
+0001ade0: 6174 615b 3a2c 203a 3a73 6b69 705d 0a20  ata[:, ::skip]. 
+0001adf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001ae00: 2064 6174 6120 3d20 696d 5b30 5d2e 6461   data = im[0].da
+0001ae10: 7461 2e61 7374 7970 6528 6e70 2e66 6c6f  ta.astype(np.flo
+0001ae20: 6174 3634 290a 0a20 2020 204e 203d 2068  at64)..    N = h
+0001ae30: 5b27 4e41 5849 5332 275d 0a20 2020 2074  ['NAXIS2'].    t
+0001ae40: 656d 705f 6c69 7374 203d 204f 7264 6572  emp_list = Order
+0001ae50: 6564 4469 6374 2829 0a20 2020 2066 6f72  edDict().    for
+0001ae60: 2069 2069 6e20 7261 6e67 6528 4e29 3a0a   i in range(N):.
+0001ae70: 2020 2020 2020 2020 7465 6d70 5f6c 6973          temp_lis
+0001ae80: 745b 277b 307d 207b 317d 272e 666f 726d  t['{0} {1}'.form
+0001ae90: 6174 286e 616d 652c 2069 2b31 295d 203d  at(name, i+1)] =
+0001aea0: 2053 7065 6374 7275 6d54 656d 706c 6174   SpectrumTemplat
+0001aeb0: 6528 7761 7665 3d77 6176 652c 2066 6c75  e(wave=wave, flu
+0001aec0: 783d 6461 7461 5b69 2c20 3a5d 290a 2020  x=data[i, :]).  
+0001aed0: 2020 0a20 2020 2069 6d2e 636c 6f73 6528    .    im.close(
+0001aee0: 290a 2020 2020 0a20 2020 2072 6574 7572  ).    .    retur
+0001aef0: 6e20 7465 6d70 5f6c 6973 740a 0a0a 6465  n temp_list...de
+0001af00: 6620 6368 6562 5f74 656d 706c 6174 6573  f cheb_templates
+0001af10: 2877 6176 652c 206f 7264 6572 3d36 2c20  (wave, order=6, 
+0001af20: 6765 745f 6d61 7472 6978 3d46 616c 7365  get_matrix=False
+0001af30: 2c20 6c6f 673d 4661 6c73 652c 2063 6c69  , log=False, cli
+0001af40: 703d 312e 652d 342c 206d 696e 6d61 783d  p=1.e-4, minmax=
+0001af50: 4e6f 6e65 293a 0a20 2020 2022 2222 0a20  None):.    """. 
+0001af60: 2020 2043 6865 6279 7368 6576 2070 6f6c     Chebyshev pol
+0001af70: 796e 6f6d 6961 6c20 6261 7369 7320 6675  ynomial basis fu
+0001af80: 6e63 7469 6f6e 730a 2020 2020 2222 220a  nctions.    """.
+0001af90: 2020 2020 6672 6f6d 206e 756d 7079 2e70      from numpy.p
+0001afa0: 6f6c 796e 6f6d 6961 6c2e 6368 6562 7973  olynomial.chebys
+0001afb0: 6865 7620 696d 706f 7274 2063 6865 6276  hev import chebv
+0001afc0: 616c 2c20 6368 6562 7661 6e64 6572 0a0a  al, chebvander..
+0001afd0: 2020 2020 6966 206d 696e 6d61 7820 6973      if minmax is
+0001afe0: 204e 6f6e 653a 0a20 2020 2020 2020 206d   None:.        m
+0001aff0: 6920 3d20 7761 7665 2e6d 696e 2829 0a20  i = wave.min(). 
+0001b000: 2020 2020 2020 206d 6120 3d20 7761 7665         ma = wave
+0001b010: 2e6d 6178 2829 0a20 2020 2065 6c73 653a  .max().    else:
+0001b020: 0a20 2020 2020 2020 206d 692c 206d 6120  .        mi, ma 
+0001b030: 3d20 6e70 2e73 7175 6565 7a65 286d 696e  = np.squeeze(min
+0001b040: 6d61 7829 2a31 2e0a 0a20 2020 2069 6620  max)*1...    if 
+0001b050: 6c6f 673a 0a20 2020 2020 2020 2078 6920  log:.        xi 
+0001b060: 3d20 6e70 2e6c 6f67 2877 6176 6529 0a20  = np.log(wave). 
+0001b070: 2020 2020 2020 206d 6920 3d20 6e70 2e6c         mi = np.l
+0001b080: 6f67 286d 6929 0a20 2020 2020 2020 206d  og(mi).        m
+0001b090: 6120 3d20 6e70 2e6c 6f67 286d 6129 0a20  a = np.log(ma). 
+0001b0a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001b0b0: 2078 6920 3d20 7761 7665 2a31 0a20 2020   xi = wave*1.   
+0001b0c0: 200a 2020 2020 7820 3d20 2878 692d 6d69   .    x = (xi-mi
+0001b0d0: 292a 322f 286d 612d 6d69 292d 310a 0a20  )*2/(ma-mi)-1.. 
+0001b0e0: 2020 206e 5f62 6173 6573 203d 206f 7264     n_bases = ord
+0001b0f0: 6572 2b31 0a20 2020 200a 2020 2020 6261  er+1.    .    ba
+0001b100: 7369 7320 3d20 6368 6562 7661 6e64 6572  sis = chebvander
+0001b110: 2878 2c20 6f72 6465 7229 0a20 2020 2023  (x, order).    #
+0001b120: 2062 6173 6973 203d 206e 702e 656d 7074   basis = np.empt
+0001b130: 7928 2878 2e73 6861 7065 5b30 5d2c 206e  y((x.shape[0], n
+0001b140: 5f62 6173 6573 292c 2064 7479 7065 3d66  _bases), dtype=f
+0001b150: 6c6f 6174 290a 2020 2020 2320 0a20 2020  loat).    # .   
+0001b160: 2023 2078 7220 3d20 6e70 2e61 7261 6e67   # xr = np.arang
+0001b170: 6528 6e5f 6261 7365 7329 0a20 2020 2023  e(n_bases).    #
+0001b180: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0001b190: 6e5f 6261 7365 7329 3a0a 2020 2020 2320  n_bases):.    # 
+0001b1a0: 2020 2020 5f63 203d 2028 7872 203d 3d20      _c = (xr == 
+0001b1b0: 6929 2a31 0a20 2020 2023 2020 2020 2023  i)*1.    #     #
+0001b1c0: 7072 696e 7428 5f63 2c20 7872 2c20 6929  print(_c, xr, i)
+0001b1d0: 0a20 2020 2023 2020 2020 2062 6173 6973  .    #     basis
+0001b1e0: 5b3a 2c69 5d20 3d20 6368 6562 7661 6c28  [:,i] = chebval(
+0001b1f0: 782c 205f 6329 0a20 2020 2020 2020 200a  x, _c).        .
+0001b200: 2020 2020 2366 6f72 2069 2069 6e20 7261      #for i in ra
+0001b210: 6e67 6528 6e5f 6261 7365 7329 3a0a 2020  nge(n_bases):.  
+0001b220: 2020 6f75 745f 6f66 5f72 616e 6765 203d    out_of_range =
+0001b230: 2028 7869 203c 206d 6929 207c 2028 7869   (xi < mi) | (xi
+0001b240: 203e 206d 6129 0a20 2020 2062 6173 6973   > ma).    basis
+0001b250: 5b6f 7574 5f6f 665f 7261 6e67 652c 3a5d  [out_of_range,:]
+0001b260: 203d 2030 0a0a 2020 2020 6966 2067 6574   = 0..    if get
+0001b270: 5f6d 6174 7269 783a 0a20 2020 2020 2020  _matrix:.       
+0001b280: 2072 6574 7572 6e20 6261 7369 730a 0a20   return basis.. 
+0001b290: 2020 2074 656d 7020 3d20 4f72 6465 7265     temp = Ordere
+0001b2a0: 6444 6963 7428 290a 2020 2020 666f 7220  dDict().    for 
+0001b2b0: 6920 696e 2072 616e 6765 286e 5f62 6173  i in range(n_bas
+0001b2c0: 6573 293a 0a20 2020 2020 2020 206b 6579  es):.        key
+0001b2d0: 203d 2066 2763 6865 6220 6f7b 697d 270a   = f'cheb o{i}'.
+0001b2e0: 2020 2020 2020 2020 7465 6d70 5b6b 6579          temp[key
+0001b2f0: 5d20 3d20 5370 6563 7472 756d 5465 6d70  ] = SpectrumTemp
+0001b300: 6c61 7465 2877 6176 652c 2062 6173 6973  late(wave, basis
+0001b310: 5b3a 2c69 5d29 0a20 2020 2020 2020 2074  [:,i]).        t
+0001b320: 656d 705b 6b65 795d 2e6e 616d 6520 3d20  emp[key].name = 
+0001b330: 6b65 790a 0a20 2020 2072 6574 7572 6e20  key..    return 
+0001b340: 7465 6d70 0a20 2020 200a 6465 6620 6273  temp.    .def bs
+0001b350: 706c 696e 655f 7465 6d70 6c61 7465 7328  pline_templates(
+0001b360: 7761 7665 2c20 6465 6772 6565 3d33 2c20  wave, degree=3, 
+0001b370: 6466 3d36 2c20 6765 745f 6d61 7472 6978  df=6, get_matrix
+0001b380: 3d46 616c 7365 2c20 6c6f 673d 4661 6c73  =False, log=Fals
+0001b390: 652c 2063 6c69 703d 312e 652d 342c 206d  e, clip=1.e-4, m
+0001b3a0: 696e 6d61 783d 4e6f 6e65 293a 0a20 2020  inmax=None):.   
+0001b3b0: 2022 2222 0a20 2020 2042 2d73 706c 696e   """.    B-splin
+0001b3c0: 6520 6261 7369 7320 6675 6e63 7469 6f6e  e basis function
+0001b3d0: 732c 206d 6f64 656c 6564 2061 6674 6572  s, modeled after
+0001b3e0: 2060 7e70 6174 7379 2e73 706c 696e 6573   `~patsy.splines
+0001b3f0: 600a 2020 2020 2222 220a 2020 2020 6672  `.    """.    fr
+0001b400: 6f6d 2073 6369 7079 2e69 6e74 6572 706f  om scipy.interpo
+0001b410: 6c61 7465 2069 6d70 6f72 7420 7370 6c65  late import sple
+0001b420: 760a 0a20 2020 206f 7264 6572 203d 2064  v..    order = d
+0001b430: 6567 7265 652b 310a 2020 2020 6e5f 696e  egree+1.    n_in
+0001b440: 6e65 725f 6b6e 6f74 7320 3d20 6466 202d  ner_knots = df -
+0001b450: 206f 7264 6572 0a20 2020 2069 6e6e 6572   order.    inner
+0001b460: 5f6b 6e6f 7473 203d 206e 702e 6c69 6e73  _knots = np.lins
+0001b470: 7061 6365 2830 2c20 312c 206e 5f69 6e6e  pace(0, 1, n_inn
+0001b480: 6572 5f6b 6e6f 7473 202b 2032 295b 313a  er_knots + 2)[1:
+0001b490: 2d31 5d0a 0a20 2020 206e 6f72 6d5f 6b6e  -1]..    norm_kn
+0001b4a0: 6f74 7320 3d20 6e70 2e63 6f6e 6361 7465  ots = np.concate
+0001b4b0: 6e61 7465 2828 5b30 2c20 315d 202a 206f  nate(([0, 1] * o
+0001b4c0: 7264 6572 2c0a 2020 2020 2020 2020 2020  rder,.          
+0001b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4e0: 2020 2020 2020 696e 6e65 725f 6b6e 6f74        inner_knot
+0001b4f0: 7329 290a 2020 2020 6e6f 726d 5f6b 6e6f  s)).    norm_kno
+0001b500: 7473 2e73 6f72 7428 290a 0a20 2020 2069  ts.sort()..    i
+0001b510: 6620 6c6f 673a 0a20 2020 2020 2020 2078  f log:.        x
+0001b520: 7370 6c20 3d20 6e70 2e6c 6f67 2877 6176  spl = np.log(wav
+0001b530: 6529 0a20 2020 2065 6c73 653a 0a20 2020  e).    else:.   
+0001b540: 2020 2020 2078 7370 6c20 3d20 7761 7665       xspl = wave
+0001b550: 2a31 0a0a 2020 2020 6966 206d 696e 6d61  *1..    if minma
+0001b560: 7820 6973 204e 6f6e 653a 0a20 2020 2020  x is None:.     
+0001b570: 2020 206d 6920 3d20 7873 706c 2e6d 696e     mi = xspl.min
+0001b580: 2829 0a20 2020 2020 2020 206d 6120 3d20  ().        ma = 
+0001b590: 7873 706c 2e6d 6178 2829 0a20 2020 2065  xspl.max().    e
+0001b5a0: 6c73 653a 0a20 2020 2020 2020 206d 692c  lse:.        mi,
+0001b5b0: 206d 6120 3d20 6d69 6e6d 6178 0a0a 2020   ma = minmax..  
+0001b5c0: 2020 7769 6474 6820 3d20 6d61 2d6d 690a    width = ma-mi.
+0001b5d0: 2020 2020 616c 6c5f 6b6e 6f74 7320 3d20      all_knots = 
+0001b5e0: 6e6f 726d 5f6b 6e6f 7473 2a77 6964 7468  norm_knots*width
+0001b5f0: 2b6d 690a 0a20 2020 206e 5f62 6173 6573  +mi..    n_bases
+0001b600: 203d 206c 656e 2861 6c6c 5f6b 6e6f 7473   = len(all_knots
+0001b610: 2920 2d20 2864 6567 7265 6520 2b20 3129  ) - (degree + 1)
+0001b620: 0a20 2020 2062 6173 6973 203d 206e 702e  .    basis = np.
+0001b630: 656d 7074 7928 2878 7370 6c2e 7368 6170  empty((xspl.shap
+0001b640: 655b 305d 2c20 6e5f 6261 7365 7329 2c20  e[0], n_bases), 
+0001b650: 6474 7970 653d 666c 6f61 7429 0a0a 2020  dtype=float)..  
+0001b660: 2020 636f 6566 7320 3d20 6e70 2e69 6465    coefs = np.ide
+0001b670: 6e74 6974 7928 6e5f 6261 7365 7329 0a20  ntity(n_bases). 
+0001b680: 2020 2062 6173 6973 203d 2073 706c 6576     basis = splev
+0001b690: 2878 7370 6c2c 2028 616c 6c5f 6b6e 6f74  (xspl, (all_knot
+0001b6a0: 732c 2063 6f65 6673 2c20 6465 6772 6565  s, coefs, degree
+0001b6b0: 2929 0a0a 2020 2020 666f 7220 6920 696e  ))..    for i in
+0001b6c0: 2072 616e 6765 286e 5f62 6173 6573 293a   range(n_bases):
+0001b6d0: 0a20 2020 2020 2020 206f 7574 5f6f 665f  .        out_of_
+0001b6e0: 7261 6e67 6520 3d20 2878 7370 6c20 3c20  range = (xspl < 
+0001b6f0: 6d69 2920 7c20 2878 7370 6c20 3e20 6d61  mi) | (xspl > ma
+0001b700: 290a 2020 2020 2020 2020 6261 7369 735b  ).        basis[
+0001b710: 695d 5b6f 7574 5f6f 665f 7261 6e67 655d  i][out_of_range]
+0001b720: 203d 2030 0a0a 2020 2020 7761 7665 5f70   = 0..    wave_p
+0001b730: 6561 6b20 3d20 6e70 2e72 6f75 6e64 2877  eak = np.round(w
+0001b740: 6176 655b 6e70 2e61 7267 6d61 7828 6261  ave[np.argmax(ba
+0001b750: 7369 732c 2061 7869 733d 3129 5d29 0a0a  sis, axis=1)])..
+0001b760: 2020 2020 6d61 7876 616c 203d 206e 702e      maxval = np.
+0001b770: 6d61 7828 6261 7369 732c 2061 7869 733d  max(basis, axis=
+0001b780: 3129 0a20 2020 2066 6f72 2069 2069 6e20  1).    for i in 
+0001b790: 7261 6e67 6528 6e5f 6261 7365 7329 3a0a  range(n_bases):.
+0001b7a0: 2020 2020 2020 2020 6261 7369 735b 695d          basis[i]
+0001b7b0: 5b62 6173 6973 5b69 5d20 3c20 636c 6970  [basis[i] < clip
+0001b7c0: 2a6d 6178 7661 6c5b 695d 5d20 3d20 300a  *maxval[i]] = 0.
+0001b7d0: 0a20 2020 2069 6620 6765 745f 6d61 7472  .    if get_matr
+0001b7e0: 6978 3a0a 2020 2020 2020 2020 7265 7475  ix:.        retu
+0001b7f0: 726e 206e 702e 7673 7461 636b 2862 6173  rn np.vstack(bas
+0001b800: 6973 292e 540a 0a20 2020 2074 656d 7020  is).T..    temp 
+0001b810: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+0001b820: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0001b830: 6765 286e 5f62 6173 6573 293a 0a20 2020  ge(n_bases):.   
+0001b840: 2020 2020 206b 6579 203d 2027 6273 706c       key = 'bspl
+0001b850: 207b 307d 207b 313a 2e30 667d 272e 666f   {0} {1:.0f}'.fo
+0001b860: 726d 6174 2869 2c20 7761 7665 5f70 6561  rmat(i, wave_pea
+0001b870: 6b5b 695d 290a 2020 2020 2020 2020 7465  k[i]).        te
+0001b880: 6d70 5b6b 6579 5d20 3d20 5370 6563 7472  mp[key] = Spectr
+0001b890: 756d 5465 6d70 6c61 7465 2877 6176 652c  umTemplate(wave,
+0001b8a0: 2062 6173 6973 5b69 5d29 0a20 2020 2020   basis[i]).     
+0001b8b0: 2020 2074 656d 705b 6b65 795d 2e6e 616d     temp[key].nam
+0001b8c0: 6520 3d20 6b65 790a 2020 2020 2020 2020  e = key.        
+0001b8d0: 7465 6d70 5b6b 6579 5d2e 7761 7665 5f70  temp[key].wave_p
+0001b8e0: 6561 6b20 3d20 7761 7665 5f70 6561 6b5b  eak = wave_peak[
+0001b8f0: 695d 0a0a 2020 2020 7465 6d70 2e6b 6e6f  i]..    temp.kno
+0001b900: 7473 203d 2061 6c6c 5f6b 6e6f 7473 0a20  ts = all_knots. 
+0001b910: 2020 2074 656d 702e 6465 6772 6565 203d     temp.degree =
+0001b920: 2064 6567 7265 650a 2020 2020 7465 6d70   degree.    temp
+0001b930: 2e78 7370 6c20 3d20 7873 706c 0a0a 2020  .xspl = xspl..  
+0001b940: 2020 7265 7475 726e 2074 656d 700a 0a0a    return temp...
+0001b950: 6465 6620 6576 616c 5f62 7370 6c69 6e65  def eval_bspline
+0001b960: 5f74 656d 706c 6174 6573 2877 6176 652c  _templates(wave,
+0001b970: 2062 7370 6c2c 2063 6f65 6673 293a 0a20   bspl, coefs):. 
+0001b980: 2020 2066 726f 6d20 7363 6970 792e 696e     from scipy.in
+0001b990: 7465 7270 6f6c 6174 6520 696d 706f 7274  terpolate import
+0001b9a0: 2073 706c 6576 0a0a 2020 2020 7873 706c   splev..    xspl
+0001b9b0: 203d 206e 702e 6c6f 6728 7761 7665 290a   = np.log(wave).
+0001b9c0: 2020 2020 6261 7369 7320 3d20 7370 6c65      basis = sple
+0001b9d0: 7628 7873 706c 2c20 2862 7370 6c2e 6b6e  v(xspl, (bspl.kn
+0001b9e0: 6f74 732c 2063 6f65 6673 2c20 6273 706c  ots, coefs, bspl
+0001b9f0: 2e64 6567 7265 6529 290a 2020 2020 7265  .degree)).    re
+0001ba00: 7475 726e 206e 702e 6172 7261 7928 6261  turn np.array(ba
+0001ba10: 7369 7329 0a0a 0a64 6566 2073 706c 6974  sis)...def split
+0001ba20: 5f73 706c 696e 655f 7465 6d70 6c61 7465  _spline_template
+0001ba30: 2874 656d 706c 2c20 7761 7665 6c65 6e67  (templ, waveleng
+0001ba40: 7468 5f72 616e 6765 3d5b 3530 3030 2c20  th_range=[5000, 
+0001ba50: 322e 3465 345d 2c20 5273 706c 696e 653d  2.4e4], Rspline=
+0001ba60: 3130 2c20 6c6f 673d 5472 7565 293a 0a20  10, log=True):. 
+0001ba70: 2020 2022 2222 0a20 2020 204d 756c 7469     """.    Multi
+0001ba80: 706c 7920 6120 7369 6e67 6c65 2074 656d  ply a single tem
+0001ba90: 706c 6174 6520 6279 2073 706c 696e 6520  plate by spline 
+0001baa0: 6261 7365 7320 746f 2065 6666 6563 7469  bases to effecti
+0001bab0: 7665 6c79 2067 656e 6572 6174 6520 610a  vely generate a.
+0001bac0: 2020 2020 7370 6c69 6e65 206d 756c 7469      spline multi
+0001bad0: 706c 6963 6174 6976 6520 636f 7272 6563  plicative correc
+0001bae0: 7469 6f6e 2074 6861 7420 6361 6e20 6265  tion that can be
+0001baf0: 2066 6974 2077 6974 6820 6c69 6e65 6172   fit with linear
+0001bb00: 206c 6561 7374 0a20 2020 2073 7175 6172   least.    squar
+0001bb10: 6573 2e0a 0a20 2020 2050 6172 616d 6574  es...    Paramet
+0001bb20: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+0001bb30: 2d2d 0a0a 2020 2020 7465 6d70 6c20 3a20  --..    templ : 
+0001bb40: 607e 6772 697a 6c69 2e75 7469 6c73 2e53  `~grizli.utils.S
+0001bb50: 7065 6374 7275 6d54 656d 706c 6174 6560  pectrumTemplate`
+0001bb60: 0a20 2020 2020 2020 2054 656d 706c 6174  .        Templat
+0001bb70: 6520 746f 2073 706c 6974 2e0a 0a20 2020  e to split...   
+0001bb80: 2077 6176 656c 656e 6774 685f 7261 6e67   wavelength_rang
+0001bb90: 6520 3a20 5b66 6c6f 6174 2c20 666c 6f61  e : [float, floa
+0001bba0: 745d 0a20 2020 2020 2020 204c 696d 6974  t].        Limit
+0001bbb0: 2074 6865 2073 706c 696e 6573 2074 6f20   the splines to 
+0001bbc0: 7468 6973 2077 6176 656c 656e 6774 6820  this wavelength 
+0001bbd0: 7261 6e67 650a 0a20 2020 2052 7370 6c69  range..    Rspli
+0001bbe0: 6e65 203a 2066 6c6f 6174 0a20 2020 2020  ne : float.     
+0001bbf0: 2020 2045 6666 6563 7469 7665 2072 6573     Effective res
+0001bc00: 6f6c 7574 696f 6e2c 2052 3d64 6c61 6d62  olution, R=dlamb
+0001bc10: 6461 2f6c 616d 6264 612c 206f 6620 7468  da/lambda, of th
+0001bc20: 6520 7370 6c69 6e65 2063 6f72 7265 6374  e spline correct
+0001bc30: 696f 6e0a 2020 2020 2020 2020 6675 6e63  ion.        func
+0001bc40: 7469 6f6e 2e0a 0a20 2020 206c 6f67 203a  tion...    log :
+0001bc50: 2062 6f6f 6c0a 2020 2020 2020 2020 4c6f   bool.        Lo
+0001bc60: 672d 7370 6163 6564 2073 706c 696e 6573  g-spaced splines
+0001bc70: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+0001bc80: 2020 2d2d 2d2d 2d2d 2d0a 0a20 2020 2073    -------..    s
+0001bc90: 7465 6d70 203a 2064 6963 740a 0a20 2020  temp : dict..   
+0001bca0: 2020 2020 2044 6963 7469 6f6e 6172 7920       Dictionary 
+0001bcb0: 6f66 2073 706c 696e 652d 636f 6d70 6f6e  of spline-compon
+0001bcc0: 656e 7420 7465 6d70 6c61 7465 732c 2077  ent templates, w
+0001bcd0: 6974 6820 6164 6469 7469 6f6e 616c 2061  ith additional a
+0001bce0: 7474 7269 6275 7465 733a 0a0a 2020 2020  ttributes:..    
+0001bcf0: 2020 2020 2020 2020 7773 706c 696e 6520          wspline 
+0001bd00: 3d20 7761 7665 6c65 6e67 7468 206f 6620  = wavelength of 
+0001bd10: 7468 6520 7465 6d70 6c61 7465 7320 2f20  the templates / 
+0001bd20: 7370 6c69 6e65 2063 6f72 7265 6374 696f  spline correctio
+0001bd30: 6e0a 2020 2020 2020 2020 2020 2020 7473  n.            ts
+0001bd40: 706c 696e 6520 3d20 6d61 7472 6978 206f  pline = matrix o
+0001bd50: 6620 7468 6520 7370 6c69 6e65 2063 6f72  f the spline cor
+0001bd60: 7265 6374 696f 6e73 0a20 2020 2020 2020  rections.       
+0001bd70: 2020 2020 206b 6e6f 7473 2020 203d 2070       knots   = p
+0001bd80: 6561 6b20 7761 7665 6c65 6e67 6874 7320  eak wavelenghts 
+0001bd90: 6f66 2065 6163 6820 7370 6c69 6e65 2063  of each spline c
+0001bda0: 6f6d 706f 6e65 6e74 0a0a 2020 2020 2222  omponent..    ""
+0001bdb0: 220a 2020 2020 6672 6f6d 2063 6f6c 6c65  ".    from colle
+0001bdc0: 6374 696f 6e73 2069 6d70 6f72 7420 4f72  ctions import Or
+0001bdd0: 6465 7265 6444 6963 740a 2020 2020 6672  deredDict.    fr
+0001bde0: 6f6d 2067 7269 7a6c 6920 696d 706f 7274  om grizli import
+0001bdf0: 2075 7469 6c73 0a0a 2020 2020 6966 2046   utils..    if F
+0001be00: 616c 7365 3a0a 2020 2020 2020 2020 7374  alse:.        st
+0001be10: 6172 7320 3d20 7574 696c 732e 6c6f 6164  ars = utils.load
+0001be20: 5f74 656d 706c 6174 6573 2873 7461 7273  _templates(stars
+0001be30: 3d54 7275 6529 0a20 2020 2020 2020 2074  =True).        t
+0001be40: 656d 706c 203d 2073 7461 7273 5b27 7374  empl = stars['st
+0001be50: 6172 732f 4c31 2e30 2e74 7874 275d 0a0a  ars/L1.0.txt']..
+0001be60: 2020 2020 7773 706c 696e 6520 3d20 7465      wspline = te
+0001be70: 6d70 6c2e 7761 7665 0a0a 2020 2020 636c  mpl.wave..    cl
+0001be80: 6970 203d 2028 7773 706c 696e 6520 3e20  ip = (wspline > 
+0001be90: 7761 7665 6c65 6e67 7468 5f72 616e 6765  wavelength_range
+0001bea0: 5b30 5d29 2026 2028 7773 706c 696e 6520  [0]) & (wspline 
+0001beb0: 3c20 7761 7665 6c65 6e67 7468 5f72 616e  < wavelength_ran
+0001bec0: 6765 5b31 5d29 0a20 2020 2064 665f 7370  ge[1]).    df_sp
+0001bed0: 6c20 3d20 6c65 6e28 7574 696c 732e 6c6f  l = len(utils.lo
+0001bee0: 675f 7a67 7269 6428 7a72 3d77 6176 656c  g_zgrid(zr=wavel
+0001bef0: 656e 6774 685f 7261 6e67 652c 2064 7a3d  ength_range, dz=
+0001bf00: 312e 2f52 7370 6c69 6e65 2929 0a0a 2020  1./Rspline))..  
+0001bf10: 2020 7473 706c 696e 6520 3d20 7574 696c    tspline = util
+0001bf20: 732e 6273 706c 696e 655f 7465 6d70 6c61  s.bspline_templa
+0001bf30: 7465 7328 7773 706c 696e 655b 636c 6970  tes(wspline[clip
+0001bf40: 5d2c 2064 663d 6466 5f73 706c 2b32 2c20  ], df=df_spl+2, 
+0001bf50: 6c6f 673d 6c6f 672c 2063 6c69 703d 302e  log=log, clip=0.
+0001bf60: 3030 3031 2c20 6765 745f 6d61 7472 6978  0001, get_matrix
+0001bf70: 3d54 7275 6529 0a0a 2020 2020 6978 203d  =True)..    ix =
+0001bf80: 206e 702e 6172 676d 6178 2874 7370 6c69   np.argmax(tspli
+0001bf90: 6e65 2c20 6178 6973 3d30 290a 2020 2020  ne, axis=0).    
+0001bfa0: 6b6e 6f74 7320 3d20 7773 706c 696e 655b  knots = wspline[
+0001bfb0: 636c 6970 5d5b 6978 5d0a 0a20 2020 204e  clip][ix]..    N
+0001bfc0: 203d 2074 7370 6c69 6e65 2e73 6861 7065   = tspline.shape
+0001bfd0: 5b31 5d0a 2020 2020 7374 656d 7020 3d20  [1].    stemp = 
+0001bfe0: 4f72 6465 7265 6444 6963 7428 290a 2020  OrderedDict().  
+0001bff0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0001c000: 284e 293a 0a20 2020 2020 2020 206e 616d  (N):.        nam
+0001c010: 6520 3d20 277b 307d 207b 313a 2e32 667d  e = '{0} {1:.2f}
+0001c020: 272e 666f 726d 6174 2874 656d 706c 2e6e  '.format(templ.n
+0001c030: 616d 652c 206b 6e6f 7473 5b69 5d2f 312e  ame, knots[i]/1.
+0001c040: 6534 290a 2020 2020 2020 2020 7374 656d  e4).        stem
+0001c050: 705b 6e61 6d65 5d20 3d20 7574 696c 732e  p[name] = utils.
+0001c060: 5370 6563 7472 756d 5465 6d70 6c61 7465  SpectrumTemplate
+0001c070: 2877 6176 653d 7773 706c 696e 655b 636c  (wave=wspline[cl
+0001c080: 6970 5d2c 2066 6c75 783d 7465 6d70 6c2e  ip], flux=templ.
+0001c090: 666c 7578 5b63 6c69 705d 2a74 7370 6c69  flux[clip]*tspli
+0001c0a0: 6e65 5b3a 2c20 695d 2c20 6e61 6d65 3d6e  ne[:, i], name=n
+0001c0b0: 616d 6529 0a20 2020 2020 2020 2073 7465  ame).        ste
+0001c0c0: 6d70 5b6e 616d 655d 2e6b 6e6f 7420 3d20  mp[name].knot = 
+0001c0d0: 6b6e 6f74 735b 695d 0a0a 2020 2020 7374  knots[i]..    st
+0001c0e0: 656d 702e 7773 706c 696e 6520 3d20 7773  emp.wspline = ws
+0001c0f0: 706c 696e 655b 636c 6970 5d0a 2020 2020  pline[clip].    
+0001c100: 7374 656d 702e 7473 706c 696e 6520 3d20  stemp.tspline = 
+0001c110: 7473 706c 696e 650a 2020 2020 7374 656d  tspline.    stem
+0001c120: 702e 6b6e 6f74 7320 3d20 6b6e 6f74 730a  p.knots = knots.
+0001c130: 0a20 2020 2072 6574 7572 6e20 7374 656d  .    return stem
+0001c140: 700a 0a0a 6465 6620 7374 6570 5f74 656d  p...def step_tem
+0001c150: 706c 6174 6573 2877 6c69 6d3d 5b35 3030  plates(wlim=[500
+0001c160: 302c 2031 2e38 6534 5d2c 2062 696e 5f73  0, 1.8e4], bin_s
+0001c170: 7465 7073 3d4e 6f6e 652c 2052 3d33 302c  teps=None, R=30,
+0001c180: 2072 6f75 6e64 3d31 302c 2072 6573 743d   round=10, rest=
+0001c190: 4661 6c73 652c 2073 7065 6369 616c 3d4e  False, special=N
+0001c1a0: 6f6e 652c 206f 7264 6572 3d30 293a 0a20  one, order=0):. 
+0001c1b0: 2020 2022 2222 0a20 2020 2053 7465 702d     """.    Step-
+0001c1c0: 6675 6e63 7469 6f6e 2074 656d 706c 6174  function templat
+0001c1d0: 6573 2066 6f72 2065 6173 7920 6269 6e6e  es for easy binn
+0001c1e0: 696e 670a 2020 2020 2222 220a 2020 2020  ing.    """.    
+0001c1f0: 6966 2073 7065 6369 616c 203d 3d20 2744  if special == 'D
+0001c200: 6e34 3030 3027 3a0a 2020 2020 2020 2020  n4000':.        
+0001c210: 7265 7374 203d 2054 7275 650a 2020 2020  rest = True.    
+0001c220: 2020 2020 6269 6e5f 7374 6570 7320 3d20      bin_steps = 
+0001c230: 6e70 2e68 7374 6163 6b28 5b6e 702e 6172  np.hstack([np.ar
+0001c240: 616e 6765 2838 3530 2c20 3338 3439 2c20  ange(850, 3849, 
+0001c250: 3130 3029 2c0a 2020 2020 2020 2020 2020  100),.          
+0001c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c270: 2020 2020 5b33 3835 302c 2033 3935 302c      [3850, 3950,
+0001c280: 2034 3030 302c 2034 3130 305d 2c0a 2020   4000, 4100],.  
+0001c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2a0: 2020 2020 2020 2020 2020 2020 6e70 2e61              np.a
+0001c2b0: 7261 6e67 6528 3432 3030 2c20 312e 3765  range(4200, 1.7e
+0001c2c0: 342c 2031 3030 295d 290a 0a20 2020 2065  4, 100)])..    e
+0001c2d0: 6c69 6620 7370 6563 6961 6c20 3d3d 2027  lif special == '
+0001c2e0: 4434 3030 3027 3a0a 2020 2020 2020 2020  D4000':.        
+0001c2f0: 7265 7374 203d 2054 7275 650a 2020 2020  rest = True.    
+0001c300: 2020 2020 6269 6e5f 7374 6570 7320 3d20      bin_steps = 
+0001c310: 6e70 2e68 7374 6163 6b28 5b6e 702e 6172  np.hstack([np.ar
+0001c320: 616e 6765 2838 3530 2c20 3337 3439 2c20  ange(850, 3749, 
+0001c330: 3230 3029 2c0a 2020 2020 2020 2020 2020  200),.          
+0001c340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c350: 2020 2020 5b33 3735 302c 2033 3935 302c      [3750, 3950,
+0001c360: 2034 3035 302c 2034 3235 305d 2c0a 2020   4050, 4250],.  
+0001c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c380: 2020 2020 2020 2020 2020 2020 6e70 2e61              np.a
+0001c390: 7261 6e67 6528 3434 3530 2c20 312e 3765  range(4450, 1.7e
+0001c3a0: 342c 2032 3030 295d 290a 2020 2020 656c  4, 200)]).    el
+0001c3b0: 6966 2073 7065 6369 616c 206e 6f74 2069  if special not i
+0001c3c0: 6e20 5b27 4434 3030 3027 2c20 2744 6e34  n ['D4000', 'Dn4
+0001c3d0: 3030 3027 2c20 4e6f 6e65 5d3a 0a20 2020  000', None]:.   
+0001c3e0: 2020 2020 2070 7269 6e74 2827 7374 6570       print('step
+0001c3f0: 5f74 656d 706c 6174 6573 3a20 7b30 7d20  _templates: {0} 
+0001c400: 6e6f 7420 7265 636f 676e 697a 6564 2028  not recognized (
+0001c410: 6f70 7469 6f6e 7320 6172 6520 5c27 4434  options are \'D4
+0001c420: 3030 305c 272c 205c 2744 6e34 3030 305c  000\', \'Dn4000\
+0001c430: 272c 2061 6e64 204e 6f6e 6529 272e 666f  ', and None)'.fo
+0001c440: 726d 6174 2873 7065 6369 616c 2929 0a20  rmat(special)). 
+0001c450: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+0001c460: 0a0a 2020 2020 6966 2062 696e 5f73 7465  ..    if bin_ste
+0001c470: 7073 2069 7320 4e6f 6e65 3a0a 2020 2020  ps is None:.    
+0001c480: 2020 2020 6269 6e5f 7374 6570 7320 3d20      bin_steps = 
+0001c490: 6e70 2e72 6f75 6e64 286c 6f67 5f7a 6772  np.round(log_zgr
+0001c4a0: 6964 2877 6c69 6d2c 2031 2e2f 5229 2f72  id(wlim, 1./R)/r
+0001c4b0: 6f75 6e64 292a 726f 756e 640a 2020 2020  ound)*round.    
+0001c4c0: 656c 7365 3a0a 2020 2020 2020 2020 776c  else:.        wl
+0001c4d0: 696d 203d 205b 6269 6e5f 7374 6570 735b  im = [bin_steps[
+0001c4e0: 305d 2c20 6269 6e5f 7374 6570 735b 2d31  0], bin_steps[-1
+0001c4f0: 5d5d 0a0a 2020 2020 6473 203d 206e 702e  ]]..    ds = np.
+0001c500: 6469 6666 2862 696e 5f73 7465 7073 290a  diff(bin_steps).
+0001c510: 0a20 2020 2078 7370 6563 203d 206e 702e  .    xspec = np.
+0001c520: 6172 616e 6765 2877 6c69 6d5b 305d 2d64  arange(wlim[0]-d
+0001c530: 735b 305d 2c20 776c 696d 5b31 5d2b 6473  s[0], wlim[1]+ds
+0001c540: 5b2d 315d 290a 0a20 2020 2062 696e 5f6d  [-1])..    bin_m
+0001c550: 6964 203d 2062 696e 5f73 7465 7073 5b3a  id = bin_steps[:
+0001c560: 2d31 5d2b 6473 2f32 2e0a 0a20 2020 2073  -1]+ds/2...    s
+0001c570: 7465 705f 7465 6d70 6c20 3d20 7b7d 0a20  tep_templ = {}. 
+0001c580: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0001c590: 6528 6c65 6e28 6269 6e5f 7374 6570 7329  e(len(bin_steps)
+0001c5a0: 2d31 293a 0a0a 2020 2020 2020 2020 7973  -1):..        ys
+0001c5b0: 7065 6320 3d20 2828 7873 7065 6320 3e3d  pec = ((xspec >=
+0001c5c0: 2062 696e 5f73 7465 7073 5b69 5d29 2026   bin_steps[i]) &
+0001c5d0: 2028 7873 7065 6320 3c20 6269 6e5f 7374   (xspec < bin_st
+0001c5e0: 6570 735b 692b 315d 2929 2a31 0a0a 2020  eps[i+1]))*1..  
+0001c5f0: 2020 2020 2020 666f 7220 6f20 696e 2072        for o in r
+0001c600: 616e 6765 286f 7264 6572 2b31 293a 0a20  ange(order+1):. 
+0001c610: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0001c620: 203d 2027 7374 6570 207b 303a 2e30 667d   = 'step {0:.0f}
+0001c630: 2d7b 313a 2e30 667d 207b 327d 272e 666f  -{1:.0f} {2}'.fo
+0001c640: 726d 6174 2862 696e 5f73 7465 7073 5b69  rmat(bin_steps[i
+0001c650: 5d2c 2062 696e 5f73 7465 7073 5b69 2b31  ], bin_steps[i+1
+0001c660: 5d2c 206f 290a 2020 2020 2020 2020 2020  ], o).          
+0001c670: 2020 6966 2072 6573 743a 0a20 2020 2020    if rest:.     
+0001c680: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0001c690: 203d 2027 7227 2b6c 6162 656c 0a0a 2020   = 'r'+label..  
+0001c6a0: 2020 2020 2020 2020 2020 666c 7578 203d            flux =
+0001c6b0: 2028 2878 7370 6563 2d62 696e 5f6d 6964   ((xspec-bin_mid
+0001c6c0: 5b69 5d29 2f64 735b 695d 292a 2a6f 202a  [i])/ds[i])**o *
+0001c6d0: 2028 7973 7065 6320 3e20 3029 0a20 2020   (yspec > 0).   
+0001c6e0: 2020 2020 2020 2020 2073 7465 705f 7465           step_te
+0001c6f0: 6d70 6c5b 6c61 6265 6c5d 203d 2053 7065  mpl[label] = Spe
+0001c700: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+0001c710: 7665 3d78 7370 6563 2c20 666c 7578 3d66  ve=xspec, flux=f
+0001c720: 6c75 782c 0a20 2020 2020 2020 2020 2020  lux,.           
+0001c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c750: 2020 2020 2020 6e61 6d65 3d6c 6162 656c        name=label
+0001c760: 290a 0a20 2020 2072 6574 7572 6e20 6269  )..    return bi
+0001c770: 6e5f 7374 6570 732c 2073 7465 705f 7465  n_steps, step_te
+0001c780: 6d70 6c0a 0a0a 6465 6620 706f 6c79 6e6f  mpl...def polyno
+0001c790: 6d69 616c 5f74 656d 706c 6174 6573 2877  mial_templates(w
+0001c7a0: 6176 652c 2072 6566 5f77 6176 653d 312e  ave, ref_wave=1.
+0001c7b0: 6534 2c20 6f72 6465 723d 302c 206c 696e  e4, order=0, lin
+0001c7c0: 653d 4661 6c73 6529 3a0a 2020 2020 7465  e=False):.    te
+0001c7d0: 6d70 203d 204f 7264 6572 6564 4469 6374  mp = OrderedDict
+0001c7e0: 2829 0a20 2020 2069 6620 6c69 6e65 3a0a  ().    if line:.
+0001c7f0: 2020 2020 2020 2020 666f 7220 7369 676e          for sign
+0001c800: 2069 6e20 5b31 2c20 2d31 5d3a 0a20 2020   in [1, -1]:.   
+0001c810: 2020 2020 2020 2020 206b 6579 203d 2027           key = '
+0001c820: 706f 6c79 207b 307d 272e 666f 726d 6174  poly {0}'.format
+0001c830: 2873 6967 6e29 0a20 2020 2020 2020 2020  (sign).         
+0001c840: 2020 2074 656d 705b 6b65 795d 203d 2053     temp[key] = S
+0001c850: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
+0001c860: 7761 7665 2c20 7369 676e 2a28 7761 7665  wave, sign*(wave
+0001c870: 2f72 6566 5f77 6176 652d 3129 2b31 290a  /ref_wave-1)+1).
+0001c880: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0001c890: 5b6b 6579 5d2e 6e61 6d65 203d 206b 6579  [key].name = key
+0001c8a0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001c8b0: 2074 656d 700a 0a20 2020 2066 6f72 2069   temp..    for i
+0001c8c0: 2069 6e20 7261 6e67 6528 6f72 6465 722b   in range(order+
+0001c8d0: 3129 3a0a 2020 2020 2020 2020 6b65 7920  1):.        key 
+0001c8e0: 3d20 2770 6f6c 7920 7b30 7d27 2e66 6f72  = 'poly {0}'.for
+0001c8f0: 6d61 7428 6929 0a20 2020 2020 2020 2074  mat(i).        t
+0001c900: 656d 705b 6b65 795d 203d 2053 7065 6374  emp[key] = Spect
+0001c910: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
+0001c920: 2c20 2877 6176 652f 7265 665f 7761 7665  , (wave/ref_wave
+0001c930: 2d31 292a 2a69 290a 2020 2020 2020 2020  -1)**i).        
+0001c940: 7465 6d70 5b6b 6579 5d2e 6e61 6d65 203d  temp[key].name =
+0001c950: 206b 6579 0a20 2020 2020 2020 2074 656d   key.        tem
+0001c960: 705b 6b65 795d 2e72 6566 5f77 6176 6520  p[key].ref_wave 
+0001c970: 3d20 7265 665f 7761 7665 0a0a 2020 2020  = ref_wave..    
+0001c980: 7265 7475 726e 2074 656d 700a 0a0a 6465  return temp...de
+0001c990: 6620 7370 6c69 745f 706f 6c79 5f74 656d  f split_poly_tem
+0001c9a0: 706c 6174 6528 7465 6d70 6c2c 2072 6566  plate(templ, ref
+0001c9b0: 5f77 6176 653d 312e 6534 2c20 6f72 6465  _wave=1.e4, orde
+0001c9c0: 723d 3329 3a0a 2020 2020 2222 220a 2020  r=3):.    """.  
+0001c9d0: 2020 4d75 6c74 6970 6c79 2061 2073 696e    Multiply a sin
+0001c9e0: 676c 6520 7465 6d70 6c61 7465 2062 7920  gle template by 
+0001c9f0: 706f 6c79 6e6f 6d69 616c 2062 6173 6573  polynomial bases
+0001ca00: 2074 6f20 6566 6665 6374 6976 656c 7920   to effectively 
+0001ca10: 6765 6e65 7261 7465 2061 0a20 2020 2070  generate a.    p
+0001ca20: 6f6c 796e 6f6d 6961 6c20 6d75 6c74 6970  olynomial multip
+0001ca30: 6c69 6361 7469 7665 2063 6f72 7265 6374  licative correct
+0001ca40: 696f 6e20 7468 6174 2063 616e 2062 6520  ion that can be 
+0001ca50: 6669 7420 7769 7468 206c 696e 6561 7220  fit with linear 
+0001ca60: 6c65 6173 740a 2020 2020 7371 7561 7265  least.    square
+0001ca70: 732e 0a0a 2020 2020 5061 7261 6d65 7465  s...    Paramete
+0001ca80: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+0001ca90: 2d0a 2020 2020 7465 6d70 6c20 3a20 607e  -.    templ : `~
+0001caa0: 6772 697a 6c69 2e75 7469 6c73 2e53 7065  grizli.utils.Spe
+0001cab0: 6374 7275 6d54 656d 706c 6174 6560 0a20  ctrumTemplate`. 
+0001cac0: 2020 2020 2020 2054 656d 706c 6174 6520         Template 
+0001cad0: 746f 2073 706c 6974 2e0a 0a20 2020 2072  to split...    r
+0001cae0: 6566 5f77 6176 6520 3a20 666c 6f61 740a  ef_wave : float.
+0001caf0: 2020 2020 2020 2057 6176 656c 656e 6774         Wavelengt
+0001cb00: 6820 7768 6572 6520 746f 206e 6f72 6d61  h where to norma
+0001cb10: 6c69 7a65 2074 6865 2070 6f6c 796e 6f6d  lize the polynom
+0001cb20: 6961 6c73 2e0a 0a20 2020 204f 7264 6572  ials...    Order
+0001cb30: 203a 2069 6e74 0a20 2020 2020 2020 2050   : int.        P
+0001cb40: 6f6c 796e 6f6d 6961 6c20 6f72 6465 722e  olynomial order.
+0001cb50: 2020 5265 7475 726e 7320 6f72 6465 722b    Returns order+
+0001cb60: 3120 7465 6d70 6c61 7465 732e 0a0a 2020  1 templates...  
+0001cb70: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0001cb80: 2d2d 2d2d 2d0a 2020 2020 7074 656d 7020  -----.    ptemp 
+0001cb90: 3a20 6469 6374 0a0a 2020 2020 2020 2020  : dict..        
+0001cba0: 4469 6374 696f 6e61 7279 206f 6620 706f  Dictionary of po
+0001cbb0: 6c79 6e6f 6d69 616c 2d63 6f6d 706f 6e65  lynomial-compone
+0001cbc0: 6e74 2074 656d 706c 6174 6573 2c20 7769  nt templates, wi
+0001cbd0: 7468 2061 6464 6974 696f 6e61 6c0a 2020  th additional.  
+0001cbe0: 2020 2020 2020 6174 7472 6962 7574 6573        attributes
+0001cbf0: 3a0a 0a20 2020 2020 2020 2020 2020 2072  :..            r
+0001cc00: 6566 5f77 6176 6520 3d20 7761 7665 6c65  ef_wave = wavele
+0001cc10: 6e67 7468 2077 6865 7265 2070 6f6c 796e  ngth where polyn
+0001cc20: 6f6d 6961 6c73 206e 6f72 6d61 6c69 7a65  omials normalize
+0001cc30: 640a 0a20 2020 2022 2222 0a20 2020 2066  d..    """.    f
+0001cc40: 726f 6d20 636f 6c6c 6563 7469 6f6e 7320  rom collections 
+0001cc50: 696d 706f 7274 204f 7264 6572 6564 4469  import OrderedDi
+0001cc60: 6374 0a20 2020 2066 726f 6d20 6772 697a  ct.    from griz
+0001cc70: 6c69 2069 6d70 6f72 7420 7574 696c 730a  li import utils.
+0001cc80: 0a20 2020 2074 7370 6c69 6e65 203d 2070  .    tspline = p
+0001cc90: 6f6c 796e 6f6d 6961 6c5f 7465 6d70 6c61  olynomial_templa
+0001cca0: 7465 7328 7465 6d70 6c2e 7761 7665 2c20  tes(templ.wave, 
+0001ccb0: 7265 665f 7761 7665 3d72 6566 5f77 6176  ref_wave=ref_wav
+0001ccc0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
 0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccf0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
-0001cd00: 2020 2070 7465 6d70 5b6e 616d 655d 2e72     ptemp[name].r
-0001cd10: 6566 5f77 6176 6520 3d20 7265 665f 7761  ef_wave = ref_wa
-0001cd20: 7665 0a0a 2020 2020 7074 656d 702e 7265  ve..    ptemp.re
-0001cd30: 665f 7761 7665 203d 2072 6566 5f77 6176  f_wave = ref_wav
-0001cd40: 650a 0a20 2020 2072 6574 7572 6e20 7074  e..    return pt
-0001cd50: 656d 700a 0a0a 6465 6620 646f 745f 7465  emp...def dot_te
-0001cd60: 6d70 6c61 7465 7328 636f 6566 6673 2c20  mplates(coeffs, 
-0001cd70: 7465 6d70 6c61 7465 732c 207a 3d30 2c20  templates, z=0, 
-0001cd80: 6d61 785f 523d 3530 3030 2c20 6170 706c  max_R=5000, appl
-0001cd90: 795f 6967 6d3d 5472 7565 293a 0a20 2020  y_igm=True):.   
-0001cda0: 2022 2222 436f 6d70 7574 6520 7465 6d70   """Compute temp
-0001cdb0: 6c61 7465 2073 756d 2061 6e61 6c6f 676f  late sum analogo
-0001cdc0: 7573 2074 6f20 606e 702e 646f 7428 636f  us to `np.dot(co
-0001cdd0: 6566 6673 2c20 7465 6d70 6c61 7465 7329  effs, templates)
-0001cde0: 602e 0a20 2020 2022 2222 0a0a 2020 2020  `..    """..    
-0001cdf0: 6966 206c 656e 2863 6f65 6666 7329 2021  if len(coeffs) !
-0001ce00: 3d20 6c65 6e28 7465 6d70 6c61 7465 7329  = len(templates)
-0001ce10: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0001ce20: 5661 6c75 6545 7272 6f72 2827 7368 6170  ValueError('shap
-0001ce30: 6573 206f 6620 636f 6566 6673 2028 7b30  es of coeffs ({0
-0001ce40: 7d29 2061 6e64 2074 656d 706c 6174 6573  }) and templates
-0001ce50: 2028 7b31 7d29 2064 6f6e 5c27 7420 6d61   ({1}) don\'t ma
-0001ce60: 7463 6827 2e66 6f72 6d61 7428 6c65 6e28  tch'.format(len(
-0001ce70: 636f 6566 6673 292c 206c 656e 2874 656d  coeffs), len(tem
-0001ce80: 706c 6174 6573 2929 290a 0a20 2020 2023  plates)))..    #
-0001ce90: 2066 6f72 2069 2c20 7465 2069 6e20 656e   for i, te in en
-0001cea0: 756d 6572 6174 6528 7465 6d70 6c61 7465  umerate(template
-0001ceb0: 7329 3a0a 2020 2020 2320 2020 2020 6966  s):.    #     if
-0001cec0: 2069 203d 3d20 303a 0a20 2020 2023 2020   i == 0:.    #  
-0001ced0: 2020 2020 2020 2074 6320 3d20 7465 6d70         tc = temp
-0001cee0: 6c61 7465 735b 7465 5d2e 7a73 6361 6c65  lates[te].zscale
-0001cef0: 287a 2c20 7363 616c 6172 3d63 6f65 6666  (z, scalar=coeff
-0001cf00: 735b 695d 290a 2020 2020 2320 2020 2020  s[i]).    #     
-0001cf10: 2020 2020 746c 203d 2074 656d 706c 6174      tl = templat
-0001cf20: 6573 5b74 655d 2e7a 7363 616c 6528 7a2c  es[te].zscale(z,
-0001cf30: 2073 6361 6c61 723d 636f 6566 6673 5b69   scalar=coeffs[i
-0001cf40: 5d29 0a20 2020 2023 2020 2020 2065 6c73  ]).    #     els
-0001cf50: 653a 0a20 2020 2023 2020 2020 2020 2020  e:.    #        
-0001cf60: 2069 6620 7465 2e73 7461 7274 7377 6974   if te.startswit
-0001cf70: 6828 276c 696e 6527 293a 0a20 2020 2023  h('line'):.    #
-0001cf80: 2020 2020 2020 2020 2020 2020 2074 6320               tc 
-0001cf90: 2b3d 2074 656d 706c 6174 6573 5b74 655d  += templates[te]
-0001cfa0: 2e7a 7363 616c 6528 7a2c 2073 6361 6c61  .zscale(z, scala
-0001cfb0: 723d 302e 290a 2020 2020 2320 2020 2020  r=0.).    #     
-0001cfc0: 2020 2020 656c 7365 3a0a 2020 2020 2320      else:.    # 
-0001cfd0: 2020 2020 2020 2020 2020 2020 7463 202b              tc +
-0001cfe0: 3d20 7465 6d70 6c61 7465 735b 7465 5d2e  = templates[te].
-0001cff0: 7a73 6361 6c65 287a 2c20 7363 616c 6172  zscale(z, scalar
-0001d000: 3d63 6f65 6666 735b 695d 290a 2020 2020  =coeffs[i]).    
-0001d010: 230a 2020 2020 2320 2020 2020 2020 2020  #.    #         
-0001d020: 746c 202b 3d20 7465 6d70 6c61 7465 735b  tl += templates[
-0001d030: 7465 5d2e 7a73 6361 6c65 287a 2c20 7363  te].zscale(z, sc
-0001d040: 616c 6172 3d63 6f65 6666 735b 695d 290a  alar=coeffs[i]).
-0001d050: 2020 2020 7761 7665 2c20 666c 7578 5f61      wave, flux_a
-0001d060: 7272 2c20 6973 5f6c 696e 6520 3d20 6172  rr, is_line = ar
-0001d070: 7261 795f 7465 6d70 6c61 7465 7328 7465  ray_templates(te
-0001d080: 6d70 6c61 7465 732c 206d 6178 5f52 3d6d  mplates, max_R=m
-0001d090: 6178 5f52 2c20 7a3d 7a2c 0a20 2020 2020  ax_R, z=z,.     
-0001d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d0c0: 2020 2020 2020 2020 2061 7070 6c79 5f69           apply_i
-0001d0d0: 676d 3d61 7070 6c79 5f69 676d 290a 0a20  gm=apply_igm).. 
-0001d0e0: 2020 2023 2023 2049 474d 0a20 2020 2023     # # IGM.    #
-0001d0f0: 2069 6620 6170 706c 795f 6967 6d3a 0a20   if apply_igm:. 
-0001d100: 2020 2023 2020 2020 2074 7279 3a0a 2020     #     try:.  
-0001d110: 2020 2320 2020 2020 2020 2020 696d 706f    #         impo
-0001d120: 7274 2065 617a 792e 6967 6d0a 2020 2020  rt eazy.igm.    
-0001d130: 2320 2020 2020 2020 2020 4947 4d20 3d20  #         IGM = 
-0001d140: 6561 7a79 2e69 676d 2e49 6e6f 7565 3134  eazy.igm.Inoue14
-0001d150: 2829 0a20 2020 2023 0a20 2020 2023 2020  ().    #.    #  
-0001d160: 2020 2020 2020 206c 796c 696d 203d 2077         lylim = w
-0001d170: 6176 6520 3c20 3132 3530 0a20 2020 2023  ave < 1250.    #
-0001d180: 2020 2020 2020 2020 2069 676d 7a20 3d20           igmz = 
-0001d190: 6e70 2e6f 6e65 735f 6c69 6b65 2877 6176  np.ones_like(wav
-0001d1a0: 6529 0a20 2020 2023 2020 2020 2020 2020  e).    #        
-0001d1b0: 2069 676d 7a5b 6c79 6c69 6d5d 203d 2049   igmz[lylim] = I
-0001d1c0: 474d 2e66 756c 6c5f 4947 4d28 7a2c 2077  GM.full_IGM(z, w
-0001d1d0: 6176 655b 6c79 6c69 6d5d 2a28 312b 7a29  ave[lylim]*(1+z)
-0001d1e0: 290a 2020 2020 2320 2020 2020 6578 6365  ).    #     exce
-0001d1f0: 7074 3a0a 2020 2020 2320 2020 2020 2020  pt:.    #       
-0001d200: 2020 6967 6d7a 203d 2031 2e0a 2020 2020    igmz = 1..    
-0001d210: 2320 656c 7365 3a0a 2020 2020 2320 2020  # else:.    #   
-0001d220: 2020 6967 6d7a 203d 2031 2e0a 2020 2020    igmz = 1..    
-0001d230: 230a 2020 2020 2320 6973 5f6f 6273 6672  #.    # is_obsfr
-0001d240: 616d 6520 3d20 6e70 2e61 7272 6179 285b  ame = np.array([
-0001d250: 742e 7370 6c69 7428 295b 305d 2069 6e20  t.split()[0] in 
-0001d260: 5b27 6273 706c 272c 2027 7374 6570 275d  ['bspl', 'step']
-0001d270: 2066 6f72 2074 2069 6e20 7465 6d70 6c61   for t in templa
-0001d280: 7465 735d 290a 2020 2020 230a 2020 2020  tes]).    #.    
-0001d290: 2320 666c 7578 5f61 7272 5b7e 6973 5f6f  # flux_arr[~is_o
-0001d2a0: 6273 6672 616d 652c 3a5d 202a 3d20 6967  bsframe,:] *= ig
-0001d2b0: 6d7a 0a20 2020 2023 0a20 2020 2023 2023  mz.    #.    # #
-0001d2c0: 204d 756c 7469 706c 7920 7370 6c69 6e65   Multiply spline
-0001d2d0: 3f0a 2020 2020 2320 666f 7220 692c 2074  ?.    # for i, t
-0001d2e0: 2069 6e20 656e 756d 6572 6174 6528 7465   in enumerate(te
-0001d2f0: 6d70 6c61 7465 7329 3a0a 2020 2020 2320  mplates):.    # 
-0001d300: 2020 2020 6966 2027 7370 6c69 6e65 2720      if 'spline' 
-0001d310: 696e 2074 3a0a 2020 2020 2320 2020 2020  in t:.    #     
-0001d320: 2020 2020 666f 7220 6a2c 2074 6a20 696e      for j, tj in
-0001d330: 2065 6e75 6d65 7261 7465 2874 656d 706c   enumerate(templ
-0001d340: 6174 6573 293a 0a20 2020 2023 2020 2020  ates):.    #    
-0001d350: 2020 2020 2020 2020 2069 6620 6973 5f6f           if is_o
-0001d360: 6273 6672 616d 655b 6a5d 3a0a 2020 2020  bsframe[j]:.    
-0001d370: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-0001d380: 2020 7072 696e 7428 2773 6361 6c65 2073    print('scale s
-0001d390: 706c 696e 653a 207b 307d 2078 207b 317d  pline: {0} x {1}
-0001d3a0: 272e 666f 726d 6174 2874 6a2c 2074 2929  '.format(tj, t))
-0001d3b0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0001d3c0: 2020 2020 2020 2066 6c75 785f 6172 725b         flux_arr[
-0001d3d0: 6a2c 3a5d 202a 3d20 666c 7578 5f61 7272  j,:] *= flux_arr
-0001d3e0: 5b69 2c3a 5d0a 0a20 2020 2023 2043 6f6e  [i,:]..    # Con
-0001d3f0: 7469 6e75 756d 0a20 2020 2063 6f6e 7420  tinuum.    cont 
-0001d400: 3d20 6e70 2e64 6f74 2863 6f65 6666 732a  = np.dot(coeffs*
-0001d410: 287e 6973 5f6c 696e 6529 2c20 666c 7578  (~is_line), flux
-0001d420: 5f61 7272 290a 2020 2020 7463 203d 2053  _arr).    tc = S
-0001d430: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
-0001d440: 7761 7665 3d77 6176 652c 2066 6c75 783d  wave=wave, flux=
-0001d450: 636f 6e74 292e 7a73 6361 6c65 287a 2c20  cont).zscale(z, 
-0001d460: 6170 706c 795f 6967 6d3d 4661 6c73 6529  apply_igm=False)
-0001d470: 0a0a 2020 2020 2320 4675 6c6c 2074 656d  ..    # Full tem
-0001d480: 706c 6174 650a 2020 2020 6c69 6e65 203d  plate.    line =
-0001d490: 206e 702e 646f 7428 636f 6566 6673 2c20   np.dot(coeffs, 
-0001d4a0: 666c 7578 5f61 7272 290a 2020 2020 746c  flux_arr).    tl
-0001d4b0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
-0001d4c0: 6174 6528 7761 7665 3d77 6176 652c 2066  ate(wave=wave, f
-0001d4d0: 6c75 783d 6c69 6e65 292e 7a73 6361 6c65  lux=line).zscale
-0001d4e0: 287a 2c20 6170 706c 795f 6967 6d3d 4661  (z, apply_igm=Fa
-0001d4f0: 6c73 6529 0a0a 2020 2020 7265 7475 726e  lse)..    return
-0001d500: 2074 632c 2074 6c0a 0a0a 6465 6620 6172   tc, tl...def ar
-0001d510: 7261 795f 7465 6d70 6c61 7465 7328 7465  ray_templates(te
-0001d520: 6d70 6c61 7465 732c 2077 6176 653d 4e6f  mplates, wave=No
-0001d530: 6e65 2c20 6d61 785f 523d 3530 3030 2c20  ne, max_R=5000, 
-0001d540: 7a3d 302c 2061 7070 6c79 5f69 676d 3d46  z=0, apply_igm=F
-0001d550: 616c 7365 293a 0a20 2020 2022 2222 5265  alse):.    """Re
-0001d560: 7475 726e 2061 6e20 6172 7261 7920 7665  turn an array ve
-0001d570: 7273 696f 6e20 6f66 2074 6865 2074 656d  rsion of the tem
-0001d580: 706c 6174 6573 2074 6861 7420 6861 7665  plates that have
-0001d590: 2061 6c6c 2062 6565 6e20 696e 7465 7270   all been interp
-0001d5a0: 6f6c 6174 6564 2074 6f20 7468 6520 7361  olated to the sa
-0001d5b0: 6d65 2067 7269 642e 0a0a 0a20 2020 2050  me grid....    P
-0001d5c0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-0001d5d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2074 656d  --------.    tem
-0001d5e0: 706c 6174 6573 203a 2064 6963 7469 6f6e  plates : diction
-0001d5f0: 6172 7920 6f66 2060 7e67 7269 7a6c 692e  ary of `~grizli.
-0001d600: 7574 696c 732e 5370 6563 7472 756d 5465  utils.SpectrumTe
-0001d610: 6d70 6c61 7465 6020 6f62 6a65 6374 730a  mplate` objects.
-0001d620: 2020 2020 2020 2020 4f75 7470 7574 2074          Output t
-0001d630: 656d 706c 6174 6520 6c69 7374 2077 6974  emplate list wit
-0001d640: 6820 604e 5445 4d50 6020 7465 6d70 6c61  h `NTEMP` templa
-0001d650: 7465 732e 0a0a 2020 2020 6d61 785f 5220  tes...    max_R 
-0001d660: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-0001d670: 4d61 7869 6d75 6d20 7370 6563 7472 616c  Maximum spectral
-0001d680: 2072 6573 6f6c 7574 696f 6e20 6f66 2074   resolution of t
-0001d690: 6865 2072 6567 7269 6464 6564 2074 656d  he regridded tem
-0001d6a0: 706c 6174 6573 2e0a 0a20 2020 207a 203a  plates...    z :
-0001d6b0: 2066 6c6f 6174 0a20 2020 2020 2020 2052   float.        R
-0001d6c0: 6564 7368 6966 7420 7768 6572 6520 746f  edshift where to
-0001d6d0: 2065 7661 6c75 6174 6520 7468 6520 7465   evaluate the te
-0001d6e0: 6d70 6c61 7465 732e 2020 4275 7420 6e6f  mplates.  But no
-0001d6f0: 7465 2074 6861 7420 7468 6973 2069 7320  te that this is 
-0001d700: 6f6e 6c79 0a20 2020 2020 2020 2075 7365  only.        use
-0001d710: 6420 746f 2073 6869 6674 2074 656d 706c  d to shift templ
-0001d720: 6174 6573 2070 726f 6475 6365 6420 6279  ates produced by
-0001d730: 2060 6273 706c 696e 655f 7465 6d70 6c61   `bspline_templa
-0001d740: 7465 7360 2c20 7768 6963 6820 6172 650a  tes`, which are.
-0001d750: 2020 2020 2020 2020 6465 6669 6e65 6420          defined 
-0001d760: 696e 2074 6865 206f 6273 6572 7665 6420  in the observed 
-0001d770: 6672 616d 652e 0a0a 2020 2020 5265 7475  frame...    Retu
-0001d780: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0001d790: 2020 2020 7761 7665 203a 2060 7e6e 756d      wave : `~num
-0001d7a0: 7079 2e6e 6461 7272 6179 602c 2064 696d  py.ndarray`, dim
-0001d7b0: 656e 7369 6f6e 7320 6028 4e4c 2c29 600a  ensions `(NL,)`.
-0001d7c0: 2020 2020 2020 2020 4172 7261 7920 636f          Array co
-0001d7d0: 6e74 6169 6e69 6e67 2075 6e69 7175 6520  ntaining unique 
-0001d7e0: 7761 7665 6c65 6e67 7468 732e 0a0a 2020  wavelengths...  
-0001d7f0: 2020 666c 7578 5f61 7272 203a 2060 7e6e    flux_arr : `~n
-0001d800: 756d 7079 2e6e 6461 7272 6179 602c 2064  umpy.ndarray`, d
-0001d810: 696d 656e 7369 6f6e 7320 6028 4e54 454d  imensions `(NTEM
-0001d820: 502c 204e 4c29 600a 2020 2020 2020 2020  P, NL)`.        
-0001d830: 4172 7261 7920 636f 6e74 6169 6e69 6e67  Array containing
-0001d840: 2074 6865 2074 656d 706c 6174 6520 666c   the template fl
-0001d850: 7578 6573 2069 6e74 6572 706f 6c61 7465  uxes interpolate
-0001d860: 6420 6174 2060 7761 7665 602e 0a0a 2020  d at `wave`...  
-0001d870: 2020 6973 5f6c 696e 6520 3a20 607e 6e75    is_line : `~nu
-0001d880: 6d70 792e 6e64 6172 7261 7960 0a20 2020  mpy.ndarray`.   
-0001d890: 2020 2020 2042 6f6f 6c65 616e 2061 7272       Boolean arr
-0001d8a0: 6179 2069 6e64 6963 6174 696e 6720 656d  ay indicating em
-0001d8b0: 6973 7369 6f6e 206c 696e 6520 7465 6d70  ission line temp
-0001d8c0: 6c61 7465 7320 2874 6865 206b 6579 2069  lates (the key i
-0001d8d0: 6e20 7468 650a 2020 2020 2020 2020 7465  n the.        te
-0001d8e0: 6d70 6c61 7465 2064 6963 7469 6f6e 6172  mplate dictionar
-0001d8f0: 7920 7374 6172 7473 2077 6974 6820 226c  y starts with "l
-0001d900: 696e 6520 2229 2e0a 0a20 2020 2022 2222  ine ")...    """
-0001d910: 0a20 2020 2066 726f 6d20 6772 697a 6c69  .    from grizli
-0001d920: 2e75 7469 6c73 5f63 2e69 6e74 6572 7020  .utils_c.interp 
-0001d930: 696d 706f 7274 2069 6e74 6572 705f 636f  import interp_co
-0001d940: 6e73 6572 7665 5f63 0a0a 2020 2020 6966  nserve_c..    if
-0001d950: 2077 6176 6520 6973 204e 6f6e 653a 0a20   wave is None:. 
-0001d960: 2020 2020 2020 2077 7374 6163 6b20 3d20         wstack = 
-0001d970: 5b5d 0a20 2020 2020 2020 2066 6f72 2074  [].        for t
-0001d980: 2069 6e20 7465 6d70 6c61 7465 733a 0a20   in templates:. 
-0001d990: 2020 2020 2020 2020 2020 2069 6620 742e             if t.
-0001d9a0: 7370 6c69 7428 295b 305d 2069 6e20 5b27  split()[0] in ['
-0001d9b0: 6273 706c 272c 2027 7374 6570 272c 2027  bspl', 'step', '
-0001d9c0: 706f 6c79 275d 3a0a 2020 2020 2020 2020  poly']:.        
-0001d9d0: 2020 2020 2020 2020 7773 7461 636b 2e61          wstack.a
-0001d9e0: 7070 656e 6428 7465 6d70 6c61 7465 735b  ppend(templates[
-0001d9f0: 745d 2e77 6176 652f 2831 2b7a 2929 0a20  t].wave/(1+z)). 
-0001da00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001da20: 2077 7374 6163 6b2e 6170 7065 6e64 2874   wstack.append(t
-0001da30: 656d 706c 6174 6573 5b74 5d2e 7761 7665  emplates[t].wave
-0001da40: 290a 0a20 2020 2020 2020 2077 6176 6520  )..        wave 
-0001da50: 3d20 6e70 2e75 6e69 7175 6528 6e70 2e68  = np.unique(np.h
-0001da60: 7374 6163 6b28 7773 7461 636b 2929 0a0a  stack(wstack))..
-0001da70: 2020 2020 636c 6970 7375 6d2c 2069 7465      clipsum, ite
-0001da80: 7220 3d20 312c 2030 0a20 2020 2077 6869  r = 1, 0.    whi
-0001da90: 6c65 2028 636c 6970 7375 6d20 3e20 3029  le (clipsum > 0)
-0001daa0: 2026 2028 6974 6572 203c 2031 3029 3a0a   & (iter < 10):.
-0001dab0: 2020 2020 2020 2020 636c 6970 203d 206e          clip = n
-0001dac0: 702e 6772 6164 6965 6e74 2877 6176 6529  p.gradient(wave)
-0001dad0: 2f77 6176 6520 3c20 312f 6d61 785f 520a  /wave < 1/max_R.
-0001dae0: 2020 2020 2020 2020 6964 7820 3d20 6e70          idx = np
-0001daf0: 2e61 7261 6e67 6528 6c65 6e28 7761 7665  .arange(len(wave
-0001db00: 2929 5b63 6c69 705d 0a20 2020 2020 2020  ))[clip].       
-0001db10: 2077 6176 655b 6964 785b 3a3a 325d 5d20   wave[idx[::2]] 
-0001db20: 3d20 6e70 2e6e 616e 0a20 2020 2020 2020  = np.nan.       
-0001db30: 2077 6176 6520 3d20 7761 7665 5b6e 702e   wave = wave[np.
-0001db40: 6973 6669 6e69 7465 2877 6176 6529 5d0a  isfinite(wave)].
-0001db50: 2020 2020 2020 2020 6974 6572 202b 3d20          iter += 
-0001db60: 310a 2020 2020 2020 2020 636c 6970 7375  1.        clipsu
-0001db70: 6d20 3d20 636c 6970 2e73 756d 2829 0a20  m = clip.sum(). 
-0001db80: 2020 2020 2020 2023 7072 696e 7428 6974         #print(it
-0001db90: 6572 2c20 636c 6970 7375 6d29 0a0a 2020  er, clipsum)..  
-0001dba0: 2020 4e54 454d 5020 3d20 6c65 6e28 7465    NTEMP = len(te
-0001dbb0: 6d70 6c61 7465 7329 0a20 2020 2066 6c75  mplates).    flu
-0001dbc0: 785f 6172 7220 3d20 6e70 2e7a 6572 6f73  x_arr = np.zeros
-0001dbd0: 2828 4e54 454d 502c 206c 656e 2877 6176  ((NTEMP, len(wav
-0001dbe0: 6529 2929 0a0a 2020 2020 666f 7220 692c  e)))..    for i,
-0001dbf0: 2074 2069 6e20 656e 756d 6572 6174 6528   t in enumerate(
-0001dc00: 7465 6d70 6c61 7465 7329 3a0a 2020 2020  templates):.    
-0001dc10: 2020 2020 6966 2074 2e73 706c 6974 2829      if t.split()
-0001dc20: 5b30 5d20 696e 205b 2762 7370 6c27 2c20  [0] in ['bspl', 
-0001dc30: 2773 7465 7027 2c20 2770 6f6c 7927 5d3a  'step', 'poly']:
-0001dc40: 0a20 2020 2020 2020 2020 2020 2066 6c75  .            flu
-0001dc50: 785f 6172 725b 692c 203a 5d20 3d20 696e  x_arr[i, :] = in
-0001dc60: 7465 7270 5f63 6f6e 7365 7276 655f 6328  terp_conserve_c(
-0001dc70: 7761 7665 2c20 7465 6d70 6c61 7465 735b  wave, templates[
-0001dc80: 745d 2e77 6176 652f 2831 2b7a 292c 0a20  t].wave/(1+z),. 
-0001dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcb0: 2020 2020 2020 2020 2074 656d 706c 6174           templat
-0001dcc0: 6573 5b74 5d2e 666c 7578 2a28 312b 7a29  es[t].flux*(1+z)
-0001dcd0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001dce0: 2020 2020 2020 2020 2020 2020 6966 2068              if h
-0001dcf0: 6173 6174 7472 2874 656d 706c 6174 6573  asattr(templates
-0001dd00: 5b74 5d2c 2027 666c 7578 5f66 6c61 6d27  [t], 'flux_flam'
-0001dd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001dd20: 2020 2023 2052 6564 7368 6966 742d 6465     # Redshift-de
-0001dd30: 7065 6e64 656e 7420 6561 7a79 2d70 7920  pendent eazy-py 
-0001dd40: 5465 6d70 6c61 7465 0a20 2020 2020 2020  Template.       
-0001dd50: 2020 2020 2020 2020 2066 6c75 785f 6172           flux_ar
-0001dd60: 725b 692c 203a 5d20 3d20 696e 7465 7270  r[i, :] = interp
-0001dd70: 5f63 6f6e 7365 7276 655f 6328 7761 7665  _conserve_c(wave
-0001dd80: 2c20 7465 6d70 6c61 7465 735b 745d 2e77  , templates[t].w
-0001dd90: 6176 652c 0a20 2020 2020 2020 2020 2020  ave,.           
-0001dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001ddc0: 656d 706c 6174 6573 5b74 5d2e 666c 7578  emplates[t].flux
-0001ddd0: 5f66 6c61 6d28 7a3d 7a29 290a 2020 2020  _flam(z=z)).    
-0001dde0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001ddf0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0001de00: 7578 5f61 7272 5b69 2c20 3a5d 203d 2069  ux_arr[i, :] = i
-0001de10: 6e74 6572 705f 636f 6e73 6572 7665 5f63  nterp_conserve_c
-0001de20: 2877 6176 652c 2074 656d 706c 6174 6573  (wave, templates
-0001de30: 5b74 5d2e 7761 7665 2c0a 2020 2020 2020  [t].wave,.      
-0001de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de60: 2020 2020 7465 6d70 6c61 7465 735b 745d      templates[t]
-0001de70: 2e66 6c75 7829 0a0a 2020 2020 6973 5f6c  .flux)..    is_l
-0001de80: 696e 6520 3d20 6e70 2e61 7272 6179 285b  ine = np.array([
-0001de90: 742e 7374 6172 7473 7769 7468 2827 6c69  t.startswith('li
-0001dea0: 6e65 2027 2920 666f 7220 7420 696e 2074  ne ') for t in t
-0001deb0: 656d 706c 6174 6573 5d29 0a0a 2020 2020  emplates])..    
-0001dec0: 2320 4947 4d0a 2020 2020 6966 2061 7070  # IGM.    if app
-0001ded0: 6c79 5f69 676d 3a0a 2020 2020 2020 2020  ly_igm:.        
-0001dee0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0001def0: 2069 6d70 6f72 7420 6561 7a79 2e69 676d   import eazy.igm
-0001df00: 0a20 2020 2020 2020 2020 2020 2049 474d  .            IGM
-0001df10: 203d 2065 617a 792e 6967 6d2e 496e 6f75   = eazy.igm.Inou
-0001df20: 6531 3428 290a 0a20 2020 2020 2020 2020  e14()..         
-0001df30: 2020 206c 796c 696d 203d 2077 6176 6520     lylim = wave 
-0001df40: 3c20 3132 3530 0a20 2020 2020 2020 2020  < 1250.         
-0001df50: 2020 2069 676d 7a20 3d20 6e70 2e6f 6e65     igmz = np.one
-0001df60: 735f 6c69 6b65 2877 6176 6529 0a20 2020  s_like(wave).   
-0001df70: 2020 2020 2020 2020 2069 676d 7a5b 6c79           igmz[ly
-0001df80: 6c69 6d5d 203d 2049 474d 2e66 756c 6c5f  lim] = IGM.full_
-0001df90: 4947 4d28 7a2c 2077 6176 655b 6c79 6c69  IGM(z, wave[lyli
-0001dfa0: 6d5d 2a28 312b 7a29 290a 2020 2020 2020  m]*(1+z)).      
-0001dfb0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-0001dfc0: 2020 2020 2020 6967 6d7a 203d 2031 2e0a        igmz = 1..
-0001dfd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001dfe0: 2020 6967 6d7a 203d 2031 2e0a 0a20 2020    igmz = 1...   
-0001dff0: 206f 6273 6e61 6d65 7320 3d20 5b27 6273   obsnames = ['bs
-0001e000: 706c 272c 2027 7374 6570 272c 2027 706f  pl', 'step', 'po
-0001e010: 6c79 275d 0a20 2020 2069 735f 6f62 7366  ly'].    is_obsf
-0001e020: 7261 6d65 203d 206e 702e 6172 7261 7928  rame = np.array(
-0001e030: 5b74 2e73 706c 6974 2829 5b30 5d20 696e  [t.split()[0] in
-0001e040: 206f 6273 6e61 6d65 7320 666f 7220 7420   obsnames for t 
-0001e050: 696e 2074 656d 706c 6174 6573 5d29 0a0a  in templates])..
-0001e060: 2020 2020 666c 7578 5f61 7272 5b7e 6973      flux_arr[~is
-0001e070: 5f6f 6273 6672 616d 652c 203a 5d20 2a3d  _obsframe, :] *=
-0001e080: 2069 676d 7a0a 0a20 2020 2023 204d 756c   igmz..    # Mul
-0001e090: 7469 706c 7920 7370 6c69 6e65 3f0a 2020  tiply spline?.  
-0001e0a0: 2020 666f 7220 692c 2074 2069 6e20 656e    for i, t in en
-0001e0b0: 756d 6572 6174 6528 7465 6d70 6c61 7465  umerate(template
-0001e0c0: 7329 3a0a 2020 2020 2020 2020 6966 2027  s):.        if '
-0001e0d0: 7370 6c69 6e65 2720 696e 2074 3a0a 2020  spline' in t:.  
-0001e0e0: 2020 2020 2020 2020 2020 666f 7220 6a2c            for j,
-0001e0f0: 2074 6a20 696e 2065 6e75 6d65 7261 7465   tj in enumerate
-0001e100: 2874 656d 706c 6174 6573 293a 0a20 2020  (templates):.   
-0001e110: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001e120: 6973 5f6f 6273 6672 616d 655b 6a5d 3a0a  is_obsframe[j]:.
-0001e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e140: 2020 2020 6d61 203d 2066 6c75 785f 6172      ma = flux_ar
-0001e150: 725b 6a2c 203a 5d2e 7375 6d28 290a 2020  r[j, :].sum().  
-0001e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e170: 2020 6d61 203d 206d 6120 6966 206d 6120    ma = ma if ma 
-0001e180: 3e20 3020 656c 7365 2031 0a20 2020 2020  > 0 else 1.     
-0001e190: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e1a0: 6120 3d20 310a 0a20 2020 2020 2020 2020  a = 1..         
-0001e1b0: 2020 2020 2020 2020 2020 2066 6c75 785f             flux_
-0001e1c0: 6172 725b 6a2c 203a 5d20 2a3d 2066 6c75  arr[j, :] *= flu
-0001e1d0: 785f 6172 725b 692c 203a 5d2f 6d61 0a0a  x_arr[i, :]/ma..
-0001e1e0: 2020 2020 7265 7475 726e 2077 6176 652c      return wave,
-0001e1f0: 2066 6c75 785f 6172 722c 2069 735f 6c69   flux_arr, is_li
-0001e200: 6e65 0a0a 0a64 6566 2063 6f6d 7075 7465  ne...def compute
-0001e210: 5f65 7175 6976 616c 656e 745f 7769 6474  _equivalent_widt
-0001e220: 6873 2874 656d 706c 6174 6573 2c20 636f  hs(templates, co
-0001e230: 6566 6673 2c20 636f 7661 722c 206d 6178  effs, covar, max
-0001e240: 5f52 3d35 3030 302c 204e 6472 6177 3d31  _R=5000, Ndraw=1
-0001e250: 3030 302c 2073 6565 643d 302c 207a 3d30  000, seed=0, z=0
-0001e260: 2c20 6f62 7365 7276 6564 5f66 7261 6d65  , observed_frame
-0001e270: 3d46 616c 7365 293a 0a20 2020 2022 2222  =False):.    """
-0001e280: 436f 6d70 7574 6520 7465 6d70 6c61 7465  Compute template
-0001e290: 2d66 6974 2065 6d69 7373 696f 6e20 6c69  -fit emission li
-0001e2a0: 6e65 2065 7175 6976 616c 656e 7420 7769  ne equivalent wi
-0001e2b0: 6474 6873 0a0a 2020 2020 5061 7261 6d65  dths..    Parame
-0001e2c0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-0001e2d0: 2d2d 2d0a 2020 2020 7465 6d70 6c61 7465  ---.    template
-0001e2e0: 7320 3a20 6469 6374 696f 6e61 7279 206f  s : dictionary o
-0001e2f0: 6620 607e 6772 697a 6c69 2e75 7469 6c73  f `~grizli.utils
-0001e300: 2e53 7065 6374 7275 6d54 656d 706c 6174  .SpectrumTemplat
-0001e310: 6560 206f 626a 6563 7473 0a20 2020 2020  e` objects.     
-0001e320: 2020 204f 7574 7075 7420 7465 6d70 6c61     Output templa
-0001e330: 7465 206c 6973 7420 7769 7468 2060 4e54  te list with `NT
-0001e340: 454d 5060 2074 656d 706c 6174 6573 2e0a  EMP` templates..
-0001e350: 0a20 2020 2063 6f65 6666 7320 3a20 607e  .    coeffs : `~
-0001e360: 6e75 6d70 792e 6e64 6172 7261 7960 2c20  numpy.ndarray`, 
-0001e370: 6469 6d65 6e73 696f 6e73 2028 604e 5445  dimensions (`NTE
-0001e380: 4d50 6029 0a20 2020 2020 2020 2046 6974  MP`).        Fit
-0001e390: 2063 6f65 6666 6963 6965 6e74 730a 0a20   coefficients.. 
-0001e3a0: 2020 2063 6f76 6172 203a 2020 607e 6e75     covar :  `~nu
-0001e3b0: 6d70 792e 6e64 6172 7261 7960 2c20 6469  mpy.ndarray`, di
-0001e3c0: 6d65 6e73 696f 6e73 2028 604e 5445 4d50  mensions (`NTEMP
-0001e3d0: 602c 2060 4e54 454d 5060 290a 2020 2020  `, `NTEMP`).    
-0001e3e0: 2020 2020 436f 7661 7269 616e 6365 206d      Covariance m
-0001e3f0: 6174 7269 780a 0a20 2020 206d 6178 5f52  atrix..    max_R
-0001e400: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-0001e410: 204d 6178 696d 756d 2073 7065 6374 7261   Maximum spectra
-0001e420: 6c20 7265 736f 6c75 7469 6f6e 206f 6620  l resolution of 
-0001e430: 7468 6520 7265 6772 6964 6465 6420 7465  the regridded te
-0001e440: 6d70 6c61 7465 732e 0a0a 2020 2020 4e64  mplates...    Nd
-0001e450: 7261 7720 3a20 696e 740a 2020 2020 2020  raw : int.      
-0001e460: 2020 4e75 6d62 6572 206f 6620 7261 6e64    Number of rand
-0001e470: 6f6d 2064 7261 7773 2074 6f20 6578 7472  om draws to extr
-0001e480: 6163 7420 6672 6f6d 2074 6865 2063 6f76  act from the cov
-0001e490: 6172 6961 6e63 6520 6d61 7472 6978 0a0a  ariance matrix..
-0001e4a0: 2020 2020 7365 6564 203a 2070 6f73 6974      seed : posit
-0001e4b0: 6976 6520 696e 740a 2020 2020 2020 2020  ive int.        
-0001e4c0: 5261 6e64 6f6d 206e 756d 6265 7220 7365  Random number se
-0001e4d0: 6564 2074 6f20 7072 6f64 7563 6520 7265  ed to produce re
-0001e4e0: 7065 6174 6962 6c65 2072 6573 756c 7473  peatible results
-0001e4f0: 2e20 4966 2060 4e6f 6e65 602c 2074 6865  . If `None`, the
-0001e500: 6e0a 2020 2020 2020 2020 7573 6520 6465  n.        use de
-0001e510: 6661 756c 7420 7374 6174 652e 0a0a 2020  fault state...  
-0001e520: 2020 7a20 3a20 666c 6f61 740a 2020 2020    z : float.    
-0001e530: 2020 2020 5265 6473 6869 6674 2077 6865      Redshift whe
-0001e540: 7265 2074 6865 2066 6974 2069 7320 6576  re the fit is ev
-0001e550: 616c 7561 7465 640a 0a20 2020 206f 6273  aluated..    obs
-0001e560: 6572 7665 645f 6672 616d 6d65 203a 2062  erved_framme : b
-0001e570: 6f6f 6c0a 2020 2020 2020 2020 4966 2074  ool.        If t
-0001e580: 7275 652c 2074 6865 6e20 636f 6d70 7574  rue, then comput
-0001e590: 6564 2045 5773 2061 7265 206f 6273 6572  ed EWs are obser
-0001e5a0: 7665 6420 6672 616d 652c 206f 7468 6572  ved frame, other
-0001e5b0: 7769 7365 2074 6865 7920 6172 650a 2020  wise they are.  
-0001e5c0: 2020 2020 2020 7265 7374 2066 7261 6d65        rest frame
-0001e5d0: 2061 7420 7265 6473 6869 6674 2060 7a60   at redshift `z`
-0001e5e0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-0001e5f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2045     -------.    E
-0001e600: 5764 6963 7420 3a20 6469 6374 0a20 2020  Wdict : dict.   
-0001e610: 2020 2020 2044 6963 7469 6f6e 6172 7920       Dictionary 
-0001e620: 6f66 205b 3136 2c20 3530 2c20 3834 7468  of [16, 50, 84th
-0001e630: 5d20 7065 7263 656e 7469 6c65 7320 6f66  ] percentiles of
-0001e640: 2074 6865 206c 696e 6520 4557 2064 6973   the line EW dis
-0001e650: 7472 6962 7574 696f 6e73 2e0a 0a20 2020  tributions...   
-0001e660: 2022 2222 0a0a 2020 2020 2320 4172 7261   """..    # Arra
-0001e670: 7920 7665 7273 696f 6e73 206f 6620 7468  y versions of th
-0001e680: 6520 7465 6d70 6c61 7465 730a 2020 2020  e templates.    
-0001e690: 7761 7665 2c20 666c 7578 5f61 7272 2c20  wave, flux_arr, 
-0001e6a0: 6973 5f6c 696e 6520 3d20 6172 7261 795f  is_line = array_
-0001e6b0: 7465 6d70 6c61 7465 7328 7465 6d70 6c61  templates(templa
-0001e6c0: 7465 732c 206d 6178 5f52 3d6d 6178 5f52  tes, max_R=max_R
-0001e6d0: 2c20 7a3d 7a29 0a20 2020 206b 6579 7320  , z=z).    keys 
-0001e6e0: 3d20 6e70 2e61 7272 6179 286c 6973 7428  = np.array(list(
-0001e6f0: 7465 6d70 6c61 7465 732e 6b65 7973 2829  templates.keys()
-0001e700: 2929 0a0a 2020 2020 4557 6469 6374 203d  ))..    EWdict =
-0001e710: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
-0001e720: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
-0001e730: 7973 5b69 735f 6c69 6e65 5d3a 0a20 2020  ys[is_line]:.   
-0001e740: 2020 2020 2045 5764 6963 745b 6b65 795d       EWdict[key]
-0001e750: 203d 2028 302e 2c20 302e 2c20 302e 290a   = (0., 0., 0.).
-0001e760: 0a20 2020 2023 204f 6e6c 7920 776f 7272  .    # Only worr
-0001e770: 7920 6162 6f75 7420 7465 6d70 6c61 7465  y about template
-0001e780: 7320 7769 7468 206e 6f6e 2d7a 6572 6f20  s with non-zero 
-0001e790: 636f 6566 6669 6369 656e 7473 2c20 7768  coefficients, wh
-0001e7a0: 6963 6820 7368 6f75 6c64 0a20 2020 2023  ich should.    #
-0001e7b0: 2062 6520 6163 636f 756e 7465 6420 666f   be accounted fo
-0001e7c0: 7220 696e 2074 6865 2063 6f76 6172 6961  r in the covaria
-0001e7d0: 6e63 6520 6172 7261 7920 2877 6974 6820  nce array (with 
-0001e7e0: 6765 745f 756e 6365 7274 6169 6e74 6965  get_uncertaintie
-0001e7f0: 733d 3229 0a20 2020 2063 6c69 7020 3d20  s=2).    clip = 
-0001e800: 636f 6566 6673 2021 3d20 300a 2020 2020  coeffs != 0.    
-0001e810: 2320 4e6f 2076 616c 6964 206c 696e 6573  # No valid lines
-0001e820: 0a20 2020 2069 6620 2869 735f 6c69 6e65  .    if (is_line
-0001e830: 2026 2063 6c69 7029 2e73 756d 2829 203d   & clip).sum() =
-0001e840: 3d20 303a 0a20 2020 2020 2020 2072 6574  = 0:.        ret
-0001e850: 7572 6e20 4557 6469 6374 0a0a 2020 2020  urn EWdict..    
-0001e860: 2320 5261 6e64 6f6d 2064 7261 7773 2066  # Random draws f
-0001e870: 726f 6d20 7468 6520 636f 7661 7269 616e  rom the covarian
-0001e880: 6365 206d 6174 7269 780a 2020 2020 636f  ce matrix.    co
-0001e890: 7661 725f 636c 6970 203d 2063 6f76 6172  var_clip = covar
-0001e8a0: 5b63 6c69 702c 203a 5d5b 3a2c 2063 6c69  [clip, :][:, cli
-0001e8b0: 705d 0a20 2020 2069 6620 7365 6564 2069  p].    if seed i
-0001e8c0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0001e8d0: 2020 2020 6e70 2e72 616e 646f 6d2e 7365      np.random.se
-0001e8e0: 6564 2873 6565 6429 0a0a 2020 2020 6472  ed(seed)..    dr
-0001e8f0: 6177 7320 3d20 6e70 2e72 616e 646f 6d2e  aws = np.random.
-0001e900: 6d75 6c74 6976 6172 6961 7465 5f6e 6f72  multivariate_nor
-0001e910: 6d61 6c28 636f 6566 6673 5b63 6c69 705d  mal(coeffs[clip]
-0001e920: 2c20 636f 7661 725f 636c 6970 2c20 7369  , covar_clip, si
-0001e930: 7a65 3d4e 6472 6177 290a 0a20 2020 2023  ze=Ndraw)..    #
-0001e940: 2045 7661 6c75 6174 6520 7468 6520 636f   Evaluate the co
-0001e950: 6e74 696e 7575 6d20 6669 7473 2066 726f  ntinuum fits fro
-0001e960: 6d20 7468 6520 6472 6177 730a 2020 2020  m the draws.    
-0001e970: 636f 6e74 696e 7575 6d20 3d20 6e70 2e64  continuum = np.d
-0001e980: 6f74 2864 7261 7773 2a28 7e69 735f 6c69  ot(draws*(~is_li
-0001e990: 6e65 5b63 6c69 705d 292c 2066 6c75 785f  ne[clip]), flux_
-0001e9a0: 6172 725b 636c 6970 2c20 3a5d 290a 0a20  arr[clip, :]).. 
-0001e9b0: 2020 2023 2043 6f6d 7075 7465 2074 6865     # Compute the
-0001e9c0: 2065 6d69 7373 696f 6e20 6c69 6e65 2045   emission line E
-0001e9d0: 5773 0a20 2020 2074 6964 7820 3d20 6e70  Ws.    tidx = np
-0001e9e0: 2e77 6865 7265 2869 735f 6c69 6e65 5b63  .where(is_line[c
-0001e9f0: 6c69 705d 295b 305d 0a20 2020 2066 6f72  lip])[0].    for
-0001ea00: 2069 7820 696e 2074 6964 783a 0a20 2020   ix in tidx:.   
-0001ea10: 2020 2020 206b 6579 203d 206b 6579 735b       key = keys[
-0001ea20: 636c 6970 5d5b 6978 5d0a 0a20 2020 2020  clip][ix]..     
-0001ea30: 2020 2023 204c 696e 6520 7465 6d70 6c61     # Line templa
-0001ea40: 7465 0a20 2020 2020 2020 206c 696e 6520  te.        line 
-0001ea50: 3d20 6e70 2e64 6f74 2864 7261 7773 5b3a  = np.dot(draws[:
-0001ea60: 2c20 6978 5d5b 3a2c 204e 6f6e 655d 2c20  , ix][:, None], 
-0001ea70: 666c 7578 5f61 7272 5b63 6c69 702c 203a  flux_arr[clip, :
-0001ea80: 5d5b 6978 2c20 3a5d 5b4e 6f6e 652c 203a  ][ix, :][None, :
-0001ea90: 5d29 0a0a 2020 2020 2020 2020 2320 5768  ])..        # Wh
-0001eaa0: 6572 6520 6c69 6e65 2074 656d 706c 6174  ere line templat
-0001eab0: 6520 6e6f 6e2d 7a65 726f 0a20 2020 2020  e non-zero.     
-0001eac0: 2020 206d 6173 6b20 3d20 666c 7578 5f61     mask = flux_a
-0001ead0: 7272 5b63 6c69 702c 203a 5d5b 6978 2c20  rr[clip, :][ix, 
-0001eae0: 3a5d 203e 2030 0a20 2020 2020 2020 2065  :] > 0.        e
-0001eaf0: 775f 6920 3d20 6e70 2e74 7261 707a 2828  w_i = np.trapz((
-0001eb00: 6c69 6e65 2f63 6f6e 7469 6e75 756d 295b  line/continuum)[
-0001eb10: 3a2c 206d 6173 6b5d 2c0a 2020 2020 2020  :, mask],.      
-0001eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb30: 2020 7761 7665 5b6d 6173 6b5d 2a28 312b    wave[mask]*(1+
-0001eb40: 7a2a 6f62 7365 7276 6564 5f66 7261 6d65  z*observed_frame
-0001eb50: 292c 2061 7869 733d 3129 0a0a 2020 2020  ), axis=1)..    
-0001eb60: 2020 2020 4557 6469 6374 5b6b 6579 5d20      EWdict[key] 
-0001eb70: 3d20 6e70 2e70 6572 6365 6e74 696c 6528  = np.percentile(
-0001eb80: 6577 5f69 2c20 5b31 362e 2c20 3530 2e2c  ew_i, [16., 50.,
-0001eb90: 2038 342e 5d29 0a0a 2020 2020 7265 7475   84.])..    retu
-0001eba0: 726e 2045 5764 6963 740a 0a23 2323 2323  rn EWdict..#####
-0001ebb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ebc0: 0a23 2050 686f 746f 6d65 7472 7920 6672  .# Photometry fr
-0001ebd0: 6f6d 2056 697a 6965 7220 7461 626c 6573  om Vizier tables
-0001ebe0: 0a0a 0a23 2043 4648 544c 530a 4346 4854  ...# CFHTLS.CFHT
-0001ebf0: 4c53 5f57 5f56 495a 4945 5220 3d20 2749  LS_W_VIZIER = 'I
-0001ec00: 492f 3331 372f 6366 6874 6c73 5f77 270a  I/317/cfhtls_w'.
-0001ec10: 4346 4854 4c53 5f57 5f42 414e 4453 203d  CFHTLS_W_BANDS =
-0001ec20: 204f 7264 6572 6564 4469 6374 285b 2827   OrderedDict([('
-0001ec30: 6366 6874 5f6d 6567 615f 7527 2c20 5b27  cfht_mega_u', ['
-0001ec40: 756d 6167 272c 2027 655f 756d 6167 275d  umag', 'e_umag']
-0001ec50: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec70: 2827 6366 6874 5f6d 6567 615f 6727 2c20  ('cfht_mega_g', 
-0001ec80: 5b27 676d 6167 272c 2027 655f 676d 6167  ['gmag', 'e_gmag
-0001ec90: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecb0: 2020 2827 6366 6874 5f6d 6567 615f 7227    ('cfht_mega_r'
-0001ecc0: 2c20 5b27 726d 6167 272c 2027 655f 726d  , ['rmag', 'e_rm
-0001ecd0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
-0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecf0: 2020 2020 2827 6366 6874 5f6d 6567 615f      ('cfht_mega_
-0001ed00: 6927 2c20 5b27 696d 6167 272c 2027 655f  i', ['imag', 'e_
-0001ed10: 696d 6167 275d 292c 0a20 2020 2020 2020  imag']),.       
-0001ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed30: 2020 2020 2020 2827 6366 6874 5f6d 6567        ('cfht_meg
-0001ed40: 615f 7a27 2c20 5b27 7a6d 6167 272c 2027  a_z', ['zmag', '
-0001ed50: 655f 7a6d 6167 275d 295d 290a 0a43 4648  e_zmag'])])..CFH
-0001ed60: 544c 535f 445f 5649 5a49 4552 203d 2027  TLS_D_VIZIER = '
-0001ed70: 4949 2f33 3137 2f63 6668 746c 735f 6427  II/317/cfhtls_d'
-0001ed80: 0a43 4648 544c 535f 445f 4241 4e44 5320  .CFHTLS_D_BANDS 
-0001ed90: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
-0001eda0: 2763 6668 745f 6d65 6761 5f75 272c 205b  'cfht_mega_u', [
-0001edb0: 2775 6d61 6727 2c20 2765 5f75 6d61 6727  'umag', 'e_umag'
-0001edc0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ede0: 2028 2763 6668 745f 6d65 6761 5f67 272c   ('cfht_mega_g',
-0001edf0: 205b 2767 6d61 6727 2c20 2765 5f67 6d61   ['gmag', 'e_gma
-0001ee00: 6727 5d29 2c0a 2020 2020 2020 2020 2020  g']),.          
-0001ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee20: 2020 2028 2763 6668 745f 6d65 6761 5f72     ('cfht_mega_r
-0001ee30: 272c 205b 2772 6d61 6727 2c20 2765 5f72  ', ['rmag', 'e_r
-0001ee40: 6d61 6727 5d29 2c0a 2020 2020 2020 2020  mag']),.        
-0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee60: 2020 2020 2028 2763 6668 745f 6d65 6761       ('cfht_mega
-0001ee70: 5f69 272c 205b 2769 6d61 6727 2c20 2765  _i', ['imag', 'e
-0001ee80: 5f69 6d61 6727 5d29 2c0a 2020 2020 2020  _imag']),.      
-0001ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eea0: 2020 2020 2020 2028 2763 6668 745f 6d65         ('cfht_me
-0001eeb0: 6761 5f7a 272c 205b 277a 6d61 6727 2c20  ga_z', ['zmag', 
-0001eec0: 2765 5f7a 6d61 6727 5d29 5d29 0a0a 2320  'e_zmag'])])..# 
-0001eed0: 5344 5353 2044 5231 320a 5344 5353 5f44  SDSS DR12.SDSS_D
-0001eee0: 5231 325f 5649 5a49 4552 203d 2027 562f  R12_VIZIER = 'V/
-0001eef0: 3134 372f 7364 7373 3132 270a 5344 5353  147/sdss12'.SDSS
-0001ef00: 5f44 5231 325f 4241 4e44 5320 3d20 4f72  _DR12_BANDS = Or
-0001ef10: 6465 7265 6444 6963 7428 5b28 2753 4453  deredDict([('SDS
-0001ef20: 532f 7527 2c20 5b27 756d 6167 272c 2027  S/u', ['umag', '
-0001ef30: 655f 756d 6167 275d 292c 0a20 2020 2020  e_umag']),.     
-0001ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef50: 2020 2020 2028 2753 4453 532f 6727 2c20       ('SDSS/g', 
-0001ef60: 5b27 676d 6167 272c 2027 655f 676d 6167  ['gmag', 'e_gmag
-0001ef70: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001ef80: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001ef90: 2753 4453 532f 7227 2c20 5b27 726d 6167  'SDSS/r', ['rmag
-0001efa0: 272c 2027 655f 726d 6167 275d 292c 0a20  ', 'e_rmag']),. 
+0001cce0: 2020 2020 2020 6f72 6465 723d 6f72 6465        order=orde
+0001ccf0: 722c 206c 696e 653d 4661 6c73 6529 0a0a  r, line=False)..
+0001cd00: 2020 2020 7074 656d 7020 3d20 4f72 6465      ptemp = Orde
+0001cd10: 7265 6444 6963 7428 290a 0a20 2020 2066  redDict()..    f
+0001cd20: 6f72 2069 2c20 7420 696e 2065 6e75 6d65  or i, t in enume
+0001cd30: 7261 7465 2874 7370 6c69 6e65 293a 0a20  rate(tspline):. 
+0001cd40: 2020 2020 2020 206e 616d 6520 3d20 277b         name = '{
+0001cd50: 307d 2070 6f6c 7920 7b31 7d27 2e66 6f72  0} poly {1}'.for
+0001cd60: 6d61 7428 7465 6d70 6c2e 6e61 6d65 2c20  mat(templ.name, 
+0001cd70: 6929 0a20 2020 2020 2020 2070 7465 6d70  i).        ptemp
+0001cd80: 5b6e 616d 655d 203d 2075 7469 6c73 2e53  [name] = utils.S
+0001cd90: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
+0001cda0: 7761 7665 3d74 656d 706c 2e77 6176 652c  wave=templ.wave,
+0001cdb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdd0: 2020 666c 7578 3d74 656d 706c 2e66 6c75    flux=templ.flu
+0001cde0: 782a 7473 706c 696e 655b 745d 2e66 6c75  x*tspline[t].flu
+0001cdf0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0001ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce10: 2020 2020 6e61 6d65 3d6e 616d 6529 0a20      name=name). 
+0001ce20: 2020 2020 2020 2070 7465 6d70 5b6e 616d         ptemp[nam
+0001ce30: 655d 2e72 6566 5f77 6176 6520 3d20 7265  e].ref_wave = re
+0001ce40: 665f 7761 7665 0a0a 2020 2020 7074 656d  f_wave..    ptem
+0001ce50: 702e 7265 665f 7761 7665 203d 2072 6566  p.ref_wave = ref
+0001ce60: 5f77 6176 650a 0a20 2020 2072 6574 7572  _wave..    retur
+0001ce70: 6e20 7074 656d 700a 0a0a 6465 6620 646f  n ptemp...def do
+0001ce80: 745f 7465 6d70 6c61 7465 7328 636f 6566  t_templates(coef
+0001ce90: 6673 2c20 7465 6d70 6c61 7465 732c 207a  fs, templates, z
+0001cea0: 3d30 2c20 6d61 785f 523d 3530 3030 2c20  =0, max_R=5000, 
+0001ceb0: 6170 706c 795f 6967 6d3d 5472 7565 293a  apply_igm=True):
+0001cec0: 0a20 2020 2022 2222 436f 6d70 7574 6520  .    """Compute 
+0001ced0: 7465 6d70 6c61 7465 2073 756d 2061 6e61  template sum ana
+0001cee0: 6c6f 676f 7573 2074 6f20 606e 702e 646f  logous to `np.do
+0001cef0: 7428 636f 6566 6673 2c20 7465 6d70 6c61  t(coeffs, templa
+0001cf00: 7465 7329 602e 0a20 2020 2022 2222 0a0a  tes)`..    """..
+0001cf10: 2020 2020 6966 206c 656e 2863 6f65 6666      if len(coeff
+0001cf20: 7329 2021 3d20 6c65 6e28 7465 6d70 6c61  s) != len(templa
+0001cf30: 7465 7329 3a0a 2020 2020 2020 2020 7261  tes):.        ra
+0001cf40: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+0001cf50: 7368 6170 6573 206f 6620 636f 6566 6673  shapes of coeffs
+0001cf60: 2028 7b30 7d29 2061 6e64 2074 656d 706c   ({0}) and templ
+0001cf70: 6174 6573 2028 7b31 7d29 2064 6f6e 5c27  ates ({1}) don\'
+0001cf80: 7420 6d61 7463 6827 2e66 6f72 6d61 7428  t match'.format(
+0001cf90: 6c65 6e28 636f 6566 6673 292c 206c 656e  len(coeffs), len
+0001cfa0: 2874 656d 706c 6174 6573 2929 290a 0a20  (templates))).. 
+0001cfb0: 2020 2023 2066 6f72 2069 2c20 7465 2069     # for i, te i
+0001cfc0: 6e20 656e 756d 6572 6174 6528 7465 6d70  n enumerate(temp
+0001cfd0: 6c61 7465 7329 3a0a 2020 2020 2320 2020  lates):.    #   
+0001cfe0: 2020 6966 2069 203d 3d20 303a 0a20 2020    if i == 0:.   
+0001cff0: 2023 2020 2020 2020 2020 2074 6320 3d20   #         tc = 
+0001d000: 7465 6d70 6c61 7465 735b 7465 5d2e 7a73  templates[te].zs
+0001d010: 6361 6c65 287a 2c20 7363 616c 6172 3d63  cale(z, scalar=c
+0001d020: 6f65 6666 735b 695d 290a 2020 2020 2320  oeffs[i]).    # 
+0001d030: 2020 2020 2020 2020 746c 203d 2074 656d          tl = tem
+0001d040: 706c 6174 6573 5b74 655d 2e7a 7363 616c  plates[te].zscal
+0001d050: 6528 7a2c 2073 6361 6c61 723d 636f 6566  e(z, scalar=coef
+0001d060: 6673 5b69 5d29 0a20 2020 2023 2020 2020  fs[i]).    #    
+0001d070: 2065 6c73 653a 0a20 2020 2023 2020 2020   else:.    #    
+0001d080: 2020 2020 2069 6620 7465 2e73 7461 7274       if te.start
+0001d090: 7377 6974 6828 276c 696e 6527 293a 0a20  swith('line'):. 
+0001d0a0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+0001d0b0: 2074 6320 2b3d 2074 656d 706c 6174 6573   tc += templates
+0001d0c0: 5b74 655d 2e7a 7363 616c 6528 7a2c 2073  [te].zscale(z, s
+0001d0d0: 6361 6c61 723d 302e 290a 2020 2020 2320  calar=0.).    # 
+0001d0e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001d0f0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+0001d100: 7463 202b 3d20 7465 6d70 6c61 7465 735b  tc += templates[
+0001d110: 7465 5d2e 7a73 6361 6c65 287a 2c20 7363  te].zscale(z, sc
+0001d120: 616c 6172 3d63 6f65 6666 735b 695d 290a  alar=coeffs[i]).
+0001d130: 2020 2020 230a 2020 2020 2320 2020 2020      #.    #     
+0001d140: 2020 2020 746c 202b 3d20 7465 6d70 6c61      tl += templa
+0001d150: 7465 735b 7465 5d2e 7a73 6361 6c65 287a  tes[te].zscale(z
+0001d160: 2c20 7363 616c 6172 3d63 6f65 6666 735b  , scalar=coeffs[
+0001d170: 695d 290a 2020 2020 7761 7665 2c20 666c  i]).    wave, fl
+0001d180: 7578 5f61 7272 2c20 6973 5f6c 696e 6520  ux_arr, is_line 
+0001d190: 3d20 6172 7261 795f 7465 6d70 6c61 7465  = array_template
+0001d1a0: 7328 7465 6d70 6c61 7465 732c 206d 6178  s(templates, max
+0001d1b0: 5f52 3d6d 6178 5f52 2c20 7a3d 7a2c 0a20  _R=max_R, z=z,. 
+0001d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1e0: 2020 2020 2020 2020 2020 2020 2061 7070               app
+0001d1f0: 6c79 5f69 676d 3d61 7070 6c79 5f69 676d  ly_igm=apply_igm
+0001d200: 290a 0a20 2020 2023 2023 2049 474d 0a20  )..    # # IGM. 
+0001d210: 2020 2023 2069 6620 6170 706c 795f 6967     # if apply_ig
+0001d220: 6d3a 0a20 2020 2023 2020 2020 2074 7279  m:.    #     try
+0001d230: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
+0001d240: 696d 706f 7274 2065 617a 792e 6967 6d0a  import eazy.igm.
+0001d250: 2020 2020 2320 2020 2020 2020 2020 4947      #         IG
+0001d260: 4d20 3d20 6561 7a79 2e69 676d 2e49 6e6f  M = eazy.igm.Ino
+0001d270: 7565 3134 2829 0a20 2020 2023 0a20 2020  ue14().    #.   
+0001d280: 2023 2020 2020 2020 2020 206c 796c 696d   #         lylim
+0001d290: 203d 2077 6176 6520 3c20 3132 3530 0a20   = wave < 1250. 
+0001d2a0: 2020 2023 2020 2020 2020 2020 2069 676d     #         igm
+0001d2b0: 7a20 3d20 6e70 2e6f 6e65 735f 6c69 6b65  z = np.ones_like
+0001d2c0: 2877 6176 6529 0a20 2020 2023 2020 2020  (wave).    #    
+0001d2d0: 2020 2020 2069 676d 7a5b 6c79 6c69 6d5d       igmz[lylim]
+0001d2e0: 203d 2049 474d 2e66 756c 6c5f 4947 4d28   = IGM.full_IGM(
+0001d2f0: 7a2c 2077 6176 655b 6c79 6c69 6d5d 2a28  z, wave[lylim]*(
+0001d300: 312b 7a29 290a 2020 2020 2320 2020 2020  1+z)).    #     
+0001d310: 6578 6365 7074 3a0a 2020 2020 2320 2020  except:.    #   
+0001d320: 2020 2020 2020 6967 6d7a 203d 2031 2e0a        igmz = 1..
+0001d330: 2020 2020 2320 656c 7365 3a0a 2020 2020      # else:.    
+0001d340: 2320 2020 2020 6967 6d7a 203d 2031 2e0a  #     igmz = 1..
+0001d350: 2020 2020 230a 2020 2020 2320 6973 5f6f      #.    # is_o
+0001d360: 6273 6672 616d 6520 3d20 6e70 2e61 7272  bsframe = np.arr
+0001d370: 6179 285b 742e 7370 6c69 7428 295b 305d  ay([t.split()[0]
+0001d380: 2069 6e20 5b27 6273 706c 272c 2027 7374   in ['bspl', 'st
+0001d390: 6570 275d 2066 6f72 2074 2069 6e20 7465  ep'] for t in te
+0001d3a0: 6d70 6c61 7465 735d 290a 2020 2020 230a  mplates]).    #.
+0001d3b0: 2020 2020 2320 666c 7578 5f61 7272 5b7e      # flux_arr[~
+0001d3c0: 6973 5f6f 6273 6672 616d 652c 3a5d 202a  is_obsframe,:] *
+0001d3d0: 3d20 6967 6d7a 0a20 2020 2023 0a20 2020  = igmz.    #.   
+0001d3e0: 2023 2023 204d 756c 7469 706c 7920 7370   # # Multiply sp
+0001d3f0: 6c69 6e65 3f0a 2020 2020 2320 666f 7220  line?.    # for 
+0001d400: 692c 2074 2069 6e20 656e 756d 6572 6174  i, t in enumerat
+0001d410: 6528 7465 6d70 6c61 7465 7329 3a0a 2020  e(templates):.  
+0001d420: 2020 2320 2020 2020 6966 2027 7370 6c69    #     if 'spli
+0001d430: 6e65 2720 696e 2074 3a0a 2020 2020 2320  ne' in t:.    # 
+0001d440: 2020 2020 2020 2020 666f 7220 6a2c 2074          for j, t
+0001d450: 6a20 696e 2065 6e75 6d65 7261 7465 2874  j in enumerate(t
+0001d460: 656d 706c 6174 6573 293a 0a20 2020 2023  emplates):.    #
+0001d470: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001d480: 6973 5f6f 6273 6672 616d 655b 6a5d 3a0a  is_obsframe[j]:.
+0001d490: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+0001d4a0: 2020 2020 2020 7072 696e 7428 2773 6361        print('sca
+0001d4b0: 6c65 2073 706c 696e 653a 207b 307d 2078  le spline: {0} x
+0001d4c0: 207b 317d 272e 666f 726d 6174 2874 6a2c   {1}'.format(tj,
+0001d4d0: 2074 2929 0a20 2020 2023 2020 2020 2020   t)).    #      
+0001d4e0: 2020 2020 2020 2020 2020 2066 6c75 785f             flux_
+0001d4f0: 6172 725b 6a2c 3a5d 202a 3d20 666c 7578  arr[j,:] *= flux
+0001d500: 5f61 7272 5b69 2c3a 5d0a 0a20 2020 2023  _arr[i,:]..    #
+0001d510: 2043 6f6e 7469 6e75 756d 0a20 2020 2063   Continuum.    c
+0001d520: 6f6e 7420 3d20 6e70 2e64 6f74 2863 6f65  ont = np.dot(coe
+0001d530: 6666 732a 287e 6973 5f6c 696e 6529 2c20  ffs*(~is_line), 
+0001d540: 666c 7578 5f61 7272 290a 2020 2020 7463  flux_arr).    tc
+0001d550: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
+0001d560: 6174 6528 7761 7665 3d77 6176 652c 2066  ate(wave=wave, f
+0001d570: 6c75 783d 636f 6e74 292e 7a73 6361 6c65  lux=cont).zscale
+0001d580: 287a 2c20 6170 706c 795f 6967 6d3d 4661  (z, apply_igm=Fa
+0001d590: 6c73 6529 0a0a 2020 2020 2320 4675 6c6c  lse)..    # Full
+0001d5a0: 2074 656d 706c 6174 650a 2020 2020 6c69   template.    li
+0001d5b0: 6e65 203d 206e 702e 646f 7428 636f 6566  ne = np.dot(coef
+0001d5c0: 6673 2c20 666c 7578 5f61 7272 290a 2020  fs, flux_arr).  
+0001d5d0: 2020 746c 203d 2053 7065 6374 7275 6d54    tl = SpectrumT
+0001d5e0: 656d 706c 6174 6528 7761 7665 3d77 6176  emplate(wave=wav
+0001d5f0: 652c 2066 6c75 783d 6c69 6e65 292e 7a73  e, flux=line).zs
+0001d600: 6361 6c65 287a 2c20 6170 706c 795f 6967  cale(z, apply_ig
+0001d610: 6d3d 4661 6c73 6529 0a0a 2020 2020 7265  m=False)..    re
+0001d620: 7475 726e 2074 632c 2074 6c0a 0a0a 6465  turn tc, tl...de
+0001d630: 6620 6172 7261 795f 7465 6d70 6c61 7465  f array_template
+0001d640: 7328 7465 6d70 6c61 7465 732c 2077 6176  s(templates, wav
+0001d650: 653d 4e6f 6e65 2c20 6d61 785f 523d 3530  e=None, max_R=50
+0001d660: 3030 2c20 7a3d 302c 2061 7070 6c79 5f69  00, z=0, apply_i
+0001d670: 676d 3d46 616c 7365 293a 0a20 2020 2022  gm=False):.    "
+0001d680: 2222 5265 7475 726e 2061 6e20 6172 7261  ""Return an arra
+0001d690: 7920 7665 7273 696f 6e20 6f66 2074 6865  y version of the
+0001d6a0: 2074 656d 706c 6174 6573 2074 6861 7420   templates that 
+0001d6b0: 6861 7665 2061 6c6c 2062 6565 6e20 696e  have all been in
+0001d6c0: 7465 7270 6f6c 6174 6564 2074 6f20 7468  terpolated to th
+0001d6d0: 6520 7361 6d65 2067 7269 642e 0a0a 0a20  e same grid.... 
+0001d6e0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+0001d6f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0001d700: 2074 656d 706c 6174 6573 203a 2064 6963   templates : dic
+0001d710: 7469 6f6e 6172 7920 6f66 2060 7e67 7269  tionary of `~gri
+0001d720: 7a6c 692e 7574 696c 732e 5370 6563 7472  zli.utils.Spectr
+0001d730: 756d 5465 6d70 6c61 7465 6020 6f62 6a65  umTemplate` obje
+0001d740: 6374 730a 2020 2020 2020 2020 4f75 7470  cts.        Outp
+0001d750: 7574 2074 656d 706c 6174 6520 6c69 7374  ut template list
+0001d760: 2077 6974 6820 604e 5445 4d50 6020 7465   with `NTEMP` te
+0001d770: 6d70 6c61 7465 732e 0a0a 2020 2020 6d61  mplates...    ma
+0001d780: 785f 5220 3a20 666c 6f61 740a 2020 2020  x_R : float.    
+0001d790: 2020 2020 4d61 7869 6d75 6d20 7370 6563      Maximum spec
+0001d7a0: 7472 616c 2072 6573 6f6c 7574 696f 6e20  tral resolution 
+0001d7b0: 6f66 2074 6865 2072 6567 7269 6464 6564  of the regridded
+0001d7c0: 2074 656d 706c 6174 6573 2e0a 0a20 2020   templates...   
+0001d7d0: 207a 203a 2066 6c6f 6174 0a20 2020 2020   z : float.     
+0001d7e0: 2020 2052 6564 7368 6966 7420 7768 6572     Redshift wher
+0001d7f0: 6520 746f 2065 7661 6c75 6174 6520 7468  e to evaluate th
+0001d800: 6520 7465 6d70 6c61 7465 732e 2020 4275  e templates.  Bu
+0001d810: 7420 6e6f 7465 2074 6861 7420 7468 6973  t note that this
+0001d820: 2069 7320 6f6e 6c79 0a20 2020 2020 2020   is only.       
+0001d830: 2075 7365 6420 746f 2073 6869 6674 2074   used to shift t
+0001d840: 656d 706c 6174 6573 2070 726f 6475 6365  emplates produce
+0001d850: 6420 6279 2060 6273 706c 696e 655f 7465  d by `bspline_te
+0001d860: 6d70 6c61 7465 7360 2c20 7768 6963 6820  mplates`, which 
+0001d870: 6172 650a 2020 2020 2020 2020 6465 6669  are.        defi
+0001d880: 6e65 6420 696e 2074 6865 206f 6273 6572  ned in the obser
+0001d890: 7665 6420 6672 616d 652e 0a0a 2020 2020  ved frame...    
+0001d8a0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+0001d8b0: 2d2d 2d0a 2020 2020 7761 7665 203a 2060  ---.    wave : `
+0001d8c0: 7e6e 756d 7079 2e6e 6461 7272 6179 602c  ~numpy.ndarray`,
+0001d8d0: 2064 696d 656e 7369 6f6e 7320 6028 4e4c   dimensions `(NL
+0001d8e0: 2c29 600a 2020 2020 2020 2020 4172 7261  ,)`.        Arra
+0001d8f0: 7920 636f 6e74 6169 6e69 6e67 2075 6e69  y containing uni
+0001d900: 7175 6520 7761 7665 6c65 6e67 7468 732e  que wavelengths.
+0001d910: 0a0a 2020 2020 666c 7578 5f61 7272 203a  ..    flux_arr :
+0001d920: 2060 7e6e 756d 7079 2e6e 6461 7272 6179   `~numpy.ndarray
+0001d930: 602c 2064 696d 656e 7369 6f6e 7320 6028  `, dimensions `(
+0001d940: 4e54 454d 502c 204e 4c29 600a 2020 2020  NTEMP, NL)`.    
+0001d950: 2020 2020 4172 7261 7920 636f 6e74 6169      Array contai
+0001d960: 6e69 6e67 2074 6865 2074 656d 706c 6174  ning the templat
+0001d970: 6520 666c 7578 6573 2069 6e74 6572 706f  e fluxes interpo
+0001d980: 6c61 7465 6420 6174 2060 7761 7665 602e  lated at `wave`.
+0001d990: 0a0a 2020 2020 6973 5f6c 696e 6520 3a20  ..    is_line : 
+0001d9a0: 607e 6e75 6d70 792e 6e64 6172 7261 7960  `~numpy.ndarray`
+0001d9b0: 0a20 2020 2020 2020 2042 6f6f 6c65 616e  .        Boolean
+0001d9c0: 2061 7272 6179 2069 6e64 6963 6174 696e   array indicatin
+0001d9d0: 6720 656d 6973 7369 6f6e 206c 696e 6520  g emission line 
+0001d9e0: 7465 6d70 6c61 7465 7320 2874 6865 206b  templates (the k
+0001d9f0: 6579 2069 6e20 7468 650a 2020 2020 2020  ey in the.      
+0001da00: 2020 7465 6d70 6c61 7465 2064 6963 7469    template dicti
+0001da10: 6f6e 6172 7920 7374 6172 7473 2077 6974  onary starts wit
+0001da20: 6820 226c 696e 6520 2229 2e0a 0a20 2020  h "line ")...   
+0001da30: 2022 2222 0a20 2020 2066 726f 6d20 6772   """.    from gr
+0001da40: 697a 6c69 2e75 7469 6c73 5f63 2e69 6e74  izli.utils_c.int
+0001da50: 6572 7020 696d 706f 7274 2069 6e74 6572  erp import inter
+0001da60: 705f 636f 6e73 6572 7665 5f63 0a0a 2020  p_conserve_c..  
+0001da70: 2020 6966 2077 6176 6520 6973 204e 6f6e    if wave is Non
+0001da80: 653a 0a20 2020 2020 2020 2077 7374 6163  e:.        wstac
+0001da90: 6b20 3d20 5b5d 0a20 2020 2020 2020 2066  k = [].        f
+0001daa0: 6f72 2074 2069 6e20 7465 6d70 6c61 7465  or t in template
+0001dab0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0001dac0: 6620 742e 7370 6c69 7428 295b 305d 2069  f t.split()[0] i
+0001dad0: 6e20 5b27 6273 706c 272c 2027 7374 6570  n ['bspl', 'step
+0001dae0: 272c 2027 706f 6c79 275d 3a0a 2020 2020  ', 'poly']:.    
+0001daf0: 2020 2020 2020 2020 2020 2020 7773 7461              wsta
+0001db00: 636b 2e61 7070 656e 6428 7465 6d70 6c61  ck.append(templa
+0001db10: 7465 735b 745d 2e77 6176 652f 2831 2b7a  tes[t].wave/(1+z
+0001db20: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+0001db30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001db40: 2020 2020 2077 7374 6163 6b2e 6170 7065       wstack.appe
+0001db50: 6e64 2874 656d 706c 6174 6573 5b74 5d2e  nd(templates[t].
+0001db60: 7761 7665 290a 0a20 2020 2020 2020 2077  wave)..        w
+0001db70: 6176 6520 3d20 6e70 2e75 6e69 7175 6528  ave = np.unique(
+0001db80: 6e70 2e68 7374 6163 6b28 7773 7461 636b  np.hstack(wstack
+0001db90: 2929 0a0a 2020 2020 636c 6970 7375 6d2c  ))..    clipsum,
+0001dba0: 2069 7465 7220 3d20 312c 2030 0a20 2020   iter = 1, 0.   
+0001dbb0: 2077 6869 6c65 2028 636c 6970 7375 6d20   while (clipsum 
+0001dbc0: 3e20 3029 2026 2028 6974 6572 203c 2031  > 0) & (iter < 1
+0001dbd0: 3029 3a0a 2020 2020 2020 2020 636c 6970  0):.        clip
+0001dbe0: 203d 206e 702e 6772 6164 6965 6e74 2877   = np.gradient(w
+0001dbf0: 6176 6529 2f77 6176 6520 3c20 312f 6d61  ave)/wave < 1/ma
+0001dc00: 785f 520a 2020 2020 2020 2020 6964 7820  x_R.        idx 
+0001dc10: 3d20 6e70 2e61 7261 6e67 6528 6c65 6e28  = np.arange(len(
+0001dc20: 7761 7665 2929 5b63 6c69 705d 0a20 2020  wave))[clip].   
+0001dc30: 2020 2020 2077 6176 655b 6964 785b 3a3a       wave[idx[::
+0001dc40: 325d 5d20 3d20 6e70 2e6e 616e 0a20 2020  2]] = np.nan.   
+0001dc50: 2020 2020 2077 6176 6520 3d20 7761 7665       wave = wave
+0001dc60: 5b6e 702e 6973 6669 6e69 7465 2877 6176  [np.isfinite(wav
+0001dc70: 6529 5d0a 2020 2020 2020 2020 6974 6572  e)].        iter
+0001dc80: 202b 3d20 310a 2020 2020 2020 2020 636c   += 1.        cl
+0001dc90: 6970 7375 6d20 3d20 636c 6970 2e73 756d  ipsum = clip.sum
+0001dca0: 2829 0a20 2020 2020 2020 2023 7072 696e  ().        #prin
+0001dcb0: 7428 6974 6572 2c20 636c 6970 7375 6d29  t(iter, clipsum)
+0001dcc0: 0a0a 2020 2020 4e54 454d 5020 3d20 6c65  ..    NTEMP = le
+0001dcd0: 6e28 7465 6d70 6c61 7465 7329 0a20 2020  n(templates).   
+0001dce0: 2066 6c75 785f 6172 7220 3d20 6e70 2e7a   flux_arr = np.z
+0001dcf0: 6572 6f73 2828 4e54 454d 502c 206c 656e  eros((NTEMP, len
+0001dd00: 2877 6176 6529 2929 0a0a 2020 2020 666f  (wave)))..    fo
+0001dd10: 7220 692c 2074 2069 6e20 656e 756d 6572  r i, t in enumer
+0001dd20: 6174 6528 7465 6d70 6c61 7465 7329 3a0a  ate(templates):.
+0001dd30: 2020 2020 2020 2020 6966 2074 2e73 706c          if t.spl
+0001dd40: 6974 2829 5b30 5d20 696e 205b 2762 7370  it()[0] in ['bsp
+0001dd50: 6c27 2c20 2773 7465 7027 2c20 2770 6f6c  l', 'step', 'pol
+0001dd60: 7927 5d3a 0a20 2020 2020 2020 2020 2020  y']:.           
+0001dd70: 2066 6c75 785f 6172 725b 692c 203a 5d20   flux_arr[i, :] 
+0001dd80: 3d20 696e 7465 7270 5f63 6f6e 7365 7276  = interp_conserv
+0001dd90: 655f 6328 7761 7665 2c20 7465 6d70 6c61  e_c(wave, templa
+0001dda0: 7465 735b 745d 2e77 6176 652f 2831 2b7a  tes[t].wave/(1+z
+0001ddb0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddd0: 2020 2020 2020 2020 2020 2020 2074 656d               tem
+0001dde0: 706c 6174 6573 5b74 5d2e 666c 7578 2a28  plates[t].flux*(
+0001ddf0: 312b 7a29 290a 2020 2020 2020 2020 656c  1+z)).        el
+0001de00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001de10: 6966 2068 6173 6174 7472 2874 656d 706c  if hasattr(templ
+0001de20: 6174 6573 5b74 5d2c 2027 666c 7578 5f66  ates[t], 'flux_f
+0001de30: 6c61 6d27 293a 0a20 2020 2020 2020 2020  lam'):.         
+0001de40: 2020 2020 2020 2023 2052 6564 7368 6966         # Redshif
+0001de50: 742d 6465 7065 6e64 656e 7420 6561 7a79  t-dependent eazy
+0001de60: 2d70 7920 5465 6d70 6c61 7465 0a20 2020  -py Template.   
+0001de70: 2020 2020 2020 2020 2020 2020 2066 6c75               flu
+0001de80: 785f 6172 725b 692c 203a 5d20 3d20 696e  x_arr[i, :] = in
+0001de90: 7465 7270 5f63 6f6e 7365 7276 655f 6328  terp_conserve_c(
+0001dea0: 7761 7665 2c20 7465 6d70 6c61 7465 735b  wave, templates[
+0001deb0: 745d 2e77 6176 652c 0a20 2020 2020 2020  t].wave,.       
+0001dec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dee0: 2020 2074 656d 706c 6174 6573 5b74 5d2e     templates[t].
+0001def0: 666c 7578 5f66 6c61 6d28 7a3d 7a29 290a  flux_flam(z=z)).
+0001df00: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001df10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001df20: 2020 666c 7578 5f61 7272 5b69 2c20 3a5d    flux_arr[i, :]
+0001df30: 203d 2069 6e74 6572 705f 636f 6e73 6572   = interp_conser
+0001df40: 7665 5f63 2877 6176 652c 2074 656d 706c  ve_c(wave, templ
+0001df50: 6174 6573 5b74 5d2e 7761 7665 2c0a 2020  ates[t].wave,.  
+0001df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df80: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
+0001df90: 735b 745d 2e66 6c75 7829 0a0a 2020 2020  s[t].flux)..    
+0001dfa0: 6973 5f6c 696e 6520 3d20 6e70 2e61 7272  is_line = np.arr
+0001dfb0: 6179 285b 742e 7374 6172 7473 7769 7468  ay([t.startswith
+0001dfc0: 2827 6c69 6e65 2027 2920 666f 7220 7420  ('line ') for t 
+0001dfd0: 696e 2074 656d 706c 6174 6573 5d29 0a0a  in templates])..
+0001dfe0: 2020 2020 2320 4947 4d0a 2020 2020 6966      # IGM.    if
+0001dff0: 2061 7070 6c79 5f69 676d 3a0a 2020 2020   apply_igm:.    
+0001e000: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001e010: 2020 2020 2069 6d70 6f72 7420 6561 7a79       import eazy
+0001e020: 2e69 676d 0a20 2020 2020 2020 2020 2020  .igm.           
+0001e030: 2049 474d 203d 2065 617a 792e 6967 6d2e   IGM = eazy.igm.
+0001e040: 496e 6f75 6531 3428 290a 0a20 2020 2020  Inoue14()..     
+0001e050: 2020 2020 2020 206c 796c 696d 203d 2077         lylim = w
+0001e060: 6176 6520 3c20 3132 3530 0a20 2020 2020  ave < 1250.     
+0001e070: 2020 2020 2020 2069 676d 7a20 3d20 6e70         igmz = np
+0001e080: 2e6f 6e65 735f 6c69 6b65 2877 6176 6529  .ones_like(wave)
+0001e090: 0a20 2020 2020 2020 2020 2020 2069 676d  .            igm
+0001e0a0: 7a5b 6c79 6c69 6d5d 203d 2049 474d 2e66  z[lylim] = IGM.f
+0001e0b0: 756c 6c5f 4947 4d28 7a2c 2077 6176 655b  ull_IGM(z, wave[
+0001e0c0: 6c79 6c69 6d5d 2a28 312b 7a29 290a 2020  lylim]*(1+z)).  
+0001e0d0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+0001e0e0: 2020 2020 2020 2020 2020 6967 6d7a 203d            igmz =
+0001e0f0: 2031 2e0a 2020 2020 656c 7365 3a0a 2020   1..    else:.  
+0001e100: 2020 2020 2020 6967 6d7a 203d 2031 2e0a        igmz = 1..
+0001e110: 0a20 2020 206f 6273 6e61 6d65 7320 3d20  .    obsnames = 
+0001e120: 5b27 6273 706c 272c 2027 7374 6570 272c  ['bspl', 'step',
+0001e130: 2027 706f 6c79 275d 0a20 2020 2069 735f   'poly'].    is_
+0001e140: 6f62 7366 7261 6d65 203d 206e 702e 6172  obsframe = np.ar
+0001e150: 7261 7928 5b74 2e73 706c 6974 2829 5b30  ray([t.split()[0
+0001e160: 5d20 696e 206f 6273 6e61 6d65 7320 666f  ] in obsnames fo
+0001e170: 7220 7420 696e 2074 656d 706c 6174 6573  r t in templates
+0001e180: 5d29 0a0a 2020 2020 666c 7578 5f61 7272  ])..    flux_arr
+0001e190: 5b7e 6973 5f6f 6273 6672 616d 652c 203a  [~is_obsframe, :
+0001e1a0: 5d20 2a3d 2069 676d 7a0a 0a20 2020 2023  ] *= igmz..    #
+0001e1b0: 204d 756c 7469 706c 7920 7370 6c69 6e65   Multiply spline
+0001e1c0: 3f0a 2020 2020 666f 7220 692c 2074 2069  ?.    for i, t i
+0001e1d0: 6e20 656e 756d 6572 6174 6528 7465 6d70  n enumerate(temp
+0001e1e0: 6c61 7465 7329 3a0a 2020 2020 2020 2020  lates):.        
+0001e1f0: 6966 2027 7370 6c69 6e65 2720 696e 2074  if 'spline' in t
+0001e200: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0001e210: 7220 6a2c 2074 6a20 696e 2065 6e75 6d65  r j, tj in enume
+0001e220: 7261 7465 2874 656d 706c 6174 6573 293a  rate(templates):
+0001e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e240: 2069 6620 6973 5f6f 6273 6672 616d 655b   if is_obsframe[
+0001e250: 6a5d 3a0a 2020 2020 2020 2020 2020 2020  j]:.            
+0001e260: 2020 2020 2020 2020 6d61 203d 2066 6c75          ma = flu
+0001e270: 785f 6172 725b 6a2c 203a 5d2e 7375 6d28  x_arr[j, :].sum(
+0001e280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001e290: 2020 2020 2020 6d61 203d 206d 6120 6966        ma = ma if
+0001e2a0: 206d 6120 3e20 3020 656c 7365 2031 0a20   ma > 0 else 1. 
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2c0: 2020 206d 6120 3d20 310a 0a20 2020 2020     ma = 1..     
+0001e2d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e2e0: 6c75 785f 6172 725b 6a2c 203a 5d20 2a3d  lux_arr[j, :] *=
+0001e2f0: 2066 6c75 785f 6172 725b 692c 203a 5d2f   flux_arr[i, :]/
+0001e300: 6d61 0a0a 2020 2020 7265 7475 726e 2077  ma..    return w
+0001e310: 6176 652c 2066 6c75 785f 6172 722c 2069  ave, flux_arr, i
+0001e320: 735f 6c69 6e65 0a0a 0a64 6566 2063 6f6d  s_line...def com
+0001e330: 7075 7465 5f65 7175 6976 616c 656e 745f  pute_equivalent_
+0001e340: 7769 6474 6873 2874 656d 706c 6174 6573  widths(templates
+0001e350: 2c20 636f 6566 6673 2c20 636f 7661 722c  , coeffs, covar,
+0001e360: 206d 6178 5f52 3d35 3030 302c 204e 6472   max_R=5000, Ndr
+0001e370: 6177 3d31 3030 302c 2073 6565 643d 302c  aw=1000, seed=0,
+0001e380: 207a 3d30 2c20 6f62 7365 7276 6564 5f66   z=0, observed_f
+0001e390: 7261 6d65 3d46 616c 7365 293a 0a20 2020  rame=False):.   
+0001e3a0: 2022 2222 436f 6d70 7574 6520 7465 6d70   """Compute temp
+0001e3b0: 6c61 7465 2d66 6974 2065 6d69 7373 696f  late-fit emissio
+0001e3c0: 6e20 6c69 6e65 2065 7175 6976 616c 656e  n line equivalen
+0001e3d0: 7420 7769 6474 6873 0a0a 2020 2020 5061  t widths..    Pa
+0001e3e0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0001e3f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7465 6d70  -------.    temp
+0001e400: 6c61 7465 7320 3a20 6469 6374 696f 6e61  lates : dictiona
+0001e410: 7279 206f 6620 607e 6772 697a 6c69 2e75  ry of `~grizli.u
+0001e420: 7469 6c73 2e53 7065 6374 7275 6d54 656d  tils.SpectrumTem
+0001e430: 706c 6174 6560 206f 626a 6563 7473 0a20  plate` objects. 
+0001e440: 2020 2020 2020 204f 7574 7075 7420 7465         Output te
+0001e450: 6d70 6c61 7465 206c 6973 7420 7769 7468  mplate list with
+0001e460: 2060 4e54 454d 5060 2074 656d 706c 6174   `NTEMP` templat
+0001e470: 6573 2e0a 0a20 2020 2063 6f65 6666 7320  es...    coeffs 
+0001e480: 3a20 607e 6e75 6d70 792e 6e64 6172 7261  : `~numpy.ndarra
+0001e490: 7960 2c20 6469 6d65 6e73 696f 6e73 2028  y`, dimensions (
+0001e4a0: 604e 5445 4d50 6029 0a20 2020 2020 2020  `NTEMP`).       
+0001e4b0: 2046 6974 2063 6f65 6666 6963 6965 6e74   Fit coefficient
+0001e4c0: 730a 0a20 2020 2063 6f76 6172 203a 2020  s..    covar :  
+0001e4d0: 607e 6e75 6d70 792e 6e64 6172 7261 7960  `~numpy.ndarray`
+0001e4e0: 2c20 6469 6d65 6e73 696f 6e73 2028 604e  , dimensions (`N
+0001e4f0: 5445 4d50 602c 2060 4e54 454d 5060 290a  TEMP`, `NTEMP`).
+0001e500: 2020 2020 2020 2020 436f 7661 7269 616e          Covarian
+0001e510: 6365 206d 6174 7269 780a 0a20 2020 206d  ce matrix..    m
+0001e520: 6178 5f52 203a 2066 6c6f 6174 0a20 2020  ax_R : float.   
+0001e530: 2020 2020 204d 6178 696d 756d 2073 7065       Maximum spe
+0001e540: 6374 7261 6c20 7265 736f 6c75 7469 6f6e  ctral resolution
+0001e550: 206f 6620 7468 6520 7265 6772 6964 6465   of the regridde
+0001e560: 6420 7465 6d70 6c61 7465 732e 0a0a 2020  d templates...  
+0001e570: 2020 4e64 7261 7720 3a20 696e 740a 2020    Ndraw : int.  
+0001e580: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
+0001e590: 7261 6e64 6f6d 2064 7261 7773 2074 6f20  random draws to 
+0001e5a0: 6578 7472 6163 7420 6672 6f6d 2074 6865  extract from the
+0001e5b0: 2063 6f76 6172 6961 6e63 6520 6d61 7472   covariance matr
+0001e5c0: 6978 0a0a 2020 2020 7365 6564 203a 2070  ix..    seed : p
+0001e5d0: 6f73 6974 6976 6520 696e 740a 2020 2020  ositive int.    
+0001e5e0: 2020 2020 5261 6e64 6f6d 206e 756d 6265      Random numbe
+0001e5f0: 7220 7365 6564 2074 6f20 7072 6f64 7563  r seed to produc
+0001e600: 6520 7265 7065 6174 6962 6c65 2072 6573  e repeatible res
+0001e610: 756c 7473 2e20 4966 2060 4e6f 6e65 602c  ults. If `None`,
+0001e620: 2074 6865 6e0a 2020 2020 2020 2020 7573   then.        us
+0001e630: 6520 6465 6661 756c 7420 7374 6174 652e  e default state.
+0001e640: 0a0a 2020 2020 7a20 3a20 666c 6f61 740a  ..    z : float.
+0001e650: 2020 2020 2020 2020 5265 6473 6869 6674          Redshift
+0001e660: 2077 6865 7265 2074 6865 2066 6974 2069   where the fit i
+0001e670: 7320 6576 616c 7561 7465 640a 0a20 2020  s evaluated..   
+0001e680: 206f 6273 6572 7665 645f 6672 616d 6d65   observed_framme
+0001e690: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+0001e6a0: 4966 2074 7275 652c 2074 6865 6e20 636f  If true, then co
+0001e6b0: 6d70 7574 6564 2045 5773 2061 7265 206f  mputed EWs are o
+0001e6c0: 6273 6572 7665 6420 6672 616d 652c 206f  bserved frame, o
+0001e6d0: 7468 6572 7769 7365 2074 6865 7920 6172  therwise they ar
+0001e6e0: 650a 2020 2020 2020 2020 7265 7374 2066  e.        rest f
+0001e6f0: 7261 6d65 2061 7420 7265 6473 6869 6674  rame at redshift
+0001e700: 2060 7a60 2e0a 0a20 2020 2052 6574 7572   `z`...    Retur
+0001e710: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0001e720: 2020 2045 5764 6963 7420 3a20 6469 6374     EWdict : dict
+0001e730: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
+0001e740: 6172 7920 6f66 205b 3136 2c20 3530 2c20  ary of [16, 50, 
+0001e750: 3834 7468 5d20 7065 7263 656e 7469 6c65  84th] percentile
+0001e760: 7320 6f66 2074 6865 206c 696e 6520 4557  s of the line EW
+0001e770: 2064 6973 7472 6962 7574 696f 6e73 2e0a   distributions..
+0001e780: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
+0001e790: 4172 7261 7920 7665 7273 696f 6e73 206f  Array versions o
+0001e7a0: 6620 7468 6520 7465 6d70 6c61 7465 730a  f the templates.
+0001e7b0: 2020 2020 7761 7665 2c20 666c 7578 5f61      wave, flux_a
+0001e7c0: 7272 2c20 6973 5f6c 696e 6520 3d20 6172  rr, is_line = ar
+0001e7d0: 7261 795f 7465 6d70 6c61 7465 7328 7465  ray_templates(te
+0001e7e0: 6d70 6c61 7465 732c 206d 6178 5f52 3d6d  mplates, max_R=m
+0001e7f0: 6178 5f52 2c20 7a3d 7a29 0a20 2020 206b  ax_R, z=z).    k
+0001e800: 6579 7320 3d20 6e70 2e61 7272 6179 286c  eys = np.array(l
+0001e810: 6973 7428 7465 6d70 6c61 7465 732e 6b65  ist(templates.ke
+0001e820: 7973 2829 2929 0a0a 2020 2020 4557 6469  ys()))..    EWdi
+0001e830: 6374 203d 204f 7264 6572 6564 4469 6374  ct = OrderedDict
+0001e840: 2829 0a20 2020 2066 6f72 206b 6579 2069  ().    for key i
+0001e850: 6e20 6b65 7973 5b69 735f 6c69 6e65 5d3a  n keys[is_line]:
+0001e860: 0a20 2020 2020 2020 2045 5764 6963 745b  .        EWdict[
+0001e870: 6b65 795d 203d 2028 302e 2c20 302e 2c20  key] = (0., 0., 
+0001e880: 302e 290a 0a20 2020 2023 204f 6e6c 7920  0.)..    # Only 
+0001e890: 776f 7272 7920 6162 6f75 7420 7465 6d70  worry about temp
+0001e8a0: 6c61 7465 7320 7769 7468 206e 6f6e 2d7a  lates with non-z
+0001e8b0: 6572 6f20 636f 6566 6669 6369 656e 7473  ero coefficients
+0001e8c0: 2c20 7768 6963 6820 7368 6f75 6c64 0a20  , which should. 
+0001e8d0: 2020 2023 2062 6520 6163 636f 756e 7465     # be accounte
+0001e8e0: 6420 666f 7220 696e 2074 6865 2063 6f76  d for in the cov
+0001e8f0: 6172 6961 6e63 6520 6172 7261 7920 2877  ariance array (w
+0001e900: 6974 6820 6765 745f 756e 6365 7274 6169  ith get_uncertai
+0001e910: 6e74 6965 733d 3229 0a20 2020 2063 6c69  nties=2).    cli
+0001e920: 7020 3d20 636f 6566 6673 2021 3d20 300a  p = coeffs != 0.
+0001e930: 2020 2020 2320 4e6f 2076 616c 6964 206c      # No valid l
+0001e940: 696e 6573 0a20 2020 2069 6620 2869 735f  ines.    if (is_
+0001e950: 6c69 6e65 2026 2063 6c69 7029 2e73 756d  line & clip).sum
+0001e960: 2829 203d 3d20 303a 0a20 2020 2020 2020  () == 0:.       
+0001e970: 2072 6574 7572 6e20 4557 6469 6374 0a0a   return EWdict..
+0001e980: 2020 2020 2320 5261 6e64 6f6d 2064 7261      # Random dra
+0001e990: 7773 2066 726f 6d20 7468 6520 636f 7661  ws from the cova
+0001e9a0: 7269 616e 6365 206d 6174 7269 780a 2020  riance matrix.  
+0001e9b0: 2020 636f 7661 725f 636c 6970 203d 2063    covar_clip = c
+0001e9c0: 6f76 6172 5b63 6c69 702c 203a 5d5b 3a2c  ovar[clip, :][:,
+0001e9d0: 2063 6c69 705d 0a20 2020 2069 6620 7365   clip].    if se
+0001e9e0: 6564 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ed is not None:.
+0001e9f0: 2020 2020 2020 2020 6e70 2e72 616e 646f          np.rando
+0001ea00: 6d2e 7365 6564 2873 6565 6429 0a0a 2020  m.seed(seed)..  
+0001ea10: 2020 6472 6177 7320 3d20 6e70 2e72 616e    draws = np.ran
+0001ea20: 646f 6d2e 6d75 6c74 6976 6172 6961 7465  dom.multivariate
+0001ea30: 5f6e 6f72 6d61 6c28 636f 6566 6673 5b63  _normal(coeffs[c
+0001ea40: 6c69 705d 2c20 636f 7661 725f 636c 6970  lip], covar_clip
+0001ea50: 2c20 7369 7a65 3d4e 6472 6177 290a 0a20  , size=Ndraw).. 
+0001ea60: 2020 2023 2045 7661 6c75 6174 6520 7468     # Evaluate th
+0001ea70: 6520 636f 6e74 696e 7575 6d20 6669 7473  e continuum fits
+0001ea80: 2066 726f 6d20 7468 6520 6472 6177 730a   from the draws.
+0001ea90: 2020 2020 636f 6e74 696e 7575 6d20 3d20      continuum = 
+0001eaa0: 6e70 2e64 6f74 2864 7261 7773 2a28 7e69  np.dot(draws*(~i
+0001eab0: 735f 6c69 6e65 5b63 6c69 705d 292c 2066  s_line[clip]), f
+0001eac0: 6c75 785f 6172 725b 636c 6970 2c20 3a5d  lux_arr[clip, :]
+0001ead0: 290a 0a20 2020 2023 2043 6f6d 7075 7465  )..    # Compute
+0001eae0: 2074 6865 2065 6d69 7373 696f 6e20 6c69   the emission li
+0001eaf0: 6e65 2045 5773 0a20 2020 2074 6964 7820  ne EWs.    tidx 
+0001eb00: 3d20 6e70 2e77 6865 7265 2869 735f 6c69  = np.where(is_li
+0001eb10: 6e65 5b63 6c69 705d 295b 305d 0a20 2020  ne[clip])[0].   
+0001eb20: 2066 6f72 2069 7820 696e 2074 6964 783a   for ix in tidx:
+0001eb30: 0a20 2020 2020 2020 206b 6579 203d 206b  .        key = k
+0001eb40: 6579 735b 636c 6970 5d5b 6978 5d0a 0a20  eys[clip][ix].. 
+0001eb50: 2020 2020 2020 2023 204c 696e 6520 7465         # Line te
+0001eb60: 6d70 6c61 7465 0a20 2020 2020 2020 206c  mplate.        l
+0001eb70: 696e 6520 3d20 6e70 2e64 6f74 2864 7261  ine = np.dot(dra
+0001eb80: 7773 5b3a 2c20 6978 5d5b 3a2c 204e 6f6e  ws[:, ix][:, Non
+0001eb90: 655d 2c20 666c 7578 5f61 7272 5b63 6c69  e], flux_arr[cli
+0001eba0: 702c 203a 5d5b 6978 2c20 3a5d 5b4e 6f6e  p, :][ix, :][Non
+0001ebb0: 652c 203a 5d29 0a0a 2020 2020 2020 2020  e, :])..        
+0001ebc0: 2320 5768 6572 6520 6c69 6e65 2074 656d  # Where line tem
+0001ebd0: 706c 6174 6520 6e6f 6e2d 7a65 726f 0a20  plate non-zero. 
+0001ebe0: 2020 2020 2020 206d 6173 6b20 3d20 666c         mask = fl
+0001ebf0: 7578 5f61 7272 5b63 6c69 702c 203a 5d5b  ux_arr[clip, :][
+0001ec00: 6978 2c20 3a5d 203e 2030 0a20 2020 2020  ix, :] > 0.     
+0001ec10: 2020 2065 775f 6920 3d20 6e70 2e74 7261     ew_i = np.tra
+0001ec20: 707a 2828 6c69 6e65 2f63 6f6e 7469 6e75  pz((line/continu
+0001ec30: 756d 295b 3a2c 206d 6173 6b5d 2c0a 2020  um)[:, mask],.  
+0001ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec50: 2020 2020 2020 7761 7665 5b6d 6173 6b5d        wave[mask]
+0001ec60: 2a28 312b 7a2a 6f62 7365 7276 6564 5f66  *(1+z*observed_f
+0001ec70: 7261 6d65 292c 2061 7869 733d 3129 0a0a  rame), axis=1)..
+0001ec80: 2020 2020 2020 2020 4557 6469 6374 5b6b          EWdict[k
+0001ec90: 6579 5d20 3d20 6e70 2e70 6572 6365 6e74  ey] = np.percent
+0001eca0: 696c 6528 6577 5f69 2c20 5b31 362e 2c20  ile(ew_i, [16., 
+0001ecb0: 3530 2e2c 2038 342e 5d29 0a0a 2020 2020  50., 84.])..    
+0001ecc0: 7265 7475 726e 2045 5764 6963 740a 0a23  return EWdict..#
+0001ecd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ece0: 2323 2323 0a23 2050 686f 746f 6d65 7472  ####.# Photometr
+0001ecf0: 7920 6672 6f6d 2056 697a 6965 7220 7461  y from Vizier ta
+0001ed00: 626c 6573 0a0a 0a23 2043 4648 544c 530a  bles...# CFHTLS.
+0001ed10: 4346 4854 4c53 5f57 5f56 495a 4945 5220  CFHTLS_W_VIZIER 
+0001ed20: 3d20 2749 492f 3331 372f 6366 6874 6c73  = 'II/317/cfhtls
+0001ed30: 5f77 270a 4346 4854 4c53 5f57 5f42 414e  _w'.CFHTLS_W_BAN
+0001ed40: 4453 203d 204f 7264 6572 6564 4469 6374  DS = OrderedDict
+0001ed50: 285b 2827 6366 6874 5f6d 6567 615f 7527  ([('cfht_mega_u'
+0001ed60: 2c20 5b27 756d 6167 272c 2027 655f 756d  , ['umag', 'e_um
+0001ed70: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
+0001ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed90: 2020 2020 2827 6366 6874 5f6d 6567 615f      ('cfht_mega_
+0001eda0: 6727 2c20 5b27 676d 6167 272c 2027 655f  g', ['gmag', 'e_
+0001edb0: 676d 6167 275d 292c 0a20 2020 2020 2020  gmag']),.       
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edd0: 2020 2020 2020 2827 6366 6874 5f6d 6567        ('cfht_meg
+0001ede0: 615f 7227 2c20 5b27 726d 6167 272c 2027  a_r', ['rmag', '
+0001edf0: 655f 726d 6167 275d 292c 0a20 2020 2020  e_rmag']),.     
+0001ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee10: 2020 2020 2020 2020 2827 6366 6874 5f6d          ('cfht_m
+0001ee20: 6567 615f 6927 2c20 5b27 696d 6167 272c  ega_i', ['imag',
+0001ee30: 2027 655f 696d 6167 275d 292c 0a20 2020   'e_imag']),.   
+0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee50: 2020 2020 2020 2020 2020 2827 6366 6874            ('cfht
+0001ee60: 5f6d 6567 615f 7a27 2c20 5b27 7a6d 6167  _mega_z', ['zmag
+0001ee70: 272c 2027 655f 7a6d 6167 275d 295d 290a  ', 'e_zmag'])]).
+0001ee80: 0a43 4648 544c 535f 445f 5649 5a49 4552  .CFHTLS_D_VIZIER
+0001ee90: 203d 2027 4949 2f33 3137 2f63 6668 746c   = 'II/317/cfhtl
+0001eea0: 735f 6427 0a43 4648 544c 535f 445f 4241  s_d'.CFHTLS_D_BA
+0001eeb0: 4e44 5320 3d20 4f72 6465 7265 6444 6963  NDS = OrderedDic
+0001eec0: 7428 5b28 2763 6668 745f 6d65 6761 5f75  t([('cfht_mega_u
+0001eed0: 272c 205b 2775 6d61 6727 2c20 2765 5f75  ', ['umag', 'e_u
+0001eee0: 6d61 6727 5d29 2c0a 2020 2020 2020 2020  mag']),.        
+0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef00: 2020 2020 2028 2763 6668 745f 6d65 6761       ('cfht_mega
+0001ef10: 5f67 272c 205b 2767 6d61 6727 2c20 2765  _g', ['gmag', 'e
+0001ef20: 5f67 6d61 6727 5d29 2c0a 2020 2020 2020  _gmag']),.      
+0001ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef40: 2020 2020 2020 2028 2763 6668 745f 6d65         ('cfht_me
+0001ef50: 6761 5f72 272c 205b 2772 6d61 6727 2c20  ga_r', ['rmag', 
+0001ef60: 2765 5f72 6d61 6727 5d29 2c0a 2020 2020  'e_rmag']),.    
+0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef80: 2020 2020 2020 2020 2028 2763 6668 745f           ('cfht_
+0001ef90: 6d65 6761 5f69 272c 205b 2769 6d61 6727  mega_i', ['imag'
+0001efa0: 2c20 2765 5f69 6d61 6727 5d29 2c0a 2020  , 'e_imag']),.  
 0001efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efc0: 2020 2020 2020 2020 2028 2753 4453 532f           ('SDSS/
-0001efd0: 6927 2c20 5b27 696d 6167 272c 2027 655f  i', ['imag', 'e_
-0001efe0: 696d 6167 275d 292c 0a20 2020 2020 2020  imag']),.       
-0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f000: 2020 2028 2753 4453 532f 7a27 2c20 5b27     ('SDSS/z', ['
-0001f010: 7a6d 6167 272c 2027 655f 7a6d 6167 275d  zmag', 'e_zmag']
-0001f020: 295d 290a 0a23 2050 616e 5374 6172 7273  )])..# PanStarrs
-0001f030: 0a50 5331 5f56 495a 4945 5220 3d20 2749  .PS1_VIZIER = 'I
-0001f040: 492f 3334 392f 7073 3127 0a50 5331 5f42  I/349/ps1'.PS1_B
-0001f050: 414e 4453 203d 204f 7264 6572 6564 4469  ANDS = OrderedDi
-0001f060: 6374 285b 2827 5053 312e 6727 2c20 5b27  ct([('PS1.g', ['
-0001f070: 674b 6d61 6727 2c20 2765 5f67 4b6d 6167  gKmag', 'e_gKmag
-0001f080: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001f090: 2020 2020 2020 2827 5053 312e 7227 2c20        ('PS1.r', 
-0001f0a0: 5b27 724b 6d61 6727 2c20 2765 5f72 4b6d  ['rKmag', 'e_rKm
-0001f0b0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
-0001f0c0: 2020 2020 2020 2020 2827 5053 312e 6927          ('PS1.i'
-0001f0d0: 2c20 5b27 694b 6d61 6727 2c20 2765 5f69  , ['iKmag', 'e_i
-0001f0e0: 4b6d 6167 275d 292c 0a20 2020 2020 2020  Kmag']),.       
-0001f0f0: 2020 2020 2020 2020 2020 2827 5053 312e            ('PS1.
-0001f100: 7a27 2c20 5b27 7a4b 6d61 6727 2c20 2765  z', ['zKmag', 'e
-0001f110: 5f7a 4b6d 6167 275d 292c 0a20 2020 2020  _zKmag']),.     
-0001f120: 2020 2020 2020 2020 2020 2020 2827 5053              ('PS
-0001f130: 312e 7927 2c20 5b27 794b 6d61 6727 2c20  1.y', ['yKmag', 
-0001f140: 2765 5f79 4b6d 6167 275d 295d 290a 0a23  'e_yKmag'])])..#
-0001f150: 204b 4944 5320 4452 330a 4b49 4453 5f44   KIDS DR3.KIDS_D
-0001f160: 5233 5f56 495a 4945 5220 3d20 2749 492f  R3_VIZIER = 'II/
-0001f170: 3334 372f 6b69 6473 5f64 7233 270a 4b49  347/kids_dr3'.KI
-0001f180: 4453 5f44 5233 5f42 414e 4453 203d 204f  DS_DR3_BANDS = O
-0001f190: 7264 6572 6564 4469 6374 285b 2827 4f43  rderedDict([('OC
-0001f1a0: 616d 2e73 6473 732e 7527 2c20 5b27 756d  am.sdss.u', ['um
-0001f1b0: 6167 272c 2027 655f 756d 6167 275d 292c  ag', 'e_umag']),
-0001f1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f1d0: 2020 2020 2020 2020 2020 2028 274f 4361             ('OCa
-0001f1e0: 6d2e 7364 7373 2e67 272c 205b 2767 6d61  m.sdss.g', ['gma
-0001f1f0: 6727 2c20 2765 5f67 6d61 6727 5d29 2c0a  g', 'e_gmag']),.
-0001f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f210: 2020 2020 2020 2020 2020 2827 4f43 616d            ('OCam
-0001f220: 2e73 6473 732e 7227 2c20 5b27 726d 6167  .sdss.r', ['rmag
-0001f230: 272c 2027 655f 726d 6167 275d 292c 0a20  ', 'e_rmag']),. 
+0001efc0: 2020 2020 2020 2020 2020 2028 2763 6668             ('cfh
+0001efd0: 745f 6d65 6761 5f7a 272c 205b 277a 6d61  t_mega_z', ['zma
+0001efe0: 6727 2c20 2765 5f7a 6d61 6727 5d29 5d29  g', 'e_zmag'])])
+0001eff0: 0a0a 2320 5344 5353 2044 5231 320a 5344  ..# SDSS DR12.SD
+0001f000: 5353 5f44 5231 325f 5649 5a49 4552 203d  SS_DR12_VIZIER =
+0001f010: 2027 562f 3134 372f 7364 7373 3132 270a   'V/147/sdss12'.
+0001f020: 5344 5353 5f44 5231 325f 4241 4e44 5320  SDSS_DR12_BANDS 
+0001f030: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
+0001f040: 2753 4453 532f 7527 2c20 5b27 756d 6167  'SDSS/u', ['umag
+0001f050: 272c 2027 655f 756d 6167 275d 292c 0a20  ', 'e_umag']),. 
+0001f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f070: 2020 2020 2020 2020 2028 2753 4453 532f           ('SDSS/
+0001f080: 6727 2c20 5b27 676d 6167 272c 2027 655f  g', ['gmag', 'e_
+0001f090: 676d 6167 275d 292c 0a20 2020 2020 2020  gmag']),.       
+0001f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0b0: 2020 2028 2753 4453 532f 7227 2c20 5b27     ('SDSS/r', ['
+0001f0c0: 726d 6167 272c 2027 655f 726d 6167 275d  rmag', 'e_rmag']
+0001f0d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001f0e0: 2020 2020 2020 2020 2020 2020 2028 2753               ('S
+0001f0f0: 4453 532f 6927 2c20 5b27 696d 6167 272c  DSS/i', ['imag',
+0001f100: 2027 655f 696d 6167 275d 292c 0a20 2020   'e_imag']),.   
+0001f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f120: 2020 2020 2020 2028 2753 4453 532f 7a27         ('SDSS/z'
+0001f130: 2c20 5b27 7a6d 6167 272c 2027 655f 7a6d  , ['zmag', 'e_zm
+0001f140: 6167 275d 295d 290a 0a23 2050 616e 5374  ag'])])..# PanSt
+0001f150: 6172 7273 0a50 5331 5f56 495a 4945 5220  arrs.PS1_VIZIER 
+0001f160: 3d20 2749 492f 3334 392f 7073 3127 0a50  = 'II/349/ps1'.P
+0001f170: 5331 5f42 414e 4453 203d 204f 7264 6572  S1_BANDS = Order
+0001f180: 6564 4469 6374 285b 2827 5053 312e 6727  edDict([('PS1.g'
+0001f190: 2c20 5b27 674b 6d61 6727 2c20 2765 5f67  , ['gKmag', 'e_g
+0001f1a0: 4b6d 6167 275d 292c 0a20 2020 2020 2020  Kmag']),.       
+0001f1b0: 2020 2020 2020 2020 2020 2827 5053 312e            ('PS1.
+0001f1c0: 7227 2c20 5b27 724b 6d61 6727 2c20 2765  r', ['rKmag', 'e
+0001f1d0: 5f72 4b6d 6167 275d 292c 0a20 2020 2020  _rKmag']),.     
+0001f1e0: 2020 2020 2020 2020 2020 2020 2827 5053              ('PS
+0001f1f0: 312e 6927 2c20 5b27 694b 6d61 6727 2c20  1.i', ['iKmag', 
+0001f200: 2765 5f69 4b6d 6167 275d 292c 0a20 2020  'e_iKmag']),.   
+0001f210: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+0001f220: 5053 312e 7a27 2c20 5b27 7a4b 6d61 6727  PS1.z', ['zKmag'
+0001f230: 2c20 2765 5f7a 4b6d 6167 275d 292c 0a20  , 'e_zKmag']),. 
 0001f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f250: 2020 2020 2020 2020 2028 274f 4361 6d2e           ('OCam.
-0001f260: 7364 7373 2e69 272c 205b 2769 6d61 6727  sdss.i', ['imag'
-0001f270: 2c20 2765 5f69 6d61 6727 5d29 5d29 0a0a  , 'e_imag'])])..
-0001f280: 2320 5749 5345 2061 6c6c 2d73 6b79 0a57  # WISE all-sky.W
-0001f290: 4953 455f 5649 5a49 4552 203d 2027 4949  ISE_VIZIER = 'II
-0001f2a0: 2f33 3238 2f61 6c6c 7769 7365 270a 5749  /328/allwise'.WI
-0001f2b0: 5345 5f42 414e 4453 203d 204f 7264 6572  SE_BANDS = Order
-0001f2c0: 6564 4469 6374 285b 2827 5749 5345 2f52  edDict([('WISE/R
-0001f2d0: 5352 2d57 3127 2c20 5b27 5731 6d61 6727  SR-W1', ['W1mag'
-0001f2e0: 2c20 2765 5f57 316d 6167 275d 292c 0a20  , 'e_W1mag']),. 
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 2020 2020 2020 2020 2028 2757 4953 452f           ('WISE/
-0001f310: 5253 522d 5732 272c 205b 2757 326d 6167  RSR-W2', ['W2mag
-0001f320: 272c 2027 655f 5732 6d61 6727 5d29 5d29  ', 'e_W2mag'])])
-0001f330: 0a23 2028 2757 4953 452f 5253 522d 5733  .# ('WISE/RSR-W3
-0001f340: 272c 205b 2757 336d 6167 272c 2027 655f  ', ['W3mag', 'e_
-0001f350: 5733 6d61 6727 5d29 2c0a 2320 2827 5749  W3mag']),.# ('WI
-0001f360: 5345 2f52 5352 2d57 3427 2c20 5b27 5734  SE/RSR-W4', ['W4
-0001f370: 6d61 6727 2c20 2765 5f57 346d 6167 275d  mag', 'e_W4mag']
-0001f380: 295d 290a 0a23 2056 494b 494e 4720 5649  )])..# VIKING VI
-0001f390: 5354 410a 5649 4b49 4e47 5f56 495a 4945  STA.VIKING_VIZIE
-0001f3a0: 5220 3d20 2749 492f 3334 332f 7669 6b69  R = 'II/343/viki
-0001f3b0: 6e67 3227 0a56 494b 494e 475f 4241 4e44  ng2'.VIKING_BAND
-0001f3c0: 5320 3d20 4f72 6465 7265 6444 6963 7428  S = OrderedDict(
-0001f3d0: 5b28 2753 4453 532f 7a27 2c20 5b27 5a70  [('SDSS/z', ['Zp
-0001f3e0: 6d61 6727 2c20 2765 5f5a 706d 6167 275d  mag', 'e_Zpmag']
-0001f3f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001f400: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001f410: 2756 4953 5441 2f59 272c 2020 5b27 5970  'VISTA/Y',  ['Yp
-0001f420: 6d61 6727 2c20 2027 655f 5970 6d61 6727  mag',  'e_Ypmag'
-0001f430: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f450: 2827 5649 5354 412f 4a27 2c20 205b 274a  ('VISTA/J',  ['J
-0001f460: 706d 6167 272c 2020 2765 5f4a 706d 6167  pmag',  'e_Jpmag
-0001f470: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f490: 2028 2756 4953 5441 2f48 272c 2020 5b27   ('VISTA/H',  ['
-0001f4a0: 4870 6d61 6727 2c20 2027 655f 4870 6d61  Hpmag',  'e_Hpma
-0001f4b0: 6727 5d29 2c0a 2020 2020 2020 2020 2020  g']),.          
-0001f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4d0: 2020 2827 5649 5354 412f 4b73 272c 205b    ('VISTA/Ks', [
-0001f4e0: 274b 7370 6d61 6727 2c20 2765 5f4b 7370  'Kspmag', 'e_Ksp
-0001f4f0: 6d61 6727 5d29 5d29 0a0a 2320 554b 4944  mag'])])..# UKID
-0001f500: 5353 2077 6964 6520 7375 7276 6579 730a  SS wide surveys.
-0001f510: 554b 4944 5353 5f4c 4153 5f56 495a 4945  UKIDSS_LAS_VIZIE
-0001f520: 5220 3d20 2749 492f 3331 392f 6c61 7339  R = 'II/319/las9
-0001f530: 270a 554b 4944 5353 5f4c 4153 5f42 414e  '.UKIDSS_LAS_BAN
-0001f540: 4453 203d 204f 7264 6572 6564 4469 6374  DS = OrderedDict
-0001f550: 285b 2827 5746 4341 4d5f 5927 2c20 5b27  ([('WFCAM_Y', ['
-0001f560: 596d 6167 272c 2027 655f 596d 6167 275d  Ymag', 'e_Ymag']
-0001f570: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001f580: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001f590: 2757 4643 414d 5f4a 272c 205b 274a 6d61  'WFCAM_J', ['Jma
-0001f5a0: 6731 272c 2027 655f 4a6d 6167 3127 5d29  g1', 'e_Jmag1'])
-0001f5b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f5c0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-0001f5d0: 5746 4341 4d5f 4a27 2c20 5b27 4a6d 6167  WFCAM_J', ['Jmag
-0001f5e0: 3227 2c20 2765 5f4a 6d61 6732 275d 292c  2', 'e_Jmag2']),
-0001f5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f600: 2020 2020 2020 2020 2020 2020 2028 2757               ('W
-0001f610: 4643 414d 5f48 272c 205b 2748 6d61 6727  FCAM_H', ['Hmag'
-0001f620: 2c20 2765 5f48 6d61 6727 5d29 2c0a 2020  , 'e_Hmag']),.  
-0001f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f640: 2020 2020 2020 2020 2020 2827 5746 4341            ('WFCA
-0001f650: 4d5f 4b27 2c20 5b27 4b6d 6167 272c 2027  M_K', ['Kmag', '
-0001f660: 655f 4b6d 6167 275d 295d 290a 0a55 4b49  e_Kmag'])])..UKI
-0001f670: 4453 535f 4458 535f 5649 5a49 4552 203d  DSS_DXS_VIZIER =
-0001f680: 2027 4949 2f33 3139 2f64 7873 3927 0a55   'II/319/dxs9'.U
-0001f690: 4b49 4453 535f 4458 535f 4241 4e44 5320  KIDSS_DXS_BANDS 
-0001f6a0: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
-0001f6b0: 2757 4643 414d 5f4a 272c 205b 274a 6d61  'WFCAM_J', ['Jma
-0001f6c0: 6727 2c20 2765 5f4a 6d61 6727 5d29 2c0a  g', 'e_Jmag']),.
-0001f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f6e0: 2020 2020 2020 2020 2020 2020 2827 5746              ('WF
-0001f6f0: 4341 4d5f 4b27 2c20 5b27 4b6d 6167 272c  CAM_K', ['Kmag',
-0001f700: 2027 655f 4b6d 6167 275d 295d 290a 0a23   'e_Kmag'])])..#
-0001f710: 2047 414c 4558 0a47 414c 4558 5f4d 4953   GALEX.GALEX_MIS
-0001f720: 5f56 495a 4945 5220 3d20 2749 492f 3331  _VIZIER = 'II/31
-0001f730: 322f 6d69 7327 0a47 414c 4558 5f4d 4953  2/mis'.GALEX_MIS
-0001f740: 5f42 414e 4453 203d 204f 7264 6572 6564  _BANDS = Ordered
-0001f750: 4469 6374 285b 2827 4655 5627 2c20 5b27  Dict([('FUV', ['
-0001f760: 4655 5627 2c20 2765 5f46 5556 275d 292c  FUV', 'e_FUV']),
-0001f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f780: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001f790: 274e 5556 272c 205b 274e 5556 272c 2027  'NUV', ['NUV', '
-0001f7a0: 655f 4e55 5627 5d29 5d29 0a0a 4741 4c45  e_NUV'])])..GALE
-0001f7b0: 585f 4149 535f 5649 5a49 4552 203d 2027  X_AIS_VIZIER = '
-0001f7c0: 4949 2f33 3132 2f61 6973 270a 4741 4c45  II/312/ais'.GALE
-0001f7d0: 585f 4149 535f 4241 4e44 5320 3d20 4f72  X_AIS_BANDS = Or
-0001f7e0: 6465 7265 6444 6963 7428 5b28 2746 5556  deredDict([('FUV
-0001f7f0: 272c 205b 2746 5556 272c 2027 655f 4655  ', ['FUV', 'e_FU
-0001f800: 5627 5d29 2c0a 2020 2020 2020 2020 2020  V']),.          
-0001f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f820: 2020 2020 2827 4e55 5627 2c20 5b27 4e55      ('NUV', ['NU
-0001f830: 5627 2c20 2765 5f4e 5556 275d 295d 290a  V', 'e_NUV'])]).
-0001f840: 0a23 2043 6f6d 6269 6e65 6420 4469 6374  .# Combined Dict
-0001f850: 0a56 495a 4945 525f 4241 4e44 5320 3d20  .VIZIER_BANDS = 
-0001f860: 4f72 6465 7265 6444 6963 7428 290a 5649  OrderedDict().VI
-0001f870: 5a49 4552 5f42 414e 4453 5b43 4648 544c  ZIER_BANDS[CFHTL
-0001f880: 535f 575f 5649 5a49 4552 5d20 3d20 4346  S_W_VIZIER] = CF
-0001f890: 4854 4c53 5f57 5f42 414e 4453 0a56 495a  HTLS_W_BANDS.VIZ
-0001f8a0: 4945 525f 4241 4e44 535b 4346 4854 4c53  IER_BANDS[CFHTLS
-0001f8b0: 5f44 5f56 495a 4945 525d 203d 2043 4648  _D_VIZIER] = CFH
-0001f8c0: 544c 535f 445f 4241 4e44 530a 5649 5a49  TLS_D_BANDS.VIZI
-0001f8d0: 4552 5f42 414e 4453 5b53 4453 535f 4452  ER_BANDS[SDSS_DR
-0001f8e0: 3132 5f56 495a 4945 525d 203d 2053 4453  12_VIZIER] = SDS
-0001f8f0: 535f 4452 3132 5f42 414e 4453 0a56 495a  S_DR12_BANDS.VIZ
-0001f900: 4945 525f 4241 4e44 535b 5053 315f 5649  IER_BANDS[PS1_VI
-0001f910: 5a49 4552 5d20 3d20 5053 315f 4241 4e44  ZIER] = PS1_BAND
-0001f920: 530a 5649 5a49 4552 5f42 414e 4453 5b4b  S.VIZIER_BANDS[K
-0001f930: 4944 535f 4452 335f 5649 5a49 4552 5d20  IDS_DR3_VIZIER] 
-0001f940: 3d20 4b49 4453 5f44 5233 5f42 414e 4453  = KIDS_DR3_BANDS
-0001f950: 0a56 495a 4945 525f 4241 4e44 535b 5749  .VIZIER_BANDS[WI
-0001f960: 5345 5f56 495a 4945 525d 203d 2057 4953  SE_VIZIER] = WIS
-0001f970: 455f 4241 4e44 530a 5649 5a49 4552 5f42  E_BANDS.VIZIER_B
-0001f980: 414e 4453 5b56 494b 494e 475f 5649 5a49  ANDS[VIKING_VIZI
-0001f990: 4552 5d20 3d20 5649 4b49 4e47 5f42 414e  ER] = VIKING_BAN
-0001f9a0: 4453 0a56 495a 4945 525f 4241 4e44 535b  DS.VIZIER_BANDS[
-0001f9b0: 554b 4944 5353 5f4c 4153 5f56 495a 4945  UKIDSS_LAS_VIZIE
-0001f9c0: 525d 203d 2055 4b49 4453 535f 4c41 535f  R] = UKIDSS_LAS_
-0001f9d0: 4241 4e44 530a 5649 5a49 4552 5f42 414e  BANDS.VIZIER_BAN
-0001f9e0: 4453 5b55 4b49 4453 535f 4458 535f 5649  DS[UKIDSS_DXS_VI
-0001f9f0: 5a49 4552 5d20 3d20 554b 4944 5353 5f44  ZIER] = UKIDSS_D
-0001fa00: 5853 5f42 414e 4453 0a56 495a 4945 525f  XS_BANDS.VIZIER_
-0001fa10: 4241 4e44 535b 4741 4c45 585f 4d49 535f  BANDS[GALEX_MIS_
-0001fa20: 5649 5a49 4552 5d20 3d20 4741 4c45 585f  VIZIER] = GALEX_
-0001fa30: 4d49 535f 4241 4e44 530a 5649 5a49 4552  MIS_BANDS.VIZIER
-0001fa40: 5f42 414e 4453 5b47 414c 4558 5f41 4953  _BANDS[GALEX_AIS
-0001fa50: 5f56 495a 4945 525d 203d 2047 414c 4558  _VIZIER] = GALEX
-0001fa60: 5f41 4953 5f42 414e 4453 0a0a 5649 5a49  _AIS_BANDS..VIZI
-0001fa70: 4552 5f56 4547 4120 3d20 4f72 6465 7265  ER_VEGA = Ordere
-0001fa80: 6444 6963 7428 290a 5649 5a49 4552 5f56  dDict().VIZIER_V
-0001fa90: 4547 415b 4346 4854 4c53 5f57 5f56 495a  EGA[CFHTLS_W_VIZ
-0001faa0: 4945 525d 203d 2046 616c 7365 0a56 495a  IER] = False.VIZ
-0001fab0: 4945 525f 5645 4741 5b43 4648 544c 535f  IER_VEGA[CFHTLS_
-0001fac0: 445f 5649 5a49 4552 5d20 3d20 4661 6c73  D_VIZIER] = Fals
-0001fad0: 650a 5649 5a49 4552 5f56 4547 415b 5344  e.VIZIER_VEGA[SD
-0001fae0: 5353 5f44 5231 325f 5649 5a49 4552 5d20  SS_DR12_VIZIER] 
-0001faf0: 3d20 4661 6c73 650a 5649 5a49 4552 5f56  = False.VIZIER_V
-0001fb00: 4547 415b 5053 315f 5649 5a49 4552 5d20  EGA[PS1_VIZIER] 
-0001fb10: 3d20 4661 6c73 650a 5649 5a49 4552 5f56  = False.VIZIER_V
-0001fb20: 4547 415b 4b49 4453 5f44 5233 5f56 495a  EGA[KIDS_DR3_VIZ
-0001fb30: 4945 525d 203d 2046 616c 7365 0a56 495a  IER] = False.VIZ
-0001fb40: 4945 525f 5645 4741 5b57 4953 455f 5649  IER_VEGA[WISE_VI
-0001fb50: 5a49 4552 5d20 3d20 5472 7565 0a56 495a  ZIER] = True.VIZ
-0001fb60: 4945 525f 5645 4741 5b56 494b 494e 475f  IER_VEGA[VIKING_
-0001fb70: 5649 5a49 4552 5d20 3d20 5472 7565 0a56  VIZIER] = True.V
-0001fb80: 495a 4945 525f 5645 4741 5b55 4b49 4453  IZIER_VEGA[UKIDS
-0001fb90: 535f 4c41 535f 5649 5a49 4552 5d20 3d20  S_LAS_VIZIER] = 
-0001fba0: 5472 7565 0a56 495a 4945 525f 5645 4741  True.VIZIER_VEGA
-0001fbb0: 5b55 4b49 4453 535f 4458 535f 5649 5a49  [UKIDSS_DXS_VIZI
-0001fbc0: 4552 5d20 3d20 5472 7565 0a56 495a 4945  ER] = True.VIZIE
-0001fbd0: 525f 5645 4741 5b47 414c 4558 5f4d 4953  R_VEGA[GALEX_MIS
-0001fbe0: 5f56 495a 4945 525d 203d 2046 616c 7365  _VIZIER] = False
-0001fbf0: 0a56 495a 4945 525f 5645 4741 5b47 414c  .VIZIER_VEGA[GAL
-0001fc00: 4558 5f41 4953 5f56 495a 4945 525d 203d  EX_AIS_VIZIER] =
-0001fc10: 2046 616c 7365 0a0a 0a64 6566 2067 6574   False...def get
-0001fc20: 5f56 697a 6965 725f 7068 6f74 6f6d 6574  _Vizier_photomet
-0001fc30: 7279 2872 612c 2064 6563 2c20 7465 6d70  ry(ra, dec, temp
-0001fc40: 6c61 7465 733d 4e6f 6e65 2c20 7261 6469  lates=None, radi
-0001fc50: 7573 3d32 2c20 7669 7a69 6572 5f63 6174  us=2, vizier_cat
-0001fc60: 616c 6f67 3d50 5331 5f56 495a 4945 522c  alog=PS1_VIZIER,
-0001fc70: 2062 616e 6473 3d50 5331 5f42 414e 4453   bands=PS1_BANDS
-0001fc80: 2c20 6669 6c74 6572 5f66 696c 653d 272f  , filter_file='/
-0001fc90: 7573 722f 6c6f 6361 6c2f 7368 6172 652f  usr/local/share/
-0001fca0: 6561 7a79 2d70 686f 746f 7a2f 6669 6c74  eazy-photoz/filt
-0001fcb0: 6572 732f 4649 4c54 4552 2e52 4553 2e6c  ers/FILTER.RES.l
-0001fcc0: 6174 6573 7427 2c20 4d57 5f45 4256 3d30  atest', MW_EBV=0
-0001fcd0: 2c20 636f 6e76 6572 745f 7665 6761 3d46  , convert_vega=F
-0001fce0: 616c 7365 2c20 7261 775f 7175 6572 793d  alse, raw_query=
-0001fcf0: 4661 6c73 652c 2076 6572 626f 7365 3d54  False, verbose=T
-0001fd00: 7275 652c 2074 696d 656f 7574 3d33 3030  rue, timeout=300
-0001fd10: 2c20 726f 776c 696d 6974 3d35 3030 3030  , rowlimit=50000
-0001fd20: 293a 0a20 2020 2022 2222 0a20 2020 2046  ):.    """.    F
-0001fd30: 6574 6368 2070 686f 746f 6d65 7472 7920  etch photometry 
-0001fd40: 6672 6f6d 2061 2056 697a 6965 7220 6361  from a Vizier ca
-0001fd50: 7461 6c6f 670a 0a20 2020 2052 6571 7569  talog..    Requi
-0001fd60: 7265 7320 6561 7a79 7079 2f65 617a 790a  res eazypy/eazy.
-0001fd70: 2020 2020 2222 220a 0a20 2020 2066 726f      """..    fro
-0001fd80: 6d20 636f 6c6c 6563 7469 6f6e 7320 696d  m collections im
-0001fd90: 706f 7274 204f 7264 6572 6564 4469 6374  port OrderedDict
-0001fda0: 0a0a 2020 2020 696d 706f 7274 2061 7374  ..    import ast
-0001fdb0: 726f 7079 2e75 6e69 7473 2061 7320 750a  ropy.units as u.
-0001fdc0: 2020 2020 6672 6f6d 2061 7374 726f 7175      from astroqu
-0001fdd0: 6572 792e 7669 7a69 6572 2069 6d70 6f72  ery.vizier impor
-0001fde0: 7420 5669 7a69 6572 0a20 2020 2056 697a  t Vizier.    Viz
-0001fdf0: 6965 722e 524f 575f 4c49 4d49 5420 3d20  ier.ROW_LIMIT = 
-0001fe00: 726f 776c 696d 6974 0a20 2020 2056 697a  rowlimit.    Viz
-0001fe10: 6965 722e 5449 4d45 4f55 5420 3d20 7469  ier.TIMEOUT = ti
-0001fe20: 6d65 6f75 740a 0a20 2020 2023 7072 696e  meout..    #prin
-0001fe30: 7428 2778 7878 272c 2056 697a 6965 722e  t('xxx', Vizier.
-0001fe40: 524f 575f 4c49 4d49 542c 2056 697a 6965  ROW_LIMIT, Vizie
-0001fe50: 722e 5449 4d45 4f55 5429 0a0a 2020 2020  r.TIMEOUT)..    
-0001fe60: 696d 706f 7274 2061 7374 726f 7079 2e63  import astropy.c
-0001fe70: 6f6f 7264 696e 6174 6573 2061 7320 636f  oordinates as co
-0001fe80: 6f72 640a 2020 2020 696d 706f 7274 2061  ord.    import a
-0001fe90: 7374 726f 7079 2e75 6e69 7473 2061 7320  stropy.units as 
-0001fea0: 750a 0a20 2020 2023 696d 706f 7274 2070  u..    #import p
-0001feb0: 7973 796e 7068 6f74 2061 7320 530a 0a20  ysynphot as S.. 
-0001fec0: 2020 2066 726f 6d20 6561 7a79 2e74 656d     from eazy.tem
-0001fed0: 706c 6174 6573 2069 6d70 6f72 7420 5465  plates import Te
-0001fee0: 6d70 6c61 7465 0a20 2020 2066 726f 6d20  mplate.    from 
-0001fef0: 6561 7a79 2e66 696c 7465 7273 2069 6d70  eazy.filters imp
-0001ff00: 6f72 7420 4669 6c74 6572 4669 6c65 0a20  ort FilterFile. 
-0001ff10: 2020 2066 726f 6d20 6561 7a79 2e70 686f     from eazy.pho
-0001ff20: 746f 7a20 696d 706f 7274 2054 656d 706c  toz import Templ
-0001ff30: 6174 6547 7269 640a 2020 2020 6672 6f6d  ateGrid.    from
-0001ff40: 2065 617a 792e 6669 6c74 6572 7320 696d   eazy.filters im
-0001ff50: 706f 7274 2046 696c 7465 7244 6566 696e  port FilterDefin
-0001ff60: 6974 696f 6e0a 0a20 2020 2072 6573 203d  ition..    res =
-0001ff70: 2046 696c 7465 7246 696c 6528 6669 6c74   FilterFile(filt
-0001ff80: 6572 5f66 696c 6529 0a0a 2020 2020 636f  er_file)..    co
-0001ff90: 6f20 3d20 636f 6f72 642e 536b 7943 6f6f  o = coord.SkyCoo
-0001ffa0: 7264 2872 613d 7261 2c20 6465 633d 6465  rd(ra=ra, dec=de
-0001ffb0: 632c 2075 6e69 743d 2875 2e64 6567 2c20  c, unit=(u.deg, 
-0001ffc0: 752e 6465 6729 2c0a 2020 2020 2020 2020  u.deg),.        
-0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffe0: 2066 7261 6d65 3d27 6963 7273 2729 0a0a   frame='icrs')..
-0001fff0: 2020 2020 636f 6c75 6d6e 7320 3d20 5b27      columns = ['
-00020000: 2a27 5d0a 2020 2020 2363 6f6c 756d 6e73  *'].    #columns
-00020010: 203d 205b 5d0a 2020 2020 6966 2069 7369   = [].    if isi
-00020020: 6e73 7461 6e63 6528 7669 7a69 6572 5f63  nstance(vizier_c
-00020030: 6174 616c 6f67 2c20 6c69 7374 293a 0a20  atalog, list):. 
-00020040: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
-00020050: 5b56 494b 494e 475f 5649 5a49 4552 5d3a  [VIKING_VIZIER]:
-00020060: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00020070: 2062 2069 6e20 5649 5a49 4552 5f42 414e   b in VIZIER_BAN
-00020080: 4453 5b63 5d3a 0a20 2020 2020 2020 2020  DS[c]:.         
-00020090: 2020 2020 2020 2063 6f6c 756d 6e73 202b         columns +
-000200a0: 3d20 5649 5a49 4552 5f42 414e 4453 5b63  = VIZIER_BANDS[c
-000200b0: 5d5b 625d 0a0a 2020 2020 2020 2020 636f  ][b]..        co
-000200c0: 6c75 6d6e 7320 3d20 6c69 7374 286e 702e  lumns = list(np.
-000200d0: 756e 6971 7565 2863 6f6c 756d 6e73 2929  unique(columns))
-000200e0: 0a20 2020 2020 2020 2023 7072 696e 7428  .        #print(
-000200f0: 2278 7878 2063 6f6c 756d 6e73 222c 2063  "xxx columns", c
-00020100: 6f6c 756d 6e73 290a 2020 2020 656c 7365  olumns).    else
-00020110: 3a0a 2020 2020 2020 2020 666f 7220 6220  :.        for b 
-00020120: 696e 2062 616e 6473 3a0a 2020 2020 2020  in bands:.      
-00020130: 2020 2020 2020 636f 6c75 6d6e 7320 2b3d        columns +=
-00020140: 2062 616e 6473 5b62 5d0a 0a20 2020 2069   bands[b]..    i
-00020150: 6620 6973 696e 7374 616e 6365 2876 697a  f isinstance(viz
-00020160: 6965 725f 6361 7461 6c6f 672c 206c 6973  ier_catalog, lis
-00020170: 7429 3a0a 2020 2020 2020 2020 7620 3d20  t):.        v = 
-00020180: 5669 7a69 6572 2863 6174 616c 6f67 3d56  Vizier(catalog=V
-00020190: 494b 494e 475f 5649 5a49 4552 2c20 636f  IKING_VIZIER, co
-000201a0: 6c75 6d6e 733d 5b27 2b5f 7227 5d2b 636f  lumns=['+_r']+co
-000201b0: 6c75 6d6e 7329 0a20 2020 2065 6c73 653a  lumns).    else:
-000201c0: 0a20 2020 2020 2020 2076 203d 2056 697a  .        v = Viz
-000201d0: 6965 7228 6361 7461 6c6f 673d 7669 7a69  ier(catalog=vizi
-000201e0: 6572 5f63 6174 616c 6f67 2c20 636f 6c75  er_catalog, colu
-000201f0: 6d6e 733d 5b27 2b5f 7227 5d2b 636f 6c75  mns=['+_r']+colu
-00020200: 6d6e 7329 0a0a 2020 2020 762e 524f 575f  mns)..    v.ROW_
-00020210: 4c49 4d49 5420 3d20 726f 776c 696d 6974  LIMIT = rowlimit
-00020220: 0a20 2020 2076 2e54 494d 454f 5554 203d  .    v.TIMEOUT =
-00020230: 2074 696d 656f 7574 0a0a 2020 2020 2371   timeout..    #q
-00020240: 7565 7279 5f63 6174 616c 6f67 203d 2076  uery_catalog = v
-00020250: 697a 6965 725f 6361 7461 6c6f 670a 2020  izier_catalog.  
-00020260: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
-00020270: 6162 7320 3d20 762e 7175 6572 795f 7265  abs = v.query_re
-00020280: 6769 6f6e 2863 6f6f 2c20 7261 6469 7573  gion(coo, radius
-00020290: 3d22 7b30 7d73 222e 666f 726d 6174 2872  ="{0}s".format(r
-000202a0: 6164 6975 7329 2c0a 2020 2020 2020 2020  adius),.        
-000202b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202c0: 2020 6361 7461 6c6f 673d 7669 7a69 6572    catalog=vizier
-000202d0: 5f63 6174 616c 6f67 2920 2023 205b 305d  _catalog)  # [0]
-000202e0: 0a0a 2020 2020 2020 2020 6966 2072 6177  ..        if raw
-000202f0: 5f71 7565 7279 3a0a 2020 2020 2020 2020  _query:.        
-00020300: 2020 2020 7265 7475 726e 2874 6162 7329      return(tabs)
-00020310: 0a0a 2020 2020 2020 2020 7461 6220 3d20  ..        tab = 
-00020320: 7461 6273 5b30 5d0a 0a20 2020 2020 2020  tabs[0]..       
-00020330: 2069 6620 4661 6c73 653a 0a20 2020 2020   if False:.     
-00020340: 2020 2020 2020 2066 6f72 2074 2069 6e20         for t in 
-00020350: 7461 6273 3a0a 2020 2020 2020 2020 2020  tabs:.          
-00020360: 2020 2020 2020 6261 6e64 7320 3d20 5649        bands = VI
-00020370: 5a49 4552 5f42 414e 4453 5b74 2e6d 6574  ZIER_BANDS[t.met
-00020380: 615b 276e 616d 6527 5d5d 0a20 2020 2020  a['name']].     
-00020390: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
-000203a0: 2069 6e20 6261 6e64 733a 0a20 2020 2020   in bands:.     
-000203b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000203c0: 6f72 2063 2069 6e20 6261 6e64 735b 625d  or c in bands[b]
-000203d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000203e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000203f0: 742e 6d65 7461 5b27 6e61 6d65 275d 2c20  t.meta['name'], 
-00020400: 632c 2063 2069 6e20 742e 636f 6c6e 616d  c, c in t.colnam
-00020410: 6573 2920 2023 2063 203d 2062 616e 6473  es)  # c = bands
-00020420: 5b62 5d5b 305d 0a0a 2020 2020 2020 2020  [b][0]..        
-00020430: 6978 203d 206e 702e 6172 676d 696e 2874  ix = np.argmin(t
-00020440: 6162 5b27 5f72 275d 290a 2020 2020 2020  ab['_r']).      
-00020450: 2020 7461 6220 3d20 7461 625b 6978 5d0a    tab = tab[ix].
-00020460: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-00020470: 2020 2020 7461 6220 3d20 4e6f 6e65 0a0a      tab = None..
-00020480: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00020490: 6f6e 650a 0a20 2020 2076 697a 5f74 6162  one..    viz_tab
-000204a0: 6c65 7320 3d20 272c 2027 2e6a 6f69 6e28  les = ', '.join(
-000204b0: 5b74 2e6d 6574 615b 276e 616d 6527 5d20  [t.meta['name'] 
-000204c0: 666f 7220 7420 696e 2074 6162 735d 290a  for t in tabs]).
-000204d0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-000204e0: 2020 2020 2020 2020 7072 696e 7428 2750          print('P
-000204f0: 686f 746f 6d65 7472 7920 6672 6f6d 2076  hotometry from v
-00020500: 697a 6965 7220 6361 7461 6c6f 6773 3a20  izier catalogs: 
-00020510: 7b30 7d27 2e66 6f72 6d61 7428 7669 7a5f  {0}'.format(viz_
-00020520: 7461 626c 6573 2929 0a0a 2020 2020 7069  tables))..    pi
-00020530: 766f 7420 3d20 5b5d 2020 2320 4f72 6465  vot = []  # Orde
-00020540: 7265 6444 6963 7428 290a 2020 2020 666c  redDict().    fl
-00020550: 616d 203d 205b 5d0a 2020 2020 6566 6c61  am = [].    efla
-00020560: 6d20 3d20 5b5d 0a20 2020 2066 696c 7465  m = [].    filte
-00020570: 7273 203d 205b 5d0a 0a20 2020 2066 6f72  rs = []..    for
-00020580: 2074 6162 2069 6e20 7461 6273 3a0a 0a20   tab in tabs:.. 
-00020590: 2020 2020 2020 2023 2044 6f77 6e77 6569         # Downwei
-000205a0: 6768 7420 5053 3120 6966 2068 6176 6520  ght PS1 if have 
-000205b0: 5344 5353 203f 2020 466f 7220 6e6f 772c  SDSS ?  For now,
-000205c0: 2064 6f20 6e6f 7468 696e 670a 2020 2020   do nothing.    
-000205d0: 2020 2020 6966 2028 7461 622e 6d65 7461      if (tab.meta
-000205e0: 5b27 6e61 6d65 275d 203d 3d20 5053 315f  ['name'] == PS1_
-000205f0: 5649 5a49 4552 2920 2620 2853 4453 535f  VIZIER) & (SDSS_
-00020600: 4452 3132 5f56 495a 4945 5220 696e 2076  DR12_VIZIER in v
-00020610: 697a 5f74 6162 6c65 7329 3a0a 2020 2020  iz_tables):.    
-00020620: 2020 2020 2020 2020 2320 636f 6e74 696e          # contin
-00020630: 7565 0a20 2020 2020 2020 2020 2020 2065  ue.            e
-00020640: 7272 5f73 6361 6c65 203d 2031 0a20 2020  rr_scale = 1.   
-00020650: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00020660: 2020 2020 2020 2065 7272 5f73 6361 6c65         err_scale
-00020670: 203d 2031 0a0a 2020 2020 2020 2020 2320   = 1..        # 
-00020680: 4f6e 6c79 2075 7365 206f 6e65 2043 4648  Only use one CFH
-00020690: 5420 6361 7461 6c6f 670a 2020 2020 2020  T catalog.      
-000206a0: 2020 6966 2028 7461 622e 6d65 7461 5b27    if (tab.meta['
-000206b0: 6e61 6d65 275d 203d 3d20 4346 4854 4c53  name'] == CFHTLS
-000206c0: 5f57 5f56 495a 4945 5229 2026 2028 4346  _W_VIZIER) & (CF
-000206d0: 4854 4c53 5f44 5f56 495a 4945 5220 696e  HTLS_D_VIZIER in
-000206e0: 2076 697a 5f74 6162 6c65 7329 3a0a 2020   viz_tables):.  
-000206f0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00020700: 7565 0a0a 2020 2020 2020 2020 6966 2028  ue..        if (
-00020710: 7461 622e 6d65 7461 5b27 6e61 6d65 275d  tab.meta['name']
-00020720: 203d 3d20 554b 4944 5353 5f4c 4153 5f56   == UKIDSS_LAS_V
-00020730: 495a 4945 5229 3a0a 2020 2020 2020 2020  IZIER):.        
-00020740: 2020 2020 666c 7578 5f73 6361 6c65 203d      flux_scale =
-00020750: 2031 2e33 330a 2020 2020 2020 2020 656c   1.33.        el
-00020760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00020770: 666c 7578 5f73 6361 6c65 203d 2031 2e0a  flux_scale = 1..
-00020780: 0a20 2020 2020 2020 2063 6f6e 7665 7274  .        convert
-00020790: 5f76 6567 6120 3d20 5649 5a49 4552 5f56  _vega = VIZIER_V
-000207a0: 4547 415b 7461 622e 6d65 7461 5b27 6e61  EGA[tab.meta['na
-000207b0: 6d65 275d 5d0a 2020 2020 2020 2020 6261  me']].        ba
-000207c0: 6e64 7320 3d20 5649 5a49 4552 5f42 414e  nds = VIZIER_BAN
-000207d0: 4453 5b74 6162 2e6d 6574 615b 276e 616d  DS[tab.meta['nam
-000207e0: 6527 5d5d 0a0a 2020 2020 2020 2020 2320  e']]..        # 
-000207f0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00020800: 2020 2020 2320 2020 2070 7269 6e74 2874      #    print(t
-00020810: 6162 2e63 6f6c 6e61 6d65 7329 0a0a 2020  ab.colnames)..  
-00020820: 2020 2020 2020 2366 696c 7465 7273 202b        #filters +
-00020830: 3d20 5b72 6573 2e66 696c 7465 7273 5b72  = [res.filters[r
-00020840: 6573 2e73 6561 7263 6828 622c 2076 6572  es.search(b, ver
-00020850: 626f 7365 3d46 616c 7365 295b 305d 5d20  bose=False)[0]] 
-00020860: 666f 7220 6220 696e 2062 616e 6473 5d0a  for b in bands].
-00020870: 0a20 2020 2020 2020 2074 6f5f 666c 616d  .        to_flam
-00020880: 203d 2031 302a 2a28 2d30 2e34 2a28 3438   = 10**(-0.4*(48
-00020890: 2e36 2929 2a33 2e65 3138 2020 2320 2f20  .6))*3.e18  # / 
-000208a0: 7069 766f 7428 416e 6729 2a2a 320a 0a20  pivot(Ang)**2.. 
-000208b0: 2020 2020 2020 2066 6f72 2069 622c 2062         for ib, b
-000208c0: 2069 6e20 656e 756d 6572 6174 6528 6261   in enumerate(ba
-000208d0: 6e64 7329 3a0a 2020 2020 2020 2020 2020  nds):.          
-000208e0: 2020 6669 6c74 203d 2072 6573 2e66 696c    filt = res.fil
-000208f0: 7465 7273 5b72 6573 2e73 6561 7263 6828  ters[res.search(
-00020900: 622c 2076 6572 626f 7365 3d46 616c 7365  b, verbose=False
-00020910: 295b 305d 5d0a 2020 2020 2020 2020 2020  )[0]].          
-00020920: 2020 6669 6c74 6572 732e 6170 7065 6e64    filters.append
-00020930: 2866 696c 7429 0a0a 2020 2020 2020 2020  (filt)..        
-00020940: 2020 2020 6966 2063 6f6e 7665 7274 5f76      if convert_v
-00020950: 6567 613a 0a20 2020 2020 2020 2020 2020  ega:.           
-00020960: 2020 2020 2074 6f5f 6162 203d 2066 696c       to_ab = fil
-00020970: 742e 4142 5665 6761 2829 0a20 2020 2020  t.ABVega().     
-00020980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00020990: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
-000209a0: 6162 203d 2030 2e0a 0a20 2020 2020 2020  ab = 0...       
-000209b0: 2020 2020 2066 636f 6c2c 2065 636f 6c20       fcol, ecol 
-000209c0: 3d20 6261 6e64 735b 625d 0a20 2020 2020  = bands[b].     
-000209d0: 2020 2020 2020 2070 6976 6f74 2e61 7070         pivot.app
-000209e0: 656e 6428 6669 6c74 2e70 6976 6f74 2829  end(filt.pivot()
-000209f0: 290a 2020 2020 2020 2020 2020 2020 666c  ).            fl
-00020a00: 616d 2e61 7070 656e 6428 3130 2a2a 282d  am.append(10**(-
-00020a10: 302e 342a 2874 6162 5b66 636f 6c5d 5b30  0.4*(tab[fcol][0
-00020a20: 5d2b 746f 5f61 6229 292a 746f 5f66 6c61  ]+to_ab))*to_fla
-00020a30: 6d2f 7069 766f 745b 2d31 5d2a 2a32 290a  m/pivot[-1]**2).
-00020a40: 2020 2020 2020 2020 2020 2020 666c 616d              flam
-00020a50: 5b2d 315d 202a 3d20 666c 7578 5f73 6361  [-1] *= flux_sca
-00020a60: 6c65 0a20 2020 2020 2020 2020 2020 2065  le.            e
-00020a70: 666c 616d 2e61 7070 656e 6428 7461 625b  flam.append(tab[
-00020a80: 6563 6f6c 5d5b 305d 2a6e 702e 6c6f 6728  ecol][0]*np.log(
-00020a90: 3130 292f 322e 352a 666c 616d 5b2d 315d  10)/2.5*flam[-1]
-00020aa0: 2a65 7272 5f73 6361 6c65 290a 0a20 2020  *err_scale)..   
-00020ab0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00020ac0: 6c65 6e28 6669 6c74 6572 7329 295b 3a3a  len(filters))[::
-00020ad0: 2d31 5d3a 0a20 2020 2020 2020 2069 6620  -1]:.        if 
-00020ae0: 6e70 2e69 7373 6361 6c61 7228 666c 616d  np.isscalar(flam
-00020af0: 5b69 5d29 2026 206e 702e 6973 7363 616c  [i]) & np.isscal
-00020b00: 6172 2865 666c 616d 5b69 5d29 3a0a 2020  ar(eflam[i]):.  
-00020b10: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00020b20: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
-00020b30: 0a20 2020 2020 2020 2020 2020 2066 6c61  .            fla
-00020b40: 6d2e 706f 7028 6929 0a20 2020 2020 2020  m.pop(i).       
-00020b50: 2020 2020 2065 666c 616d 2e70 6f70 2869       eflam.pop(i
-00020b60: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
-00020b70: 6c74 6572 732e 706f 7028 6929 0a20 2020  lters.pop(i).   
-00020b80: 2020 2020 2020 2020 2070 6976 6f74 2e70           pivot.p
-00020b90: 6f70 2869 290a 0a20 2020 206c 6320 3d20  op(i)..    lc = 
-00020ba0: 6e70 2e61 7272 6179 2870 6976 6f74 2920  np.array(pivot) 
-00020bb0: 2023 205b 7069 766f 745b 6962 5d20 666f   # [pivot[ib] fo
-00020bc0: 7220 6962 2069 6e20 7261 6e67 6528 6c65  r ib in range(le
-00020bd0: 6e28 6261 6e64 7329 295d 0a0a 2020 2020  n(bands))]..    
-00020be0: 6966 2074 656d 706c 6174 6573 2069 7320  if templates is 
-00020bf0: 6e6f 7420 4e6f 6e65 3a0a 0a20 2020 2020  not None:..     
-00020c00: 2020 2065 617a 795f 7465 6d70 6c61 7465     eazy_template
-00020c10: 7320 3d20 5b54 656d 706c 6174 6528 6172  s = [Template(ar
-00020c20: 7261 7973 3d28 7465 6d70 6c61 7465 735b  rays=(templates[
-00020c30: 6b5d 2e77 6176 652c 2074 656d 706c 6174  k].wave, templat
-00020c40: 6573 5b6b 5d2e 666c 7578 292c 206e 616d  es[k].flux), nam
-00020c50: 653d 6b29 2066 6f72 206b 2069 6e20 7465  e=k) for k in te
-00020c60: 6d70 6c61 7465 735d 0a0a 2020 2020 2020  mplates]..      
-00020c70: 2020 7a67 7269 6420 3d20 6c6f 675f 7a67    zgrid = log_zg
-00020c80: 7269 6428 7a72 3d5b 302e 3031 2c20 332e  rid(zr=[0.01, 3.
-00020c90: 345d 2c20 647a 3d30 2e30 3035 290a 0a20  4], dz=0.005).. 
-00020ca0: 2020 2020 2020 2074 656d 7066 696c 7420         tempfilt 
-00020cb0: 3d20 5465 6d70 6c61 7465 4772 6964 287a  = TemplateGrid(z
-00020cc0: 6772 6964 2c20 6561 7a79 5f74 656d 706c  grid, eazy_templ
-00020cd0: 6174 6573 2c20 6669 6c74 6572 733d 6669  ates, filters=fi
-00020ce0: 6c74 6572 732c 2061 6464 5f69 676d 3d54  lters, add_igm=T
-00020cf0: 7275 652c 2067 616c 6163 7469 635f 6562  rue, galactic_eb
-00020d00: 763d 4d57 5f45 4256 2c20 4562 3d30 2c20  v=MW_EBV, Eb=0, 
-00020d10: 6e5f 7072 6f63 3d30 2c20 7665 7262 6f73  n_proc=0, verbos
-00020d20: 653d 4661 6c73 6529 0a20 2020 2065 6c73  e=False).    els
-00020d30: 653a 0a20 2020 2020 2020 2074 656d 7066  e:.        tempf
-00020d40: 696c 7420 3d20 4e6f 6e65 0a0a 2020 2020  ilt = None..    
-00020d50: 7068 6f74 203d 204f 7264 6572 6564 4469  phot = OrderedDi
-00020d60: 6374 285b 2827 666c 616d 272c 206e 702e  ct([('flam', np.
-00020d70: 6172 7261 7928 666c 616d 2929 2c20 2827  array(flam)), ('
-00020d80: 6566 6c61 6d27 2c20 6e70 2e61 7272 6179  eflam', np.array
-00020d90: 2865 666c 616d 2929 2c20 2827 6669 6c74  (eflam)), ('filt
-00020da0: 6572 7327 2c20 6669 6c74 6572 7329 2c20  ers', filters), 
-00020db0: 2827 7465 6d70 6669 6c74 272c 2074 656d  ('tempfilt', tem
-00020dc0: 7066 696c 7429 2c20 2827 6c63 272c 206e  pfilt), ('lc', n
-00020dd0: 702e 6172 7261 7928 6c63 2929 2c20 2827  p.array(lc)), ('
-00020de0: 736f 7572 6365 272c 2027 5669 7a69 6572  source', 'Vizier
-00020df0: 2027 2b76 697a 5f74 6162 6c65 7329 5d29   '+viz_tables)])
-00020e00: 0a0a 2020 2020 7265 7475 726e 2070 686f  ..    return pho
-00020e10: 740a 0a0a 6465 6620 6765 6e65 7261 7465  t...def generate
-00020e20: 5f74 656d 7066 696c 7428 7465 6d70 6c61  _tempfilt(templa
-00020e30: 7465 732c 2066 696c 7465 7273 2c20 7a67  tes, filters, zg
-00020e40: 7269 643d 4e6f 6e65 2c20 4d57 5f45 4256  rid=None, MW_EBV
-00020e50: 3d30 293a 0a0a 2020 2020 6672 6f6d 2065  =0):..    from e
-00020e60: 617a 792e 7465 6d70 6c61 7465 7320 696d  azy.templates im
-00020e70: 706f 7274 2054 656d 706c 6174 650a 2020  port Template.  
-00020e80: 2020 6672 6f6d 2065 617a 792e 7068 6f74    from eazy.phot
-00020e90: 6f7a 2069 6d70 6f72 7420 5465 6d70 6c61  oz import Templa
-00020ea0: 7465 4772 6964 0a0a 2020 2020 2320 7477  teGrid..    # tw
-00020eb0: 6176 652c 2074 666c 7578 2c20 6973 5f6c  ave, tflux, is_l
-00020ec0: 696e 6520 3d20 6172 7261 795f 7465 6d70  ine = array_temp
-00020ed0: 6c61 7465 7328 7465 6d70 6c61 7465 732c  lates(templates,
-00020ee0: 207a 3d30 290a 2020 2020 2320 6561 7a79   z=0).    # eazy
-00020ef0: 5f74 656d 706c 6174 6573 203d 205b 5d0a  _templates = [].
-00020f00: 2020 2020 2320 666f 7220 692c 2074 2069      # for i, t i
-00020f10: 6e20 656e 756d 6572 6174 6528 7465 6d70  n enumerate(temp
-00020f20: 6c61 7465 7329 3a0a 2020 2020 2320 2020  lates):.    #   
-00020f30: 2020 6561 7a79 5f74 656d 706c 6174 6573    eazy_templates
-00020f40: 2e61 7070 656e 6428 5465 6d70 6c61 7465  .append(Template
-00020f50: 2861 7272 6179 733d 5b74 7761 7665 2c20  (arrays=[twave, 
-00020f60: 6e70 2e6d 6178 696d 756d 2874 7761 7665  np.maximum(twave
-00020f70: 2c20 312e 652d 3330 295d 2c20 6e61 6d65  , 1.e-30)], name
-00020f80: 3d74 2929 0a0a 2020 2020 6561 7a79 5f74  =t))..    eazy_t
-00020f90: 656d 706c 6174 6573 203d 205b 5465 6d70  emplates = [Temp
-00020fa0: 6c61 7465 2861 7272 6179 733d 2874 656d  late(arrays=(tem
-00020fb0: 706c 6174 6573 5b6b 5d2e 7761 7665 2c20  plates[k].wave, 
-00020fc0: 7465 6d70 6c61 7465 735b 6b5d 2e66 6c75  templates[k].flu
-00020fd0: 7829 2c20 6e61 6d65 3d6b 2920 666f 7220  x), name=k) for 
-00020fe0: 6b20 696e 2074 656d 706c 6174 6573 5d0a  k in templates].
-00020ff0: 0a20 2020 2069 6620 7a67 7269 6420 6973  .    if zgrid is
-00021000: 204e 6f6e 653a 0a20 2020 2020 2020 207a   None:.        z
-00021010: 6772 6964 203d 206c 6f67 5f7a 6772 6964  grid = log_zgrid
-00021020: 287a 723d 5b30 2e30 312c 2033 2e34 5d2c  (zr=[0.01, 3.4],
-00021030: 2064 7a3d 302e 3030 3529 0a0a 2020 2020   dz=0.005)..    
-00021040: 7465 6d70 6669 6c74 203d 2054 656d 706c  tempfilt = Templ
-00021050: 6174 6547 7269 6428 7a67 7269 642c 2065  ateGrid(zgrid, e
-00021060: 617a 795f 7465 6d70 6c61 7465 732c 2066  azy_templates, f
-00021070: 696c 7465 7273 3d66 696c 7465 7273 2c20  ilters=filters, 
-00021080: 6164 645f 6967 6d3d 5472 7565 2c20 6761  add_igm=True, ga
-00021090: 6c61 6374 6963 5f65 6276 3d4d 575f 4542  lactic_ebv=MW_EB
-000210a0: 562c 2045 623d 302c 206e 5f70 726f 633d  V, Eb=0, n_proc=
-000210b0: 302c 2076 6572 626f 7365 3d46 616c 7365  0, verbose=False
-000210c0: 290a 0a20 2020 2072 6574 7572 6e20 7465  )..    return te
-000210d0: 6d70 6669 6c74 0a0a 0a64 6566 2063 6f6d  mpfilt...def com
-000210e0: 6269 6e65 5f70 686f 745f 6469 6374 2870  bine_phot_dict(p
-000210f0: 686f 7473 2c20 7465 6d70 6c61 7465 733d  hots, templates=
-00021100: 4e6f 6e65 2c20 4d57 5f45 4256 3d30 293a  None, MW_EBV=0):
-00021110: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
-00021120: 6269 6e65 2070 686f 746d 6574 7279 2064  bine photmetry d
-00021130: 6963 7469 6f6e 6172 6965 730a 2020 2020  ictionaries.    
-00021140: 2222 220a 2020 2020 7068 6f74 203d 207b  """.    phot = {
-00021150: 7d0a 2020 2020 7068 6f74 5b27 666c 616d  }.    phot['flam
-00021160: 275d 203d 205b 5d0a 2020 2020 7068 6f74  '] = [].    phot
-00021170: 5b27 6566 6c61 6d27 5d20 3d20 5b5d 0a20  ['eflam'] = []. 
-00021180: 2020 2070 686f 745b 2766 696c 7465 7273     phot['filters
-00021190: 275d 203d 205b 5d0a 2020 2020 666f 7220  '] = [].    for 
-000211a0: 7020 696e 2070 686f 7473 3a0a 2020 2020  p in phots:.    
-000211b0: 2020 2020 7068 6f74 5b27 666c 616d 275d      phot['flam']
-000211c0: 203d 206e 702e 6170 7065 6e64 2870 686f   = np.append(pho
-000211d0: 745b 2766 6c61 6d27 5d2c 2070 5b27 666c  t['flam'], p['fl
-000211e0: 616d 275d 290a 2020 2020 2020 2020 7068  am']).        ph
-000211f0: 6f74 5b27 6566 6c61 6d27 5d20 3d20 6e70  ot['eflam'] = np
-00021200: 2e61 7070 656e 6428 7068 6f74 5b27 6566  .append(phot['ef
-00021210: 6c61 6d27 5d2c 2070 5b27 6566 6c61 6d27  lam'], p['eflam'
-00021220: 5d29 0a20 2020 2020 2020 2070 686f 745b  ]).        phot[
-00021230: 2766 696c 7465 7273 275d 2e65 7874 656e  'filters'].exten
-00021240: 6428 705b 2766 696c 7465 7273 275d 290a  d(p['filters']).
-00021250: 0a20 2020 2069 6620 7465 6d70 6c61 7465  .    if template
-00021260: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00021270: 2020 2020 2020 2070 686f 745b 2774 656d         phot['tem
-00021280: 7066 696c 7427 5d20 3d20 6765 6e65 7261  pfilt'] = genera
-00021290: 7465 5f74 656d 7066 696c 7428 7465 6d70  te_tempfilt(temp
-000212a0: 6c61 7465 732c 2070 686f 745b 2766 696c  lates, phot['fil
-000212b0: 7465 7273 275d 2c20 4d57 5f45 4256 3d4d  ters'], MW_EBV=M
-000212c0: 575f 4542 5629 0a0a 2020 2020 7265 7475  W_EBV)..    retu
-000212d0: 726e 2070 686f 740a 0a0a 6465 6620 6765  rn phot...def ge
-000212e0: 745f 7370 6563 7472 756d 5f41 425f 6d61  t_spectrum_AB_ma
-000212f0: 6773 2873 7065 6374 7275 6d2c 2062 616e  gs(spectrum, ban
-00021300: 6470 6173 7365 733d 5b5d 293a 0a20 2020  dpasses=[]):.   
-00021310: 2022 2222 0a20 2020 2049 6e74 6567 7261   """.    Integra
-00021320: 7465 2061 2060 7e70 7973 796e 7068 6f74  te a `~pysynphot
-00021330: 6020 7370 6563 7472 756d 2074 6872 6f75  ` spectrum throu
-00021340: 6768 2066 696c 7465 7220 6261 6e64 7061  gh filter bandpa
-00021350: 7373 6573 0a0a 2020 2020 5061 7261 6d65  sses..    Parame
-00021360: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00021370: 2d2d 2d0a 2020 2020 7370 6563 7472 756d  ---.    spectrum
-00021380: 203a 2074 7970 650a 0a20 2020 2062 616e   : type..    ban
-00021390: 6470 6173 7365 7320 3a20 6c69 7374 0a20  dpasses : list. 
-000213a0: 2020 2020 2020 204c 6973 7420 6f66 2060         List of `
-000213b0: 7079 7379 6e70 686f 7460 2062 616e 6470  pysynphot` bandp
-000213c0: 6173 7320 6f62 6a65 6374 732c 2065 2e67  ass objects, e.g
-000213d0: 2e2c 0a0a 2020 2020 2020 2020 2020 203e  .,..           >
-000213e0: 3e3e 2069 6d70 6f72 7420 7079 7379 6e70  >> import pysynp
-000213f0: 686f 7420 6173 2053 0a20 2020 2020 2020  hot as S.       
-00021400: 2020 2020 3e3e 3e20 6261 6e64 7061 7373      >>> bandpass
-00021410: 6573 203d 205b 532e 4f62 7342 616e 6470  es = [S.ObsBandp
-00021420: 6173 7328 2777 6663 332c 6972 2c66 3134  ass('wfc3,ir,f14
-00021430: 3077 2729 5d0a 0a0a 2020 2020 5265 7475  0w')]...    Retu
-00021440: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00021450: 2020 2020 6162 5f6d 6167 7320 3a20 6469      ab_mags : di
-00021460: 6374 0a20 2020 2020 2020 2044 6963 7469  ct.        Dicti
-00021470: 6f6e 6172 7920 7769 7468 206b 6579 7320  onary with keys 
-00021480: 6672 6f6d 2060 6261 6e64 7061 7373 6573  from `bandpasses
-00021490: 6020 616e 6420 7468 6520 696e 7465 6772  ` and the integr
-000214a0: 6174 6564 206d 6167 6e69 7475 6465 730a  ated magnitudes.
-000214b0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-000214c0: 6f72 7420 7079 7379 6e70 686f 7420 6173  ort pysynphot as
-000214d0: 2053 0a20 2020 2066 6c61 7420 3d20 532e   S.    flat = S.
-000214e0: 466c 6174 5370 6563 7472 756d 2830 2c20  FlatSpectrum(0, 
-000214f0: 666c 7578 756e 6974 733d 2741 424d 6167  fluxunits='ABMag
-00021500: 2729 0a20 2020 2061 625f 6d61 6773 203d  ').    ab_mags =
-00021510: 204f 7264 6572 6564 4469 6374 2829 0a0a   OrderedDict()..
-00021520: 2020 2020 666f 7220 6270 2069 6e20 6261      for bp in ba
-00021530: 6e64 7061 7373 6573 3a0a 2020 2020 2020  ndpasses:.      
-00021540: 2020 666c 6174 5f6f 6273 203d 2053 2e4f    flat_obs = S.O
-00021550: 6273 6572 7661 7469 6f6e 2866 6c61 742c  bservation(flat,
-00021560: 2062 7029 0a20 2020 2020 2020 2073 7065   bp).        spe
-00021570: 635f 6f62 7320 3d20 532e 4f62 7365 7276  c_obs = S.Observ
-00021580: 6174 696f 6e28 7370 6563 7472 756d 2c20  ation(spectrum, 
-00021590: 6270 290a 2020 2020 2020 2020 6162 5f6d  bp).        ab_m
-000215a0: 6167 735b 6270 2e6e 616d 655d 203d 202d  ags[bp.name] = -
-000215b0: 322e 352a 6e70 2e6c 6f67 3130 2873 7065  2.5*np.log10(spe
-000215c0: 635f 6f62 732e 636f 756e 7472 6174 6528  c_obs.countrate(
-000215d0: 292f 666c 6174 5f6f 6273 2e63 6f75 6e74  )/flat_obs.count
-000215e0: 7261 7465 2829 290a 0a20 2020 2072 6574  rate())..    ret
-000215f0: 7572 6e20 6162 5f6d 6167 730a 0a0a 6465  urn ab_mags...de
-00021600: 6620 6c6f 675f 7a67 7269 6428 7a72 3d5b  f log_zgrid(zr=[
-00021610: 302e 372c 2033 2e34 5d2c 2064 7a3d 302e  0.7, 3.4], dz=0.
-00021620: 3031 293a 0a20 2020 2022 2222 4d61 6b65  01):.    """Make
-00021630: 2061 206c 6f67 6172 6974 686d 6963 616c   a logarithmical
-00021640: 6c79 2073 7061 6365 6420 7265 6473 6869  ly spaced redshi
-00021650: 6674 2067 7269 640a 0a20 2020 2050 6172  ft grid..    Par
-00021660: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00021670: 2d2d 2d2d 2d2d 0a20 2020 207a 7220 3a20  ------.    zr : 
-00021680: 5b66 6c6f 6174 2c20 666c 6f61 745d 0a20  [float, float]. 
-00021690: 2020 2020 2020 204d 696e 696d 756d 2061         Minimum a
-000216a0: 6e64 206d 6178 696d 756d 206f 6620 7468  nd maximum of th
-000216b0: 6520 6465 7369 7265 6420 6772 6964 0a0a  e desired grid..
-000216c0: 2020 2020 647a 203a 2066 6c6f 6174 0a20      dz : float. 
-000216d0: 2020 2020 2020 2053 7465 7020 7369 7a65         Step size
-000216e0: 2c20 647a 2f28 312b 7a29 0a0a 2020 2020  , dz/(1+z)..    
-000216f0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00021700: 2d2d 2d0a 2020 2020 7a67 7269 6420 3a20  ---.    zgrid : 
-00021710: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
-00021720: 2020 2052 6564 7368 6966 7420 6772 6964     Redshift grid
-00021730: 0a0a 2020 2020 2222 220a 2020 2020 7a67  ..    """.    zg
-00021740: 7269 6420 3d20 6e70 2e65 7870 286e 702e  rid = np.exp(np.
-00021750: 6172 616e 6765 286e 702e 6c6f 6728 312b  arange(np.log(1+
-00021760: 7a72 5b30 5d29 2c20 6e70 2e6c 6f67 2831  zr[0]), np.log(1
-00021770: 2b7a 725b 315d 292c 2064 7a29 292d 310a  +zr[1]), dz))-1.
-00021780: 2020 2020 7265 7475 726e 207a 6772 6964      return zgrid
-00021790: 0a0a 6465 6620 7472 6170 7a5f 6478 2878  ..def trapz_dx(x
-000217a0: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
-000217b0: 6574 7572 6e20 7472 6170 657a 6f69 6420  eturn trapezoid 
-000217c0: 7275 6c65 2063 6f65 6666 6963 6965 6e74  rule coefficient
-000217d0: 732c 2075 7365 6675 6c20 666f 7220 6e75  s, useful for nu
-000217e0: 6d65 7269 6361 6c20 696e 7465 6772 6174  merical integrat
-000217f0: 696f 6e20 0a20 2020 2075 7369 6e67 2061  ion .    using a
-00021800: 2064 6f74 2070 726f 6475 6374 0a20 2020   dot product.   
-00021810: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
-00021820: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00021830: 2020 2020 7820 3a20 6172 7261 792d 6c69      x : array-li
-00021840: 6b65 0a20 2020 2020 2020 2049 6e64 6570  ke.        Indep
-00021850: 656e 6465 6e74 2076 6172 6961 626c 650a  endent variable.
-00021860: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
-00021870: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00021880: 2064 7820 3a20 6172 7261 795f 6c69 6b65   dx : array_like
-00021890: 0a20 2020 2020 2020 2043 6f65 6666 6963  .        Coeffic
-000218a0: 6965 6e74 7320 666f 7220 7472 6170 657a  ients for trapez
-000218b0: 6f69 6461 6c20 7275 6c65 2069 6e74 6567  oidal rule integ
-000218c0: 7261 7469 6f6e 2e0a 2020 2020 2020 2020  ration..        
-000218d0: 0a20 2020 2022 2222 0a20 2020 2064 7820  .    """.    dx 
-000218e0: 3d20 6e70 2e7a 6572 6f73 5f6c 696b 6528  = np.zeros_like(
-000218f0: 7829 0a20 2020 2064 6966 6620 3d20 6e70  x).    diff = np
-00021900: 2e64 6966 6628 7829 2f32 2e0a 2020 2020  .diff(x)/2..    
-00021910: 6478 5b3a 2d31 5d20 2b3d 2064 6966 660a  dx[:-1] += diff.
-00021920: 2020 2020 6478 5b31 3a5d 202b 3d20 6469      dx[1:] += di
-00021930: 6666 0a20 2020 2072 6574 7572 6e20 6478  ff.    return dx
-00021940: 0a0a 0a64 6566 2067 6574 5f77 6373 5f70  ...def get_wcs_p
-00021950: 7363 616c 6528 7763 732c 2073 6574 5f61  scale(wcs, set_a
-00021960: 7474 7269 6275 7465 3d54 7275 6529 3a0a  ttribute=True):.
-00021970: 2020 2020 2222 2247 6574 2063 6f72 7265      """Get corre
-00021980: 6374 2070 7363 616c 6520 6672 6f6d 2061  ct pscale from a
-00021990: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
-000219a0: 4353 6020 6f62 6a65 6374 0a0a 2020 2020  CS` object..    
-000219b0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000219c0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7763  ---------.    wc
-000219d0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
-000219e0: 732e 5743 5360 206f 7220 607e 6173 7472  s.WCS` or `~astr
-000219f0: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-00021a00: 6572 600a 0a20 2020 2073 6574 5f61 7474  er`..    set_att
-00021a10: 7269 6275 7465 203a 2062 6f6f 6c0a 2020  ribute : bool.  
-00021a20: 2020 2020 2020 5365 7420 7468 6520 6070        Set the `p
-00021a30: 7363 616c 6560 2061 7474 7269 6275 7465  scale` attribute
-00021a40: 206f 6e20 6077 6373 602c 2061 6c6f 6e67   on `wcs`, along
-00021a50: 2077 6974 6820 7265 7475 726e 696e 6720   with returning 
-00021a60: 7468 6520 7661 6c75 652e 0a0a 2020 2020  the value...    
-00021a70: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00021a80: 2d2d 2d0a 2020 2020 7073 6361 6c65 203a  ---.    pscale :
-00021a90: 2066 6c6f 6174 0a20 2020 2020 2020 2050   float.        P
-00021aa0: 6978 656c 2073 6361 6c65 2066 726f 6d20  ixel scale from 
-00021ab0: 6077 6373 2e63 6460 0a0a 2020 2020 2222  `wcs.cd`..    ""
-00021ac0: 220a 2020 2020 6672 6f6d 206e 756d 7079  ".    from numpy
-00021ad0: 2069 6d70 6f72 7420 6c69 6e61 6c67 0a0a   import linalg..
-00021ae0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00021af0: 6528 7763 732c 2070 7966 6974 732e 4865  e(wcs, pyfits.He
-00021b00: 6164 6572 293a 0a20 2020 2020 2020 2077  ader):.        w
-00021b10: 6373 203d 2070 7977 6373 2e57 4353 2877  cs = pywcs.WCS(w
-00021b20: 6373 2c20 7265 6c61 783d 5472 7565 290a  cs, relax=True).
-00021b30: 0a20 2020 2069 6620 6861 7361 7474 7228  .    if hasattr(
-00021b40: 7763 732e 7763 732c 2027 6364 2729 3a0a  wcs.wcs, 'cd'):.
-00021b50: 2020 2020 2020 2020 6465 7420 3d20 6c69          det = li
-00021b60: 6e61 6c67 2e64 6574 2877 6373 2e77 6373  nalg.det(wcs.wcs
-00021b70: 2e63 6429 0a20 2020 2065 6c73 653a 0a20  .cd).    else:. 
-00021b80: 2020 2020 2020 2064 6574 203d 206c 696e         det = lin
-00021b90: 616c 672e 6465 7428 7763 732e 7763 732e  alg.det(wcs.wcs.
-00021ba0: 7063 290a 0a20 2020 2070 7363 616c 6520  pc)..    pscale 
-00021bb0: 3d20 6e70 2e73 7172 7428 6e70 2e61 6273  = np.sqrt(np.abs
-00021bc0: 2864 6574 2929 2a33 3630 302e 0a20 2020  (det))*3600..   
-00021bd0: 200a 2020 2020 7769 7468 2077 6172 6e69   .    with warni
-00021be0: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
-00021bf0: 6773 2829 3a0a 2020 2020 2020 2020 7761  gs():.        wa
-00021c00: 726e 696e 6773 2e66 696c 7465 7277 6172  rnings.filterwar
-00021c10: 6e69 6e67 7328 2769 676e 6f72 6527 2c20  nings('ignore', 
-00021c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021c30: 2020 2027 6364 656c 7420 7769 6c6c 2062     'cdelt will b
-00021c40: 6520 6967 6e6f 7265 6420 7369 6e63 6520  e ignored since 
-00021c50: 6364 2069 7320 7072 6573 656e 7427 2c20  cd is present', 
-00021c60: 5275 6e74 696d 6557 6172 6e69 6e67 290a  RuntimeWarning).
-00021c70: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00021c80: 2069 6620 6861 7361 7474 7228 7763 732e   if hasattr(wcs.
-00021c90: 7763 732c 2027 6364 656c 7427 293a 0a20  wcs, 'cdelt'):. 
-00021ca0: 2020 2020 2020 2020 2020 2070 7363 616c             pscal
-00021cb0: 6520 2a3d 2077 6373 2e77 6373 2e63 6465  e *= wcs.wcs.cde
-00021cc0: 6c74 5b30 5d0a 2020 2020 2020 2020 0a20  lt[0].        . 
-00021cd0: 2020 2077 6373 2e70 7363 616c 6520 3d20     wcs.pscale = 
-00021ce0: 7073 6361 6c65 0a0a 2020 2020 7265 7475  pscale..    retu
-00021cf0: 726e 2070 7363 616c 650a 0a0a 6465 6620  rn pscale...def 
-00021d00: 7472 616e 7366 6f72 6d5f 7763 7328 696e  transform_wcs(in
-00021d10: 5f77 6373 2c20 7472 616e 736c 6174 696f  _wcs, translatio
-00021d20: 6e3d 5b30 2e2c 2030 2e5d 2c20 726f 7461  n=[0., 0.], rota
-00021d30: 7469 6f6e 3d30 2e2c 2073 6361 6c65 3d31  tion=0., scale=1
-00021d40: 2e29 3a0a 2020 2020 2222 2255 7064 6174  .):.    """Updat
-00021d50: 6520 5743 5320 7769 7468 2073 6869 6674  e WCS with shift
-00021d60: 2c20 726f 7461 7469 6f6e 2c20 2620 7363  , rotation, & sc
-00021d70: 616c 650a 0a20 2020 2050 6172 616d 6574  ale..    Paramet
-00021d80: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00021d90: 2d2d 0a20 2020 2069 6e5f 7763 733a 2060  --.    in_wcs: `
-00021da0: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
-00021db0: 600a 2020 2020 2020 2020 496e 7075 7420  `.        Input 
-00021dc0: 5743 530a 0a20 2020 2074 7261 6e73 6c61  WCS..    transla
-00021dd0: 7469 6f6e 3a20 5b66 6c6f 6174 2c20 666c  tion: [float, fl
-00021de0: 6f61 745d 0a20 2020 2020 2020 2078 7368  oat].        xsh
-00021df0: 6966 7420 2620 7973 6869 6674 2069 6e20  ift & yshift in 
-00021e00: 7069 7865 6c73 0a0a 2020 2020 726f 7461  pixels..    rota
-00021e10: 7469 6f6e 3a20 666c 6f61 740a 2020 2020  tion: float.    
-00021e20: 2020 2020 4343 5720 726f 7461 7469 6f6e      CCW rotation
-00021e30: 2028 746f 7761 7264 7320 4561 7374 292c   (towards East),
-00021e40: 2072 6164 6961 6e73 0a0a 2020 2020 7363   radians..    sc
-00021e50: 616c 653a 2066 6c6f 6174 0a20 2020 2020  ale: float.     
-00021e60: 2020 2050 6978 656c 2073 6361 6c65 2066     Pixel scale f
-00021e70: 6163 746f 720a 0a20 2020 2052 6574 7572  actor..    Retur
-00021e80: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00021e90: 2020 206f 7574 5f77 6373 3a20 607e 6173     out_wcs: `~as
-00021ea0: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
-00021eb0: 2020 2020 2020 204d 6f64 6966 6965 6420         Modified 
-00021ec0: 5743 530a 2020 2020 2222 220a 2020 2020  WCS.    """.    
-00021ed0: 6f75 745f 7763 7320 3d20 696e 5f77 6373  out_wcs = in_wcs
-00021ee0: 2e64 6565 7063 6f70 7928 290a 0a20 2020  .deepcopy()..   
-00021ef0: 2023 6f75 745f 7763 732e 7763 732e 6372   #out_wcs.wcs.cr
-00021f00: 7069 7820 2b3d 206e 702e 6172 7261 7928  pix += np.array(
-00021f10: 7472 616e 736c 6174 696f 6e29 0a0a 2020  translation)..  
-00021f20: 2020 2320 436f 6d70 7574 6520 7368 6966    # Compute shif
-00021f30: 7420 666f 7220 6372 7661 6c2c 206e 6f74  t for crval, not
-00021f40: 2063 7270 6978 0a20 2020 2063 7276 616c   crpix.    crval
-00021f50: 203d 2069 6e5f 7763 732e 616c 6c5f 7069   = in_wcs.all_pi
-00021f60: 7832 776f 726c 6428 5b69 6e5f 7763 732e  x2world([in_wcs.
-00021f70: 7763 732e 6372 7069 782d 6e70 2e61 7272  wcs.crpix-np.arr
-00021f80: 6179 2874 7261 6e73 6c61 7469 6f6e 295d  ay(translation)]
-00021f90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021fb0: 2020 2020 2020 2031 292e 666c 6174 7465         1).flatte
-00021fc0: 6e28 290a 0a20 2020 2023 2043 6f6d 7075  n()..    # Compu
-00021fd0: 7465 2073 6869 6674 2061 7420 696d 6167  te shift at imag
-00021fe0: 6520 6365 6e74 6572 0a20 2020 2069 6620  e center.    if 
-00021ff0: 6861 7361 7474 7228 696e 5f77 6373 2c20  hasattr(in_wcs, 
-00022000: 275f 6e61 7869 7331 2729 3a0a 2020 2020  '_naxis1'):.    
-00022010: 2020 2020 7265 6670 6978 203d 206e 702e      refpix = np.
-00022020: 6172 7261 7928 5b69 6e5f 7763 732e 5f6e  array([in_wcs._n
-00022030: 6178 6973 312f 322e 2c20 696e 5f77 6373  axis1/2., in_wcs
-00022040: 2e5f 6e61 7869 7332 2f32 2e5d 290a 2020  ._naxis2/2.]).  
-00022050: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00022060: 7265 6670 6978 203d 206e 702e 6172 7261  refpix = np.arra
-00022070: 7928 696e 5f77 6373 2e5f 6e61 7869 7329  y(in_wcs._naxis)
-00022080: 2f32 2e0a 0a20 2020 2063 3020 3d20 696e  /2...    c0 = in
-00022090: 5f77 6373 2e61 6c6c 5f70 6978 3277 6f72  _wcs.all_pix2wor
-000220a0: 6c64 285b 7265 6670 6978 5d2c 2031 292e  ld([refpix], 1).
-000220b0: 666c 6174 7465 6e28 290a 2020 2020 6331  flatten().    c1
-000220c0: 203d 2069 6e5f 7763 732e 616c 6c5f 7069   = in_wcs.all_pi
-000220d0: 7832 776f 726c 6428 5b72 6566 7069 782d  x2world([refpix-
-000220e0: 6e70 2e61 7272 6179 2874 7261 6e73 6c61  np.array(transla
-000220f0: 7469 6f6e 295d 2c20 3129 2e66 6c61 7474  tion)], 1).flatt
-00022100: 656e 2829 0a0a 2020 2020 6f75 745f 7763  en()..    out_wc
-00022110: 732e 7763 732e 6372 7661 6c20 2b3d 2063  s.wcs.crval += c
-00022120: 312d 6330 0a0a 2020 2020 7468 6574 6120  1-c0..    theta 
-00022130: 3d20 2d72 6f74 6174 696f 6e0a 2020 2020  = -rotation.    
-00022140: 5f6d 6174 203d 206e 702e 6172 7261 7928  _mat = np.array(
-00022150: 5b5b 6e70 2e63 6f73 2874 6865 7461 292c  [[np.cos(theta),
-00022160: 202d 6e70 2e73 696e 2874 6865 7461 295d   -np.sin(theta)]
-00022170: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00022180: 2020 2020 2020 205b 6e70 2e73 696e 2874         [np.sin(t
-00022190: 6865 7461 292c 206e 702e 636f 7328 7468  heta), np.cos(th
-000221a0: 6574 6129 5d5d 290a 0a20 2020 2074 7279  eta)]])..    try
-000221b0: 3a0a 2020 2020 2020 2020 6f75 745f 7763  :.        out_wc
-000221c0: 732e 7763 732e 6364 5b3a 322c 3a32 5d20  s.wcs.cd[:2,:2] 
-000221d0: 3d20 6e70 2e64 6f74 286f 7574 5f77 6373  = np.dot(out_wcs
-000221e0: 2e77 6373 2e63 645b 3a32 2c3a 325d 2c20  .wcs.cd[:2,:2], 
-000221f0: 5f6d 6174 292f 7363 616c 650a 2020 2020  _mat)/scale.    
-00022200: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00022210: 6f75 745f 7763 732e 7763 732e 7063 203d  out_wcs.wcs.pc =
-00022220: 206e 702e 646f 7428 6f75 745f 7763 732e   np.dot(out_wcs.
-00022230: 7763 732e 7063 2c20 5f6d 6174 292f 7363  wcs.pc, _mat)/sc
-00022240: 616c 650a 0a20 2020 206f 7574 5f77 6373  ale..    out_wcs
-00022250: 2e70 7363 616c 6520 3d20 6765 745f 7763  .pscale = get_wc
-00022260: 735f 7073 6361 6c65 286f 7574 5f77 6373  s_pscale(out_wcs
-00022270: 290a 2020 2020 236f 7574 5f77 6373 2e77  ).    #out_wcs.w
-00022280: 6373 2e63 7270 6978 202a 3d20 7363 616c  cs.crpix *= scal
-00022290: 650a 2020 2020 6966 2068 6173 6174 7472  e.    if hasattr
-000222a0: 286f 7574 5f77 6373 2c20 2770 6978 656c  (out_wcs, 'pixel
-000222b0: 5f73 6861 7065 2729 3a0a 2020 2020 2020  _shape'):.      
-000222c0: 2020 5f6e 6178 6973 3120 3d20 696e 7428    _naxis1 = int(
-000222d0: 6e70 2e72 6f75 6e64 286f 7574 5f77 6373  np.round(out_wcs
-000222e0: 2e70 6978 656c 5f73 6861 7065 5b30 5d2a  .pixel_shape[0]*
-000222f0: 7363 616c 6529 290a 2020 2020 2020 2020  scale)).        
-00022300: 5f6e 6178 6973 3220 3d20 696e 7428 6e70  _naxis2 = int(np
-00022310: 2e72 6f75 6e64 286f 7574 5f77 6373 2e70  .round(out_wcs.p
-00022320: 6978 656c 5f73 6861 7065 5b31 5d2a 7363  ixel_shape[1]*sc
-00022330: 616c 6529 290a 2020 2020 2020 2020 6f75  ale)).        ou
-00022340: 745f 7763 732e 5f6e 6178 6973 203d 205b  t_wcs._naxis = [
-00022350: 5f6e 6178 6973 312c 205f 6e61 7869 7332  _naxis1, _naxis2
-00022360: 5d0a 2020 2020 656c 6966 2068 6173 6174  ].    elif hasat
-00022370: 7472 286f 7574 5f77 6373 2c20 275f 6e61  tr(out_wcs, '_na
-00022380: 7869 7331 2729 3a0a 2020 2020 2020 2020  xis1'):.        
-00022390: 6f75 745f 7763 732e 5f6e 6178 6973 3120  out_wcs._naxis1 
-000223a0: 3d20 696e 7428 6e70 2e72 6f75 6e64 286f  = int(np.round(o
-000223b0: 7574 5f77 6373 2e5f 6e61 7869 7331 2a73  ut_wcs._naxis1*s
-000223c0: 6361 6c65 2929 0a20 2020 2020 2020 206f  cale)).        o
-000223d0: 7574 5f77 6373 2e5f 6e61 7869 7332 203d  ut_wcs._naxis2 =
-000223e0: 2069 6e74 286e 702e 726f 756e 6428 6f75   int(np.round(ou
-000223f0: 745f 7763 732e 5f6e 6178 6973 322a 7363  t_wcs._naxis2*sc
-00022400: 616c 6529 290a 0a20 2020 2072 6574 7572  ale))..    retur
-00022410: 6e20 6f75 745f 7763 730a 0a0a 6465 6620  n out_wcs...def 
-00022420: 7369 705f 726f 7439 3028 696e 7075 742c  sip_rot90(input,
-00022430: 2072 6f74 2c20 7265 7665 7273 653d 4661   rot, reverse=Fa
-00022440: 6c73 652c 2076 6572 626f 7365 3d46 616c  lse, verbose=Fal
-00022450: 7365 2c20 636f 6d70 6172 653d 4661 6c73  se, compare=Fals
-00022460: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00022470: 526f 7461 7465 2061 2053 4950 2057 4353  Rotate a SIP WCS
-00022480: 2062 7920 696e 6372 656d 656e 7473 206f   by increments o
-00022490: 6620 3930 2064 6567 7265 6573 2075 7369  f 90 degrees usi
-000224a0: 6e67 2064 6972 6563 7420 7472 616e 7366  ng direct transf
-000224b0: 6f72 6d61 7469 6f6e 730a 2020 2020 6265  ormations.    be
-000224c0: 7477 6565 6e20 7820 2f20 7920 636f 6f72  tween x / y coor
-000224d0: 6469 6e61 7465 730a 2020 2020 0a20 2020  dinates.    .   
-000224e0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-000224f0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069  ----------.    i
-00022500: 6e70 7574 203a 2060 7e61 7374 726f 7079  nput : `~astropy
-00022510: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00022520: 206f 7220 607e 6173 7472 6f70 792e 7763   or `~astropy.wc
-00022530: 732e 5743 5360 0a20 2020 2020 2020 2048  s.WCS`.        H
-00022540: 6561 6465 7220 6f72 2057 4353 0a20 2020  eader or WCS.   
-00022550: 200a 2020 2020 726f 7420 3a20 696e 740a   .    rot : int.
-00022560: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
-00022570: 6620 7469 6d65 7320 746f 2072 6f74 6174  f times to rotat
-00022580: 6520 7468 6520 5743 5320 3930 2064 6567  e the WCS 90 deg
-00022590: 7265 6573 202a 636c 6f63 6b77 6973 652a  rees *clockwise*
-000225a0: 2c20 616e 616c 6f67 6f75 730a 2020 2020  , analogous.    
-000225b0: 2020 2020 746f 2060 6e75 6d70 792e 726f      to `numpy.ro
-000225c0: 7439 3060 0a20 2020 200a 2020 2020 7265  t90`.    .    re
-000225d0: 7665 7273 6520 3a20 626f 6f6c 0a20 2020  verse : bool.   
-000225e0: 2020 2020 2049 6620 6069 6e70 7574 6020       If `input` 
-000225f0: 6973 2061 2068 6561 6465 7220 616e 6420  is a header and 
-00022600: 696e 636c 7564 6573 2061 206b 6579 776f  includes a keywo
-00022610: 7264 2060 6052 4f54 3930 6060 2c20 7468  rd ``ROT90``, th
-00022620: 656e 2075 6e64 6f20 0a20 2020 2020 2020  en undo .       
-00022630: 2074 6865 2072 6f74 6174 696f 6e20 616e   the rotation an
-00022640: 6420 7265 6d6f 7665 2074 6865 206b 6579  d remove the key
-00022650: 776f 7264 2066 726f 6d20 7468 6520 6f75  word from the ou
-00022660: 7470 7574 2068 6561 6465 720a 2020 2020  tput header.    
-00022670: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
-00022680: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00022690: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
-000226a0: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-000226b0: 6572 600a 2020 2020 2020 2020 526f 7461  er`.        Rota
-000226c0: 7465 6420 5743 5320 6865 6164 6572 0a20  ted WCS header. 
-000226d0: 2020 2020 2020 200a 2020 2020 7763 7320         .    wcs 
-000226e0: 3a20 607e 6173 7472 6f70 792e 7763 732e  : `~astropy.wcs.
-000226f0: 5743 5360 0a20 2020 2020 2020 2052 6f74  WCS`.        Rot
-00022700: 6174 6564 2057 4353 0a20 2020 200a 2020  ated WCS.    .  
-00022710: 2020 6465 7363 203a 2073 7472 0a20 2020    desc : str.   
-00022720: 2020 2020 2044 6573 6372 6970 7469 6f6e       Description
-00022730: 206f 6620 7468 6520 7472 616e 7366 6f72   of the transfor
-00022740: 6d20 6173 736f 6369 6174 6564 2077 6974  m associated wit
-00022750: 6820 6060 726f 7460 602c 2065 2e67 2c20  h ``rot``, e.g, 
-00022760: 0a20 2020 2020 2020 2060 6078 3d6e 782d  .        ``x=nx-
-00022770: 782c 2079 3d6e 792d 7960 6020 666f 7220  x, y=ny-y`` for 
-00022780: 6060 726f 743d c2b1 3260 602e 0a20 2020  ``rot=..2``..   
-00022790: 2020 2020 200a 2020 2020 2222 220a 2020       .    """.  
-000227a0: 2020 696d 706f 7274 2063 6f70 790a 2020    import copy.  
-000227b0: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
-000227c0: 2e69 6f2e 6669 7473 0a20 2020 2069 6d70  .io.fits.    imp
-000227d0: 6f72 7420 6173 7472 6f70 792e 7763 730a  ort astropy.wcs.
-000227e0: 2020 2020 696d 706f 7274 206d 6174 706c      import matpl
-000227f0: 6f74 6c69 622e 7079 706c 6f74 2061 7320  otlib.pyplot as 
-00022800: 706c 740a 2020 2020 0a20 2020 2069 6620  plt.    .    if 
-00022810: 6973 696e 7374 616e 6365 2869 6e70 7574  isinstance(input
-00022820: 2c20 6173 7472 6f70 792e 696f 2e66 6974  , astropy.io.fit
-00022830: 732e 4865 6164 6572 293a 0a20 2020 2020  s.Header):.     
-00022840: 2020 206f 7269 6720 3d20 636f 7079 2e64     orig = copy.d
-00022850: 6565 7063 6f70 7928 696e 7075 7429 0a20  eepcopy(input). 
-00022860: 2020 2020 2020 206e 6577 203d 2063 6f70         new = cop
-00022870: 792e 6465 6570 636f 7079 2869 6e70 7574  y.deepcopy(input
-00022880: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-00022890: 2020 2069 6620 2827 524f 5439 3027 2069     if ('ROT90' i
-000228a0: 6e20 696e 7075 7429 3a0a 2020 2020 2020  n input):.      
-000228b0: 2020 2020 2020 6966 2072 6576 6572 7365        if reverse
-000228c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000228d0: 2020 726f 7420 3d20 2d6f 7269 675b 2752    rot = -orig['R
-000228e0: 4f54 3930 275d 0a20 2020 2020 2020 2020  OT90'].         
-000228f0: 2020 2020 2020 206e 6577 2e72 656d 6f76         new.remov
-00022900: 6528 2752 4f54 3930 2729 0a20 2020 2020  e('ROT90').     
-00022910: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00022920: 2020 2020 2020 2020 2020 2020 206e 6577               new
-00022930: 5b27 524f 5439 3027 5d20 3d20 6f72 6967  ['ROT90'] = orig
-00022940: 5b27 524f 5439 3027 5d20 2b20 726f 740a  ['ROT90'] + rot.
-00022950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00022960: 2020 2020 2020 2020 2020 6e65 775b 2752            new['R
-00022970: 4f54 3930 275d 203d 2072 6f74 0a20 2020  OT90'] = rot.   
-00022980: 2065 6c73 653a 0a20 2020 2020 2020 206f   else:.        o
-00022990: 7269 6720 3d20 746f 5f68 6561 6465 7228  rig = to_header(
-000229a0: 696e 7075 7429 0a20 2020 2020 2020 206e  input).        n
-000229b0: 6577 203d 2074 6f5f 6865 6164 6572 2869  ew = to_header(i
-000229c0: 6e70 7574 290a 0a20 2020 206f 7269 675f  nput)..    orig_
-000229d0: 7763 7320 3d20 7079 7763 732e 5743 5328  wcs = pywcs.WCS(
-000229e0: 6f72 6967 2c20 7265 6c61 783d 5472 7565  orig, relax=True
-000229f0: 290a 0a20 2020 2023 2323 2043 4420 3d20  )..    ### CD = 
-00022a00: 5b5b 6472 612f 6478 2c20 6472 612f 6479  [[dra/dx, dra/dy
-00022a10: 5d2c 205b 6464 652f 6478 2c20 6464 652f  ], [dde/dx, dde/
-00022a20: 6479 5d5d 0a20 2020 2023 2323 2078 203d  dy]].    ### x =
-00022a30: 2061 5f69 5f6a 202a 2075 2a2a 6920 2a20   a_i_j * u**i * 
-00022a40: 762a 2a6a 0a20 2020 2023 2323 2079 203d  v**j.    ### y =
-00022a50: 2062 5f69 5f6a 202a 2075 2a2a 6920 2a20   b_i_j * u**i * 
-00022a60: 762a 2a6a 0a20 2020 200a 2020 2020 6978  v**j.    .    ix
-00022a70: 203d 2031 0a20 2020 200a 2020 2020 6966   = 1.    .    if
-00022a80: 2063 6f6d 7061 7265 3a0a 2020 2020 2020   compare:.      
-00022a90: 2020 7861 7272 203d 206e 702e 6172 616e    xarr = np.aran
-00022aa0: 6765 2830 2c32 3034 382c 3634 290a 2020  ge(0,2048,64).  
-00022ab0: 2020 2020 2020 7870 2c20 7970 203d 206e        xp, yp = n
-00022ac0: 702e 6d65 7368 6772 6964 2878 6172 722c  p.meshgrid(xarr,
-00022ad0: 2078 6172 7229 0a20 2020 2020 2020 2072   xarr).        r
-00022ae0: 6420 3d20 6f72 6967 5f77 6373 2e61 6c6c  d = orig_wcs.all
-00022af0: 5f70 6978 3277 6f72 6c64 2878 702c 2079  _pix2world(xp, y
-00022b00: 702c 2069 7829 0a0a 2020 2020 6966 2072  p, ix)..    if r
-00022b10: 6f74 2025 2034 203d 3d20 313a 0a20 2020  ot % 4 == 1:.   
-00022b20: 2020 2020 2023 2043 5720 3930 2064 6567       # CW 90 deg
-00022b30: 203a 2078 203d 2079 2c20 7920 3d20 286e   : x = y, y = (n
-00022b40: 7820 2d20 7829 2c20 753d 762c 2076 3d2d  x - x), u=v, v=-
-00022b50: 750a 2020 2020 2020 2020 6465 7363 203d  u.        desc =
-00022b60: 2027 783d 792c 2079 3d6e 782d 7827 0a20   'x=y, y=nx-x'. 
-00022b70: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00022b80: 6e65 775b 2743 5250 4958 3127 5d20 3d20  new['CRPIX1'] = 
-00022b90: 6f72 6967 5b27 4352 5049 5832 275d 0a20  orig['CRPIX2']. 
-00022ba0: 2020 2020 2020 206e 6577 5b27 4352 5049         new['CRPI
-00022bb0: 5832 275d 203d 206f 7269 675b 274e 4158  X2'] = orig['NAX
-00022bc0: 4953 3127 5d20 2d20 6f72 6967 5b27 4352  IS1'] - orig['CR
-00022bd0: 5049 5831 275d 202b 2031 0a0a 2020 2020  PIX1'] + 1..    
-00022be0: 2020 2020 6e65 775b 2743 4431 5f31 275d      new['CD1_1']
-00022bf0: 203d 206f 7269 675b 2743 4431 5f32 275d   = orig['CD1_2']
-00022c00: 0a20 2020 2020 2020 206e 6577 5b27 4344  .        new['CD
-00022c10: 315f 3227 5d20 3d20 2d6f 7269 675b 2743  1_2'] = -orig['C
-00022c20: 4431 5f31 275d 0a20 2020 2020 2020 206e  D1_1'].        n
-00022c30: 6577 5b27 4344 325f 3127 5d20 3d20 6f72  ew['CD2_1'] = or
-00022c40: 6967 5b27 4344 325f 3227 5d0a 2020 2020  ig['CD2_2'].    
-00022c50: 2020 2020 6e65 775b 2743 4432 5f32 275d      new['CD2_2']
-00022c60: 203d 202d 6f72 6967 5b27 4344 325f 3127   = -orig['CD2_1'
-00022c70: 5d0a 0a20 2020 2020 2020 2066 6f72 2069  ]..        for i
-00022c80: 2069 6e20 7261 6e67 6528 6e65 775b 2741   in range(new['A
-00022c90: 5f4f 5244 4552 275d 2b31 293a 0a20 2020  _ORDER']+1):.   
-00022ca0: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
-00022cb0: 6e20 7261 6e67 6528 6e65 775b 2742 5f4f  n range(new['B_O
-00022cc0: 5244 4552 275d 2b31 293a 0a20 2020 2020  RDER']+1):.     
-00022cd0: 2020 2020 2020 2020 2020 2041 696a 2020             Aij  
-00022ce0: 3d20 6627 415f 7b69 7d5f 7b6a 7d27 0a20  = f'A_{i}_{j}'. 
-00022cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00022d00: 6620 4169 6a20 6e6f 7420 696e 206e 6577  f Aij not in new
-00022d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00022d20: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d40: 6e65 775b 6627 415f 7b69 7d5f 7b6a 7d27  new[f'A_{i}_{j}'
-00022d50: 5d20 3d20 6f72 6967 5b66 2742 5f7b 6a7d  ] = orig[f'B_{j}
-00022d60: 5f7b 697d 275d 2a28 2d31 292a 2a6a 0a20  _{i}']*(-1)**j. 
-00022d70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00022d80: 6577 5b66 2742 5f7b 697d 5f7b 6a7d 275d  ew[f'B_{i}_{j}']
-00022d90: 203d 206f 7269 675b 6627 415f 7b6a 7d5f   = orig[f'A_{j}_
-00022da0: 7b69 7d27 5d2a 282d 3129 2a2a 6a2a 2d31  {i}']*(-1)**j*-1
-00022db0: 0a0a 2020 2020 2020 2020 6e65 775f 7763  ..        new_wc
-00022dc0: 7320 3d20 6173 7472 6f70 792e 7763 732e  s = astropy.wcs.
-00022dd0: 5743 5328 6e65 772c 2072 656c 6178 3d54  WCS(new, relax=T
-00022de0: 7275 6529 0a20 2020 2020 2020 200a 2020  rue).        .  
-00022df0: 2020 2020 2020 6966 2063 6f6d 7061 7265        if compare
-00022e00: 3a0a 2020 2020 2020 2020 2020 2020 7872  :.            xr
-00022e10: 2c20 7972 203d 206e 6577 5f77 6373 2e61  , yr = new_wcs.a
-00022e20: 6c6c 5f77 6f72 6c64 3270 6978 282a 7264  ll_world2pix(*rd
-00022e30: 2c20 6978 290a 2020 2020 2020 2020 2020  , ix).          
-00022e40: 2020 786f 203d 2079 700a 2020 2020 2020    xo = yp.      
-00022e50: 2020 2020 2020 796f 203d 206f 7269 675b        yo = orig[
-00022e60: 274e 4158 4953 3127 5d20 2d20 7870 0a0a  'NAXIS1'] - xp..
-00022e70: 2020 2020 656c 6966 2072 6f74 2025 2034      elif rot % 4
-00022e80: 203d 3d20 333a 0a20 2020 2020 2020 2023   == 3:.        #
-00022e90: 2043 5720 3237 3020 6465 6720 3a20 7920   CW 270 deg : y 
-00022ea0: 3d20 782c 2078 203d 2028 6e79 202d 2075  = x, x = (ny - u
-00022eb0: 292c 2075 3d2d 762c 2076 3d75 0a20 2020  ), u=-v, v=u.   
-00022ec0: 2020 2020 2064 6573 6320 3d20 2778 3d6e       desc = 'x=n
-00022ed0: 792d 792c 2079 3d78 270a 0a20 2020 2020  y-y, y=x'..     
-00022ee0: 2020 206e 6577 5b27 4352 5049 5831 275d     new['CRPIX1']
-00022ef0: 203d 206f 7269 675b 274e 4158 4953 3227   = orig['NAXIS2'
-00022f00: 5d20 2d20 6f72 6967 5b27 4352 5049 5832  ] - orig['CRPIX2
-00022f10: 275d 202b 2031 0a20 2020 2020 2020 206e  '] + 1.        n
-00022f20: 6577 5b27 4352 5049 5832 275d 203d 206f  ew['CRPIX2'] = o
-00022f30: 7269 675b 2743 5250 4958 3127 5d0a 0a20  rig['CRPIX1'].. 
-00022f40: 2020 2020 2020 206e 6577 5b27 4344 315f         new['CD1_
-00022f50: 3127 5d20 3d20 2d6f 7269 675b 2743 4431  1'] = -orig['CD1
-00022f60: 5f32 275d 0a20 2020 2020 2020 206e 6577  _2'].        new
-00022f70: 5b27 4344 315f 3227 5d20 3d20 6f72 6967  ['CD1_2'] = orig
-00022f80: 5b27 4344 315f 3127 5d0a 2020 2020 2020  ['CD1_1'].      
-00022f90: 2020 6e65 775b 2743 4432 5f31 275d 203d    new['CD2_1'] =
-00022fa0: 202d 6f72 6967 5b27 4344 325f 3227 5d0a   -orig['CD2_2'].
-00022fb0: 2020 2020 2020 2020 6e65 775b 2743 4432          new['CD2
-00022fc0: 5f32 275d 203d 206f 7269 675b 2743 4432  _2'] = orig['CD2
-00022fd0: 5f31 275d 0a0a 2020 2020 2020 2020 666f  _1']..        fo
-00022fe0: 7220 6920 696e 2072 616e 6765 286e 6577  r i in range(new
-00022ff0: 5b27 415f 4f52 4445 5227 5d2b 3129 3a0a  ['A_ORDER']+1):.
-00023000: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00023010: 6a20 696e 2072 616e 6765 286e 6577 5b27  j in range(new['
-00023020: 425f 4f52 4445 5227 5d2b 3129 3a0a 2020  B_ORDER']+1):.  
-00023030: 2020 2020 2020 2020 2020 2020 2020 4169                Ai
-00023040: 6a20 203d 2066 2741 5f7b 697d 5f7b 6a7d  j  = f'A_{i}_{j}
-00023050: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00023060: 2020 6966 2041 696a 206e 6f74 2069 6e20    if Aij not in 
-00023070: 6e65 773a 0a20 2020 2020 2020 2020 2020  new:.           
-00023080: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00023090: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-000230a0: 2020 206e 6577 5b66 2741 5f7b 697d 5f7b     new[f'A_{i}_{
-000230b0: 6a7d 275d 203d 206f 7269 675b 6627 425f  j}'] = orig[f'B_
-000230c0: 7b6a 7d5f 7b69 7d27 5d2a 282d 3129 2a2a  {j}_{i}']*(-1)**
-000230d0: 692a 2d31 0a20 2020 2020 2020 2020 2020  i*-1.           
-000230e0: 2020 2020 206e 6577 5b66 2742 5f7b 697d       new[f'B_{i}
-000230f0: 5f7b 6a7d 275d 203d 206f 7269 675b 6627  _{j}'] = orig[f'
-00023100: 415f 7b6a 7d5f 7b69 7d27 5d2a 282d 3129  A_{j}_{i}']*(-1)
-00023110: 2a2a 690a 0a20 2020 2020 2020 206e 6577  **i..        new
-00023120: 5f77 6373 203d 2061 7374 726f 7079 2e77  _wcs = astropy.w
-00023130: 6373 2e57 4353 286e 6577 2c20 7265 6c61  cs.WCS(new, rela
-00023140: 783d 5472 7565 290a 2020 2020 2020 2020  x=True).        
-00023150: 0a20 2020 2020 2020 2069 6620 636f 6d70  .        if comp
-00023160: 6172 653a 0a20 2020 2020 2020 2020 2020  are:.           
-00023170: 2078 722c 2079 7220 3d20 6e65 775f 7763   xr, yr = new_wc
-00023180: 732e 616c 6c5f 776f 726c 6432 7069 7828  s.all_world2pix(
-00023190: 2a72 642c 2069 7829 0a20 2020 2020 2020  *rd, ix).       
-000231a0: 2020 2020 2078 6f20 3d20 6f72 6967 5b27       xo = orig['
-000231b0: 4e41 5849 5332 275d 202d 2079 700a 2020  NAXIS2'] - yp.  
-000231c0: 2020 2020 2020 2020 2020 796f 203d 2078            yo = x
-000231d0: 700a 0a0a 2020 2020 656c 6966 2072 6f74  p...    elif rot
-000231e0: 2025 2034 203d 3d20 323a 0a20 2020 2020   % 4 == 2:.     
-000231f0: 2020 2023 2043 5720 3138 3020 6465 6720     # CW 180 deg 
-00023200: 3a20 783d 6e78 2d78 2c20 793d 6e79 2d79  : x=nx-x, y=ny-y
-00023210: 2c20 753d 2d75 2c20 763d 2d76 0a20 2020  , u=-u, v=-v.   
-00023220: 2020 2020 2064 6573 6320 3d20 2778 3d6e       desc = 'x=n
-00023230: 782d 782c 2079 3d6e 792d 7927 0a0a 2020  x-x, y=ny-y'..  
-00023240: 2020 2020 2020 6e65 775b 2743 5250 4958        new['CRPIX
-00023250: 3127 5d20 3d20 6f72 6967 5b27 4e41 5849  1'] = orig['NAXI
-00023260: 5331 275d 202d 206f 7269 675b 2743 5250  S1'] - orig['CRP
-00023270: 4958 3127 5d20 2b20 310a 2020 2020 2020  IX1'] + 1.      
-00023280: 2020 6e65 775b 2743 5250 4958 3227 5d20    new['CRPIX2'] 
-00023290: 3d20 6f72 6967 5b27 4e41 5849 5332 275d  = orig['NAXIS2']
-000232a0: 202d 206f 7269 675b 2743 5250 4958 3227   - orig['CRPIX2'
-000232b0: 5d20 2b20 310a 0a20 2020 2020 2020 206e  ] + 1..        n
-000232c0: 6577 5b27 4344 315f 3127 5d20 3d20 2d6f  ew['CD1_1'] = -o
-000232d0: 7269 675b 2743 4431 5f31 275d 0a20 2020  rig['CD1_1'].   
-000232e0: 2020 2020 206e 6577 5b27 4344 315f 3227       new['CD1_2'
-000232f0: 5d20 3d20 2d6f 7269 675b 2743 4431 5f32  ] = -orig['CD1_2
-00023300: 275d 0a20 2020 2020 2020 206e 6577 5b27  '].        new['
-00023310: 4344 325f 3127 5d20 3d20 2d6f 7269 675b  CD2_1'] = -orig[
-00023320: 2743 4432 5f31 275d 0a20 2020 2020 2020  'CD2_1'].       
-00023330: 206e 6577 5b27 4344 325f 3227 5d20 3d20   new['CD2_2'] = 
-00023340: 2d6f 7269 675b 2743 4432 5f32 275d 0a0a  -orig['CD2_2']..
-00023350: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00023360: 2072 616e 6765 286e 6577 5b27 415f 4f52   range(new['A_OR
-00023370: 4445 5227 5d2b 3129 3a0a 2020 2020 2020  DER']+1):.      
-00023380: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
-00023390: 616e 6765 286e 6577 5b27 425f 4f52 4445  ange(new['B_ORDE
-000233a0: 5227 5d2b 3129 3a0a 2020 2020 2020 2020  R']+1):.        
-000233b0: 2020 2020 2020 2020 4169 6a20 203d 2066          Aij  = f
-000233c0: 2741 5f7b 697d 5f7b 6a7d 270a 2020 2020  'A_{i}_{j}'.    
-000233d0: 2020 2020 2020 2020 2020 2020 6966 2041              if A
-000233e0: 696a 206e 6f74 2069 6e20 6e65 773a 0a20  ij not in new:. 
-000233f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023400: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00023410: 2020 2020 2020 2020 2020 2020 206e 6577               new
-00023420: 5b66 2741 5f7b 697d 5f7b 6a7d 275d 203d  [f'A_{i}_{j}'] =
-00023430: 206f 7269 675b 6627 415f 7b69 7d5f 7b6a   orig[f'A_{i}_{j
-00023440: 7d27 5d2a 282d 3129 2a2a 6a2a 282d 3129  }']*(-1)**j*(-1)
-00023450: 2a2a 692a 2d31 0a20 2020 2020 2020 2020  **i*-1.         
-00023460: 2020 2020 2020 206e 6577 5b66 2742 5f7b         new[f'B_{
-00023470: 697d 5f7b 6a7d 275d 203d 206f 7269 675b  i}_{j}'] = orig[
-00023480: 6627 425f 7b69 7d5f 7b6a 7d27 5d2a 282d  f'B_{i}_{j}']*(-
-00023490: 3129 2a2a 6a2a 282d 3129 2a2a 692a 2d31  1)**j*(-1)**i*-1
-000234a0: 0a0a 2020 2020 2020 2020 6e65 775f 7763  ..        new_wc
-000234b0: 7320 3d20 6173 7472 6f70 792e 7763 732e  s = astropy.wcs.
-000234c0: 5743 5328 6e65 772c 2072 656c 6178 3d54  WCS(new, relax=T
-000234d0: 7275 6529 0a20 2020 2020 2020 200a 2020  rue).        .  
-000234e0: 2020 2020 2020 6966 2063 6f6d 7061 7265        if compare
-000234f0: 3a0a 2020 2020 2020 2020 2020 2020 7872  :.            xr
-00023500: 2c20 7972 203d 206e 6577 5f77 6373 2e61  , yr = new_wcs.a
-00023510: 6c6c 5f77 6f72 6c64 3270 6978 282a 7264  ll_world2pix(*rd
-00023520: 2c20 6978 290a 2020 2020 2020 2020 2020  , ix).          
-00023530: 2020 786f 203d 206f 7269 675b 274e 4158    xo = orig['NAX
-00023540: 4953 3127 5d20 2d20 7870 0a20 2020 2020  IS1'] - xp.     
-00023550: 2020 2020 2020 2079 6f20 3d20 6f72 6967         yo = orig
-00023560: 5b27 4e41 5849 5332 275d 202d 2079 700a  ['NAXIS2'] - yp.
-00023570: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023580: 2020 2320 726f 743d 302c 2064 6f20 6e6f    # rot=0, do no
-00023590: 7468 696e 670a 2020 2020 2020 2020 6465  thing.        de
-000235a0: 7363 203d 2027 783d 782c 2079 3d79 270a  sc = 'x=x, y=y'.
-000235b0: 2020 2020 2020 2020 6e65 775f 7763 7320          new_wcs 
-000235c0: 3d20 6f72 6967 5f77 6373 0a20 2020 2020  = orig_wcs.     
-000235d0: 2020 2069 6620 636f 6d70 6172 653a 0a20     if compare:. 
-000235e0: 2020 2020 2020 2020 2020 2078 6f20 3d20             xo = 
-000235f0: 7870 0a20 2020 2020 2020 2020 2020 2079  xp.            y
-00023600: 6f20 3d20 7970 0a20 2020 2020 2020 2020  o = yp.         
-00023610: 2020 2078 722c 2079 7220 3d20 6e65 775f     xr, yr = new_
-00023620: 7763 732e 616c 6c5f 776f 726c 6432 7069  wcs.all_world2pi
-00023630: 7828 2a72 642c 2069 7829 0a20 2020 2020  x(*rd, ix).     
-00023640: 2020 200a 2020 2020 6966 2076 6572 626f     .    if verbo
-00023650: 7365 3a0a 2020 2020 2020 2020 6966 2063  se:.        if c
-00023660: 6f6d 7061 7265 3a0a 2020 2020 2020 2020  ompare:.        
-00023670: 2020 2020 7872 6d73 203d 206e 6d61 6428      xrms = nmad(
-00023680: 7872 2d78 6f29 0a20 2020 2020 2020 2020  xr-xo).         
-00023690: 2020 2079 726d 7320 3d20 6e6d 6164 2879     yrms = nmad(y
-000236a0: 722d 796f 290a 2020 2020 2020 2020 2020  r-yo).          
-000236b0: 2020 7072 696e 7428 6627 526f 7439 303a    print(f'Rot90:
-000236c0: 207b 726f 747d 2072 6d73 3d7b 7872 6d73   {rot} rms={xrms
-000236d0: 3a2e 3265 7d20 7b79 726d 733a 2e32 657d  :.2e} {yrms:.2e}
-000236e0: 2729 0a20 2020 2020 2020 2020 2020 200a  ').            .
-000236f0: 2020 2020 6966 2063 6f6d 7061 7265 3a0a      if compare:.
-00023700: 2020 2020 2020 2020 6669 672c 2061 7865          fig, axe
-00023710: 7320 3d20 706c 742e 7375 6270 6c6f 7473  s = plt.subplots
-00023720: 2831 2c32 2c66 6967 7369 7a65 3d28 3130  (1,2,figsize=(10
-00023730: 2c35 292c 2073 6861 7265 783d 5472 7565  ,5), sharex=True
-00023740: 2c20 7368 6172 6579 3d54 7275 6529 0a20  , sharey=True). 
-00023750: 2020 2020 2020 2061 7865 735b 305d 2e73         axes[0].s
-00023760: 6361 7474 6572 2878 702c 2078 722d 786f  catter(xp, xr-xo
-00023770: 290a 2020 2020 2020 2020 6178 6573 5b30  ).        axes[0
-00023780: 5d2e 7365 745f 786c 6162 656c 2827 6478  ].set_xlabel('dx
-00023790: 2729 0a20 2020 2020 2020 2061 7865 735b  ').        axes[
-000237a0: 315d 2e73 6361 7474 6572 2879 702c 2079  1].scatter(yp, y
-000237b0: 722d 796f 290a 2020 2020 2020 2020 6178  r-yo).        ax
-000237c0: 6573 5b31 5d2e 7365 745f 786c 6162 656c  es[1].set_xlabel
-000237d0: 2827 6479 2729 0a20 2020 2020 2020 2066  ('dy').        f
-000237e0: 6f72 2061 7820 696e 2061 7865 733a 0a20  or ax in axes:. 
-000237f0: 2020 2020 2020 2020 2020 2061 782e 6772             ax.gr
-00023800: 6964 2829 0a20 2020 2020 2020 200a 2020  id().        .  
-00023810: 2020 2020 2020 6669 672e 7469 6768 745f        fig.tight_
-00023820: 6c61 796f 7574 2870 6164 3d30 2e35 290a  layout(pad=0.5).
-00023830: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
-00023840: 6e65 772c 206e 6577 5f77 6373 2c20 6465  new, new_wcs, de
-00023850: 7363 0a0a 0a64 6566 2067 6574 5f77 6373  sc...def get_wcs
-00023860: 5f73 6c69 6365 5f68 6561 6465 7228 7763  _slice_header(wc
-00023870: 732c 2073 6c78 2c20 736c 7929 3a0a 2020  s, slx, sly):.  
-00023880: 2020 2222 2254 4244 0a20 2020 2022 2222    """TBD.    """
-00023890: 0a20 2020 2023 736c 782c 2073 6c79 203d  .    #slx, sly =
-000238a0: 2073 6c69 6365 2831 3237 392c 2031 3434   slice(1279, 144
-000238b0: 3529 2c20 736c 6963 6528 3236 3635 2c32  5), slice(2665,2
-000238c0: 3831 3329 0a20 2020 2068 203d 2077 6373  813).    h = wcs
-000238d0: 2e73 6c69 6365 2828 736c 792c 2073 6c78  .slice((sly, slx
-000238e0: 2929 2e74 6f5f 6865 6164 6572 2872 656c  )).to_header(rel
-000238f0: 6178 3d54 7275 6529 0a20 2020 2068 5b27  ax=True).    h['
-00023900: 4e41 5849 5327 5d20 3d20 320a 2020 2020  NAXIS'] = 2.    
-00023910: 685b 274e 4158 4953 3127 5d20 3d20 736c  h['NAXIS1'] = sl
-00023920: 782e 7374 6f70 2d73 6c78 2e73 7461 7274  x.stop-slx.start
-00023930: 0a20 2020 2068 5b27 4e41 5849 5332 275d  .    h['NAXIS2']
-00023940: 203d 2073 6c79 2e73 746f 702d 736c 792e   = sly.stop-sly.
-00023950: 7374 6172 740a 2020 2020 666f 7220 6b20  start.    for k 
-00023960: 696e 2068 3a0a 2020 2020 2020 2020 6966  in h:.        if
-00023970: 206b 2e73 7461 7274 7377 6974 6828 2750   k.startswith('P
-00023980: 4327 293a 0a20 2020 2020 2020 2020 2020  C'):.           
-00023990: 2068 2e72 656e 616d 655f 6b65 7977 6f72   h.rename_keywor
-000239a0: 6428 6b2c 206b 2e72 6570 6c61 6365 2827  d(k, k.replace('
-000239b0: 5043 272c 2027 4344 2729 290a 0a20 2020  PC', 'CD'))..   
-000239c0: 2072 6574 7572 6e20 680a 0a0a 6465 6620   return h...def 
-000239d0: 6765 745f 636f 6d6d 6f6e 5f73 6c69 6365  get_common_slice
-000239e0: 7328 615f 6f72 6967 696e 2c20 615f 7368  s(a_origin, a_sh
-000239f0: 6170 652c 2062 5f6f 7269 6769 6e2c 2062  ape, b_origin, b
-00023a00: 5f73 6861 7065 293a 0a20 2020 2022 2222  _shape):.    """
-00023a10: 0a20 2020 2047 6574 2073 6c69 6365 7320  .    Get slices 
-00023a20: 6f66 206f 7665 726c 6170 7320 6265 7477  of overlaps betw
-00023a30: 6565 6e20 7477 6f20 7265 6374 616e 6775  een two rectangu
-00023a40: 6c61 7220 6772 6964 730a 2020 2020 2222  lar grids.    ""
-00023a50: 220a 0a20 2020 206c 6c20 3d20 6e70 2e6d  "..    ll = np.m
-00023a60: 696e 285b 615f 6f72 6967 696e 2c20 625f  in([a_origin, b_
-00023a70: 6f72 6967 696e 5d2c 2061 7869 733d 3029  origin], axis=0)
-00023a80: 0a20 2020 2075 7220 3d20 6e70 2e6d 6178  .    ur = np.max
-00023a90: 285b 615f 6f72 6967 696e 2b61 5f73 6861  ([a_origin+a_sha
-00023aa0: 7065 2c20 625f 6f72 6967 696e 2b62 5f73  pe, b_origin+b_s
-00023ab0: 6861 7065 5d2c 2061 7869 733d 3029 0a0a  hape], axis=0)..
-00023ac0: 2020 2020 2320 6f74 6865 7220 696e 2073      # other in s
-00023ad0: 656c 660a 2020 2020 6c6c 7320 3d20 6e70  elf.    lls = np
-00023ae0: 2e6d 696e 696d 756d 2862 5f6f 7269 6769  .minimum(b_origi
-00023af0: 6e20 2d20 6c6c 2c20 615f 7368 6170 6529  n - ll, a_shape)
-00023b00: 0a20 2020 2075 7273 203d 206e 702e 636c  .    urs = np.cl
-00023b10: 6970 2862 5f6f 7269 6769 6e20 2b20 625f  ip(b_origin + b_
-00023b20: 7368 6170 6520 2d20 615f 6f72 6967 696e  shape - a_origin
-00023b30: 2c20 5b30 2c20 305d 2c20 615f 7368 6170  , [0, 0], a_shap
-00023b40: 6529 0a0a 2020 2020 2320 7365 6c66 2069  e)..    # self i
-00023b50: 6e20 6f74 6865 720a 2020 2020 6c6c 6f20  n other.    llo 
-00023b60: 3d20 6e70 2e6d 696e 696d 756d 2861 5f6f  = np.minimum(a_o
-00023b70: 7269 6769 6e20 2d20 6c6c 2c20 625f 7368  rigin - ll, b_sh
-00023b80: 6170 6529 0a20 2020 2075 726f 203d 206e  ape).    uro = n
-00023b90: 702e 636c 6970 2861 5f6f 7269 6769 6e20  p.clip(a_origin 
-00023ba0: 2b20 615f 7368 6170 6520 2d20 625f 6f72  + a_shape - b_or
-00023bb0: 6967 696e 2c20 5b30 2c20 305d 2c20 625f  igin, [0, 0], b_
-00023bc0: 7368 6170 6529 0a0a 2020 2020 615f 736c  shape)..    a_sl
-00023bd0: 6963 6520 3d20 2873 6c69 6365 286c 6c73  ice = (slice(lls
-00023be0: 5b30 5d2c 2075 7273 5b30 5d29 2c20 736c  [0], urs[0]), sl
-00023bf0: 6963 6528 6c6c 735b 315d 2c20 7572 735b  ice(lls[1], urs[
-00023c00: 315d 2929 0a20 2020 2062 5f73 6c69 6365  1])).    b_slice
-00023c10: 203d 2028 736c 6963 6528 6c6c 6f5b 305d   = (slice(llo[0]
-00023c20: 2c20 7572 6f5b 305d 292c 2073 6c69 6365  , uro[0]), slice
-00023c30: 286c 6c6f 5b31 5d2c 2075 726f 5b31 5d29  (llo[1], uro[1])
-00023c40: 290a 2020 2020 7265 7475 726e 2061 5f73  ).    return a_s
-00023c50: 6c69 6365 2c20 625f 736c 6963 650a 0a0a  lice, b_slice...
-00023c60: 636c 6173 7320 5743 5346 6f6f 7470 7269  class WCSFootpri
-00023c70: 6e74 286f 626a 6563 7429 3a0a 2020 2020  nt(object):.    
-00023c80: 2222 220a 2020 2020 4865 6c70 6572 2066  """.    Helper f
-00023c90: 756e 6374 696f 6e73 2066 6f72 2064 6561  unctions for dea
-00023ca0: 6c69 6e67 2077 6974 6820 5743 5320 666f  ling with WCS fo
-00023cb0: 6f74 7072 696e 7473 0a20 2020 2022 2222  otprints.    """
-00023cc0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00023cd0: 5f5f 2873 656c 662c 2077 6373 2c20 6578  __(self, wcs, ex
-00023ce0: 743d 312c 206c 6162 656c 3d4e 6f6e 6529  t=1, label=None)
-00023cf0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00023d00: 6e73 7461 6e63 6528 7763 732c 2070 7977  nstance(wcs, pyw
-00023d10: 6373 2e57 4353 293a 0a20 2020 2020 2020  cs.WCS):.       
-00023d20: 2020 2020 2073 656c 662e 7763 7320 3d20       self.wcs = 
-00023d30: 7763 732e 6465 6570 636f 7079 2829 0a20  wcs.deepcopy(). 
-00023d40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00023d50: 7420 6861 7361 7474 7228 7365 6c66 2e77  t hasattr(self.w
-00023d60: 6373 2c20 2770 6978 656c 5f73 6861 7065  cs, 'pixel_shape
-00023d70: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00023d80: 2020 2020 7365 6c66 2e77 6373 2e70 6978      self.wcs.pix
-00023d90: 656c 5f73 6861 7065 203d 204e 6f6e 650a  el_shape = None.
-00023da0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00023db0: 7365 6c66 2e77 6373 2e70 6978 656c 5f73  self.wcs.pixel_s
-00023dc0: 6861 7065 2069 7320 4e6f 6e65 3a0a 2020  hape is None:.  
-00023dd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00023de0: 6c66 2e77 6373 2e70 6978 656c 5f73 6861  lf.wcs.pixel_sha
-00023df0: 7065 203d 205b 696e 7428 702a 3229 2066  pe = [int(p*2) f
-00023e00: 6f72 2070 2069 6e20 7365 6c66 2e77 6373  or p in self.wcs
-00023e10: 2e77 6373 2e63 7270 6978 5d0a 2020 2020  .wcs.crpix].    
-00023e20: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00023e30: 6e63 6528 7763 732c 2073 7472 293a 0a20  nce(wcs, str):. 
-00023e40: 2020 2020 2020 2020 2020 2068 6475 203d             hdu =
-00023e50: 2070 7966 6974 732e 6f70 656e 2877 6373   pyfits.open(wcs
-00023e60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00023e70: 206c 656e 2868 6475 2920 3d3d 2031 3a0a   len(hdu) == 1:.
-00023e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e90: 6578 7420 3d20 300a 0a20 2020 2020 2020  ext = 0..       
-00023ea0: 2020 2020 2073 656c 662e 6164 645f 6e61       self.add_na
-00023eb0: 7869 7328 6864 755b 6578 745d 2e68 6561  xis(hdu[ext].hea
-00023ec0: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
-00023ed0: 2074 6865 5f77 6373 203d 2070 7977 6373   the_wcs = pywcs
-00023ee0: 2e57 4353 2868 6475 5b65 7874 5d2e 6865  .WCS(hdu[ext].he
-00023ef0: 6164 6572 2c20 666f 626a 3d68 6475 290a  ader, fobj=hdu).
-00023f00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00023f10: 2e77 6373 203d 2074 6865 5f77 6373 0a20  .wcs = the_wcs. 
-00023f20: 2020 2020 2020 2020 2020 2068 6475 2e63             hdu.c
-00023f30: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
-00023f40: 2020 200a 2020 2020 2020 2020 656c 6966     .        elif
-00023f50: 2069 7369 6e73 7461 6e63 6528 7763 732c   isinstance(wcs,
-00023f60: 2070 7966 6974 732e 4844 554c 6973 7429   pyfits.HDUList)
-00023f70: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00023f80: 206c 656e 2877 6373 2920 3d3d 2031 3a0a   len(wcs) == 1:.
-00023f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fa0: 6578 7420 3d20 300a 2020 2020 2020 2020  ext = 0.        
-00023fb0: 2020 2020 7365 6c66 2e61 6464 5f6e 6178      self.add_nax
-00023fc0: 6973 2877 6373 5b65 7874 5d2e 6865 6164  is(wcs[ext].head
-00023fd0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00023fe0: 7468 655f 7763 7320 3d20 7079 7763 732e  the_wcs = pywcs.
-00023ff0: 5743 5328 7763 735b 6578 745d 2e68 6561  WCS(wcs[ext].hea
-00024000: 6465 722c 2066 6f62 6a3d 7763 7329 0a20  der, fobj=wcs). 
-00024010: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00024020: 7763 7320 3d20 7468 655f 7763 730a 2020  wcs = the_wcs.  
-00024030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00024040: 2020 2020 2020 2020 7072 696e 7428 2757          print('W
-00024050: 4353 2063 6c61 7373 206e 6f74 2072 6563  CS class not rec
-00024060: 6f67 6e69 7a65 643a 207b 307d 272e 666f  ognized: {0}'.fo
-00024070: 726d 6174 2877 6373 2e5f 5f63 6c61 7373  rmat(wcs.__class
-00024080: 5f5f 2929 0a20 2020 2020 2020 2020 2020  __)).           
-00024090: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000240a0: 720a 0a20 2020 2020 2020 2073 656c 662e  r..        self.
-000240b0: 6670 203d 2073 656c 662e 7763 732e 6361  fp = self.wcs.ca
-000240c0: 6c63 5f66 6f6f 7470 7269 6e74 2829 0a20  lc_footprint(). 
-000240d0: 2020 2020 2020 2073 656c 662e 636f 7364         self.cosd
-000240e0: 6563 203d 206e 702e 636f 7328 7365 6c66  ec = np.cos(self
-000240f0: 2e66 705b 302c 2031 5d2f 3138 302a 6e70  .fp[0, 1]/180*np
-00024100: 2e70 6929 0a20 2020 2020 2020 2073 656c  .pi).        sel
-00024110: 662e 6c61 6265 6c20 3d20 6c61 6265 6c0a  f.label = label.
-00024120: 2020 2020 2020 2020 7365 6c66 2e70 6978          self.pix
-00024130: 656c 5f73 6361 6c65 203d 2067 6574 5f77  el_scale = get_w
-00024140: 6373 5f70 7363 616c 6528 7365 6c66 2e77  cs_pscale(self.w
-00024150: 6373 290a 0a20 2020 2040 7072 6f70 6572  cs)..    @proper
-00024160: 7479 0a20 2020 2064 6566 2063 656e 7472  ty.    def centr
-00024170: 6f69 6428 7365 6c66 293a 0a20 2020 2020  oid(self):.     
-00024180: 2020 2072 6574 7572 6e20 6e70 2e6d 6561     return np.mea
-00024190: 6e28 7365 6c66 2e66 702c 2061 7869 733d  n(self.fp, axis=
-000241a0: 3029 0a0a 0a20 2020 2040 7072 6f70 6572  0)...    @proper
-000241b0: 7479 0a20 2020 2064 6566 2070 6174 6828  ty.    def path(
-000241c0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
-000241d0: 2222 0a20 2020 2020 2020 2060 7e6d 6174  "".        `~mat
-000241e0: 706c 6f74 6c69 622e 7061 7468 2e50 6174  plotlib.path.Pat
-000241f0: 6860 206f 626a 6563 740a 2020 2020 2020  h` object.      
-00024200: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
-00024210: 706f 7274 206d 6174 706c 6f74 6c69 622e  port matplotlib.
-00024220: 7061 7468 0a20 2020 2020 2020 2072 6574  path.        ret
-00024230: 7572 6e20 6d61 7470 6c6f 746c 6962 2e70  urn matplotlib.p
-00024240: 6174 682e 5061 7468 2873 656c 662e 6670  ath.Path(self.fp
-00024250: 290a 0a0a 2020 2020 4070 726f 7065 7274  )...    @propert
-00024260: 790a 2020 2020 6465 6620 706f 6c79 676f  y.    def polygo
-00024270: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00024280: 2022 2222 0a20 2020 2020 2020 2060 7e73   """.        `~s
-00024290: 6861 7065 6c79 2e67 656f 6d65 7472 792e  hapely.geometry.
-000242a0: 506f 6c79 676f 6e60 206f 626a 6563 742e  Polygon` object.
-000242b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000242c0: 2020 2020 2066 726f 6d20 7368 6170 656c       from shapel
-000242d0: 792e 6765 6f6d 6574 7279 2069 6d70 6f72  y.geometry impor
-000242e0: 7420 506f 6c79 676f 6e0a 2020 2020 2020  t Polygon.      
-000242f0: 2020 7265 7475 726e 2050 6f6c 7967 6f6e    return Polygon
-00024300: 2873 656c 662e 6670 290a 0a0a 2020 2020  (self.fp)...    
-00024310: 6465 6620 6765 745f 7061 7463 6828 7365  def get_patch(se
-00024320: 6c66 2c20 2a2a 6b77 6172 6773 293a 0a20  lf, **kwargs):. 
-00024330: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00024340: 2020 2060 7e6d 6174 706c 6f74 6c69 622e     `~matplotlib.
-00024350: 7061 6368 2e50 6174 6850 6174 6368 6020  pach.PathPatch` 
-00024360: 6f62 6a65 6374 0a20 2020 2020 2020 2022  object.        "
-00024370: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00024380: 6e20 7061 7463 685f 6672 6f6d 5f70 6f6c  n patch_from_pol
-00024390: 7967 6f6e 2873 656c 662e 706f 6c79 676f  ygon(self.polygo
-000243a0: 6e2c 202a 2a6b 7761 7267 7329 0a0a 0a20  n, **kwargs)... 
-000243b0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-000243c0: 2064 6566 2072 6567 696f 6e28 7365 6c66   def region(self
-000243d0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-000243e0: 2020 2020 2020 2050 6f6c 7967 6f6e 2073         Polygon s
-000243f0: 7472 696e 6720 696e 2044 5339 2072 6567  tring in DS9 reg
-00024400: 696f 6e20 666f 726d 6174 0a20 2020 2020  ion format.     
-00024410: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00024420: 6574 7572 6e20 2770 6f6c 7967 6f6e 287b  eturn 'polygon({
-00024430: 307d 2927 2e66 6f72 6d61 7428 272c 272e  0})'.format(','.
-00024440: 6a6f 696e 285b 277b 303a 2e36 667d 272e  join(['{0:.6f}'.
-00024450: 666f 726d 6174 2863 2920 666f 7220 6320  format(c) for c 
-00024460: 696e 2073 656c 662e 6670 2e66 6c61 7474  in self.fp.flatt
-00024470: 656e 2829 5d29 290a 0a0a 2020 2020 4073  en()]))...    @s
-00024480: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-00024490: 6465 6620 6164 645f 6e61 7869 7328 6865  def add_naxis(he
-000244a0: 6164 6572 293a 0a20 2020 2020 2020 2022  ader):.        "
-000244b0: 2222 0a20 2020 2020 2020 2049 6620 4e41  "".        If NA
-000244c0: 5849 5320 6b65 7977 6f72 6473 206e 6f74  XIS keywords not
-000244d0: 2066 6f75 6e64 2069 6e20 616e 2069 6d61   found in an ima
-000244e0: 6765 2068 6561 6465 722c 2061 7373 756d  ge header, assum
-000244f0: 6520 7468 6520 7061 7265 6e74 0a20 2020  e the parent.   
-00024500: 2020 2020 2069 6d61 6765 2064 696d 656e       image dimen
-00024510: 7369 6f6e 7320 6172 6520 322a 4352 5049  sions are 2*CRPI
-00024520: 580a 2020 2020 2020 2020 2222 220a 2020  X.        """.  
-00024530: 2020 2020 2020 666f 7220 6920 696e 205b        for i in [
-00024540: 312c 2032 5d3a 0a20 2020 2020 2020 2020  1, 2]:.         
-00024550: 2020 2069 6620 274e 4158 4953 7b30 7d27     if 'NAXIS{0}'
-00024560: 2e66 6f72 6d61 7428 6929 206e 6f74 2069  .format(i) not i
-00024570: 6e20 6865 6164 6572 3a0a 2020 2020 2020  n header:.      
-00024580: 2020 2020 2020 2020 2020 6865 6164 6572            header
-00024590: 5b27 4e41 5849 537b 307d 272e 666f 726d  ['NAXIS{0}'.form
-000245a0: 6174 2869 295d 203d 2069 6e74 2868 6561  at(i)] = int(hea
-000245b0: 6465 725b 2743 5250 4958 7b30 7d27 2e66  der['CRPIX{0}'.f
-000245c0: 6f72 6d61 7428 6929 5d2a 3229 0a0a 0a64  ormat(i)]*2)...d
-000245d0: 6566 2072 6570 726f 6a65 6374 5f66 6173  ef reproject_fas
-000245e0: 7465 7228 696e 7075 745f 6864 752c 206f  ter(input_hdu, o
-000245f0: 7574 7075 742c 2070 6164 3d31 302c 202a  utput, pad=10, *
-00024600: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-00024610: 2253 7065 6564 2075 7020 6072 6570 726f  "Speed up `repro
-00024620: 6a65 6374 6020 6d6f 6475 6c65 2077 6974  ject` module wit
-00024630: 6820 6172 7261 7920 736c 6963 6573 206f  h array slices o
-00024640: 6620 7468 6520 696e 7075 7420 696d 6167  f the input imag
-00024650: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
-00024660: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00024670: 0a20 2020 2069 6e70 7574 5f68 6475 203a  .    input_hdu :
-00024680: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
-00024690: 7473 2e49 6d61 6765 4844 5560 0a20 2020  ts.ImageHDU`.   
-000246a0: 2020 2020 2049 6e70 7574 2069 6d61 6765       Input image
-000246b0: 2048 4455 2074 6f20 7265 7072 6f6a 6563   HDU to reprojec
-000246c0: 742e 0a0a 2020 2020 6f75 7470 7574 203a  t...    output :
-000246d0: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
-000246e0: 4353 6020 6f72 2060 7e61 7374 726f 7079  CS` or `~astropy
-000246f0: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00024700: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
-00024710: 6672 616d 6520 6465 6669 6e69 7469 6f6e  frame definition
-00024720: 2e0a 0a20 2020 2070 6164 203a 2069 6e74  ...    pad : int
-00024730: 0a20 2020 2020 2020 2050 6978 656c 2070  .        Pixel p
-00024740: 6164 6469 6e67 206f 6e20 736c 6963 6573  adding on slices
-00024750: 2063 7574 2066 726f 6d20 7468 6520 6069   cut from the `i
-00024760: 6e70 7574 5f68 6475 602e 0a0a 2020 2020  nput_hdu`...    
-00024770: 6b77 6172 6773 203a 2064 6963 740a 2020  kwargs : dict.  
-00024780: 2020 2020 2020 4172 6775 6d65 6e74 7320        Arguments 
-00024790: 7061 7373 6564 2074 6872 6f75 6768 2074  passed through t
-000247a0: 6f20 607e 7265 7072 6f6a 6563 742e 7265  o `~reproject.re
-000247b0: 7072 6f6a 6563 745f 696e 7465 7270 602e  project_interp`.
-000247c0: 2020 466f 720a 2020 2020 2020 2020 6578    For.        ex
-000247d0: 616d 706c 652c 2060 6f72 6465 723d 276e  ample, `order='n
-000247e0: 6561 7265 7374 2d6e 6569 6768 626f 7227  earest-neighbor'
-000247f0: 602e 0a0a 2020 2020 5265 7475 726e 730a  `...    Returns.
-00024800: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00024810: 7265 7072 6f6a 6563 7465 6420 3a20 607e  reprojected : `~
-00024820: 6e75 6d70 792e 6e64 6172 7261 7960 0a20  numpy.ndarray`. 
-00024830: 2020 2020 2020 2052 6570 726f 6a65 6374         Reproject
-00024840: 6564 2064 6174 6120 6672 6f6d 2060 696e  ed data from `in
-00024850: 7075 745f 6864 7560 2e0a 0a20 2020 2066  put_hdu`...    f
-00024860: 6f6f 7470 7269 6e74 203a 2060 7e6e 756d  ootprint : `~num
-00024870: 7079 2e6e 6461 7272 6179 600a 2020 2020  py.ndarray`.    
-00024880: 2020 2020 466f 6f74 7072 696e 7420 6f66      Footprint of
-00024890: 2074 6865 2069 6e70 7574 2061 7272 6179   the input array
-000248a0: 2069 6e20 7468 6520 6f75 7470 7574 2066   in the output f
-000248b0: 7261 6d65 2e0a 0a20 2020 204e 6f74 6573  rame...    Notes
-000248c0: 0a20 2020 202d 2d2d 2d2d 0a0a 2020 2020  .    -----..    
-000248d0: 6072 6570 726f 6a65 6374 2720 6973 2061  `reproject' is a
-000248e0: 6e20 6173 7472 6f70 792d 636f 6d70 6174  n astropy-compat
-000248f0: 6962 6c65 206d 6f64 756c 6520 7468 6174  ible module that
-00024900: 2063 616e 2062 6520 696e 7374 616c 6c65   can be installe
-00024910: 6420 7769 7468 0a20 2020 2060 7069 7060  d with.    `pip`
-00024920: 2e20 2053 6565 2068 7474 7073 3a2f 2f72  .  See https://r
-00024930: 6570 726f 6a65 6374 2e72 6561 6474 6865  eproject.readthe
-00024940: 646f 6373 2e69 6f2e 0a20 2020 2022 2222  docs.io..    """
-00024950: 0a20 2020 2069 6d70 6f72 7420 7265 7072  .    import repr
-00024960: 6f6a 6563 740a 0a20 2020 2023 204f 7574  oject..    # Out
-00024970: 7075 7420 5743 530a 2020 2020 6966 2069  put WCS.    if i
-00024980: 7369 6e73 7461 6e63 6528 6f75 7470 7574  sinstance(output
-00024990: 2c20 7079 7763 732e 5743 5329 3a0a 2020  , pywcs.WCS):.  
-000249a0: 2020 2020 2020 6f75 745f 7763 7320 3d20        out_wcs = 
-000249b0: 6f75 7470 7574 0a20 2020 2065 6c73 653a  output.    else:
-000249c0: 0a20 2020 2020 2020 206f 7574 5f77 6373  .        out_wcs
-000249d0: 203d 2070 7977 6373 2e57 4353 286f 7574   = pywcs.WCS(out
-000249e0: 7075 742c 2072 656c 6178 3d54 7275 6529  put, relax=True)
-000249f0: 0a0a 2020 2020 6966 2027 5349 5027 2069  ..    if 'SIP' i
-00024a00: 6e20 6f75 745f 7763 732e 7763 732e 6374  n out_wcs.wcs.ct
-00024a10: 7970 655b 305d 3a0a 2020 2020 2020 2020  ype[0]:.        
-00024a20: 7072 696e 7428 2757 6172 6e69 6e67 3a20  print('Warning: 
-00024a30: 6072 6570 726f 6a65 6374 6020 646f 6573  `reproject` does
-00024a40: 6e5c 2774 2061 7070 6561 7220 746f 2073  n\'t appear to s
-00024a50: 7570 706f 7274 2053 4950 2070 726f 6a65  upport SIP proje
-00024a60: 6374 696f 6e27 290a 0a20 2020 2023 2043  ction')..    # C
-00024a70: 6f6d 7075 7465 2070 6978 656c 2063 6f6f  ompute pixel coo
-00024a80: 7264 696e 6174 6573 206f 6620 7468 6520  rdinates of the 
-00024a90: 6f75 7470 7574 2066 7261 6d65 2063 6f72  output frame cor
-00024aa0: 6e65 7273 2069 6e20 7468 6520 696e 7075  ners in the inpu
-00024ab0: 7420 696d 6167 650a 2020 2020 696e 7075  t image.    inpu
-00024ac0: 745f 7763 7320 3d20 7079 7763 732e 5743  t_wcs = pywcs.WC
-00024ad0: 5328 696e 7075 745f 6864 752e 6865 6164  S(input_hdu.head
-00024ae0: 6572 2c20 7265 6c61 783d 5472 7565 290a  er, relax=True).
-00024af0: 2020 2020 6f75 745f 6670 203d 206f 7574      out_fp = out
-00024b00: 5f77 6373 2e63 616c 635f 666f 6f74 7072  _wcs.calc_footpr
-00024b10: 696e 7428 290a 2020 2020 696e 7075 745f  int().    input_
-00024b20: 7879 203d 2069 6e70 7574 5f77 6373 2e61  xy = input_wcs.a
-00024b30: 6c6c 5f77 6f72 6c64 3270 6978 286f 7574  ll_world2pix(out
-00024b40: 5f66 702c 2030 290a 2020 2020 736c 7820  _fp, 0).    slx 
-00024b50: 3d20 736c 6963 6528 696e 7428 696e 7075  = slice(int(inpu
-00024b60: 745f 7879 5b3a 2c20 305d 2e6d 696e 2829  t_xy[:, 0].min()
-00024b70: 292d 7061 642c 2069 6e74 2869 6e70 7574  )-pad, int(input
-00024b80: 5f78 795b 3a2c 2030 5d2e 6d61 7828 2929  _xy[:, 0].max())
-00024b90: 2b70 6164 290a 2020 2020 736c 7920 3d20  +pad).    sly = 
-00024ba0: 736c 6963 6528 696e 7428 696e 7075 745f  slice(int(input_
-00024bb0: 7879 5b3a 2c20 315d 2e6d 696e 2829 292d  xy[:, 1].min())-
-00024bc0: 7061 642c 2069 6e74 2869 6e70 7574 5f78  pad, int(input_x
-00024bd0: 795b 3a2c 2031 5d2e 6d61 7828 2929 2b70  y[:, 1].max())+p
-00024be0: 6164 290a 0a20 2020 2023 204d 616b 6520  ad)..    # Make 
-00024bf0: 7468 6520 6375 746f 7574 0a20 2020 2073  the cutout.    s
-00024c00: 7562 5f64 6174 6120 3d20 696e 7075 745f  ub_data = input_
-00024c10: 6864 752e 6461 7461 5b73 6c79 2c20 736c  hdu.data[sly, sl
-00024c20: 785d 0a20 2020 2073 7562 5f68 6561 6465  x].    sub_heade
-00024c30: 7220 3d20 6765 745f 7763 735f 736c 6963  r = get_wcs_slic
-00024c40: 655f 6865 6164 6572 2869 6e70 7574 5f77  e_header(input_w
-00024c50: 6373 2c20 736c 782c 2073 6c79 290a 2020  cs, slx, sly).  
-00024c60: 2020 7375 625f 6864 7520 3d20 7079 6669    sub_hdu = pyfi
-00024c70: 7473 2e50 7269 6d61 7279 4844 5528 6461  ts.PrimaryHDU(da
-00024c80: 7461 3d73 7562 5f64 6174 612c 2068 6561  ta=sub_data, hea
-00024c90: 6465 723d 7375 625f 6865 6164 6572 290a  der=sub_header).
-00024ca0: 0a20 2020 2023 2047 6574 2074 6865 2072  .    # Get the r
-00024cb0: 6570 726f 6a65 6374 696f 6e0a 2020 2020  eprojection.    
-00024cc0: 7365 675f 692c 2066 705f 6920 3d20 7265  seg_i, fp_i = re
-00024cd0: 7072 6f6a 6563 742e 7265 7072 6f6a 6563  project.reprojec
-00024ce0: 745f 696e 7465 7270 2873 7562 5f68 6475  t_interp(sub_hdu
-00024cf0: 2c20 6f75 7470 7574 2c20 2a2a 6b77 6172  , output, **kwar
-00024d00: 6773 290a 2020 2020 7265 7475 726e 2073  gs).    return s
-00024d10: 6567 5f69 2e61 7374 7970 6528 7375 625f  eg_i.astype(sub_
-00024d20: 6461 7461 2e64 7479 7065 292c 2066 705f  data.dtype), fp_
-00024d30: 692e 6173 7479 7065 286e 702e 7569 6e74  i.astype(np.uint
-00024d40: 3829 0a0a 0a64 6566 2066 756c 6c5f 7370  8)...def full_sp
-00024d50: 6563 7472 756d 5f77 6373 6865 6164 6572  ectrum_wcsheader
-00024d60: 2863 656e 7465 725f 7761 7665 3d31 2e34  (center_wave=1.4
-00024d70: 6534 2c20 646c 616d 3d34 302c 204e 583d  e4, dlam=40, NX=
-00024d80: 3130 302c 2073 7061 7469 616c 5f73 6361  100, spatial_sca
-00024d90: 6c65 3d31 2c20 4e59 3d31 3029 3a0a 2020  le=1, NY=10):.  
-00024da0: 2020 2222 224d 616b 6520 6120 5743 5320    """Make a WCS 
-00024db0: 6865 6164 6572 2066 6f72 2061 2032 4420  header for a 2D 
-00024dc0: 7370 6563 7472 756d 0a0a 2020 2020 5061  spectrum..    Pa
-00024dd0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00024de0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6365 6e74  -------.    cent
-00024df0: 6572 5f77 6176 6520 3a20 666c 6f61 740a  er_wave : float.
-00024e00: 2020 2020 2020 2020 5761 7665 6c65 6e67          Waveleng
-00024e10: 7468 206f 6620 7468 6520 6365 6e74 7261  th of the centra
-00024e20: 6c20 7069 7865 6c2c 2069 6e20 416e 7374  l pixel, in Anst
-00024e30: 726f 6d73 0a0a 2020 2020 646c 616d 203a  roms..    dlam :
-00024e40: 2066 6c6f 6174 0a20 2020 2020 2020 2044   float.        D
-00024e50: 656c 7461 2d77 6176 656c 656e 6774 6820  elta-wavelength 
-00024e60: 7065 7220 2878 2920 7069 7865 6c0a 0a20  per (x) pixel.. 
-00024e70: 2020 204e 582c 204e 5920 3a20 696e 740a     NX, NY : int.
-00024e80: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
-00024e90: 6620 7820 2620 7920 7069 7865 6c73 2e20  f x & y pixels. 
-00024ea0: 4f75 7470 7574 2077 696c 6c20 6861 7665  Output will have
-00024eb0: 2073 6861 7065 2060 2832 2a4e 592c 2032   shape `(2*NY, 2
-00024ec0: 2a4e 5829 602e 0a0a 2020 2020 7370 6174  *NX)`...    spat
-00024ed0: 6961 6c5f 7363 616c 6520 3a20 666c 6f61  ial_scale : floa
-00024ee0: 740a 2020 2020 2020 2020 5370 6174 6961  t.        Spatia
-00024ef0: 6c20 7363 616c 6520 6f66 2074 6865 206f  l scale of the o
-00024f00: 7574 7075 742c 2069 6e20 756e 6974 7320  utput, in units 
-00024f10: 6f66 2074 6865 2069 6e70 7574 2070 6978  of the input pix
-00024f20: 656c 730a 0a20 2020 2052 6574 7572 6e73  els..    Returns
-00024f30: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00024f40: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
-00024f50: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-00024f60: 6572 600a 2020 2020 2020 2020 4f75 7470  er`.        Outp
-00024f70: 7574 2057 4353 2068 6561 6465 720a 0a20  ut WCS header.. 
-00024f80: 2020 2077 6373 203a 2060 7e61 7374 726f     wcs : `~astro
-00024f90: 7079 2e77 6373 2e57 4353 600a 2020 2020  py.wcs.WCS`.    
-00024fa0: 2020 2020 4f75 7470 7574 2057 4353 0a0a      Output WCS..
-00024fb0: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
-00024fc0: 202d 2d2d 2d2d 2d2d 2d0a 0a20 2020 2020   --------..     
-00024fd0: 2020 203e 3e3e 2066 726f 6d20 6772 697a     >>> from griz
-00024fe0: 6c69 2e75 7469 6c73 2069 6d70 6f72 7420  li.utils import 
-00024ff0: 6d61 6b65 5f73 7065 6374 7275 6d5f 7763  make_spectrum_wc
-00025000: 7368 6561 6465 720a 2020 2020 2020 2020  sheader.        
-00025010: 3e3e 3e20 682c 2077 6373 203d 206d 616b  >>> h, wcs = mak
-00025020: 655f 7370 6563 7472 756d 5f77 6373 6865  e_spectrum_wcshe
-00025030: 6164 6572 2829 0a20 2020 2020 2020 203e  ader().        >
-00025040: 3e3e 2070 7269 6e74 2877 6373 290a 2020  >> print(wcs).  
-00025050: 2020 2020 2020 5743 5320 4b65 7977 6f72        WCS Keywor
-00025060: 6473 0a20 2020 2020 2020 204e 756d 6265  ds.        Numbe
-00025070: 7220 6f66 2057 4353 2061 7865 733a 2032  r of WCS axes: 2
-00025080: 0a20 2020 2020 2020 2043 5459 5045 203a  .        CTYPE :
-00025090: 2027 5741 5645 2720 2027 4c49 4e45 4152   'WAVE'  'LINEAR
-000250a0: 270a 2020 2020 2020 2020 4352 5641 4c20  '.        CRVAL 
-000250b0: 3a20 3134 3030 302e 3020 2030 2e30 0a20  : 14000.0  0.0. 
-000250c0: 2020 2020 2020 2043 5250 4958 203a 2031         CRPIX : 1
-000250d0: 3031 2e30 2020 3131 2e30 0a20 2020 2020  01.0  11.0.     
-000250e0: 2020 2043 4431 5f31 2043 4431 5f32 2020     CD1_1 CD1_2  
-000250f0: 3a20 3430 2e30 2020 302e 300a 2020 2020  : 40.0  0.0.    
-00025100: 2020 2020 4344 325f 3120 4344 325f 3220      CD2_1 CD2_2 
-00025110: 203a 2030 2e30 2020 312e 300a 2020 2020   : 0.0  1.0.    
-00025120: 2020 2020 4e41 5849 5320 2020 203a 2032      NAXIS    : 2
-00025130: 3030 2032 300a 0a20 2020 2022 2222 0a0a  00 20..    """..
-00025140: 2020 2020 6820 3d20 7079 6669 7473 2e49      h = pyfits.I
-00025150: 6d61 6765 4844 5528 6461 7461 3d6e 702e  mageHDU(data=np.
-00025160: 7a65 726f 7328 2832 2a4e 592c 2032 2a4e  zeros((2*NY, 2*N
-00025170: 5829 2c20 6474 7970 653d 6e70 2e66 6c6f  X), dtype=np.flo
-00025180: 6174 3332 2929 0a0a 2020 2020 7265 6668  at32))..    refh
-00025190: 203d 2068 2e68 6561 6465 720a 2020 2020   = h.header.    
-000251a0: 7265 6668 5b27 4352 5049 5831 275d 203d  refh['CRPIX1'] =
-000251b0: 204e 582b 310a 2020 2020 7265 6668 5b27   NX+1.    refh['
-000251c0: 4352 5049 5832 275d 203d 204e 592b 310a  CRPIX2'] = NY+1.
-000251d0: 2020 2020 7265 6668 5b27 4352 5641 4c31      refh['CRVAL1
-000251e0: 275d 203d 2063 656e 7465 725f 7761 7665  '] = center_wave
-000251f0: 2f31 2e65 340a 2020 2020 7265 6668 5b27  /1.e4.    refh['
-00025200: 4344 315f 3127 5d20 3d20 646c 616d 2f31  CD1_1'] = dlam/1
-00025210: 2e65 340a 2020 2020 7265 6668 5b27 4344  .e4.    refh['CD
-00025220: 315f 3227 5d20 3d20 302e 0a20 2020 2072  1_2'] = 0..    r
-00025230: 6566 685b 2743 5256 414c 3227 5d20 3d20  efh['CRVAL2'] = 
-00025240: 302e 0a20 2020 2072 6566 685b 2743 4432  0..    refh['CD2
-00025250: 5f32 275d 203d 2073 7061 7469 616c 5f73  _2'] = spatial_s
-00025260: 6361 6c65 0a20 2020 2072 6566 685b 2743  cale.    refh['C
-00025270: 4432 5f31 275d 203d 2030 2e0a 2020 2020  D2_1'] = 0..    
-00025280: 7265 6668 5b27 5241 4445 5359 5327 5d20  refh['RADESYS'] 
-00025290: 3d20 2727 0a0a 2020 2020 7265 6668 5b27  = ''..    refh['
-000252a0: 4354 5950 4531 275d 203d 2027 5241 2d2d  CTYPE1'] = 'RA--
-000252b0: 2d54 414e 2d53 4950 270a 2020 2020 7265  -TAN-SIP'.    re
-000252c0: 6668 5b27 4355 4e49 5431 275d 203d 2027  fh['CUNIT1'] = '
-000252d0: 6d61 7327 0a20 2020 2072 6566 685b 2743  mas'.    refh['C
-000252e0: 5459 5045 3227 5d20 3d20 2744 4543 2d2d  TYPE2'] = 'DEC--
-000252f0: 5441 4e2d 5349 5027 0a20 2020 2072 6566  TAN-SIP'.    ref
-00025300: 685b 2743 554e 4954 3227 5d20 3d20 276d  h['CUNIT2'] = 'm
-00025310: 6173 270a 0a20 2020 2072 6566 5f77 6373  as'..    ref_wcs
-00025320: 203d 2070 7977 6373 2e57 4353 2872 6566   = pywcs.WCS(ref
-00025330: 6829 0a20 2020 2072 6566 5f77 6373 2e70  h).    ref_wcs.p
-00025340: 7363 616c 6520 3d20 6765 745f 7763 735f  scale = get_wcs_
-00025350: 7073 6361 6c65 2872 6566 5f77 6373 290a  pscale(ref_wcs).
-00025360: 0a20 2020 2072 6574 7572 6e20 7265 6668  .    return refh
-00025370: 2c20 7265 665f 7763 730a 0a0a 6465 6620  , ref_wcs...def 
-00025380: 6d61 6b65 5f73 7065 6374 7275 6d5f 7763  make_spectrum_wc
-00025390: 7368 6561 6465 7228 6365 6e74 6572 5f77  sheader(center_w
-000253a0: 6176 653d 312e 3465 342c 2064 6c61 6d3d  ave=1.4e4, dlam=
-000253b0: 3430 2c20 4e58 3d31 3030 2c20 7370 6174  40, NX=100, spat
-000253c0: 6961 6c5f 7363 616c 653d 312c 204e 593d  ial_scale=1, NY=
-000253d0: 3130 293a 0a20 2020 2022 2222 4d61 6b65  10):.    """Make
-000253e0: 2061 2057 4353 2068 6561 6465 7220 666f   a WCS header fo
-000253f0: 7220 6120 3244 2073 7065 6374 7275 6d0a  r a 2D spectrum.
-00025400: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00025410: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00025420: 2020 2063 656e 7465 725f 7761 7665 203a     center_wave :
-00025430: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
-00025440: 6176 656c 656e 6774 6820 6f66 2074 6865  avelength of the
-00025450: 2063 656e 7472 616c 2070 6978 656c 2c20   central pixel, 
-00025460: 696e 2041 6e73 7472 6f6d 730a 0a20 2020  in Anstroms..   
-00025470: 2064 6c61 6d20 3a20 666c 6f61 740a 2020   dlam : float.  
-00025480: 2020 2020 2020 4465 6c74 612d 7761 7665        Delta-wave
-00025490: 6c65 6e67 7468 2070 6572 2028 7829 2070  length per (x) p
-000254a0: 6978 656c 0a0a 2020 2020 4e58 2c20 4e59  ixel..    NX, NY
-000254b0: 203a 2069 6e74 0a20 2020 2020 2020 204e   : int.        N
-000254c0: 756d 6265 7220 6f66 2078 2026 2079 2070  umber of x & y p
-000254d0: 6978 656c 732e 204f 7574 7075 7420 7769  ixels. Output wi
-000254e0: 6c6c 2068 6176 6520 7368 6170 6520 6028  ll have shape `(
-000254f0: 322a 4e59 2c20 322a 4e58 2960 2e0a 0a20  2*NY, 2*NX)`... 
-00025500: 2020 2073 7061 7469 616c 5f73 6361 6c65     spatial_scale
-00025510: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-00025520: 2053 7061 7469 616c 2073 6361 6c65 206f   Spatial scale o
-00025530: 6620 7468 6520 6f75 7470 7574 2c20 696e  f the output, in
-00025540: 2075 6e69 7473 206f 6620 7468 6520 696e   units of the in
-00025550: 7075 7420 7069 7865 6c73 0a0a 2020 2020  put pixels..    
-00025560: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00025570: 2d2d 2d0a 2020 2020 6865 6164 6572 203a  ---.    header :
-00025580: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
-00025590: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
-000255a0: 2020 204f 7574 7075 7420 5743 5320 6865     Output WCS he
-000255b0: 6164 6572 0a0a 2020 2020 7763 7320 3a20  ader..    wcs : 
-000255c0: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
-000255d0: 5360 0a20 2020 2020 2020 204f 7574 7075  S`.        Outpu
-000255e0: 7420 5743 530a 0a20 2020 2045 7861 6d70  t WCS..    Examp
-000255f0: 6c65 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  les.    --------
-00025600: 0a0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
-00025610: 6f6d 2067 7269 7a6c 692e 7574 696c 7320  om grizli.utils 
-00025620: 696d 706f 7274 206d 616b 655f 7370 6563  import make_spec
-00025630: 7472 756d 5f77 6373 6865 6164 6572 0a20  trum_wcsheader. 
-00025640: 2020 2020 2020 203e 3e3e 2068 2c20 7763         >>> h, wc
-00025650: 7320 3d20 6d61 6b65 5f73 7065 6374 7275  s = make_spectru
-00025660: 6d5f 7763 7368 6561 6465 7228 290a 2020  m_wcsheader().  
-00025670: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
-00025680: 7763 7329 0a20 2020 2020 2020 2057 4353  wcs).        WCS
-00025690: 204b 6579 776f 7264 730a 2020 2020 2020   Keywords.      
-000256a0: 2020 4e75 6d62 6572 206f 6620 5743 5320    Number of WCS 
-000256b0: 6178 6573 3a20 320a 2020 2020 2020 2020  axes: 2.        
-000256c0: 4354 5950 4520 3a20 2757 4156 4527 2020  CTYPE : 'WAVE'  
-000256d0: 274c 494e 4541 5227 0a20 2020 2020 2020  'LINEAR'.       
-000256e0: 2043 5256 414c 203a 2031 3430 3030 2e30   CRVAL : 14000.0
-000256f0: 2020 302e 300a 2020 2020 2020 2020 4352    0.0.        CR
-00025700: 5049 5820 3a20 3130 312e 3020 2031 312e  PIX : 101.0  11.
-00025710: 300a 2020 2020 2020 2020 4344 315f 3120  0.        CD1_1 
-00025720: 4344 315f 3220 203a 2034 302e 3020 2030  CD1_2  : 40.0  0
-00025730: 2e30 0a20 2020 2020 2020 2043 4432 5f31  .0.        CD2_1
-00025740: 2043 4432 5f32 2020 3a20 302e 3020 2031   CD2_2  : 0.0  1
-00025750: 2e30 0a20 2020 2020 2020 204e 4158 4953  .0.        NAXIS
-00025760: 2020 2020 3a20 3230 3020 3230 0a0a 2020      : 200 20..  
-00025770: 2020 2222 220a 0a20 2020 2068 203d 2070    """..    h = p
-00025780: 7966 6974 732e 496d 6167 6548 4455 2864  yfits.ImageHDU(d
-00025790: 6174 613d 6e70 2e7a 6572 6f73 2828 322a  ata=np.zeros((2*
-000257a0: 4e59 2c20 322a 4e58 292c 2064 7479 7065  NY, 2*NX), dtype
-000257b0: 3d6e 702e 666c 6f61 7433 3229 290a 0a20  =np.float32)).. 
-000257c0: 2020 2072 6566 6820 3d20 682e 6865 6164     refh = h.head
-000257d0: 6572 0a20 2020 2072 6566 685b 2743 5250  er.    refh['CRP
-000257e0: 4958 3127 5d20 3d20 4e58 2b31 0a20 2020  IX1'] = NX+1.   
-000257f0: 2072 6566 685b 2743 5250 4958 3227 5d20   refh['CRPIX2'] 
-00025800: 3d20 4e59 2b31 0a20 2020 2072 6566 685b  = NY+1.    refh[
-00025810: 2743 5256 414c 3127 5d20 3d20 6365 6e74  'CRVAL1'] = cent
-00025820: 6572 5f77 6176 650a 2020 2020 7265 6668  er_wave.    refh
-00025830: 5b27 4344 315f 3127 5d20 3d20 646c 616d  ['CD1_1'] = dlam
-00025840: 0a20 2020 2072 6566 685b 2743 4431 5f32  .    refh['CD1_2
-00025850: 275d 203d 2030 2e0a 2020 2020 7265 6668  '] = 0..    refh
-00025860: 5b27 4352 5641 4c32 275d 203d 2030 2e0a  ['CRVAL2'] = 0..
-00025870: 2020 2020 7265 6668 5b27 4344 325f 3227      refh['CD2_2'
-00025880: 5d20 3d20 7370 6174 6961 6c5f 7363 616c  ] = spatial_scal
-00025890: 650a 2020 2020 7265 6668 5b27 4344 325f  e.    refh['CD2_
-000258a0: 3127 5d20 3d20 302e 0a20 2020 2072 6566  1'] = 0..    ref
-000258b0: 685b 2752 4144 4553 5953 275d 203d 2027  h['RADESYS'] = '
-000258c0: 270a 0a20 2020 2072 6566 685b 2743 5459  '..    refh['CTY
-000258d0: 5045 3127 5d20 3d20 2757 4156 4527 0a20  PE1'] = 'WAVE'. 
-000258e0: 2020 2072 6566 685b 2743 5459 5045 3227     refh['CTYPE2'
-000258f0: 5d20 3d20 274c 494e 4541 5227 0a0a 2020  ] = 'LINEAR'..  
-00025900: 2020 7265 665f 7763 7320 3d20 7079 7763    ref_wcs = pywc
-00025910: 732e 5743 5328 682e 6865 6164 6572 290a  s.WCS(h.header).
-00025920: 2020 2020 7265 665f 7763 732e 7073 6361      ref_wcs.psca
-00025930: 6c65 203d 206e 702e 7371 7274 2872 6566  le = np.sqrt(ref
-00025940: 5f77 6373 2e77 6373 2e63 645b 302c 2030  _wcs.wcs.cd[0, 0
-00025950: 5d2a 2a32 202b 2072 6566 5f77 6373 2e77  ]**2 + ref_wcs.w
-00025960: 6373 2e63 645b 312c 2030 5d2a 2a32 292a  cs.cd[1, 0]**2)*
-00025970: 3336 3030 2e0a 0a20 2020 2072 6574 7572  3600...    retur
-00025980: 6e20 7265 6668 2c20 7265 665f 7763 730a  n refh, ref_wcs.
-00025990: 0a0a 6465 6620 7265 6164 5f67 7a69 7070  ..def read_gzipp
-000259a0: 6564 5f68 6561 6465 7228 6669 6c65 3d27  ed_header(file='
-000259b0: 7465 7374 2e66 6974 732e 677a 272c 2042  test.fits.gz', B
-000259c0: 4c4f 434b 3d31 3032 342c 204e 4d41 583d  LOCK=1024, NMAX=
-000259d0: 3235 362c 206e 7370 6163 653d 3136 2c20  256, nspace=16, 
-000259e0: 7374 7269 703d 4661 6c73 6529 3a0a 2020  strip=False):.  
-000259f0: 2020 2222 220a 2020 2020 5265 6164 2070    """.    Read p
-00025a00: 7269 6d61 7279 2068 6561 6465 7220 6672  rimary header fr
-00025a10: 6f6d 2061 2028 706f 7465 6e74 6961 6c6c  om a (potentiall
-00025a20: 7920 6c61 7267 6529 207a 6970 7065 6420  y large) zipped 
-00025a30: 4649 5453 2066 696c 650a 0a20 2020 2054  FITS file..    T
-00025a40: 6865 2073 6372 6970 7420 7072 6f63 6565  he script procee
-00025a50: 6473 2062 7920 7265 6164 696e 6720 604e  ds by reading `N
-00025a60: 4d41 5860 2073 6567 6d65 6e74 7320 6f66  MAX` segments of
-00025a70: 2073 697a 6520 6042 4c4f 434b 6020 6279   size `BLOCK` by
-00025a80: 7465 7320 6672 6f6d 0a20 2020 2074 6865  tes from.    the
-00025a90: 2066 696c 6520 616e 6420 7365 6172 6368   file and search
-00025aa0: 696e 6720 666f 7220 6120 7374 7269 6e67  ing for a string
-00025ab0: 2060 454e 4420 2b20 2720 272a 6e73 7061   `END + ' '*nspa
-00025ac0: 6365 6020 696e 2074 6865 2064 6174 610a  ce` in the data.
-00025ad0: 2020 2020 696e 6469 6361 7469 6e67 2074      indicating t
-00025ae0: 6865 2065 6e64 206f 6620 7468 6520 7072  he end of the pr
-00025af0: 696d 6172 7920 6865 6164 6572 2e0a 0a20  imary header... 
-00025b00: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00025b10: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00025b20: 2066 696c 6520 3a20 7374 720a 2020 2020   file : str.    
-00025b30: 2020 2020 4669 6c65 6e61 6d65 206f 6620      Filename of 
-00025b40: 677a 6970 7065 6420 4649 5453 2066 696c  gzipped FITS fil
-00025b50: 650a 0a20 2020 2042 4c4f 434b 2c20 4e4d  e..    BLOCK, NM
-00025b60: 4158 2c20 6e73 7061 6365 203a 2069 6e74  AX, nspace : int
-00025b70: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00025b80: 6572 7320 666f 7220 7265 6164 696e 6720  ers for reading 
-00025b90: 6279 7465 7320 6672 6f6d 2074 6865 2069  bytes from the i
-00025ba0: 6e70 7574 2066 696c 650a 0a20 2020 2073  nput file..    s
-00025bb0: 7472 6970 203a 2062 6f6f 6c0a 2020 2020  trip : bool.    
-00025bc0: 2020 2020 5365 6e64 206f 7574 7075 7420      Send output 
-00025bd0: 7468 726f 7567 6820 6073 7472 6970 5f68  through `strip_h
-00025be0: 6561 6465 725f 6b65 7973 602e 0a0a 0a20  eader_keys`.... 
-00025bf0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00025c00: 2d2d 2d2d 2d2d 0a20 2020 2068 6561 6465  ------.    heade
-00025c10: 7220 3a20 607e 6173 7472 6f70 792e 696f  r : `~astropy.io
-00025c20: 2e66 6974 732e 4865 6164 6572 600a 2020  .fits.Header`.  
-00025c30: 2020 2020 2020 4865 6164 6572 206f 626a        Header obj
-00025c40: 6563 740a 0a20 2020 2022 2222 0a20 2020  ect..    """.   
-00025c50: 2069 6d70 6f72 7420 677a 6970 0a20 2020   import gzip.   
-00025c60: 2069 6d70 6f72 7420 6173 7472 6f70 792e   import astropy.
-00025c70: 696f 2e66 6974 7320 6173 2070 7966 6974  io.fits as pyfit
-00025c80: 730a 0a20 2020 2066 203d 2067 7a69 702e  s..    f = gzip.
-00025c90: 477a 6970 4669 6c65 2866 696c 656f 626a  GzipFile(fileobj
-00025ca0: 3d6f 7065 6e28 6669 6c65 2c20 2772 6227  =open(file, 'rb'
-00025cb0: 2929 0a0a 2020 2020 6461 7461 203d 2062  ))..    data = b
-00025cc0: 2727 0a20 2020 2065 6e64 203d 2062 2720  ''.    end = b' 
-00025cd0: 454e 4427 2b62 2720 272a 6e73 7061 6365  END'+b' '*nspace
-00025ce0: 0a0a 2020 2020 666f 7220 6920 696e 2072  ..    for i in r
-00025cf0: 616e 6765 284e 4d41 5829 3a0a 2020 2020  ange(NMAX):.    
-00025d00: 2020 2020 6461 7461 5f69 203d 2066 2e72      data_i = f.r
-00025d10: 6561 6428 424c 4f43 4b29 0a20 2020 2020  ead(BLOCK).     
-00025d20: 2020 2069 6620 656e 6420 696e 2064 6174     if end in dat
-00025d30: 615f 693a 0a20 2020 2020 2020 2020 2020  a_i:.           
-00025d40: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
-00025d50: 6461 7461 202b 3d20 6461 7461 5f69 0a0a  data += data_i..
-00025d60: 2020 2020 6966 2028 6920 3d3d 204e 4d41      if (i == NMA
-00025d70: 582d 3129 3a0a 2020 2020 2020 2020 7072  X-1):.        pr
-00025d80: 696e 7428 2745 7272 6f72 3a20 454e 442b  int('Error: END+
-00025d90: 7b33 7d2a 2220 2220 6e6f 7420 666f 756e  {3}*" " not foun
-00025da0: 6420 696e 2066 6972 7374 207b 307d 787b  d in first {0}x{
-00025db0: 317d 2062 7974 6573 206f 6620 7b32 7d29  1} bytes of {2})
-00025dc0: 272e 666f 726d 6174 284e 4d41 582c 2042  '.format(NMAX, B
-00025dd0: 4c4f 434b 2c20 6669 6c65 2c20 6e73 7061  LOCK, file, nspa
-00025de0: 6365 2929 0a20 2020 2020 2020 2066 2e63  ce)).        f.c
-00025df0: 6c6f 7365 2829 0a20 2020 2020 2020 2072  lose().        r
-00025e00: 6574 7572 6e20 7b7d 0a0a 2020 2020 6978  eturn {}..    ix
-00025e10: 203d 2064 6174 615f 692e 696e 6465 7828   = data_i.index(
-00025e20: 656e 6429 0a20 2020 2064 6174 6120 2b3d  end).    data +=
-00025e30: 2064 6174 615f 695b 3a69 785d 2b65 6e64   data_i[:ix]+end
-00025e40: 2020 2320 6461 7461 5f69 5b3a 6978 5d0a    # data_i[:ix].
-00025e50: 0a20 2020 2066 2e63 6c6f 7365 2829 0a20  .    f.close(). 
-00025e60: 2020 2064 6174 615f 7374 7220 3d20 6461     data_str = da
-00025e70: 7461 2e64 6563 6f64 6528 2775 7466 3827  ta.decode('utf8'
-00025e80: 290a 2020 2020 6820 3d20 7079 6669 7473  ).    h = pyfits
-00025e90: 2e48 6561 6465 722e 6672 6f6d 7374 7269  .Header.fromstri
-00025ea0: 6e67 2864 6174 615f 7374 7229 0a0a 2020  ng(data_str)..  
-00025eb0: 2020 6966 2073 7472 6970 3a0a 2020 2020    if strip:.    
-00025ec0: 2020 2020 7265 7475 726e 2073 7472 6970      return strip
-00025ed0: 5f68 6561 6465 725f 6b65 7973 2868 2c20  _header_keys(h, 
-00025ee0: 7573 6577 6373 3d54 7275 6529 0a20 2020  usewcs=True).   
-00025ef0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-00025f00: 6574 7572 6e20 680a 0a0a 4452 495a 5a4c  eturn h...DRIZZL
-00025f10: 455f 4b45 5953 203d 205b 2747 454f 4d27  E_KEYS = ['GEOM'
-00025f20: 2c20 2744 4154 4127 2c20 2744 4558 5027  , 'DATA', 'DEXP'
-00025f30: 2c20 274f 5544 4127 2c20 274f 5557 4527  , 'OUDA', 'OUWE'
-00025f40: 2c20 274f 5543 4f27 2c20 274d 4153 4b27  , 'OUCO', 'MASK'
-00025f50: 2c20 2757 5453 4327 2c20 274b 4552 4e27  , 'WTSC', 'KERN'
-00025f60: 2c20 2750 4958 4627 2c20 2743 4f45 4627  , 'PIXF', 'COEF'
-00025f70: 2c20 274f 5555 4e27 2c20 2746 5641 4c27  , 'OUUN', 'FVAL'
-00025f80: 2c20 2757 4b45 5927 2c20 2753 4341 4c27  , 'WKEY', 'SCAL'
-00025f90: 2c20 2749 5343 4c27 5d0a 0a0a 6465 6620  , 'ISCL']...def 
-00025fa0: 7374 7269 705f 6865 6164 6572 5f6b 6579  strip_header_key
-00025fb0: 7328 6865 6164 6572 2c20 636f 6d6d 656e  s(header, commen
-00025fc0: 743d 5472 7565 2c20 6869 7374 6f72 793d  t=True, history=
-00025fd0: 5472 7565 2c20 6472 697a 7a6c 655f 6b65  True, drizzle_ke
-00025fe0: 7973 3d44 5249 5a5a 4c45 5f4b 4559 532c  ys=DRIZZLE_KEYS,
-00025ff0: 2075 7365 7763 733d 4661 6c73 652c 206b   usewcs=False, k
-00026000: 6565 705f 7769 7468 5f77 6373 3d5b 2745  eep_with_wcs=['E
-00026010: 5850 5449 4d45 272c 2027 4649 4c54 4552  XPTIME', 'FILTER
-00026020: 272c 2027 5445 4c45 5343 4f50 272c 2027  ', 'TELESCOP', '
-00026030: 494e 5354 5255 4d45 272c 2027 4441 5445  INSTRUME', 'DATE
-00026040: 2d4f 4253 272c 2027 4558 5053 5441 5254  -OBS', 'EXPSTART
-00026050: 272c 2027 4558 5045 4e44 275d 293a 0a20  ', 'EXPEND']):. 
-00026060: 2020 2022 2222 0a20 2020 2053 7472 6970     """.    Strip
-00026070: 2068 6561 6465 7220 6b65 7977 6f72 6473   header keywords
-00026080: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00026090: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-000260a0: 0a20 2020 2063 6f6d 6d65 6e74 2c20 6869  .    comment, hi
-000260b0: 7374 6f72 7920 3a20 626f 6f6c 0a20 2020  story : bool.   
-000260c0: 2020 2020 2053 7472 6970 2027 434f 4d4d       Strip 'COMM
-000260d0: 454e 5427 2061 6e64 2027 4849 5354 4f52  ENT' and 'HISTOR
-000260e0: 5927 206b 6579 776f 7264 732c 2072 6573  Y' keywords, res
-000260f0: 7065 6374 6976 656c 792e 0a0a 2020 2020  pectively...    
-00026100: 6472 697a 7a6c 655f 6b65 7973 203a 206c  drizzle_keys : l
-00026110: 6973 740a 2020 2020 2020 2020 5374 7269  ist.        Stri
-00026120: 7020 6b65 7973 2070 726f 6475 6365 6420  p keys produced 
-00026130: 6279 2060 7e64 7269 7a7a 6c65 7061 632e  by `~drizzlepac.
-00026140: 6173 7472 6f64 7269 7a7a 6c65 602e 0a0a  astrodrizzle`...
-00026150: 2020 2020 7573 6577 6373 203a 2062 6f6f      usewcs : boo
-00026160: 6c0a 2020 2020 2020 2020 416c 7465 726e  l.        Altern
-00026170: 6174 6976 656c 792c 206a 7573 7420 6765  atively, just ge
-00026180: 6e65 7261 7465 2061 2073 696d 706c 6520  nerate a simple 
-00026190: 5743 532d 6f6e 6c79 2068 6561 6465 7220  WCS-only header 
-000261a0: 6672 6f6d 2074 6865 2069 6e70 7574 0a20  from the input. 
-000261b0: 2020 2020 2020 2068 6561 6465 722e 0a0a         header...
-000261c0: 2020 2020 6b65 6570 5f77 6974 685f 7763      keep_with_wc
-000261d0: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
-000261e0: 2041 6464 6974 696f 6e61 6c20 6b65 7973   Additional keys
-000261f0: 2074 6f20 7472 7920 746f 2061 6464 2074   to try to add t
-00026200: 6f20 7468 6520 6075 7365 7763 7360 2068  o the `usewcs` h
-00026210: 6561 6465 722e 0a0a 2020 2020 5265 7475  eader...    Retu
-00026220: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00026230: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
-00026240: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
-00026250: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
-00026260: 4865 6164 6572 206f 626a 6563 742e 0a0a  Header object...
-00026270: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
-00026280: 7274 2063 6f70 790a 2020 2020 696d 706f  rt copy.    impo
-00026290: 7274 2061 7374 726f 7079 2e77 6373 2061  rt astropy.wcs a
-000262a0: 7320 7079 7763 730a 0a20 2020 2023 2050  s pywcs..    # P
-000262b0: 6172 7365 2057 4353 2061 6e64 2062 7569  arse WCS and bui
-000262c0: 6c64 2068 6561 6465 720a 2020 2020 6966  ld header.    if
-000262d0: 2075 7365 7763 733a 0a20 2020 2020 2020   usewcs:.       
-000262e0: 2077 6373 203d 2070 7977 6373 2e57 4353   wcs = pywcs.WCS
-000262f0: 2868 6561 6465 7229 0a20 2020 2020 2020  (header).       
-00026300: 2068 203d 2074 6f5f 6865 6164 6572 2877   h = to_header(w
-00026310: 6373 290a 2020 2020 2020 2020 666f 7220  cs).        for 
-00026320: 6b20 696e 206b 6565 705f 7769 7468 5f77  k in keep_with_w
-00026330: 6373 3a0a 2020 2020 2020 2020 2020 2020  cs:.            
-00026340: 6966 206b 2069 6e20 6865 6164 6572 3a0a  if k in header:.
-00026350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026360: 6966 206b 2069 6e20 6865 6164 6572 2e63  if k in header.c
-00026370: 6f6d 6d65 6e74 733a 0a20 2020 2020 2020  omments:.       
-00026380: 2020 2020 2020 2020 2020 2020 2068 5b6b               h[k
-00026390: 5d20 3d20 6865 6164 6572 5b6b 5d2c 2068  ] = header[k], h
-000263a0: 6561 6465 722e 636f 6d6d 656e 7473 5b6b  eader.comments[k
-000263b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000263c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000263d0: 2020 2020 2020 2020 2020 2020 685b 6b5d              h[k]
-000263e0: 203d 2068 6561 6465 725b 6b5d 0a0a 2020   = header[k]..  
-000263f0: 2020 2020 2020 6966 2027 4649 4c54 4552        if 'FILTER
-00026400: 2720 696e 206b 6565 705f 7769 7468 5f77  ' in keep_with_w
-00026410: 6373 3a0a 2020 2020 2020 2020 2020 2020  cs:.            
-00026420: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00026430: 2020 2020 2068 5b27 4649 4c54 4552 275d       h['FILTER']
-00026440: 203d 2028 7061 7273 655f 6669 6c74 6572   = (parse_filter
-00026450: 5f66 726f 6d5f 6865 6164 6572 2868 6561  _from_header(hea
-00026460: 6465 7229 2c0a 2020 2020 2020 2020 2020  der),.          
-00026470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026480: 2020 2020 2027 656c 656d 656e 7420 7365       'element se
-00026490: 6c65 6374 6564 2066 726f 6d20 6669 6c74  lected from filt
-000264a0: 6572 2077 6865 656c 2729 0a20 2020 2020  er wheel').     
-000264b0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-000264c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000264d0: 6173 730a 0a20 2020 2020 2020 2072 6574  ass..        ret
-000264e0: 7572 6e20 680a 0a20 2020 2068 203d 2063  urn h..    h = c
-000264f0: 6f70 792e 6465 6570 636f 7079 2868 6561  opy.deepcopy(hea
-00026500: 6465 7229 0a20 2020 206b 6579 7320 3d20  der).    keys = 
-00026510: 6c69 7374 2868 2e6b 6579 7328 2929 0a20  list(h.keys()). 
-00026520: 2020 2073 7472 6970 5f6b 6579 7320 3d20     strip_keys = 
-00026530: 5b5d 0a20 2020 2069 6620 636f 6d6d 656e  [].    if commen
-00026540: 743a 0a20 2020 2020 2020 2073 7472 6970  t:.        strip
-00026550: 5f6b 6579 732e 6170 7065 6e64 2827 434f  _keys.append('CO
-00026560: 4d4d 454e 5427 290a 0a20 2020 2069 6620  MMENT')..    if 
-00026570: 6869 7374 6f72 793a 0a20 2020 2020 2020  history:.       
-00026580: 2073 7472 6970 5f6b 6579 732e 6170 7065   strip_keys.appe
-00026590: 6e64 2827 4849 5354 4f52 5927 290a 0a20  nd('HISTORY').. 
-000265a0: 2020 2066 6f72 206b 2069 6e20 6b65 7973     for k in keys
-000265b0: 3a0a 2020 2020 2020 2020 6966 206b 2069  :.        if k i
-000265c0: 6e20 7374 7269 705f 6b65 7973 3a0a 2020  n strip_keys:.  
-000265d0: 2020 2020 2020 2020 2020 682e 7265 6d6f            h.remo
-000265e0: 7665 286b 290a 0a20 2020 2020 2020 2069  ve(k)..        i
-000265f0: 6620 6472 697a 7a6c 655f 6b65 7973 3a0a  f drizzle_keys:.
-00026600: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00026610: 2e73 7461 7274 7377 6974 6828 2744 2729  .startswith('D')
-00026620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026630: 2020 6966 2028 6b5b 2d34 3a5d 2069 6e20    if (k[-4:] in 
-00026640: 6472 697a 7a6c 655f 6b65 7973 2920 7c20  drizzle_keys) | 
-00026650: 6b2e 656e 6473 7769 7468 2827 5645 5227  k.endswith('VER'
-00026660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00026670: 2020 2020 2020 2068 2e72 656d 6f76 6528         h.remove(
-00026680: 6b29 0a0a 2020 2020 7265 7475 726e 2068  k)..    return h
-00026690: 0a0a 0a64 6566 2077 6373 5f66 726f 6d5f  ...def wcs_from_
-000266a0: 6865 6164 6572 2868 6561 6465 722c 2072  header(header, r
-000266b0: 656c 6178 3d54 7275 652c 202a 2a6b 7761  elax=True, **kwa
-000266c0: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
-000266d0: 2020 496e 6974 6961 6c69 7a65 2060 7e61    Initialize `~a
-000266e0: 7374 726f 7079 2e77 6373 2e57 4353 6020  stropy.wcs.WCS` 
-000266f0: 6672 6f6d 2061 2060 7e61 7374 726f 7079  from a `~astropy
-00026700: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00026710: 0a20 2020 200a 2020 2020 5061 7261 6d65  .    .    Parame
-00026720: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00026730: 2d2d 2d0a 2020 2020 6865 6164 6572 203a  ---.    header :
-00026740: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
-00026750: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
-00026760: 2020 2046 4954 5320 6865 6164 6572 2077     FITS header w
-00026770: 6974 6820 6f70 7469 6f6e 616c 2060 6053  ith optional ``S
-00026780: 4950 4352 5058 3160 6020 616e 6420 6060  IPCRPX1`` and ``
-00026790: 5349 5043 5250 5832 6060 206b 6579 776f  SIPCRPX2`` keywo
-000267a0: 7264 7320 7468 6174 0a20 2020 2020 2020  rds that.       
-000267b0: 2064 6566 696e 6520 6120 7365 7061 7261   define a separa
-000267c0: 7465 2072 6566 6572 656e 6365 2070 6978  te reference pix
-000267d0: 656c 2066 6f72 2061 2053 4950 2068 6561  el for a SIP hea
-000267e0: 6465 720a 2020 2020 0a20 2020 2072 656c  der.    .    rel
-000267f0: 6178 2c20 6b77 6172 6773 203a 2062 6f6f  ax, kwargs : boo
-00026800: 6c2c 2064 6963 740a 2020 2020 2020 2020  l, dict.        
-00026810: 4b65 7977 6f72 6473 2070 6173 7365 6420  Keywords passed 
-00026820: 746f 2060 6173 7472 6f70 792e 7763 732e  to `astropy.wcs.
-00026830: 5743 5360 0a20 2020 200a 2020 2020 5265  WCS`.    .    Re
-00026840: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00026850: 2d0a 2020 2020 7763 7320 3a20 607e 6173  -.    wcs : `~as
-00026860: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
-00026870: 2020 2020 2020 2057 4353 206f 626a 6563         WCS objec
-00026880: 740a 2020 2020 2020 2020 0a20 2020 2022  t.        .    "
-00026890: 2222 0a20 2020 2077 6373 203d 2070 7977  "".    wcs = pyw
-000268a0: 6373 2e57 4353 2868 6561 6465 722c 2072  cs.WCS(header, r
-000268b0: 656c 6178 3d72 656c 6178 290a 2020 2020  elax=relax).    
-000268c0: 0a20 2020 2069 6620 2827 5349 5043 5250  .    if ('SIPCRP
-000268d0: 5831 2720 696e 2068 6561 6465 7229 2026  X1' in header) &
-000268e0: 2068 6173 6174 7472 2877 6373 2c20 2773   hasattr(wcs, 's
-000268f0: 6970 2729 3a0a 2020 2020 2020 2020 7763  ip'):.        wc
-00026900: 732e 7369 702e 6372 7069 785b 305d 203d  s.sip.crpix[0] =
-00026910: 2068 6561 6465 725b 2753 4950 4352 5058   header['SIPCRPX
-00026920: 3127 5d0a 2020 2020 2020 2020 7763 732e  1'].        wcs.
-00026930: 7369 702e 6372 7069 785b 315d 203d 2068  sip.crpix[1] = h
-00026940: 6561 6465 725b 2753 4950 4352 5058 3227  eader['SIPCRPX2'
-00026950: 5d0a 2020 2020 656c 6966 2028 2753 4941  ].    elif ('SIA
-00026960: 465f 5852 4546 5f53 4349 2720 696e 2068  F_XREF_SCI' in h
-00026970: 6561 6465 7229 2026 2068 6173 6174 7472  eader) & hasattr
-00026980: 2877 6373 2c20 2773 6970 2729 3a0a 2020  (wcs, 'sip'):.  
-00026990: 2020 2020 2020 7763 732e 7369 702e 6372        wcs.sip.cr
-000269a0: 7069 785b 305d 203d 2068 6561 6465 725b  pix[0] = header[
-000269b0: 2753 4941 465f 5852 4546 5f53 4349 275d  'SIAF_XREF_SCI']
-000269c0: 0a20 2020 2020 2020 2077 6373 2e73 6970  .        wcs.sip
-000269d0: 2e63 7270 6978 5b31 5d20 3d20 6865 6164  .crpix[1] = head
-000269e0: 6572 5b27 5349 4146 5f59 5245 465f 5343  er['SIAF_YREF_SC
-000269f0: 4927 5d0a 2020 2020 2020 2020 0a20 2020  I'].        .   
-00026a00: 2072 6574 7572 6e20 7763 730a 0a0a 6465   return wcs...de
-00026a10: 6620 746f 5f68 6561 6465 7228 7763 732c  f to_header(wcs,
-00026a20: 2061 6464 5f6e 6178 6973 3d54 7275 652c   add_naxis=True,
-00026a30: 2072 656c 6178 3d54 7275 652c 206b 6579   relax=True, key
-00026a40: 3d4e 6f6e 6529 3a0a 2020 2020 2222 224d  =None):.    """M
-00026a50: 6f64 6966 7920 6061 7374 726f 7079 2e77  odify `astropy.w
-00026a60: 6373 2e57 4353 2e74 6f5f 6865 6164 6572  cs.WCS.to_header
-00026a70: 6020 746f 2070 726f 6475 6365 206d 6f72  ` to produce mor
-00026a80: 6520 6b65 7977 6f72 6473 0a0a 2020 2020  e keywords..    
-00026a90: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00026aa0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7763  ---------.    wc
-00026ab0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
-00026ac0: 732e 5743 5360 0a20 2020 2020 2020 2049  s.WCS`.        I
-00026ad0: 6e70 7574 2057 4353 2e0a 0a20 2020 2061  nput WCS...    a
-00026ae0: 6464 5f6e 6178 6973 203a 2062 6f6f 6c0a  dd_naxis : bool.
-00026af0: 2020 2020 2020 2020 4164 6420 4e41 5849          Add NAXI
-00026b00: 5320 6b65 7977 6f72 6473 2066 726f 6d20  S keywords from 
-00026b10: 5743 5320 6469 6d65 6e73 696f 6e73 0a0a  WCS dimensions..
-00026b20: 2020 2020 7265 6c61 7820 3a20 626f 6f6c      relax : bool
-00026b30: 0a20 2020 2020 2020 2050 6173 7365 6420  .        Passed 
-00026b40: 746f 2060 5743 532e 746f 5f68 6561 6465  to `WCS.to_heade
-00026b50: 7228 7265 6c61 783d 2960 2e0a 0a20 2020  r(relax=)`...   
-00026b60: 206b 6579 203a 2073 7472 0a20 2020 2020   key : str.     
-00026b70: 2020 2053 6565 2060 7e61 7374 726f 7079     See `~astropy
-00026b80: 2e77 6373 2e57 4353 2e74 6f5f 6865 6164  .wcs.WCS.to_head
-00026b90: 6572 602e 0a0a 2020 2020 5265 7475 726e  er`...    Return
-00026ba0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00026bb0: 2020 6865 6164 6572 203a 2060 7e61 7374    header : `~ast
-00026bc0: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
-00026bd0: 6465 7260 0a20 2020 2020 2020 204f 7574  der`.        Out
-00026be0: 7075 7420 6865 6164 6572 2e0a 0a20 2020  put header...   
-00026bf0: 2022 2222 0a20 2020 2068 6561 6465 7220   """.    header 
-00026c00: 3d20 7763 732e 746f 5f68 6561 6465 7228  = wcs.to_header(
-00026c10: 7265 6c61 783d 7265 6c61 782c 206b 6579  relax=relax, key
-00026c20: 3d6b 6579 290a 2020 2020 6966 2061 6464  =key).    if add
-00026c30: 5f6e 6178 6973 3a0a 2020 2020 2020 2020  _naxis:.        
-00026c40: 6966 2068 6173 6174 7472 2877 6373 2c20  if hasattr(wcs, 
-00026c50: 2770 6978 656c 5f73 6861 7065 2729 3a0a  'pixel_shape'):.
-00026c60: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00026c70: 6572 5b27 4e41 5849 5327 5d20 3d20 7763  er['NAXIS'] = wc
-00026c80: 732e 6e61 7869 730a 2020 2020 2020 2020  s.naxis.        
-00026c90: 2020 2020 6966 2077 6373 2e70 6978 656c      if wcs.pixel
-00026ca0: 5f73 6861 7065 2069 7320 6e6f 7420 4e6f  _shape is not No
-00026cb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00026cc0: 2020 2020 6865 6164 6572 5b27 4e41 5849      header['NAXI
-00026cd0: 5331 275d 203d 2077 6373 2e70 6978 656c  S1'] = wcs.pixel
-00026ce0: 5f73 6861 7065 5b30 5d0a 2020 2020 2020  _shape[0].      
-00026cf0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-00026d00: 5b27 4e41 5849 5332 275d 203d 2077 6373  ['NAXIS2'] = wcs
-00026d10: 2e70 6978 656c 5f73 6861 7065 5b31 5d0a  .pixel_shape[1].
-00026d20: 0a20 2020 2020 2020 2065 6c69 6620 6861  .        elif ha
-00026d30: 7361 7474 7228 7763 732c 2027 5f6e 6178  sattr(wcs, '_nax
-00026d40: 6973 3127 293a 0a20 2020 2020 2020 2020  is1'):.         
-00026d50: 2020 2068 6561 6465 725b 274e 4158 4953     header['NAXIS
-00026d60: 275d 203d 2077 6373 2e6e 6178 6973 0a20  '] = wcs.naxis. 
-00026d70: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-00026d80: 725b 274e 4158 4953 3127 5d20 3d20 7763  r['NAXIS1'] = wc
-00026d90: 732e 5f6e 6178 6973 310a 2020 2020 2020  s._naxis1.      
-00026da0: 2020 2020 2020 6865 6164 6572 5b27 4e41        header['NA
-00026db0: 5849 5332 275d 203d 2077 6373 2e5f 6e61  XIS2'] = wcs._na
-00026dc0: 7869 7332 0a0a 2020 2020 666f 7220 6b20  xis2..    for k 
-00026dd0: 696e 2068 6561 6465 723a 0a20 2020 2020  in header:.     
-00026de0: 2020 2069 6620 6b2e 7374 6172 7473 7769     if k.startswi
-00026df0: 7468 2827 5043 2729 3a0a 2020 2020 2020  th('PC'):.      
-00026e00: 2020 2020 2020 6364 203d 206b 2e72 6570        cd = k.rep
-00026e10: 6c61 6365 2827 5043 272c 2027 4344 2729  lace('PC', 'CD')
-00026e20: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-00026e30: 6465 722e 7265 6e61 6d65 5f6b 6579 776f  der.rename_keywo
-00026e40: 7264 286b 2c20 6364 290a 2020 2020 0a20  rd(k, cd).    . 
-00026e50: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
-00026e60: 732e 7763 732c 2027 6364 2729 3a0a 2020  s.wcs, 'cd'):.  
-00026e70: 2020 2020 2020 666f 7220 6920 696e 205b        for i in [
-00026e80: 302c 315d 3a0a 2020 2020 2020 2020 2020  0,1]:.          
-00026e90: 2020 666f 7220 6a20 696e 205b 302c 315d    for j in [0,1]
-00026ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026eb0: 2020 6865 6164 6572 5b66 2743 447b 692b    header[f'CD{i+
-00026ec0: 317d 5f7b 6a2b 317d 275d 203d 2077 6373  1}_{j+1}'] = wcs
-00026ed0: 2e77 6373 2e63 645b 695d 5b6a 5d0a 2020  .wcs.cd[i][j].  
-00026ee0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00026ef0: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
-00026f00: 732c 2027 7369 7027 293a 0a20 2020 2020  s, 'sip'):.     
-00026f10: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
-00026f20: 732e 7369 702c 2027 6372 7069 7827 293a  s.sip, 'crpix'):
-00026f30: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-00026f40: 6465 725b 2753 4950 4352 5058 3127 5d2c  der['SIPCRPX1'],
-00026f50: 2068 6561 6465 725b 2753 4950 4352 5058   header['SIPCRPX
-00026f60: 3227 5d20 3d20 7763 732e 7369 702e 6372  2'] = wcs.sip.cr
-00026f70: 7069 780a 2020 2020 2020 2020 2020 2020  pix.            
-00026f80: 0a20 2020 2072 6574 7572 6e20 6865 6164  .    return head
-00026f90: 6572 0a0a 0a64 6566 206d 616b 655f 7763  er...def make_wc
-00026fa0: 7368 6561 6465 7228 7261 3d34 302e 3037  sheader(ra=40.07
-00026fb0: 3239 332c 2064 6563 3d2d 312e 3631 3337  293, dec=-1.6137
-00026fc0: 3734 382c 2073 697a 653d 322c 2070 6978  748, size=2, pix
-00026fd0: 7363 616c 653d 302e 312c 2067 6574 5f68  scale=0.1, get_h
-00026fe0: 6475 3d46 616c 7365 2c20 7468 6574 613d  du=False, theta=
-00026ff0: 3029 3a0a 2020 2020 2222 224d 616b 6520  0):.    """Make 
-00027000: 6120 6365 6c65 7374 6961 6c20 5743 5320  a celestial WCS 
-00027010: 6865 6164 6572 0a0a 2020 2020 5061 7261  header..    Para
-00027020: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00027030: 2d2d 2d2d 2d0a 2020 2020 7261 2c20 6465  -----.    ra, de
-00027040: 6320 3a20 666c 6f61 740a 2020 2020 2020  c : float.      
-00027050: 2020 4365 6c65 7374 6961 6c20 636f 6f72    Celestial coor
-00027060: 6469 6e61 7465 7320 696e 2064 6563 696d  dinates in decim
-00027070: 616c 2064 6567 7265 6573 0a0a 2020 2020  al degrees..    
-00027080: 7369 7a65 2c20 7069 7873 6361 6c65 203a  size, pixscale :
-00027090: 2066 6c6f 6174 206f 7220 322d 6c69 7374   float or 2-list
-000270a0: 0a20 2020 2020 2020 2053 697a 6520 6f66  .        Size of
-000270b0: 2074 6865 2074 6875 6d62 6e61 696c 2c20   the thumbnail, 
-000270c0: 696e 2061 7263 7365 632c 2061 6e64 2070  in arcsec, and p
-000270d0: 6978 656c 2073 6361 6c65 2c20 696e 2061  ixel scale, in a
-000270e0: 7263 7365 632f 7069 7865 6c2e 0a20 2020  rcsec/pixel..   
-000270f0: 2020 2020 204f 7574 7075 7420 696d 6167       Output imag
-00027100: 6520 7769 6c6c 2068 6176 6520 6469 6d65  e will have dime
-00027110: 6e73 696f 6e73 2060 286e 7069 782c 6e70  nsions `(npix,np
-00027120: 6978 2960 2c20 7768 6572 650a 0a20 2020  ix)`, where..   
-00027130: 2020 2020 2020 2020 203e 3e3e 206e 7069           >>> npi
-00027140: 7820 3d20 7369 7a65 2f70 6978 7363 616c  x = size/pixscal
-00027150: 650a 0a20 2020 2067 6574 5f68 6475 203a  e..    get_hdu :
-00027160: 2062 6f6f 6c0a 2020 2020 2020 2020 5265   bool.        Re
-00027170: 7475 726e 2061 2060 7e61 7374 726f 7079  turn a `~astropy
-00027180: 2e69 6f2e 6669 7473 2e49 6d61 6765 4844  .io.fits.ImageHD
-00027190: 5560 2072 6174 6865 7220 7468 616e 2068  U` rather than h
-000271a0: 6561 6465 722f 7763 732e 0a0a 2020 2020  eader/wcs...    
-000271b0: 7468 6574 6120 3a20 666c 6f61 740a 2020  theta : float.  
-000271c0: 2020 2020 2020 506f 7369 7469 6f6e 2061        Position a
-000271d0: 6e67 6c65 206f 6620 7468 6520 6f75 7470  ngle of the outp
-000271e0: 7574 2074 6875 6d62 6e61 696c 2028 6465  ut thumbnail (de
-000271f0: 6772 6565 7329 0a0a 2020 2020 5265 7475  grees)..    Retu
-00027200: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00027210: 2020 2020 6864 7520 3a20 607e 6173 7472      hdu : `~astr
-00027220: 6f70 792e 696f 2e66 6974 732e 496d 6167  opy.io.fits.Imag
-00027230: 6548 4455 600a 2020 2020 2020 2020 4844  eHDU`.        HD
-00027240: 5520 7769 7468 2064 6174 6120 6669 6c6c  U with data fill
-00027250: 6564 2077 6974 6820 7a65 726f 7320 6966  ed with zeros if
-00027260: 2060 6765 745f 6864 753d 5472 7565 602e   `get_hdu=True`.
-00027270: 0a0a 2020 2020 6865 6164 6572 2c20 7763  ..    header, wc
-00027280: 7320 3a20 607e 6173 7472 6f70 792e 696f  s : `~astropy.io
-00027290: 2e66 6974 732e 4865 6164 6572 602c 2060  .fits.Header`, `
-000272a0: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
-000272b0: 600a 2020 2020 2020 2020 4865 6164 6572  `.        Header
-000272c0: 2061 6e64 2057 4353 206f 626a 6563 7420   and WCS object 
-000272d0: 6966 2060 6765 745f 6864 753d 4661 6c73  if `get_hdu=Fals
-000272e0: 6560 2e0a 0a20 2020 2045 7861 6d70 6c65  e`...    Example
-000272f0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a0a  s.    --------..
-00027300: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
-00027310: 2067 7269 7a6c 692e 7574 696c 7320 696d   grizli.utils im
-00027320: 706f 7274 206d 616b 655f 7763 7368 6561  port make_wcshea
-00027330: 6465 720a 2020 2020 2020 2020 3e3e 3e20  der.        >>> 
-00027340: 682c 2077 6373 203d 206d 616b 655f 7763  h, wcs = make_wc
-00027350: 7368 6561 6465 7228 290a 2020 2020 2020  sheader().      
-00027360: 2020 3e3e 3e20 7072 696e 7428 7763 7329    >>> print(wcs)
-00027370: 0a20 2020 2020 2020 2057 4353 204b 6579  .        WCS Key
-00027380: 776f 7264 730a 2020 2020 2020 2020 4e75  words.        Nu
-00027390: 6d62 6572 206f 6620 5743 5320 6178 6573  mber of WCS axes
-000273a0: 3a20 320a 2020 2020 2020 2020 4354 5950  : 2.        CTYP
-000273b0: 4520 3a20 2752 412d 2d2d 5441 4e27 2020  E : 'RA---TAN'  
-000273c0: 2744 4543 2d2d 5441 4e27 0a20 2020 2020  'DEC--TAN'.     
-000273d0: 2020 2043 5256 414c 203a 2034 302e 3037     CRVAL : 40.07
-000273e0: 3239 3239 3939 3939 3939 3939 3920 202d  2929999999999  -
-000273f0: 312e 3631 3337 3734 3830 3030 3030 3030  1.61377480000000
-00027400: 3031 0a20 2020 2020 2020 2043 5250 4958  01.        CRPIX
-00027410: 203a 2031 302e 3020 2031 302e 300a 2020   : 10.0  10.0.  
-00027420: 2020 2020 2020 4344 315f 3120 4344 315f        CD1_1 CD1_
-00027430: 3220 203a 202d 322e 3737 3737 3737 3737  2  : -2.77777777
-00027440: 3737 3737 3765 2d30 3520 2030 2e30 0a20  77777e-05  0.0. 
-00027450: 2020 2020 2020 2043 4432 5f31 2043 4432         CD2_1 CD2
-00027460: 5f32 2020 3a20 302e 3020 2032 2e37 3737  _2  : 0.0  2.777
-00027470: 3737 3737 3737 3737 3737 3730 3165 2d30  7777777777701e-0
-00027480: 350a 2020 2020 2020 2020 4e41 5849 5320  5.        NAXIS 
-00027490: 2020 203a 2032 3020 3230 0a0a 2020 2020     : 20 20..    
-000274a0: 2020 2020 3e3e 3e20 6672 6f6d 2067 7269      >>> from gri
-000274b0: 7a6c 692e 7574 696c 7320 696d 706f 7274  zli.utils import
-000274c0: 206d 616b 655f 7763 7368 6561 6465 720a   make_wcsheader.
-000274d0: 2020 2020 2020 2020 3e3e 3e20 6864 7520          >>> hdu 
-000274e0: 3d20 6d61 6b65 5f77 6373 6865 6164 6572  = make_wcsheader
-000274f0: 2867 6574 5f68 6475 3d54 7275 6529 0a20  (get_hdu=True). 
-00027500: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
-00027510: 2868 6475 2e64 6174 612e 7368 6170 6529  (hdu.data.shape)
-00027520: 0a20 2020 2020 2020 2028 3230 2c20 3230  .        (20, 20
-00027530: 290a 2020 2020 2020 2020 3e3e 3e20 7072  ).        >>> pr
-00027540: 696e 7428 6864 752e 6865 6164 6572 2e74  int(hdu.header.t
-00027550: 6f73 7472 696e 6729 0a20 2020 2020 2020  ostring).       
-00027560: 2058 5445 4e53 494f 4e3d 2027 494d 4147   XTENSION= 'IMAG
-00027570: 4520 2020 2720 2020 2020 2020 2020 2020  E   '           
-00027580: 2f20 496d 6167 6520 6578 7465 6e73 696f  / Image extensio
-00027590: 6e0a 2020 2020 2020 2020 4249 5450 4958  n.        BITPIX
-000275a0: 2020 3d20 2020 2020 2020 2020 2020 2020    =             
-000275b0: 2020 2020 202d 3332 202f 2061 7272 6179       -32 / array
-000275c0: 2064 6174 6120 7479 7065 0a20 2020 2020   data type.     
-000275d0: 2020 204e 4158 4953 2020 203d 2020 2020     NAXIS   =    
-000275e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000275f0: 3220 2f20 6e75 6d62 6572 206f 6620 6172  2 / number of ar
-00027600: 7261 7920 6469 6d65 6e73 696f 6e73 0a20  ray dimensions. 
-00027610: 2020 2020 2020 2050 434f 554e 5420 203d         PCOUNT  =
-00027620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027630: 2020 2020 3020 2f20 6e75 6d62 6572 206f      0 / number o
-00027640: 6620 7061 7261 6d65 7465 7273 0a20 2020  f parameters.   
-00027650: 2020 2020 2047 434f 554e 5420 203d 2020       GCOUNT  =  
-00027660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027670: 2020 3120 2f20 6e75 6d62 6572 206f 6620    1 / number of 
-00027680: 6772 6f75 7073 0a20 2020 2020 2020 2043  groups.        C
-00027690: 5250 4958 3120 203d 2020 2020 2020 2020  RPIX1  =        
-000276a0: 2020 2020 2020 2020 2020 2031 300a 2020             10.  
-000276b0: 2020 2020 2020 4352 5049 5832 2020 3d20        CRPIX2  = 
-000276c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276d0: 2020 3130 0a20 2020 2020 2020 2043 5256    10.        CRV
-000276e0: 414c 3120 203d 2020 2020 2020 2020 2020  AL1  =          
-000276f0: 2020 2034 302e 3037 3239 330a 2020 2020     40.07293.    
-00027700: 2020 2020 4352 5641 4c32 2020 3d20 2020      CRVAL2  =   
-00027710: 2020 2020 2020 2020 2d31 2e36 3133 3737          -1.61377
-00027720: 3438 0a20 2020 2020 2020 2043 4431 5f31  48.        CD1_1
-00027730: 2020 203d 202d 322e 3737 3737 3737 3737     = -2.77777777
-00027740: 3737 3737 3745 2d30 350a 2020 2020 2020  77777E-05.      
-00027750: 2020 4344 315f 3220 2020 3d20 2020 2020    CD1_2   =     
-00027760: 2020 2020 2020 2020 2020 2020 2030 2e30               0.0
-00027770: 0a20 2020 2020 2020 2043 4432 5f31 2020  .        CD2_1  
+0001f250: 2827 5053 312e 7927 2c20 5b27 794b 6d61  ('PS1.y', ['yKma
+0001f260: 6727 2c20 2765 5f79 4b6d 6167 275d 295d  g', 'e_yKmag'])]
+0001f270: 290a 0a23 204b 4944 5320 4452 330a 4b49  )..# KIDS DR3.KI
+0001f280: 4453 5f44 5233 5f56 495a 4945 5220 3d20  DS_DR3_VIZIER = 
+0001f290: 2749 492f 3334 372f 6b69 6473 5f64 7233  'II/347/kids_dr3
+0001f2a0: 270a 4b49 4453 5f44 5233 5f42 414e 4453  '.KIDS_DR3_BANDS
+0001f2b0: 203d 204f 7264 6572 6564 4469 6374 285b   = OrderedDict([
+0001f2c0: 2827 4f43 616d 2e73 6473 732e 7527 2c20  ('OCam.sdss.u', 
+0001f2d0: 5b27 756d 6167 272c 2027 655f 756d 6167  ['umag', 'e_umag
+0001f2e0: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001f300: 274f 4361 6d2e 7364 7373 2e67 272c 205b  'OCam.sdss.g', [
+0001f310: 2767 6d61 6727 2c20 2765 5f67 6d61 6727  'gmag', 'e_gmag'
+0001f320: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0001f330: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+0001f340: 4f43 616d 2e73 6473 732e 7227 2c20 5b27  OCam.sdss.r', ['
+0001f350: 726d 6167 272c 2027 655f 726d 6167 275d  rmag', 'e_rmag']
+0001f360: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001f370: 2020 2020 2020 2020 2020 2020 2028 274f               ('O
+0001f380: 4361 6d2e 7364 7373 2e69 272c 205b 2769  Cam.sdss.i', ['i
+0001f390: 6d61 6727 2c20 2765 5f69 6d61 6727 5d29  mag', 'e_imag'])
+0001f3a0: 5d29 0a0a 2320 5749 5345 2061 6c6c 2d73  ])..# WISE all-s
+0001f3b0: 6b79 0a57 4953 455f 5649 5a49 4552 203d  ky.WISE_VIZIER =
+0001f3c0: 2027 4949 2f33 3238 2f61 6c6c 7769 7365   'II/328/allwise
+0001f3d0: 270a 5749 5345 5f42 414e 4453 203d 204f  '.WISE_BANDS = O
+0001f3e0: 7264 6572 6564 4469 6374 285b 2827 5749  rderedDict([('WI
+0001f3f0: 5345 2f52 5352 2d57 3127 2c20 5b27 5731  SE/RSR-W1', ['W1
+0001f400: 6d61 6727 2c20 2765 5f57 316d 6167 275d  mag', 'e_W1mag']
+0001f410: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001f420: 2020 2020 2020 2020 2020 2020 2028 2757               ('W
+0001f430: 4953 452f 5253 522d 5732 272c 205b 2757  ISE/RSR-W2', ['W
+0001f440: 326d 6167 272c 2027 655f 5732 6d61 6727  2mag', 'e_W2mag'
+0001f450: 5d29 5d29 0a23 2028 2757 4953 452f 5253  ])]).# ('WISE/RS
+0001f460: 522d 5733 272c 205b 2757 336d 6167 272c  R-W3', ['W3mag',
+0001f470: 2027 655f 5733 6d61 6727 5d29 2c0a 2320   'e_W3mag']),.# 
+0001f480: 2827 5749 5345 2f52 5352 2d57 3427 2c20  ('WISE/RSR-W4', 
+0001f490: 5b27 5734 6d61 6727 2c20 2765 5f57 346d  ['W4mag', 'e_W4m
+0001f4a0: 6167 275d 295d 290a 0a23 2056 494b 494e  ag'])])..# VIKIN
+0001f4b0: 4720 5649 5354 410a 5649 4b49 4e47 5f56  G VISTA.VIKING_V
+0001f4c0: 495a 4945 5220 3d20 2749 492f 3334 332f  IZIER = 'II/343/
+0001f4d0: 7669 6b69 6e67 3227 0a56 494b 494e 475f  viking2'.VIKING_
+0001f4e0: 4241 4e44 5320 3d20 4f72 6465 7265 6444  BANDS = OrderedD
+0001f4f0: 6963 7428 5b28 2753 4453 532f 7a27 2c20  ict([('SDSS/z', 
+0001f500: 5b27 5a70 6d61 6727 2c20 2765 5f5a 706d  ['Zpmag', 'e_Zpm
+0001f510: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
+0001f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f530: 2020 2028 2756 4953 5441 2f59 272c 2020     ('VISTA/Y',  
+0001f540: 5b27 5970 6d61 6727 2c20 2027 655f 5970  ['Ypmag',  'e_Yp
+0001f550: 6d61 6727 5d29 2c0a 2020 2020 2020 2020  mag']),.        
+0001f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f570: 2020 2020 2827 5649 5354 412f 4a27 2c20      ('VISTA/J', 
+0001f580: 205b 274a 706d 6167 272c 2020 2765 5f4a   ['Jpmag',  'e_J
+0001f590: 706d 6167 275d 292c 0a20 2020 2020 2020  pmag']),.       
+0001f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5b0: 2020 2020 2028 2756 4953 5441 2f48 272c       ('VISTA/H',
+0001f5c0: 2020 5b27 4870 6d61 6727 2c20 2027 655f    ['Hpmag',  'e_
+0001f5d0: 4870 6d61 6727 5d29 2c0a 2020 2020 2020  Hpmag']),.      
+0001f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5f0: 2020 2020 2020 2827 5649 5354 412f 4b73        ('VISTA/Ks
+0001f600: 272c 205b 274b 7370 6d61 6727 2c20 2765  ', ['Kspmag', 'e
+0001f610: 5f4b 7370 6d61 6727 5d29 5d29 0a0a 2320  _Kspmag'])])..# 
+0001f620: 554b 4944 5353 2077 6964 6520 7375 7276  UKIDSS wide surv
+0001f630: 6579 730a 554b 4944 5353 5f4c 4153 5f56  eys.UKIDSS_LAS_V
+0001f640: 495a 4945 5220 3d20 2749 492f 3331 392f  IZIER = 'II/319/
+0001f650: 6c61 7339 270a 554b 4944 5353 5f4c 4153  las9'.UKIDSS_LAS
+0001f660: 5f42 414e 4453 203d 204f 7264 6572 6564  _BANDS = Ordered
+0001f670: 4469 6374 285b 2827 5746 4341 4d5f 5927  Dict([('WFCAM_Y'
+0001f680: 2c20 5b27 596d 6167 272c 2027 655f 596d  , ['Ymag', 'e_Ym
+0001f690: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
+0001f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6b0: 2020 2028 2757 4643 414d 5f4a 272c 205b     ('WFCAM_J', [
+0001f6c0: 274a 6d61 6731 272c 2027 655f 4a6d 6167  'Jmag1', 'e_Jmag
+0001f6d0: 3127 5d29 2c0a 2020 2020 2020 2020 2020  1']),.          
+0001f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6f0: 2020 2827 5746 4341 4d5f 4a27 2c20 5b27    ('WFCAM_J', ['
+0001f700: 4a6d 6167 3227 2c20 2765 5f4a 6d61 6732  Jmag2', 'e_Jmag2
+0001f710: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f730: 2028 2757 4643 414d 5f48 272c 205b 2748   ('WFCAM_H', ['H
+0001f740: 6d61 6727 2c20 2765 5f48 6d61 6727 5d29  mag', 'e_Hmag'])
+0001f750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001f760: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+0001f770: 5746 4341 4d5f 4b27 2c20 5b27 4b6d 6167  WFCAM_K', ['Kmag
+0001f780: 272c 2027 655f 4b6d 6167 275d 295d 290a  ', 'e_Kmag'])]).
+0001f790: 0a55 4b49 4453 535f 4458 535f 5649 5a49  .UKIDSS_DXS_VIZI
+0001f7a0: 4552 203d 2027 4949 2f33 3139 2f64 7873  ER = 'II/319/dxs
+0001f7b0: 3927 0a55 4b49 4453 535f 4458 535f 4241  9'.UKIDSS_DXS_BA
+0001f7c0: 4e44 5320 3d20 4f72 6465 7265 6444 6963  NDS = OrderedDic
+0001f7d0: 7428 5b28 2757 4643 414d 5f4a 272c 205b  t([('WFCAM_J', [
+0001f7e0: 274a 6d61 6727 2c20 2765 5f4a 6d61 6727  'Jmag', 'e_Jmag'
+0001f7f0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0001f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f810: 2827 5746 4341 4d5f 4b27 2c20 5b27 4b6d  ('WFCAM_K', ['Km
+0001f820: 6167 272c 2027 655f 4b6d 6167 275d 295d  ag', 'e_Kmag'])]
+0001f830: 290a 0a23 2047 414c 4558 0a47 414c 4558  )..# GALEX.GALEX
+0001f840: 5f4d 4953 5f56 495a 4945 5220 3d20 2749  _MIS_VIZIER = 'I
+0001f850: 492f 3331 322f 6d69 7327 0a47 414c 4558  I/312/mis'.GALEX
+0001f860: 5f4d 4953 5f42 414e 4453 203d 204f 7264  _MIS_BANDS = Ord
+0001f870: 6572 6564 4469 6374 285b 2827 4655 5627  eredDict([('FUV'
+0001f880: 2c20 5b27 4655 5627 2c20 2765 5f46 5556  , ['FUV', 'e_FUV
+0001f890: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8b0: 2020 2028 274e 5556 272c 205b 274e 5556     ('NUV', ['NUV
+0001f8c0: 272c 2027 655f 4e55 5627 5d29 5d29 0a0a  ', 'e_NUV'])])..
+0001f8d0: 4741 4c45 585f 4149 535f 5649 5a49 4552  GALEX_AIS_VIZIER
+0001f8e0: 203d 2027 4949 2f33 3132 2f61 6973 270a   = 'II/312/ais'.
+0001f8f0: 4741 4c45 585f 4149 535f 4241 4e44 5320  GALEX_AIS_BANDS 
+0001f900: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
+0001f910: 2746 5556 272c 205b 2746 5556 272c 2027  'FUV', ['FUV', '
+0001f920: 655f 4655 5627 5d29 2c0a 2020 2020 2020  e_FUV']),.      
+0001f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f940: 2020 2020 2020 2020 2827 4e55 5627 2c20          ('NUV', 
+0001f950: 5b27 4e55 5627 2c20 2765 5f4e 5556 275d  ['NUV', 'e_NUV']
+0001f960: 295d 290a 0a23 2043 6f6d 6269 6e65 6420  )])..# Combined 
+0001f970: 4469 6374 0a56 495a 4945 525f 4241 4e44  Dict.VIZIER_BAND
+0001f980: 5320 3d20 4f72 6465 7265 6444 6963 7428  S = OrderedDict(
+0001f990: 290a 5649 5a49 4552 5f42 414e 4453 5b43  ).VIZIER_BANDS[C
+0001f9a0: 4648 544c 535f 575f 5649 5a49 4552 5d20  FHTLS_W_VIZIER] 
+0001f9b0: 3d20 4346 4854 4c53 5f57 5f42 414e 4453  = CFHTLS_W_BANDS
+0001f9c0: 0a56 495a 4945 525f 4241 4e44 535b 4346  .VIZIER_BANDS[CF
+0001f9d0: 4854 4c53 5f44 5f56 495a 4945 525d 203d  HTLS_D_VIZIER] =
+0001f9e0: 2043 4648 544c 535f 445f 4241 4e44 530a   CFHTLS_D_BANDS.
+0001f9f0: 5649 5a49 4552 5f42 414e 4453 5b53 4453  VIZIER_BANDS[SDS
+0001fa00: 535f 4452 3132 5f56 495a 4945 525d 203d  S_DR12_VIZIER] =
+0001fa10: 2053 4453 535f 4452 3132 5f42 414e 4453   SDSS_DR12_BANDS
+0001fa20: 0a56 495a 4945 525f 4241 4e44 535b 5053  .VIZIER_BANDS[PS
+0001fa30: 315f 5649 5a49 4552 5d20 3d20 5053 315f  1_VIZIER] = PS1_
+0001fa40: 4241 4e44 530a 5649 5a49 4552 5f42 414e  BANDS.VIZIER_BAN
+0001fa50: 4453 5b4b 4944 535f 4452 335f 5649 5a49  DS[KIDS_DR3_VIZI
+0001fa60: 4552 5d20 3d20 4b49 4453 5f44 5233 5f42  ER] = KIDS_DR3_B
+0001fa70: 414e 4453 0a56 495a 4945 525f 4241 4e44  ANDS.VIZIER_BAND
+0001fa80: 535b 5749 5345 5f56 495a 4945 525d 203d  S[WISE_VIZIER] =
+0001fa90: 2057 4953 455f 4241 4e44 530a 5649 5a49   WISE_BANDS.VIZI
+0001faa0: 4552 5f42 414e 4453 5b56 494b 494e 475f  ER_BANDS[VIKING_
+0001fab0: 5649 5a49 4552 5d20 3d20 5649 4b49 4e47  VIZIER] = VIKING
+0001fac0: 5f42 414e 4453 0a56 495a 4945 525f 4241  _BANDS.VIZIER_BA
+0001fad0: 4e44 535b 554b 4944 5353 5f4c 4153 5f56  NDS[UKIDSS_LAS_V
+0001fae0: 495a 4945 525d 203d 2055 4b49 4453 535f  IZIER] = UKIDSS_
+0001faf0: 4c41 535f 4241 4e44 530a 5649 5a49 4552  LAS_BANDS.VIZIER
+0001fb00: 5f42 414e 4453 5b55 4b49 4453 535f 4458  _BANDS[UKIDSS_DX
+0001fb10: 535f 5649 5a49 4552 5d20 3d20 554b 4944  S_VIZIER] = UKID
+0001fb20: 5353 5f44 5853 5f42 414e 4453 0a56 495a  SS_DXS_BANDS.VIZ
+0001fb30: 4945 525f 4241 4e44 535b 4741 4c45 585f  IER_BANDS[GALEX_
+0001fb40: 4d49 535f 5649 5a49 4552 5d20 3d20 4741  MIS_VIZIER] = GA
+0001fb50: 4c45 585f 4d49 535f 4241 4e44 530a 5649  LEX_MIS_BANDS.VI
+0001fb60: 5a49 4552 5f42 414e 4453 5b47 414c 4558  ZIER_BANDS[GALEX
+0001fb70: 5f41 4953 5f56 495a 4945 525d 203d 2047  _AIS_VIZIER] = G
+0001fb80: 414c 4558 5f41 4953 5f42 414e 4453 0a0a  ALEX_AIS_BANDS..
+0001fb90: 5649 5a49 4552 5f56 4547 4120 3d20 4f72  VIZIER_VEGA = Or
+0001fba0: 6465 7265 6444 6963 7428 290a 5649 5a49  deredDict().VIZI
+0001fbb0: 4552 5f56 4547 415b 4346 4854 4c53 5f57  ER_VEGA[CFHTLS_W
+0001fbc0: 5f56 495a 4945 525d 203d 2046 616c 7365  _VIZIER] = False
+0001fbd0: 0a56 495a 4945 525f 5645 4741 5b43 4648  .VIZIER_VEGA[CFH
+0001fbe0: 544c 535f 445f 5649 5a49 4552 5d20 3d20  TLS_D_VIZIER] = 
+0001fbf0: 4661 6c73 650a 5649 5a49 4552 5f56 4547  False.VIZIER_VEG
+0001fc00: 415b 5344 5353 5f44 5231 325f 5649 5a49  A[SDSS_DR12_VIZI
+0001fc10: 4552 5d20 3d20 4661 6c73 650a 5649 5a49  ER] = False.VIZI
+0001fc20: 4552 5f56 4547 415b 5053 315f 5649 5a49  ER_VEGA[PS1_VIZI
+0001fc30: 4552 5d20 3d20 4661 6c73 650a 5649 5a49  ER] = False.VIZI
+0001fc40: 4552 5f56 4547 415b 4b49 4453 5f44 5233  ER_VEGA[KIDS_DR3
+0001fc50: 5f56 495a 4945 525d 203d 2046 616c 7365  _VIZIER] = False
+0001fc60: 0a56 495a 4945 525f 5645 4741 5b57 4953  .VIZIER_VEGA[WIS
+0001fc70: 455f 5649 5a49 4552 5d20 3d20 5472 7565  E_VIZIER] = True
+0001fc80: 0a56 495a 4945 525f 5645 4741 5b56 494b  .VIZIER_VEGA[VIK
+0001fc90: 494e 475f 5649 5a49 4552 5d20 3d20 5472  ING_VIZIER] = Tr
+0001fca0: 7565 0a56 495a 4945 525f 5645 4741 5b55  ue.VIZIER_VEGA[U
+0001fcb0: 4b49 4453 535f 4c41 535f 5649 5a49 4552  KIDSS_LAS_VIZIER
+0001fcc0: 5d20 3d20 5472 7565 0a56 495a 4945 525f  ] = True.VIZIER_
+0001fcd0: 5645 4741 5b55 4b49 4453 535f 4458 535f  VEGA[UKIDSS_DXS_
+0001fce0: 5649 5a49 4552 5d20 3d20 5472 7565 0a56  VIZIER] = True.V
+0001fcf0: 495a 4945 525f 5645 4741 5b47 414c 4558  IZIER_VEGA[GALEX
+0001fd00: 5f4d 4953 5f56 495a 4945 525d 203d 2046  _MIS_VIZIER] = F
+0001fd10: 616c 7365 0a56 495a 4945 525f 5645 4741  alse.VIZIER_VEGA
+0001fd20: 5b47 414c 4558 5f41 4953 5f56 495a 4945  [GALEX_AIS_VIZIE
+0001fd30: 525d 203d 2046 616c 7365 0a0a 0a64 6566  R] = False...def
+0001fd40: 2067 6574 5f56 697a 6965 725f 7068 6f74   get_Vizier_phot
+0001fd50: 6f6d 6574 7279 2872 612c 2064 6563 2c20  ometry(ra, dec, 
+0001fd60: 7465 6d70 6c61 7465 733d 4e6f 6e65 2c20  templates=None, 
+0001fd70: 7261 6469 7573 3d32 2c20 7669 7a69 6572  radius=2, vizier
+0001fd80: 5f63 6174 616c 6f67 3d50 5331 5f56 495a  _catalog=PS1_VIZ
+0001fd90: 4945 522c 2062 616e 6473 3d50 5331 5f42  IER, bands=PS1_B
+0001fda0: 414e 4453 2c20 6669 6c74 6572 5f66 696c  ANDS, filter_fil
+0001fdb0: 653d 272f 7573 722f 6c6f 6361 6c2f 7368  e='/usr/local/sh
+0001fdc0: 6172 652f 6561 7a79 2d70 686f 746f 7a2f  are/eazy-photoz/
+0001fdd0: 6669 6c74 6572 732f 4649 4c54 4552 2e52  filters/FILTER.R
+0001fde0: 4553 2e6c 6174 6573 7427 2c20 4d57 5f45  ES.latest', MW_E
+0001fdf0: 4256 3d30 2c20 636f 6e76 6572 745f 7665  BV=0, convert_ve
+0001fe00: 6761 3d46 616c 7365 2c20 7261 775f 7175  ga=False, raw_qu
+0001fe10: 6572 793d 4661 6c73 652c 2076 6572 626f  ery=False, verbo
+0001fe20: 7365 3d54 7275 652c 2074 696d 656f 7574  se=True, timeout
+0001fe30: 3d33 3030 2c20 726f 776c 696d 6974 3d35  =300, rowlimit=5
+0001fe40: 3030 3030 293a 0a20 2020 2022 2222 0a20  0000):.    """. 
+0001fe50: 2020 2046 6574 6368 2070 686f 746f 6d65     Fetch photome
+0001fe60: 7472 7920 6672 6f6d 2061 2056 697a 6965  try from a Vizie
+0001fe70: 7220 6361 7461 6c6f 670a 0a20 2020 2052  r catalog..    R
+0001fe80: 6571 7569 7265 7320 6561 7a79 7079 2f65  equires eazypy/e
+0001fe90: 617a 790a 2020 2020 2222 220a 0a20 2020  azy.    """..   
+0001fea0: 2066 726f 6d20 636f 6c6c 6563 7469 6f6e   from collection
+0001feb0: 7320 696d 706f 7274 204f 7264 6572 6564  s import Ordered
+0001fec0: 4469 6374 0a0a 2020 2020 696d 706f 7274  Dict..    import
+0001fed0: 2061 7374 726f 7079 2e75 6e69 7473 2061   astropy.units a
+0001fee0: 7320 750a 2020 2020 6672 6f6d 2061 7374  s u.    from ast
+0001fef0: 726f 7175 6572 792e 7669 7a69 6572 2069  roquery.vizier i
+0001ff00: 6d70 6f72 7420 5669 7a69 6572 0a20 2020  mport Vizier.   
+0001ff10: 2056 697a 6965 722e 524f 575f 4c49 4d49   Vizier.ROW_LIMI
+0001ff20: 5420 3d20 726f 776c 696d 6974 0a20 2020  T = rowlimit.   
+0001ff30: 2056 697a 6965 722e 5449 4d45 4f55 5420   Vizier.TIMEOUT 
+0001ff40: 3d20 7469 6d65 6f75 740a 0a20 2020 2023  = timeout..    #
+0001ff50: 7072 696e 7428 2778 7878 272c 2056 697a  print('xxx', Viz
+0001ff60: 6965 722e 524f 575f 4c49 4d49 542c 2056  ier.ROW_LIMIT, V
+0001ff70: 697a 6965 722e 5449 4d45 4f55 5429 0a0a  izier.TIMEOUT)..
+0001ff80: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
+0001ff90: 7079 2e63 6f6f 7264 696e 6174 6573 2061  py.coordinates a
+0001ffa0: 7320 636f 6f72 640a 2020 2020 696d 706f  s coord.    impo
+0001ffb0: 7274 2061 7374 726f 7079 2e75 6e69 7473  rt astropy.units
+0001ffc0: 2061 7320 750a 0a20 2020 2023 696d 706f   as u..    #impo
+0001ffd0: 7274 2070 7973 796e 7068 6f74 2061 7320  rt pysynphot as 
+0001ffe0: 530a 0a20 2020 2066 726f 6d20 6561 7a79  S..    from eazy
+0001fff0: 2e74 656d 706c 6174 6573 2069 6d70 6f72  .templates impor
+00020000: 7420 5465 6d70 6c61 7465 0a20 2020 2066  t Template.    f
+00020010: 726f 6d20 6561 7a79 2e66 696c 7465 7273  rom eazy.filters
+00020020: 2069 6d70 6f72 7420 4669 6c74 6572 4669   import FilterFi
+00020030: 6c65 0a20 2020 2066 726f 6d20 6561 7a79  le.    from eazy
+00020040: 2e70 686f 746f 7a20 696d 706f 7274 2054  .photoz import T
+00020050: 656d 706c 6174 6547 7269 640a 2020 2020  emplateGrid.    
+00020060: 6672 6f6d 2065 617a 792e 6669 6c74 6572  from eazy.filter
+00020070: 7320 696d 706f 7274 2046 696c 7465 7244  s import FilterD
+00020080: 6566 696e 6974 696f 6e0a 0a20 2020 2072  efinition..    r
+00020090: 6573 203d 2046 696c 7465 7246 696c 6528  es = FilterFile(
+000200a0: 6669 6c74 6572 5f66 696c 6529 0a0a 2020  filter_file)..  
+000200b0: 2020 636f 6f20 3d20 636f 6f72 642e 536b    coo = coord.Sk
+000200c0: 7943 6f6f 7264 2872 613d 7261 2c20 6465  yCoord(ra=ra, de
+000200d0: 633d 6465 632c 2075 6e69 743d 2875 2e64  c=dec, unit=(u.d
+000200e0: 6567 2c20 752e 6465 6729 2c0a 2020 2020  eg, u.deg),.    
+000200f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020100: 2020 2020 2066 7261 6d65 3d27 6963 7273       frame='icrs
+00020110: 2729 0a0a 2020 2020 636f 6c75 6d6e 7320  ')..    columns 
+00020120: 3d20 5b27 2a27 5d0a 2020 2020 2363 6f6c  = ['*'].    #col
+00020130: 756d 6e73 203d 205b 5d0a 2020 2020 6966  umns = [].    if
+00020140: 2069 7369 6e73 7461 6e63 6528 7669 7a69   isinstance(vizi
+00020150: 6572 5f63 6174 616c 6f67 2c20 6c69 7374  er_catalog, list
+00020160: 293a 0a20 2020 2020 2020 2066 6f72 2063  ):.        for c
+00020170: 2069 6e20 5b56 494b 494e 475f 5649 5a49   in [VIKING_VIZI
+00020180: 4552 5d3a 0a20 2020 2020 2020 2020 2020  ER]:.           
+00020190: 2066 6f72 2062 2069 6e20 5649 5a49 4552   for b in VIZIER
+000201a0: 5f42 414e 4453 5b63 5d3a 0a20 2020 2020  _BANDS[c]:.     
+000201b0: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+000201c0: 6e73 202b 3d20 5649 5a49 4552 5f42 414e  ns += VIZIER_BAN
+000201d0: 4453 5b63 5d5b 625d 0a0a 2020 2020 2020  DS[c][b]..      
+000201e0: 2020 636f 6c75 6d6e 7320 3d20 6c69 7374    columns = list
+000201f0: 286e 702e 756e 6971 7565 2863 6f6c 756d  (np.unique(colum
+00020200: 6e73 2929 0a20 2020 2020 2020 2023 7072  ns)).        #pr
+00020210: 696e 7428 2278 7878 2063 6f6c 756d 6e73  int("xxx columns
+00020220: 222c 2063 6f6c 756d 6e73 290a 2020 2020  ", columns).    
+00020230: 656c 7365 3a0a 2020 2020 2020 2020 666f  else:.        fo
+00020240: 7220 6220 696e 2062 616e 6473 3a0a 2020  r b in bands:.  
+00020250: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
+00020260: 7320 2b3d 2062 616e 6473 5b62 5d0a 0a20  s += bands[b].. 
+00020270: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00020280: 2876 697a 6965 725f 6361 7461 6c6f 672c  (vizier_catalog,
+00020290: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
+000202a0: 7620 3d20 5669 7a69 6572 2863 6174 616c  v = Vizier(catal
+000202b0: 6f67 3d56 494b 494e 475f 5649 5a49 4552  og=VIKING_VIZIER
+000202c0: 2c20 636f 6c75 6d6e 733d 5b27 2b5f 7227  , columns=['+_r'
+000202d0: 5d2b 636f 6c75 6d6e 7329 0a20 2020 2065  ]+columns).    e
+000202e0: 6c73 653a 0a20 2020 2020 2020 2076 203d  lse:.        v =
+000202f0: 2056 697a 6965 7228 6361 7461 6c6f 673d   Vizier(catalog=
+00020300: 7669 7a69 6572 5f63 6174 616c 6f67 2c20  vizier_catalog, 
+00020310: 636f 6c75 6d6e 733d 5b27 2b5f 7227 5d2b  columns=['+_r']+
+00020320: 636f 6c75 6d6e 7329 0a0a 2020 2020 762e  columns)..    v.
+00020330: 524f 575f 4c49 4d49 5420 3d20 726f 776c  ROW_LIMIT = rowl
+00020340: 696d 6974 0a20 2020 2076 2e54 494d 454f  imit.    v.TIMEO
+00020350: 5554 203d 2074 696d 656f 7574 0a0a 2020  UT = timeout..  
+00020360: 2020 2371 7565 7279 5f63 6174 616c 6f67    #query_catalog
+00020370: 203d 2076 697a 6965 725f 6361 7461 6c6f   = vizier_catalo
+00020380: 670a 2020 2020 7472 793a 0a20 2020 2020  g.    try:.     
+00020390: 2020 2074 6162 7320 3d20 762e 7175 6572     tabs = v.quer
+000203a0: 795f 7265 6769 6f6e 2863 6f6f 2c20 7261  y_region(coo, ra
+000203b0: 6469 7573 3d22 7b30 7d73 222e 666f 726d  dius="{0}s".form
+000203c0: 6174 2872 6164 6975 7329 2c0a 2020 2020  at(radius),.    
+000203d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000203e0: 2020 2020 2020 6361 7461 6c6f 673d 7669        catalog=vi
+000203f0: 7a69 6572 5f63 6174 616c 6f67 2920 2023  zier_catalog)  #
+00020400: 205b 305d 0a0a 2020 2020 2020 2020 6966   [0]..        if
+00020410: 2072 6177 5f71 7565 7279 3a0a 2020 2020   raw_query:.    
+00020420: 2020 2020 2020 2020 7265 7475 726e 2874          return(t
+00020430: 6162 7329 0a0a 2020 2020 2020 2020 7461  abs)..        ta
+00020440: 6220 3d20 7461 6273 5b30 5d0a 0a20 2020  b = tabs[0]..   
+00020450: 2020 2020 2069 6620 4661 6c73 653a 0a20       if False:. 
+00020460: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+00020470: 2069 6e20 7461 6273 3a0a 2020 2020 2020   in tabs:.      
+00020480: 2020 2020 2020 2020 2020 6261 6e64 7320            bands 
+00020490: 3d20 5649 5a49 4552 5f42 414e 4453 5b74  = VIZIER_BANDS[t
+000204a0: 2e6d 6574 615b 276e 616d 6527 5d5d 0a20  .meta['name']]. 
+000204b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000204c0: 6f72 2062 2069 6e20 6261 6e64 733a 0a20  or b in bands:. 
+000204d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204e0: 2020 2066 6f72 2063 2069 6e20 6261 6e64     for c in band
+000204f0: 735b 625d 3a0a 2020 2020 2020 2020 2020  s[b]:.          
+00020500: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00020510: 696e 7428 742e 6d65 7461 5b27 6e61 6d65  int(t.meta['name
+00020520: 275d 2c20 632c 2063 2069 6e20 742e 636f  '], c, c in t.co
+00020530: 6c6e 616d 6573 2920 2023 2063 203d 2062  lnames)  # c = b
+00020540: 616e 6473 5b62 5d5b 305d 0a0a 2020 2020  ands[b][0]..    
+00020550: 2020 2020 6978 203d 206e 702e 6172 676d      ix = np.argm
+00020560: 696e 2874 6162 5b27 5f72 275d 290a 2020  in(tab['_r']).  
+00020570: 2020 2020 2020 7461 6220 3d20 7461 625b        tab = tab[
+00020580: 6978 5d0a 2020 2020 6578 6365 7074 3a0a  ix].    except:.
+00020590: 2020 2020 2020 2020 7461 6220 3d20 4e6f          tab = No
+000205a0: 6e65 0a0a 2020 2020 2020 2020 7265 7475  ne..        retu
+000205b0: 726e 204e 6f6e 650a 0a20 2020 2076 697a  rn None..    viz
+000205c0: 5f74 6162 6c65 7320 3d20 272c 2027 2e6a  _tables = ', '.j
+000205d0: 6f69 6e28 5b74 2e6d 6574 615b 276e 616d  oin([t.meta['nam
+000205e0: 6527 5d20 666f 7220 7420 696e 2074 6162  e'] for t in tab
+000205f0: 735d 290a 2020 2020 6966 2076 6572 626f  s]).    if verbo
+00020600: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+00020610: 7428 2750 686f 746f 6d65 7472 7920 6672  t('Photometry fr
+00020620: 6f6d 2076 697a 6965 7220 6361 7461 6c6f  om vizier catalo
+00020630: 6773 3a20 7b30 7d27 2e66 6f72 6d61 7428  gs: {0}'.format(
+00020640: 7669 7a5f 7461 626c 6573 2929 0a0a 2020  viz_tables))..  
+00020650: 2020 7069 766f 7420 3d20 5b5d 2020 2320    pivot = []  # 
+00020660: 4f72 6465 7265 6444 6963 7428 290a 2020  OrderedDict().  
+00020670: 2020 666c 616d 203d 205b 5d0a 2020 2020    flam = [].    
+00020680: 6566 6c61 6d20 3d20 5b5d 0a20 2020 2066  eflam = [].    f
+00020690: 696c 7465 7273 203d 205b 5d0a 0a20 2020  ilters = []..   
+000206a0: 2066 6f72 2074 6162 2069 6e20 7461 6273   for tab in tabs
+000206b0: 3a0a 0a20 2020 2020 2020 2023 2044 6f77  :..        # Dow
+000206c0: 6e77 6569 6768 7420 5053 3120 6966 2068  nweight PS1 if h
+000206d0: 6176 6520 5344 5353 203f 2020 466f 7220  ave SDSS ?  For 
+000206e0: 6e6f 772c 2064 6f20 6e6f 7468 696e 670a  now, do nothing.
+000206f0: 2020 2020 2020 2020 6966 2028 7461 622e          if (tab.
+00020700: 6d65 7461 5b27 6e61 6d65 275d 203d 3d20  meta['name'] == 
+00020710: 5053 315f 5649 5a49 4552 2920 2620 2853  PS1_VIZIER) & (S
+00020720: 4453 535f 4452 3132 5f56 495a 4945 5220  DSS_DR12_VIZIER 
+00020730: 696e 2076 697a 5f74 6162 6c65 7329 3a0a  in viz_tables):.
+00020740: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+00020750: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00020760: 2020 2065 7272 5f73 6361 6c65 203d 2031     err_scale = 1
+00020770: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00020780: 2020 2020 2020 2020 2020 2065 7272 5f73             err_s
+00020790: 6361 6c65 203d 2031 0a0a 2020 2020 2020  cale = 1..      
+000207a0: 2020 2320 4f6e 6c79 2075 7365 206f 6e65    # Only use one
+000207b0: 2043 4648 5420 6361 7461 6c6f 670a 2020   CFHT catalog.  
+000207c0: 2020 2020 2020 6966 2028 7461 622e 6d65        if (tab.me
+000207d0: 7461 5b27 6e61 6d65 275d 203d 3d20 4346  ta['name'] == CF
+000207e0: 4854 4c53 5f57 5f56 495a 4945 5229 2026  HTLS_W_VIZIER) &
+000207f0: 2028 4346 4854 4c53 5f44 5f56 495a 4945   (CFHTLS_D_VIZIE
+00020800: 5220 696e 2076 697a 5f74 6162 6c65 7329  R in viz_tables)
+00020810: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00020820: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+00020830: 6966 2028 7461 622e 6d65 7461 5b27 6e61  if (tab.meta['na
+00020840: 6d65 275d 203d 3d20 554b 4944 5353 5f4c  me'] == UKIDSS_L
+00020850: 4153 5f56 495a 4945 5229 3a0a 2020 2020  AS_VIZIER):.    
+00020860: 2020 2020 2020 2020 666c 7578 5f73 6361          flux_sca
+00020870: 6c65 203d 2031 2e33 330a 2020 2020 2020  le = 1.33.      
+00020880: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00020890: 2020 2020 666c 7578 5f73 6361 6c65 203d      flux_scale =
+000208a0: 2031 2e0a 0a20 2020 2020 2020 2063 6f6e   1...        con
+000208b0: 7665 7274 5f76 6567 6120 3d20 5649 5a49  vert_vega = VIZI
+000208c0: 4552 5f56 4547 415b 7461 622e 6d65 7461  ER_VEGA[tab.meta
+000208d0: 5b27 6e61 6d65 275d 5d0a 2020 2020 2020  ['name']].      
+000208e0: 2020 6261 6e64 7320 3d20 5649 5a49 4552    bands = VIZIER
+000208f0: 5f42 414e 4453 5b74 6162 2e6d 6574 615b  _BANDS[tab.meta[
+00020900: 276e 616d 6527 5d5d 0a0a 2020 2020 2020  'name']]..      
+00020910: 2020 2320 6966 2076 6572 626f 7365 3a0a    # if verbose:.
+00020920: 2020 2020 2020 2020 2320 2020 2070 7269          #    pri
+00020930: 6e74 2874 6162 2e63 6f6c 6e61 6d65 7329  nt(tab.colnames)
+00020940: 0a0a 2020 2020 2020 2020 2366 696c 7465  ..        #filte
+00020950: 7273 202b 3d20 5b72 6573 2e66 696c 7465  rs += [res.filte
+00020960: 7273 5b72 6573 2e73 6561 7263 6828 622c  rs[res.search(b,
+00020970: 2076 6572 626f 7365 3d46 616c 7365 295b   verbose=False)[
+00020980: 305d 5d20 666f 7220 6220 696e 2062 616e  0]] for b in ban
+00020990: 6473 5d0a 0a20 2020 2020 2020 2074 6f5f  ds]..        to_
+000209a0: 666c 616d 203d 2031 302a 2a28 2d30 2e34  flam = 10**(-0.4
+000209b0: 2a28 3438 2e36 2929 2a33 2e65 3138 2020  *(48.6))*3.e18  
+000209c0: 2320 2f20 7069 766f 7428 416e 6729 2a2a  # / pivot(Ang)**
+000209d0: 320a 0a20 2020 2020 2020 2066 6f72 2069  2..        for i
+000209e0: 622c 2062 2069 6e20 656e 756d 6572 6174  b, b in enumerat
+000209f0: 6528 6261 6e64 7329 3a0a 2020 2020 2020  e(bands):.      
+00020a00: 2020 2020 2020 6669 6c74 203d 2072 6573        filt = res
+00020a10: 2e66 696c 7465 7273 5b72 6573 2e73 6561  .filters[res.sea
+00020a20: 7263 6828 622c 2076 6572 626f 7365 3d46  rch(b, verbose=F
+00020a30: 616c 7365 295b 305d 5d0a 2020 2020 2020  alse)[0]].      
+00020a40: 2020 2020 2020 6669 6c74 6572 732e 6170        filters.ap
+00020a50: 7065 6e64 2866 696c 7429 0a0a 2020 2020  pend(filt)..    
+00020a60: 2020 2020 2020 2020 6966 2063 6f6e 7665          if conve
+00020a70: 7274 5f76 6567 613a 0a20 2020 2020 2020  rt_vega:.       
+00020a80: 2020 2020 2020 2020 2074 6f5f 6162 203d           to_ab =
+00020a90: 2066 696c 742e 4142 5665 6761 2829 0a20   filt.ABVega(). 
+00020aa0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00020ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ac0: 2074 6f5f 6162 203d 2030 2e0a 0a20 2020   to_ab = 0...   
+00020ad0: 2020 2020 2020 2020 2066 636f 6c2c 2065           fcol, e
+00020ae0: 636f 6c20 3d20 6261 6e64 735b 625d 0a20  col = bands[b]. 
+00020af0: 2020 2020 2020 2020 2020 2070 6976 6f74             pivot
+00020b00: 2e61 7070 656e 6428 6669 6c74 2e70 6976  .append(filt.piv
+00020b10: 6f74 2829 290a 2020 2020 2020 2020 2020  ot()).          
+00020b20: 2020 666c 616d 2e61 7070 656e 6428 3130    flam.append(10
+00020b30: 2a2a 282d 302e 342a 2874 6162 5b66 636f  **(-0.4*(tab[fco
+00020b40: 6c5d 5b30 5d2b 746f 5f61 6229 292a 746f  l][0]+to_ab))*to
+00020b50: 5f66 6c61 6d2f 7069 766f 745b 2d31 5d2a  _flam/pivot[-1]*
+00020b60: 2a32 290a 2020 2020 2020 2020 2020 2020  *2).            
+00020b70: 666c 616d 5b2d 315d 202a 3d20 666c 7578  flam[-1] *= flux
+00020b80: 5f73 6361 6c65 0a20 2020 2020 2020 2020  _scale.         
+00020b90: 2020 2065 666c 616d 2e61 7070 656e 6428     eflam.append(
+00020ba0: 7461 625b 6563 6f6c 5d5b 305d 2a6e 702e  tab[ecol][0]*np.
+00020bb0: 6c6f 6728 3130 292f 322e 352a 666c 616d  log(10)/2.5*flam
+00020bc0: 5b2d 315d 2a65 7272 5f73 6361 6c65 290a  [-1]*err_scale).
+00020bd0: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+00020be0: 6e67 6528 6c65 6e28 6669 6c74 6572 7329  nge(len(filters)
+00020bf0: 295b 3a3a 2d31 5d3a 0a20 2020 2020 2020  )[::-1]:.       
+00020c00: 2069 6620 6e70 2e69 7373 6361 6c61 7228   if np.isscalar(
+00020c10: 666c 616d 5b69 5d29 2026 206e 702e 6973  flam[i]) & np.is
+00020c20: 7363 616c 6172 2865 666c 616d 5b69 5d29  scalar(eflam[i])
+00020c30: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00020c40: 6e74 696e 7565 0a20 2020 2020 2020 2065  ntinue.        e
+00020c50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00020c60: 2066 6c61 6d2e 706f 7028 6929 0a20 2020   flam.pop(i).   
+00020c70: 2020 2020 2020 2020 2065 666c 616d 2e70           eflam.p
+00020c80: 6f70 2869 290a 2020 2020 2020 2020 2020  op(i).          
+00020c90: 2020 6669 6c74 6572 732e 706f 7028 6929    filters.pop(i)
+00020ca0: 0a20 2020 2020 2020 2020 2020 2070 6976  .            piv
+00020cb0: 6f74 2e70 6f70 2869 290a 0a20 2020 206c  ot.pop(i)..    l
+00020cc0: 6320 3d20 6e70 2e61 7272 6179 2870 6976  c = np.array(piv
+00020cd0: 6f74 2920 2023 205b 7069 766f 745b 6962  ot)  # [pivot[ib
+00020ce0: 5d20 666f 7220 6962 2069 6e20 7261 6e67  ] for ib in rang
+00020cf0: 6528 6c65 6e28 6261 6e64 7329 295d 0a0a  e(len(bands))]..
+00020d00: 2020 2020 6966 2074 656d 706c 6174 6573      if templates
+00020d10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 0a20   is not None:.. 
+00020d20: 2020 2020 2020 2065 617a 795f 7465 6d70         eazy_temp
+00020d30: 6c61 7465 7320 3d20 5b54 656d 706c 6174  lates = [Templat
+00020d40: 6528 6172 7261 7973 3d28 7465 6d70 6c61  e(arrays=(templa
+00020d50: 7465 735b 6b5d 2e77 6176 652c 2074 656d  tes[k].wave, tem
+00020d60: 706c 6174 6573 5b6b 5d2e 666c 7578 292c  plates[k].flux),
+00020d70: 206e 616d 653d 6b29 2066 6f72 206b 2069   name=k) for k i
+00020d80: 6e20 7465 6d70 6c61 7465 735d 0a0a 2020  n templates]..  
+00020d90: 2020 2020 2020 7a67 7269 6420 3d20 6c6f        zgrid = lo
+00020da0: 675f 7a67 7269 6428 7a72 3d5b 302e 3031  g_zgrid(zr=[0.01
+00020db0: 2c20 332e 345d 2c20 647a 3d30 2e30 3035  , 3.4], dz=0.005
+00020dc0: 290a 0a20 2020 2020 2020 2074 656d 7066  )..        tempf
+00020dd0: 696c 7420 3d20 5465 6d70 6c61 7465 4772  ilt = TemplateGr
+00020de0: 6964 287a 6772 6964 2c20 6561 7a79 5f74  id(zgrid, eazy_t
+00020df0: 656d 706c 6174 6573 2c20 6669 6c74 6572  emplates, filter
+00020e00: 733d 6669 6c74 6572 732c 2061 6464 5f69  s=filters, add_i
+00020e10: 676d 3d54 7275 652c 2067 616c 6163 7469  gm=True, galacti
+00020e20: 635f 6562 763d 4d57 5f45 4256 2c20 4562  c_ebv=MW_EBV, Eb
+00020e30: 3d30 2c20 6e5f 7072 6f63 3d30 2c20 7665  =0, n_proc=0, ve
+00020e40: 7262 6f73 653d 4661 6c73 6529 0a20 2020  rbose=False).   
+00020e50: 2065 6c73 653a 0a20 2020 2020 2020 2074   else:.        t
+00020e60: 656d 7066 696c 7420 3d20 4e6f 6e65 0a0a  empfilt = None..
+00020e70: 2020 2020 7068 6f74 203d 204f 7264 6572      phot = Order
+00020e80: 6564 4469 6374 285b 2827 666c 616d 272c  edDict([('flam',
+00020e90: 206e 702e 6172 7261 7928 666c 616d 2929   np.array(flam))
+00020ea0: 2c20 2827 6566 6c61 6d27 2c20 6e70 2e61  , ('eflam', np.a
+00020eb0: 7272 6179 2865 666c 616d 2929 2c20 2827  rray(eflam)), ('
+00020ec0: 6669 6c74 6572 7327 2c20 6669 6c74 6572  filters', filter
+00020ed0: 7329 2c20 2827 7465 6d70 6669 6c74 272c  s), ('tempfilt',
+00020ee0: 2074 656d 7066 696c 7429 2c20 2827 6c63   tempfilt), ('lc
+00020ef0: 272c 206e 702e 6172 7261 7928 6c63 2929  ', np.array(lc))
+00020f00: 2c20 2827 736f 7572 6365 272c 2027 5669  , ('source', 'Vi
+00020f10: 7a69 6572 2027 2b76 697a 5f74 6162 6c65  zier '+viz_table
+00020f20: 7329 5d29 0a0a 2020 2020 7265 7475 726e  s)])..    return
+00020f30: 2070 686f 740a 0a0a 6465 6620 6765 6e65   phot...def gene
+00020f40: 7261 7465 5f74 656d 7066 696c 7428 7465  rate_tempfilt(te
+00020f50: 6d70 6c61 7465 732c 2066 696c 7465 7273  mplates, filters
+00020f60: 2c20 7a67 7269 643d 4e6f 6e65 2c20 4d57  , zgrid=None, MW
+00020f70: 5f45 4256 3d30 293a 0a0a 2020 2020 6672  _EBV=0):..    fr
+00020f80: 6f6d 2065 617a 792e 7465 6d70 6c61 7465  om eazy.template
+00020f90: 7320 696d 706f 7274 2054 656d 706c 6174  s import Templat
+00020fa0: 650a 2020 2020 6672 6f6d 2065 617a 792e  e.    from eazy.
+00020fb0: 7068 6f74 6f7a 2069 6d70 6f72 7420 5465  photoz import Te
+00020fc0: 6d70 6c61 7465 4772 6964 0a0a 2020 2020  mplateGrid..    
+00020fd0: 2320 7477 6176 652c 2074 666c 7578 2c20  # twave, tflux, 
+00020fe0: 6973 5f6c 696e 6520 3d20 6172 7261 795f  is_line = array_
+00020ff0: 7465 6d70 6c61 7465 7328 7465 6d70 6c61  templates(templa
+00021000: 7465 732c 207a 3d30 290a 2020 2020 2320  tes, z=0).    # 
+00021010: 6561 7a79 5f74 656d 706c 6174 6573 203d  eazy_templates =
+00021020: 205b 5d0a 2020 2020 2320 666f 7220 692c   [].    # for i,
+00021030: 2074 2069 6e20 656e 756d 6572 6174 6528   t in enumerate(
+00021040: 7465 6d70 6c61 7465 7329 3a0a 2020 2020  templates):.    
+00021050: 2320 2020 2020 6561 7a79 5f74 656d 706c  #     eazy_templ
+00021060: 6174 6573 2e61 7070 656e 6428 5465 6d70  ates.append(Temp
+00021070: 6c61 7465 2861 7272 6179 733d 5b74 7761  late(arrays=[twa
+00021080: 7665 2c20 6e70 2e6d 6178 696d 756d 2874  ve, np.maximum(t
+00021090: 7761 7665 2c20 312e 652d 3330 295d 2c20  wave, 1.e-30)], 
+000210a0: 6e61 6d65 3d74 2929 0a0a 2020 2020 6561  name=t))..    ea
+000210b0: 7a79 5f74 656d 706c 6174 6573 203d 205b  zy_templates = [
+000210c0: 5465 6d70 6c61 7465 2861 7272 6179 733d  Template(arrays=
+000210d0: 2874 656d 706c 6174 6573 5b6b 5d2e 7761  (templates[k].wa
+000210e0: 7665 2c20 7465 6d70 6c61 7465 735b 6b5d  ve, templates[k]
+000210f0: 2e66 6c75 7829 2c20 6e61 6d65 3d6b 2920  .flux), name=k) 
+00021100: 666f 7220 6b20 696e 2074 656d 706c 6174  for k in templat
+00021110: 6573 5d0a 0a20 2020 2069 6620 7a67 7269  es]..    if zgri
+00021120: 6420 6973 204e 6f6e 653a 0a20 2020 2020  d is None:.     
+00021130: 2020 207a 6772 6964 203d 206c 6f67 5f7a     zgrid = log_z
+00021140: 6772 6964 287a 723d 5b30 2e30 312c 2033  grid(zr=[0.01, 3
+00021150: 2e34 5d2c 2064 7a3d 302e 3030 3529 0a0a  .4], dz=0.005)..
+00021160: 2020 2020 7465 6d70 6669 6c74 203d 2054      tempfilt = T
+00021170: 656d 706c 6174 6547 7269 6428 7a67 7269  emplateGrid(zgri
+00021180: 642c 2065 617a 795f 7465 6d70 6c61 7465  d, eazy_template
+00021190: 732c 2066 696c 7465 7273 3d66 696c 7465  s, filters=filte
+000211a0: 7273 2c20 6164 645f 6967 6d3d 5472 7565  rs, add_igm=True
+000211b0: 2c20 6761 6c61 6374 6963 5f65 6276 3d4d  , galactic_ebv=M
+000211c0: 575f 4542 562c 2045 623d 302c 206e 5f70  W_EBV, Eb=0, n_p
+000211d0: 726f 633d 302c 2076 6572 626f 7365 3d46  roc=0, verbose=F
+000211e0: 616c 7365 290a 0a20 2020 2072 6574 7572  alse)..    retur
+000211f0: 6e20 7465 6d70 6669 6c74 0a0a 0a64 6566  n tempfilt...def
+00021200: 2063 6f6d 6269 6e65 5f70 686f 745f 6469   combine_phot_di
+00021210: 6374 2870 686f 7473 2c20 7465 6d70 6c61  ct(phots, templa
+00021220: 7465 733d 4e6f 6e65 2c20 4d57 5f45 4256  tes=None, MW_EBV
+00021230: 3d30 293a 0a20 2020 2022 2222 0a20 2020  =0):.    """.   
+00021240: 2043 6f6d 6269 6e65 2070 686f 746d 6574   Combine photmet
+00021250: 7279 2064 6963 7469 6f6e 6172 6965 730a  ry dictionaries.
+00021260: 2020 2020 2222 220a 2020 2020 7068 6f74      """.    phot
+00021270: 203d 207b 7d0a 2020 2020 7068 6f74 5b27   = {}.    phot['
+00021280: 666c 616d 275d 203d 205b 5d0a 2020 2020  flam'] = [].    
+00021290: 7068 6f74 5b27 6566 6c61 6d27 5d20 3d20  phot['eflam'] = 
+000212a0: 5b5d 0a20 2020 2070 686f 745b 2766 696c  [].    phot['fil
+000212b0: 7465 7273 275d 203d 205b 5d0a 2020 2020  ters'] = [].    
+000212c0: 666f 7220 7020 696e 2070 686f 7473 3a0a  for p in phots:.
+000212d0: 2020 2020 2020 2020 7068 6f74 5b27 666c          phot['fl
+000212e0: 616d 275d 203d 206e 702e 6170 7065 6e64  am'] = np.append
+000212f0: 2870 686f 745b 2766 6c61 6d27 5d2c 2070  (phot['flam'], p
+00021300: 5b27 666c 616d 275d 290a 2020 2020 2020  ['flam']).      
+00021310: 2020 7068 6f74 5b27 6566 6c61 6d27 5d20    phot['eflam'] 
+00021320: 3d20 6e70 2e61 7070 656e 6428 7068 6f74  = np.append(phot
+00021330: 5b27 6566 6c61 6d27 5d2c 2070 5b27 6566  ['eflam'], p['ef
+00021340: 6c61 6d27 5d29 0a20 2020 2020 2020 2070  lam']).        p
+00021350: 686f 745b 2766 696c 7465 7273 275d 2e65  hot['filters'].e
+00021360: 7874 656e 6428 705b 2766 696c 7465 7273  xtend(p['filters
+00021370: 275d 290a 0a20 2020 2069 6620 7465 6d70  '])..    if temp
+00021380: 6c61 7465 7320 6973 206e 6f74 204e 6f6e  lates is not Non
+00021390: 653a 0a20 2020 2020 2020 2070 686f 745b  e:.        phot[
+000213a0: 2774 656d 7066 696c 7427 5d20 3d20 6765  'tempfilt'] = ge
+000213b0: 6e65 7261 7465 5f74 656d 7066 696c 7428  nerate_tempfilt(
+000213c0: 7465 6d70 6c61 7465 732c 2070 686f 745b  templates, phot[
+000213d0: 2766 696c 7465 7273 275d 2c20 4d57 5f45  'filters'], MW_E
+000213e0: 4256 3d4d 575f 4542 5629 0a0a 2020 2020  BV=MW_EBV)..    
+000213f0: 7265 7475 726e 2070 686f 740a 0a0a 6465  return phot...de
+00021400: 6620 6765 745f 7370 6563 7472 756d 5f41  f get_spectrum_A
+00021410: 425f 6d61 6773 2873 7065 6374 7275 6d2c  B_mags(spectrum,
+00021420: 2062 616e 6470 6173 7365 733d 5b5d 293a   bandpasses=[]):
+00021430: 0a20 2020 2022 2222 0a20 2020 2049 6e74  .    """.    Int
+00021440: 6567 7261 7465 2061 2060 7e70 7973 796e  egrate a `~pysyn
+00021450: 7068 6f74 6020 7370 6563 7472 756d 2074  phot` spectrum t
+00021460: 6872 6f75 6768 2066 696c 7465 7220 6261  hrough filter ba
+00021470: 6e64 7061 7373 6573 0a0a 2020 2020 5061  ndpasses..    Pa
+00021480: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00021490: 2d2d 2d2d 2d2d 2d0a 2020 2020 7370 6563  -------.    spec
+000214a0: 7472 756d 203a 2074 7970 650a 0a20 2020  trum : type..   
+000214b0: 2062 616e 6470 6173 7365 7320 3a20 6c69   bandpasses : li
+000214c0: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+000214d0: 6f66 2060 7079 7379 6e70 686f 7460 2062  of `pysynphot` b
+000214e0: 616e 6470 6173 7320 6f62 6a65 6374 732c  andpass objects,
+000214f0: 2065 2e67 2e2c 0a0a 2020 2020 2020 2020   e.g.,..        
+00021500: 2020 203e 3e3e 2069 6d70 6f72 7420 7079     >>> import py
+00021510: 7379 6e70 686f 7420 6173 2053 0a20 2020  synphot as S.   
+00021520: 2020 2020 2020 2020 3e3e 3e20 6261 6e64          >>> band
+00021530: 7061 7373 6573 203d 205b 532e 4f62 7342  passes = [S.ObsB
+00021540: 616e 6470 6173 7328 2777 6663 332c 6972  andpass('wfc3,ir
+00021550: 2c66 3134 3077 2729 5d0a 0a0a 2020 2020  ,f140w')]...    
+00021560: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00021570: 2d2d 2d0a 2020 2020 6162 5f6d 6167 7320  ---.    ab_mags 
+00021580: 3a20 6469 6374 0a20 2020 2020 2020 2044  : dict.        D
+00021590: 6963 7469 6f6e 6172 7920 7769 7468 206b  ictionary with k
+000215a0: 6579 7320 6672 6f6d 2060 6261 6e64 7061  eys from `bandpa
+000215b0: 7373 6573 6020 616e 6420 7468 6520 696e  sses` and the in
+000215c0: 7465 6772 6174 6564 206d 6167 6e69 7475  tegrated magnitu
+000215d0: 6465 730a 0a20 2020 2022 2222 0a20 2020  des..    """.   
+000215e0: 2069 6d70 6f72 7420 7079 7379 6e70 686f   import pysynpho
+000215f0: 7420 6173 2053 0a20 2020 2066 6c61 7420  t as S.    flat 
+00021600: 3d20 532e 466c 6174 5370 6563 7472 756d  = S.FlatSpectrum
+00021610: 2830 2c20 666c 7578 756e 6974 733d 2741  (0, fluxunits='A
+00021620: 424d 6167 2729 0a20 2020 2061 625f 6d61  BMag').    ab_ma
+00021630: 6773 203d 204f 7264 6572 6564 4469 6374  gs = OrderedDict
+00021640: 2829 0a0a 2020 2020 666f 7220 6270 2069  ()..    for bp i
+00021650: 6e20 6261 6e64 7061 7373 6573 3a0a 2020  n bandpasses:.  
+00021660: 2020 2020 2020 666c 6174 5f6f 6273 203d        flat_obs =
+00021670: 2053 2e4f 6273 6572 7661 7469 6f6e 2866   S.Observation(f
+00021680: 6c61 742c 2062 7029 0a20 2020 2020 2020  lat, bp).       
+00021690: 2073 7065 635f 6f62 7320 3d20 532e 4f62   spec_obs = S.Ob
+000216a0: 7365 7276 6174 696f 6e28 7370 6563 7472  servation(spectr
+000216b0: 756d 2c20 6270 290a 2020 2020 2020 2020  um, bp).        
+000216c0: 6162 5f6d 6167 735b 6270 2e6e 616d 655d  ab_mags[bp.name]
+000216d0: 203d 202d 322e 352a 6e70 2e6c 6f67 3130   = -2.5*np.log10
+000216e0: 2873 7065 635f 6f62 732e 636f 756e 7472  (spec_obs.countr
+000216f0: 6174 6528 292f 666c 6174 5f6f 6273 2e63  ate()/flat_obs.c
+00021700: 6f75 6e74 7261 7465 2829 290a 0a20 2020  ountrate())..   
+00021710: 2072 6574 7572 6e20 6162 5f6d 6167 730a   return ab_mags.
+00021720: 0a0a 6465 6620 6c6f 675f 7a67 7269 6428  ..def log_zgrid(
+00021730: 7a72 3d5b 302e 372c 2033 2e34 5d2c 2064  zr=[0.7, 3.4], d
+00021740: 7a3d 302e 3031 293a 0a20 2020 2022 2222  z=0.01):.    """
+00021750: 4d61 6b65 2061 206c 6f67 6172 6974 686d  Make a logarithm
+00021760: 6963 616c 6c79 2073 7061 6365 6420 7265  ically spaced re
+00021770: 6473 6869 6674 2067 7269 640a 0a20 2020  dshift grid..   
+00021780: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00021790: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 207a  ----------.    z
+000217a0: 7220 3a20 5b66 6c6f 6174 2c20 666c 6f61  r : [float, floa
+000217b0: 745d 0a20 2020 2020 2020 204d 696e 696d  t].        Minim
+000217c0: 756d 2061 6e64 206d 6178 696d 756d 206f  um and maximum o
+000217d0: 6620 7468 6520 6465 7369 7265 6420 6772  f the desired gr
+000217e0: 6964 0a0a 2020 2020 647a 203a 2066 6c6f  id..    dz : flo
+000217f0: 6174 0a20 2020 2020 2020 2053 7465 7020  at.        Step 
+00021800: 7369 7a65 2c20 647a 2f28 312b 7a29 0a0a  size, dz/(1+z)..
+00021810: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00021820: 2d2d 2d2d 2d2d 2d0a 2020 2020 7a67 7269  -------.    zgri
+00021830: 6420 3a20 6172 7261 792d 6c69 6b65 0a20  d : array-like. 
+00021840: 2020 2020 2020 2052 6564 7368 6966 7420         Redshift 
+00021850: 6772 6964 0a0a 2020 2020 2222 220a 2020  grid..    """.  
+00021860: 2020 7a67 7269 6420 3d20 6e70 2e65 7870    zgrid = np.exp
+00021870: 286e 702e 6172 616e 6765 286e 702e 6c6f  (np.arange(np.lo
+00021880: 6728 312b 7a72 5b30 5d29 2c20 6e70 2e6c  g(1+zr[0]), np.l
+00021890: 6f67 2831 2b7a 725b 315d 292c 2064 7a29  og(1+zr[1]), dz)
+000218a0: 292d 310a 2020 2020 7265 7475 726e 207a  )-1.    return z
+000218b0: 6772 6964 0a0a 6465 6620 7472 6170 7a5f  grid..def trapz_
+000218c0: 6478 2878 293a 0a20 2020 2022 2222 0a20  dx(x):.    """. 
+000218d0: 2020 2052 6574 7572 6e20 7472 6170 657a     Return trapez
+000218e0: 6f69 6420 7275 6c65 2063 6f65 6666 6963  oid rule coeffic
+000218f0: 6965 6e74 732c 2075 7365 6675 6c20 666f  ients, useful fo
+00021900: 7220 6e75 6d65 7269 6361 6c20 696e 7465  r numerical inte
+00021910: 6772 6174 696f 6e20 0a20 2020 2075 7369  gration .    usi
+00021920: 6e67 2061 2064 6f74 2070 726f 6475 6374  ng a dot product
+00021930: 0a20 2020 200a 2020 2020 5061 7261 6d65  .    .    Parame
+00021940: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00021950: 2d2d 2d0a 2020 2020 7820 3a20 6172 7261  ---.    x : arra
+00021960: 792d 6c69 6b65 0a20 2020 2020 2020 2049  y-like.        I
+00021970: 6e64 6570 656e 6465 6e74 2076 6172 6961  ndependent varia
+00021980: 626c 650a 2020 2020 0a20 2020 2052 6574  ble.    .    Ret
+00021990: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+000219a0: 0a20 2020 2064 7820 3a20 6172 7261 795f  .    dx : array_
+000219b0: 6c69 6b65 0a20 2020 2020 2020 2043 6f65  like.        Coe
+000219c0: 6666 6963 6965 6e74 7320 666f 7220 7472  fficients for tr
+000219d0: 6170 657a 6f69 6461 6c20 7275 6c65 2069  apezoidal rule i
+000219e0: 6e74 6567 7261 7469 6f6e 2e0a 2020 2020  ntegration..    
+000219f0: 2020 2020 0a20 2020 2022 2222 0a20 2020      .    """.   
+00021a00: 2064 7820 3d20 6e70 2e7a 6572 6f73 5f6c   dx = np.zeros_l
+00021a10: 696b 6528 7829 0a20 2020 2064 6966 6620  ike(x).    diff 
+00021a20: 3d20 6e70 2e64 6966 6628 7829 2f32 2e0a  = np.diff(x)/2..
+00021a30: 2020 2020 6478 5b3a 2d31 5d20 2b3d 2064      dx[:-1] += d
+00021a40: 6966 660a 2020 2020 6478 5b31 3a5d 202b  iff.    dx[1:] +
+00021a50: 3d20 6469 6666 0a20 2020 2072 6574 7572  = diff.    retur
+00021a60: 6e20 6478 0a0a 0a64 6566 2067 6574 5f77  n dx...def get_w
+00021a70: 6373 5f70 7363 616c 6528 7763 732c 2073  cs_pscale(wcs, s
+00021a80: 6574 5f61 7474 7269 6275 7465 3d54 7275  et_attribute=Tru
+00021a90: 6529 3a0a 2020 2020 2222 2247 6574 2063  e):.    """Get c
+00021aa0: 6f72 7265 6374 2070 7363 616c 6520 6672  orrect pscale fr
+00021ab0: 6f6d 2061 2060 7e61 7374 726f 7079 2e77  om a `~astropy.w
+00021ac0: 6373 2e57 4353 6020 6f62 6a65 6374 0a0a  cs.WCS` object..
+00021ad0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00021ae0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00021af0: 2020 7763 7320 3a20 607e 6173 7472 6f70    wcs : `~astrop
+00021b00: 792e 7763 732e 5743 5360 206f 7220 607e  y.wcs.WCS` or `~
+00021b10: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+00021b20: 4865 6164 6572 600a 0a20 2020 2073 6574  Header`..    set
+00021b30: 5f61 7474 7269 6275 7465 203a 2062 6f6f  _attribute : boo
+00021b40: 6c0a 2020 2020 2020 2020 5365 7420 7468  l.        Set th
+00021b50: 6520 6070 7363 616c 6560 2061 7474 7269  e `pscale` attri
+00021b60: 6275 7465 206f 6e20 6077 6373 602c 2061  bute on `wcs`, a
+00021b70: 6c6f 6e67 2077 6974 6820 7265 7475 726e  long with return
+00021b80: 696e 6720 7468 6520 7661 6c75 652e 0a0a  ing the value...
+00021b90: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00021ba0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7073 6361  -------.    psca
+00021bb0: 6c65 203a 2066 6c6f 6174 0a20 2020 2020  le : float.     
+00021bc0: 2020 2050 6978 656c 2073 6361 6c65 2066     Pixel scale f
+00021bd0: 726f 6d20 6077 6373 2e63 6460 0a0a 2020  rom `wcs.cd`..  
+00021be0: 2020 2222 220a 2020 2020 6672 6f6d 206e    """.    from n
+00021bf0: 756d 7079 2069 6d70 6f72 7420 6c69 6e61  umpy import lina
+00021c00: 6c67 0a0a 2020 2020 6966 2069 7369 6e73  lg..    if isins
+00021c10: 7461 6e63 6528 7763 732c 2070 7966 6974  tance(wcs, pyfit
+00021c20: 732e 4865 6164 6572 293a 0a20 2020 2020  s.Header):.     
+00021c30: 2020 2077 6373 203d 2070 7977 6373 2e57     wcs = pywcs.W
+00021c40: 4353 2877 6373 2c20 7265 6c61 783d 5472  CS(wcs, relax=Tr
+00021c50: 7565 290a 0a20 2020 2069 6620 6861 7361  ue)..    if hasa
+00021c60: 7474 7228 7763 732e 7763 732c 2027 6364  ttr(wcs.wcs, 'cd
+00021c70: 2729 3a0a 2020 2020 2020 2020 6465 7420  '):.        det 
+00021c80: 3d20 6c69 6e61 6c67 2e64 6574 2877 6373  = linalg.det(wcs
+00021c90: 2e77 6373 2e63 6429 0a20 2020 2065 6c73  .wcs.cd).    els
+00021ca0: 653a 0a20 2020 2020 2020 2064 6574 203d  e:.        det =
+00021cb0: 206c 696e 616c 672e 6465 7428 7763 732e   linalg.det(wcs.
+00021cc0: 7763 732e 7063 290a 0a20 2020 2070 7363  wcs.pc)..    psc
+00021cd0: 616c 6520 3d20 6e70 2e73 7172 7428 6e70  ale = np.sqrt(np
+00021ce0: 2e61 6273 2864 6574 2929 2a33 3630 302e  .abs(det))*3600.
+00021cf0: 0a20 2020 200a 2020 2020 7769 7468 2077  .    .    with w
+00021d00: 6172 6e69 6e67 732e 6361 7463 685f 7761  arnings.catch_wa
+00021d10: 726e 696e 6773 2829 3a0a 2020 2020 2020  rnings():.      
+00021d20: 2020 7761 726e 696e 6773 2e66 696c 7465    warnings.filte
+00021d30: 7277 6172 6e69 6e67 7328 2769 676e 6f72  rwarnings('ignor
+00021d40: 6527 2c20 0a20 2020 2020 2020 2020 2020  e', .           
+00021d50: 2020 2020 2020 2027 6364 656c 7420 7769         'cdelt wi
+00021d60: 6c6c 2062 6520 6967 6e6f 7265 6420 7369  ll be ignored si
+00021d70: 6e63 6520 6364 2069 7320 7072 6573 656e  nce cd is presen
+00021d80: 7427 2c20 5275 6e74 696d 6557 6172 6e69  t', RuntimeWarni
+00021d90: 6e67 290a 2020 2020 2020 2020 0a20 2020  ng).        .   
+00021da0: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+00021db0: 7763 732e 7763 732c 2027 6364 656c 7427  wcs.wcs, 'cdelt'
+00021dc0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+00021dd0: 7363 616c 6520 2a3d 2077 6373 2e77 6373  scale *= wcs.wcs
+00021de0: 2e63 6465 6c74 5b30 5d0a 2020 2020 2020  .cdelt[0].      
+00021df0: 2020 0a20 2020 2077 6373 2e70 7363 616c    .    wcs.pscal
+00021e00: 6520 3d20 7073 6361 6c65 0a0a 2020 2020  e = pscale..    
+00021e10: 7265 7475 726e 2070 7363 616c 650a 0a0a  return pscale...
+00021e20: 6465 6620 7472 616e 7366 6f72 6d5f 7763  def transform_wc
+00021e30: 7328 696e 5f77 6373 2c20 7472 616e 736c  s(in_wcs, transl
+00021e40: 6174 696f 6e3d 5b30 2e2c 2030 2e5d 2c20  ation=[0., 0.], 
+00021e50: 726f 7461 7469 6f6e 3d30 2e2c 2073 6361  rotation=0., sca
+00021e60: 6c65 3d31 2e29 3a0a 2020 2020 2222 2255  le=1.):.    """U
+00021e70: 7064 6174 6520 5743 5320 7769 7468 2073  pdate WCS with s
+00021e80: 6869 6674 2c20 726f 7461 7469 6f6e 2c20  hift, rotation, 
+00021e90: 2620 7363 616c 650a 0a20 2020 2050 6172  & scale..    Par
+00021ea0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00021eb0: 2d2d 2d2d 2d2d 0a20 2020 2069 6e5f 7763  ------.    in_wc
+00021ec0: 733a 2060 7e61 7374 726f 7079 2e77 6373  s: `~astropy.wcs
+00021ed0: 2e57 4353 600a 2020 2020 2020 2020 496e  .WCS`.        In
+00021ee0: 7075 7420 5743 530a 0a20 2020 2074 7261  put WCS..    tra
+00021ef0: 6e73 6c61 7469 6f6e 3a20 5b66 6c6f 6174  nslation: [float
+00021f00: 2c20 666c 6f61 745d 0a20 2020 2020 2020  , float].       
+00021f10: 2078 7368 6966 7420 2620 7973 6869 6674   xshift & yshift
+00021f20: 2069 6e20 7069 7865 6c73 0a0a 2020 2020   in pixels..    
+00021f30: 726f 7461 7469 6f6e 3a20 666c 6f61 740a  rotation: float.
+00021f40: 2020 2020 2020 2020 4343 5720 726f 7461          CCW rota
+00021f50: 7469 6f6e 2028 746f 7761 7264 7320 4561  tion (towards Ea
+00021f60: 7374 292c 2072 6164 6961 6e73 0a0a 2020  st), radians..  
+00021f70: 2020 7363 616c 653a 2066 6c6f 6174 0a20    scale: float. 
+00021f80: 2020 2020 2020 2050 6978 656c 2073 6361         Pixel sca
+00021f90: 6c65 2066 6163 746f 720a 0a20 2020 2052  le factor..    R
+00021fa0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+00021fb0: 2d2d 0a20 2020 206f 7574 5f77 6373 3a20  --.    out_wcs: 
+00021fc0: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
+00021fd0: 5360 0a20 2020 2020 2020 204d 6f64 6966  S`.        Modif
+00021fe0: 6965 6420 5743 530a 2020 2020 2222 220a  ied WCS.    """.
+00021ff0: 2020 2020 6f75 745f 7763 7320 3d20 696e      out_wcs = in
+00022000: 5f77 6373 2e64 6565 7063 6f70 7928 290a  _wcs.deepcopy().
+00022010: 0a20 2020 2023 6f75 745f 7763 732e 7763  .    #out_wcs.wc
+00022020: 732e 6372 7069 7820 2b3d 206e 702e 6172  s.crpix += np.ar
+00022030: 7261 7928 7472 616e 736c 6174 696f 6e29  ray(translation)
+00022040: 0a0a 2020 2020 2320 436f 6d70 7574 6520  ..    # Compute 
+00022050: 7368 6966 7420 666f 7220 6372 7661 6c2c  shift for crval,
+00022060: 206e 6f74 2063 7270 6978 0a20 2020 2063   not crpix.    c
+00022070: 7276 616c 203d 2069 6e5f 7763 732e 616c  rval = in_wcs.al
+00022080: 6c5f 7069 7832 776f 726c 6428 5b69 6e5f  l_pix2world([in_
+00022090: 7763 732e 7763 732e 6372 7069 782d 6e70  wcs.wcs.crpix-np
+000220a0: 2e61 7272 6179 2874 7261 6e73 6c61 7469  .array(translati
+000220b0: 6f6e 295d 2c0a 2020 2020 2020 2020 2020  on)],.          
+000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220d0: 2020 2020 2020 2020 2020 2031 292e 666c             1).fl
+000220e0: 6174 7465 6e28 290a 0a20 2020 2023 2043  atten()..    # C
+000220f0: 6f6d 7075 7465 2073 6869 6674 2061 7420  ompute shift at 
+00022100: 696d 6167 6520 6365 6e74 6572 0a20 2020  image center.   
+00022110: 2069 6620 6861 7361 7474 7228 696e 5f77   if hasattr(in_w
+00022120: 6373 2c20 275f 6e61 7869 7331 2729 3a0a  cs, '_naxis1'):.
+00022130: 2020 2020 2020 2020 7265 6670 6978 203d          refpix =
+00022140: 206e 702e 6172 7261 7928 5b69 6e5f 7763   np.array([in_wc
+00022150: 732e 5f6e 6178 6973 312f 322e 2c20 696e  s._naxis1/2., in
+00022160: 5f77 6373 2e5f 6e61 7869 7332 2f32 2e5d  _wcs._naxis2/2.]
+00022170: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00022180: 2020 2020 7265 6670 6978 203d 206e 702e      refpix = np.
+00022190: 6172 7261 7928 696e 5f77 6373 2e5f 6e61  array(in_wcs._na
+000221a0: 7869 7329 2f32 2e0a 0a20 2020 2063 3020  xis)/2...    c0 
+000221b0: 3d20 696e 5f77 6373 2e61 6c6c 5f70 6978  = in_wcs.all_pix
+000221c0: 3277 6f72 6c64 285b 7265 6670 6978 5d2c  2world([refpix],
+000221d0: 2031 292e 666c 6174 7465 6e28 290a 2020   1).flatten().  
+000221e0: 2020 6331 203d 2069 6e5f 7763 732e 616c    c1 = in_wcs.al
+000221f0: 6c5f 7069 7832 776f 726c 6428 5b72 6566  l_pix2world([ref
+00022200: 7069 782d 6e70 2e61 7272 6179 2874 7261  pix-np.array(tra
+00022210: 6e73 6c61 7469 6f6e 295d 2c20 3129 2e66  nslation)], 1).f
+00022220: 6c61 7474 656e 2829 0a0a 2020 2020 6f75  latten()..    ou
+00022230: 745f 7763 732e 7763 732e 6372 7661 6c20  t_wcs.wcs.crval 
+00022240: 2b3d 2063 312d 6330 0a0a 2020 2020 7468  += c1-c0..    th
+00022250: 6574 6120 3d20 2d72 6f74 6174 696f 6e0a  eta = -rotation.
+00022260: 2020 2020 5f6d 6174 203d 206e 702e 6172      _mat = np.ar
+00022270: 7261 7928 5b5b 6e70 2e63 6f73 2874 6865  ray([[np.cos(the
+00022280: 7461 292c 202d 6e70 2e73 696e 2874 6865  ta), -np.sin(the
+00022290: 7461 295d 2c0a 2020 2020 2020 2020 2020  ta)],.          
+000222a0: 2020 2020 2020 2020 2020 205b 6e70 2e73             [np.s
+000222b0: 696e 2874 6865 7461 292c 206e 702e 636f  in(theta), np.co
+000222c0: 7328 7468 6574 6129 5d5d 290a 0a20 2020  s(theta)]])..   
+000222d0: 2074 7279 3a0a 2020 2020 2020 2020 6f75   try:.        ou
+000222e0: 745f 7763 732e 7763 732e 6364 5b3a 322c  t_wcs.wcs.cd[:2,
+000222f0: 3a32 5d20 3d20 6e70 2e64 6f74 286f 7574  :2] = np.dot(out
+00022300: 5f77 6373 2e77 6373 2e63 645b 3a32 2c3a  _wcs.wcs.cd[:2,:
+00022310: 325d 2c20 5f6d 6174 292f 7363 616c 650a  2], _mat)/scale.
+00022320: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00022330: 2020 2020 6f75 745f 7763 732e 7763 732e      out_wcs.wcs.
+00022340: 7063 203d 206e 702e 646f 7428 6f75 745f  pc = np.dot(out_
+00022350: 7763 732e 7763 732e 7063 2c20 5f6d 6174  wcs.wcs.pc, _mat
+00022360: 292f 7363 616c 650a 0a20 2020 206f 7574  )/scale..    out
+00022370: 5f77 6373 2e70 7363 616c 6520 3d20 6765  _wcs.pscale = ge
+00022380: 745f 7763 735f 7073 6361 6c65 286f 7574  t_wcs_pscale(out
+00022390: 5f77 6373 290a 2020 2020 236f 7574 5f77  _wcs).    #out_w
+000223a0: 6373 2e77 6373 2e63 7270 6978 202a 3d20  cs.wcs.crpix *= 
+000223b0: 7363 616c 650a 2020 2020 6966 2068 6173  scale.    if has
+000223c0: 6174 7472 286f 7574 5f77 6373 2c20 2770  attr(out_wcs, 'p
+000223d0: 6978 656c 5f73 6861 7065 2729 3a0a 2020  ixel_shape'):.  
+000223e0: 2020 2020 2020 5f6e 6178 6973 3120 3d20        _naxis1 = 
+000223f0: 696e 7428 6e70 2e72 6f75 6e64 286f 7574  int(np.round(out
+00022400: 5f77 6373 2e70 6978 656c 5f73 6861 7065  _wcs.pixel_shape
+00022410: 5b30 5d2a 7363 616c 6529 290a 2020 2020  [0]*scale)).    
+00022420: 2020 2020 5f6e 6178 6973 3220 3d20 696e      _naxis2 = in
+00022430: 7428 6e70 2e72 6f75 6e64 286f 7574 5f77  t(np.round(out_w
+00022440: 6373 2e70 6978 656c 5f73 6861 7065 5b31  cs.pixel_shape[1
+00022450: 5d2a 7363 616c 6529 290a 2020 2020 2020  ]*scale)).      
+00022460: 2020 6f75 745f 7763 732e 5f6e 6178 6973    out_wcs._naxis
+00022470: 203d 205b 5f6e 6178 6973 312c 205f 6e61   = [_naxis1, _na
+00022480: 7869 7332 5d0a 2020 2020 656c 6966 2068  xis2].    elif h
+00022490: 6173 6174 7472 286f 7574 5f77 6373 2c20  asattr(out_wcs, 
+000224a0: 275f 6e61 7869 7331 2729 3a0a 2020 2020  '_naxis1'):.    
+000224b0: 2020 2020 6f75 745f 7763 732e 5f6e 6178      out_wcs._nax
+000224c0: 6973 3120 3d20 696e 7428 6e70 2e72 6f75  is1 = int(np.rou
+000224d0: 6e64 286f 7574 5f77 6373 2e5f 6e61 7869  nd(out_wcs._naxi
+000224e0: 7331 2a73 6361 6c65 2929 0a20 2020 2020  s1*scale)).     
+000224f0: 2020 206f 7574 5f77 6373 2e5f 6e61 7869     out_wcs._naxi
+00022500: 7332 203d 2069 6e74 286e 702e 726f 756e  s2 = int(np.roun
+00022510: 6428 6f75 745f 7763 732e 5f6e 6178 6973  d(out_wcs._naxis
+00022520: 322a 7363 616c 6529 290a 0a20 2020 2072  2*scale))..    r
+00022530: 6574 7572 6e20 6f75 745f 7763 730a 0a0a  eturn out_wcs...
+00022540: 6465 6620 7369 705f 726f 7439 3028 696e  def sip_rot90(in
+00022550: 7075 742c 2072 6f74 2c20 7265 7665 7273  put, rot, revers
+00022560: 653d 4661 6c73 652c 2076 6572 626f 7365  e=False, verbose
+00022570: 3d46 616c 7365 2c20 636f 6d70 6172 653d  =False, compare=
+00022580: 4661 6c73 6529 3a0a 2020 2020 2222 220a  False):.    """.
+00022590: 2020 2020 526f 7461 7465 2061 2053 4950      Rotate a SIP
+000225a0: 2057 4353 2062 7920 696e 6372 656d 656e   WCS by incremen
+000225b0: 7473 206f 6620 3930 2064 6567 7265 6573  ts of 90 degrees
+000225c0: 2075 7369 6e67 2064 6972 6563 7420 7472   using direct tr
+000225d0: 616e 7366 6f72 6d61 7469 6f6e 730a 2020  ansformations.  
+000225e0: 2020 6265 7477 6565 6e20 7820 2f20 7920    between x / y 
+000225f0: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
+00022600: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00022610: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00022620: 2020 2069 6e70 7574 203a 2060 7e61 7374     input : `~ast
+00022630: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
+00022640: 6465 7260 206f 7220 607e 6173 7472 6f70  der` or `~astrop
+00022650: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
+00022660: 2020 2048 6561 6465 7220 6f72 2057 4353     Header or WCS
+00022670: 0a20 2020 200a 2020 2020 726f 7420 3a20  .    .    rot : 
+00022680: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
+00022690: 6572 206f 6620 7469 6d65 7320 746f 2072  er of times to r
+000226a0: 6f74 6174 6520 7468 6520 5743 5320 3930  otate the WCS 90
+000226b0: 2064 6567 7265 6573 202a 636c 6f63 6b77   degrees *clockw
+000226c0: 6973 652a 2c20 616e 616c 6f67 6f75 730a  ise*, analogous.
+000226d0: 2020 2020 2020 2020 746f 2060 6e75 6d70          to `nump
+000226e0: 792e 726f 7439 3060 0a20 2020 200a 2020  y.rot90`.    .  
+000226f0: 2020 7265 7665 7273 6520 3a20 626f 6f6c    reverse : bool
+00022700: 0a20 2020 2020 2020 2049 6620 6069 6e70  .        If `inp
+00022710: 7574 6020 6973 2061 2068 6561 6465 7220  ut` is a header 
+00022720: 616e 6420 696e 636c 7564 6573 2061 206b  and includes a k
+00022730: 6579 776f 7264 2060 6052 4f54 3930 6060  eyword ``ROT90``
+00022740: 2c20 7468 656e 2075 6e64 6f20 0a20 2020  , then undo .   
+00022750: 2020 2020 2074 6865 2072 6f74 6174 696f       the rotatio
+00022760: 6e20 616e 6420 7265 6d6f 7665 2074 6865  n and remove the
+00022770: 206b 6579 776f 7264 2066 726f 6d20 7468   keyword from th
+00022780: 6520 6f75 7470 7574 2068 6561 6465 720a  e output header.
+00022790: 2020 2020 2020 2020 0a20 2020 2052 6574          .    Ret
+000227a0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+000227b0: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
+000227c0: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+000227d0: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
+000227e0: 526f 7461 7465 6420 5743 5320 6865 6164  Rotated WCS head
+000227f0: 6572 0a20 2020 2020 2020 200a 2020 2020  er.        .    
+00022800: 7763 7320 3a20 607e 6173 7472 6f70 792e  wcs : `~astropy.
+00022810: 7763 732e 5743 5360 0a20 2020 2020 2020  wcs.WCS`.       
+00022820: 2052 6f74 6174 6564 2057 4353 0a20 2020   Rotated WCS.   
+00022830: 200a 2020 2020 6465 7363 203a 2073 7472   .    desc : str
+00022840: 0a20 2020 2020 2020 2044 6573 6372 6970  .        Descrip
+00022850: 7469 6f6e 206f 6620 7468 6520 7472 616e  tion of the tran
+00022860: 7366 6f72 6d20 6173 736f 6369 6174 6564  sform associated
+00022870: 2077 6974 6820 6060 726f 7460 602c 2065   with ``rot``, e
+00022880: 2e67 2c20 0a20 2020 2020 2020 2060 6078  .g, .        ``x
+00022890: 3d6e 782d 782c 2079 3d6e 792d 7960 6020  =nx-x, y=ny-y`` 
+000228a0: 666f 7220 6060 726f 743d c2b1 3260 602e  for ``rot=..2``.
+000228b0: 0a20 2020 2020 2020 200a 2020 2020 2222  .        .    ""
+000228c0: 220a 2020 2020 696d 706f 7274 2063 6f70  ".    import cop
+000228d0: 790a 2020 2020 696d 706f 7274 2061 7374  y.    import ast
+000228e0: 726f 7079 2e69 6f2e 6669 7473 0a20 2020  ropy.io.fits.   
+000228f0: 2069 6d70 6f72 7420 6173 7472 6f70 792e   import astropy.
+00022900: 7763 730a 2020 2020 696d 706f 7274 206d  wcs.    import m
+00022910: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
+00022920: 2061 7320 706c 740a 2020 2020 0a20 2020   as plt.    .   
+00022930: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+00022940: 6e70 7574 2c20 6173 7472 6f70 792e 696f  nput, astropy.io
+00022950: 2e66 6974 732e 4865 6164 6572 293a 0a20  .fits.Header):. 
+00022960: 2020 2020 2020 206f 7269 6720 3d20 636f         orig = co
+00022970: 7079 2e64 6565 7063 6f70 7928 696e 7075  py.deepcopy(inpu
+00022980: 7429 0a20 2020 2020 2020 206e 6577 203d  t).        new =
+00022990: 2063 6f70 792e 6465 6570 636f 7079 2869   copy.deepcopy(i
+000229a0: 6e70 7574 290a 2020 2020 2020 2020 0a20  nput).        . 
+000229b0: 2020 2020 2020 2069 6620 2827 524f 5439         if ('ROT9
+000229c0: 3027 2069 6e20 696e 7075 7429 3a0a 2020  0' in input):.  
+000229d0: 2020 2020 2020 2020 2020 6966 2072 6576            if rev
+000229e0: 6572 7365 3a0a 2020 2020 2020 2020 2020  erse:.          
+000229f0: 2020 2020 2020 726f 7420 3d20 2d6f 7269        rot = -ori
+00022a00: 675b 2752 4f54 3930 275d 0a20 2020 2020  g['ROT90'].     
+00022a10: 2020 2020 2020 2020 2020 206e 6577 2e72             new.r
+00022a20: 656d 6f76 6528 2752 4f54 3930 2729 0a20  emove('ROT90'). 
+00022a30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00022a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022a50: 206e 6577 5b27 524f 5439 3027 5d20 3d20   new['ROT90'] = 
+00022a60: 6f72 6967 5b27 524f 5439 3027 5d20 2b20  orig['ROT90'] + 
+00022a70: 726f 740a 2020 2020 2020 2020 656c 7365  rot.        else
+00022a80: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+00022a90: 775b 2752 4f54 3930 275d 203d 2072 6f74  w['ROT90'] = rot
+00022aa0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00022ab0: 2020 206f 7269 6720 3d20 746f 5f68 6561     orig = to_hea
+00022ac0: 6465 7228 696e 7075 7429 0a20 2020 2020  der(input).     
+00022ad0: 2020 206e 6577 203d 2074 6f5f 6865 6164     new = to_head
+00022ae0: 6572 2869 6e70 7574 290a 0a20 2020 206f  er(input)..    o
+00022af0: 7269 675f 7763 7320 3d20 7079 7763 732e  rig_wcs = pywcs.
+00022b00: 5743 5328 6f72 6967 2c20 7265 6c61 783d  WCS(orig, relax=
+00022b10: 5472 7565 290a 0a20 2020 2023 2323 2043  True)..    ### C
+00022b20: 4420 3d20 5b5b 6472 612f 6478 2c20 6472  D = [[dra/dx, dr
+00022b30: 612f 6479 5d2c 205b 6464 652f 6478 2c20  a/dy], [dde/dx, 
+00022b40: 6464 652f 6479 5d5d 0a20 2020 2023 2323  dde/dy]].    ###
+00022b50: 2078 203d 2061 5f69 5f6a 202a 2075 2a2a   x = a_i_j * u**
+00022b60: 6920 2a20 762a 2a6a 0a20 2020 2023 2323  i * v**j.    ###
+00022b70: 2079 203d 2062 5f69 5f6a 202a 2075 2a2a   y = b_i_j * u**
+00022b80: 6920 2a20 762a 2a6a 0a20 2020 200a 2020  i * v**j.    .  
+00022b90: 2020 6978 203d 2031 0a20 2020 200a 2020    ix = 1.    .  
+00022ba0: 2020 6966 2063 6f6d 7061 7265 3a0a 2020    if compare:.  
+00022bb0: 2020 2020 2020 7861 7272 203d 206e 702e        xarr = np.
+00022bc0: 6172 616e 6765 2830 2c32 3034 382c 3634  arange(0,2048,64
+00022bd0: 290a 2020 2020 2020 2020 7870 2c20 7970  ).        xp, yp
+00022be0: 203d 206e 702e 6d65 7368 6772 6964 2878   = np.meshgrid(x
+00022bf0: 6172 722c 2078 6172 7229 0a20 2020 2020  arr, xarr).     
+00022c00: 2020 2072 6420 3d20 6f72 6967 5f77 6373     rd = orig_wcs
+00022c10: 2e61 6c6c 5f70 6978 3277 6f72 6c64 2878  .all_pix2world(x
+00022c20: 702c 2079 702c 2069 7829 0a0a 2020 2020  p, yp, ix)..    
+00022c30: 6966 2072 6f74 2025 2034 203d 3d20 313a  if rot % 4 == 1:
+00022c40: 0a20 2020 2020 2020 2023 2043 5720 3930  .        # CW 90
+00022c50: 2064 6567 203a 2078 203d 2079 2c20 7920   deg : x = y, y 
+00022c60: 3d20 286e 7820 2d20 7829 2c20 753d 762c  = (nx - x), u=v,
+00022c70: 2076 3d2d 750a 2020 2020 2020 2020 6465   v=-u.        de
+00022c80: 7363 203d 2027 783d 792c 2079 3d6e 782d  sc = 'x=y, y=nx-
+00022c90: 7827 0a20 2020 2020 2020 200a 2020 2020  x'.        .    
+00022ca0: 2020 2020 6e65 775b 2743 5250 4958 3127      new['CRPIX1'
+00022cb0: 5d20 3d20 6f72 6967 5b27 4352 5049 5832  ] = orig['CRPIX2
+00022cc0: 275d 0a20 2020 2020 2020 206e 6577 5b27  '].        new['
+00022cd0: 4352 5049 5832 275d 203d 206f 7269 675b  CRPIX2'] = orig[
+00022ce0: 274e 4158 4953 3127 5d20 2d20 6f72 6967  'NAXIS1'] - orig
+00022cf0: 5b27 4352 5049 5831 275d 202b 2031 0a0a  ['CRPIX1'] + 1..
+00022d00: 2020 2020 2020 2020 6e65 775b 2743 4431          new['CD1
+00022d10: 5f31 275d 203d 206f 7269 675b 2743 4431  _1'] = orig['CD1
+00022d20: 5f32 275d 0a20 2020 2020 2020 206e 6577  _2'].        new
+00022d30: 5b27 4344 315f 3227 5d20 3d20 2d6f 7269  ['CD1_2'] = -ori
+00022d40: 675b 2743 4431 5f31 275d 0a20 2020 2020  g['CD1_1'].     
+00022d50: 2020 206e 6577 5b27 4344 325f 3127 5d20     new['CD2_1'] 
+00022d60: 3d20 6f72 6967 5b27 4344 325f 3227 5d0a  = orig['CD2_2'].
+00022d70: 2020 2020 2020 2020 6e65 775b 2743 4432          new['CD2
+00022d80: 5f32 275d 203d 202d 6f72 6967 5b27 4344  _2'] = -orig['CD
+00022d90: 325f 3127 5d0a 0a20 2020 2020 2020 2066  2_1']..        f
+00022da0: 6f72 2069 2069 6e20 7261 6e67 6528 6e65  or i in range(ne
+00022db0: 775b 2741 5f4f 5244 4552 275d 2b31 293a  w['A_ORDER']+1):
+00022dc0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00022dd0: 206a 2069 6e20 7261 6e67 6528 6e65 775b   j in range(new[
+00022de0: 2742 5f4f 5244 4552 275d 2b31 293a 0a20  'B_ORDER']+1):. 
+00022df0: 2020 2020 2020 2020 2020 2020 2020 2041                 A
+00022e00: 696a 2020 3d20 6627 415f 7b69 7d5f 7b6a  ij  = f'A_{i}_{j
+00022e10: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00022e20: 2020 2069 6620 4169 6a20 6e6f 7420 696e     if Aij not in
+00022e30: 206e 6577 3a0a 2020 2020 2020 2020 2020   new:.          
+00022e40: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00022e50: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00022e60: 2020 2020 6e65 775b 6627 415f 7b69 7d5f      new[f'A_{i}_
+00022e70: 7b6a 7d27 5d20 3d20 6f72 6967 5b66 2742  {j}'] = orig[f'B
+00022e80: 5f7b 6a7d 5f7b 697d 275d 2a28 2d31 292a  _{j}_{i}']*(-1)*
+00022e90: 2a6a 0a20 2020 2020 2020 2020 2020 2020  *j.             
+00022ea0: 2020 206e 6577 5b66 2742 5f7b 697d 5f7b     new[f'B_{i}_{
+00022eb0: 6a7d 275d 203d 206f 7269 675b 6627 415f  j}'] = orig[f'A_
+00022ec0: 7b6a 7d5f 7b69 7d27 5d2a 282d 3129 2a2a  {j}_{i}']*(-1)**
+00022ed0: 6a2a 2d31 0a0a 2020 2020 2020 2020 6e65  j*-1..        ne
+00022ee0: 775f 7763 7320 3d20 6173 7472 6f70 792e  w_wcs = astropy.
+00022ef0: 7763 732e 5743 5328 6e65 772c 2072 656c  wcs.WCS(new, rel
+00022f00: 6178 3d54 7275 6529 0a20 2020 2020 2020  ax=True).       
+00022f10: 200a 2020 2020 2020 2020 6966 2063 6f6d   .        if com
+00022f20: 7061 7265 3a0a 2020 2020 2020 2020 2020  pare:.          
+00022f30: 2020 7872 2c20 7972 203d 206e 6577 5f77    xr, yr = new_w
+00022f40: 6373 2e61 6c6c 5f77 6f72 6c64 3270 6978  cs.all_world2pix
+00022f50: 282a 7264 2c20 6978 290a 2020 2020 2020  (*rd, ix).      
+00022f60: 2020 2020 2020 786f 203d 2079 700a 2020        xo = yp.  
+00022f70: 2020 2020 2020 2020 2020 796f 203d 206f            yo = o
+00022f80: 7269 675b 274e 4158 4953 3127 5d20 2d20  rig['NAXIS1'] - 
+00022f90: 7870 0a0a 2020 2020 656c 6966 2072 6f74  xp..    elif rot
+00022fa0: 2025 2034 203d 3d20 333a 0a20 2020 2020   % 4 == 3:.     
+00022fb0: 2020 2023 2043 5720 3237 3020 6465 6720     # CW 270 deg 
+00022fc0: 3a20 7920 3d20 782c 2078 203d 2028 6e79  : y = x, x = (ny
+00022fd0: 202d 2075 292c 2075 3d2d 762c 2076 3d75   - u), u=-v, v=u
+00022fe0: 0a20 2020 2020 2020 2064 6573 6320 3d20  .        desc = 
+00022ff0: 2778 3d6e 792d 792c 2079 3d78 270a 0a20  'x=ny-y, y=x'.. 
+00023000: 2020 2020 2020 206e 6577 5b27 4352 5049         new['CRPI
+00023010: 5831 275d 203d 206f 7269 675b 274e 4158  X1'] = orig['NAX
+00023020: 4953 3227 5d20 2d20 6f72 6967 5b27 4352  IS2'] - orig['CR
+00023030: 5049 5832 275d 202b 2031 0a20 2020 2020  PIX2'] + 1.     
+00023040: 2020 206e 6577 5b27 4352 5049 5832 275d     new['CRPIX2']
+00023050: 203d 206f 7269 675b 2743 5250 4958 3127   = orig['CRPIX1'
+00023060: 5d0a 0a20 2020 2020 2020 206e 6577 5b27  ]..        new['
+00023070: 4344 315f 3127 5d20 3d20 2d6f 7269 675b  CD1_1'] = -orig[
+00023080: 2743 4431 5f32 275d 0a20 2020 2020 2020  'CD1_2'].       
+00023090: 206e 6577 5b27 4344 315f 3227 5d20 3d20   new['CD1_2'] = 
+000230a0: 6f72 6967 5b27 4344 315f 3127 5d0a 2020  orig['CD1_1'].  
+000230b0: 2020 2020 2020 6e65 775b 2743 4432 5f31        new['CD2_1
+000230c0: 275d 203d 202d 6f72 6967 5b27 4344 325f  '] = -orig['CD2_
+000230d0: 3227 5d0a 2020 2020 2020 2020 6e65 775b  2'].        new[
+000230e0: 2743 4432 5f32 275d 203d 206f 7269 675b  'CD2_2'] = orig[
+000230f0: 2743 4432 5f31 275d 0a0a 2020 2020 2020  'CD2_1']..      
+00023100: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00023110: 286e 6577 5b27 415f 4f52 4445 5227 5d2b  (new['A_ORDER']+
+00023120: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+00023130: 666f 7220 6a20 696e 2072 616e 6765 286e  for j in range(n
+00023140: 6577 5b27 425f 4f52 4445 5227 5d2b 3129  ew['B_ORDER']+1)
+00023150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023160: 2020 4169 6a20 203d 2066 2741 5f7b 697d    Aij  = f'A_{i}
+00023170: 5f7b 6a7d 270a 2020 2020 2020 2020 2020  _{j}'.          
+00023180: 2020 2020 2020 6966 2041 696a 206e 6f74        if Aij not
+00023190: 2069 6e20 6e65 773a 0a20 2020 2020 2020   in new:.       
+000231a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000231b0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+000231c0: 2020 2020 2020 206e 6577 5b66 2741 5f7b         new[f'A_{
+000231d0: 697d 5f7b 6a7d 275d 203d 206f 7269 675b  i}_{j}'] = orig[
+000231e0: 6627 425f 7b6a 7d5f 7b69 7d27 5d2a 282d  f'B_{j}_{i}']*(-
+000231f0: 3129 2a2a 692a 2d31 0a20 2020 2020 2020  1)**i*-1.       
+00023200: 2020 2020 2020 2020 206e 6577 5b66 2742           new[f'B
+00023210: 5f7b 697d 5f7b 6a7d 275d 203d 206f 7269  _{i}_{j}'] = ori
+00023220: 675b 6627 415f 7b6a 7d5f 7b69 7d27 5d2a  g[f'A_{j}_{i}']*
+00023230: 282d 3129 2a2a 690a 0a20 2020 2020 2020  (-1)**i..       
+00023240: 206e 6577 5f77 6373 203d 2061 7374 726f   new_wcs = astro
+00023250: 7079 2e77 6373 2e57 4353 286e 6577 2c20  py.wcs.WCS(new, 
+00023260: 7265 6c61 783d 5472 7565 290a 2020 2020  relax=True).    
+00023270: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
+00023280: 636f 6d70 6172 653a 0a20 2020 2020 2020  compare:.       
+00023290: 2020 2020 2078 722c 2079 7220 3d20 6e65       xr, yr = ne
+000232a0: 775f 7763 732e 616c 6c5f 776f 726c 6432  w_wcs.all_world2
+000232b0: 7069 7828 2a72 642c 2069 7829 0a20 2020  pix(*rd, ix).   
+000232c0: 2020 2020 2020 2020 2078 6f20 3d20 6f72           xo = or
+000232d0: 6967 5b27 4e41 5849 5332 275d 202d 2079  ig['NAXIS2'] - y
+000232e0: 700a 2020 2020 2020 2020 2020 2020 796f  p.            yo
+000232f0: 203d 2078 700a 0a0a 2020 2020 656c 6966   = xp...    elif
+00023300: 2072 6f74 2025 2034 203d 3d20 323a 0a20   rot % 4 == 2:. 
+00023310: 2020 2020 2020 2023 2043 5720 3138 3020         # CW 180 
+00023320: 6465 6720 3a20 783d 6e78 2d78 2c20 793d  deg : x=nx-x, y=
+00023330: 6e79 2d79 2c20 753d 2d75 2c20 763d 2d76  ny-y, u=-u, v=-v
+00023340: 0a20 2020 2020 2020 2064 6573 6320 3d20  .        desc = 
+00023350: 2778 3d6e 782d 782c 2079 3d6e 792d 7927  'x=nx-x, y=ny-y'
+00023360: 0a0a 2020 2020 2020 2020 6e65 775b 2743  ..        new['C
+00023370: 5250 4958 3127 5d20 3d20 6f72 6967 5b27  RPIX1'] = orig['
+00023380: 4e41 5849 5331 275d 202d 206f 7269 675b  NAXIS1'] - orig[
+00023390: 2743 5250 4958 3127 5d20 2b20 310a 2020  'CRPIX1'] + 1.  
+000233a0: 2020 2020 2020 6e65 775b 2743 5250 4958        new['CRPIX
+000233b0: 3227 5d20 3d20 6f72 6967 5b27 4e41 5849  2'] = orig['NAXI
+000233c0: 5332 275d 202d 206f 7269 675b 2743 5250  S2'] - orig['CRP
+000233d0: 4958 3227 5d20 2b20 310a 0a20 2020 2020  IX2'] + 1..     
+000233e0: 2020 206e 6577 5b27 4344 315f 3127 5d20     new['CD1_1'] 
+000233f0: 3d20 2d6f 7269 675b 2743 4431 5f31 275d  = -orig['CD1_1']
+00023400: 0a20 2020 2020 2020 206e 6577 5b27 4344  .        new['CD
+00023410: 315f 3227 5d20 3d20 2d6f 7269 675b 2743  1_2'] = -orig['C
+00023420: 4431 5f32 275d 0a20 2020 2020 2020 206e  D1_2'].        n
+00023430: 6577 5b27 4344 325f 3127 5d20 3d20 2d6f  ew['CD2_1'] = -o
+00023440: 7269 675b 2743 4432 5f31 275d 0a20 2020  rig['CD2_1'].   
+00023450: 2020 2020 206e 6577 5b27 4344 325f 3227       new['CD2_2'
+00023460: 5d20 3d20 2d6f 7269 675b 2743 4432 5f32  ] = -orig['CD2_2
+00023470: 275d 0a0a 2020 2020 2020 2020 666f 7220  ']..        for 
+00023480: 6920 696e 2072 616e 6765 286e 6577 5b27  i in range(new['
+00023490: 415f 4f52 4445 5227 5d2b 3129 3a0a 2020  A_ORDER']+1):.  
+000234a0: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
+000234b0: 696e 2072 616e 6765 286e 6577 5b27 425f  in range(new['B_
+000234c0: 4f52 4445 5227 5d2b 3129 3a0a 2020 2020  ORDER']+1):.    
+000234d0: 2020 2020 2020 2020 2020 2020 4169 6a20              Aij 
+000234e0: 203d 2066 2741 5f7b 697d 5f7b 6a7d 270a   = f'A_{i}_{j}'.
+000234f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023500: 6966 2041 696a 206e 6f74 2069 6e20 6e65  if Aij not in ne
+00023510: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
+00023520: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00023530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023540: 206e 6577 5b66 2741 5f7b 697d 5f7b 6a7d   new[f'A_{i}_{j}
+00023550: 275d 203d 206f 7269 675b 6627 415f 7b69  '] = orig[f'A_{i
+00023560: 7d5f 7b6a 7d27 5d2a 282d 3129 2a2a 6a2a  }_{j}']*(-1)**j*
+00023570: 282d 3129 2a2a 692a 2d31 0a20 2020 2020  (-1)**i*-1.     
+00023580: 2020 2020 2020 2020 2020 206e 6577 5b66             new[f
+00023590: 2742 5f7b 697d 5f7b 6a7d 275d 203d 206f  'B_{i}_{j}'] = o
+000235a0: 7269 675b 6627 425f 7b69 7d5f 7b6a 7d27  rig[f'B_{i}_{j}'
+000235b0: 5d2a 282d 3129 2a2a 6a2a 282d 3129 2a2a  ]*(-1)**j*(-1)**
+000235c0: 692a 2d31 0a0a 2020 2020 2020 2020 6e65  i*-1..        ne
+000235d0: 775f 7763 7320 3d20 6173 7472 6f70 792e  w_wcs = astropy.
+000235e0: 7763 732e 5743 5328 6e65 772c 2072 656c  wcs.WCS(new, rel
+000235f0: 6178 3d54 7275 6529 0a20 2020 2020 2020  ax=True).       
+00023600: 200a 2020 2020 2020 2020 6966 2063 6f6d   .        if com
+00023610: 7061 7265 3a0a 2020 2020 2020 2020 2020  pare:.          
+00023620: 2020 7872 2c20 7972 203d 206e 6577 5f77    xr, yr = new_w
+00023630: 6373 2e61 6c6c 5f77 6f72 6c64 3270 6978  cs.all_world2pix
+00023640: 282a 7264 2c20 6978 290a 2020 2020 2020  (*rd, ix).      
+00023650: 2020 2020 2020 786f 203d 206f 7269 675b        xo = orig[
+00023660: 274e 4158 4953 3127 5d20 2d20 7870 0a20  'NAXIS1'] - xp. 
+00023670: 2020 2020 2020 2020 2020 2079 6f20 3d20             yo = 
+00023680: 6f72 6967 5b27 4e41 5849 5332 275d 202d  orig['NAXIS2'] -
+00023690: 2079 700a 2020 2020 656c 7365 3a0a 2020   yp.    else:.  
+000236a0: 2020 2020 2020 2320 726f 743d 302c 2064        # rot=0, d
+000236b0: 6f20 6e6f 7468 696e 670a 2020 2020 2020  o nothing.      
+000236c0: 2020 6465 7363 203d 2027 783d 782c 2079    desc = 'x=x, y
+000236d0: 3d79 270a 2020 2020 2020 2020 6e65 775f  =y'.        new_
+000236e0: 7763 7320 3d20 6f72 6967 5f77 6373 0a20  wcs = orig_wcs. 
+000236f0: 2020 2020 2020 2069 6620 636f 6d70 6172         if compar
+00023700: 653a 0a20 2020 2020 2020 2020 2020 2078  e:.            x
+00023710: 6f20 3d20 7870 0a20 2020 2020 2020 2020  o = xp.         
+00023720: 2020 2079 6f20 3d20 7970 0a20 2020 2020     yo = yp.     
+00023730: 2020 2020 2020 2078 722c 2079 7220 3d20         xr, yr = 
+00023740: 6e65 775f 7763 732e 616c 6c5f 776f 726c  new_wcs.all_worl
+00023750: 6432 7069 7828 2a72 642c 2069 7829 0a20  d2pix(*rd, ix). 
+00023760: 2020 2020 2020 200a 2020 2020 6966 2076         .    if v
+00023770: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+00023780: 6966 2063 6f6d 7061 7265 3a0a 2020 2020  if compare:.    
+00023790: 2020 2020 2020 2020 7872 6d73 203d 206e          xrms = n
+000237a0: 6d61 6428 7872 2d78 6f29 0a20 2020 2020  mad(xr-xo).     
+000237b0: 2020 2020 2020 2079 726d 7320 3d20 6e6d         yrms = nm
+000237c0: 6164 2879 722d 796f 290a 2020 2020 2020  ad(yr-yo).      
+000237d0: 2020 2020 2020 7072 696e 7428 6627 526f        print(f'Ro
+000237e0: 7439 303a 207b 726f 747d 2072 6d73 3d7b  t90: {rot} rms={
+000237f0: 7872 6d73 3a2e 3265 7d20 7b79 726d 733a  xrms:.2e} {yrms:
+00023800: 2e32 657d 2729 0a20 2020 2020 2020 2020  .2e}').         
+00023810: 2020 200a 2020 2020 6966 2063 6f6d 7061     .    if compa
+00023820: 7265 3a0a 2020 2020 2020 2020 6669 672c  re:.        fig,
+00023830: 2061 7865 7320 3d20 706c 742e 7375 6270   axes = plt.subp
+00023840: 6c6f 7473 2831 2c32 2c66 6967 7369 7a65  lots(1,2,figsize
+00023850: 3d28 3130 2c35 292c 2073 6861 7265 783d  =(10,5), sharex=
+00023860: 5472 7565 2c20 7368 6172 6579 3d54 7275  True, sharey=Tru
+00023870: 6529 0a20 2020 2020 2020 2061 7865 735b  e).        axes[
+00023880: 305d 2e73 6361 7474 6572 2878 702c 2078  0].scatter(xp, x
+00023890: 722d 786f 290a 2020 2020 2020 2020 6178  r-xo).        ax
+000238a0: 6573 5b30 5d2e 7365 745f 786c 6162 656c  es[0].set_xlabel
+000238b0: 2827 6478 2729 0a20 2020 2020 2020 2061  ('dx').        a
+000238c0: 7865 735b 315d 2e73 6361 7474 6572 2879  xes[1].scatter(y
+000238d0: 702c 2079 722d 796f 290a 2020 2020 2020  p, yr-yo).      
+000238e0: 2020 6178 6573 5b31 5d2e 7365 745f 786c    axes[1].set_xl
+000238f0: 6162 656c 2827 6479 2729 0a20 2020 2020  abel('dy').     
+00023900: 2020 2066 6f72 2061 7820 696e 2061 7865     for ax in axe
+00023910: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+00023920: 782e 6772 6964 2829 0a20 2020 2020 2020  x.grid().       
+00023930: 200a 2020 2020 2020 2020 6669 672e 7469   .        fig.ti
+00023940: 6768 745f 6c61 796f 7574 2870 6164 3d30  ght_layout(pad=0
+00023950: 2e35 290a 2020 2020 0a20 2020 2072 6574  .5).    .    ret
+00023960: 7572 6e20 6e65 772c 206e 6577 5f77 6373  urn new, new_wcs
+00023970: 2c20 6465 7363 0a0a 0a64 6566 2067 6574  , desc...def get
+00023980: 5f77 6373 5f73 6c69 6365 5f68 6561 6465  _wcs_slice_heade
+00023990: 7228 7763 732c 2073 6c78 2c20 736c 7929  r(wcs, slx, sly)
+000239a0: 3a0a 2020 2020 2222 2254 4244 0a20 2020  :.    """TBD.   
+000239b0: 2022 2222 0a20 2020 2023 736c 782c 2073   """.    #slx, s
+000239c0: 6c79 203d 2073 6c69 6365 2831 3237 392c  ly = slice(1279,
+000239d0: 2031 3434 3529 2c20 736c 6963 6528 3236   1445), slice(26
+000239e0: 3635 2c32 3831 3329 0a20 2020 2068 203d  65,2813).    h =
+000239f0: 2077 6373 2e73 6c69 6365 2828 736c 792c   wcs.slice((sly,
+00023a00: 2073 6c78 2929 2e74 6f5f 6865 6164 6572   slx)).to_header
+00023a10: 2872 656c 6178 3d54 7275 6529 0a20 2020  (relax=True).   
+00023a20: 2068 5b27 4e41 5849 5327 5d20 3d20 320a   h['NAXIS'] = 2.
+00023a30: 2020 2020 685b 274e 4158 4953 3127 5d20      h['NAXIS1'] 
+00023a40: 3d20 736c 782e 7374 6f70 2d73 6c78 2e73  = slx.stop-slx.s
+00023a50: 7461 7274 0a20 2020 2068 5b27 4e41 5849  tart.    h['NAXI
+00023a60: 5332 275d 203d 2073 6c79 2e73 746f 702d  S2'] = sly.stop-
+00023a70: 736c 792e 7374 6172 740a 2020 2020 666f  sly.start.    fo
+00023a80: 7220 6b20 696e 2068 3a0a 2020 2020 2020  r k in h:.      
+00023a90: 2020 6966 206b 2e73 7461 7274 7377 6974    if k.startswit
+00023aa0: 6828 2750 4327 293a 0a20 2020 2020 2020  h('PC'):.       
+00023ab0: 2020 2020 2068 2e72 656e 616d 655f 6b65       h.rename_ke
+00023ac0: 7977 6f72 6428 6b2c 206b 2e72 6570 6c61  yword(k, k.repla
+00023ad0: 6365 2827 5043 272c 2027 4344 2729 290a  ce('PC', 'CD')).
+00023ae0: 0a20 2020 2072 6574 7572 6e20 680a 0a0a  .    return h...
+00023af0: 6465 6620 6765 745f 636f 6d6d 6f6e 5f73  def get_common_s
+00023b00: 6c69 6365 7328 615f 6f72 6967 696e 2c20  lices(a_origin, 
+00023b10: 615f 7368 6170 652c 2062 5f6f 7269 6769  a_shape, b_origi
+00023b20: 6e2c 2062 5f73 6861 7065 293a 0a20 2020  n, b_shape):.   
+00023b30: 2022 2222 0a20 2020 2047 6574 2073 6c69   """.    Get sli
+00023b40: 6365 7320 6f66 206f 7665 726c 6170 7320  ces of overlaps 
+00023b50: 6265 7477 6565 6e20 7477 6f20 7265 6374  between two rect
+00023b60: 616e 6775 6c61 7220 6772 6964 730a 2020  angular grids.  
+00023b70: 2020 2222 220a 0a20 2020 206c 6c20 3d20    """..    ll = 
+00023b80: 6e70 2e6d 696e 285b 615f 6f72 6967 696e  np.min([a_origin
+00023b90: 2c20 625f 6f72 6967 696e 5d2c 2061 7869  , b_origin], axi
+00023ba0: 733d 3029 0a20 2020 2075 7220 3d20 6e70  s=0).    ur = np
+00023bb0: 2e6d 6178 285b 615f 6f72 6967 696e 2b61  .max([a_origin+a
+00023bc0: 5f73 6861 7065 2c20 625f 6f72 6967 696e  _shape, b_origin
+00023bd0: 2b62 5f73 6861 7065 5d2c 2061 7869 733d  +b_shape], axis=
+00023be0: 3029 0a0a 2020 2020 2320 6f74 6865 7220  0)..    # other 
+00023bf0: 696e 2073 656c 660a 2020 2020 6c6c 7320  in self.    lls 
+00023c00: 3d20 6e70 2e6d 696e 696d 756d 2862 5f6f  = np.minimum(b_o
+00023c10: 7269 6769 6e20 2d20 6c6c 2c20 615f 7368  rigin - ll, a_sh
+00023c20: 6170 6529 0a20 2020 2075 7273 203d 206e  ape).    urs = n
+00023c30: 702e 636c 6970 2862 5f6f 7269 6769 6e20  p.clip(b_origin 
+00023c40: 2b20 625f 7368 6170 6520 2d20 615f 6f72  + b_shape - a_or
+00023c50: 6967 696e 2c20 5b30 2c20 305d 2c20 615f  igin, [0, 0], a_
+00023c60: 7368 6170 6529 0a0a 2020 2020 2320 7365  shape)..    # se
+00023c70: 6c66 2069 6e20 6f74 6865 720a 2020 2020  lf in other.    
+00023c80: 6c6c 6f20 3d20 6e70 2e6d 696e 696d 756d  llo = np.minimum
+00023c90: 2861 5f6f 7269 6769 6e20 2d20 6c6c 2c20  (a_origin - ll, 
+00023ca0: 625f 7368 6170 6529 0a20 2020 2075 726f  b_shape).    uro
+00023cb0: 203d 206e 702e 636c 6970 2861 5f6f 7269   = np.clip(a_ori
+00023cc0: 6769 6e20 2b20 615f 7368 6170 6520 2d20  gin + a_shape - 
+00023cd0: 625f 6f72 6967 696e 2c20 5b30 2c20 305d  b_origin, [0, 0]
+00023ce0: 2c20 625f 7368 6170 6529 0a0a 2020 2020  , b_shape)..    
+00023cf0: 615f 736c 6963 6520 3d20 2873 6c69 6365  a_slice = (slice
+00023d00: 286c 6c73 5b30 5d2c 2075 7273 5b30 5d29  (lls[0], urs[0])
+00023d10: 2c20 736c 6963 6528 6c6c 735b 315d 2c20  , slice(lls[1], 
+00023d20: 7572 735b 315d 2929 0a20 2020 2062 5f73  urs[1])).    b_s
+00023d30: 6c69 6365 203d 2028 736c 6963 6528 6c6c  lice = (slice(ll
+00023d40: 6f5b 305d 2c20 7572 6f5b 305d 292c 2073  o[0], uro[0]), s
+00023d50: 6c69 6365 286c 6c6f 5b31 5d2c 2075 726f  lice(llo[1], uro
+00023d60: 5b31 5d29 290a 2020 2020 7265 7475 726e  [1])).    return
+00023d70: 2061 5f73 6c69 6365 2c20 625f 736c 6963   a_slice, b_slic
+00023d80: 650a 0a0a 636c 6173 7320 5743 5346 6f6f  e...class WCSFoo
+00023d90: 7470 7269 6e74 286f 626a 6563 7429 3a0a  tprint(object):.
+00023da0: 2020 2020 2222 220a 2020 2020 4865 6c70      """.    Help
+00023db0: 6572 2066 756e 6374 696f 6e73 2066 6f72  er functions for
+00023dc0: 2064 6561 6c69 6e67 2077 6974 6820 5743   dealing with WC
+00023dd0: 5320 666f 6f74 7072 696e 7473 0a20 2020  S footprints.   
+00023de0: 2022 2222 0a0a 2020 2020 6465 6620 5f5f   """..    def __
+00023df0: 696e 6974 5f5f 2873 656c 662c 2077 6373  init__(self, wcs
+00023e00: 2c20 6578 743d 312c 206c 6162 656c 3d4e  , ext=1, label=N
+00023e10: 6f6e 6529 3a0a 2020 2020 2020 2020 6966  one):.        if
+00023e20: 2069 7369 6e73 7461 6e63 6528 7763 732c   isinstance(wcs,
+00023e30: 2070 7977 6373 2e57 4353 293a 0a20 2020   pywcs.WCS):.   
+00023e40: 2020 2020 2020 2020 2073 656c 662e 7763           self.wc
+00023e50: 7320 3d20 7763 732e 6465 6570 636f 7079  s = wcs.deepcopy
+00023e60: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+00023e70: 6620 6e6f 7420 6861 7361 7474 7228 7365  f not hasattr(se
+00023e80: 6c66 2e77 6373 2c20 2770 6978 656c 5f73  lf.wcs, 'pixel_s
+00023e90: 6861 7065 2729 3a0a 2020 2020 2020 2020  hape'):.        
+00023ea0: 2020 2020 2020 2020 7365 6c66 2e77 6373          self.wcs
+00023eb0: 2e70 6978 656c 5f73 6861 7065 203d 204e  .pixel_shape = N
+00023ec0: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
+00023ed0: 2069 6620 7365 6c66 2e77 6373 2e70 6978   if self.wcs.pix
+00023ee0: 656c 5f73 6861 7065 2069 7320 4e6f 6e65  el_shape is None
+00023ef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023f00: 2020 7365 6c66 2e77 6373 2e70 6978 656c    self.wcs.pixel
+00023f10: 5f73 6861 7065 203d 205b 696e 7428 702a  _shape = [int(p*
+00023f20: 3229 2066 6f72 2070 2069 6e20 7365 6c66  2) for p in self
+00023f30: 2e77 6373 2e77 6373 2e63 7270 6978 5d0a  .wcs.wcs.crpix].
+00023f40: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00023f50: 6e73 7461 6e63 6528 7763 732c 2073 7472  nstance(wcs, str
+00023f60: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
+00023f70: 6475 203d 2070 7966 6974 732e 6f70 656e  du = pyfits.open
+00023f80: 2877 6373 290a 2020 2020 2020 2020 2020  (wcs).          
+00023f90: 2020 6966 206c 656e 2868 6475 2920 3d3d    if len(hdu) ==
+00023fa0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00023fb0: 2020 2020 6578 7420 3d20 300a 0a20 2020      ext = 0..   
+00023fc0: 2020 2020 2020 2020 2073 656c 662e 6164           self.ad
+00023fd0: 645f 6e61 7869 7328 6864 755b 6578 745d  d_naxis(hdu[ext]
+00023fe0: 2e68 6561 6465 7229 0a20 2020 2020 2020  .header).       
+00023ff0: 2020 2020 2074 6865 5f77 6373 203d 2070       the_wcs = p
+00024000: 7977 6373 2e57 4353 2868 6475 5b65 7874  ywcs.WCS(hdu[ext
+00024010: 5d2e 6865 6164 6572 2c20 666f 626a 3d68  ].header, fobj=h
+00024020: 6475 290a 2020 2020 2020 2020 2020 2020  du).            
+00024030: 7365 6c66 2e77 6373 203d 2074 6865 5f77  self.wcs = the_w
+00024040: 6373 0a20 2020 2020 2020 2020 2020 2068  cs.            h
+00024050: 6475 2e63 6c6f 7365 2829 0a20 2020 2020  du.close().     
+00024060: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00024070: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00024080: 7763 732c 2070 7966 6974 732e 4844 554c  wcs, pyfits.HDUL
+00024090: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+000240a0: 2020 6966 206c 656e 2877 6373 2920 3d3d    if len(wcs) ==
+000240b0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+000240c0: 2020 2020 6578 7420 3d20 300a 2020 2020      ext = 0.    
+000240d0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+000240e0: 5f6e 6178 6973 2877 6373 5b65 7874 5d2e  _naxis(wcs[ext].
+000240f0: 6865 6164 6572 290a 2020 2020 2020 2020  header).        
+00024100: 2020 2020 7468 655f 7763 7320 3d20 7079      the_wcs = py
+00024110: 7763 732e 5743 5328 7763 735b 6578 745d  wcs.WCS(wcs[ext]
+00024120: 2e68 6561 6465 722c 2066 6f62 6a3d 7763  .header, fobj=wc
+00024130: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
+00024140: 656c 662e 7763 7320 3d20 7468 655f 7763  elf.wcs = the_wc
+00024150: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
+00024160: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00024170: 7428 2757 4353 2063 6c61 7373 206e 6f74  t('WCS class not
+00024180: 2072 6563 6f67 6e69 7a65 643a 207b 307d   recognized: {0}
+00024190: 272e 666f 726d 6174 2877 6373 2e5f 5f63  '.format(wcs.__c
+000241a0: 6c61 7373 5f5f 2929 0a20 2020 2020 2020  lass__)).       
+000241b0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000241c0: 4572 726f 720a 0a20 2020 2020 2020 2073  Error..        s
+000241d0: 656c 662e 6670 203d 2073 656c 662e 7763  elf.fp = self.wc
+000241e0: 732e 6361 6c63 5f66 6f6f 7470 7269 6e74  s.calc_footprint
+000241f0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00024200: 636f 7364 6563 203d 206e 702e 636f 7328  cosdec = np.cos(
+00024210: 7365 6c66 2e66 705b 302c 2031 5d2f 3138  self.fp[0, 1]/18
+00024220: 302a 6e70 2e70 6929 0a20 2020 2020 2020  0*np.pi).       
+00024230: 2073 656c 662e 6c61 6265 6c20 3d20 6c61   self.label = la
+00024240: 6265 6c0a 2020 2020 2020 2020 7365 6c66  bel.        self
+00024250: 2e70 6978 656c 5f73 6361 6c65 203d 2067  .pixel_scale = g
+00024260: 6574 5f77 6373 5f70 7363 616c 6528 7365  et_wcs_pscale(se
+00024270: 6c66 2e77 6373 290a 0a20 2020 2040 7072  lf.wcs)..    @pr
+00024280: 6f70 6572 7479 0a20 2020 2064 6566 2063  operty.    def c
+00024290: 656e 7472 6f69 6428 7365 6c66 293a 0a20  entroid(self):. 
+000242a0: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
+000242b0: 2e6d 6561 6e28 7365 6c66 2e66 702c 2061  .mean(self.fp, a
+000242c0: 7869 733d 3029 0a0a 0a20 2020 2040 7072  xis=0)...    @pr
+000242d0: 6f70 6572 7479 0a20 2020 2064 6566 2070  operty.    def p
+000242e0: 6174 6828 7365 6c66 293a 0a20 2020 2020  ath(self):.     
+000242f0: 2020 2022 2222 0a20 2020 2020 2020 2060     """.        `
+00024300: 7e6d 6174 706c 6f74 6c69 622e 7061 7468  ~matplotlib.path
+00024310: 2e50 6174 6860 206f 626a 6563 740a 2020  .Path` object.  
+00024320: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00024330: 2020 696d 706f 7274 206d 6174 706c 6f74    import matplot
+00024340: 6c69 622e 7061 7468 0a20 2020 2020 2020  lib.path.       
+00024350: 2072 6574 7572 6e20 6d61 7470 6c6f 746c   return matplotl
+00024360: 6962 2e70 6174 682e 5061 7468 2873 656c  ib.path.Path(sel
+00024370: 662e 6670 290a 0a0a 2020 2020 4070 726f  f.fp)...    @pro
+00024380: 7065 7274 790a 2020 2020 6465 6620 706f  perty.    def po
+00024390: 6c79 676f 6e28 7365 6c66 293a 0a20 2020  lygon(self):.   
+000243a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000243b0: 2060 7e73 6861 7065 6c79 2e67 656f 6d65   `~shapely.geome
+000243c0: 7472 792e 506f 6c79 676f 6e60 206f 626a  try.Polygon` obj
+000243d0: 6563 742e 0a20 2020 2020 2020 2022 2222  ect..        """
+000243e0: 0a20 2020 2020 2020 2066 726f 6d20 7368  .        from sh
+000243f0: 6170 656c 792e 6765 6f6d 6574 7279 2069  apely.geometry i
+00024400: 6d70 6f72 7420 506f 6c79 676f 6e0a 2020  mport Polygon.  
+00024410: 2020 2020 2020 7265 7475 726e 2050 6f6c        return Pol
+00024420: 7967 6f6e 2873 656c 662e 6670 290a 0a0a  ygon(self.fp)...
+00024430: 2020 2020 6465 6620 6765 745f 7061 7463      def get_patc
+00024440: 6828 7365 6c66 2c20 2a2a 6b77 6172 6773  h(self, **kwargs
+00024450: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00024460: 2020 2020 2020 2060 7e6d 6174 706c 6f74         `~matplot
+00024470: 6c69 622e 7061 6368 2e50 6174 6850 6174  lib.pach.PathPat
+00024480: 6368 6020 6f62 6a65 6374 0a20 2020 2020  ch` object.     
+00024490: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+000244a0: 6574 7572 6e20 7061 7463 685f 6672 6f6d  eturn patch_from
+000244b0: 5f70 6f6c 7967 6f6e 2873 656c 662e 706f  _polygon(self.po
+000244c0: 6c79 676f 6e2c 202a 2a6b 7761 7267 7329  lygon, **kwargs)
+000244d0: 0a0a 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+000244e0: 0a20 2020 2064 6566 2072 6567 696f 6e28  .    def region(
+000244f0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00024500: 2222 0a20 2020 2020 2020 2050 6f6c 7967  "".        Polyg
+00024510: 6f6e 2073 7472 696e 6720 696e 2044 5339  on string in DS9
+00024520: 2072 6567 696f 6e20 666f 726d 6174 0a20   region format. 
+00024530: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00024540: 2020 2072 6574 7572 6e20 2770 6f6c 7967     return 'polyg
+00024550: 6f6e 287b 307d 2927 2e66 6f72 6d61 7428  on({0})'.format(
+00024560: 272c 272e 6a6f 696e 285b 277b 303a 2e36  ','.join(['{0:.6
+00024570: 667d 272e 666f 726d 6174 2863 2920 666f  f}'.format(c) fo
+00024580: 7220 6320 696e 2073 656c 662e 6670 2e66  r c in self.fp.f
+00024590: 6c61 7474 656e 2829 5d29 290a 0a0a 2020  latten()]))...  
+000245a0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+000245b0: 2020 2020 6465 6620 6164 645f 6e61 7869      def add_naxi
+000245c0: 7328 6865 6164 6572 293a 0a20 2020 2020  s(header):.     
+000245d0: 2020 2022 2222 0a20 2020 2020 2020 2049     """.        I
+000245e0: 6620 4e41 5849 5320 6b65 7977 6f72 6473  f NAXIS keywords
+000245f0: 206e 6f74 2066 6f75 6e64 2069 6e20 616e   not found in an
+00024600: 2069 6d61 6765 2068 6561 6465 722c 2061   image header, a
+00024610: 7373 756d 6520 7468 6520 7061 7265 6e74  ssume the parent
+00024620: 0a20 2020 2020 2020 2069 6d61 6765 2064  .        image d
+00024630: 696d 656e 7369 6f6e 7320 6172 6520 322a  imensions are 2*
+00024640: 4352 5049 580a 2020 2020 2020 2020 2222  CRPIX.        ""
+00024650: 220a 2020 2020 2020 2020 666f 7220 6920  ".        for i 
+00024660: 696e 205b 312c 2032 5d3a 0a20 2020 2020  in [1, 2]:.     
+00024670: 2020 2020 2020 2069 6620 274e 4158 4953         if 'NAXIS
+00024680: 7b30 7d27 2e66 6f72 6d61 7428 6929 206e  {0}'.format(i) n
+00024690: 6f74 2069 6e20 6865 6164 6572 3a0a 2020  ot in header:.  
+000246a0: 2020 2020 2020 2020 2020 2020 2020 6865                he
+000246b0: 6164 6572 5b27 4e41 5849 537b 307d 272e  ader['NAXIS{0}'.
+000246c0: 666f 726d 6174 2869 295d 203d 2069 6e74  format(i)] = int
+000246d0: 2868 6561 6465 725b 2743 5250 4958 7b30  (header['CRPIX{0
+000246e0: 7d27 2e66 6f72 6d61 7428 6929 5d2a 3229  }'.format(i)]*2)
+000246f0: 0a0a 0a64 6566 2072 6570 726f 6a65 6374  ...def reproject
+00024700: 5f66 6173 7465 7228 696e 7075 745f 6864  _faster(input_hd
+00024710: 752c 206f 7574 7075 742c 2070 6164 3d31  u, output, pad=1
+00024720: 302c 202a 2a6b 7761 7267 7329 3a0a 2020  0, **kwargs):.  
+00024730: 2020 2222 2253 7065 6564 2075 7020 6072    """Speed up `r
+00024740: 6570 726f 6a65 6374 6020 6d6f 6475 6c65  eproject` module
+00024750: 2077 6974 6820 6172 7261 7920 736c 6963   with array slic
+00024760: 6573 206f 6620 7468 6520 696e 7075 7420  es of the input 
+00024770: 696d 6167 650a 0a20 2020 2050 6172 616d  image..    Param
+00024780: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00024790: 2d2d 2d2d 0a20 2020 2069 6e70 7574 5f68  ----.    input_h
+000247a0: 6475 203a 2060 7e61 7374 726f 7079 2e69  du : `~astropy.i
+000247b0: 6f2e 6669 7473 2e49 6d61 6765 4844 5560  o.fits.ImageHDU`
+000247c0: 0a20 2020 2020 2020 2049 6e70 7574 2069  .        Input i
+000247d0: 6d61 6765 2048 4455 2074 6f20 7265 7072  mage HDU to repr
+000247e0: 6f6a 6563 742e 0a0a 2020 2020 6f75 7470  oject...    outp
+000247f0: 7574 203a 2060 7e61 7374 726f 7079 2e77  ut : `~astropy.w
+00024800: 6373 2e57 4353 6020 6f72 2060 7e61 7374  cs.WCS` or `~ast
+00024810: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
+00024820: 6465 7260 0a20 2020 2020 2020 204f 7574  der`.        Out
+00024830: 7075 7420 6672 616d 6520 6465 6669 6e69  put frame defini
+00024840: 7469 6f6e 2e0a 0a20 2020 2070 6164 203a  tion...    pad :
+00024850: 2069 6e74 0a20 2020 2020 2020 2050 6978   int.        Pix
+00024860: 656c 2070 6164 6469 6e67 206f 6e20 736c  el padding on sl
+00024870: 6963 6573 2063 7574 2066 726f 6d20 7468  ices cut from th
+00024880: 6520 6069 6e70 7574 5f68 6475 602e 0a0a  e `input_hdu`...
+00024890: 2020 2020 6b77 6172 6773 203a 2064 6963      kwargs : dic
+000248a0: 740a 2020 2020 2020 2020 4172 6775 6d65  t.        Argume
+000248b0: 6e74 7320 7061 7373 6564 2074 6872 6f75  nts passed throu
+000248c0: 6768 2074 6f20 607e 7265 7072 6f6a 6563  gh to `~reprojec
+000248d0: 742e 7265 7072 6f6a 6563 745f 696e 7465  t.reproject_inte
+000248e0: 7270 602e 2020 466f 720a 2020 2020 2020  rp`.  For.      
+000248f0: 2020 6578 616d 706c 652c 2060 6f72 6465    example, `orde
+00024900: 723d 276e 6561 7265 7374 2d6e 6569 6768  r='nearest-neigh
+00024910: 626f 7227 602e 0a0a 2020 2020 5265 7475  bor'`...    Retu
+00024920: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00024930: 2020 2020 7265 7072 6f6a 6563 7465 6420      reprojected 
+00024940: 3a20 607e 6e75 6d70 792e 6e64 6172 7261  : `~numpy.ndarra
+00024950: 7960 0a20 2020 2020 2020 2052 6570 726f  y`.        Repro
+00024960: 6a65 6374 6564 2064 6174 6120 6672 6f6d  jected data from
+00024970: 2060 696e 7075 745f 6864 7560 2e0a 0a20   `input_hdu`... 
+00024980: 2020 2066 6f6f 7470 7269 6e74 203a 2060     footprint : `
+00024990: 7e6e 756d 7079 2e6e 6461 7272 6179 600a  ~numpy.ndarray`.
+000249a0: 2020 2020 2020 2020 466f 6f74 7072 696e          Footprin
+000249b0: 7420 6f66 2074 6865 2069 6e70 7574 2061  t of the input a
+000249c0: 7272 6179 2069 6e20 7468 6520 6f75 7470  rray in the outp
+000249d0: 7574 2066 7261 6d65 2e0a 0a20 2020 204e  ut frame...    N
+000249e0: 6f74 6573 0a20 2020 202d 2d2d 2d2d 0a0a  otes.    -----..
+000249f0: 2020 2020 6072 6570 726f 6a65 6374 2720      `reproject' 
+00024a00: 6973 2061 6e20 6173 7472 6f70 792d 636f  is an astropy-co
+00024a10: 6d70 6174 6962 6c65 206d 6f64 756c 6520  mpatible module 
+00024a20: 7468 6174 2063 616e 2062 6520 696e 7374  that can be inst
+00024a30: 616c 6c65 6420 7769 7468 0a20 2020 2060  alled with.    `
+00024a40: 7069 7060 2e20 2053 6565 2068 7474 7073  pip`.  See https
+00024a50: 3a2f 2f72 6570 726f 6a65 6374 2e72 6561  ://reproject.rea
+00024a60: 6474 6865 646f 6373 2e69 6f2e 0a20 2020  dthedocs.io..   
+00024a70: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
+00024a80: 7265 7072 6f6a 6563 740a 0a20 2020 2023  reproject..    #
+00024a90: 204f 7574 7075 7420 5743 530a 2020 2020   Output WCS.    
+00024aa0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+00024ab0: 7470 7574 2c20 7079 7763 732e 5743 5329  tput, pywcs.WCS)
+00024ac0: 3a0a 2020 2020 2020 2020 6f75 745f 7763  :.        out_wc
+00024ad0: 7320 3d20 6f75 7470 7574 0a20 2020 2065  s = output.    e
+00024ae0: 6c73 653a 0a20 2020 2020 2020 206f 7574  lse:.        out
+00024af0: 5f77 6373 203d 2070 7977 6373 2e57 4353  _wcs = pywcs.WCS
+00024b00: 286f 7574 7075 742c 2072 656c 6178 3d54  (output, relax=T
+00024b10: 7275 6529 0a0a 2020 2020 6966 2027 5349  rue)..    if 'SI
+00024b20: 5027 2069 6e20 6f75 745f 7763 732e 7763  P' in out_wcs.wc
+00024b30: 732e 6374 7970 655b 305d 3a0a 2020 2020  s.ctype[0]:.    
+00024b40: 2020 2020 7072 696e 7428 2757 6172 6e69      print('Warni
+00024b50: 6e67 3a20 6072 6570 726f 6a65 6374 6020  ng: `reproject` 
+00024b60: 646f 6573 6e5c 2774 2061 7070 6561 7220  doesn\'t appear 
+00024b70: 746f 2073 7570 706f 7274 2053 4950 2070  to support SIP p
+00024b80: 726f 6a65 6374 696f 6e27 290a 0a20 2020  rojection')..   
+00024b90: 2023 2043 6f6d 7075 7465 2070 6978 656c   # Compute pixel
+00024ba0: 2063 6f6f 7264 696e 6174 6573 206f 6620   coordinates of 
+00024bb0: 7468 6520 6f75 7470 7574 2066 7261 6d65  the output frame
+00024bc0: 2063 6f72 6e65 7273 2069 6e20 7468 6520   corners in the 
+00024bd0: 696e 7075 7420 696d 6167 650a 2020 2020  input image.    
+00024be0: 696e 7075 745f 7763 7320 3d20 7079 7763  input_wcs = pywc
+00024bf0: 732e 5743 5328 696e 7075 745f 6864 752e  s.WCS(input_hdu.
+00024c00: 6865 6164 6572 2c20 7265 6c61 783d 5472  header, relax=Tr
+00024c10: 7565 290a 2020 2020 6f75 745f 6670 203d  ue).    out_fp =
+00024c20: 206f 7574 5f77 6373 2e63 616c 635f 666f   out_wcs.calc_fo
+00024c30: 6f74 7072 696e 7428 290a 2020 2020 696e  otprint().    in
+00024c40: 7075 745f 7879 203d 2069 6e70 7574 5f77  put_xy = input_w
+00024c50: 6373 2e61 6c6c 5f77 6f72 6c64 3270 6978  cs.all_world2pix
+00024c60: 286f 7574 5f66 702c 2030 290a 2020 2020  (out_fp, 0).    
+00024c70: 736c 7820 3d20 736c 6963 6528 696e 7428  slx = slice(int(
+00024c80: 696e 7075 745f 7879 5b3a 2c20 305d 2e6d  input_xy[:, 0].m
+00024c90: 696e 2829 292d 7061 642c 2069 6e74 2869  in())-pad, int(i
+00024ca0: 6e70 7574 5f78 795b 3a2c 2030 5d2e 6d61  nput_xy[:, 0].ma
+00024cb0: 7828 2929 2b70 6164 290a 2020 2020 736c  x())+pad).    sl
+00024cc0: 7920 3d20 736c 6963 6528 696e 7428 696e  y = slice(int(in
+00024cd0: 7075 745f 7879 5b3a 2c20 315d 2e6d 696e  put_xy[:, 1].min
+00024ce0: 2829 292d 7061 642c 2069 6e74 2869 6e70  ())-pad, int(inp
+00024cf0: 7574 5f78 795b 3a2c 2031 5d2e 6d61 7828  ut_xy[:, 1].max(
+00024d00: 2929 2b70 6164 290a 0a20 2020 2023 204d  ))+pad)..    # M
+00024d10: 616b 6520 7468 6520 6375 746f 7574 0a20  ake the cutout. 
+00024d20: 2020 2073 7562 5f64 6174 6120 3d20 696e     sub_data = in
+00024d30: 7075 745f 6864 752e 6461 7461 5b73 6c79  put_hdu.data[sly
+00024d40: 2c20 736c 785d 0a20 2020 2073 7562 5f68  , slx].    sub_h
+00024d50: 6561 6465 7220 3d20 6765 745f 7763 735f  eader = get_wcs_
+00024d60: 736c 6963 655f 6865 6164 6572 2869 6e70  slice_header(inp
+00024d70: 7574 5f77 6373 2c20 736c 782c 2073 6c79  ut_wcs, slx, sly
+00024d80: 290a 2020 2020 7375 625f 6864 7520 3d20  ).    sub_hdu = 
+00024d90: 7079 6669 7473 2e50 7269 6d61 7279 4844  pyfits.PrimaryHD
+00024da0: 5528 6461 7461 3d73 7562 5f64 6174 612c  U(data=sub_data,
+00024db0: 2068 6561 6465 723d 7375 625f 6865 6164   header=sub_head
+00024dc0: 6572 290a 0a20 2020 2023 2047 6574 2074  er)..    # Get t
+00024dd0: 6865 2072 6570 726f 6a65 6374 696f 6e0a  he reprojection.
+00024de0: 2020 2020 7365 675f 692c 2066 705f 6920      seg_i, fp_i 
+00024df0: 3d20 7265 7072 6f6a 6563 742e 7265 7072  = reproject.repr
+00024e00: 6f6a 6563 745f 696e 7465 7270 2873 7562  oject_interp(sub
+00024e10: 5f68 6475 2c20 6f75 7470 7574 2c20 2a2a  _hdu, output, **
+00024e20: 6b77 6172 6773 290a 2020 2020 7265 7475  kwargs).    retu
+00024e30: 726e 2073 6567 5f69 2e61 7374 7970 6528  rn seg_i.astype(
+00024e40: 7375 625f 6461 7461 2e64 7479 7065 292c  sub_data.dtype),
+00024e50: 2066 705f 692e 6173 7479 7065 286e 702e   fp_i.astype(np.
+00024e60: 7569 6e74 3829 0a0a 0a64 6566 2066 756c  uint8)...def ful
+00024e70: 6c5f 7370 6563 7472 756d 5f77 6373 6865  l_spectrum_wcshe
+00024e80: 6164 6572 2863 656e 7465 725f 7761 7665  ader(center_wave
+00024e90: 3d31 2e34 6534 2c20 646c 616d 3d34 302c  =1.4e4, dlam=40,
+00024ea0: 204e 583d 3130 302c 2073 7061 7469 616c   NX=100, spatial
+00024eb0: 5f73 6361 6c65 3d31 2c20 4e59 3d31 3029  _scale=1, NY=10)
+00024ec0: 3a0a 2020 2020 2222 224d 616b 6520 6120  :.    """Make a 
+00024ed0: 5743 5320 6865 6164 6572 2066 6f72 2061  WCS header for a
+00024ee0: 2032 4420 7370 6563 7472 756d 0a0a 2020   2D spectrum..  
+00024ef0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00024f00: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00024f10: 6365 6e74 6572 5f77 6176 6520 3a20 666c  center_wave : fl
+00024f20: 6f61 740a 2020 2020 2020 2020 5761 7665  oat.        Wave
+00024f30: 6c65 6e67 7468 206f 6620 7468 6520 6365  length of the ce
+00024f40: 6e74 7261 6c20 7069 7865 6c2c 2069 6e20  ntral pixel, in 
+00024f50: 416e 7374 726f 6d73 0a0a 2020 2020 646c  Anstroms..    dl
+00024f60: 616d 203a 2066 6c6f 6174 0a20 2020 2020  am : float.     
+00024f70: 2020 2044 656c 7461 2d77 6176 656c 656e     Delta-wavelen
+00024f80: 6774 6820 7065 7220 2878 2920 7069 7865  gth per (x) pixe
+00024f90: 6c0a 0a20 2020 204e 582c 204e 5920 3a20  l..    NX, NY : 
+00024fa0: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
+00024fb0: 6572 206f 6620 7820 2620 7920 7069 7865  er of x & y pixe
+00024fc0: 6c73 2e20 4f75 7470 7574 2077 696c 6c20  ls. Output will 
+00024fd0: 6861 7665 2073 6861 7065 2060 2832 2a4e  have shape `(2*N
+00024fe0: 592c 2032 2a4e 5829 602e 0a0a 2020 2020  Y, 2*NX)`...    
+00024ff0: 7370 6174 6961 6c5f 7363 616c 6520 3a20  spatial_scale : 
+00025000: 666c 6f61 740a 2020 2020 2020 2020 5370  float.        Sp
+00025010: 6174 6961 6c20 7363 616c 6520 6f66 2074  atial scale of t
+00025020: 6865 206f 7574 7075 742c 2069 6e20 756e  he output, in un
+00025030: 6974 7320 6f66 2074 6865 2069 6e70 7574  its of the input
+00025040: 2070 6978 656c 730a 0a20 2020 2052 6574   pixels..    Ret
+00025050: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00025060: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
+00025070: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+00025080: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
+00025090: 4f75 7470 7574 2057 4353 2068 6561 6465  Output WCS heade
+000250a0: 720a 0a20 2020 2077 6373 203a 2060 7e61  r..    wcs : `~a
+000250b0: 7374 726f 7079 2e77 6373 2e57 4353 600a  stropy.wcs.WCS`.
+000250c0: 2020 2020 2020 2020 4f75 7470 7574 2057          Output W
+000250d0: 4353 0a0a 2020 2020 4578 616d 706c 6573  CS..    Examples
+000250e0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a 0a20  .    --------.. 
+000250f0: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
+00025100: 6772 697a 6c69 2e75 7469 6c73 2069 6d70  grizli.utils imp
+00025110: 6f72 7420 6d61 6b65 5f73 7065 6374 7275  ort make_spectru
+00025120: 6d5f 7763 7368 6561 6465 720a 2020 2020  m_wcsheader.    
+00025130: 2020 2020 3e3e 3e20 682c 2077 6373 203d      >>> h, wcs =
+00025140: 206d 616b 655f 7370 6563 7472 756d 5f77   make_spectrum_w
+00025150: 6373 6865 6164 6572 2829 0a20 2020 2020  csheader().     
+00025160: 2020 203e 3e3e 2070 7269 6e74 2877 6373     >>> print(wcs
+00025170: 290a 2020 2020 2020 2020 5743 5320 4b65  ).        WCS Ke
+00025180: 7977 6f72 6473 0a20 2020 2020 2020 204e  ywords.        N
+00025190: 756d 6265 7220 6f66 2057 4353 2061 7865  umber of WCS axe
+000251a0: 733a 2032 0a20 2020 2020 2020 2043 5459  s: 2.        CTY
+000251b0: 5045 203a 2027 5741 5645 2720 2027 4c49  PE : 'WAVE'  'LI
+000251c0: 4e45 4152 270a 2020 2020 2020 2020 4352  NEAR'.        CR
+000251d0: 5641 4c20 3a20 3134 3030 302e 3020 2030  VAL : 14000.0  0
+000251e0: 2e30 0a20 2020 2020 2020 2043 5250 4958  .0.        CRPIX
+000251f0: 203a 2031 3031 2e30 2020 3131 2e30 0a20   : 101.0  11.0. 
+00025200: 2020 2020 2020 2043 4431 5f31 2043 4431         CD1_1 CD1
+00025210: 5f32 2020 3a20 3430 2e30 2020 302e 300a  _2  : 40.0  0.0.
+00025220: 2020 2020 2020 2020 4344 325f 3120 4344          CD2_1 CD
+00025230: 325f 3220 203a 2030 2e30 2020 312e 300a  2_2  : 0.0  1.0.
+00025240: 2020 2020 2020 2020 4e41 5849 5320 2020          NAXIS   
+00025250: 203a 2032 3030 2032 300a 0a20 2020 2022   : 200 20..    "
+00025260: 2222 0a0a 2020 2020 6820 3d20 7079 6669  ""..    h = pyfi
+00025270: 7473 2e49 6d61 6765 4844 5528 6461 7461  ts.ImageHDU(data
+00025280: 3d6e 702e 7a65 726f 7328 2832 2a4e 592c  =np.zeros((2*NY,
+00025290: 2032 2a4e 5829 2c20 6474 7970 653d 6e70   2*NX), dtype=np
+000252a0: 2e66 6c6f 6174 3332 2929 0a0a 2020 2020  .float32))..    
+000252b0: 7265 6668 203d 2068 2e68 6561 6465 720a  refh = h.header.
+000252c0: 2020 2020 7265 6668 5b27 4352 5049 5831      refh['CRPIX1
+000252d0: 275d 203d 204e 582b 310a 2020 2020 7265  '] = NX+1.    re
+000252e0: 6668 5b27 4352 5049 5832 275d 203d 204e  fh['CRPIX2'] = N
+000252f0: 592b 310a 2020 2020 7265 6668 5b27 4352  Y+1.    refh['CR
+00025300: 5641 4c31 275d 203d 2063 656e 7465 725f  VAL1'] = center_
+00025310: 7761 7665 2f31 2e65 340a 2020 2020 7265  wave/1.e4.    re
+00025320: 6668 5b27 4344 315f 3127 5d20 3d20 646c  fh['CD1_1'] = dl
+00025330: 616d 2f31 2e65 340a 2020 2020 7265 6668  am/1.e4.    refh
+00025340: 5b27 4344 315f 3227 5d20 3d20 302e 0a20  ['CD1_2'] = 0.. 
+00025350: 2020 2072 6566 685b 2743 5256 414c 3227     refh['CRVAL2'
+00025360: 5d20 3d20 302e 0a20 2020 2072 6566 685b  ] = 0..    refh[
+00025370: 2743 4432 5f32 275d 203d 2073 7061 7469  'CD2_2'] = spati
+00025380: 616c 5f73 6361 6c65 0a20 2020 2072 6566  al_scale.    ref
+00025390: 685b 2743 4432 5f31 275d 203d 2030 2e0a  h['CD2_1'] = 0..
+000253a0: 2020 2020 7265 6668 5b27 5241 4445 5359      refh['RADESY
+000253b0: 5327 5d20 3d20 2727 0a0a 2020 2020 7265  S'] = ''..    re
+000253c0: 6668 5b27 4354 5950 4531 275d 203d 2027  fh['CTYPE1'] = '
+000253d0: 5241 2d2d 2d54 414e 2d53 4950 270a 2020  RA---TAN-SIP'.  
+000253e0: 2020 7265 6668 5b27 4355 4e49 5431 275d    refh['CUNIT1']
+000253f0: 203d 2027 6d61 7327 0a20 2020 2072 6566   = 'mas'.    ref
+00025400: 685b 2743 5459 5045 3227 5d20 3d20 2744  h['CTYPE2'] = 'D
+00025410: 4543 2d2d 5441 4e2d 5349 5027 0a20 2020  EC--TAN-SIP'.   
+00025420: 2072 6566 685b 2743 554e 4954 3227 5d20   refh['CUNIT2'] 
+00025430: 3d20 276d 6173 270a 0a20 2020 2072 6566  = 'mas'..    ref
+00025440: 5f77 6373 203d 2070 7977 6373 2e57 4353  _wcs = pywcs.WCS
+00025450: 2872 6566 6829 0a20 2020 2072 6566 5f77  (refh).    ref_w
+00025460: 6373 2e70 7363 616c 6520 3d20 6765 745f  cs.pscale = get_
+00025470: 7763 735f 7073 6361 6c65 2872 6566 5f77  wcs_pscale(ref_w
+00025480: 6373 290a 0a20 2020 2072 6574 7572 6e20  cs)..    return 
+00025490: 7265 6668 2c20 7265 665f 7763 730a 0a0a  refh, ref_wcs...
+000254a0: 6465 6620 6d61 6b65 5f73 7065 6374 7275  def make_spectru
+000254b0: 6d5f 7763 7368 6561 6465 7228 6365 6e74  m_wcsheader(cent
+000254c0: 6572 5f77 6176 653d 312e 3465 342c 2064  er_wave=1.4e4, d
+000254d0: 6c61 6d3d 3430 2c20 4e58 3d31 3030 2c20  lam=40, NX=100, 
+000254e0: 7370 6174 6961 6c5f 7363 616c 653d 312c  spatial_scale=1,
+000254f0: 204e 593d 3130 293a 0a20 2020 2022 2222   NY=10):.    """
+00025500: 4d61 6b65 2061 2057 4353 2068 6561 6465  Make a WCS heade
+00025510: 7220 666f 7220 6120 3244 2073 7065 6374  r for a 2D spect
+00025520: 7275 6d0a 0a20 2020 2050 6172 616d 6574  rum..    Paramet
+00025530: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00025540: 2d2d 0a20 2020 2063 656e 7465 725f 7761  --.    center_wa
+00025550: 7665 203a 2066 6c6f 6174 0a20 2020 2020  ve : float.     
+00025560: 2020 2057 6176 656c 656e 6774 6820 6f66     Wavelength of
+00025570: 2074 6865 2063 656e 7472 616c 2070 6978   the central pix
+00025580: 656c 2c20 696e 2041 6e73 7472 6f6d 730a  el, in Anstroms.
+00025590: 0a20 2020 2064 6c61 6d20 3a20 666c 6f61  .    dlam : floa
+000255a0: 740a 2020 2020 2020 2020 4465 6c74 612d  t.        Delta-
+000255b0: 7761 7665 6c65 6e67 7468 2070 6572 2028  wavelength per (
+000255c0: 7829 2070 6978 656c 0a0a 2020 2020 4e58  x) pixel..    NX
+000255d0: 2c20 4e59 203a 2069 6e74 0a20 2020 2020  , NY : int.     
+000255e0: 2020 204e 756d 6265 7220 6f66 2078 2026     Number of x &
+000255f0: 2079 2070 6978 656c 732e 204f 7574 7075   y pixels. Outpu
+00025600: 7420 7769 6c6c 2068 6176 6520 7368 6170  t will have shap
+00025610: 6520 6028 322a 4e59 2c20 322a 4e58 2960  e `(2*NY, 2*NX)`
+00025620: 2e0a 0a20 2020 2073 7061 7469 616c 5f73  ...    spatial_s
+00025630: 6361 6c65 203a 2066 6c6f 6174 0a20 2020  cale : float.   
+00025640: 2020 2020 2053 7061 7469 616c 2073 6361       Spatial sca
+00025650: 6c65 206f 6620 7468 6520 6f75 7470 7574  le of the output
+00025660: 2c20 696e 2075 6e69 7473 206f 6620 7468  , in units of th
+00025670: 6520 696e 7075 7420 7069 7865 6c73 0a0a  e input pixels..
+00025680: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00025690: 2d2d 2d2d 2d2d 2d0a 2020 2020 6865 6164  -------.    head
+000256a0: 6572 203a 2060 7e61 7374 726f 7079 2e69  er : `~astropy.i
+000256b0: 6f2e 6669 7473 2e48 6561 6465 7260 0a20  o.fits.Header`. 
+000256c0: 2020 2020 2020 204f 7574 7075 7420 5743         Output WC
+000256d0: 5320 6865 6164 6572 0a0a 2020 2020 7763  S header..    wc
+000256e0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
+000256f0: 732e 5743 5360 0a20 2020 2020 2020 204f  s.WCS`.        O
+00025700: 7574 7075 7420 5743 530a 0a20 2020 2045  utput WCS..    E
+00025710: 7861 6d70 6c65 730a 2020 2020 2d2d 2d2d  xamples.    ----
+00025720: 2d2d 2d2d 0a0a 2020 2020 2020 2020 3e3e  ----..        >>
+00025730: 3e20 6672 6f6d 2067 7269 7a6c 692e 7574  > from grizli.ut
+00025740: 696c 7320 696d 706f 7274 206d 616b 655f  ils import make_
+00025750: 7370 6563 7472 756d 5f77 6373 6865 6164  spectrum_wcshead
+00025760: 6572 0a20 2020 2020 2020 203e 3e3e 2068  er.        >>> h
+00025770: 2c20 7763 7320 3d20 6d61 6b65 5f73 7065  , wcs = make_spe
+00025780: 6374 7275 6d5f 7763 7368 6561 6465 7228  ctrum_wcsheader(
+00025790: 290a 2020 2020 2020 2020 3e3e 3e20 7072  ).        >>> pr
+000257a0: 696e 7428 7763 7329 0a20 2020 2020 2020  int(wcs).       
+000257b0: 2057 4353 204b 6579 776f 7264 730a 2020   WCS Keywords.  
+000257c0: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
+000257d0: 5743 5320 6178 6573 3a20 320a 2020 2020  WCS axes: 2.    
+000257e0: 2020 2020 4354 5950 4520 3a20 2757 4156      CTYPE : 'WAV
+000257f0: 4527 2020 274c 494e 4541 5227 0a20 2020  E'  'LINEAR'.   
+00025800: 2020 2020 2043 5256 414c 203a 2031 3430       CRVAL : 140
+00025810: 3030 2e30 2020 302e 300a 2020 2020 2020  00.0  0.0.      
+00025820: 2020 4352 5049 5820 3a20 3130 312e 3020    CRPIX : 101.0 
+00025830: 2031 312e 300a 2020 2020 2020 2020 4344   11.0.        CD
+00025840: 315f 3120 4344 315f 3220 203a 2034 302e  1_1 CD1_2  : 40.
+00025850: 3020 2030 2e30 0a20 2020 2020 2020 2043  0  0.0.        C
+00025860: 4432 5f31 2043 4432 5f32 2020 3a20 302e  D2_1 CD2_2  : 0.
+00025870: 3020 2031 2e30 0a20 2020 2020 2020 204e  0  1.0.        N
+00025880: 4158 4953 2020 2020 3a20 3230 3020 3230  AXIS    : 200 20
+00025890: 0a0a 2020 2020 2222 220a 0a20 2020 2068  ..    """..    h
+000258a0: 203d 2070 7966 6974 732e 496d 6167 6548   = pyfits.ImageH
+000258b0: 4455 2864 6174 613d 6e70 2e7a 6572 6f73  DU(data=np.zeros
+000258c0: 2828 322a 4e59 2c20 322a 4e58 292c 2064  ((2*NY, 2*NX), d
+000258d0: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
+000258e0: 290a 0a20 2020 2072 6566 6820 3d20 682e  )..    refh = h.
+000258f0: 6865 6164 6572 0a20 2020 2072 6566 685b  header.    refh[
+00025900: 2743 5250 4958 3127 5d20 3d20 4e58 2b31  'CRPIX1'] = NX+1
+00025910: 0a20 2020 2072 6566 685b 2743 5250 4958  .    refh['CRPIX
+00025920: 3227 5d20 3d20 4e59 2b31 0a20 2020 2072  2'] = NY+1.    r
+00025930: 6566 685b 2743 5256 414c 3127 5d20 3d20  efh['CRVAL1'] = 
+00025940: 6365 6e74 6572 5f77 6176 650a 2020 2020  center_wave.    
+00025950: 7265 6668 5b27 4344 315f 3127 5d20 3d20  refh['CD1_1'] = 
+00025960: 646c 616d 0a20 2020 2072 6566 685b 2743  dlam.    refh['C
+00025970: 4431 5f32 275d 203d 2030 2e0a 2020 2020  D1_2'] = 0..    
+00025980: 7265 6668 5b27 4352 5641 4c32 275d 203d  refh['CRVAL2'] =
+00025990: 2030 2e0a 2020 2020 7265 6668 5b27 4344   0..    refh['CD
+000259a0: 325f 3227 5d20 3d20 7370 6174 6961 6c5f  2_2'] = spatial_
+000259b0: 7363 616c 650a 2020 2020 7265 6668 5b27  scale.    refh['
+000259c0: 4344 325f 3127 5d20 3d20 302e 0a20 2020  CD2_1'] = 0..   
+000259d0: 2072 6566 685b 2752 4144 4553 5953 275d   refh['RADESYS']
+000259e0: 203d 2027 270a 0a20 2020 2072 6566 685b   = ''..    refh[
+000259f0: 2743 5459 5045 3127 5d20 3d20 2757 4156  'CTYPE1'] = 'WAV
+00025a00: 4527 0a20 2020 2072 6566 685b 2743 5459  E'.    refh['CTY
+00025a10: 5045 3227 5d20 3d20 274c 494e 4541 5227  PE2'] = 'LINEAR'
+00025a20: 0a0a 2020 2020 7265 665f 7763 7320 3d20  ..    ref_wcs = 
+00025a30: 7079 7763 732e 5743 5328 682e 6865 6164  pywcs.WCS(h.head
+00025a40: 6572 290a 2020 2020 7265 665f 7763 732e  er).    ref_wcs.
+00025a50: 7073 6361 6c65 203d 206e 702e 7371 7274  pscale = np.sqrt
+00025a60: 2872 6566 5f77 6373 2e77 6373 2e63 645b  (ref_wcs.wcs.cd[
+00025a70: 302c 2030 5d2a 2a32 202b 2072 6566 5f77  0, 0]**2 + ref_w
+00025a80: 6373 2e77 6373 2e63 645b 312c 2030 5d2a  cs.wcs.cd[1, 0]*
+00025a90: 2a32 292a 3336 3030 2e0a 0a20 2020 2072  *2)*3600...    r
+00025aa0: 6574 7572 6e20 7265 6668 2c20 7265 665f  eturn refh, ref_
+00025ab0: 7763 730a 0a0a 6465 6620 7265 6164 5f67  wcs...def read_g
+00025ac0: 7a69 7070 6564 5f68 6561 6465 7228 6669  zipped_header(fi
+00025ad0: 6c65 3d27 7465 7374 2e66 6974 732e 677a  le='test.fits.gz
+00025ae0: 272c 2042 4c4f 434b 3d31 3032 342c 204e  ', BLOCK=1024, N
+00025af0: 4d41 583d 3235 362c 206e 7370 6163 653d  MAX=256, nspace=
+00025b00: 3136 2c20 7374 7269 703d 4661 6c73 6529  16, strip=False)
+00025b10: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+00025b20: 6164 2070 7269 6d61 7279 2068 6561 6465  ad primary heade
+00025b30: 7220 6672 6f6d 2061 2028 706f 7465 6e74  r from a (potent
+00025b40: 6961 6c6c 7920 6c61 7267 6529 207a 6970  ially large) zip
+00025b50: 7065 6420 4649 5453 2066 696c 650a 0a20  ped FITS file.. 
+00025b60: 2020 2054 6865 2073 6372 6970 7420 7072     The script pr
+00025b70: 6f63 6565 6473 2062 7920 7265 6164 696e  oceeds by readin
+00025b80: 6720 604e 4d41 5860 2073 6567 6d65 6e74  g `NMAX` segment
+00025b90: 7320 6f66 2073 697a 6520 6042 4c4f 434b  s of size `BLOCK
+00025ba0: 6020 6279 7465 7320 6672 6f6d 0a20 2020  ` bytes from.   
+00025bb0: 2074 6865 2066 696c 6520 616e 6420 7365   the file and se
+00025bc0: 6172 6368 696e 6720 666f 7220 6120 7374  arching for a st
+00025bd0: 7269 6e67 2060 454e 4420 2b20 2720 272a  ring `END + ' '*
+00025be0: 6e73 7061 6365 6020 696e 2074 6865 2064  nspace` in the d
+00025bf0: 6174 610a 2020 2020 696e 6469 6361 7469  ata.    indicati
+00025c00: 6e67 2074 6865 2065 6e64 206f 6620 7468  ng the end of th
+00025c10: 6520 7072 696d 6172 7920 6865 6164 6572  e primary header
+00025c20: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00025c30: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00025c40: 0a20 2020 2066 696c 6520 3a20 7374 720a  .    file : str.
+00025c50: 2020 2020 2020 2020 4669 6c65 6e61 6d65          Filename
+00025c60: 206f 6620 677a 6970 7065 6420 4649 5453   of gzipped FITS
+00025c70: 2066 696c 650a 0a20 2020 2042 4c4f 434b   file..    BLOCK
+00025c80: 2c20 4e4d 4158 2c20 6e73 7061 6365 203a  , NMAX, nspace :
+00025c90: 2069 6e74 0a20 2020 2020 2020 2050 6172   int.        Par
+00025ca0: 616d 6574 6572 7320 666f 7220 7265 6164  ameters for read
+00025cb0: 696e 6720 6279 7465 7320 6672 6f6d 2074  ing bytes from t
+00025cc0: 6865 2069 6e70 7574 2066 696c 650a 0a20  he input file.. 
+00025cd0: 2020 2073 7472 6970 203a 2062 6f6f 6c0a     strip : bool.
+00025ce0: 2020 2020 2020 2020 5365 6e64 206f 7574          Send out
+00025cf0: 7075 7420 7468 726f 7567 6820 6073 7472  put through `str
+00025d00: 6970 5f68 6561 6465 725f 6b65 7973 602e  ip_header_keys`.
+00025d10: 0a0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+00025d20: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2068     -------.    h
+00025d30: 6561 6465 7220 3a20 607e 6173 7472 6f70  eader : `~astrop
+00025d40: 792e 696f 2e66 6974 732e 4865 6164 6572  y.io.fits.Header
+00025d50: 600a 2020 2020 2020 2020 4865 6164 6572  `.        Header
+00025d60: 206f 626a 6563 740a 0a20 2020 2022 2222   object..    """
+00025d70: 0a20 2020 2069 6d70 6f72 7420 677a 6970  .    import gzip
+00025d80: 0a20 2020 2069 6d70 6f72 7420 6173 7472  .    import astr
+00025d90: 6f70 792e 696f 2e66 6974 7320 6173 2070  opy.io.fits as p
+00025da0: 7966 6974 730a 0a20 2020 2066 203d 2067  yfits..    f = g
+00025db0: 7a69 702e 477a 6970 4669 6c65 2866 696c  zip.GzipFile(fil
+00025dc0: 656f 626a 3d6f 7065 6e28 6669 6c65 2c20  eobj=open(file, 
+00025dd0: 2772 6227 2929 0a0a 2020 2020 6461 7461  'rb'))..    data
+00025de0: 203d 2062 2727 0a20 2020 2065 6e64 203d   = b''.    end =
+00025df0: 2062 2720 454e 4427 2b62 2720 272a 6e73   b' END'+b' '*ns
+00025e00: 7061 6365 0a0a 2020 2020 666f 7220 6920  pace..    for i 
+00025e10: 696e 2072 616e 6765 284e 4d41 5829 3a0a  in range(NMAX):.
+00025e20: 2020 2020 2020 2020 6461 7461 5f69 203d          data_i =
+00025e30: 2066 2e72 6561 6428 424c 4f43 4b29 0a20   f.read(BLOCK). 
+00025e40: 2020 2020 2020 2069 6620 656e 6420 696e         if end in
+00025e50: 2064 6174 615f 693a 0a20 2020 2020 2020   data_i:.       
+00025e60: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00025e70: 2020 2020 6461 7461 202b 3d20 6461 7461      data += data
+00025e80: 5f69 0a0a 2020 2020 6966 2028 6920 3d3d  _i..    if (i ==
+00025e90: 204e 4d41 582d 3129 3a0a 2020 2020 2020   NMAX-1):.      
+00025ea0: 2020 7072 696e 7428 2745 7272 6f72 3a20    print('Error: 
+00025eb0: 454e 442b 7b33 7d2a 2220 2220 6e6f 7420  END+{3}*" " not 
+00025ec0: 666f 756e 6420 696e 2066 6972 7374 207b  found in first {
+00025ed0: 307d 787b 317d 2062 7974 6573 206f 6620  0}x{1} bytes of 
+00025ee0: 7b32 7d29 272e 666f 726d 6174 284e 4d41  {2})'.format(NMA
+00025ef0: 582c 2042 4c4f 434b 2c20 6669 6c65 2c20  X, BLOCK, file, 
+00025f00: 6e73 7061 6365 2929 0a20 2020 2020 2020  nspace)).       
+00025f10: 2066 2e63 6c6f 7365 2829 0a20 2020 2020   f.close().     
+00025f20: 2020 2072 6574 7572 6e20 7b7d 0a0a 2020     return {}..  
+00025f30: 2020 6978 203d 2064 6174 615f 692e 696e    ix = data_i.in
+00025f40: 6465 7828 656e 6429 0a20 2020 2064 6174  dex(end).    dat
+00025f50: 6120 2b3d 2064 6174 615f 695b 3a69 785d  a += data_i[:ix]
+00025f60: 2b65 6e64 2020 2320 6461 7461 5f69 5b3a  +end  # data_i[:
+00025f70: 6978 5d0a 0a20 2020 2066 2e63 6c6f 7365  ix]..    f.close
+00025f80: 2829 0a20 2020 2064 6174 615f 7374 7220  ().    data_str 
+00025f90: 3d20 6461 7461 2e64 6563 6f64 6528 2775  = data.decode('u
+00025fa0: 7466 3827 290a 2020 2020 6820 3d20 7079  tf8').    h = py
+00025fb0: 6669 7473 2e48 6561 6465 722e 6672 6f6d  fits.Header.from
+00025fc0: 7374 7269 6e67 2864 6174 615f 7374 7229  string(data_str)
+00025fd0: 0a0a 2020 2020 6966 2073 7472 6970 3a0a  ..    if strip:.
+00025fe0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00025ff0: 7472 6970 5f68 6561 6465 725f 6b65 7973  trip_header_keys
+00026000: 2868 2c20 7573 6577 6373 3d54 7275 6529  (h, usewcs=True)
+00026010: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00026020: 2020 2072 6574 7572 6e20 680a 0a0a 4452     return h...DR
+00026030: 495a 5a4c 455f 4b45 5953 203d 205b 2747  IZZLE_KEYS = ['G
+00026040: 454f 4d27 2c20 2744 4154 4127 2c20 2744  EOM', 'DATA', 'D
+00026050: 4558 5027 2c20 274f 5544 4127 2c20 274f  EXP', 'OUDA', 'O
+00026060: 5557 4527 2c20 274f 5543 4f27 2c20 274d  UWE', 'OUCO', 'M
+00026070: 4153 4b27 2c20 2757 5453 4327 2c20 274b  ASK', 'WTSC', 'K
+00026080: 4552 4e27 2c20 2750 4958 4627 2c20 2743  ERN', 'PIXF', 'C
+00026090: 4f45 4627 2c20 274f 5555 4e27 2c20 2746  OEF', 'OUUN', 'F
+000260a0: 5641 4c27 2c20 2757 4b45 5927 2c20 2753  VAL', 'WKEY', 'S
+000260b0: 4341 4c27 2c20 2749 5343 4c27 5d0a 0a0a  CAL', 'ISCL']...
+000260c0: 6465 6620 7374 7269 705f 6865 6164 6572  def strip_header
+000260d0: 5f6b 6579 7328 6865 6164 6572 2c20 636f  _keys(header, co
+000260e0: 6d6d 656e 743d 5472 7565 2c20 6869 7374  mment=True, hist
+000260f0: 6f72 793d 5472 7565 2c20 6472 697a 7a6c  ory=True, drizzl
+00026100: 655f 6b65 7973 3d44 5249 5a5a 4c45 5f4b  e_keys=DRIZZLE_K
+00026110: 4559 532c 2075 7365 7763 733d 4661 6c73  EYS, usewcs=Fals
+00026120: 652c 206b 6565 705f 7769 7468 5f77 6373  e, keep_with_wcs
+00026130: 3d5b 2745 5850 5449 4d45 272c 2027 4649  =['EXPTIME', 'FI
+00026140: 4c54 4552 272c 2027 5445 4c45 5343 4f50  LTER', 'TELESCOP
+00026150: 272c 2027 494e 5354 5255 4d45 272c 2027  ', 'INSTRUME', '
+00026160: 4441 5445 2d4f 4253 272c 2027 4558 5053  DATE-OBS', 'EXPS
+00026170: 5441 5254 272c 2027 4558 5045 4e44 275d  TART', 'EXPEND']
+00026180: 293a 0a20 2020 2022 2222 0a20 2020 2053  ):.    """.    S
+00026190: 7472 6970 2068 6561 6465 7220 6b65 7977  trip header keyw
+000261a0: 6f72 6473 0a0a 2020 2020 5061 7261 6d65  ords..    Parame
+000261b0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+000261c0: 2d2d 2d0a 0a20 2020 2063 6f6d 6d65 6e74  ---..    comment
+000261d0: 2c20 6869 7374 6f72 7920 3a20 626f 6f6c  , history : bool
+000261e0: 0a20 2020 2020 2020 2053 7472 6970 2027  .        Strip '
+000261f0: 434f 4d4d 454e 5427 2061 6e64 2027 4849  COMMENT' and 'HI
+00026200: 5354 4f52 5927 206b 6579 776f 7264 732c  STORY' keywords,
+00026210: 2072 6573 7065 6374 6976 656c 792e 0a0a   respectively...
+00026220: 2020 2020 6472 697a 7a6c 655f 6b65 7973      drizzle_keys
+00026230: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00026240: 5374 7269 7020 6b65 7973 2070 726f 6475  Strip keys produ
+00026250: 6365 6420 6279 2060 7e64 7269 7a7a 6c65  ced by `~drizzle
+00026260: 7061 632e 6173 7472 6f64 7269 7a7a 6c65  pac.astrodrizzle
+00026270: 602e 0a0a 2020 2020 7573 6577 6373 203a  `...    usewcs :
+00026280: 2062 6f6f 6c0a 2020 2020 2020 2020 416c   bool.        Al
+00026290: 7465 726e 6174 6976 656c 792c 206a 7573  ternatively, jus
+000262a0: 7420 6765 6e65 7261 7465 2061 2073 696d  t generate a sim
+000262b0: 706c 6520 5743 532d 6f6e 6c79 2068 6561  ple WCS-only hea
+000262c0: 6465 7220 6672 6f6d 2074 6865 2069 6e70  der from the inp
+000262d0: 7574 0a20 2020 2020 2020 2068 6561 6465  ut.        heade
+000262e0: 722e 0a0a 2020 2020 6b65 6570 5f77 6974  r...    keep_wit
+000262f0: 685f 7763 7320 3a20 6c69 7374 0a20 2020  h_wcs : list.   
+00026300: 2020 2020 2041 6464 6974 696f 6e61 6c20       Additional 
+00026310: 6b65 7973 2074 6f20 7472 7920 746f 2061  keys to try to a
+00026320: 6464 2074 6f20 7468 6520 6075 7365 7763  dd to the `usewc
+00026330: 7360 2068 6561 6465 722e 0a0a 2020 2020  s` header...    
+00026340: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00026350: 2d2d 2d0a 0a20 2020 2068 6561 6465 7220  ---..    header 
+00026360: 3a20 607e 6173 7472 6f70 792e 696f 2e66  : `~astropy.io.f
+00026370: 6974 732e 4865 6164 6572 600a 2020 2020  its.Header`.    
+00026380: 2020 2020 4865 6164 6572 206f 626a 6563      Header objec
+00026390: 742e 0a0a 2020 2020 2222 220a 2020 2020  t...    """.    
+000263a0: 696d 706f 7274 2063 6f70 790a 2020 2020  import copy.    
+000263b0: 696d 706f 7274 2061 7374 726f 7079 2e77  import astropy.w
+000263c0: 6373 2061 7320 7079 7763 730a 0a20 2020  cs as pywcs..   
+000263d0: 2023 2050 6172 7365 2057 4353 2061 6e64   # Parse WCS and
+000263e0: 2062 7569 6c64 2068 6561 6465 720a 2020   build header.  
+000263f0: 2020 6966 2075 7365 7763 733a 0a20 2020    if usewcs:.   
+00026400: 2020 2020 2077 6373 203d 2070 7977 6373       wcs = pywcs
+00026410: 2e57 4353 2868 6561 6465 7229 0a20 2020  .WCS(header).   
+00026420: 2020 2020 2068 203d 2074 6f5f 6865 6164       h = to_head
+00026430: 6572 2877 6373 290a 2020 2020 2020 2020  er(wcs).        
+00026440: 666f 7220 6b20 696e 206b 6565 705f 7769  for k in keep_wi
+00026450: 7468 5f77 6373 3a0a 2020 2020 2020 2020  th_wcs:.        
+00026460: 2020 2020 6966 206b 2069 6e20 6865 6164      if k in head
+00026470: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00026480: 2020 2020 6966 206b 2069 6e20 6865 6164      if k in head
+00026490: 6572 2e63 6f6d 6d65 6e74 733a 0a20 2020  er.comments:.   
+000264a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264b0: 2068 5b6b 5d20 3d20 6865 6164 6572 5b6b   h[k] = header[k
+000264c0: 5d2c 2068 6561 6465 722e 636f 6d6d 656e  ], header.commen
+000264d0: 7473 5b6b 5d0a 2020 2020 2020 2020 2020  ts[k].          
+000264e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000264f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026500: 685b 6b5d 203d 2068 6561 6465 725b 6b5d  h[k] = header[k]
+00026510: 0a0a 2020 2020 2020 2020 6966 2027 4649  ..        if 'FI
+00026520: 4c54 4552 2720 696e 206b 6565 705f 7769  LTER' in keep_wi
+00026530: 7468 5f77 6373 3a0a 2020 2020 2020 2020  th_wcs:.        
+00026540: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00026550: 2020 2020 2020 2020 2068 5b27 4649 4c54           h['FILT
+00026560: 4552 275d 203d 2028 7061 7273 655f 6669  ER'] = (parse_fi
+00026570: 6c74 6572 5f66 726f 6d5f 6865 6164 6572  lter_from_header
+00026580: 2868 6561 6465 7229 2c0a 2020 2020 2020  (header),.      
+00026590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000265a0: 2020 2020 2020 2020 2027 656c 656d 656e           'elemen
+000265b0: 7420 7365 6c65 6374 6564 2066 726f 6d20  t selected from 
+000265c0: 6669 6c74 6572 2077 6865 656c 2729 0a20  filter wheel'). 
+000265d0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000265e0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000265f0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
+00026600: 2072 6574 7572 6e20 680a 0a20 2020 2068   return h..    h
+00026610: 203d 2063 6f70 792e 6465 6570 636f 7079   = copy.deepcopy
+00026620: 2868 6561 6465 7229 0a20 2020 206b 6579  (header).    key
+00026630: 7320 3d20 6c69 7374 2868 2e6b 6579 7328  s = list(h.keys(
+00026640: 2929 0a20 2020 2073 7472 6970 5f6b 6579  )).    strip_key
+00026650: 7320 3d20 5b5d 0a20 2020 2069 6620 636f  s = [].    if co
+00026660: 6d6d 656e 743a 0a20 2020 2020 2020 2073  mment:.        s
+00026670: 7472 6970 5f6b 6579 732e 6170 7065 6e64  trip_keys.append
+00026680: 2827 434f 4d4d 454e 5427 290a 0a20 2020  ('COMMENT')..   
+00026690: 2069 6620 6869 7374 6f72 793a 0a20 2020   if history:.   
+000266a0: 2020 2020 2073 7472 6970 5f6b 6579 732e       strip_keys.
+000266b0: 6170 7065 6e64 2827 4849 5354 4f52 5927  append('HISTORY'
+000266c0: 290a 0a20 2020 2066 6f72 206b 2069 6e20  )..    for k in 
+000266d0: 6b65 7973 3a0a 2020 2020 2020 2020 6966  keys:.        if
+000266e0: 206b 2069 6e20 7374 7269 705f 6b65 7973   k in strip_keys
+000266f0: 3a0a 2020 2020 2020 2020 2020 2020 682e  :.            h.
+00026700: 7265 6d6f 7665 286b 290a 0a20 2020 2020  remove(k)..     
+00026710: 2020 2069 6620 6472 697a 7a6c 655f 6b65     if drizzle_ke
+00026720: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00026730: 6966 206b 2e73 7461 7274 7377 6974 6828  if k.startswith(
+00026740: 2744 2729 3a0a 2020 2020 2020 2020 2020  'D'):.          
+00026750: 2020 2020 2020 6966 2028 6b5b 2d34 3a5d        if (k[-4:]
+00026760: 2069 6e20 6472 697a 7a6c 655f 6b65 7973   in drizzle_keys
+00026770: 2920 7c20 6b2e 656e 6473 7769 7468 2827  ) | k.endswith('
+00026780: 5645 5227 293a 0a20 2020 2020 2020 2020  VER'):.         
+00026790: 2020 2020 2020 2020 2020 2068 2e72 656d             h.rem
+000267a0: 6f76 6528 6b29 0a0a 2020 2020 7265 7475  ove(k)..    retu
+000267b0: 726e 2068 0a0a 0a64 6566 2077 6373 5f66  rn h...def wcs_f
+000267c0: 726f 6d5f 6865 6164 6572 2868 6561 6465  rom_header(heade
+000267d0: 722c 2072 656c 6178 3d54 7275 652c 202a  r, relax=True, *
+000267e0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+000267f0: 220a 2020 2020 496e 6974 6961 6c69 7a65  ".    Initialize
+00026800: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
+00026810: 4353 6020 6672 6f6d 2061 2060 7e61 7374  CS` from a `~ast
+00026820: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
+00026830: 6465 7260 0a20 2020 200a 2020 2020 5061  der`.    .    Pa
+00026840: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00026850: 2d2d 2d2d 2d2d 2d0a 2020 2020 6865 6164  -------.    head
+00026860: 6572 203a 2060 7e61 7374 726f 7079 2e69  er : `~astropy.i
+00026870: 6f2e 6669 7473 2e48 6561 6465 7260 0a20  o.fits.Header`. 
+00026880: 2020 2020 2020 2046 4954 5320 6865 6164         FITS head
+00026890: 6572 2077 6974 6820 6f70 7469 6f6e 616c  er with optional
+000268a0: 2060 6053 4950 4352 5058 3160 6020 616e   ``SIPCRPX1`` an
+000268b0: 6420 6060 5349 5043 5250 5832 6060 206b  d ``SIPCRPX2`` k
+000268c0: 6579 776f 7264 7320 7468 6174 0a20 2020  eywords that.   
+000268d0: 2020 2020 2064 6566 696e 6520 6120 7365       define a se
+000268e0: 7061 7261 7465 2072 6566 6572 656e 6365  parate reference
+000268f0: 2070 6978 656c 2066 6f72 2061 2053 4950   pixel for a SIP
+00026900: 2068 6561 6465 720a 2020 2020 0a20 2020   header.    .   
+00026910: 2072 656c 6178 2c20 6b77 6172 6773 203a   relax, kwargs :
+00026920: 2062 6f6f 6c2c 2064 6963 740a 2020 2020   bool, dict.    
+00026930: 2020 2020 4b65 7977 6f72 6473 2070 6173      Keywords pas
+00026940: 7365 6420 746f 2060 6173 7472 6f70 792e  sed to `astropy.
+00026950: 7763 732e 5743 5360 0a20 2020 200a 2020  wcs.WCS`.    .  
+00026960: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00026970: 2d2d 2d2d 2d0a 2020 2020 7763 7320 3a20  -----.    wcs : 
+00026980: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
+00026990: 5360 0a20 2020 2020 2020 2057 4353 206f  S`.        WCS o
+000269a0: 626a 6563 740a 2020 2020 2020 2020 0a20  bject.        . 
+000269b0: 2020 2022 2222 0a20 2020 2077 6373 203d     """.    wcs =
+000269c0: 2070 7977 6373 2e57 4353 2868 6561 6465   pywcs.WCS(heade
+000269d0: 722c 2072 656c 6178 3d72 656c 6178 290a  r, relax=relax).
+000269e0: 2020 2020 0a20 2020 2069 6620 2827 5349      .    if ('SI
+000269f0: 5043 5250 5831 2720 696e 2068 6561 6465  PCRPX1' in heade
+00026a00: 7229 2026 2068 6173 6174 7472 2877 6373  r) & hasattr(wcs
+00026a10: 2c20 2773 6970 2729 3a0a 2020 2020 2020  , 'sip'):.      
+00026a20: 2020 7763 732e 7369 702e 6372 7069 785b    wcs.sip.crpix[
+00026a30: 305d 203d 2068 6561 6465 725b 2753 4950  0] = header['SIP
+00026a40: 4352 5058 3127 5d0a 2020 2020 2020 2020  CRPX1'].        
+00026a50: 7763 732e 7369 702e 6372 7069 785b 315d  wcs.sip.crpix[1]
+00026a60: 203d 2068 6561 6465 725b 2753 4950 4352   = header['SIPCR
+00026a70: 5058 3227 5d0a 2020 2020 656c 6966 2028  PX2'].    elif (
+00026a80: 2753 4941 465f 5852 4546 5f53 4349 2720  'SIAF_XREF_SCI' 
+00026a90: 696e 2068 6561 6465 7229 2026 2068 6173  in header) & has
+00026aa0: 6174 7472 2877 6373 2c20 2773 6970 2729  attr(wcs, 'sip')
+00026ab0: 3a0a 2020 2020 2020 2020 7763 732e 7369  :.        wcs.si
+00026ac0: 702e 6372 7069 785b 305d 203d 2068 6561  p.crpix[0] = hea
+00026ad0: 6465 725b 2753 4941 465f 5852 4546 5f53  der['SIAF_XREF_S
+00026ae0: 4349 275d 0a20 2020 2020 2020 2077 6373  CI'].        wcs
+00026af0: 2e73 6970 2e63 7270 6978 5b31 5d20 3d20  .sip.crpix[1] = 
+00026b00: 6865 6164 6572 5b27 5349 4146 5f59 5245  header['SIAF_YRE
+00026b10: 465f 5343 4927 5d0a 2020 2020 2020 2020  F_SCI'].        
+00026b20: 0a20 2020 2072 6574 7572 6e20 7763 730a  .    return wcs.
+00026b30: 0a0a 6465 6620 746f 5f68 6561 6465 7228  ..def to_header(
+00026b40: 7763 732c 2061 6464 5f6e 6178 6973 3d54  wcs, add_naxis=T
+00026b50: 7275 652c 2072 656c 6178 3d54 7275 652c  rue, relax=True,
+00026b60: 206b 6579 3d4e 6f6e 6529 3a0a 2020 2020   key=None):.    
+00026b70: 2222 224d 6f64 6966 7920 6061 7374 726f  """Modify `astro
+00026b80: 7079 2e77 6373 2e57 4353 2e74 6f5f 6865  py.wcs.WCS.to_he
+00026b90: 6164 6572 6020 746f 2070 726f 6475 6365  ader` to produce
+00026ba0: 206d 6f72 6520 6b65 7977 6f72 6473 0a0a   more keywords..
+00026bb0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00026bc0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00026bd0: 2020 7763 7320 3a20 607e 6173 7472 6f70    wcs : `~astrop
+00026be0: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
+00026bf0: 2020 2049 6e70 7574 2057 4353 2e0a 0a20     Input WCS... 
+00026c00: 2020 2061 6464 5f6e 6178 6973 203a 2062     add_naxis : b
+00026c10: 6f6f 6c0a 2020 2020 2020 2020 4164 6420  ool.        Add 
+00026c20: 4e41 5849 5320 6b65 7977 6f72 6473 2066  NAXIS keywords f
+00026c30: 726f 6d20 5743 5320 6469 6d65 6e73 696f  rom WCS dimensio
+00026c40: 6e73 0a0a 2020 2020 7265 6c61 7820 3a20  ns..    relax : 
+00026c50: 626f 6f6c 0a20 2020 2020 2020 2050 6173  bool.        Pas
+00026c60: 7365 6420 746f 2060 5743 532e 746f 5f68  sed to `WCS.to_h
+00026c70: 6561 6465 7228 7265 6c61 783d 2960 2e0a  eader(relax=)`..
+00026c80: 0a20 2020 206b 6579 203a 2073 7472 0a20  .    key : str. 
+00026c90: 2020 2020 2020 2053 6565 2060 7e61 7374         See `~ast
+00026ca0: 726f 7079 2e77 6373 2e57 4353 2e74 6f5f  ropy.wcs.WCS.to_
+00026cb0: 6865 6164 6572 602e 0a0a 2020 2020 5265  header`...    Re
+00026cc0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00026cd0: 2d0a 2020 2020 6865 6164 6572 203a 2060  -.    header : `
+00026ce0: 7e61 7374 726f 7079 2e69 6f2e 6669 7473  ~astropy.io.fits
+00026cf0: 2e48 6561 6465 7260 0a20 2020 2020 2020  .Header`.       
+00026d00: 204f 7574 7075 7420 6865 6164 6572 2e0a   Output header..
+00026d10: 0a20 2020 2022 2222 0a20 2020 2068 6561  .    """.    hea
+00026d20: 6465 7220 3d20 7763 732e 746f 5f68 6561  der = wcs.to_hea
+00026d30: 6465 7228 7265 6c61 783d 7265 6c61 782c  der(relax=relax,
+00026d40: 206b 6579 3d6b 6579 290a 2020 2020 6966   key=key).    if
+00026d50: 2061 6464 5f6e 6178 6973 3a0a 2020 2020   add_naxis:.    
+00026d60: 2020 2020 6966 2068 6173 6174 7472 2877      if hasattr(w
+00026d70: 6373 2c20 2770 6978 656c 5f73 6861 7065  cs, 'pixel_shape
+00026d80: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00026d90: 6865 6164 6572 5b27 4e41 5849 5327 5d20  header['NAXIS'] 
+00026da0: 3d20 7763 732e 6e61 7869 730a 2020 2020  = wcs.naxis.    
+00026db0: 2020 2020 2020 2020 6966 2077 6373 2e70          if wcs.p
+00026dc0: 6978 656c 5f73 6861 7065 2069 7320 6e6f  ixel_shape is no
+00026dd0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00026de0: 2020 2020 2020 2020 6865 6164 6572 5b27          header['
+00026df0: 4e41 5849 5331 275d 203d 2077 6373 2e70  NAXIS1'] = wcs.p
+00026e00: 6978 656c 5f73 6861 7065 5b30 5d0a 2020  ixel_shape[0].  
+00026e10: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00026e20: 6164 6572 5b27 4e41 5849 5332 275d 203d  ader['NAXIS2'] =
+00026e30: 2077 6373 2e70 6978 656c 5f73 6861 7065   wcs.pixel_shape
+00026e40: 5b31 5d0a 0a20 2020 2020 2020 2065 6c69  [1]..        eli
+00026e50: 6620 6861 7361 7474 7228 7763 732c 2027  f hasattr(wcs, '
+00026e60: 5f6e 6178 6973 3127 293a 0a20 2020 2020  _naxis1'):.     
+00026e70: 2020 2020 2020 2068 6561 6465 725b 274e         header['N
+00026e80: 4158 4953 275d 203d 2077 6373 2e6e 6178  AXIS'] = wcs.nax
+00026e90: 6973 0a20 2020 2020 2020 2020 2020 2068  is.            h
+00026ea0: 6561 6465 725b 274e 4158 4953 3127 5d20  eader['NAXIS1'] 
+00026eb0: 3d20 7763 732e 5f6e 6178 6973 310a 2020  = wcs._naxis1.  
+00026ec0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00026ed0: 5b27 4e41 5849 5332 275d 203d 2077 6373  ['NAXIS2'] = wcs
+00026ee0: 2e5f 6e61 7869 7332 0a0a 2020 2020 666f  ._naxis2..    fo
+00026ef0: 7220 6b20 696e 2068 6561 6465 723a 0a20  r k in header:. 
+00026f00: 2020 2020 2020 2069 6620 6b2e 7374 6172         if k.star
+00026f10: 7473 7769 7468 2827 5043 2729 3a0a 2020  tswith('PC'):.  
+00026f20: 2020 2020 2020 2020 2020 6364 203d 206b            cd = k
+00026f30: 2e72 6570 6c61 6365 2827 5043 272c 2027  .replace('PC', '
+00026f40: 4344 2729 0a20 2020 2020 2020 2020 2020  CD').           
+00026f50: 2068 6561 6465 722e 7265 6e61 6d65 5f6b   header.rename_k
+00026f60: 6579 776f 7264 286b 2c20 6364 290a 2020  eyword(k, cd).  
+00026f70: 2020 0a20 2020 2069 6620 6861 7361 7474    .    if hasatt
+00026f80: 7228 7763 732e 7763 732c 2027 6364 2729  r(wcs.wcs, 'cd')
+00026f90: 3a0a 2020 2020 2020 2020 666f 7220 6920  :.        for i 
+00026fa0: 696e 205b 302c 315d 3a0a 2020 2020 2020  in [0,1]:.      
+00026fb0: 2020 2020 2020 666f 7220 6a20 696e 205b        for j in [
+00026fc0: 302c 315d 3a0a 2020 2020 2020 2020 2020  0,1]:.          
+00026fd0: 2020 2020 2020 6865 6164 6572 5b66 2743        header[f'C
+00026fe0: 447b 692b 317d 5f7b 6a2b 317d 275d 203d  D{i+1}_{j+1}'] =
+00026ff0: 2077 6373 2e77 6373 2e63 645b 695d 5b6a   wcs.wcs.cd[i][j
+00027000: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00027010: 2020 0a20 2020 2069 6620 6861 7361 7474    .    if hasatt
+00027020: 7228 7763 732c 2027 7369 7027 293a 0a20  r(wcs, 'sip'):. 
+00027030: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+00027040: 7228 7763 732e 7369 702c 2027 6372 7069  r(wcs.sip, 'crpi
+00027050: 7827 293a 0a20 2020 2020 2020 2020 2020  x'):.           
+00027060: 2068 6561 6465 725b 2753 4950 4352 5058   header['SIPCRPX
+00027070: 3127 5d2c 2068 6561 6465 725b 2753 4950  1'], header['SIP
+00027080: 4352 5058 3227 5d20 3d20 7763 732e 7369  CRPX2'] = wcs.si
+00027090: 702e 6372 7069 780a 2020 2020 2020 2020  p.crpix.        
+000270a0: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+000270b0: 6865 6164 6572 0a0a 0a64 6566 206d 616b  header...def mak
+000270c0: 655f 7763 7368 6561 6465 7228 7261 3d34  e_wcsheader(ra=4
+000270d0: 302e 3037 3239 332c 2064 6563 3d2d 312e  0.07293, dec=-1.
+000270e0: 3631 3337 3734 382c 2073 697a 653d 322c  6137748, size=2,
+000270f0: 2070 6978 7363 616c 653d 302e 312c 2067   pixscale=0.1, g
+00027100: 6574 5f68 6475 3d46 616c 7365 2c20 7468  et_hdu=False, th
+00027110: 6574 613d 3029 3a0a 2020 2020 2222 224d  eta=0):.    """M
+00027120: 616b 6520 6120 6365 6c65 7374 6961 6c20  ake a celestial 
+00027130: 5743 5320 6865 6164 6572 0a0a 2020 2020  WCS header..    
+00027140: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00027150: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7261  ---------.    ra
+00027160: 2c20 6465 6320 3a20 666c 6f61 740a 2020  , dec : float.  
+00027170: 2020 2020 2020 4365 6c65 7374 6961 6c20        Celestial 
+00027180: 636f 6f72 6469 6e61 7465 7320 696e 2064  coordinates in d
+00027190: 6563 696d 616c 2064 6567 7265 6573 0a0a  ecimal degrees..
+000271a0: 2020 2020 7369 7a65 2c20 7069 7873 6361      size, pixsca
+000271b0: 6c65 203a 2066 6c6f 6174 206f 7220 322d  le : float or 2-
+000271c0: 6c69 7374 0a20 2020 2020 2020 2053 697a  list.        Siz
+000271d0: 6520 6f66 2074 6865 2074 6875 6d62 6e61  e of the thumbna
+000271e0: 696c 2c20 696e 2061 7263 7365 632c 2061  il, in arcsec, a
+000271f0: 6e64 2070 6978 656c 2073 6361 6c65 2c20  nd pixel scale, 
+00027200: 696e 2061 7263 7365 632f 7069 7865 6c2e  in arcsec/pixel.
+00027210: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
+00027220: 696d 6167 6520 7769 6c6c 2068 6176 6520  image will have 
+00027230: 6469 6d65 6e73 696f 6e73 2060 286e 7069  dimensions `(npi
+00027240: 782c 6e70 6978 2960 2c20 7768 6572 650a  x,npix)`, where.
+00027250: 0a20 2020 2020 2020 2020 2020 203e 3e3e  .            >>>
+00027260: 206e 7069 7820 3d20 7369 7a65 2f70 6978   npix = size/pix
+00027270: 7363 616c 650a 0a20 2020 2067 6574 5f68  scale..    get_h
+00027280: 6475 203a 2062 6f6f 6c0a 2020 2020 2020  du : bool.      
+00027290: 2020 5265 7475 726e 2061 2060 7e61 7374    Return a `~ast
+000272a0: 726f 7079 2e69 6f2e 6669 7473 2e49 6d61  ropy.io.fits.Ima
+000272b0: 6765 4844 5560 2072 6174 6865 7220 7468  geHDU` rather th
+000272c0: 616e 2068 6561 6465 722f 7763 732e 0a0a  an header/wcs...
+000272d0: 2020 2020 7468 6574 6120 3a20 666c 6f61      theta : floa
+000272e0: 740a 2020 2020 2020 2020 506f 7369 7469  t.        Positi
+000272f0: 6f6e 2061 6e67 6c65 206f 6620 7468 6520  on angle of the 
+00027300: 6f75 7470 7574 2074 6875 6d62 6e61 696c  output thumbnail
+00027310: 2028 6465 6772 6565 7329 0a0a 2020 2020   (degrees)..    
+00027320: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00027330: 2d2d 2d0a 2020 2020 6864 7520 3a20 607e  ---.    hdu : `~
+00027340: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+00027350: 496d 6167 6548 4455 600a 2020 2020 2020  ImageHDU`.      
+00027360: 2020 4844 5520 7769 7468 2064 6174 6120    HDU with data 
+00027370: 6669 6c6c 6564 2077 6974 6820 7a65 726f  filled with zero
+00027380: 7320 6966 2060 6765 745f 6864 753d 5472  s if `get_hdu=Tr
+00027390: 7565 602e 0a0a 2020 2020 6865 6164 6572  ue`...    header
+000273a0: 2c20 7763 7320 3a20 607e 6173 7472 6f70  , wcs : `~astrop
+000273b0: 792e 696f 2e66 6974 732e 4865 6164 6572  y.io.fits.Header
+000273c0: 602c 2060 7e61 7374 726f 7079 2e77 6373  `, `~astropy.wcs
+000273d0: 2e57 4353 600a 2020 2020 2020 2020 4865  .WCS`.        He
+000273e0: 6164 6572 2061 6e64 2057 4353 206f 626a  ader and WCS obj
+000273f0: 6563 7420 6966 2060 6765 745f 6864 753d  ect if `get_hdu=
+00027400: 4661 6c73 6560 2e0a 0a20 2020 2045 7861  False`...    Exa
+00027410: 6d70 6c65 730a 2020 2020 2d2d 2d2d 2d2d  mples.    ------
+00027420: 2d2d 0a0a 2020 2020 2020 2020 3e3e 3e20  --..        >>> 
+00027430: 6672 6f6d 2067 7269 7a6c 692e 7574 696c  from grizli.util
+00027440: 7320 696d 706f 7274 206d 616b 655f 7763  s import make_wc
+00027450: 7368 6561 6465 720a 2020 2020 2020 2020  sheader.        
+00027460: 3e3e 3e20 682c 2077 6373 203d 206d 616b  >>> h, wcs = mak
+00027470: 655f 7763 7368 6561 6465 7228 290a 2020  e_wcsheader().  
+00027480: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
+00027490: 7763 7329 0a20 2020 2020 2020 2057 4353  wcs).        WCS
+000274a0: 204b 6579 776f 7264 730a 2020 2020 2020   Keywords.      
+000274b0: 2020 4e75 6d62 6572 206f 6620 5743 5320    Number of WCS 
+000274c0: 6178 6573 3a20 320a 2020 2020 2020 2020  axes: 2.        
+000274d0: 4354 5950 4520 3a20 2752 412d 2d2d 5441  CTYPE : 'RA---TA
+000274e0: 4e27 2020 2744 4543 2d2d 5441 4e27 0a20  N'  'DEC--TAN'. 
+000274f0: 2020 2020 2020 2043 5256 414c 203a 2034         CRVAL : 4
+00027500: 302e 3037 3239 3239 3939 3939 3939 3939  0.07292999999999
+00027510: 3920 202d 312e 3631 3337 3734 3830 3030  9  -1.6137748000
+00027520: 3030 3030 3031 0a20 2020 2020 2020 2043  000001.        C
+00027530: 5250 4958 203a 2031 302e 3020 2031 302e  RPIX : 10.0  10.
+00027540: 300a 2020 2020 2020 2020 4344 315f 3120  0.        CD1_1 
+00027550: 4344 315f 3220 203a 202d 322e 3737 3737  CD1_2  : -2.7777
+00027560: 3737 3737 3737 3737 3765 2d30 3520 2030  777777777e-05  0
+00027570: 2e30 0a20 2020 2020 2020 2043 4432 5f31  .0.        CD2_1
+00027580: 2043 4432 5f32 2020 3a20 302e 3020 2032   CD2_2  : 0.0  2
+00027590: 2e37 3737 3737 3737 3737 3737 3737 3730  .777777777777770
+000275a0: 3165 2d30 350a 2020 2020 2020 2020 4e41  1e-05.        NA
+000275b0: 5849 5320 2020 203a 2032 3020 3230 0a0a  XIS    : 20 20..
+000275c0: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+000275d0: 2067 7269 7a6c 692e 7574 696c 7320 696d   grizli.utils im
+000275e0: 706f 7274 206d 616b 655f 7763 7368 6561  port make_wcshea
+000275f0: 6465 720a 2020 2020 2020 2020 3e3e 3e20  der.        >>> 
+00027600: 6864 7520 3d20 6d61 6b65 5f77 6373 6865  hdu = make_wcshe
+00027610: 6164 6572 2867 6574 5f68 6475 3d54 7275  ader(get_hdu=Tru
+00027620: 6529 0a20 2020 2020 2020 203e 3e3e 2070  e).        >>> p
+00027630: 7269 6e74 2868 6475 2e64 6174 612e 7368  rint(hdu.data.sh
+00027640: 6170 6529 0a20 2020 2020 2020 2028 3230  ape).        (20
+00027650: 2c20 3230 290a 2020 2020 2020 2020 3e3e  , 20).        >>
+00027660: 3e20 7072 696e 7428 6864 752e 6865 6164  > print(hdu.head
+00027670: 6572 2e74 6f73 7472 696e 6729 0a20 2020  er.tostring).   
+00027680: 2020 2020 2058 5445 4e53 494f 4e3d 2027       XTENSION= '
+00027690: 494d 4147 4520 2020 2720 2020 2020 2020  IMAGE   '       
+000276a0: 2020 2020 2f20 496d 6167 6520 6578 7465      / Image exte
+000276b0: 6e73 696f 6e0a 2020 2020 2020 2020 4249  nsion.        BI
+000276c0: 5450 4958 2020 3d20 2020 2020 2020 2020  TPIX  =         
+000276d0: 2020 2020 2020 2020 202d 3332 202f 2061           -32 / a
+000276e0: 7272 6179 2064 6174 6120 7479 7065 0a20  rray data type. 
+000276f0: 2020 2020 2020 204e 4158 4953 2020 203d         NAXIS   =
+00027700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027710: 2020 2020 3220 2f20 6e75 6d62 6572 206f      2 / number o
+00027720: 6620 6172 7261 7920 6469 6d65 6e73 696f  f array dimensio
+00027730: 6e73 0a20 2020 2020 2020 2050 434f 554e  ns.        PCOUN
+00027740: 5420 203d 2020 2020 2020 2020 2020 2020  T  =            
+00027750: 2020 2020 2020 2020 3020 2f20 6e75 6d62          0 / numb
+00027760: 6572 206f 6620 7061 7261 6d65 7465 7273  er of parameters
+00027770: 0a20 2020 2020 2020 2047 434f 554e 5420  .        GCOUNT 
 00027780: 203d 2020 2020 2020 2020 2020 2020 2020   =              
-00027790: 2020 2020 302e 300a 2020 2020 2020 2020      0.0.        
-000277a0: 4344 325f 3220 2020 3d20 322e 3737 3737  CD2_2   = 2.7777
-000277b0: 3737 3737 3737 3737 3737 452d 3035 0a20  7777777777E-05. 
-000277c0: 2020 2020 2020 204e 4158 4953 3120 203d         NAXIS1  =
-000277d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000277e0: 2020 2032 300a 2020 2020 2020 2020 4e41     20.        NA
-000277f0: 5849 5332 2020 3d20 2020 2020 2020 2020  XIS2  =         
-00027800: 2020 2020 2020 2020 2020 3230 0a20 2020            20.   
-00027810: 2020 2020 2043 5459 5045 3120 203d 2027       CTYPE1  = '
-00027820: 5241 2d2d 2d54 414e 270a 2020 2020 2020  RA---TAN'.      
-00027830: 2020 4354 5950 4532 2020 3d20 2744 4543    CTYPE2  = 'DEC
-00027840: 2d2d 5441 4e27 0a20 2020 2022 2222 0a0a  --TAN'.    """..
-00027850: 2020 2020 6966 206e 702e 6973 7363 616c      if np.isscal
-00027860: 6172 2870 6978 7363 616c 6529 3a0a 2020  ar(pixscale):.  
-00027870: 2020 2020 2020 6364 656c 7420 3d20 5b70        cdelt = [p
-00027880: 6978 7363 616c 652f 3336 3030 2e5d 2a32  ixscale/3600.]*2
-00027890: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000278a0: 2020 2063 6465 6c74 203d 205b 7069 7873     cdelt = [pixs
-000278b0: 6361 6c65 5b30 5d2f 3336 3030 2e2c 2070  cale[0]/3600., p
-000278c0: 6978 7363 616c 655b 315d 2f33 3630 302e  ixscale[1]/3600.
-000278d0: 5d0a 0a20 2020 2069 6620 6e70 2e69 7373  ]..    if np.iss
-000278e0: 6361 6c61 7228 7369 7a65 293a 0a20 2020  calar(size):.   
-000278f0: 2020 2020 206e 7069 7820 3d20 6e70 2e63       npix = np.c
-00027900: 6173 745b 696e 745d 286e 702e 726f 756e  ast[int](np.roun
-00027910: 6428 5b73 697a 652f 7069 7873 6361 6c65  d([size/pixscale
-00027920: 2c20 7369 7a65 2f70 6978 7363 616c 655d  , size/pixscale]
-00027930: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-00027940: 2020 2020 206e 7069 7820 3d20 6e70 2e63       npix = np.c
-00027950: 6173 745b 696e 745d 286e 702e 726f 756e  ast[int](np.roun
-00027960: 6428 5b73 697a 655b 305d 2f70 6978 7363  d([size[0]/pixsc
-00027970: 616c 652c 2073 697a 655b 315d 2f70 6978  ale, size[1]/pix
-00027980: 7363 616c 655d 2929 0a0a 2020 2020 686f  scale]))..    ho
-00027990: 7574 203d 2070 7966 6974 732e 4865 6164  ut = pyfits.Head
-000279a0: 6572 2829 0a20 2020 2068 6f75 745b 2743  er().    hout['C
-000279b0: 5250 4958 3127 5d20 3d20 286e 7069 785b  RPIX1'] = (npix[
-000279c0: 305d 2d31 292f 322b 310a 2020 2020 686f  0]-1)/2+1.    ho
-000279d0: 7574 5b27 4352 5049 5832 275d 203d 2028  ut['CRPIX2'] = (
-000279e0: 6e70 6978 5b31 5d2d 3129 2f32 2b31 0a20  npix[1]-1)/2+1. 
-000279f0: 2020 2068 6f75 745b 2743 5256 414c 3127     hout['CRVAL1'
-00027a00: 5d20 3d20 7261 0a20 2020 2068 6f75 745b  ] = ra.    hout[
-00027a10: 2743 5256 414c 3227 5d20 3d20 6465 630a  'CRVAL2'] = dec.
-00027a20: 2020 2020 686f 7574 5b27 4344 315f 3127      hout['CD1_1'
-00027a30: 5d20 3d20 2d63 6465 6c74 5b30 5d0a 2020  ] = -cdelt[0].  
-00027a40: 2020 686f 7574 5b27 4344 315f 3227 5d20    hout['CD1_2'] 
-00027a50: 3d20 686f 7574 5b27 4344 325f 3127 5d20  = hout['CD2_1'] 
-00027a60: 3d20 302e 0a20 2020 2068 6f75 745b 2743  = 0..    hout['C
-00027a70: 4432 5f32 275d 203d 2063 6465 6c74 5b31  D2_2'] = cdelt[1
-00027a80: 5d0a 2020 2020 686f 7574 5b27 4e41 5849  ].    hout['NAXI
-00027a90: 5331 275d 203d 206e 7069 785b 305d 0a20  S1'] = npix[0]. 
-00027aa0: 2020 2068 6f75 745b 274e 4158 4953 3227     hout['NAXIS2'
-00027ab0: 5d20 3d20 6e70 6978 5b31 5d0a 2020 2020  ] = npix[1].    
-00027ac0: 686f 7574 5b27 4354 5950 4531 275d 203d  hout['CTYPE1'] =
-00027ad0: 2027 5241 2d2d 2d54 414e 270a 2020 2020   'RA---TAN'.    
-00027ae0: 686f 7574 5b27 4354 5950 4532 275d 203d  hout['CTYPE2'] =
-00027af0: 2027 4445 432d 2d54 414e 270a 0a20 2020   'DEC--TAN'..   
-00027b00: 2068 6f75 745b 2752 4144 4553 5953 275d   hout['RADESYS']
-00027b10: 203d 2027 4943 5253 270a 2020 2020 686f   = 'ICRS'.    ho
-00027b20: 7574 5b27 4551 5549 4e4f 5827 5d20 3d20  ut['EQUINOX'] = 
-00027b30: 3230 3030 0a20 2020 2068 6f75 745b 274c  2000.    hout['L
-00027b40: 4154 504f 4c45 275d 203d 2068 6f75 745b  ATPOLE'] = hout[
-00027b50: 2743 5256 414c 3227 5d0a 2020 2020 686f  'CRVAL2'].    ho
-00027b60: 7574 5b27 4c4f 4e50 4f4c 4527 5d20 3d20  ut['LONPOLE'] = 
-00027b70: 3138 300a 0a20 2020 2068 6f75 745b 2750  180..    hout['P
-00027b80: 4958 4153 4543 275d 203d 2070 6978 7363  IXASEC'] = pixsc
-00027b90: 616c 652c 2027 5069 7865 6c20 7363 616c  ale, 'Pixel scal
-00027ba0: 6520 696e 2061 7263 7365 6327 0a0a 2020  e in arcsec'..  
-00027bb0: 2020 7763 735f 6f75 7420 3d20 7079 7763    wcs_out = pywc
-00027bc0: 732e 5743 5328 686f 7574 290a 0a20 2020  s.WCS(hout)..   
-00027bd0: 2074 6865 7461 5f72 6164 203d 206e 702e   theta_rad = np.
-00027be0: 6465 6732 7261 6428 7468 6574 6129 0a20  deg2rad(theta). 
-00027bf0: 2020 206d 6174 203d 206e 702e 6172 7261     mat = np.arra
-00027c00: 7928 5b5b 6e70 2e63 6f73 2874 6865 7461  y([[np.cos(theta
-00027c10: 5f72 6164 292c 202d 6e70 2e73 696e 2874  _rad), -np.sin(t
-00027c20: 6865 7461 5f72 6164 295d 2c0a 2020 2020  heta_rad)],.    
-00027c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c40: 5b6e 702e 7369 6e28 7468 6574 615f 7261  [np.sin(theta_ra
-00027c50: 6429 2c20 206e 702e 636f 7328 7468 6574  d),  np.cos(thet
-00027c60: 615f 7261 6429 5d5d 290a 0a20 2020 2072  a_rad)]])..    r
-00027c70: 6f74 5f63 6420 3d20 6e70 2e64 6f74 286d  ot_cd = np.dot(m
-00027c80: 6174 2c20 7763 735f 6f75 742e 7763 732e  at, wcs_out.wcs.
-00027c90: 6364 290a 0a20 2020 2066 6f72 2069 2069  cd)..    for i i
-00027ca0: 6e20 5b30 2c20 315d 3a0a 2020 2020 2020  n [0, 1]:.      
-00027cb0: 2020 666f 7220 6a20 696e 205b 302c 2031    for j in [0, 1
-00027cc0: 5d3a 0a20 2020 2020 2020 2020 2020 2068  ]:.            h
-00027cd0: 6f75 745b 2743 447b 303a 647d 5f7b 313a  out['CD{0:d}_{1:
-00027ce0: 647d 272e 666f 726d 6174 2869 2b31 2c20  d}'.format(i+1, 
-00027cf0: 6a2b 3129 5d20 3d20 726f 745f 6364 5b69  j+1)] = rot_cd[i
-00027d00: 2c20 6a5d 0a20 2020 2020 2020 2020 2020  , j].           
-00027d10: 2077 6373 5f6f 7574 2e77 6373 2e63 645b   wcs_out.wcs.cd[
-00027d20: 692c 206a 5d20 3d20 726f 745f 6364 5b69  i, j] = rot_cd[i
-00027d30: 2c20 6a5d 0a0a 2020 2020 6364 203d 2077  , j]..    cd = w
-00027d40: 6373 5f6f 7574 2e77 6373 2e63 640a 2020  cs_out.wcs.cd.  
-00027d50: 2020 7763 735f 6f75 742e 7073 6361 6c65    wcs_out.pscale
-00027d60: 203d 2067 6574 5f77 6373 5f70 7363 616c   = get_wcs_pscal
-00027d70: 6528 7763 735f 6f75 7429 2020 2320 6e70  e(wcs_out)  # np
-00027d80: 2e73 7172 7428 2863 645b 302c 3a5d 2a2a  .sqrt((cd[0,:]**
-00027d90: 3229 2e73 756d 2829 292a 3336 3030 2e0a  2).sum())*3600..
-00027da0: 0a20 2020 2069 6620 6765 745f 6864 753a  .    if get_hdu:
-00027db0: 0a20 2020 2020 2020 2068 6475 203d 2070  .        hdu = p
-00027dc0: 7966 6974 732e 496d 6167 6548 4455 2868  yfits.ImageHDU(h
-00027dd0: 6561 6465 723d 686f 7574 2c20 6461 7461  eader=hout, data
-00027de0: 3d6e 702e 7a65 726f 7328 286e 7069 785b  =np.zeros((npix[
-00027df0: 315d 2c20 6e70 6978 5b30 5d29 2c20 6474  1], npix[0]), dt
-00027e00: 7970 653d 6e70 2e66 6c6f 6174 3332 2929  ype=np.float32))
-00027e10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00027e20: 6864 750a 2020 2020 656c 7365 3a0a 2020  hdu.    else:.  
-00027e30: 2020 2020 2020 7265 7475 726e 2068 6f75        return hou
-00027e40: 742c 2077 6373 5f6f 7574 0a0a 0a64 6566  t, wcs_out...def
-00027e50: 2067 6574 5f66 6c74 5f66 6f6f 7470 7269   get_flt_footpri
-00027e60: 6e74 2866 6c74 5f66 696c 652c 2065 7874  nt(flt_file, ext
-00027e70: 656e 7369 6f6e 733d 5b31 2c20 322c 2033  ensions=[1, 2, 3
-00027e80: 2c20 345d 2c20 7061 7463 685f 6172 6773  , 4], patch_args
-00027e90: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
-00027ea0: 2020 2020 436f 6d70 7574 6520 666f 6f74      Compute foot
-00027eb0: 7072 696e 7420 6f66 2061 6c6c 2053 4349  print of all SCI
-00027ec0: 2065 7874 656e 7369 6f6e 7320 6f66 2061   extensions of a
-00027ed0: 6e20 4853 5420 6578 706f 7375 7265 0a0a  n HST exposure..
-00027ee0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00027ef0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00027f00: 2020 6578 7465 6e73 696f 6e73 203a 206c    extensions : l
-00027f10: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
-00027f20: 206f 6620 6578 7465 6e73 696f 6e73 2074   of extensions t
-00027f30: 6f20 7265 7472 6965 7665 2028 6361 6e20  o retrieve (can 
-00027f40: 6861 7665 2065 7874 7261 7329 2e0a 0a20  have extras)... 
-00027f50: 2020 2070 6174 6368 5f61 7267 7320 3a20     patch_args : 
-00027f60: 6469 6374 206f 7220 4e6f 6e65 0a20 2020  dict or None.   
-00027f70: 2020 2020 2049 6620 6120 6064 6963 7460       If a `dict`
-00027f80: 2c20 7468 656e 2067 656e 6572 6174 6520  , then generate 
-00027f90: 6120 7061 7463 6820 666f 7220 7468 6520  a patch for the 
-00027fa0: 666f 6f74 7072 696e 7420 7061 7373 696e  footprint passin
-00027fb0: 670a 2020 2020 2020 2020 602a 2a70 6174  g.        `**pat
-00027fc0: 6368 5f61 7267 7360 2061 7267 756d 656e  ch_args` argumen
-00027fd0: 7473 2028 652e 672e 2c20 607b 2766 6327  ts (e.g., `{'fc'
-00027fe0: 3a27 626c 7565 272c 2027 616c 7068 6127  :'blue', 'alpha'
-00027ff0: 3a30 2e31 7d60 292e 0a0a 2020 2020 5265  :0.1}`)...    Re
-00028000: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00028010: 2d0a 2020 2020 6670 202f 2070 6174 6368  -.    fp / patch
-00028020: 203a 2060 7e73 6861 7065 6c79 2e67 656f   : `~shapely.geo
-00028030: 6d65 7472 7960 206f 626a 6563 7420 6f72  metry` object or
-00028040: 2060 6d61 7470 6c6f 746c 6962 2e70 6174   `matplotlib.pat
-00028050: 6368 2e50 6174 6368 600a 2020 2020 2020  ch.Patch`.      
-00028060: 2020 5468 6520 666f 6f74 7072 696e 7420    The footprint 
-00028070: 6f72 2066 6f6f 7470 7269 6e74 2070 6174  or footprint pat
-00028080: 6368 2e0a 0a20 2020 2022 2222 0a20 2020  ch...    """.   
-00028090: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
-000280a0: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
-000280b0: 6c79 676f 6e0a 0a20 2020 2069 6d20 3d20  lygon..    im = 
-000280c0: 7079 6669 7473 2e6f 7065 6e28 666c 745f  pyfits.open(flt_
-000280d0: 6669 6c65 290a 2020 2020 6670 203d 204e  file).    fp = N
-000280e0: 6f6e 650a 0a20 2020 2066 6f72 2065 7874  one..    for ext
-000280f0: 2069 6e20 6578 7465 6e73 696f 6e73 3a0a   in extensions:.
-00028100: 2020 2020 2020 2020 6966 2028 2753 4349          if ('SCI
-00028110: 272c 2065 7874 2920 6e6f 7420 696e 2069  ', ext) not in i
-00028120: 6d3a 0a20 2020 2020 2020 2020 2020 2063  m:.            c
-00028130: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00028140: 2077 6373 203d 2070 7977 6373 2e57 4353   wcs = pywcs.WCS
-00028150: 2869 6d5b 2753 4349 272c 2065 7874 5d2e  (im['SCI', ext].
-00028160: 6865 6164 6572 2c20 666f 626a 3d69 6d29  header, fobj=im)
-00028170: 0a20 2020 2020 2020 2070 5f69 203d 2050  .        p_i = P
-00028180: 6f6c 7967 6f6e 2877 6373 2e63 616c 635f  olygon(wcs.calc_
-00028190: 666f 6f74 7072 696e 7428 2929 0a20 2020  footprint()).   
-000281a0: 2020 2020 2069 6620 6670 2069 7320 4e6f       if fp is No
-000281b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000281c0: 6670 203d 2070 5f69 0a20 2020 2020 2020  fp = p_i.       
-000281d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000281e0: 2020 2066 7020 3d20 6670 2e75 6e69 6f6e     fp = fp.union
-000281f0: 2870 5f69 290a 2020 2020 0a20 2020 2069  (p_i).    .    i
-00028200: 6d2e 636c 6f73 6528 290a 2020 2020 0a20  m.close().    . 
-00028210: 2020 2069 6620 7061 7463 685f 6172 6773     if patch_args
-00028220: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00028230: 2020 2020 2020 7061 7463 6820 3d20 7061        patch = pa
-00028240: 7463 685f 6672 6f6d 5f70 6f6c 7967 6f6e  tch_from_polygon
-00028250: 2866 702c 202a 2a70 6174 6368 5f61 7267  (fp, **patch_arg
-00028260: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00028270: 6e20 7061 7463 680a 2020 2020 656c 7365  n patch.    else
-00028280: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00028290: 2066 700a 0a0a 6465 6620 6d61 6b65 5f6d   fp...def make_m
-000282a0: 6178 696d 616c 5f77 6373 2866 696c 6573  aximal_wcs(files
-000282b0: 2c20 7069 7865 6c5f 7363 616c 653d 4e6f  , pixel_scale=No
-000282c0: 6e65 2c20 6765 745f 6864 753d 5472 7565  ne, get_hdu=True
-000282d0: 2c20 7061 643d 3930 2c20 7665 7262 6f73  , pad=90, verbos
-000282e0: 653d 5472 7565 2c20 7468 6574 613d 302c  e=True, theta=0,
-000282f0: 2070 6f6c 795f 6275 6666 6572 3d31 2e2f   poly_buffer=1./
-00028300: 3336 3030 2c20 6e73 6369 5f65 7874 656e  3600, nsci_exten
-00028310: 7369 6f6e 733d 3429 3a0a 2020 2020 2222  sions=4):.    ""
-00028320: 220a 2020 2020 436f 6d70 7574 6520 616e  ".    Compute an
-00028330: 2049 6d61 6765 4844 5520 7769 7468 2061   ImageHDU with a
-00028340: 2066 6f6f 7470 7269 6e74 2074 6861 7420   footprint that 
-00028350: 636f 6e74 6169 6e73 2061 6c6c 206f 6620  contains all of 
-00028360: 6066 696c 6573 600a 0a20 2020 2050 6172  `files`..    Par
-00028370: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00028380: 2d2d 2d2d 2d2d 0a20 2020 2066 696c 6573  ------.    files
-00028390: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-000283a0: 4c69 7374 206f 6620 4853 5420 4649 5453  List of HST FITS
-000283b0: 2066 696c 6573 2028 652e 672e 2c20 464c   files (e.g., FL
-000283c0: 542e 2920 6f72 2057 4353 206f 626a 6563  T.) or WCS objec
-000283d0: 7473 2e0a 0a20 2020 2070 6978 656c 5f73  ts...    pixel_s
-000283e0: 6361 6c65 203a 2066 6c6f 6174 0a20 2020  cale : float.   
-000283f0: 2020 2020 2050 6978 656c 2073 6361 6c65       Pixel scale
-00028400: 206f 6620 6f75 7470 7574 2057 4353 2c20   of output WCS, 
-00028410: 696e 2060 7e61 7374 726f 7079 2e75 6e69  in `~astropy.uni
-00028420: 7473 2e61 7263 7365 6360 2e20 2049 6620  ts.arcsec`.  If 
-00028430: 604e 6f6e 6560 2c0a 2020 2020 2020 2020  `None`,.        
-00028440: 6765 7420 7069 7865 6c20 7363 616c 6520  get pixel scale 
-00028450: 6f66 2066 6972 7374 2066 696c 6520 696e  of first file in
-00028460: 2060 6669 6c65 7360 2e0a 0a20 2020 2067   `files`...    g
-00028470: 6574 5f68 6475 203a 2062 6f6f 6c0a 2020  et_hdu : bool.  
-00028480: 2020 2020 2020 5365 6520 6265 6c6f 772e        See below.
-00028490: 0a0a 2020 2020 7061 6420 3a20 666c 6f61  ..    pad : floa
-000284a0: 740a 2020 2020 2020 2020 5061 6464 696e  t.        Paddin
-000284b0: 6720 746f 2061 6464 2074 6f20 7468 6520  g to add to the 
-000284c0: 746f 7461 6c20 696d 6167 6520 7369 7a65  total image size
-000284d0: 2c20 696e 2060 7e61 7374 726f 7079 2e75  , in `~astropy.u
-000284e0: 6e69 7473 2e61 7263 7365 6360 2e0a 0a20  nits.arcsec`... 
-000284f0: 2020 2074 6865 7461 203a 2066 6c6f 6174     theta : float
-00028500: 0a20 2020 2020 2020 2050 6f73 6974 696f  .        Positio
-00028510: 6e20 616e 676c 652c 2064 6567 7265 6573  n angle, degrees
-00028520: 0a0a 2020 2020 6e73 6369 5f65 7874 656e  ..    nsci_exten
-00028530: 7369 6f6e 7320 3a20 696e 740a 2020 2020  sions : int.    
-00028540: 2020 2020 4e75 6d62 6572 206f 6620 2753      Number of 'S
-00028550: 4349 2720 6578 7465 6e73 696f 6e73 2074  CI' extensions t
-00028560: 6f20 7472 7920 696e 2074 6865 2065 7870  o try in the exp
-00028570: 6f73 7572 6520 6669 6c65 732e 0a0a 2020  osure files...  
-00028580: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-00028590: 2d2d 2d2d 2d0a 2020 2020 6864 7520 3a20  -----.    hdu : 
-000285a0: 607e 6173 7472 6f70 792e 696f 2e66 6974  `~astropy.io.fit
-000285b0: 732e 496d 6167 6548 4455 600a 2020 2020  s.ImageHDU`.    
-000285c0: 2020 2020 4966 2060 6765 745f 6864 7560      If `get_hdu`
-000285d0: 2069 7320 5472 7565 2e0a 0a20 2020 202d   is True...    -
-000285e0: 6f72 2d0a 0a20 2020 2068 6561 6465 722c  or-..    header,
-000285f0: 2077 6373 203a 2060 7e61 7374 726f 7079   wcs : `~astropy
-00028600: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00028610: 2c20 607e 6173 7472 6f70 792e 7763 732e  , `~astropy.wcs.
-00028620: 5743 5360 0a20 2020 2020 2020 2049 6620  WCS`.        If 
-00028630: 6067 6574 5f68 6475 6020 6973 2046 616c  `get_hdu` is Fal
-00028640: 7365 2e0a 0a20 2020 2022 2222 0a20 2020  se...    """.   
-00028650: 2069 6d70 6f72 7420 6e75 6d70 7920 6173   import numpy as
-00028660: 206e 700a 2020 2020 6672 6f6d 2073 6861   np.    from sha
-00028670: 7065 6c79 2e67 656f 6d65 7472 7920 696d  pely.geometry im
-00028680: 706f 7274 2050 6f6c 7967 6f6e 0a0a 2020  port Polygon..  
-00028690: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
-000286a0: 2e69 6f2e 6669 7473 2061 7320 7079 6669  .io.fits as pyfi
-000286b0: 7473 0a20 2020 2069 6d70 6f72 7420 6173  ts.    import as
-000286c0: 7472 6f70 792e 7763 7320 6173 2070 7977  tropy.wcs as pyw
-000286d0: 6373 0a0a 2020 2020 6966 2069 7369 6e73  cs..    if isins
-000286e0: 7461 6e63 6528 6669 6c65 735b 305d 2c20  tance(files[0], 
-000286f0: 7079 7763 732e 5743 5329 3a0a 2020 2020  pywcs.WCS):.    
-00028700: 2020 2020 2320 416c 7265 6164 7920 7763      # Already wc
-00028710: 735f 6c69 7374 0a20 2020 2020 2020 2077  s_list.        w
-00028720: 6373 5f6c 6973 7420 3d20 5b28 7763 732c  cs_list = [(wcs,
-00028730: 2027 5743 5327 2c20 2d31 2920 666f 7220   'WCS', -1) for 
-00028740: 7763 7320 696e 2066 696c 6573 5d0a 2020  wcs in files].  
-00028750: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00028760: 7763 735f 6c69 7374 203d 205b 5d0a 2020  wcs_list = [].  
-00028770: 2020 2020 2020 666f 7220 692c 2066 696c        for i, fil
-00028780: 6520 696e 2065 6e75 6d65 7261 7465 2866  e in enumerate(f
-00028790: 696c 6573 293a 0a20 2020 2020 2020 2020  iles):.         
-000287a0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
-000287b0: 682e 6578 6973 7473 2866 696c 6529 3a0a  h.exists(file):.
-000287c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000287d0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-000287e0: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
-000287f0: 732e 6f70 656e 2866 696c 6529 2061 7320  s.open(file) as 
-00028800: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-00028810: 2020 2020 666f 7220 6578 7420 696e 2072      for ext in r
-00028820: 616e 6765 286e 7363 695f 6578 7465 6e73  ange(nsci_extens
-00028830: 696f 6e73 293a 0a20 2020 2020 2020 2020  ions):.         
-00028840: 2020 2020 2020 2020 2020 2069 6620 2827             if ('
-00028850: 5343 4927 2c20 6578 742b 3129 206e 6f74  SCI', ext+1) not
-00028860: 2069 6e20 696d 3a0a 2020 2020 2020 2020   in im:.        
-00028870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028880: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-00028890: 2020 2020 2020 2020 2020 2020 2020 7763                wc
-000288a0: 7320 3d20 7079 7763 732e 5743 5328 696d  s = pywcs.WCS(im
-000288b0: 5b27 5343 4927 2c20 6578 742b 315d 2e68  ['SCI', ext+1].h
-000288c0: 6561 6465 722c 2066 6f62 6a3d 696d 290a  eader, fobj=im).
-000288d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288e0: 2020 2020 7763 735f 6c69 7374 2e61 7070      wcs_list.app
-000288f0: 656e 6428 2877 6373 2c20 6669 6c65 2c20  end((wcs, file, 
-00028900: 6578 7429 290a 2020 2020 0a20 2020 2069  ext)).    .    i
-00028910: 6620 7069 7865 6c5f 7363 616c 6520 6973  f pixel_scale is
-00028920: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
-00028930: 6978 656c 5f73 6361 6c65 203d 2067 6574  ixel_scale = get
-00028940: 5f77 6373 5f70 7363 616c 6528 7763 735f  _wcs_pscale(wcs_
-00028950: 6c69 7374 5b30 5d5b 305d 290a 2020 2020  list[0][0]).    
-00028960: 2020 2020 0a20 2020 2067 726f 7570 5f70      .    group_p
-00028970: 6f6c 7920 3d20 4e6f 6e65 0a20 2020 2066  oly = None.    f
-00028980: 6f72 2069 2c20 2877 6373 2c20 6669 6c65  or i, (wcs, file
-00028990: 2c20 6368 6970 2920 696e 2065 6e75 6d65  , chip) in enume
-000289a0: 7261 7465 2877 6373 5f6c 6973 7429 3a0a  rate(wcs_list):.
-000289b0: 2020 2020 2020 2020 705f 6920 3d20 506f          p_i = Po
-000289c0: 6c79 676f 6e28 7763 732e 6361 6c63 5f66  lygon(wcs.calc_f
-000289d0: 6f6f 7470 7269 6e74 2829 290a 2020 2020  ootprint()).    
-000289e0: 2020 2020 6966 2067 726f 7570 5f70 6f6c      if group_pol
-000289f0: 7920 6973 204e 6f6e 653a 0a20 2020 2020  y is None:.     
-00028a00: 2020 2020 2020 2069 6620 706f 6c79 5f62         if poly_b
-00028a10: 7566 6665 7220 3e20 303a 0a20 2020 2020  uffer > 0:.     
-00028a20: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00028a30: 5f70 6f6c 7920 3d20 705f 692e 6275 6666  _poly = p_i.buff
-00028a40: 6572 2831 2e2f 3336 3030 290a 2020 2020  er(1./3600).    
-00028a50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00028a60: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00028a70: 6f75 705f 706f 6c79 203d 2070 5f69 0a20  oup_poly = p_i. 
-00028a80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00028a90: 2020 2020 2020 2020 2069 6620 706f 6c79           if poly
-00028aa0: 5f62 7566 6665 7220 3e20 303a 0a20 2020  _buffer > 0:.   
-00028ab0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00028ac0: 7570 5f70 6f6c 7920 3d20 6772 6f75 705f  up_poly = group_
-00028ad0: 706f 6c79 2e75 6e69 6f6e 2870 5f69 2e62  poly.union(p_i.b
-00028ae0: 7566 6665 7228 312e 2f33 3630 3029 290a  uffer(1./3600)).
-00028af0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00028b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028b10: 2020 6772 6f75 705f 706f 6c79 203d 2067    group_poly = g
-00028b20: 726f 7570 5f70 6f6c 792e 756e 696f 6e28  roup_poly.union(
-00028b30: 705f 6929 0a20 2020 2020 2020 2020 2020  p_i).           
-00028b40: 2020 2020 2020 0a20 2020 2020 2020 2078        .        x
-00028b50: 302c 2079 3020 3d20 6e70 2e63 6173 745b  0, y0 = np.cast[
-00028b60: 666c 6f61 745d 2867 726f 7570 5f70 6f6c  float](group_pol
-00028b70: 792e 6365 6e74 726f 6964 2e78 7929 5b3a  y.centroid.xy)[:
-00028b80: 2c20 305d 0a20 2020 2020 2020 2069 6620  , 0].        if 
-00028b90: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00028ba0: 2020 2020 206d 7367 203d 2027 7b30 3a3e       msg = '{0:>
-00028bb0: 3364 7d2f 7b31 3a3e 3364 7d3a 207b 327d  3d}/{1:>3d}: {2}
-00028bc0: 5b53 4349 2c7b 337d 5d20 207b 343a 3e36  [SCI,{3}]  {4:>6
-00028bd0: 2e32 667d 270a 2020 2020 2020 2020 2020  .2f}'.          
-00028be0: 2020 7072 696e 7428 6d73 672e 666f 726d    print(msg.form
-00028bf0: 6174 2869 2c20 6c65 6e28 6669 6c65 7329  at(i, len(files)
-00028c00: 2c20 6669 6c65 2c20 6368 6970 2b31 2c0a  , file, chip+1,.
-00028c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c20: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00028c30: 7570 5f70 6f6c 792e 6172 6561 2a33 3630  up_poly.area*360
-00028c40: 302a 6e70 2e63 6f73 2879 302f 3138 302a  0*np.cos(y0/180*
-00028c50: 6e70 2e70 6929 0a20 2020 2020 2020 2020  np.pi).         
-00028c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c70: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00028c80: 2020 2020 2020 2020 290a 0a20 2020 2070          )..    p
-00028c90: 7820 3d20 6e70 2e63 6173 745b 666c 6f61  x = np.cast[floa
-00028ca0: 745d 2867 726f 7570 5f70 6f6c 792e 636f  t](group_poly.co
-00028cb0: 6e76 6578 5f68 756c 6c2e 626f 756e 6461  nvex_hull.bounda
-00028cc0: 7279 2e78 7929 2e54 0a20 2020 2023 7830  ry.xy).T.    #x0
-00028cd0: 2c20 7930 203d 206e 702e 6361 7374 5b66  , y0 = np.cast[f
-00028ce0: 6c6f 6174 5d28 6772 6f75 705f 706f 6c79  loat](group_poly
-00028cf0: 2e63 656e 7472 6f69 642e 7879 295b 3a2c  .centroid.xy)[:,
-00028d00: 305d 0a0a 2020 2020 7830 203d 2028 7078  0]..    x0 = (px
-00028d10: 2e6d 6178 2861 7869 733d 3029 2b70 782e  .max(axis=0)+px.
-00028d20: 6d69 6e28 6178 6973 3d30 2929 2f32 2e0a  min(axis=0))/2..
-00028d30: 0a20 2020 2063 6f73 6420 3d20 6e70 2e61  .    cosd = np.a
-00028d40: 7272 6179 285b 6e70 2e63 6f73 2878 305b  rray([np.cos(x0[
-00028d50: 315d 2f31 3830 2a6e 702e 7069 292c 2031  1]/180*np.pi), 1
-00028d60: 5d29 0a0a 2020 2020 5f6d 6174 203d 206e  ])..    _mat = n
-00028d70: 702e 6172 7261 7928 5b5b 6e70 2e63 6f73  p.array([[np.cos
-00028d80: 2874 6865 7461 292c 202d 6e70 2e73 696e  (theta), -np.sin
-00028d90: 2874 6865 7461 295d 2c0a 2020 2020 2020  (theta)],.      
-00028da0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00028db0: 6e70 2e73 696e 2874 6865 7461 292c 206e  np.sin(theta), n
-00028dc0: 702e 636f 7328 7468 6574 6129 5d5d 290a  p.cos(theta)]]).
-00028dd0: 0a20 2020 2023 2052 6f74 6174 6564 0a20  .    # Rotated. 
-00028de0: 2020 2070 7220 3d20 2828 7078 2d78 3029     pr = ((px-x0)
-00028df0: 2a63 6f73 6429 2e64 6f74 285f 6d61 7429  *cosd).dot(_mat)
-00028e00: 2f63 6f73 642b 7830 0a0a 2020 2020 7369  /cosd+x0..    si
-00028e10: 7a65 5f61 7263 7365 6320 3d20 2870 722e  ze_arcsec = (pr.
-00028e20: 6d61 7828 6178 6973 3d30 292d 7072 2e6d  max(axis=0)-pr.m
-00028e30: 696e 2861 7869 733d 3029 292a 636f 7364  in(axis=0))*cosd
-00028e40: 2a33 3630 300a 2020 2020 7378 2c20 7379  *3600.    sx, sy
-00028e50: 203d 2073 697a 655f 6172 6373 6563 0a0a   = size_arcsec..
-00028e60: 2020 2020 2320 7378 203d 2028 7078 2e6d      # sx = (px.m
-00028e70: 6178 2829 2d70 782e 6d69 6e28 2929 2a63  ax()-px.min())*c
-00028e80: 6f73 642a 3336 3030 2023 2061 7263 7365  osd*3600 # arcse
-00028e90: 630a 2020 2020 2320 7379 203d 2028 7079  c.    # sy = (py
-00028ea0: 2e6d 6178 2829 2d70 792e 6d69 6e28 2929  .max()-py.min())
-00028eb0: 2a33 3630 3020 2320 6172 6373 6563 0a0a  *3600 # arcsec..
-00028ec0: 2020 2020 7369 7a65 203d 206e 702e 6d61      size = np.ma
-00028ed0: 7869 6d75 6d28 7378 2b70 6164 2c20 7379  ximum(sx+pad, sy
-00028ee0: 2b70 6164 290a 0a20 2020 2069 6620 7665  +pad)..    if ve
-00028ef0: 7262 6f73 653a 0a20 2020 2020 2020 206d  rbose:.        m
-00028f00: 7367 203d 2027 5c6e 2020 4d6f 7361 6963  sg = '\n  Mosaic
-00028f10: 2057 4353 3a20 287b 303a 2e35 667d 2c7b   WCS: ({0:.5f},{
-00028f20: 313a 2e35 667d 2920 270a 2020 2020 2020  1:.5f}) '.      
-00028f30: 2020 6d73 6720 2b3d 2027 7b32 3a2e 3166    msg += '{2:.1f
-00028f40: 7d5c 2778 7b33 3a2e 3166 7d5c 2720 207b  }\'x{3:.1f}\'  {
-00028f50: 343a 2e33 667d 222f 7069 785c 6e27 0a20  4:.3f}"/pix\n'. 
-00028f60: 2020 2020 2020 2070 7269 6e74 286d 7367         print(msg
-00028f70: 2e66 6f72 6d61 7428 7830 5b30 5d2c 2078  .format(x0[0], x
-00028f80: 305b 315d 2c20 2873 782b 7061 6429 2f36  0[1], (sx+pad)/6
-00028f90: 302e 2c20 2873 792b 7061 6429 2f36 302e  0., (sy+pad)/60.
-00028fa0: 2c20 7069 7865 6c5f 7363 616c 6529 290a  , pixel_scale)).
-00028fb0: 0a20 2020 206f 7574 203d 206d 616b 655f  .    out = make_
-00028fc0: 7763 7368 6561 6465 7228 7261 3d78 305b  wcsheader(ra=x0[
-00028fd0: 305d 2c20 6465 633d 7830 5b31 5d2c 0a20  0], dec=x0[1],. 
-00028fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ff0: 2020 2020 2020 2020 7369 7a65 3d28 7378          size=(sx
-00029000: 2b70 6164 2a32 2c20 7379 2b70 6164 2a32  +pad*2, sy+pad*2
-00029010: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00029020: 2020 2020 2020 2020 2020 2020 7069 7873              pixs
-00029030: 6361 6c65 3d70 6978 656c 5f73 6361 6c65  cale=pixel_scale
-00029040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029050: 2020 2020 2020 2020 2020 2067 6574 5f68             get_h
-00029060: 6475 3d67 6574 5f68 6475 2c20 7468 6574  du=get_hdu, thet
-00029070: 613d 7468 6574 612f 6e70 2e70 692a 3138  a=theta/np.pi*18
-00029080: 3029 0a0a 2020 2020 7265 7475 726e 206f  0)..    return o
-00029090: 7574 0a0a 0a64 6566 2068 616c 665f 7069  ut...def half_pi
-000290a0: 7865 6c5f 7363 616c 6528 7763 7329 3a0a  xel_scale(wcs):.
-000290b0: 2020 2020 2222 220a 2020 2020 4372 6561      """.    Crea
-000290c0: 7465 2061 206e 6577 2057 4353 2077 6974  te a new WCS wit
-000290d0: 6820 6861 6c66 2074 6865 2070 6978 656c  h half the pixel
-000290e0: 2073 6361 6c65 206f 6620 616e 6f74 6865   scale of anothe
-000290f0: 7220 7468 6174 2063 616e 2062 6520 0a20  r that can be . 
-00029100: 2020 2062 6c6f 636b 2d61 7665 7261 6765     block-average
-00029110: 6420 3278 320a 2020 2020 0a20 2020 2050  d 2x2.    .    P
-00029120: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00029130: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6373  --------.    wcs
-00029140: 203a 2060 7e61 7374 726f 7079 2e77 6373   : `~astropy.wcs
-00029150: 2e57 4353 600a 2020 2020 2020 2020 496e  .WCS`.        In
-00029160: 7075 7420 5743 530a 2020 2020 0a20 2020  put WCS.    .   
-00029170: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00029180: 2d2d 2d2d 0a20 2020 2068 616c 665f 7763  ----.    half_wc
-00029190: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
-000291a0: 732e 5743 5360 0a20 2020 2020 2020 204e  s.WCS`.        N
-000291b0: 6577 2057 4353 2077 6974 6820 736d 616c  ew WCS with smal
-000291c0: 6c65 7220 7069 7865 6c73 0a20 2020 2022  ler pixels.    "
-000291d0: 2222 0a20 2020 2068 203d 2074 6f5f 6865  "".    h = to_he
-000291e0: 6164 6572 2877 6373 290a 2020 2020 0a20  ader(wcs).    . 
-000291f0: 2020 2066 6f72 206b 2069 6e20 5b27 4e41     for k in ['NA
-00029200: 5849 5331 272c 2027 4e41 5849 5332 275d  XIS1', 'NAXIS2']
-00029210: 3a20 232c 2027 4352 5049 5831 272c 2027  : #, 'CRPIX1', '
-00029220: 4352 5049 5832 275d 3a0a 2020 2020 2020  CRPIX2']:.      
-00029230: 2020 685b 6b5d 202a 3d20 320a 0a20 2020    h[k] *= 2..   
-00029240: 2066 6f72 206b 2069 6e20 5b27 4352 5049   for k in ['CRPI
-00029250: 5831 272c 2027 4352 5049 5832 275d 3a0a  X1', 'CRPIX2']:.
-00029260: 2020 2020 2020 2020 685b 6b5d 203d 2068          h[k] = h
-00029270: 5b6b 5d2a 3220 2d20 302e 350a 2020 2020  [k]*2 - 0.5.    
-00029280: 2020 2020 0a20 2020 2066 6f72 206b 2069      .    for k i
-00029290: 6e20 5b27 4344 315f 3127 2c20 2743 4431  n ['CD1_1', 'CD1
-000292a0: 5f32 272c 2027 4344 325f 3127 2c20 2743  _2', 'CD2_1', 'C
-000292b0: 4432 5f32 275d 3a0a 2020 2020 2020 2020  D2_2']:.        
-000292c0: 6966 206b 2069 6e20 683a 0a20 2020 2020  if k in h:.     
-000292d0: 2020 2020 2020 2068 5b6b 5d20 2f3d 2032         h[k] /= 2
-000292e0: 0a20 2020 200a 2020 2020 6966 2030 3a0a  .    .    if 0:.
-000292f0: 2020 2020 2020 2020 2320 5465 7374 0a20          # Test. 
-00029300: 2020 2020 2020 206e 6577 203d 2070 7977         new = pyw
-00029310: 6373 2e57 4353 2868 290a 2020 2020 2020  cs.WCS(h).      
-00029320: 2020 7368 203d 206e 6577 2e70 6978 656c    sh = new.pixel
-00029330: 5f73 6861 7065 0a20 2020 2020 2020 200a  _shape.        .
-00029340: 2020 2020 2020 2020 7763 6f72 6e65 7220          wcorner 
-00029350: 3d20 7763 732e 616c 6c5f 776f 726c 6432  = wcs.all_world2
-00029360: 7069 7828 6e65 772e 616c 6c5f 7069 7832  pix(new.all_pix2
-00029370: 776f 726c 6428 5b5b 2d30 2e35 2c20 2d30  world([[-0.5, -0
-00029380: 2e35 5d2c 200a 2020 2020 2020 2020 2020  .5], .          
-00029390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293b0: 2020 205b 7368 5b30 5d2d 302e 352c 2073     [sh[0]-0.5, s
-000293c0: 685b 315d 2d30 2e35 5d5d 2c20 3029 2c30  h[1]-0.5]], 0),0
-000293d0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-000293e0: 2773 6d61 6c6c 203e 206c 6172 6765 2729  'small > large')
-000293f0: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-00029400: 2c20 272e 6a6f 696e 285b 6627 7b77 3a2e  , '.join([f'{w:.
-00029410: 3266 7d27 2066 6f72 2077 2069 6e20 7763  2f}' for w in wc
-00029420: 6f72 6e65 725b 305d 5d29 290a 2020 2020  orner[0]])).    
-00029430: 2020 2020 7072 696e 7428 272c 2027 2e6a      print(', '.j
-00029440: 6f69 6e28 5b66 277b 773a 2e32 667d 2720  oin([f'{w:.2f}' 
-00029450: 666f 7220 7720 696e 2077 636f 726e 6572  for w in wcorner
-00029460: 5b31 5d5d 292c 2077 6373 2e70 6978 656c  [1]]), wcs.pixel
-00029470: 5f73 6861 7065 290a 2020 2020 2020 2020  _shape).        
-00029480: 0a20 2020 2020 2020 2073 6820 3d20 7763  .        sh = wc
-00029490: 732e 7069 7865 6c5f 7368 6170 650a 2020  s.pixel_shape.  
-000294a0: 2020 2020 2020 7763 6f72 6e65 7220 3d20        wcorner = 
-000294b0: 6e65 772e 616c 6c5f 776f 726c 6432 7069  new.all_world2pi
-000294c0: 7828 7763 732e 616c 6c5f 7069 7832 776f  x(wcs.all_pix2wo
-000294d0: 726c 6428 5b5b 2d30 2e35 2c20 2d30 2e35  rld([[-0.5, -0.5
-000294e0: 5d2c 200a 2020 2020 2020 2020 2020 2020  ], .            
-000294f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029510: 205b 7368 5b30 5d2d 302e 352c 2073 685b   [sh[0]-0.5, sh[
-00029520: 315d 2d30 2e35 5d5d 2c20 3029 2c30 290a  1]-0.5]], 0),0).
-00029530: 2020 2020 2020 2020 7072 696e 7428 276c          print('l
-00029540: 6172 6765 203e 2073 6d61 6c6c 2729 0a20  arge > small'). 
-00029550: 2020 2020 2020 2070 7269 6e74 2827 2c20         print(', 
-00029560: 272e 6a6f 696e 285b 6627 7b77 3a2e 3266  '.join([f'{w:.2f
-00029570: 7d27 2066 6f72 2077 2069 6e20 7763 6f72  }' for w in wcor
-00029580: 6e65 725b 305d 5d29 290a 2020 2020 2020  ner[0]])).      
-00029590: 2020 7072 696e 7428 272c 2027 2e6a 6f69    print(', '.joi
-000295a0: 6e28 5b66 277b 773a 2e32 667d 2720 666f  n([f'{w:.2f}' fo
-000295b0: 7220 7720 696e 2077 636f 726e 6572 5b31  r w in wcorner[1
-000295c0: 5d5d 292c 206e 6577 2e70 6978 656c 5f73  ]]), new.pixel_s
-000295d0: 6861 7065 290a 2020 2020 2020 2020 0a20  hape).        . 
-000295e0: 2020 206e 6577 5f77 6373 203d 2070 7977     new_wcs = pyw
-000295f0: 6373 2e57 4353 2868 2c20 7265 6c61 783d  cs.WCS(h, relax=
-00029600: 5472 7565 290a 2020 2020 0a20 2020 2072  True).    .    r
-00029610: 6574 7572 6e20 6e65 775f 7763 730a 0a0a  eturn new_wcs...
-00029620: 6465 6620 6865 6164 6572 5f6b 6579 735f  def header_keys_
-00029630: 6672 6f6d 5f66 696c 656c 6973 7428 6669  from_filelist(fi
-00029640: 7473 5f66 696c 6573 2c20 6b65 7977 6f72  ts_files, keywor
-00029650: 6473 3d5b 5d2c 2065 7874 3d30 2c20 636f  ds=[], ext=0, co
-00029660: 6c6e 616d 655f 6361 7365 3d73 7472 2e6c  lname_case=str.l
-00029670: 6f77 6572 293a 0a20 2020 2022 2222 4475  ower):.    """Du
-00029680: 6d70 2068 6561 6465 7220 6b65 7977 6f72  mp header keywor
-00029690: 6473 2074 6f20 6120 607e 6173 7472 6f70  ds to a `~astrop
-000296a0: 792e 7461 626c 652e 5461 626c 6560 0a0a  y.table.Table`..
-000296b0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000296c0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000296d0: 2020 6669 7473 5f66 696c 6573 203a 206c    fits_files : l
-000296e0: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
-000296f0: 206f 6620 4649 5453 2066 696c 656e 616d   of FITS filenam
-00029700: 6573 0a0a 2020 2020 6b65 7977 6f72 6473  es..    keywords
-00029710: 203a 206c 6973 7420 6f72 204e 6f6e 650a   : list or None.
-00029720: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
-00029730: 6865 6164 6572 206b 6579 776f 7264 7320  header keywords 
-00029740: 746f 2072 6574 7269 6576 652e 2020 4966  to retrieve.  If
-00029750: 2060 4e6f 6e65 602c 2074 6865 6e20 6765   `None`, then ge
-00029760: 6e65 7261 7465 2061 206c 6973 740a 2020  nerate a list.  
-00029770: 2020 2020 2020 6f66 202a 616c 6c2a 206b        of *all* k
-00029780: 6579 776f 7264 7320 6672 6f6d 2074 6865  eywords from the
-00029790: 2066 6972 7374 2066 696c 6520 696e 2074   first file in t
-000297a0: 6865 206c 6973 742e 0a0a 2020 2020 6578  he list...    ex
-000297b0: 7420 3a20 696e 742c 2074 7570 6c65 0a20  t : int, tuple. 
-000297c0: 2020 2020 2020 2046 4954 5320 6578 7465         FITS exte
-000297d0: 6e73 696f 6e20 6672 6f6d 2077 6869 6368  nsion from which
-000297e0: 2074 6f20 7075 6c6c 2074 6865 2068 6561   to pull the hea
-000297f0: 6465 722e 2020 4361 6e20 6265 2069 6e74  der.  Can be int
-00029800: 6567 6572 206f 720a 2020 2020 2020 2020  eger or.        
-00029810: 7475 706c 652c 2065 2e67 2e2c 2028 2753  tuple, e.g., ('S
-00029820: 4349 272c 3129 2066 6f72 2048 5354 2041  CI',1) for HST A
-00029830: 4353 2f57 4643 3320 464c 5420 6669 6c65  CS/WFC3 FLT file
-00029840: 732e 0a0a 2020 2020 636f 6c6e 616d 655f  s...    colname_
-00029850: 6361 7365 203a 2066 756e 630a 2020 2020  case : func.    
-00029860: 2020 2020 4675 6e63 7469 6f6e 2074 6f20      Function to 
-00029870: 7365 7420 7468 6520 6361 7365 206f 6620  set the case of 
-00029880: 7468 6520 6f75 7470 7574 2063 6f6c 6e61  the output colna
-00029890: 6d65 732c 2065 2e67 2e2c 2060 7374 722e  mes, e.g., `str.
-000298a0: 6c6f 7765 7260 2c0a 2020 2020 2020 2020  lower`,.        
-000298b0: 6073 7472 2e75 7070 6572 602c 2060 7374  `str.upper`, `st
-000298c0: 722e 7469 746c 6560 2e0a 0a20 2020 2052  r.title`...    R
-000298d0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-000298e0: 2d2d 0a20 2020 2074 6162 203a 2060 7e61  --.    tab : `~a
-000298f0: 7374 726f 7079 2e74 6162 6c65 2e54 6162  stropy.table.Tab
-00029900: 6c65 600a 2020 2020 2020 2020 4f75 7470  le`.        Outp
-00029910: 7574 2074 6162 6c65 2e0a 0a20 2020 2022  ut table...    "
-00029920: 2222 0a20 2020 2069 6d70 6f72 7420 6e75  "".    import nu
-00029930: 6d70 7920 6173 206e 700a 2020 2020 696d  mpy as np.    im
-00029940: 706f 7274 2061 7374 726f 7079 2e69 6f2e  port astropy.io.
-00029950: 6669 7473 2061 7320 7079 6669 7473 0a20  fits as pyfits. 
-00029960: 2020 2066 726f 6d20 6173 7472 6f70 792e     from astropy.
-00029970: 7461 626c 6520 696d 706f 7274 2054 6162  table import Tab
-00029980: 6c65 0a0a 2020 2020 2320 4966 206b 6579  le..    # If key
-00029990: 776f 7264 733d 4e6f 6e65 2c20 6765 7420  words=None, get 
-000299a0: 6675 6c6c 206c 6973 7420 6672 6f6d 2066  full list from f
-000299b0: 6972 7374 2046 4954 5320 6669 6c65 0a20  irst FITS file. 
-000299c0: 2020 2069 6620 6b65 7977 6f72 6473 2069     if keywords i
-000299d0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000299e0: 6820 3d20 7079 6669 7473 2e67 6574 6865  h = pyfits.gethe
-000299f0: 6164 6572 2866 6974 735f 6669 6c65 735b  ader(fits_files[
-00029a00: 305d 2c20 6578 7429 0a20 2020 2020 2020  0], ext).       
-00029a10: 206b 6579 776f 7264 7320 3d20 6c69 7374   keywords = list
-00029a20: 286e 702e 756e 6971 7565 286c 6973 7428  (np.unique(list(
-00029a30: 682e 6b65 7973 2829 2929 290a 2020 2020  h.keys()))).    
-00029a40: 2020 2020 6b65 7977 6f72 6473 2e70 6f70      keywords.pop
-00029a50: 286b 6579 776f 7264 732e 696e 6465 7828  (keywords.index(
-00029a60: 2727 2929 0a20 2020 2020 2020 206b 6579  '')).        key
-00029a70: 776f 7264 732e 706f 7028 6b65 7977 6f72  words.pop(keywor
-00029a80: 6473 2e69 6e64 6578 2827 4849 5354 4f52  ds.index('HISTOR
-00029a90: 5927 2929 0a0a 2020 2020 2320 4c6f 6f70  Y'))..    # Loop
-00029aa0: 2074 6872 6f75 6768 2066 696c 6573 0a20   through files. 
-00029ab0: 2020 206c 696e 6573 203d 205b 5d0a 2020     lines = [].  
-00029ac0: 2020 666f 7220 6669 6c65 2069 6e20 6669    for file in fi
-00029ad0: 7473 5f66 696c 6573 3a0a 2020 2020 2020  ts_files:.      
-00029ae0: 2020 6c69 6e65 203d 205b 6669 6c65 5d0a    line = [file].
-00029af0: 2020 2020 2020 2020 6820 3d20 7079 6669          h = pyfi
-00029b00: 7473 2e67 6574 6865 6164 6572 2866 696c  ts.getheader(fil
-00029b10: 652c 2065 7874 290a 2020 2020 2020 2020  e, ext).        
-00029b20: 666f 7220 6b65 7920 696e 206b 6579 776f  for key in keywo
-00029b30: 7264 733a 0a20 2020 2020 2020 2020 2020  rds:.           
-00029b40: 2069 6620 6b65 7920 696e 2068 3a0a 2020   if key in h:.  
-00029b50: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00029b60: 6e65 2e61 7070 656e 6428 685b 6b65 795d  ne.append(h[key]
-00029b70: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00029b80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00029b90: 2020 2020 6c69 6e65 2e61 7070 656e 6428      line.append(
-00029ba0: 4e6f 6e65 290a 0a20 2020 2020 2020 206c  None)..        l
-00029bb0: 696e 6573 2e61 7070 656e 6428 6c69 6e65  ines.append(line
-00029bc0: 290a 0a20 2020 2023 2043 6f6c 756d 6e20  )..    # Column 
-00029bd0: 6e61 6d65 730a 2020 2020 7461 626c 655f  names.    table_
-00029be0: 6865 6164 6572 203d 205b 636f 6c6e 616d  header = [colnam
-00029bf0: 655f 6361 7365 286b 6579 2920 666f 7220  e_case(key) for 
-00029c00: 6b65 7920 696e 205b 2766 696c 6527 5d2b  key in ['file']+
-00029c10: 6b65 7977 6f72 6473 5d0a 0a20 2020 2023  keywords]..    #
-00029c20: 204f 7574 7075 7420 7461 626c 650a 2020   Output table.  
-00029c30: 2020 7461 6220 3d20 5461 626c 6528 6461    tab = Table(da
-00029c40: 7461 3d6e 702e 6172 7261 7928 6c69 6e65  ta=np.array(line
-00029c50: 7329 2c20 6e61 6d65 733d 7461 626c 655f  s), names=table_
-00029c60: 6865 6164 6572 290a 0a20 2020 2072 6574  header)..    ret
-00029c70: 7572 6e20 7461 620a 0a0a 6465 6620 7061  urn tab...def pa
-00029c80: 7273 655f 7333 5f75 726c 2875 726c 3d27  rse_s3_url(url='
-00029c90: 7333 3a2f 2f62 7563 6b65 742f 7061 7468  s3://bucket/path
-00029ca0: 2f74 6f2f 6669 6c65 2e74 7874 2729 3a0a  /to/file.txt'):.
-00029cb0: 2020 2020 2222 220a 2020 2020 5061 7273      """.    Pars
-00029cc0: 6520 7333 2070 6174 6820 7374 7269 6e67  e s3 path string
-00029cd0: 0a20 2020 200a 2020 2020 5061 7261 6d65  .    .    Parame
-00029ce0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00029cf0: 2d2d 2d0a 2020 2020 7572 6c20 3a20 7374  ---.    url : st
-00029d00: 720a 2020 2020 2020 2020 4675 6c6c 2053  r.        Full S
-00029d10: 3320 7061 7468 2c20 652e 672e 2c20 6060  3 path, e.g., ``
-00029d20: 5b73 333a 2f2f 5d7b 6275 636b 6574 5f6e  [s3://]{bucket_n
-00029d30: 616d 657d 2f7b 7333 5f6f 626a 6563 747d  ame}/{s3_object}
-00029d40: 6060 0a20 2020 200a 2020 2020 5265 7475  ``.    .    Retu
-00029d50: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00029d60: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
-00029d70: 3a20 7374 720a 2020 2020 2020 2020 4275  : str.        Bu
-00029d80: 636b 6574 206e 616d 650a 2020 2020 0a20  cket name.    . 
-00029d90: 2020 2073 335f 6f62 6a65 6374 203a 2073     s3_object : s
-00029da0: 7472 0a20 2020 2020 2020 2046 756c 6c20  tr.        Full 
-00029db0: 7061 7468 206f 6620 7468 6520 5333 2066  path of the S3 f
-00029dc0: 696c 6520 6f62 6a65 6374 0a20 2020 200a  ile object.    .
-00029dd0: 2020 2020 6669 6c65 6e61 6d65 203a 2073      filename : s
-00029de0: 7472 0a20 2020 2020 2020 2046 696c 6520  tr.        File 
-00029df0: 6e61 6d65 206f 6620 7468 6520 6f62 6a65  name of the obje
-00029e00: 6374 2c20 652e 672e 2060 606f 732e 7061  ct, e.g. ``os.pa
-00029e10: 7468 2e62 6173 656e 616d 6528 7333 5f6f  th.basename(s3_o
-00029e20: 626a 6563 7429 6060 0a20 2020 2020 2020  bject)``.       
-00029e30: 200a 2020 2020 2222 220a 2020 2020 7375   .    """.    su
-00029e40: 726c 203d 2075 726c 2e73 7472 6970 2827  rl = url.strip('
-00029e50: 7333 3a2f 2f27 290a 2020 2020 7370 6c20  s3://').    spl 
-00029e60: 3d20 7375 726c 2e73 706c 6974 2827 2f27  = surl.split('/'
-00029e70: 290a 2020 2020 6966 206c 656e 2873 706c  ).    if len(spl
-00029e80: 2920 3c20 323a 0a20 2020 2020 2020 2070  ) < 2:.        p
-00029e90: 7269 6e74 2866 2262 7563 6b65 7420 2f20  rint(f"bucket / 
-00029ea0: 7061 7468 206e 6f74 2066 6f75 6e64 2069  path not found i
-00029eb0: 6e20 7b75 726c 7d22 290a 2020 2020 2020  n {url}").      
-00029ec0: 2020 7265 7475 726e 204e 6f6e 652c 204e    return None, N
-00029ed0: 6f6e 652c 204e 6f6e 650a 2020 2020 2020  one, None.      
-00029ee0: 2020 0a20 2020 2062 7563 6b65 745f 6e61    .    bucket_na
-00029ef0: 6d65 203d 2073 706c 5b30 5d0a 2020 2020  me = spl[0].    
-00029f00: 7333 5f6f 626a 6563 7420 3d20 272f 272e  s3_object = '/'.
-00029f10: 6a6f 696e 2873 706c 5b31 3a5d 290a 2020  join(spl[1:]).  
-00029f20: 2020 6669 6c65 6e61 6d65 203d 206f 732e    filename = os.
-00029f30: 7061 7468 2e62 6173 656e 616d 6528 7333  path.basename(s3
-00029f40: 5f6f 626a 6563 7429 0a20 2020 2072 6574  _object).    ret
-00029f50: 7572 6e20 6275 636b 6574 5f6e 616d 652c  urn bucket_name,
-00029f60: 2073 335f 6f62 6a65 6374 2c20 6669 6c65   s3_object, file
-00029f70: 6e61 6d65 0a0a 0a64 6566 2066 6574 6368  name...def fetch
-00029f80: 5f73 335f 7572 6c28 7572 6c3d 2773 333a  _s3_url(url='s3:
-00029f90: 2f2f 6275 636b 6574 2f70 6174 682f 746f  //bucket/path/to
-00029fa0: 2f66 696c 652e 7478 7427 2c20 6669 6c65  /file.txt', file
-00029fb0: 5f66 756e 633d 6c61 6d62 6461 2078 203a  _func=lambda x :
-00029fc0: 206f 732e 7061 7468 2e6a 6f69 6e28 272e   os.path.join('.
-00029fd0: 2f27 2c78 292c 2073 6b69 705f 6578 6973  /',x), skip_exis
-00029fe0: 7469 6e67 3d54 7275 652c 2076 6572 626f  ting=True, verbo
-00029ff0: 7365 3d54 7275 6529 3a0a 2020 2020 2222  se=True):.    ""
-0002a000: 220a 2020 2020 4665 7463 6820 6669 6c65  ".    Fetch file
-0002a010: 2066 726f 6d20 616e 2053 3320 6275 636b   from an S3 buck
-0002a020: 6574 0a20 2020 200a 2020 2020 5061 7261  et.    .    Para
-0002a030: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-0002a040: 2d2d 2d2d 2d0a 2020 2020 7572 6c20 3a20  -----.    url : 
-0002a050: 7374 720a 2020 2020 2020 2020 5333 2075  str.        S3 u
-0002a060: 726c 206f 6620 6120 6669 6c65 2074 6f20  rl of a file to 
-0002a070: 646f 776e 6c6f 6164 0a20 2020 200a 2020  download.    .  
-0002a080: 2020 6669 6c65 5f66 756e 6320 3a20 6675    file_func : fu
-0002a090: 6e63 7469 6f6e 0a20 2020 2020 2020 2046  nction.        F
-0002a0a0: 756e 6374 696f 6e20 6170 706c 6965 6420  unction applied 
-0002a0b0: 746f 2074 6865 2066 696c 6520 6e61 6d65  to the file name
-0002a0c0: 2065 7874 7261 6374 6564 2066 726f 6d20   extracted from 
-0002a0d0: 6075 726c 602c 2065 2e67 2e2c 2074 6f20  `url`, e.g., to 
-0002a0e0: 0a20 2020 2020 2020 2073 6574 206f 7574  .        set out
-0002a0f0: 7075 7420 6469 7265 6374 6f72 792c 2072  put directory, r
-0002a100: 656e 616d 6520 6669 6c65 732c 2073 6574  ename files, set
-0002a110: 2061 2070 7265 6669 782c 2065 7463 2e0a   a prefix, etc..
-0002a120: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
-0002a130: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-0002a140: 206c 6f63 616c 5f66 696c 6520 3a20 7374   local_file : st
-0002a150: 720a 2020 2020 2020 2020 4e61 6d65 206f  r.        Name o
-0002a160: 6620 6c6f 6361 6c20 6669 6c65 206f 7220  f local file or 
-0002a170: 604e 6f6e 6560 2069 6620 6661 696c 6564  `None` if failed
-0002a180: 2074 6f20 7061 7273 6520 6075 726c 600a   to parse `url`.
-0002a190: 2020 2020 0a20 2020 2073 7461 7475 7320      .    status 
-0002a1a0: 3a20 696e 740a 2020 2020 2020 2020 4269  : int.        Bi
-0002a1b0: 7420 666c 6167 206f 6620 7265 7375 6c74  t flag of result
-0002a1c0: 733a 202a 2a31 2a2a 203d 3d20 6669 6c65  s: **1** == file
-0002a1d0: 2066 6f75 6e64 2c20 2a2a 322a 2a20 3d20   found, **2** = 
-0002a1e0: 646f 776e 6c6f 6164 2073 7563 6365 7373  download success
-0002a1f0: 6675 6c0a 2020 2020 2020 2020 0a20 2020  ful.        .   
-0002a200: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-0002a210: 7472 6163 6562 6163 6b0a 2020 2020 696d  traceback.    im
-0002a220: 706f 7274 2062 6f74 6f33 0a20 2020 2069  port boto3.    i
-0002a230: 6d70 6f72 7420 626f 746f 636f 7265 2e65  mport botocore.e
-0002a240: 7863 6570 7469 6f6e 730a 2020 2020 0a20  xceptions.    . 
-0002a250: 2020 2073 3320 3d20 626f 746f 332e 7265     s3 = boto3.re
-0002a260: 736f 7572 6365 2827 7333 2729 0a20 2020  source('s3').   
-0002a270: 2062 7563 6b65 745f 6e61 6d65 2c20 7333   bucket_name, s3
-0002a280: 5f6f 626a 6563 742c 2066 696c 656e 616d  _object, filenam
-0002a290: 6520 3d20 7061 7273 655f 7333 5f75 726c  e = parse_s3_url
-0002a2a0: 2875 726c 3d75 726c 290a 2020 2020 6966  (url=url).    if
-0002a2b0: 2062 7563 6b65 745f 6e61 6d65 2069 7320   bucket_name is 
-0002a2c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
-0002a2d0: 7475 726e 2075 726c 2c20 6f73 2e70 6174  turn url, os.pat
-0002a2e0: 682e 6578 6973 7473 2875 726c 290a 2020  h.exists(url).  
-0002a2f0: 2020 2020 2020 0a20 2020 2062 6b74 203d        .    bkt =
-0002a300: 2073 332e 4275 636b 6574 2862 7563 6b65   s3.Bucket(bucke
-0002a310: 745f 6e61 6d65 290a 2020 2020 6c6f 6361  t_name).    loca
-0002a320: 6c5f 6669 6c65 203d 2066 696c 655f 6675  l_file = file_fu
-0002a330: 6e63 2866 696c 656e 616d 6529 0a20 2020  nc(filename).   
-0002a340: 2073 7461 7475 7320 3d20 6f73 2e70 6174   status = os.pat
-0002a350: 682e 6578 6973 7473 286c 6f63 616c 5f66  h.exists(local_f
-0002a360: 696c 6529 2a31 0a20 2020 200a 2020 2020  ile)*1.    .    
-0002a370: 6966 2028 7374 6174 7573 203e 2030 2920  if (status > 0) 
-0002a380: 2620 736b 6970 5f65 7869 7374 696e 673a  & skip_existing:
-0002a390: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
-0002a3a0: 277b 6c6f 6361 6c5f 6669 6c65 7d20 6578  '{local_file} ex
-0002a3b0: 6973 7473 2c20 736b 6970 7069 6e67 2e27  ists, skipping.'
-0002a3c0: 290a 2020 2020 656c 7365 3a0a 0a20 2020  ).    else:..   
-0002a3d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002a3e0: 2020 2020 2020 626b 742e 646f 776e 6c6f        bkt.downlo
-0002a3f0: 6164 5f66 696c 6528 7333 5f6f 626a 6563  ad_file(s3_objec
-0002a400: 742c 206c 6f63 616c 5f66 696c 652c 0a20  t, local_file,. 
-0002a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a420: 2020 2020 2045 7874 7261 4172 6773 3d7b       ExtraArgs={
-0002a430: 2252 6571 7565 7374 5061 7965 7222 3a20  "RequestPayer": 
-0002a440: 2272 6571 7565 7374 6572 227d 290a 2020  "requester"}).  
-0002a450: 2020 2020 2020 2020 2020 7374 6174 7573            status
-0002a460: 202b 3d20 320a 2020 2020 2020 2020 2020   += 2.          
-0002a470: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0002a480: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0002a490: 696e 7428 6627 7b75 726c 7d20 3e20 7b6c  int(f'{url} > {l
-0002a4a0: 6f63 616c 5f66 696c 657d 2729 0a20 2020  ocal_file}').   
-0002a4b0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0002a4c0: 2020 2020 2020 6578 6365 7074 2062 6f74        except bot
-0002a4d0: 6f63 6f72 652e 6578 6365 7074 696f 6e73  ocore.exceptions
-0002a4e0: 2e43 6c69 656e 7445 7272 6f72 3a0a 2020  .ClientError:.  
-0002a4f0: 2020 2020 2020 2020 2020 7472 6163 6520            trace 
-0002a500: 3d20 7472 6163 6562 6163 6b2e 666f 726d  = traceback.form
-0002a510: 6174 5f65 7863 286c 696d 6974 3d32 290a  at_exc(limit=2).
-0002a520: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-0002a530: 3d20 7472 6163 652e 7370 6c69 7428 275c  = trace.split('\
-0002a540: 6e27 295b 2d32 5d2e 7370 6c69 7428 2743  n')[-2].split('C
-0002a550: 6c69 656e 7445 7272 6f72 3a20 2729 5b31  lientError: ')[1
-0002a560: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0002a570: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0002a580: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002a590: 6627 4661 696c 6564 207b 7572 6c7d 3a20  f'Failed {url}: 
-0002a5a0: 7b6d 7367 7d27 290a 2020 2020 2020 2020  {msg}').        
-0002a5b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002a5c0: 2020 2020 2023 2044 6f77 6e6c 6f61 6420       # Download 
-0002a5d0: 6661 696c 6564 2064 7565 2074 6f20 6120  failed due to a 
-0002a5e0: 436c 6965 6e74 4572 726f 720a 2020 2020  ClientError.    
-0002a5f0: 2020 2020 2020 2020 2320 466f 7262 6964          # Forbid
-0002a600: 6465 6e20 7072 6f62 6162 6c79 206d 6561  den probably mea
-0002a610: 6e73 2069 6e73 7566 6669 6369 656e 7420  ns insufficient 
-0002a620: 6275 636b 6574 2061 6363 6573 7320 7072  bucket access pr
-0002a630: 6976 696c 6567 6573 0a20 2020 2020 2020  ivileges.       
-0002a640: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-0002a650: 2020 2020 2020 0a20 2020 2072 6574 7572        .    retur
-0002a660: 6e20 6c6f 6361 6c5f 6669 6c65 2c20 7374  n local_file, st
-0002a670: 6174 7573 0a0a 0a64 6566 206e 6972 6973  atus...def niris
-0002a680: 735f 6768 6f73 745f 6d61 736b 2869 6d2c  s_ghost_mask(im,
-0002a690: 2069 6e69 745f 7468 7265 7368 3d30 2e30   init_thresh=0.0
-0002a6a0: 352c 2069 6e69 745f 7369 676d 613d 332c  5, init_sigma=3,
-0002a6b0: 2066 696e 616c 5f74 6872 6573 683d 302e   final_thresh=0.
-0002a6c0: 3031 2c20 6669 6e61 6c5f 7369 676d 613d  01, final_sigma=
-0002a6d0: 332c 2065 726f 7369 6f6e 733d 302c 2064  3, erosions=0, d
-0002a6e0: 696c 6174 696f 6e73 3d39 2c20 7665 7262  ilations=9, verb
-0002a6f0: 6f73 653d 5472 7565 2c20 2a2a 6b77 6172  ose=True, **kwar
-0002a700: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
-0002a710: 204d 616b 6520 6120 6d61 736b 2066 6f72   Make a mask for
-0002a720: 204e 4952 4953 5320 696d 6167 696e 6720   NIRISS imaging 
-0002a730: 6768 6f73 7473 0a20 2020 200a 2020 2020  ghosts.    .    
-0002a740: 5365 6520 616c 736f 204d 6172 7465 6c2e  See also Martel.
-0002a750: 204a 5753 542d 5354 5363 492d 3030 3438   JWST-STScI-0048
-0002a760: 3737 2061 6e64 0a20 2020 2068 7474 7073  77 and.    https
-0002a770: 3a2f 2f67 6974 6875 622e 636f 6d2f 7370  ://github.com/sp
-0002a780: 6163 6574 656c 6573 636f 7065 2f6e 6972  acetelescope/nir
-0002a790: 6973 735f 6768 6f73 740a 2020 2020 0a20  iss_ghost.    . 
-0002a7a0: 2020 2048 6572 650a 2020 2020 2222 220a     Here.    """.
-0002a7b0: 2020 2020 696d 706f 7274 2073 6369 7079      import scipy
-0002a7c0: 2e6e 6469 6d61 6765 2061 7320 6e64 0a20  .ndimage as nd. 
-0002a7d0: 2020 200a 2020 2020 6966 2069 6d5b 305d     .    if im[0]
-0002a7e0: 2e68 6561 6465 725b 2750 5550 494c 275d  .header['PUPIL']
-0002a7f0: 206e 6f74 2069 6e20 5b27 4631 3135 5727   not in ['F115W'
-0002a800: 2c27 4631 3530 5727 2c27 4632 3030 5727  ,'F150W','F200W'
-0002a810: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0002a820: 6e20 4661 6c73 650a 2020 2020 0a20 2020  n False.    .   
-0002a830: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
-0002a840: 5b27 5055 5049 4c27 5d20 3d3d 2027 4631  ['PUPIL'] == 'F1
-0002a850: 3135 5727 3a0a 2020 2020 2020 2020 7867  15W':.        xg
-0002a860: 6170 2c20 7967 6170 203d 2031 3135 362c  ap, ygap = 1156,
-0002a870: 2039 3237 0a20 2020 2065 6c69 6620 696d   927.    elif im
-0002a880: 5b30 5d2e 6865 6164 6572 5b27 5055 5049  [0].header['PUPI
-0002a890: 4c27 5d20 3d3d 2027 4631 3135 5727 3a0a  L'] == 'F115W':.
-0002a8a0: 2020 2020 2020 2020 7867 6170 2c20 7967          xgap, yg
-0002a8b0: 6170 203d 2031 3136 322c 2039 3338 0a20  ap = 1162, 938. 
-0002a8c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002a8d0: 2078 6761 702c 2079 6761 7020 3d20 3131   xgap, ygap = 11
-0002a8e0: 3536 2c20 3934 342d 320a 2020 2020 2020  56, 944-2.      
-0002a8f0: 2020 0a20 2020 2079 702c 2078 7020 3d20    .    yp, xp = 
-0002a900: 6e70 2e69 6e64 6963 6573 2828 3230 3438  np.indices((2048
-0002a910: 2c20 3230 3438 2929 0a20 2020 200a 2020  , 2048)).    .  
-0002a920: 2020 7967 203d 2032 2a28 7967 6170 2d31    yg = 2*(ygap-1
-0002a930: 2920 2d20 7970 0a20 2020 2078 6720 3d20  ) - yp.    xg = 
-0002a940: 322a 2878 6761 702d 3129 202d 2078 700a  2*(xgap-1) - xp.
-0002a950: 0a20 2020 2064 7820 3d20 2878 7020 2d20  .    dx = (xp - 
-0002a960: 7867 6170 290a 2020 2020 6479 203d 2028  xgap).    dy = (
-0002a970: 7970 202d 2079 6761 7029 0a0a 2020 2020  yp - ygap)..    
-0002a980: 696e 5f69 6d67 203d 2028 7867 203e 3d20  in_img = (xg >= 
-0002a990: 3029 2026 2028 7867 203c 2032 3034 3829  0) & (xg < 2048)
-0002a9a0: 0a20 2020 2069 6e5f 696d 6720 263d 2028  .    in_img &= (
-0002a9b0: 7967 203e 3d20 3029 2026 2028 7967 203c  yg >= 0) & (yg <
-0002a9c0: 2032 3034 3829 0a0a 2020 2020 696e 5f69   2048)..    in_i
-0002a9d0: 6d67 2026 3d20 6e70 2e61 6273 2864 7829  mg &= np.abs(dx)
-0002a9e0: 203c 2034 3030 0a20 2020 2069 6e5f 696d   < 400.    in_im
-0002a9f0: 6720 263d 206e 702e 6162 7328 6479 2920  g &= np.abs(dy) 
-0002aa00: 3c20 3430 300a 2020 2020 0a20 2020 2069  < 400.    .    i
-0002aa10: 6620 274d 4452 495a 534b 5927 2069 6e20  f 'MDRIZSKY' in 
-0002aa20: 696d 5b27 5343 4927 5d2e 6865 6164 6572  im['SCI'].header
-0002aa30: 3a0a 2020 2020 2020 2020 626b 6720 3d20  :.        bkg = 
-0002aa40: 696d 5b27 5343 4927 5d2e 6865 6164 6572  im['SCI'].header
-0002aa50: 5b27 4d44 5249 5a53 4b59 275d 0a20 2020  ['MDRIZSKY'].   
-0002aa60: 2065 6c73 653a 0a20 2020 2020 2020 2062   else:.        b
-0002aa70: 6b67 203d 206e 702e 6e61 6e6d 6564 6961  kg = np.nanmedia
-0002aa80: 6e28 696d 5b27 5343 4927 5d2e 6461 7461  n(im['SCI'].data
-0002aa90: 5b69 6d5b 2744 5127 5d2e 6461 7461 203d  [im['DQ'].data =
-0002aaa0: 3d20 305d 290a 2020 2020 2020 2020 0a20  = 0]).        . 
-0002aab0: 2020 2074 6872 6573 6820 3d20 2869 6d5b     thresh = (im[
-0002aac0: 2753 4349 275d 2e64 6174 6120 2d20 626b  'SCI'].data - bk
-0002aad0: 6729 2a69 6e69 745f 7468 7265 7368 203e  g)*init_thresh >
-0002aae0: 2069 6e69 745f 7369 676d 612a 696d 5b27   init_sigma*im['
-0002aaf0: 4552 5227 5d2e 6461 7461 0a20 2020 2074  ERR'].data.    t
-0002ab00: 6872 6573 6820 263d 2069 6e5f 696d 670a  hresh &= in_img.
-0002ab10: 0a20 2020 205f 7265 666c 6563 7465 6420  .    _reflected 
-0002ab20: 3d20 6e70 2e7a 6572 6f73 5f6c 696b 6528  = np.zeros_like(
-0002ab30: 696d 5b27 5343 4927 5d2e 6461 7461 290a  im['SCI'].data).
-0002ab40: 2020 2020 666f 7220 7870 692c 2079 7069      for xpi, ypi
-0002ab50: 2c20 7867 692c 2079 6769 2069 6e20 7a69  , xgi, ygi in zi
-0002ab60: 7028 7870 5b74 6872 6573 685d 2c20 7970  p(xp[thresh], yp
-0002ab70: 5b74 6872 6573 685d 2c0a 2020 2020 2020  [thresh],.      
-0002ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab90: 2020 2020 2020 2020 2020 2020 7867 5b74              xg[t
-0002aba0: 6872 6573 685d 2c20 7967 5b74 6872 6573  hresh], yg[thres
-0002abb0: 685d 293a 0a20 2020 2020 2020 2020 2020  h]):.           
-0002abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002abd0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002abe0: 5f72 6566 6c65 6374 6564 5b79 6769 2c20  _reflected[ygi, 
-0002abf0: 7867 695d 203d 2069 6d5b 2753 4349 275d  xgi] = im['SCI']
-0002ac00: 2e64 6174 615b 7970 692c 2078 7069 5d20  .data[ypi, xpi] 
-0002ac10: 2d20 626b 670a 0a20 2020 2067 686f 7374  - bkg..    ghost
-0002ac20: 5f6d 6173 6b20 3d20 5f72 6566 6c65 6374  _mask = _reflect
-0002ac30: 6564 2a66 696e 616c 5f74 6872 6573 6820  ed*final_thresh 
-0002ac40: 3e20 6669 6e61 6c5f 7369 676d 612a 696d  > final_sigma*im
-0002ac50: 5b27 4552 5227 5d2e 6461 7461 0a20 2020  ['ERR'].data.   
-0002ac60: 200a 2020 2020 6966 2065 726f 7369 6f6e   .    if erosion
-0002ac70: 7320 3e20 303a 0a20 2020 2020 2020 2067  s > 0:.        g
-0002ac80: 686f 7374 5f6d 6173 6b20 3d20 6e64 2e62  host_mask = nd.b
-0002ac90: 696e 6172 795f 6572 6f73 696f 6e28 6768  inary_erosion(gh
-0002aca0: 6f73 745f 6d61 736b 2c20 6974 6572 6174  ost_mask, iterat
-0002acb0: 696f 6e73 3d65 726f 7369 6f6e 7329 0a20  ions=erosions). 
-0002acc0: 2020 2020 2020 200a 2020 2020 6768 6f73         .    ghos
-0002acd0: 745f 6d61 736b 203d 206e 642e 6269 6e61  t_mask = nd.bina
-0002ace0: 7279 5f64 696c 6174 696f 6e28 6768 6f73  ry_dilation(ghos
-0002acf0: 745f 6d61 736b 2c20 6974 6572 6174 696f  t_mask, iteratio
-0002ad00: 6e73 3d64 696c 6174 696f 6e73 290a 2020  ns=dilations).  
-0002ad10: 2020 0a20 2020 2069 6d5b 305d 2e68 6561    .    im[0].hea
-0002ad20: 6465 725b 2747 484f 5354 4d53 4b27 5d20  der['GHOSTMSK'] 
-0002ad30: 3d20 5472 7565 2c20 274e 4952 4953 5320  = True, 'NIRISS 
-0002ad40: 6768 6f73 7420 6d61 736b 2061 7070 6c69  ghost mask appli
-0002ad50: 6564 270a 2020 2020 696d 5b30 5d2e 6865  ed'.    im[0].he
-0002ad60: 6164 6572 5b27 4748 4f53 544e 5058 275d  ader['GHOSTNPX']
-0002ad70: 203d 2067 686f 7374 5f6d 6173 6b2e 7375   = ghost_mask.su
-0002ad80: 6d28 292c 2027 5069 7865 6c73 2069 6e20  m(), 'Pixels in 
-0002ad90: 4e49 5249 5353 2067 686f 7374 206d 6173  NIRISS ghost mas
-0002ada0: 6b27 0a20 2020 200a 2020 2020 6d73 6720  k'.    .    msg 
-0002adb0: 3d20 274e 4952 4953 5320 6768 6f73 7420  = 'NIRISS ghost 
-0002adc0: 6d61 736b 207b 307d 204e 7069 783a 207b  mask {0} Npix: {
-0002add0: 317d 5c6e 272e 666f 726d 6174 2869 6d5b  1}\n'.format(im[
-0002ade0: 305d 2e68 6561 6465 725b 2750 5550 494c  0].header['PUPIL
-0002adf0: 275d 2c20 0a20 2020 2020 2020 2020 2020  '], .           
-0002ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae20: 2020 2020 2020 2020 2067 686f 7374 5f6d           ghost_m
-0002ae30: 6173 6b2e 7375 6d28 2929 0a20 2020 206c  ask.sum()).    l
-0002ae40: 6f67 5f63 6f6d 6d65 6e74 284c 4f47 4649  og_comment(LOGFI
-0002ae50: 4c45 2c20 6d73 672c 2076 6572 626f 7365  LE, msg, verbose
-0002ae60: 3d76 6572 626f 7365 290a 2020 2020 0a20  =verbose).    . 
-0002ae70: 2020 2072 6574 7572 6e20 6768 6f73 745f     return ghost_
-0002ae80: 6d61 736b 0a0a 0a64 6566 2067 6574 5f70  mask...def get_p
-0002ae90: 686f 746f 6d5f 7363 616c 6528 6865 6164  hotom_scale(head
-0002aea0: 6572 2c20 7665 7262 6f73 653d 5472 7565  er, verbose=True
-0002aeb0: 293a 0a20 2020 2022 2222 0a20 2020 2047  ):.    """.    G
-0002aec0: 6574 2074 6162 756c 6174 6564 2073 6361  et tabulated sca
-0002aed0: 6c65 2066 6163 746f 720a 2020 2020 0a20  le factor.    . 
-0002aee0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0002aef0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0002af00: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
-0002af10: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-0002af20: 6572 600a 2020 2020 2020 2020 496d 6167  er`.        Imag
-0002af30: 6520 6865 6164 6572 0a20 2020 200a 2020  e header.    .  
-0002af40: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-0002af50: 2d2d 2d2d 2d0a 2020 2020 6b65 7920 3a20  -----.    key : 
-0002af60: 7374 720a 2020 2020 2020 2020 4465 7465  str.        Dete
-0002af70: 6374 6f72 202b 2066 696c 7465 7220 6b65  ctor + filter ke
-0002af80: 790a 2020 2020 0a20 2020 2073 6361 6c65  y.    .    scale
-0002af90: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-0002afa0: 2053 6361 6c65 2076 616c 7565 2e20 2049   Scale value.  I
-0002afb0: 6620 606b 6579 6020 6e6f 7420 666f 756e  f `key` not foun
-0002afc0: 6420 696e 2074 6865 2060 6064 6174 612f  d in the ``data/
-0002afd0: 7068 6f74 6f6d 5f63 6f72 7265 6374 696f  photom_correctio
-0002afe0: 6e2e 796d 6c60 600a 2020 2020 2020 2020  n.yml``.        
-0002aff0: 7461 626c 6520 6f72 2069 6620 7468 6520  table or if the 
-0002b000: 4354 5820 6973 206e 6577 6572 2074 6861  CTX is newer tha
-0002b010: 6e20 7468 6174 2069 6e64 6963 6174 6564  n that indicated
-0002b020: 2069 6e20 7468 6520 636f 7272 6563 7469   in the correcti
-0002b030: 6f6e 0a20 2020 2020 2020 2074 6162 6c65  on.        table
-0002b040: 2074 6865 6e20 7265 7475 726e 2031 2e30   then return 1.0
-0002b050: 2e0a 2020 2020 2020 2020 0a20 2020 2022  ..        .    "
-0002b060: 2222 0a20 2020 2069 6d70 6f72 7420 7961  "".    import ya
-0002b070: 6d6c 0a20 2020 2069 6620 2754 454c 4553  ml.    if 'TELES
-0002b080: 434f 5027 2069 6e20 6865 6164 6572 3a0a  COP' in header:.
-0002b090: 2020 2020 2020 2020 6966 2068 6561 6465          if heade
-0002b0a0: 725b 2754 454c 4553 434f 5027 5d20 6e6f  r['TELESCOP'] no
-0002b0b0: 7420 696e 205b 274a 5753 5427 5d3a 0a20  t in ['JWST']:. 
-0002b0c0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0002b0d0: 2066 2267 6574 5f70 686f 746f 6d5f 7363   f"get_photom_sc
-0002b0e0: 616c 653a 2054 454c 4553 434f 503d 7b68  ale: TELESCOP={h
-0002b0f0: 6561 6465 725b 2754 454c 4553 434f 5027  eader['TELESCOP'
-0002b100: 5d7d 2069 7320 6e6f 7420 274a 5753 5427  ]} is not 'JWST'
-0002b110: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
-0002b120: 675f 636f 6d6d 656e 7428 4c4f 4746 494c  g_comment(LOGFIL
-0002b130: 452c 206d 7367 2c20 7665 7262 6f73 653d  E, msg, verbose=
-0002b140: 7665 7262 6f73 6529 0a20 2020 2020 2020  verbose).       
-0002b150: 2020 2020 2072 6574 7572 6e20 6865 6164       return head
-0002b160: 6572 5b27 5445 4c45 5343 4f50 275d 2c20  er['TELESCOP'], 
-0002b170: 312e 300a 2020 2020 656c 7365 3a0a 2020  1.0.    else:.  
-0002b180: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0002b190: 652c 2031 2e30 0a20 2020 2020 2020 200a  e, 1.0.        .
-0002b1a0: 2020 2020 636f 7272 5f66 696c 6520 3d20      corr_file = 
-0002b1b0: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
-0002b1c0: 7061 7468 2e64 6972 6e61 6d65 285f 5f66  path.dirname(__f
-0002b1d0: 696c 655f 5f29 2c20 0a20 2020 2020 2020  ile__), .       
-0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1f0: 2020 2020 2020 2764 6174 612f 7068 6f74        'data/phot
-0002b200: 6f6d 5f63 6f72 7265 6374 696f 6e2e 796d  om_correction.ym
-0002b210: 6c27 290a 2020 2020 0a20 2020 2069 6620  l').    .    if 
-0002b220: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-0002b230: 7473 2863 6f72 725f 6669 6c65 293a 0a20  ts(corr_file):. 
-0002b240: 2020 2020 2020 206d 7367 203d 2066 277b         msg = f'{
-0002b250: 636f 7272 5f66 696c 657d 206e 6f74 2066  corr_file} not f
-0002b260: 6f75 6e64 2e27 0a20 2020 2020 2020 206c  ound.'.        l
-0002b270: 6f67 5f63 6f6d 6d65 6e74 284c 4f47 4649  og_comment(LOGFI
-0002b280: 4c45 2c20 6d73 672c 2076 6572 626f 7365  LE, msg, verbose
-0002b290: 3d76 6572 626f 7365 290a 2020 2020 2020  =verbose).      
-0002b2a0: 2020 7265 7475 726e 204e 6f6e 652c 2031    return None, 1
-0002b2b0: 0a20 2020 200a 2020 2020 7769 7468 206f  .    .    with o
-0002b2c0: 7065 6e28 636f 7272 5f66 696c 6529 2061  pen(corr_file) a
-0002b2d0: 7320 6670 3a0a 2020 2020 2020 2020 636f  s fp:.        co
-0002b2e0: 7272 203d 2079 616d 6c2e 6c6f 6164 2866  rr = yaml.load(f
-0002b2f0: 702c 204c 6f61 6465 723d 7961 6d6c 2e53  p, Loader=yaml.S
-0002b300: 6166 654c 6f61 6465 7229 0a20 2020 2020  afeLoader).     
-0002b310: 2020 200a 2020 2020 6966 2027 4352 4453     .    if 'CRDS
-0002b320: 5f43 5458 2720 696e 2068 6561 6465 723a  _CTX' in header:
-0002b330: 0a20 2020 2020 2020 2069 6620 6865 6164  .        if head
-0002b340: 6572 5b27 4352 4453 5f43 5458 275d 203e  er['CRDS_CTX'] >
-0002b350: 2063 6f72 725b 2743 5244 535f 4354 585f   corr['CRDS_CTX_
-0002b360: 4d41 5827 5d3a 0a20 2020 2020 2020 2020  MAX']:.         
-0002b370: 2020 206d 7367 203d 2066 2267 6574 5f70     msg = f"get_p
-0002b380: 686f 746f 6d5f 7363 616c 6520 7b63 6f72  hotom_scale {cor
-0002b390: 725f 6669 6c65 7d3a 207b 6865 6164 6572  r_file}: {header
-0002b3a0: 5b27 4352 4453 5f43 5458 275d 7d20 3e20  ['CRDS_CTX']} > 
-0002b3b0: 7b63 6f72 725b 2743 5244 535f 4354 585f  {corr['CRDS_CTX_
-0002b3c0: 4d41 5827 5d7d 220a 2020 2020 2020 2020  MAX']}".        
-0002b3d0: 2020 2020 6c6f 675f 636f 6d6d 656e 7428      log_comment(
-0002b3e0: 4c4f 4746 494c 452c 206d 7367 2c20 7665  LOGFILE, msg, ve
-0002b3f0: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
-0002b400: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002b410: 6e20 6865 6164 6572 5b27 4352 4453 5f43  n header['CRDS_C
-0002b420: 5458 275d 2c20 312e 300a 2020 2020 2020  TX'], 1.0.      
-0002b430: 2020 2020 2020 0a20 2020 206b 6579 203d        .    key =
-0002b440: 2027 7b30 7d2d 7b31 7d27 2e66 6f72 6d61   '{0}-{1}'.forma
-0002b450: 7428 6865 6164 6572 5b27 4445 5445 4354  t(header['DETECT
-0002b460: 4f52 275d 2c20 6865 6164 6572 5b27 4649  OR'], header['FI
-0002b470: 4c54 4552 275d 290a 2020 2020 6966 2027  LTER']).    if '
-0002b480: 5055 5049 4c27 2069 6e20 6865 6164 6572  PUPIL' in header
-0002b490: 3a0a 2020 2020 2020 2020 6b65 7920 2b3d  :.        key +=
-0002b4a0: 2027 2d7b 307d 272e 666f 726d 6174 2868   '-{0}'.format(h
-0002b4b0: 6561 6465 725b 2750 5550 494c 275d 290a  eader['PUPIL']).
-0002b4c0: 2020 2020 0a20 2020 2069 6620 6b65 7920      .    if key 
-0002b4d0: 6e6f 7420 696e 2063 6f72 723a 0a20 2020  not in corr:.   
-0002b4e0: 2020 2020 206d 7367 203d 2066 2267 6574       msg = f"get
-0002b4f0: 5f70 686f 746f 6d5f 7363 616c 6520 7b63  _photom_scale {c
-0002b500: 6f72 725f 6669 6c65 7d3a 207b 6b65 797d  orr_file}: {key}
-0002b510: 206e 6f74 2066 6f75 6e64 220a 2020 2020   not found".    
-0002b520: 2020 2020 6c6f 675f 636f 6d6d 656e 7428      log_comment(
-0002b530: 4c4f 4746 494c 452c 206d 7367 2c20 7665  LOGFILE, msg, ve
-0002b540: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
-0002b550: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002b560: 7265 7475 726e 206b 6579 2c20 312e 300a  return key, 1.0.
-0002b570: 2020 2020 0a20 2020 2065 6c73 653a 0a20      .    else:. 
-0002b580: 2020 2020 2020 206d 7367 203d 2066 2267         msg = f"g
-0002b590: 6574 5f70 686f 746f 6d5f 7363 616c 6520  et_photom_scale 
-0002b5a0: 7b63 6f72 725f 6669 6c65 7d3a 2053 6361  {corr_file}: Sca
-0002b5b0: 6c65 207b 6b65 797d 2062 7920 7b31 2e2f  le {key} by {1./
-0002b5c0: 636f 7272 5b6b 6579 5d3a 2e33 667d 220a  corr[key]:.3f}".
-0002b5d0: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
-0002b5e0: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
-0002b5f0: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
-0002b600: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
-0002b610: 2020 2020 7265 7475 726e 206b 6579 2c20      return key, 
-0002b620: 312e 2f63 6f72 725b 6b65 795d 0a0a 0a64  1./corr[key]...d
-0002b630: 6566 2064 7269 7a7a 6c65 5f66 726f 6d5f  ef drizzle_from_
-0002b640: 7669 7369 7428 7669 7369 742c 206f 7574  visit(visit, out
-0002b650: 7075 743d 4e6f 6e65 2c20 7069 7866 7261  put=None, pixfra
-0002b660: 633d 312e 2c20 6b65 726e 656c 3d27 706f  c=1., kernel='po
-0002b670: 696e 7427 2c0a 2020 2020 2020 2020 2020  int',.          
-0002b680: 2020 2020 2020 2020 2020 2020 2063 6c65               cle
-0002b690: 616e 3d54 7275 652c 2069 6e63 6c75 6465  an=True, include
-0002b6a0: 5f73 6174 7572 6174 6564 3d54 7275 652c  _saturated=True,
-0002b6b0: 206b 6565 705f 6269 7473 3d4e 6f6e 652c   keep_bits=None,
-0002b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b6d0: 2020 2020 2020 2020 6472 7972 756e 3d46          dryrun=F
-0002b6e0: 616c 7365 2c20 736b 6970 3d4e 6f6e 652c  alse, skip=None,
-0002b6f0: 2065 7874 7261 5f77 6663 3369 725f 6261   extra_wfc3ir_ba
-0002b700: 6470 6978 3d54 7275 652c 0a20 2020 2020  dpix=True,.     
-0002b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b720: 2020 7665 7262 6f73 653d 5472 7565 2c0a    verbose=True,.
-0002b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b740: 2020 2020 2020 2073 6361 6c65 5f70 686f         scale_pho
-0002b750: 746f 6d3d 5472 7565 2c0a 2020 2020 2020  tom=True,.      
-0002b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b770: 2063 616c 635f 7763 736d 6170 3d46 616c   calc_wcsmap=Fal
-0002b780: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-0002b790: 2020 2020 2020 2020 2020 206e 6972 6973             niris
-0002b7a0: 735f 6768 6f73 745f 6b77 6172 6773 3d7b  s_ghost_kwargs={
-0002b7b0: 7d29 3a0a 2020 2020 2222 220a 2020 2020  }):.    """.    
-0002b7c0: 4d61 6b65 2064 7269 7a7a 6c65 206d 6f73  Make drizzle mos
-0002b7d0: 6169 6320 6672 6f6d 2065 7870 6f73 7572  aic from exposur
-0002b7e0: 6573 2069 6e20 6120 7669 7369 7420 6469  es in a visit di
-0002b7f0: 6374 696f 6e61 7279 0a20 2020 200a 2020  ctionary.    .  
-0002b800: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-0002b810: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0002b820: 7669 7369 7420 3a20 6469 6374 0a20 2020  visit : dict.   
-0002b830: 2020 2020 2056 6973 6974 2064 6963 7469       Visit dicti
-0002b840: 6f6e 6172 7920 7769 7468 2027 7072 6f64  onary with 'prod
-0002b850: 7563 7427 2061 6e64 2027 6669 6c65 7327  uct' and 'files'
-0002b860: 206b 6579 730a 2020 2020 0a20 2020 206f   keys.    .    o
-0002b870: 7574 7075 7420 3a20 607e 6173 7472 6f70  utput : `~astrop
-0002b880: 792e 7763 732e 5743 5360 2c20 607e 6173  y.wcs.WCS`, `~as
-0002b890: 7472 6f70 792e 696f 2e66 6974 732e 4865  tropy.io.fits.He
-0002b8a0: 6164 6572 602c 2060 7e61 7374 726f 7079  ader`, `~astropy
-0002b8b0: 2e69 6f2e 496d 6167 6548 4455 600a 2020  .io.ImageHDU`.  
-0002b8c0: 2020 2020 2020 4f75 7470 7574 2066 7261        Output fra
-0002b8d0: 6d65 2064 6566 696e 6974 696f 6e2e 2020  me definition.  
-0002b8e0: 4361 6e20 6265 2061 2057 4353 206f 626a  Can be a WCS obj
-0002b8f0: 6563 742c 2068 6561 6465 722c 206f 7220  ect, header, or 
-0002b900: 4649 5453 2048 4455 2e20 2049 660a 2020  FITS HDU.  If.  
-0002b910: 2020 2020 2020 4e6f 6e65 2c20 7468 656e        None, then
-0002b920: 2067 656e 6572 6174 6573 2061 2057 4353   generates a WCS
-0002b930: 2077 6974 6820 6067 7269 7a6c 692e 7574   with `grizli.ut
-0002b940: 696c 732e 6d61 6b65 5f6d 6178 696d 616c  ils.make_maximal
-0002b950: 5f77 6373 600a 2020 2020 0a20 2020 2070  _wcs`.    .    p
-0002b960: 6978 6672 6163 203a 2066 6c6f 6174 0a20  ixfrac : float. 
-0002b970: 2020 2020 2020 2044 7269 7a7a 6c65 2060         Drizzle `
-0002b980: 7069 7866 7261 6360 0a20 2020 200a 2020  pixfrac`.    .  
-0002b990: 2020 6b65 726e 656c 203a 2073 7472 0a20    kernel : str. 
-0002b9a0: 2020 2020 2020 2044 7269 7a7a 6c65 2060         Drizzle `
-0002b9b0: 6b65 726e 656c 6020 2865 2e67 2e2c 2027  kernel` (e.g., '
-0002b9c0: 706f 696e 7427 2c20 2773 7175 6172 6527  point', 'square'
-0002b9d0: 290a 2020 2020 0a20 2020 2063 6c65 616e  ).    .    clean
-0002b9e0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-0002b9f0: 5265 6d6f 7665 2065 7870 6f73 7572 6520  Remove exposure 
-0002ba00: 6669 6c65 7320 6166 7465 7220 6164 6469  files after addi
-0002ba10: 6e67 2074 6f20 7468 6520 6d6f 7361 6963  ng to the mosaic
-0002ba20: 0a20 2020 200a 2020 2020 696e 636c 7564  .    .    includ
-0002ba30: 655f 7361 7475 7261 7465 6420 3a20 626f  e_saturated : bo
-0002ba40: 6f6c 0a20 2020 2020 2020 2049 6e63 6c75  ol.        Inclu
-0002ba50: 6465 2070 6978 656c 7320 7769 7468 2073  de pixels with s
-0002ba60: 6174 7572 6174 6564 2044 5120 666c 6167  aturated DQ flag
-0002ba70: 0a20 2020 200a 2020 2020 6b65 6570 5f62  .    .    keep_b
-0002ba80: 6974 7320 3a20 696e 742c 204e 6f6e 650a  its : int, None.
-0002ba90: 2020 2020 2020 2020 4578 7472 6120 4451          Extra DQ
-0002baa0: 2062 6974 7320 746f 206b 6565 7020 6173   bits to keep as
-0002bab0: 2076 616c 6964 0a20 2020 200a 2020 2020   valid.    .    
-0002bac0: 6472 7972 756e 203a 2062 6f6f 6c0a 2020  dryrun : bool.  
-0002bad0: 2020 2020 2020 4966 2054 7275 652c 2064        If True, d
-0002bae0: 6f6e 2774 2061 6374 7561 6c6c 7920 7072  on't actually pr
-0002baf0: 6f64 7563 6520 7468 6520 6f75 7470 7574  oduce the output
-0002bb00: 0a20 2020 200a 2020 2020 736b 6970 203a  .    .    skip :
-0002bb10: 2069 6e74 0a20 2020 2020 2020 2053 6c69   int.        Sli
-0002bb20: 6365 2073 6b69 7020 746f 2064 7269 7a7a  ce skip to drizz
-0002bb30: 6c65 2061 2073 7562 7365 7420 6f66 2065  le a subset of e
-0002bb40: 7870 6f73 7572 6573 0a20 2020 200a 2020  xposures.    .  
-0002bb50: 2020 6578 7472 615f 7766 6333 6972 5f62    extra_wfc3ir_b
-0002bb60: 6164 7069 7820 3a20 626f 6f6c 0a20 2020  adpix : bool.   
-0002bb70: 2020 2020 2041 7070 6c79 2065 7874 7261       Apply extra
-0002bb80: 2057 4643 332f 4952 2062 6164 2070 6978   WFC3/IR bad pix
-0002bb90: 2074 6f20 4451 0a20 2020 200a 2020 2020   to DQ.    .    
-0002bba0: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
-0002bbb0: 2020 2020 2020 2053 6f6d 6520 7665 7262         Some verb
-0002bbc0: 6f73 6520 6d65 7373 6167 6520 7072 696e  ose message prin
-0002bbd0: 7469 6e67 0a20 2020 200a 2020 2020 7363  ting.    .    sc
-0002bbe0: 616c 655f 7068 6f74 6f6d 203a 2062 6f6f  ale_photom : boo
-0002bbf0: 6c0a 2020 2020 2020 2020 466f 7220 4a57  l.        For JW
-0002bc00: 5354 2c20 6170 706c 7920 7068 6f74 6f6d  ST, apply photom
-0002bc10: 6574 7279 2073 6361 6c65 2063 6f72 7265  etry scale corre
-0002bc20: 6374 696f 6e73 2066 726f 6d20 7468 6520  ctions from the 
-0002bc30: 200a 2020 2020 2020 2020 6067 7269 7a6c   .        `grizl
-0002bc40: 692f 6461 7461 2f70 686f 746f 6d5f 636f  i/data/photom_co
-0002bc50: 7272 6563 7469 6f6e 2e79 6d6c 6020 7461  rrection.yml` ta
-0002bc60: 626c 650a 2020 2020 0a20 2020 206e 6972  ble.    .    nir
-0002bc70: 6973 735f 6768 6f73 745f 6b77 6172 6773  iss_ghost_kwargs
-0002bc80: 203a 2064 6963 740a 2020 2020 2020 2020   : dict.        
-0002bc90: 4b65 7977 6f72 6420 6172 6775 6d65 6e74  Keyword argument
-0002bca0: 7320 666f 7220 607e 6772 697a 6c69 2e75  s for `~grizli.u
-0002bcb0: 7469 6c73 2e6e 6972 6973 735f 6768 6f73  tils.niriss_ghos
-0002bcc0: 745f 6d61 736b 600a 2020 2020 0a20 2020  t_mask`.    .   
-0002bcd0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-0002bce0: 2d2d 2d2d 0a20 2020 206f 7574 7363 6920  ----.    outsci 
-0002bcf0: 3a20 6172 7261 792d 6c69 6b65 0a20 2020  : array-like.   
-0002bd00: 2020 2020 2053 4349 2061 7272 6179 0a20       SCI array. 
-0002bd10: 2020 200a 2020 2020 6f75 7477 6874 203a     .    outwht :
-0002bd20: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
-0002bd30: 2020 2020 496e 7665 7273 6520 7661 7269      Inverse vari
-0002bd40: 616e 6365 2057 4854 2061 7272 6179 0a20  ance WHT array. 
-0002bd50: 2020 200a 2020 2020 6865 6164 6572 203a     .    header :
-0002bd60: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
-0002bd70: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
-0002bd80: 2020 2049 6d61 6765 2068 6561 6465 720a     Image header.
-0002bd90: 2020 2020 0a20 2020 2066 6c69 7374 203a      .    flist :
-0002bda0: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
-0002bdb0: 7374 206f 6620 6669 6c65 7320 7468 6174  st of files that
-0002bdc0: 2077 6572 6520 6472 697a 7a6c 6564 2074   were drizzled t
-0002bdd0: 6f20 7468 6520 6d6f 7361 6963 0a20 2020  o the mosaic.   
-0002bde0: 2020 2020 200a 2020 2020 7763 735f 7461       .    wcs_ta
-0002bdf0: 6220 3a20 607e 6173 7472 6f70 792e 7461  b : `~astropy.ta
-0002be00: 626c 652e 5461 626c 6560 0a20 2020 2020  ble.Table`.     
-0002be10: 2020 2054 6162 6c65 206f 6620 5743 5320     Table of WCS 
-0002be20: 7061 7261 6d65 7465 7273 206f 6620 696e  parameters of in
-0002be30: 6469 7669 6475 616c 2065 7870 6f73 7572  dividual exposur
-0002be40: 6573 0a20 2020 200a 2020 2020 2222 220a  es.    .    """.
-0002be50: 2020 2020 6672 6f6d 2073 6861 7065 6c79      from shapely
-0002be60: 2e67 656f 6d65 7472 7920 696d 706f 7274  .geometry import
-0002be70: 2050 6f6c 7967 6f6e 0a20 2020 2069 6d70   Polygon.    imp
-0002be80: 6f72 7420 626f 746f 330a 2020 2020 6672  ort boto3.    fr
-0002be90: 6f6d 2062 6f74 6f63 6f72 652e 6578 6365  om botocore.exce
-0002bea0: 7074 696f 6e73 2069 6d70 6f72 7420 436c  ptions import Cl
-0002beb0: 6965 6e74 4572 726f 720a 2020 2020 696d  ientError.    im
-0002bec0: 706f 7274 2073 6369 7079 2e6e 6469 6d61  port scipy.ndima
-0002bed0: 6765 2061 7320 6e64 0a20 2020 2066 726f  ge as nd.    fro
-0002bee0: 6d20 6173 7472 6f70 792e 696f 2e66 6974  m astropy.io.fit
-0002bef0: 7320 696d 706f 7274 2050 7269 6d61 7279  s import Primary
-0002bf00: 4844 552c 2049 6d61 6765 4844 550a 2020  HDU, ImageHDU.  
-0002bf10: 2020 6672 6f6d 202e 7665 7273 696f 6e20    from .version 
-0002bf20: 696d 706f 7274 205f 5f76 6572 7369 6f6e  import __version
-0002bf30: 5f5f 2061 7320 6772 697a 6c69 5f5f 7665  __ as grizli__ve
-0002bf40: 7273 696f 6e0a 2020 2020 0a20 2020 2062  rsion.    .    b
-0002bf50: 7563 6b65 745f 6e61 6d65 203d 204e 6f6e  ucket_name = Non
-0002bf60: 650a 2020 2020 7333 203d 2062 6f74 6f33  e.    s3 = boto3
-0002bf70: 2e72 6573 6f75 7263 6528 2773 3327 290a  .resource('s3').
-0002bf80: 2020 2020 7333 5f63 6c69 656e 7420 3d20      s3_client = 
-0002bf90: 626f 746f 332e 636c 6965 6e74 2827 7333  boto3.client('s3
-0002bfa0: 2729 0a20 2020 200a 2020 2020 0a20 2020  ').    .    .   
-0002bfb0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-0002bfc0: 7574 7075 742c 2070 7977 6373 2e57 4353  utput, pywcs.WCS
-0002bfd0: 293a 0a20 2020 2020 2020 206f 7574 7075  ):.        outpu
-0002bfe0: 7477 6373 203d 206f 7574 7075 740a 2020  twcs = output.  
-0002bff0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0002c000: 6528 6f75 7470 7574 2c20 7079 6669 7473  e(output, pyfits
-0002c010: 2e48 6561 6465 7229 3a0a 2020 2020 2020  .Header):.      
-0002c020: 2020 6f75 7470 7574 7763 7320 3d20 7079    outputwcs = py
-0002c030: 7763 732e 5743 5328 6f75 7470 7574 290a  wcs.WCS(output).
-0002c040: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0002c050: 6e63 6528 6f75 7470 7574 2c20 5072 696d  nce(output, Prim
-0002c060: 6172 7948 4455 2920 7c20 6973 696e 7374  aryHDU) | isinst
-0002c070: 616e 6365 286f 7574 7075 742c 2049 6d61  ance(output, Ima
-0002c080: 6765 4844 5529 3a0a 2020 2020 2020 2020  geHDU):.        
-0002c090: 6f75 7470 7574 7763 7320 3d20 7079 7763  outputwcs = pywc
-0002c0a0: 732e 5743 5328 6f75 7470 7574 2e68 6561  s.WCS(output.hea
-0002c0b0: 6465 7229 0a20 2020 2065 6c69 6620 6f75  der).    elif ou
-0002c0c0: 7470 7574 2069 7320 4e6f 6e65 3a0a 2020  tput is None:.  
-0002c0d0: 2020 2020 2020 5f68 6475 203d 206d 616b        _hdu = mak
-0002c0e0: 655f 6d61 7869 6d61 6c5f 7763 7328 6669  e_maximal_wcs(fi
-0002c0f0: 6c65 733d 7669 7369 745b 2766 696c 6573  les=visit['files
-0002c100: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0002c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c120: 2020 2020 7069 7865 6c5f 7363 616c 653d      pixel_scale=
-0002c130: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c150: 2020 2020 2020 6765 745f 6864 753d 5472        get_hdu=Tr
-0002c160: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0002c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c180: 2020 2020 7665 7262 6f73 653d 4661 6c73      verbose=Fals
-0002c190: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1b0: 2020 2070 6164 3d34 290a 2020 2020 2020     pad=4).      
-0002c1c0: 2020 6f75 7470 7574 7763 7320 3d20 7079    outputwcs = py
-0002c1d0: 7763 732e 5743 5328 5f68 6475 2e68 6561  wcs.WCS(_hdu.hea
-0002c1e0: 6465 7229 0a20 2020 2065 6c73 653a 0a20  der).    else:. 
-0002c1f0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0002c200: 6e65 0a0a 2020 2020 6966 206e 6f74 2068  ne..    if not h
-0002c210: 6173 6174 7472 286f 7574 7075 7477 6373  asattr(outputwcs
-0002c220: 2c20 275f 6e61 7869 7331 2729 3a0a 2020  , '_naxis1'):.  
-0002c230: 2020 2020 2020 6f75 7470 7574 7763 732e        outputwcs.
-0002c240: 5f6e 6178 6973 312c 206f 7574 7075 7477  _naxis1, outputw
-0002c250: 6373 2e5f 6e61 7869 7332 203d 206f 7574  cs._naxis2 = out
-0002c260: 7075 7477 6373 2e5f 6e61 7869 730a 0a20  putwcs._naxis.. 
-0002c270: 2020 206f 7574 7075 7477 6373 2e70 7363     outputwcs.psc
-0002c280: 616c 6520 3d20 6765 745f 7763 735f 7073  ale = get_wcs_ps
-0002c290: 6361 6c65 286f 7574 7075 7477 6373 290a  cale(outputwcs).
-0002c2a0: 0a20 2020 206f 7574 7075 745f 706f 6c79  .    output_poly
-0002c2b0: 203d 2050 6f6c 7967 6f6e 286f 7574 7075   = Polygon(outpu
-0002c2c0: 7477 6373 2e63 616c 635f 666f 6f74 7072  twcs.calc_footpr
-0002c2d0: 696e 7428 2929 0a20 2020 2063 6f75 6e74  int()).    count
-0002c2e0: 203d 2030 0a0a 2020 2020 7265 665f 7068   = 0..    ref_ph
-0002c2f0: 6f74 666c 616d 203d 204e 6f6e 650a 2020  otflam = None.  
-0002c300: 2020 0a20 2020 2069 6e64 6963 6573 203d    .    indices =
-0002c310: 205b 5d0a 2020 2020 666f 7220 6920 696e   [].    for i in
-0002c320: 2072 616e 6765 286c 656e 2876 6973 6974   range(len(visit
-0002c330: 5b27 6669 6c65 7327 5d29 293a 0a20 2020  ['files'])):.   
-0002c340: 2020 2020 2069 6620 2766 6f6f 7470 7269       if 'footpri
-0002c350: 6e74 7327 2069 6e20 7669 7369 743a 0a20  nts' in visit:. 
-0002c360: 2020 2020 2020 2020 2020 206f 6c61 7020             olap 
-0002c370: 3d20 7669 7369 745b 2766 6f6f 7470 7269  = visit['footpri
-0002c380: 6e74 7327 5d5b 695d 2e69 6e74 6572 7365  nts'][i].interse
-0002c390: 6374 696f 6e28 6f75 7470 7574 5f70 6f6c  ction(output_pol
-0002c3a0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-0002c3b0: 6620 6f6c 6170 2e61 7265 6120 3e20 303a  f olap.area > 0:
-0002c3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c3d0: 2069 6e64 6963 6573 2e61 7070 656e 6428   indices.append(
-0002c3e0: 6929 0a20 2020 2020 2020 2065 6c73 653a  i).        else:
-0002c3f0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-0002c400: 6963 6573 2e61 7070 656e 6428 6929 0a0a  ices.append(i)..
-0002c410: 2020 2020 6966 2073 6b69 7020 6973 206e      if skip is n
-0002c420: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0002c430: 2069 6e64 6963 6573 203d 2069 6e64 6963   indices = indic
-0002c440: 6573 5b3a 3a73 6b69 705d 0a0a 2020 2020  es[::skip]..    
-0002c450: 4e54 4f54 414c 203d 206c 656e 2869 6e64  NTOTAL = len(ind
-0002c460: 6963 6573 290a 2020 2020 0a20 2020 2077  ices).    .    w
-0002c470: 6373 5f72 6f77 7320 3d20 5b5d 0a20 2020  cs_rows = [].   
-0002c480: 2077 6373 5f63 6f6c 6e61 6d65 7320 3d20   wcs_colnames = 
-0002c490: 4e6f 6e65 0a20 2020 2077 6373 5f6b 6579  None.    wcs_key
-0002c4a0: 7320 3d20 7b7d 0a20 2020 200a 2020 2020  s = {}.    .    
-0002c4b0: 6270 6461 7461 203d 2030 0a20 2020 200a  bpdata = 0.    .
-0002c4c0: 2020 2020 666f 7220 6920 696e 2069 6e64      for i in ind
-0002c4d0: 6963 6573 3a0a 0a20 2020 2020 2020 2066  ices:..        f
-0002c4e0: 696c 6520 3d20 7669 7369 745b 2766 696c  ile = visit['fil
-0002c4f0: 6573 275d 5b69 5d0a 0a20 2020 2020 2020  es'][i]..       
-0002c500: 206d 7367 203d 2027 5c6e 287b 303a 3464   msg = '\n({0:4d
-0002c510: 7d2f 7b31 3a34 647d 2920 4164 6420 6578  }/{1:4d}) Add ex
-0002c520: 706f 7375 7265 207b 327d 5c6e 270a 2020  posure {2}\n'.  
-0002c530: 2020 2020 2020 6d73 6720 3d20 6d73 672e        msg = msg.
-0002c540: 666f 726d 6174 2863 6f75 6e74 2b31 2c20  format(count+1, 
-0002c550: 4e54 4f54 414c 2c20 6669 6c65 290a 2020  NTOTAL, file).  
-0002c560: 2020 2020 2020 6c6f 675f 636f 6d6d 656e        log_commen
-0002c570: 7428 4c4f 4746 494c 452c 206d 7367 2c20  t(LOGFILE, msg, 
-0002c580: 7665 7262 6f73 653d 7665 7262 6f73 6529  verbose=verbose)
-0002c590: 0a0a 2020 2020 2020 2020 6966 2064 7279  ..        if dry
-0002c5a0: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
-0002c5b0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0002c5c0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
-0002c5d0: 682e 6578 6973 7473 2866 696c 6529 3a0a  h.exists(file):.
-0002c5e0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-0002c5f0: 6574 5f69 203d 2076 6973 6974 5b27 6177  et_i = visit['aw
-0002c600: 7370 6174 6827 5d5b 695d 2e73 706c 6974  spath'][i].split
-0002c610: 2827 2f27 295b 305d 0a20 2020 2020 2020  ('/')[0].       
-0002c620: 2020 2020 2069 6620 6275 636b 6574 5f6e       if bucket_n
-0002c630: 616d 6520 213d 2062 7563 6b65 745f 693a  ame != bucket_i:
-0002c640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c650: 2062 7563 6b65 745f 6e61 6d65 203d 2062   bucket_name = b
-0002c660: 7563 6b65 745f 690a 2020 2020 2020 2020  ucket_i.        
-0002c670: 2020 2020 2020 2020 626b 7420 3d20 7333          bkt = s3
-0002c680: 2e42 7563 6b65 7428 6275 636b 6574 5f6e  .Bucket(bucket_n
-0002c690: 616d 6529 0a0a 2020 2020 2020 2020 2020  ame)..          
-0002c6a0: 2020 7333 5f70 6174 6820 3d20 272f 272e    s3_path = '/'.
-0002c6b0: 6a6f 696e 2876 6973 6974 5b27 6177 7370  join(visit['awsp
-0002c6c0: 6174 6827 5d5b 695d 2e73 706c 6974 2827  ath'][i].split('
-0002c6d0: 2f27 295b 313a 5d29 0a20 2020 2020 2020  /')[1:]).       
-0002c6e0: 2020 2020 2072 656d 6f74 655f 6669 6c65       remote_file
-0002c6f0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0002c700: 7333 5f70 6174 682c 2066 696c 6529 0a0a  s3_path, file)..
-0002c710: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002c720: 7428 2720 2028 6665 7463 6820 6672 6f6d  t('  (fetch from
-0002c730: 2073 333a 2f2f 7b30 7d2f 7b31 7d29 272e   s3://{0}/{1})'.
-0002c740: 666f 726d 6174 2862 7563 6b65 745f 692c  format(bucket_i,
-0002c750: 2072 656d 6f74 655f 6669 6c65 2929 0a0a   remote_file))..
-0002c760: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0002c770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c780: 2062 6b74 2e64 6f77 6e6c 6f61 645f 6669   bkt.download_fi
-0002c790: 6c65 2872 656d 6f74 655f 6669 6c65 2c20  le(remote_file, 
-0002c7a0: 6669 6c65 2c0a 2020 2020 2020 2020 2020  file,.          
-0002c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c7c0: 2020 2020 4578 7472 6141 7267 733d 7b22      ExtraArgs={"
-0002c7d0: 5265 7175 6573 7450 6179 6572 223a 2022  RequestPayer": "
-0002c7e0: 7265 7175 6573 7465 7222 7d29 0a20 2020  requester"}).   
-0002c7f0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0002c800: 436c 6965 6e74 4572 726f 723a 0a20 2020  ClientError:.   
-0002c810: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0002c820: 6e74 2827 2020 2866 6169 6c65 6420 7333  nt('  (failed s3
-0002c830: 3a2f 2f7b 307d 2f7b 317d 2927 2e66 6f72  ://{0}/{1})'.for
-0002c840: 6d61 7428 6275 636b 6574 5f69 2c20 7265  mat(bucket_i, re
-0002c850: 6d6f 7465 5f66 696c 6529 290a 2020 2020  mote_file)).    
-0002c860: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0002c870: 696e 7565 0a0a 2020 2020 2020 2020 7472  inue..        tr
-0002c880: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
-0002c890: 6c74 203d 2070 7966 6974 732e 6f70 656e  lt = pyfits.open
-0002c8a0: 2866 696c 6529 0a20 2020 2020 2020 2065  (file).        e
-0002c8b0: 7863 6570 7420 4f53 4572 726f 723a 0a20  xcept OSError:. 
-0002c8c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0002c8d0: 2866 276f 7065 6e28 7b66 696c 657d 2920  (f'open({file}) 
-0002c8e0: 6661 696c 6564 2127 290a 2020 2020 2020  failed!').      
-0002c8f0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0002c900: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0002c910: 2020 2020 7363 695f 6c69 7374 2c20 7768      sci_list, wh
-0002c920: 745f 6c69 7374 2c20 7763 735f 6c69 7374  t_list, wcs_list
-0002c930: 203d 205b 5d2c 205b 5d2c 205b 5d0a 2020   = [], [], [].  
-0002c940: 2020 2020 2020 0a20 2020 2020 2020 206b        .        k
-0002c950: 6579 7320 3d20 4f72 6465 7265 6444 6963  eys = OrderedDic
-0002c960: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-0002c970: 6b20 696e 205b 2745 5850 5449 4d45 272c  k in ['EXPTIME',
-0002c980: 2027 5445 4c45 5343 4f50 272c 2027 4649   'TELESCOP', 'FI
-0002c990: 4c54 4552 272c 2746 494c 5445 5231 272c  LTER','FILTER1',
-0002c9a0: 2027 4649 4c54 4552 3227 2c20 0a20 2020   'FILTER2', .   
-0002c9b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002c9c0: 5055 5049 4c27 2c20 2744 4554 4543 544f  PUPIL', 'DETECTO
-0002c9d0: 5227 2c20 2749 4e53 5452 554d 4527 2c20  R', 'INSTRUME', 
-0002c9e0: 2750 484f 5446 4c41 4d27 2c20 2750 484f  'PHOTFLAM', 'PHO
-0002c9f0: 5450 4c41 4d27 2c20 0a20 2020 2020 2020  TPLAM', .       
-0002ca00: 2020 2020 2020 2020 2020 2027 5048 4f54             'PHOT
-0002ca10: 464e 5527 2c20 2750 484f 545a 5054 272c  FNU', 'PHOTZPT',
-0002ca20: 2027 5048 4f54 4257 272c 2027 5048 4f54   'PHOTBW', 'PHOT
-0002ca30: 4d4f 4445 272c 2027 4558 5053 5441 5254  MODE', 'EXPSTART
-0002ca40: 272c 200a 2020 2020 2020 2020 2020 2020  ', .            
-0002ca50: 2020 2020 2020 2745 5850 454e 4427 2c20        'EXPEND', 
-0002ca60: 2744 4154 452d 4f42 5327 2c20 2754 494d  'DATE-OBS', 'TIM
-0002ca70: 452d 4f42 5327 2c0a 2020 2020 2020 2020  E-OBS',.        
-0002ca80: 2020 2020 2020 2020 2020 2755 5044 415f            'UPDA_
-0002ca90: 4354 5827 2c20 2743 5244 535f 4354 5827  CTX', 'CRDS_CTX'
-0002caa0: 2c20 2752 5f44 4953 544f 5227 2c20 2752  , 'R_DISTOR', 'R
-0002cab0: 5f50 484f 544f 4d27 2c20 2752 5f46 4c41  _PHOTOM', 'R_FLA
-0002cac0: 5427 5d3a 0a20 2020 2020 2020 2020 2020  T']:.           
-0002cad0: 2069 6620 6b20 696e 2066 6c74 5b30 5d2e   if k in flt[0].
-0002cae0: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
-0002caf0: 2020 2020 2020 2020 6b65 7973 5b6b 5d20          keys[k] 
-0002cb00: 3d20 666c 745b 305d 2e68 6561 6465 725b  = flt[0].header[
-0002cb10: 6b5d 0a20 2020 2020 2020 200a 2020 2020  k].        .    
-0002cb20: 2020 2020 6966 2066 6c74 5b30 5d2e 6865      if flt[0].he
-0002cb30: 6164 6572 5b27 5445 4c45 5343 4f50 275d  ader['TELESCOP']
-0002cb40: 2069 6e20 5b27 4a57 5354 275d 3a0a 2020   in ['JWST']:.  
-0002cb50: 2020 2020 2020 2020 2020 6269 7473 203d            bits =
-0002cb60: 2034 0a20 2020 2020 2020 2020 2020 2069   4.            i
-0002cb70: 6e63 6c75 6465 5f73 6174 7572 6174 6564  nclude_saturated
-0002cb80: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0002cb90: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0002cba0: 2020 2362 7064 6174 6120 3d20 300a 2020    #bpdata = 0.  
-0002cbb0: 2020 2020 2020 2020 2020 5f69 6e73 7420            _inst 
-0002cbc0: 3d20 666c 745b 305d 2e68 6561 6465 725b  = flt[0].header[
-0002cbd0: 2749 4e53 5452 554d 4527 5d0a 2020 2020  'INSTRUME'].    
-0002cbe0: 2020 2020 2020 2020 6966 2028 6578 7472          if (extr
-0002cbf0: 615f 7766 6333 6972 5f62 6164 7069 7829  a_wfc3ir_badpix)
-0002cc00: 2026 2028 5f69 6e73 7420 696e 205b 274e   & (_inst in ['N
-0002cc10: 4952 4341 4d27 5d29 3a0a 2020 2020 2020  IRCAM']):.      
-0002cc20: 2020 2020 2020 2020 2020 5f64 6574 203d            _det =
-0002cc30: 2066 6c74 5b30 5d2e 6865 6164 6572 5b27   flt[0].header['
-0002cc40: 4445 5445 4354 4f52 275d 0a20 2020 2020  DETECTOR'].     
-0002cc50: 2020 2020 2020 2020 2020 2062 7066 696c             bpfil
-0002cc60: 6573 203d 205b 6f73 2e70 6174 682e 6a6f  es = [os.path.jo
-0002cc70: 696e 286f 732e 7061 7468 2e64 6972 6e61  in(os.path.dirna
-0002cc80: 6d65 285f 5f66 696c 655f 5f29 2c20 0a20  me(__file__), . 
-0002cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cca0: 2020 2020 2020 2020 2020 6627 6461 7461            f'data
-0002ccb0: 2f6e 7263 5f62 6164 7069 785f 3233 3031  /nrc_badpix_2301
-0002ccc0: 3230 5f7b 5f64 6574 7d2e 6669 7473 2e67  20_{_det}.fits.g
-0002ccd0: 7a27 295d 0a20 2020 2020 2020 2020 2020  z')].           
-0002cce0: 2020 2020 2062 7066 696c 6573 202b 3d20       bpfiles += 
-0002ccf0: 5b6f 732e 7061 7468 2e6a 6f69 6e28 6f73  [os.path.join(os
-0002cd00: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
-0002cd10: 6669 6c65 5f5f 292c 200a 2020 2020 2020  file__), .      
-0002cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd30: 2020 2020 2066 2764 6174 612f 6e72 635f       f'data/nrc_
-0002cd40: 6c6f 7770 6978 5f30 3931 365f 7b5f 6465  lowpix_0916_{_de
-0002cd50: 747d 2e66 6974 732e 677a 2729 5d0a 2020  t}.fits.gz')].  
-0002cd60: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-0002cd70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002cd80: 6f72 2062 7066 696c 6520 696e 2062 7066  or bpfile in bpf
-0002cd90: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
-0002cda0: 2020 2020 2020 2020 2020 6966 206f 732e            if os.
-0002cdb0: 7061 7468 2e65 7869 7374 7328 6270 6669  path.exists(bpfi
-0002cdc0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
-0002cdd0: 2020 2020 2020 2020 2020 2020 2062 7064               bpd
-0002cde0: 6174 6120 3d20 7079 6669 7473 2e6f 7065  ata = pyfits.ope
-0002cdf0: 6e28 6270 6669 6c65 295b 305d 2e64 6174  n(bpfile)[0].dat
-0002ce00: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-0002ce10: 2020 2020 2020 2020 2020 6270 6461 7461            bpdata
-0002ce20: 203d 206e 642e 6269 6e61 7279 5f64 696c   = nd.binary_dil
-0002ce30: 6174 696f 6e28 6270 6461 7461 203e 2030  ation(bpdata > 0
-0002ce40: 292a 3130 3234 0a20 2020 2020 2020 2020  )*1024.         
-0002ce50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002ce60: 7367 203d 2066 2755 7365 2065 7874 7261  sg = f'Use extra
-0002ce70: 2062 6164 7069 7820 696e 207b 6270 6669   badpix in {bpfi
-0002ce80: 6c65 7d27 0a20 2020 2020 2020 2020 2020  le}'.           
-0002ce90: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0002cea0: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
-0002ceb0: 2c20 6d73 672c 2076 6572 626f 7365 3d76  , msg, verbose=v
-0002cec0: 6572 626f 7365 290a 2020 2020 2020 2020  erbose).        
-0002ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cee0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-0002cef0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002cf00: 2020 2020 2020 2020 6270 6461 7461 203d          bpdata =
-0002cf10: 206e 702e 7a65 726f 7328 666c 745b 2753   np.zeros(flt['S
-0002cf20: 4349 275d 2e64 6174 612e 7368 6170 652c  CI'].data.shape,
-0002cf30: 2064 7479 7065 3d69 6e74 290a 2020 2020   dtype=int).    
-0002cf40: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0002cf50: 2020 2020 2020 2020 2023 204e 4952 4953           # NIRIS
-0002cf60: 5320 6768 6f73 7420 6d61 736b 0a20 2020  S ghost mask.   
-0002cf70: 2020 2020 2020 2020 2069 6620 285f 696e           if (_in
-0002cf80: 7374 2069 6e20 5b27 4e49 5249 5353 275d  st in ['NIRISS']
-0002cf90: 2920 2620 286e 6972 6973 735f 6768 6f73  ) & (niriss_ghos
-0002cfa0: 745f 6b77 6172 6773 2069 7320 6e6f 7420  t_kwargs is not 
-0002cfb0: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-0002cfc0: 2020 2020 2020 2069 6620 2776 6572 626f         if 'verbo
-0002cfd0: 7365 2720 6e6f 7420 696e 206e 6972 6973  se' not in niris
-0002cfe0: 735f 6768 6f73 745f 6b77 6172 6773 3a0a  s_ghost_kwargs:.
-0002cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d000: 2020 2020 6e69 7269 7373 5f67 686f 7374      niriss_ghost
-0002d010: 5f6b 7761 7267 735b 2776 6572 626f 7365  _kwargs['verbose
-0002d020: 275d 203d 2076 6572 626f 7365 0a20 2020  '] = verbose.   
-0002d030: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0002d040: 2020 2020 2020 2020 2020 2020 2020 5f67                _g
-0002d050: 686f 7374 203d 206e 6972 6973 735f 6768  host = niriss_gh
-0002d060: 6f73 745f 6d61 736b 2866 6c74 2c20 2a2a  ost_mask(flt, **
-0002d070: 6e69 7269 7373 5f67 686f 7374 5f6b 7761  niriss_ghost_kwa
-0002d080: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-0002d090: 2020 2020 2062 7064 6174 6120 7c3d 205f       bpdata |= _
-0002d0a0: 6768 6f73 742a 3130 3234 0a20 2020 2020  ghost*1024.     
-0002d0b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002d0c0: 2020 2020 2320 4e65 6761 7469 7665 0a20      # Negative. 
-0002d0d0: 2020 2020 2020 2020 2020 2069 6620 274d             if 'M
-0002d0e0: 4452 495a 534b 5927 2069 6e20 666c 745b  DRIZSKY' in flt[
-0002d0f0: 2753 4349 275d 2e68 6561 6465 723a 0a20  'SCI'].header:. 
-0002d100: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0002d110: 6c6f 7720 3d20 2828 666c 745b 2753 4349  low = ((flt['SCI
-0002d120: 275d 2e64 6174 6120 2d20 666c 745b 2753  '].data - flt['S
-0002d130: 4349 275d 2e68 6561 6465 725b 274d 4452  CI'].header['MDR
-0002d140: 495a 534b 5927 5d29 203c 200a 2020 2020  IZSKY']) < .    
-0002d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d160: 2020 2d35 2a66 6c74 5b27 4552 5227 5d2e    -5*flt['ERR'].
-0002d170: 6461 7461 290a 2020 2020 2020 2020 2020  data).          
-0002d180: 2020 2020 2020 6d73 6720 3d20 6627 4578        msg = f'Ex
-0002d190: 7472 6120 2d35 2073 6967 6d61 206c 6f77  tra -5 sigma low
-0002d1a0: 2070 6978 656c 733a 204e 3d20 7b5f 6c6f   pixels: N= {_lo
-0002d1b0: 772e 7375 6d28 297d 2027 0a20 2020 2020  w.sum()} '.     
-0002d1c0: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
-0002d1d0: 3d20 6627 2028 207b 5f6c 6f77 2e73 756d  = f' ( {_low.sum
-0002d1e0: 2829 2f5f 6c6f 772e 7369 7a65 2a31 3030  ()/_low.size*100
-0002d1f0: 3a2e 317d 2025 2927 0a20 2020 2020 2020  :.1} %)'.       
-0002d200: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
-0002d210: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
-0002d220: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
-0002d230: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-0002d240: 2020 2020 6270 6461 7461 207c 3d20 5f6c      bpdata |= _l
-0002d250: 6f77 2a31 3032 340a 2020 2020 2020 2020  ow*1024.        
-0002d260: 2020 2020 0a20 2020 2020 2020 2065 6c69      .        eli
-0002d270: 6620 666c 745b 305d 2e68 6561 6465 725b  f flt[0].header[
-0002d280: 2744 4554 4543 544f 5227 5d20 3d3d 2027  'DETECTOR'] == '
-0002d290: 4952 273a 0a20 2020 2020 2020 2020 2020  IR':.           
-0002d2a0: 2062 6974 7320 3d20 3537 360a 2020 2020   bits = 576.    
-0002d2b0: 2020 2020 2020 2020 6966 2065 7874 7261          if extra
-0002d2c0: 5f77 6663 3369 725f 6261 6470 6978 3a0a  _wfc3ir_badpix:.
-0002d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2e0: 6966 2028 6920 3d3d 2069 6e64 6963 6573  if (i == indices
-0002d2f0: 5b30 5d29 207c 2028 6e6f 7420 6861 7361  [0]) | (not hasa
-0002d300: 7474 7228 6270 6461 7461 2c20 2773 6861  ttr(bpdata, 'sha
-0002d310: 7065 2729 293a 0a20 2020 2020 2020 2020  pe')):.         
-0002d320: 2020 2020 2020 2020 2020 2062 7066 696c             bpfil
-0002d330: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
-0002d340: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
-0002d350: 285f 5f66 696c 655f 5f29 2c20 0a20 2020  (__file__), .   
-0002d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d370: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
-0002d380: 612f 7766 6333 6972 5f62 6164 7069 785f  a/wfc3ir_badpix_
-0002d390: 7370 6172 7332 3030 5f32 322e 3033 2e33  spars200_22.03.3
-0002d3a0: 312e 6669 7473 2e67 7a27 290a 2020 2020  1.fits.gz').    
+00027790: 2020 2020 2020 3120 2f20 6e75 6d62 6572        1 / number
+000277a0: 206f 6620 6772 6f75 7073 0a20 2020 2020   of groups.     
+000277b0: 2020 2043 5250 4958 3120 203d 2020 2020     CRPIX1  =    
+000277c0: 2020 2020 2020 2020 2020 2020 2020 2031                 1
+000277d0: 300a 2020 2020 2020 2020 4352 5049 5832  0.        CRPIX2
+000277e0: 2020 3d20 2020 2020 2020 2020 2020 2020    =             
+000277f0: 2020 2020 2020 3130 0a20 2020 2020 2020        10.       
+00027800: 2043 5256 414c 3120 203d 2020 2020 2020   CRVAL1  =      
+00027810: 2020 2020 2020 2034 302e 3037 3239 330a         40.07293.
+00027820: 2020 2020 2020 2020 4352 5641 4c32 2020          CRVAL2  
+00027830: 3d20 2020 2020 2020 2020 2020 2d31 2e36  =           -1.6
+00027840: 3133 3737 3438 0a20 2020 2020 2020 2043  137748.        C
+00027850: 4431 5f31 2020 203d 202d 322e 3737 3737  D1_1   = -2.7777
+00027860: 3737 3737 3737 3737 3745 2d30 350a 2020  777777777E-05.  
+00027870: 2020 2020 2020 4344 315f 3220 2020 3d20        CD1_2   = 
+00027880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027890: 2030 2e30 0a20 2020 2020 2020 2043 4432   0.0.        CD2
+000278a0: 5f31 2020 203d 2020 2020 2020 2020 2020  _1   =          
+000278b0: 2020 2020 2020 2020 302e 300a 2020 2020          0.0.    
+000278c0: 2020 2020 4344 325f 3220 2020 3d20 322e      CD2_2   = 2.
+000278d0: 3737 3737 3737 3737 3737 3737 3737 452d  77777777777777E-
+000278e0: 3035 0a20 2020 2020 2020 204e 4158 4953  05.        NAXIS
+000278f0: 3120 203d 2020 2020 2020 2020 2020 2020  1  =            
+00027900: 2020 2020 2020 2032 300a 2020 2020 2020         20.      
+00027910: 2020 4e41 5849 5332 2020 3d20 2020 2020    NAXIS2  =     
+00027920: 2020 2020 2020 2020 2020 2020 2020 3230                20
+00027930: 0a20 2020 2020 2020 2043 5459 5045 3120  .        CTYPE1 
+00027940: 203d 2027 5241 2d2d 2d54 414e 270a 2020   = 'RA---TAN'.  
+00027950: 2020 2020 2020 4354 5950 4532 2020 3d20        CTYPE2  = 
+00027960: 2744 4543 2d2d 5441 4e27 0a20 2020 2022  'DEC--TAN'.    "
+00027970: 2222 0a0a 2020 2020 6966 206e 702e 6973  ""..    if np.is
+00027980: 7363 616c 6172 2870 6978 7363 616c 6529  scalar(pixscale)
+00027990: 3a0a 2020 2020 2020 2020 6364 656c 7420  :.        cdelt 
+000279a0: 3d20 5b70 6978 7363 616c 652f 3336 3030  = [pixscale/3600
+000279b0: 2e5d 2a32 0a20 2020 2065 6c73 653a 0a20  .]*2.    else:. 
+000279c0: 2020 2020 2020 2063 6465 6c74 203d 205b         cdelt = [
+000279d0: 7069 7873 6361 6c65 5b30 5d2f 3336 3030  pixscale[0]/3600
+000279e0: 2e2c 2070 6978 7363 616c 655b 315d 2f33  ., pixscale[1]/3
+000279f0: 3630 302e 5d0a 0a20 2020 2069 6620 6e70  600.]..    if np
+00027a00: 2e69 7373 6361 6c61 7228 7369 7a65 293a  .isscalar(size):
+00027a10: 0a20 2020 2020 2020 206e 7069 7820 3d20  .        npix = 
+00027a20: 6e70 2e63 6173 745b 696e 745d 286e 702e  np.cast[int](np.
+00027a30: 726f 756e 6428 5b73 697a 652f 7069 7873  round([size/pixs
+00027a40: 6361 6c65 2c20 7369 7a65 2f70 6978 7363  cale, size/pixsc
+00027a50: 616c 655d 2929 0a20 2020 2065 6c73 653a  ale])).    else:
+00027a60: 0a20 2020 2020 2020 206e 7069 7820 3d20  .        npix = 
+00027a70: 6e70 2e63 6173 745b 696e 745d 286e 702e  np.cast[int](np.
+00027a80: 726f 756e 6428 5b73 697a 655b 305d 2f70  round([size[0]/p
+00027a90: 6978 7363 616c 652c 2073 697a 655b 315d  ixscale, size[1]
+00027aa0: 2f70 6978 7363 616c 655d 2929 0a0a 2020  /pixscale]))..  
+00027ab0: 2020 686f 7574 203d 2070 7966 6974 732e    hout = pyfits.
+00027ac0: 4865 6164 6572 2829 0a20 2020 2068 6f75  Header().    hou
+00027ad0: 745b 2743 5250 4958 3127 5d20 3d20 286e  t['CRPIX1'] = (n
+00027ae0: 7069 785b 305d 2d31 292f 322b 310a 2020  pix[0]-1)/2+1.  
+00027af0: 2020 686f 7574 5b27 4352 5049 5832 275d    hout['CRPIX2']
+00027b00: 203d 2028 6e70 6978 5b31 5d2d 3129 2f32   = (npix[1]-1)/2
+00027b10: 2b31 0a20 2020 2068 6f75 745b 2743 5256  +1.    hout['CRV
+00027b20: 414c 3127 5d20 3d20 7261 0a20 2020 2068  AL1'] = ra.    h
+00027b30: 6f75 745b 2743 5256 414c 3227 5d20 3d20  out['CRVAL2'] = 
+00027b40: 6465 630a 2020 2020 686f 7574 5b27 4344  dec.    hout['CD
+00027b50: 315f 3127 5d20 3d20 2d63 6465 6c74 5b30  1_1'] = -cdelt[0
+00027b60: 5d0a 2020 2020 686f 7574 5b27 4344 315f  ].    hout['CD1_
+00027b70: 3227 5d20 3d20 686f 7574 5b27 4344 325f  2'] = hout['CD2_
+00027b80: 3127 5d20 3d20 302e 0a20 2020 2068 6f75  1'] = 0..    hou
+00027b90: 745b 2743 4432 5f32 275d 203d 2063 6465  t['CD2_2'] = cde
+00027ba0: 6c74 5b31 5d0a 2020 2020 686f 7574 5b27  lt[1].    hout['
+00027bb0: 4e41 5849 5331 275d 203d 206e 7069 785b  NAXIS1'] = npix[
+00027bc0: 305d 0a20 2020 2068 6f75 745b 274e 4158  0].    hout['NAX
+00027bd0: 4953 3227 5d20 3d20 6e70 6978 5b31 5d0a  IS2'] = npix[1].
+00027be0: 2020 2020 686f 7574 5b27 4354 5950 4531      hout['CTYPE1
+00027bf0: 275d 203d 2027 5241 2d2d 2d54 414e 270a  '] = 'RA---TAN'.
+00027c00: 2020 2020 686f 7574 5b27 4354 5950 4532      hout['CTYPE2
+00027c10: 275d 203d 2027 4445 432d 2d54 414e 270a  '] = 'DEC--TAN'.
+00027c20: 0a20 2020 2068 6f75 745b 2752 4144 4553  .    hout['RADES
+00027c30: 5953 275d 203d 2027 4943 5253 270a 2020  YS'] = 'ICRS'.  
+00027c40: 2020 686f 7574 5b27 4551 5549 4e4f 5827    hout['EQUINOX'
+00027c50: 5d20 3d20 3230 3030 0a20 2020 2068 6f75  ] = 2000.    hou
+00027c60: 745b 274c 4154 504f 4c45 275d 203d 2068  t['LATPOLE'] = h
+00027c70: 6f75 745b 2743 5256 414c 3227 5d0a 2020  out['CRVAL2'].  
+00027c80: 2020 686f 7574 5b27 4c4f 4e50 4f4c 4527    hout['LONPOLE'
+00027c90: 5d20 3d20 3138 300a 0a20 2020 2068 6f75  ] = 180..    hou
+00027ca0: 745b 2750 4958 4153 4543 275d 203d 2070  t['PIXASEC'] = p
+00027cb0: 6978 7363 616c 652c 2027 5069 7865 6c20  ixscale, 'Pixel 
+00027cc0: 7363 616c 6520 696e 2061 7263 7365 6327  scale in arcsec'
+00027cd0: 0a0a 2020 2020 7763 735f 6f75 7420 3d20  ..    wcs_out = 
+00027ce0: 7079 7763 732e 5743 5328 686f 7574 290a  pywcs.WCS(hout).
+00027cf0: 0a20 2020 2074 6865 7461 5f72 6164 203d  .    theta_rad =
+00027d00: 206e 702e 6465 6732 7261 6428 7468 6574   np.deg2rad(thet
+00027d10: 6129 0a20 2020 206d 6174 203d 206e 702e  a).    mat = np.
+00027d20: 6172 7261 7928 5b5b 6e70 2e63 6f73 2874  array([[np.cos(t
+00027d30: 6865 7461 5f72 6164 292c 202d 6e70 2e73  heta_rad), -np.s
+00027d40: 696e 2874 6865 7461 5f72 6164 295d 2c0a  in(theta_rad)],.
+00027d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d60: 2020 2020 5b6e 702e 7369 6e28 7468 6574      [np.sin(thet
+00027d70: 615f 7261 6429 2c20 206e 702e 636f 7328  a_rad),  np.cos(
+00027d80: 7468 6574 615f 7261 6429 5d5d 290a 0a20  theta_rad)]]).. 
+00027d90: 2020 2072 6f74 5f63 6420 3d20 6e70 2e64     rot_cd = np.d
+00027da0: 6f74 286d 6174 2c20 7763 735f 6f75 742e  ot(mat, wcs_out.
+00027db0: 7763 732e 6364 290a 0a20 2020 2066 6f72  wcs.cd)..    for
+00027dc0: 2069 2069 6e20 5b30 2c20 315d 3a0a 2020   i in [0, 1]:.  
+00027dd0: 2020 2020 2020 666f 7220 6a20 696e 205b        for j in [
+00027de0: 302c 2031 5d3a 0a20 2020 2020 2020 2020  0, 1]:.         
+00027df0: 2020 2068 6f75 745b 2743 447b 303a 647d     hout['CD{0:d}
+00027e00: 5f7b 313a 647d 272e 666f 726d 6174 2869  _{1:d}'.format(i
+00027e10: 2b31 2c20 6a2b 3129 5d20 3d20 726f 745f  +1, j+1)] = rot_
+00027e20: 6364 5b69 2c20 6a5d 0a20 2020 2020 2020  cd[i, j].       
+00027e30: 2020 2020 2077 6373 5f6f 7574 2e77 6373       wcs_out.wcs
+00027e40: 2e63 645b 692c 206a 5d20 3d20 726f 745f  .cd[i, j] = rot_
+00027e50: 6364 5b69 2c20 6a5d 0a0a 2020 2020 6364  cd[i, j]..    cd
+00027e60: 203d 2077 6373 5f6f 7574 2e77 6373 2e63   = wcs_out.wcs.c
+00027e70: 640a 2020 2020 7763 735f 6f75 742e 7073  d.    wcs_out.ps
+00027e80: 6361 6c65 203d 2067 6574 5f77 6373 5f70  cale = get_wcs_p
+00027e90: 7363 616c 6528 7763 735f 6f75 7429 2020  scale(wcs_out)  
+00027ea0: 2320 6e70 2e73 7172 7428 2863 645b 302c  # np.sqrt((cd[0,
+00027eb0: 3a5d 2a2a 3229 2e73 756d 2829 292a 3336  :]**2).sum())*36
+00027ec0: 3030 2e0a 0a20 2020 2069 6620 6765 745f  00...    if get_
+00027ed0: 6864 753a 0a20 2020 2020 2020 2068 6475  hdu:.        hdu
+00027ee0: 203d 2070 7966 6974 732e 496d 6167 6548   = pyfits.ImageH
+00027ef0: 4455 2868 6561 6465 723d 686f 7574 2c20  DU(header=hout, 
+00027f00: 6461 7461 3d6e 702e 7a65 726f 7328 286e  data=np.zeros((n
+00027f10: 7069 785b 315d 2c20 6e70 6978 5b30 5d29  pix[1], npix[0])
+00027f20: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
+00027f30: 3332 2929 0a20 2020 2020 2020 2072 6574  32)).        ret
+00027f40: 7572 6e20 6864 750a 2020 2020 656c 7365  urn hdu.    else
+00027f50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00027f60: 2068 6f75 742c 2077 6373 5f6f 7574 0a0a   hout, wcs_out..
+00027f70: 0a64 6566 2067 6574 5f66 6c74 5f66 6f6f  .def get_flt_foo
+00027f80: 7470 7269 6e74 2866 6c74 5f66 696c 652c  tprint(flt_file,
+00027f90: 2065 7874 656e 7369 6f6e 733d 5b31 2c20   extensions=[1, 
+00027fa0: 322c 2033 2c20 345d 2c20 7061 7463 685f  2, 3, 4], patch_
+00027fb0: 6172 6773 3d4e 6f6e 6529 3a0a 2020 2020  args=None):.    
+00027fc0: 2222 220a 2020 2020 436f 6d70 7574 6520  """.    Compute 
+00027fd0: 666f 6f74 7072 696e 7420 6f66 2061 6c6c  footprint of all
+00027fe0: 2053 4349 2065 7874 656e 7369 6f6e 7320   SCI extensions 
+00027ff0: 6f66 2061 6e20 4853 5420 6578 706f 7375  of an HST exposu
+00028000: 7265 0a0a 2020 2020 5061 7261 6d65 7465  re..    Paramete
+00028010: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00028020: 2d0a 2020 2020 6578 7465 6e73 696f 6e73  -.    extensions
+00028030: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00028040: 4c69 7374 206f 6620 6578 7465 6e73 696f  List of extensio
+00028050: 6e73 2074 6f20 7265 7472 6965 7665 2028  ns to retrieve (
+00028060: 6361 6e20 6861 7665 2065 7874 7261 7329  can have extras)
+00028070: 2e0a 0a20 2020 2070 6174 6368 5f61 7267  ...    patch_arg
+00028080: 7320 3a20 6469 6374 206f 7220 4e6f 6e65  s : dict or None
+00028090: 0a20 2020 2020 2020 2049 6620 6120 6064  .        If a `d
+000280a0: 6963 7460 2c20 7468 656e 2067 656e 6572  ict`, then gener
+000280b0: 6174 6520 6120 7061 7463 6820 666f 7220  ate a patch for 
+000280c0: 7468 6520 666f 6f74 7072 696e 7420 7061  the footprint pa
+000280d0: 7373 696e 670a 2020 2020 2020 2020 602a  ssing.        `*
+000280e0: 2a70 6174 6368 5f61 7267 7360 2061 7267  *patch_args` arg
+000280f0: 756d 656e 7473 2028 652e 672e 2c20 607b  uments (e.g., `{
+00028100: 2766 6327 3a27 626c 7565 272c 2027 616c  'fc':'blue', 'al
+00028110: 7068 6127 3a30 2e31 7d60 292e 0a0a 2020  pha':0.1}`)...  
+00028120: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00028130: 2d2d 2d2d 2d0a 2020 2020 6670 202f 2070  -----.    fp / p
+00028140: 6174 6368 203a 2060 7e73 6861 7065 6c79  atch : `~shapely
+00028150: 2e67 656f 6d65 7472 7960 206f 626a 6563  .geometry` objec
+00028160: 7420 6f72 2060 6d61 7470 6c6f 746c 6962  t or `matplotlib
+00028170: 2e70 6174 6368 2e50 6174 6368 600a 2020  .patch.Patch`.  
+00028180: 2020 2020 2020 5468 6520 666f 6f74 7072        The footpr
+00028190: 696e 7420 6f72 2066 6f6f 7470 7269 6e74  int or footprint
+000281a0: 2070 6174 6368 2e0a 0a20 2020 2022 2222   patch...    """
+000281b0: 0a20 2020 2066 726f 6d20 7368 6170 656c  .    from shapel
+000281c0: 792e 6765 6f6d 6574 7279 2069 6d70 6f72  y.geometry impor
+000281d0: 7420 506f 6c79 676f 6e0a 0a20 2020 2069  t Polygon..    i
+000281e0: 6d20 3d20 7079 6669 7473 2e6f 7065 6e28  m = pyfits.open(
+000281f0: 666c 745f 6669 6c65 290a 2020 2020 6670  flt_file).    fp
+00028200: 203d 204e 6f6e 650a 0a20 2020 2066 6f72   = None..    for
+00028210: 2065 7874 2069 6e20 6578 7465 6e73 696f   ext in extensio
+00028220: 6e73 3a0a 2020 2020 2020 2020 6966 2028  ns:.        if (
+00028230: 2753 4349 272c 2065 7874 2920 6e6f 7420  'SCI', ext) not 
+00028240: 696e 2069 6d3a 0a20 2020 2020 2020 2020  in im:.         
+00028250: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00028260: 2020 2020 2077 6373 203d 2070 7977 6373       wcs = pywcs
+00028270: 2e57 4353 2869 6d5b 2753 4349 272c 2065  .WCS(im['SCI', e
+00028280: 7874 5d2e 6865 6164 6572 2c20 666f 626a  xt].header, fobj
+00028290: 3d69 6d29 0a20 2020 2020 2020 2070 5f69  =im).        p_i
+000282a0: 203d 2050 6f6c 7967 6f6e 2877 6373 2e63   = Polygon(wcs.c
+000282b0: 616c 635f 666f 6f74 7072 696e 7428 2929  alc_footprint())
+000282c0: 0a20 2020 2020 2020 2069 6620 6670 2069  .        if fp i
+000282d0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000282e0: 2020 2020 6670 203d 2070 5f69 0a20 2020      fp = p_i.   
+000282f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00028300: 2020 2020 2020 2066 7020 3d20 6670 2e75         fp = fp.u
+00028310: 6e69 6f6e 2870 5f69 290a 2020 2020 0a20  nion(p_i).    . 
+00028320: 2020 2069 6d2e 636c 6f73 6528 290a 2020     im.close().  
+00028330: 2020 0a20 2020 2069 6620 7061 7463 685f    .    if patch_
+00028340: 6172 6773 2069 7320 6e6f 7420 4e6f 6e65  args is not None
+00028350: 3a0a 2020 2020 2020 2020 7061 7463 6820  :.        patch 
+00028360: 3d20 7061 7463 685f 6672 6f6d 5f70 6f6c  = patch_from_pol
+00028370: 7967 6f6e 2866 702c 202a 2a70 6174 6368  ygon(fp, **patch
+00028380: 5f61 7267 7329 0a20 2020 2020 2020 2072  _args).        r
+00028390: 6574 7572 6e20 7061 7463 680a 2020 2020  eturn patch.    
+000283a0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+000283b0: 7475 726e 2066 700a 0a0a 6465 6620 6d61  turn fp...def ma
+000283c0: 6b65 5f6d 6178 696d 616c 5f77 6373 2866  ke_maximal_wcs(f
+000283d0: 696c 6573 2c20 7069 7865 6c5f 7363 616c  iles, pixel_scal
+000283e0: 653d 4e6f 6e65 2c20 6765 745f 6864 753d  e=None, get_hdu=
+000283f0: 5472 7565 2c20 7061 643d 3930 2c20 7665  True, pad=90, ve
+00028400: 7262 6f73 653d 5472 7565 2c20 7468 6574  rbose=True, thet
+00028410: 613d 302c 2070 6f6c 795f 6275 6666 6572  a=0, poly_buffer
+00028420: 3d31 2e2f 3336 3030 2c20 6e73 6369 5f65  =1./3600, nsci_e
+00028430: 7874 656e 7369 6f6e 733d 3429 3a0a 2020  xtensions=4):.  
+00028440: 2020 2222 220a 2020 2020 436f 6d70 7574    """.    Comput
+00028450: 6520 616e 2049 6d61 6765 4844 5520 7769  e an ImageHDU wi
+00028460: 7468 2061 2066 6f6f 7470 7269 6e74 2074  th a footprint t
+00028470: 6861 7420 636f 6e74 6169 6e73 2061 6c6c  hat contains all
+00028480: 206f 6620 6066 696c 6573 600a 0a20 2020   of `files`..   
+00028490: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+000284a0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066  ----------.    f
+000284b0: 696c 6573 203a 206c 6973 740a 2020 2020  iles : list.    
+000284c0: 2020 2020 4c69 7374 206f 6620 4853 5420      List of HST 
+000284d0: 4649 5453 2066 696c 6573 2028 652e 672e  FITS files (e.g.
+000284e0: 2c20 464c 542e 2920 6f72 2057 4353 206f  , FLT.) or WCS o
+000284f0: 626a 6563 7473 2e0a 0a20 2020 2070 6978  bjects...    pix
+00028500: 656c 5f73 6361 6c65 203a 2066 6c6f 6174  el_scale : float
+00028510: 0a20 2020 2020 2020 2050 6978 656c 2073  .        Pixel s
+00028520: 6361 6c65 206f 6620 6f75 7470 7574 2057  cale of output W
+00028530: 4353 2c20 696e 2060 7e61 7374 726f 7079  CS, in `~astropy
+00028540: 2e75 6e69 7473 2e61 7263 7365 6360 2e20  .units.arcsec`. 
+00028550: 2049 6620 604e 6f6e 6560 2c0a 2020 2020   If `None`,.    
+00028560: 2020 2020 6765 7420 7069 7865 6c20 7363      get pixel sc
+00028570: 616c 6520 6f66 2066 6972 7374 2066 696c  ale of first fil
+00028580: 6520 696e 2060 6669 6c65 7360 2e0a 0a20  e in `files`... 
+00028590: 2020 2067 6574 5f68 6475 203a 2062 6f6f     get_hdu : boo
+000285a0: 6c0a 2020 2020 2020 2020 5365 6520 6265  l.        See be
+000285b0: 6c6f 772e 0a0a 2020 2020 7061 6420 3a20  low...    pad : 
+000285c0: 666c 6f61 740a 2020 2020 2020 2020 5061  float.        Pa
+000285d0: 6464 696e 6720 746f 2061 6464 2074 6f20  dding to add to 
+000285e0: 7468 6520 746f 7461 6c20 696d 6167 6520  the total image 
+000285f0: 7369 7a65 2c20 696e 2060 7e61 7374 726f  size, in `~astro
+00028600: 7079 2e75 6e69 7473 2e61 7263 7365 6360  py.units.arcsec`
+00028610: 2e0a 0a20 2020 2074 6865 7461 203a 2066  ...    theta : f
+00028620: 6c6f 6174 0a20 2020 2020 2020 2050 6f73  loat.        Pos
+00028630: 6974 696f 6e20 616e 676c 652c 2064 6567  ition angle, deg
+00028640: 7265 6573 0a0a 2020 2020 6e73 6369 5f65  rees..    nsci_e
+00028650: 7874 656e 7369 6f6e 7320 3a20 696e 740a  xtensions : int.
+00028660: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
+00028670: 6620 2753 4349 2720 6578 7465 6e73 696f  f 'SCI' extensio
+00028680: 6e73 2074 6f20 7472 7920 696e 2074 6865  ns to try in the
+00028690: 2065 7870 6f73 7572 6520 6669 6c65 732e   exposure files.
+000286a0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+000286b0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6864    -------.    hd
+000286c0: 7520 3a20 607e 6173 7472 6f70 792e 696f  u : `~astropy.io
+000286d0: 2e66 6974 732e 496d 6167 6548 4455 600a  .fits.ImageHDU`.
+000286e0: 2020 2020 2020 2020 4966 2060 6765 745f          If `get_
+000286f0: 6864 7560 2069 7320 5472 7565 2e0a 0a20  hdu` is True... 
+00028700: 2020 202d 6f72 2d0a 0a20 2020 2068 6561     -or-..    hea
+00028710: 6465 722c 2077 6373 203a 2060 7e61 7374  der, wcs : `~ast
+00028720: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
+00028730: 6465 7260 2c20 607e 6173 7472 6f70 792e  der`, `~astropy.
+00028740: 7763 732e 5743 5360 0a20 2020 2020 2020  wcs.WCS`.       
+00028750: 2049 6620 6067 6574 5f68 6475 6020 6973   If `get_hdu` is
+00028760: 2046 616c 7365 2e0a 0a20 2020 2022 2222   False...    """
+00028770: 0a20 2020 2069 6d70 6f72 7420 6e75 6d70  .    import nump
+00028780: 7920 6173 206e 700a 2020 2020 6672 6f6d  y as np.    from
+00028790: 2073 6861 7065 6c79 2e67 656f 6d65 7472   shapely.geometr
+000287a0: 7920 696d 706f 7274 2050 6f6c 7967 6f6e  y import Polygon
+000287b0: 0a0a 2020 2020 696d 706f 7274 2061 7374  ..    import ast
+000287c0: 726f 7079 2e69 6f2e 6669 7473 2061 7320  ropy.io.fits as 
+000287d0: 7079 6669 7473 0a20 2020 2069 6d70 6f72  pyfits.    impor
+000287e0: 7420 6173 7472 6f70 792e 7763 7320 6173  t astropy.wcs as
+000287f0: 2070 7977 6373 0a0a 2020 2020 6966 2069   pywcs..    if i
+00028800: 7369 6e73 7461 6e63 6528 6669 6c65 735b  sinstance(files[
+00028810: 305d 2c20 7079 7763 732e 5743 5329 3a0a  0], pywcs.WCS):.
+00028820: 2020 2020 2020 2020 2320 416c 7265 6164          # Alread
+00028830: 7920 7763 735f 6c69 7374 0a20 2020 2020  y wcs_list.     
+00028840: 2020 2077 6373 5f6c 6973 7420 3d20 5b28     wcs_list = [(
+00028850: 7763 732c 2027 5743 5327 2c20 2d31 2920  wcs, 'WCS', -1) 
+00028860: 666f 7220 7763 7320 696e 2066 696c 6573  for wcs in files
+00028870: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
+00028880: 2020 2020 7763 735f 6c69 7374 203d 205b      wcs_list = [
+00028890: 5d0a 2020 2020 2020 2020 666f 7220 692c  ].        for i,
+000288a0: 2066 696c 6520 696e 2065 6e75 6d65 7261   file in enumera
+000288b0: 7465 2866 696c 6573 293a 0a20 2020 2020  te(files):.     
+000288c0: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
+000288d0: 2e70 6174 682e 6578 6973 7473 2866 696c  .path.exists(fil
+000288e0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+000288f0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00028900: 2020 2020 2020 2020 2020 7769 7468 2070            with p
+00028910: 7966 6974 732e 6f70 656e 2866 696c 6529  yfits.open(file)
+00028920: 2061 7320 696d 3a0a 2020 2020 2020 2020   as im:.        
+00028930: 2020 2020 2020 2020 666f 7220 6578 7420          for ext 
+00028940: 696e 2072 616e 6765 286e 7363 695f 6578  in range(nsci_ex
+00028950: 7465 6e73 696f 6e73 293a 0a20 2020 2020  tensions):.     
+00028960: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00028970: 6620 2827 5343 4927 2c20 6578 742b 3129  f ('SCI', ext+1)
+00028980: 206e 6f74 2069 6e20 696d 3a0a 2020 2020   not in im:.    
+00028990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289a0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+000289b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289c0: 2020 7763 7320 3d20 7079 7763 732e 5743    wcs = pywcs.WC
+000289d0: 5328 696d 5b27 5343 4927 2c20 6578 742b  S(im['SCI', ext+
+000289e0: 315d 2e68 6561 6465 722c 2066 6f62 6a3d  1].header, fobj=
+000289f0: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
+00028a00: 2020 2020 2020 2020 7763 735f 6c69 7374          wcs_list
+00028a10: 2e61 7070 656e 6428 2877 6373 2c20 6669  .append((wcs, fi
+00028a20: 6c65 2c20 6578 7429 290a 2020 2020 0a20  le, ext)).    . 
+00028a30: 2020 2069 6620 7069 7865 6c5f 7363 616c     if pixel_scal
+00028a40: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+00028a50: 2020 2070 6978 656c 5f73 6361 6c65 203d     pixel_scale =
+00028a60: 2067 6574 5f77 6373 5f70 7363 616c 6528   get_wcs_pscale(
+00028a70: 7763 735f 6c69 7374 5b30 5d5b 305d 290a  wcs_list[0][0]).
+00028a80: 2020 2020 2020 2020 0a20 2020 2067 726f          .    gro
+00028a90: 7570 5f70 6f6c 7920 3d20 4e6f 6e65 0a20  up_poly = None. 
+00028aa0: 2020 2066 6f72 2069 2c20 2877 6373 2c20     for i, (wcs, 
+00028ab0: 6669 6c65 2c20 6368 6970 2920 696e 2065  file, chip) in e
+00028ac0: 6e75 6d65 7261 7465 2877 6373 5f6c 6973  numerate(wcs_lis
+00028ad0: 7429 3a0a 2020 2020 2020 2020 705f 6920  t):.        p_i 
+00028ae0: 3d20 506f 6c79 676f 6e28 7763 732e 6361  = Polygon(wcs.ca
+00028af0: 6c63 5f66 6f6f 7470 7269 6e74 2829 290a  lc_footprint()).
+00028b00: 2020 2020 2020 2020 6966 2067 726f 7570          if group
+00028b10: 5f70 6f6c 7920 6973 204e 6f6e 653a 0a20  _poly is None:. 
+00028b20: 2020 2020 2020 2020 2020 2069 6620 706f             if po
+00028b30: 6c79 5f62 7566 6665 7220 3e20 303a 0a20  ly_buffer > 0:. 
+00028b40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00028b50: 726f 7570 5f70 6f6c 7920 3d20 705f 692e  roup_poly = p_i.
+00028b60: 6275 6666 6572 2831 2e2f 3336 3030 290a  buffer(1./3600).
+00028b70: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00028b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028b90: 2020 6772 6f75 705f 706f 6c79 203d 2070    group_poly = p
+00028ba0: 5f69 0a20 2020 2020 2020 2065 6c73 653a  _i.        else:
+00028bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028bc0: 706f 6c79 5f62 7566 6665 7220 3e20 303a  poly_buffer > 0:
+00028bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028be0: 2067 726f 7570 5f70 6f6c 7920 3d20 6772   group_poly = gr
+00028bf0: 6f75 705f 706f 6c79 2e75 6e69 6f6e 2870  oup_poly.union(p
+00028c00: 5f69 2e62 7566 6665 7228 312e 2f33 3630  _i.buffer(1./360
+00028c10: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
+00028c20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00028c30: 2020 2020 2020 6772 6f75 705f 706f 6c79        group_poly
+00028c40: 203d 2067 726f 7570 5f70 6f6c 792e 756e   = group_poly.un
+00028c50: 696f 6e28 705f 6929 0a20 2020 2020 2020  ion(p_i).       
+00028c60: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00028c70: 2020 2078 302c 2079 3020 3d20 6e70 2e63     x0, y0 = np.c
+00028c80: 6173 745b 666c 6f61 745d 2867 726f 7570  ast[float](group
+00028c90: 5f70 6f6c 792e 6365 6e74 726f 6964 2e78  _poly.centroid.x
+00028ca0: 7929 5b3a 2c20 305d 0a20 2020 2020 2020  y)[:, 0].       
+00028cb0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00028cc0: 2020 2020 2020 2020 206d 7367 203d 2027           msg = '
+00028cd0: 7b30 3a3e 3364 7d2f 7b31 3a3e 3364 7d3a  {0:>3d}/{1:>3d}:
+00028ce0: 207b 327d 5b53 4349 2c7b 337d 5d20 207b   {2}[SCI,{3}]  {
+00028cf0: 343a 3e36 2e32 667d 270a 2020 2020 2020  4:>6.2f}'.      
+00028d00: 2020 2020 2020 7072 696e 7428 6d73 672e        print(msg.
+00028d10: 666f 726d 6174 2869 2c20 6c65 6e28 6669  format(i, len(fi
+00028d20: 6c65 7329 2c20 6669 6c65 2c20 6368 6970  les), file, chip
+00028d30: 2b31 2c0a 2020 2020 2020 2020 2020 2020  +1,.            
+00028d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d50: 2067 726f 7570 5f70 6f6c 792e 6172 6561   group_poly.area
+00028d60: 2a33 3630 302a 6e70 2e63 6f73 2879 302f  *3600*np.cos(y0/
+00028d70: 3138 302a 6e70 2e70 6929 0a20 2020 2020  180*np.pi).     
+00028d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00028da0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00028db0: 2020 2070 7820 3d20 6e70 2e63 6173 745b     px = np.cast[
+00028dc0: 666c 6f61 745d 2867 726f 7570 5f70 6f6c  float](group_pol
+00028dd0: 792e 636f 6e76 6578 5f68 756c 6c2e 626f  y.convex_hull.bo
+00028de0: 756e 6461 7279 2e78 7929 2e54 0a20 2020  undary.xy).T.   
+00028df0: 2023 7830 2c20 7930 203d 206e 702e 6361   #x0, y0 = np.ca
+00028e00: 7374 5b66 6c6f 6174 5d28 6772 6f75 705f  st[float](group_
+00028e10: 706f 6c79 2e63 656e 7472 6f69 642e 7879  poly.centroid.xy
+00028e20: 295b 3a2c 305d 0a0a 2020 2020 7830 203d  )[:,0]..    x0 =
+00028e30: 2028 7078 2e6d 6178 2861 7869 733d 3029   (px.max(axis=0)
+00028e40: 2b70 782e 6d69 6e28 6178 6973 3d30 2929  +px.min(axis=0))
+00028e50: 2f32 2e0a 0a20 2020 2063 6f73 6420 3d20  /2...    cosd = 
+00028e60: 6e70 2e61 7272 6179 285b 6e70 2e63 6f73  np.array([np.cos
+00028e70: 2878 305b 315d 2f31 3830 2a6e 702e 7069  (x0[1]/180*np.pi
+00028e80: 292c 2031 5d29 0a0a 2020 2020 5f6d 6174  ), 1])..    _mat
+00028e90: 203d 206e 702e 6172 7261 7928 5b5b 6e70   = np.array([[np
+00028ea0: 2e63 6f73 2874 6865 7461 292c 202d 6e70  .cos(theta), -np
+00028eb0: 2e73 696e 2874 6865 7461 295d 2c0a 2020  .sin(theta)],.  
+00028ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ed0: 2020 205b 6e70 2e73 696e 2874 6865 7461     [np.sin(theta
+00028ee0: 292c 206e 702e 636f 7328 7468 6574 6129  ), np.cos(theta)
+00028ef0: 5d5d 290a 0a20 2020 2023 2052 6f74 6174  ]])..    # Rotat
+00028f00: 6564 0a20 2020 2070 7220 3d20 2828 7078  ed.    pr = ((px
+00028f10: 2d78 3029 2a63 6f73 6429 2e64 6f74 285f  -x0)*cosd).dot(_
+00028f20: 6d61 7429 2f63 6f73 642b 7830 0a0a 2020  mat)/cosd+x0..  
+00028f30: 2020 7369 7a65 5f61 7263 7365 6320 3d20    size_arcsec = 
+00028f40: 2870 722e 6d61 7828 6178 6973 3d30 292d  (pr.max(axis=0)-
+00028f50: 7072 2e6d 696e 2861 7869 733d 3029 292a  pr.min(axis=0))*
+00028f60: 636f 7364 2a33 3630 300a 2020 2020 7378  cosd*3600.    sx
+00028f70: 2c20 7379 203d 2073 697a 655f 6172 6373  , sy = size_arcs
+00028f80: 6563 0a0a 2020 2020 2320 7378 203d 2028  ec..    # sx = (
+00028f90: 7078 2e6d 6178 2829 2d70 782e 6d69 6e28  px.max()-px.min(
+00028fa0: 2929 2a63 6f73 642a 3336 3030 2023 2061  ))*cosd*3600 # a
+00028fb0: 7263 7365 630a 2020 2020 2320 7379 203d  rcsec.    # sy =
+00028fc0: 2028 7079 2e6d 6178 2829 2d70 792e 6d69   (py.max()-py.mi
+00028fd0: 6e28 2929 2a33 3630 3020 2320 6172 6373  n())*3600 # arcs
+00028fe0: 6563 0a0a 2020 2020 7369 7a65 203d 206e  ec..    size = n
+00028ff0: 702e 6d61 7869 6d75 6d28 7378 2b70 6164  p.maximum(sx+pad
+00029000: 2c20 7379 2b70 6164 290a 0a20 2020 2069  , sy+pad)..    i
+00029010: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00029020: 2020 206d 7367 203d 2027 5c6e 2020 4d6f     msg = '\n  Mo
+00029030: 7361 6963 2057 4353 3a20 287b 303a 2e35  saic WCS: ({0:.5
+00029040: 667d 2c7b 313a 2e35 667d 2920 270a 2020  f},{1:.5f}) '.  
+00029050: 2020 2020 2020 6d73 6720 2b3d 2027 7b32        msg += '{2
+00029060: 3a2e 3166 7d5c 2778 7b33 3a2e 3166 7d5c  :.1f}\'x{3:.1f}\
+00029070: 2720 207b 343a 2e33 667d 222f 7069 785c  '  {4:.3f}"/pix\
+00029080: 6e27 0a20 2020 2020 2020 2070 7269 6e74  n'.        print
+00029090: 286d 7367 2e66 6f72 6d61 7428 7830 5b30  (msg.format(x0[0
+000290a0: 5d2c 2078 305b 315d 2c20 2873 782b 7061  ], x0[1], (sx+pa
+000290b0: 6429 2f36 302e 2c20 2873 792b 7061 6429  d)/60., (sy+pad)
+000290c0: 2f36 302e 2c20 7069 7865 6c5f 7363 616c  /60., pixel_scal
+000290d0: 6529 290a 0a20 2020 206f 7574 203d 206d  e))..    out = m
+000290e0: 616b 655f 7763 7368 6561 6465 7228 7261  ake_wcsheader(ra
+000290f0: 3d78 305b 305d 2c20 6465 633d 7830 5b31  =x0[0], dec=x0[1
+00029100: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00029110: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+00029120: 3d28 7378 2b70 6164 2a32 2c20 7379 2b70  =(sx+pad*2, sy+p
+00029130: 6164 2a32 292c 0a20 2020 2020 2020 2020  ad*2),.         
+00029140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029150: 7069 7873 6361 6c65 3d70 6978 656c 5f73  pixscale=pixel_s
+00029160: 6361 6c65 2c0a 2020 2020 2020 2020 2020  cale,.          
+00029170: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00029180: 6574 5f68 6475 3d67 6574 5f68 6475 2c20  et_hdu=get_hdu, 
+00029190: 7468 6574 613d 7468 6574 612f 6e70 2e70  theta=theta/np.p
+000291a0: 692a 3138 3029 0a0a 2020 2020 7265 7475  i*180)..    retu
+000291b0: 726e 206f 7574 0a0a 0a64 6566 2068 616c  rn out...def hal
+000291c0: 665f 7069 7865 6c5f 7363 616c 6528 7763  f_pixel_scale(wc
+000291d0: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
+000291e0: 4372 6561 7465 2061 206e 6577 2057 4353  Create a new WCS
+000291f0: 2077 6974 6820 6861 6c66 2074 6865 2070   with half the p
+00029200: 6978 656c 2073 6361 6c65 206f 6620 616e  ixel scale of an
+00029210: 6f74 6865 7220 7468 6174 2063 616e 2062  other that can b
+00029220: 6520 0a20 2020 2062 6c6f 636b 2d61 7665  e .    block-ave
+00029230: 7261 6765 6420 3278 320a 2020 2020 0a20  raged 2x2.    . 
+00029240: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00029250: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00029260: 2077 6373 203a 2060 7e61 7374 726f 7079   wcs : `~astropy
+00029270: 2e77 6373 2e57 4353 600a 2020 2020 2020  .wcs.WCS`.      
+00029280: 2020 496e 7075 7420 5743 530a 2020 2020    Input WCS.    
+00029290: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+000292a0: 202d 2d2d 2d2d 2d2d 0a20 2020 2068 616c   -------.    hal
+000292b0: 665f 7763 7320 3a20 607e 6173 7472 6f70  f_wcs : `~astrop
+000292c0: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
+000292d0: 2020 204e 6577 2057 4353 2077 6974 6820     New WCS with 
+000292e0: 736d 616c 6c65 7220 7069 7865 6c73 0a20  smaller pixels. 
+000292f0: 2020 2022 2222 0a20 2020 2068 203d 2074     """.    h = t
+00029300: 6f5f 6865 6164 6572 2877 6373 290a 2020  o_header(wcs).  
+00029310: 2020 0a20 2020 2066 6f72 206b 2069 6e20    .    for k in 
+00029320: 5b27 4e41 5849 5331 272c 2027 4e41 5849  ['NAXIS1', 'NAXI
+00029330: 5332 275d 3a20 232c 2027 4352 5049 5831  S2']: #, 'CRPIX1
+00029340: 272c 2027 4352 5049 5832 275d 3a0a 2020  ', 'CRPIX2']:.  
+00029350: 2020 2020 2020 685b 6b5d 202a 3d20 320a        h[k] *= 2.
+00029360: 0a20 2020 2066 6f72 206b 2069 6e20 5b27  .    for k in ['
+00029370: 4352 5049 5831 272c 2027 4352 5049 5832  CRPIX1', 'CRPIX2
+00029380: 275d 3a0a 2020 2020 2020 2020 685b 6b5d  ']:.        h[k]
+00029390: 203d 2068 5b6b 5d2a 3220 2d20 302e 350a   = h[k]*2 - 0.5.
+000293a0: 2020 2020 2020 2020 0a20 2020 2066 6f72          .    for
+000293b0: 206b 2069 6e20 5b27 4344 315f 3127 2c20   k in ['CD1_1', 
+000293c0: 2743 4431 5f32 272c 2027 4344 325f 3127  'CD1_2', 'CD2_1'
+000293d0: 2c20 2743 4432 5f32 275d 3a0a 2020 2020  , 'CD2_2']:.    
+000293e0: 2020 2020 6966 206b 2069 6e20 683a 0a20      if k in h:. 
+000293f0: 2020 2020 2020 2020 2020 2068 5b6b 5d20             h[k] 
+00029400: 2f3d 2032 0a20 2020 200a 2020 2020 6966  /= 2.    .    if
+00029410: 2030 3a0a 2020 2020 2020 2020 2320 5465   0:.        # Te
+00029420: 7374 0a20 2020 2020 2020 206e 6577 203d  st.        new =
+00029430: 2070 7977 6373 2e57 4353 2868 290a 2020   pywcs.WCS(h).  
+00029440: 2020 2020 2020 7368 203d 206e 6577 2e70        sh = new.p
+00029450: 6978 656c 5f73 6861 7065 0a20 2020 2020  ixel_shape.     
+00029460: 2020 200a 2020 2020 2020 2020 7763 6f72     .        wcor
+00029470: 6e65 7220 3d20 7763 732e 616c 6c5f 776f  ner = wcs.all_wo
+00029480: 726c 6432 7069 7828 6e65 772e 616c 6c5f  rld2pix(new.all_
+00029490: 7069 7832 776f 726c 6428 5b5b 2d30 2e35  pix2world([[-0.5
+000294a0: 2c20 2d30 2e35 5d2c 200a 2020 2020 2020  , -0.5], .      
+000294b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000294c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000294d0: 2020 2020 2020 205b 7368 5b30 5d2d 302e         [sh[0]-0.
+000294e0: 352c 2073 685b 315d 2d30 2e35 5d5d 2c20  5, sh[1]-0.5]], 
+000294f0: 3029 2c30 290a 2020 2020 2020 2020 7072  0),0).        pr
+00029500: 696e 7428 2773 6d61 6c6c 203e 206c 6172  int('small > lar
+00029510: 6765 2729 0a20 2020 2020 2020 2070 7269  ge').        pri
+00029520: 6e74 2827 2c20 272e 6a6f 696e 285b 6627  nt(', '.join([f'
+00029530: 7b77 3a2e 3266 7d27 2066 6f72 2077 2069  {w:.2f}' for w i
+00029540: 6e20 7763 6f72 6e65 725b 305d 5d29 290a  n wcorner[0]])).
+00029550: 2020 2020 2020 2020 7072 696e 7428 272c          print(',
+00029560: 2027 2e6a 6f69 6e28 5b66 277b 773a 2e32   '.join([f'{w:.2
+00029570: 667d 2720 666f 7220 7720 696e 2077 636f  f}' for w in wco
+00029580: 726e 6572 5b31 5d5d 292c 2077 6373 2e70  rner[1]]), wcs.p
+00029590: 6978 656c 5f73 6861 7065 290a 2020 2020  ixel_shape).    
+000295a0: 2020 2020 0a20 2020 2020 2020 2073 6820      .        sh 
+000295b0: 3d20 7763 732e 7069 7865 6c5f 7368 6170  = wcs.pixel_shap
+000295c0: 650a 2020 2020 2020 2020 7763 6f72 6e65  e.        wcorne
+000295d0: 7220 3d20 6e65 772e 616c 6c5f 776f 726c  r = new.all_worl
+000295e0: 6432 7069 7828 7763 732e 616c 6c5f 7069  d2pix(wcs.all_pi
+000295f0: 7832 776f 726c 6428 5b5b 2d30 2e35 2c20  x2world([[-0.5, 
+00029600: 2d30 2e35 5d2c 200a 2020 2020 2020 2020  -0.5], .        
+00029610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029630: 2020 2020 205b 7368 5b30 5d2d 302e 352c       [sh[0]-0.5,
+00029640: 2073 685b 315d 2d30 2e35 5d5d 2c20 3029   sh[1]-0.5]], 0)
+00029650: 2c30 290a 2020 2020 2020 2020 7072 696e  ,0).        prin
+00029660: 7428 276c 6172 6765 203e 2073 6d61 6c6c  t('large > small
+00029670: 2729 0a20 2020 2020 2020 2070 7269 6e74  ').        print
+00029680: 2827 2c20 272e 6a6f 696e 285b 6627 7b77  (', '.join([f'{w
+00029690: 3a2e 3266 7d27 2066 6f72 2077 2069 6e20  :.2f}' for w in 
+000296a0: 7763 6f72 6e65 725b 305d 5d29 290a 2020  wcorner[0]])).  
+000296b0: 2020 2020 2020 7072 696e 7428 272c 2027        print(', '
+000296c0: 2e6a 6f69 6e28 5b66 277b 773a 2e32 667d  .join([f'{w:.2f}
+000296d0: 2720 666f 7220 7720 696e 2077 636f 726e  ' for w in wcorn
+000296e0: 6572 5b31 5d5d 292c 206e 6577 2e70 6978  er[1]]), new.pix
+000296f0: 656c 5f73 6861 7065 290a 2020 2020 2020  el_shape).      
+00029700: 2020 0a20 2020 206e 6577 5f77 6373 203d    .    new_wcs =
+00029710: 2070 7977 6373 2e57 4353 2868 2c20 7265   pywcs.WCS(h, re
+00029720: 6c61 783d 5472 7565 290a 2020 2020 0a20  lax=True).    . 
+00029730: 2020 2072 6574 7572 6e20 6e65 775f 7763     return new_wc
+00029740: 730a 0a0a 6465 6620 6865 6164 6572 5f6b  s...def header_k
+00029750: 6579 735f 6672 6f6d 5f66 696c 656c 6973  eys_from_filelis
+00029760: 7428 6669 7473 5f66 696c 6573 2c20 6b65  t(fits_files, ke
+00029770: 7977 6f72 6473 3d5b 5d2c 2065 7874 3d30  ywords=[], ext=0
+00029780: 2c20 636f 6c6e 616d 655f 6361 7365 3d73  , colname_case=s
+00029790: 7472 2e6c 6f77 6572 293a 0a20 2020 2022  tr.lower):.    "
+000297a0: 2222 4475 6d70 2068 6561 6465 7220 6b65  ""Dump header ke
+000297b0: 7977 6f72 6473 2074 6f20 6120 607e 6173  ywords to a `~as
+000297c0: 7472 6f70 792e 7461 626c 652e 5461 626c  tropy.table.Tabl
+000297d0: 6560 0a0a 2020 2020 5061 7261 6d65 7465  e`..    Paramete
+000297e0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+000297f0: 2d0a 2020 2020 6669 7473 5f66 696c 6573  -.    fits_files
+00029800: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00029810: 4c69 7374 206f 6620 4649 5453 2066 696c  List of FITS fil
+00029820: 656e 616d 6573 0a0a 2020 2020 6b65 7977  enames..    keyw
+00029830: 6f72 6473 203a 206c 6973 7420 6f72 204e  ords : list or N
+00029840: 6f6e 650a 2020 2020 2020 2020 4c69 7374  one.        List
+00029850: 206f 6620 6865 6164 6572 206b 6579 776f   of header keywo
+00029860: 7264 7320 746f 2072 6574 7269 6576 652e  rds to retrieve.
+00029870: 2020 4966 2060 4e6f 6e65 602c 2074 6865    If `None`, the
+00029880: 6e20 6765 6e65 7261 7465 2061 206c 6973  n generate a lis
+00029890: 740a 2020 2020 2020 2020 6f66 202a 616c  t.        of *al
+000298a0: 6c2a 206b 6579 776f 7264 7320 6672 6f6d  l* keywords from
+000298b0: 2074 6865 2066 6972 7374 2066 696c 6520   the first file 
+000298c0: 696e 2074 6865 206c 6973 742e 0a0a 2020  in the list...  
+000298d0: 2020 6578 7420 3a20 696e 742c 2074 7570    ext : int, tup
+000298e0: 6c65 0a20 2020 2020 2020 2046 4954 5320  le.        FITS 
+000298f0: 6578 7465 6e73 696f 6e20 6672 6f6d 2077  extension from w
+00029900: 6869 6368 2074 6f20 7075 6c6c 2074 6865  hich to pull the
+00029910: 2068 6561 6465 722e 2020 4361 6e20 6265   header.  Can be
+00029920: 2069 6e74 6567 6572 206f 720a 2020 2020   integer or.    
+00029930: 2020 2020 7475 706c 652c 2065 2e67 2e2c      tuple, e.g.,
+00029940: 2028 2753 4349 272c 3129 2066 6f72 2048   ('SCI',1) for H
+00029950: 5354 2041 4353 2f57 4643 3320 464c 5420  ST ACS/WFC3 FLT 
+00029960: 6669 6c65 732e 0a0a 2020 2020 636f 6c6e  files...    coln
+00029970: 616d 655f 6361 7365 203a 2066 756e 630a  ame_case : func.
+00029980: 2020 2020 2020 2020 4675 6e63 7469 6f6e          Function
+00029990: 2074 6f20 7365 7420 7468 6520 6361 7365   to set the case
+000299a0: 206f 6620 7468 6520 6f75 7470 7574 2063   of the output c
+000299b0: 6f6c 6e61 6d65 732c 2065 2e67 2e2c 2060  olnames, e.g., `
+000299c0: 7374 722e 6c6f 7765 7260 2c0a 2020 2020  str.lower`,.    
+000299d0: 2020 2020 6073 7472 2e75 7070 6572 602c      `str.upper`,
+000299e0: 2060 7374 722e 7469 746c 6560 2e0a 0a20   `str.title`... 
+000299f0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00029a00: 2d2d 2d2d 2d2d 0a20 2020 2074 6162 203a  ------.    tab :
+00029a10: 2060 7e61 7374 726f 7079 2e74 6162 6c65   `~astropy.table
+00029a20: 2e54 6162 6c65 600a 2020 2020 2020 2020  .Table`.        
+00029a30: 4f75 7470 7574 2074 6162 6c65 2e0a 0a20  Output table... 
+00029a40: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+00029a50: 7420 6e75 6d70 7920 6173 206e 700a 2020  t numpy as np.  
+00029a60: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
+00029a70: 2e69 6f2e 6669 7473 2061 7320 7079 6669  .io.fits as pyfi
+00029a80: 7473 0a20 2020 2066 726f 6d20 6173 7472  ts.    from astr
+00029a90: 6f70 792e 7461 626c 6520 696d 706f 7274  opy.table import
+00029aa0: 2054 6162 6c65 0a0a 2020 2020 2320 4966   Table..    # If
+00029ab0: 206b 6579 776f 7264 733d 4e6f 6e65 2c20   keywords=None, 
+00029ac0: 6765 7420 6675 6c6c 206c 6973 7420 6672  get full list fr
+00029ad0: 6f6d 2066 6972 7374 2046 4954 5320 6669  om first FITS fi
+00029ae0: 6c65 0a20 2020 2069 6620 6b65 7977 6f72  le.    if keywor
+00029af0: 6473 2069 7320 4e6f 6e65 3a0a 2020 2020  ds is None:.    
+00029b00: 2020 2020 6820 3d20 7079 6669 7473 2e67      h = pyfits.g
+00029b10: 6574 6865 6164 6572 2866 6974 735f 6669  etheader(fits_fi
+00029b20: 6c65 735b 305d 2c20 6578 7429 0a20 2020  les[0], ext).   
+00029b30: 2020 2020 206b 6579 776f 7264 7320 3d20       keywords = 
+00029b40: 6c69 7374 286e 702e 756e 6971 7565 286c  list(np.unique(l
+00029b50: 6973 7428 682e 6b65 7973 2829 2929 290a  ist(h.keys()))).
+00029b60: 2020 2020 2020 2020 6b65 7977 6f72 6473          keywords
+00029b70: 2e70 6f70 286b 6579 776f 7264 732e 696e  .pop(keywords.in
+00029b80: 6465 7828 2727 2929 0a20 2020 2020 2020  dex('')).       
+00029b90: 206b 6579 776f 7264 732e 706f 7028 6b65   keywords.pop(ke
+00029ba0: 7977 6f72 6473 2e69 6e64 6578 2827 4849  ywords.index('HI
+00029bb0: 5354 4f52 5927 2929 0a0a 2020 2020 2320  STORY'))..    # 
+00029bc0: 4c6f 6f70 2074 6872 6f75 6768 2066 696c  Loop through fil
+00029bd0: 6573 0a20 2020 206c 696e 6573 203d 205b  es.    lines = [
+00029be0: 5d0a 2020 2020 666f 7220 6669 6c65 2069  ].    for file i
+00029bf0: 6e20 6669 7473 5f66 696c 6573 3a0a 2020  n fits_files:.  
+00029c00: 2020 2020 2020 6c69 6e65 203d 205b 6669        line = [fi
+00029c10: 6c65 5d0a 2020 2020 2020 2020 6820 3d20  le].        h = 
+00029c20: 7079 6669 7473 2e67 6574 6865 6164 6572  pyfits.getheader
+00029c30: 2866 696c 652c 2065 7874 290a 2020 2020  (file, ext).    
+00029c40: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+00029c50: 6579 776f 7264 733a 0a20 2020 2020 2020  eywords:.       
+00029c60: 2020 2020 2069 6620 6b65 7920 696e 2068       if key in h
+00029c70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029c80: 2020 6c69 6e65 2e61 7070 656e 6428 685b    line.append(h[
+00029c90: 6b65 795d 290a 2020 2020 2020 2020 2020  key]).          
+00029ca0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029cb0: 2020 2020 2020 2020 6c69 6e65 2e61 7070          line.app
+00029cc0: 656e 6428 4e6f 6e65 290a 0a20 2020 2020  end(None)..     
+00029cd0: 2020 206c 696e 6573 2e61 7070 656e 6428     lines.append(
+00029ce0: 6c69 6e65 290a 0a20 2020 2023 2043 6f6c  line)..    # Col
+00029cf0: 756d 6e20 6e61 6d65 730a 2020 2020 7461  umn names.    ta
+00029d00: 626c 655f 6865 6164 6572 203d 205b 636f  ble_header = [co
+00029d10: 6c6e 616d 655f 6361 7365 286b 6579 2920  lname_case(key) 
+00029d20: 666f 7220 6b65 7920 696e 205b 2766 696c  for key in ['fil
+00029d30: 6527 5d2b 6b65 7977 6f72 6473 5d0a 0a20  e']+keywords].. 
+00029d40: 2020 2023 204f 7574 7075 7420 7461 626c     # Output tabl
+00029d50: 650a 2020 2020 7461 6220 3d20 5461 626c  e.    tab = Tabl
+00029d60: 6528 6461 7461 3d6e 702e 6172 7261 7928  e(data=np.array(
+00029d70: 6c69 6e65 7329 2c20 6e61 6d65 733d 7461  lines), names=ta
+00029d80: 626c 655f 6865 6164 6572 290a 0a20 2020  ble_header)..   
+00029d90: 2072 6574 7572 6e20 7461 620a 0a0a 6465   return tab...de
+00029da0: 6620 7061 7273 655f 7333 5f75 726c 2875  f parse_s3_url(u
+00029db0: 726c 3d27 7333 3a2f 2f62 7563 6b65 742f  rl='s3://bucket/
+00029dc0: 7061 7468 2f74 6f2f 6669 6c65 2e74 7874  path/to/file.txt
+00029dd0: 2729 3a0a 2020 2020 2222 220a 2020 2020  '):.    """.    
+00029de0: 5061 7273 6520 7333 2070 6174 6820 7374  Parse s3 path st
+00029df0: 7269 6e67 0a20 2020 200a 2020 2020 5061  ring.    .    Pa
+00029e00: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00029e10: 2d2d 2d2d 2d2d 2d0a 2020 2020 7572 6c20  -------.    url 
+00029e20: 3a20 7374 720a 2020 2020 2020 2020 4675  : str.        Fu
+00029e30: 6c6c 2053 3320 7061 7468 2c20 652e 672e  ll S3 path, e.g.
+00029e40: 2c20 6060 5b73 333a 2f2f 5d7b 6275 636b  , ``[s3://]{buck
+00029e50: 6574 5f6e 616d 657d 2f7b 7333 5f6f 626a  et_name}/{s3_obj
+00029e60: 6563 747d 6060 0a20 2020 200a 2020 2020  ect}``.    .    
+00029e70: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00029e80: 2d2d 2d0a 2020 2020 6275 636b 6574 5f6e  ---.    bucket_n
+00029e90: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
+00029ea0: 2020 4275 636b 6574 206e 616d 650a 2020    Bucket name.  
+00029eb0: 2020 0a20 2020 2073 335f 6f62 6a65 6374    .    s3_object
+00029ec0: 203a 2073 7472 0a20 2020 2020 2020 2046   : str.        F
+00029ed0: 756c 6c20 7061 7468 206f 6620 7468 6520  ull path of the 
+00029ee0: 5333 2066 696c 6520 6f62 6a65 6374 0a20  S3 file object. 
+00029ef0: 2020 200a 2020 2020 6669 6c65 6e61 6d65     .    filename
+00029f00: 203a 2073 7472 0a20 2020 2020 2020 2046   : str.        F
+00029f10: 696c 6520 6e61 6d65 206f 6620 7468 6520  ile name of the 
+00029f20: 6f62 6a65 6374 2c20 652e 672e 2060 606f  object, e.g. ``o
+00029f30: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+00029f40: 7333 5f6f 626a 6563 7429 6060 0a20 2020  s3_object)``.   
+00029f50: 2020 2020 200a 2020 2020 2222 220a 2020       .    """.  
+00029f60: 2020 7375 726c 203d 2075 726c 2e73 7472    surl = url.str
+00029f70: 6970 2827 7333 3a2f 2f27 290a 2020 2020  ip('s3://').    
+00029f80: 7370 6c20 3d20 7375 726c 2e73 706c 6974  spl = surl.split
+00029f90: 2827 2f27 290a 2020 2020 6966 206c 656e  ('/').    if len
+00029fa0: 2873 706c 2920 3c20 323a 0a20 2020 2020  (spl) < 2:.     
+00029fb0: 2020 2070 7269 6e74 2866 2262 7563 6b65     print(f"bucke
+00029fc0: 7420 2f20 7061 7468 206e 6f74 2066 6f75  t / path not fou
+00029fd0: 6e64 2069 6e20 7b75 726c 7d22 290a 2020  nd in {url}").  
+00029fe0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00029ff0: 652c 204e 6f6e 652c 204e 6f6e 650a 2020  e, None, None.  
+0002a000: 2020 2020 2020 0a20 2020 2062 7563 6b65        .    bucke
+0002a010: 745f 6e61 6d65 203d 2073 706c 5b30 5d0a  t_name = spl[0].
+0002a020: 2020 2020 7333 5f6f 626a 6563 7420 3d20      s3_object = 
+0002a030: 272f 272e 6a6f 696e 2873 706c 5b31 3a5d  '/'.join(spl[1:]
+0002a040: 290a 2020 2020 6669 6c65 6e61 6d65 203d  ).    filename =
+0002a050: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0002a060: 6528 7333 5f6f 626a 6563 7429 0a20 2020  e(s3_object).   
+0002a070: 2072 6574 7572 6e20 6275 636b 6574 5f6e   return bucket_n
+0002a080: 616d 652c 2073 335f 6f62 6a65 6374 2c20  ame, s3_object, 
+0002a090: 6669 6c65 6e61 6d65 0a0a 0a64 6566 2066  filename...def f
+0002a0a0: 6574 6368 5f73 335f 7572 6c28 7572 6c3d  etch_s3_url(url=
+0002a0b0: 2773 333a 2f2f 6275 636b 6574 2f70 6174  's3://bucket/pat
+0002a0c0: 682f 746f 2f66 696c 652e 7478 7427 2c20  h/to/file.txt', 
+0002a0d0: 6669 6c65 5f66 756e 633d 6c61 6d62 6461  file_func=lambda
+0002a0e0: 2078 203a 206f 732e 7061 7468 2e6a 6f69   x : os.path.joi
+0002a0f0: 6e28 272e 2f27 2c78 292c 2073 6b69 705f  n('./',x), skip_
+0002a100: 6578 6973 7469 6e67 3d54 7275 652c 2076  existing=True, v
+0002a110: 6572 626f 7365 3d54 7275 6529 3a0a 2020  erbose=True):.  
+0002a120: 2020 2222 220a 2020 2020 4665 7463 6820    """.    Fetch 
+0002a130: 6669 6c65 2066 726f 6d20 616e 2053 3320  file from an S3 
+0002a140: 6275 636b 6574 0a20 2020 200a 2020 2020  bucket.    .    
+0002a150: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+0002a160: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7572  ---------.    ur
+0002a170: 6c20 3a20 7374 720a 2020 2020 2020 2020  l : str.        
+0002a180: 5333 2075 726c 206f 6620 6120 6669 6c65  S3 url of a file
+0002a190: 2074 6f20 646f 776e 6c6f 6164 0a20 2020   to download.   
+0002a1a0: 200a 2020 2020 6669 6c65 5f66 756e 6320   .    file_func 
+0002a1b0: 3a20 6675 6e63 7469 6f6e 0a20 2020 2020  : function.     
+0002a1c0: 2020 2046 756e 6374 696f 6e20 6170 706c     Function appl
+0002a1d0: 6965 6420 746f 2074 6865 2066 696c 6520  ied to the file 
+0002a1e0: 6e61 6d65 2065 7874 7261 6374 6564 2066  name extracted f
+0002a1f0: 726f 6d20 6075 726c 602c 2065 2e67 2e2c  rom `url`, e.g.,
+0002a200: 2074 6f20 0a20 2020 2020 2020 2073 6574   to .        set
+0002a210: 206f 7574 7075 7420 6469 7265 6374 6f72   output director
+0002a220: 792c 2072 656e 616d 6520 6669 6c65 732c  y, rename files,
+0002a230: 2073 6574 2061 2070 7265 6669 782c 2065   set a prefix, e
+0002a240: 7463 2e0a 2020 2020 0a20 2020 2052 6574  tc..    .    Ret
+0002a250: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+0002a260: 0a20 2020 206c 6f63 616c 5f66 696c 6520  .    local_file 
+0002a270: 3a20 7374 720a 2020 2020 2020 2020 4e61  : str.        Na
+0002a280: 6d65 206f 6620 6c6f 6361 6c20 6669 6c65  me of local file
+0002a290: 206f 7220 604e 6f6e 6560 2069 6620 6661   or `None` if fa
+0002a2a0: 696c 6564 2074 6f20 7061 7273 6520 6075  iled to parse `u
+0002a2b0: 726c 600a 2020 2020 0a20 2020 2073 7461  rl`.    .    sta
+0002a2c0: 7475 7320 3a20 696e 740a 2020 2020 2020  tus : int.      
+0002a2d0: 2020 4269 7420 666c 6167 206f 6620 7265    Bit flag of re
+0002a2e0: 7375 6c74 733a 202a 2a31 2a2a 203d 3d20  sults: **1** == 
+0002a2f0: 6669 6c65 2066 6f75 6e64 2c20 2a2a 322a  file found, **2*
+0002a300: 2a20 3d20 646f 776e 6c6f 6164 2073 7563  * = download suc
+0002a310: 6365 7373 6675 6c0a 2020 2020 2020 2020  cessful.        
+0002a320: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+0002a330: 6f72 7420 7472 6163 6562 6163 6b0a 2020  ort traceback.  
+0002a340: 2020 696d 706f 7274 2062 6f74 6f33 0a20    import boto3. 
+0002a350: 2020 2069 6d70 6f72 7420 626f 746f 636f     import botoco
+0002a360: 7265 2e65 7863 6570 7469 6f6e 730a 2020  re.exceptions.  
+0002a370: 2020 0a20 2020 2073 3320 3d20 626f 746f    .    s3 = boto
+0002a380: 332e 7265 736f 7572 6365 2827 7333 2729  3.resource('s3')
+0002a390: 0a20 2020 2062 7563 6b65 745f 6e61 6d65  .    bucket_name
+0002a3a0: 2c20 7333 5f6f 626a 6563 742c 2066 696c  , s3_object, fil
+0002a3b0: 656e 616d 6520 3d20 7061 7273 655f 7333  ename = parse_s3
+0002a3c0: 5f75 726c 2875 726c 3d75 726c 290a 2020  _url(url=url).  
+0002a3d0: 2020 6966 2062 7563 6b65 745f 6e61 6d65    if bucket_name
+0002a3e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0002a3f0: 2020 7265 7475 726e 2075 726c 2c20 6f73    return url, os
+0002a400: 2e70 6174 682e 6578 6973 7473 2875 726c  .path.exists(url
+0002a410: 290a 2020 2020 2020 2020 0a20 2020 2062  ).        .    b
+0002a420: 6b74 203d 2073 332e 4275 636b 6574 2862  kt = s3.Bucket(b
+0002a430: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
+0002a440: 6c6f 6361 6c5f 6669 6c65 203d 2066 696c  local_file = fil
+0002a450: 655f 6675 6e63 2866 696c 656e 616d 6529  e_func(filename)
+0002a460: 0a20 2020 2073 7461 7475 7320 3d20 6f73  .    status = os
+0002a470: 2e70 6174 682e 6578 6973 7473 286c 6f63  .path.exists(loc
+0002a480: 616c 5f66 696c 6529 2a31 0a20 2020 200a  al_file)*1.    .
+0002a490: 2020 2020 6966 2028 7374 6174 7573 203e      if (status >
+0002a4a0: 2030 2920 2620 736b 6970 5f65 7869 7374   0) & skip_exist
+0002a4b0: 696e 673a 0a20 2020 2020 2020 2070 7269  ing:.        pri
+0002a4c0: 6e74 2866 277b 6c6f 6361 6c5f 6669 6c65  nt(f'{local_file
+0002a4d0: 7d20 6578 6973 7473 2c20 736b 6970 7069  } exists, skippi
+0002a4e0: 6e67 2e27 290a 2020 2020 656c 7365 3a0a  ng.').    else:.
+0002a4f0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0002a500: 2020 2020 2020 2020 2020 626b 742e 646f            bkt.do
+0002a510: 776e 6c6f 6164 5f66 696c 6528 7333 5f6f  wnload_file(s3_o
+0002a520: 626a 6563 742c 206c 6f63 616c 5f66 696c  bject, local_fil
+0002a530: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002a540: 2020 2020 2020 2020 2045 7874 7261 4172           ExtraAr
+0002a550: 6773 3d7b 2252 6571 7565 7374 5061 7965  gs={"RequestPaye
+0002a560: 7222 3a20 2272 6571 7565 7374 6572 227d  r": "requester"}
+0002a570: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0002a580: 6174 7573 202b 3d20 320a 2020 2020 2020  atus += 2.      
+0002a590: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+0002a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a5b0: 2020 7072 696e 7428 6627 7b75 726c 7d20    print(f'{url} 
+0002a5c0: 3e20 7b6c 6f63 616c 5f66 696c 657d 2729  > {local_file}')
+0002a5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a5e0: 200a 2020 2020 2020 2020 6578 6365 7074   .        except
+0002a5f0: 2062 6f74 6f63 6f72 652e 6578 6365 7074   botocore.except
+0002a600: 696f 6e73 2e43 6c69 656e 7445 7272 6f72  ions.ClientError
+0002a610: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0002a620: 6163 6520 3d20 7472 6163 6562 6163 6b2e  ace = traceback.
+0002a630: 666f 726d 6174 5f65 7863 286c 696d 6974  format_exc(limit
+0002a640: 3d32 290a 2020 2020 2020 2020 2020 2020  =2).            
+0002a650: 6d73 6720 3d20 7472 6163 652e 7370 6c69  msg = trace.spli
+0002a660: 7428 275c 6e27 295b 2d32 5d2e 7370 6c69  t('\n')[-2].spli
+0002a670: 7428 2743 6c69 656e 7445 7272 6f72 3a20  t('ClientError: 
+0002a680: 2729 5b31 5d0a 2020 2020 2020 2020 2020  ')[1].          
+0002a690: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0002a6a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0002a6b0: 696e 7428 6627 4661 696c 6564 207b 7572  int(f'Failed {ur
+0002a6c0: 6c7d 3a20 7b6d 7367 7d27 290a 2020 2020  l}: {msg}').    
+0002a6d0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0002a6e0: 2020 2020 2020 2020 2023 2044 6f77 6e6c           # Downl
+0002a6f0: 6f61 6420 6661 696c 6564 2064 7565 2074  oad failed due t
+0002a700: 6f20 6120 436c 6965 6e74 4572 726f 720a  o a ClientError.
+0002a710: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
+0002a720: 7262 6964 6465 6e20 7072 6f62 6162 6c79  rbidden probably
+0002a730: 206d 6561 6e73 2069 6e73 7566 6669 6369   means insuffici
+0002a740: 656e 7420 6275 636b 6574 2061 6363 6573  ent bucket acces
+0002a750: 7320 7072 6976 696c 6567 6573 0a20 2020  s privileges.   
+0002a760: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0002a770: 2020 2020 2020 2020 2020 0a20 2020 2072            .    r
+0002a780: 6574 7572 6e20 6c6f 6361 6c5f 6669 6c65  eturn local_file
+0002a790: 2c20 7374 6174 7573 0a0a 0a64 6566 206e  , status...def n
+0002a7a0: 6972 6973 735f 6768 6f73 745f 6d61 736b  iriss_ghost_mask
+0002a7b0: 2869 6d2c 2069 6e69 745f 7468 7265 7368  (im, init_thresh
+0002a7c0: 3d30 2e30 352c 2069 6e69 745f 7369 676d  =0.05, init_sigm
+0002a7d0: 613d 332c 2066 696e 616c 5f74 6872 6573  a=3, final_thres
+0002a7e0: 683d 302e 3031 2c20 6669 6e61 6c5f 7369  h=0.01, final_si
+0002a7f0: 676d 613d 332c 2065 726f 7369 6f6e 733d  gma=3, erosions=
+0002a800: 302c 2064 696c 6174 696f 6e73 3d39 2c20  0, dilations=9, 
+0002a810: 7665 7262 6f73 653d 5472 7565 2c20 2a2a  verbose=True, **
+0002a820: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
+0002a830: 0a20 2020 204d 616b 6520 6120 6d61 736b  .    Make a mask
+0002a840: 2066 6f72 204e 4952 4953 5320 696d 6167   for NIRISS imag
+0002a850: 696e 6720 6768 6f73 7473 0a20 2020 200a  ing ghosts.    .
+0002a860: 2020 2020 5365 6520 616c 736f 204d 6172      See also Mar
+0002a870: 7465 6c2e 204a 5753 542d 5354 5363 492d  tel. JWST-STScI-
+0002a880: 3030 3438 3737 2061 6e64 0a20 2020 2068  004877 and.    h
+0002a890: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+0002a8a0: 6d2f 7370 6163 6574 656c 6573 636f 7065  m/spacetelescope
+0002a8b0: 2f6e 6972 6973 735f 6768 6f73 740a 2020  /niriss_ghost.  
+0002a8c0: 2020 0a20 2020 2048 6572 650a 2020 2020    .    Here.    
+0002a8d0: 2222 220a 2020 2020 696d 706f 7274 2073  """.    import s
+0002a8e0: 6369 7079 2e6e 6469 6d61 6765 2061 7320  cipy.ndimage as 
+0002a8f0: 6e64 0a20 2020 200a 2020 2020 6966 2069  nd.    .    if i
+0002a900: 6d5b 305d 2e68 6561 6465 725b 2750 5550  m[0].header['PUP
+0002a910: 494c 275d 206e 6f74 2069 6e20 5b27 4631  IL'] not in ['F1
+0002a920: 3135 5727 2c27 4631 3530 5727 2c27 4632  15W','F150W','F2
+0002a930: 3030 5727 5d3a 0a20 2020 2020 2020 2072  00W']:.        r
+0002a940: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
+0002a950: 0a20 2020 2069 6620 696d 5b30 5d2e 6865  .    if im[0].he
+0002a960: 6164 6572 5b27 5055 5049 4c27 5d20 3d3d  ader['PUPIL'] ==
+0002a970: 2027 4631 3135 5727 3a0a 2020 2020 2020   'F115W':.      
+0002a980: 2020 7867 6170 2c20 7967 6170 203d 2031    xgap, ygap = 1
+0002a990: 3135 362c 2039 3237 0a20 2020 2065 6c69  156, 927.    eli
+0002a9a0: 6620 696d 5b30 5d2e 6865 6164 6572 5b27  f im[0].header['
+0002a9b0: 5055 5049 4c27 5d20 3d3d 2027 4631 3135  PUPIL'] == 'F115
+0002a9c0: 5727 3a0a 2020 2020 2020 2020 7867 6170  W':.        xgap
+0002a9d0: 2c20 7967 6170 203d 2031 3136 322c 2039  , ygap = 1162, 9
+0002a9e0: 3338 0a20 2020 2065 6c73 653a 0a20 2020  38.    else:.   
+0002a9f0: 2020 2020 2078 6761 702c 2079 6761 7020       xgap, ygap 
+0002aa00: 3d20 3131 3536 2c20 3934 342d 320a 2020  = 1156, 944-2.  
+0002aa10: 2020 2020 2020 0a20 2020 2079 702c 2078        .    yp, x
+0002aa20: 7020 3d20 6e70 2e69 6e64 6963 6573 2828  p = np.indices((
+0002aa30: 3230 3438 2c20 3230 3438 2929 0a20 2020  2048, 2048)).   
+0002aa40: 200a 2020 2020 7967 203d 2032 2a28 7967   .    yg = 2*(yg
+0002aa50: 6170 2d31 2920 2d20 7970 0a20 2020 2078  ap-1) - yp.    x
+0002aa60: 6720 3d20 322a 2878 6761 702d 3129 202d  g = 2*(xgap-1) -
+0002aa70: 2078 700a 0a20 2020 2064 7820 3d20 2878   xp..    dx = (x
+0002aa80: 7020 2d20 7867 6170 290a 2020 2020 6479  p - xgap).    dy
+0002aa90: 203d 2028 7970 202d 2079 6761 7029 0a0a   = (yp - ygap)..
+0002aaa0: 2020 2020 696e 5f69 6d67 203d 2028 7867      in_img = (xg
+0002aab0: 203e 3d20 3029 2026 2028 7867 203c 2032   >= 0) & (xg < 2
+0002aac0: 3034 3829 0a20 2020 2069 6e5f 696d 6720  048).    in_img 
+0002aad0: 263d 2028 7967 203e 3d20 3029 2026 2028  &= (yg >= 0) & (
+0002aae0: 7967 203c 2032 3034 3829 0a0a 2020 2020  yg < 2048)..    
+0002aaf0: 696e 5f69 6d67 2026 3d20 6e70 2e61 6273  in_img &= np.abs
+0002ab00: 2864 7829 203c 2034 3030 0a20 2020 2069  (dx) < 400.    i
+0002ab10: 6e5f 696d 6720 263d 206e 702e 6162 7328  n_img &= np.abs(
+0002ab20: 6479 2920 3c20 3430 300a 2020 2020 0a20  dy) < 400.    . 
+0002ab30: 2020 2069 6620 274d 4452 495a 534b 5927     if 'MDRIZSKY'
+0002ab40: 2069 6e20 696d 5b27 5343 4927 5d2e 6865   in im['SCI'].he
+0002ab50: 6164 6572 3a0a 2020 2020 2020 2020 626b  ader:.        bk
+0002ab60: 6720 3d20 696d 5b27 5343 4927 5d2e 6865  g = im['SCI'].he
+0002ab70: 6164 6572 5b27 4d44 5249 5a53 4b59 275d  ader['MDRIZSKY']
+0002ab80: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0002ab90: 2020 2062 6b67 203d 206e 702e 6e61 6e6d     bkg = np.nanm
+0002aba0: 6564 6961 6e28 696d 5b27 5343 4927 5d2e  edian(im['SCI'].
+0002abb0: 6461 7461 5b69 6d5b 2744 5127 5d2e 6461  data[im['DQ'].da
+0002abc0: 7461 203d 3d20 305d 290a 2020 2020 2020  ta == 0]).      
+0002abd0: 2020 0a20 2020 2074 6872 6573 6820 3d20    .    thresh = 
+0002abe0: 2869 6d5b 2753 4349 275d 2e64 6174 6120  (im['SCI'].data 
+0002abf0: 2d20 626b 6729 2a69 6e69 745f 7468 7265  - bkg)*init_thre
+0002ac00: 7368 203e 2069 6e69 745f 7369 676d 612a  sh > init_sigma*
+0002ac10: 696d 5b27 4552 5227 5d2e 6461 7461 0a20  im['ERR'].data. 
+0002ac20: 2020 2074 6872 6573 6820 263d 2069 6e5f     thresh &= in_
+0002ac30: 696d 670a 0a20 2020 205f 7265 666c 6563  img..    _reflec
+0002ac40: 7465 6420 3d20 6e70 2e7a 6572 6f73 5f6c  ted = np.zeros_l
+0002ac50: 696b 6528 696d 5b27 5343 4927 5d2e 6461  ike(im['SCI'].da
+0002ac60: 7461 290a 2020 2020 666f 7220 7870 692c  ta).    for xpi,
+0002ac70: 2079 7069 2c20 7867 692c 2079 6769 2069   ypi, xgi, ygi i
+0002ac80: 6e20 7a69 7028 7870 5b74 6872 6573 685d  n zip(xp[thresh]
+0002ac90: 2c20 7970 5b74 6872 6573 685d 2c0a 2020  , yp[thresh],.  
+0002aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acc0: 7867 5b74 6872 6573 685d 2c20 7967 5b74  xg[thresh], yg[t
+0002acd0: 6872 6573 685d 293a 0a20 2020 2020 2020  hresh]):.       
+0002ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acf0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002ad00: 2020 2020 5f72 6566 6c65 6374 6564 5b79      _reflected[y
+0002ad10: 6769 2c20 7867 695d 203d 2069 6d5b 2753  gi, xgi] = im['S
+0002ad20: 4349 275d 2e64 6174 615b 7970 692c 2078  CI'].data[ypi, x
+0002ad30: 7069 5d20 2d20 626b 670a 0a20 2020 2067  pi] - bkg..    g
+0002ad40: 686f 7374 5f6d 6173 6b20 3d20 5f72 6566  host_mask = _ref
+0002ad50: 6c65 6374 6564 2a66 696e 616c 5f74 6872  lected*final_thr
+0002ad60: 6573 6820 3e20 6669 6e61 6c5f 7369 676d  esh > final_sigm
+0002ad70: 612a 696d 5b27 4552 5227 5d2e 6461 7461  a*im['ERR'].data
+0002ad80: 0a20 2020 200a 2020 2020 6966 2065 726f  .    .    if ero
+0002ad90: 7369 6f6e 7320 3e20 303a 0a20 2020 2020  sions > 0:.     
+0002ada0: 2020 2067 686f 7374 5f6d 6173 6b20 3d20     ghost_mask = 
+0002adb0: 6e64 2e62 696e 6172 795f 6572 6f73 696f  nd.binary_erosio
+0002adc0: 6e28 6768 6f73 745f 6d61 736b 2c20 6974  n(ghost_mask, it
+0002add0: 6572 6174 696f 6e73 3d65 726f 7369 6f6e  erations=erosion
+0002ade0: 7329 0a20 2020 2020 2020 200a 2020 2020  s).        .    
+0002adf0: 6768 6f73 745f 6d61 736b 203d 206e 642e  ghost_mask = nd.
+0002ae00: 6269 6e61 7279 5f64 696c 6174 696f 6e28  binary_dilation(
+0002ae10: 6768 6f73 745f 6d61 736b 2c20 6974 6572  ghost_mask, iter
+0002ae20: 6174 696f 6e73 3d64 696c 6174 696f 6e73  ations=dilations
+0002ae30: 290a 2020 2020 0a20 2020 2069 6d5b 305d  ).    .    im[0]
+0002ae40: 2e68 6561 6465 725b 2747 484f 5354 4d53  .header['GHOSTMS
+0002ae50: 4b27 5d20 3d20 5472 7565 2c20 274e 4952  K'] = True, 'NIR
+0002ae60: 4953 5320 6768 6f73 7420 6d61 736b 2061  ISS ghost mask a
+0002ae70: 7070 6c69 6564 270a 2020 2020 696d 5b30  pplied'.    im[0
+0002ae80: 5d2e 6865 6164 6572 5b27 4748 4f53 544e  ].header['GHOSTN
+0002ae90: 5058 275d 203d 2067 686f 7374 5f6d 6173  PX'] = ghost_mas
+0002aea0: 6b2e 7375 6d28 292c 2027 5069 7865 6c73  k.sum(), 'Pixels
+0002aeb0: 2069 6e20 4e49 5249 5353 2067 686f 7374   in NIRISS ghost
+0002aec0: 206d 6173 6b27 0a20 2020 200a 2020 2020   mask'.    .    
+0002aed0: 6d73 6720 3d20 274e 4952 4953 5320 6768  msg = 'NIRISS gh
+0002aee0: 6f73 7420 6d61 736b 207b 307d 204e 7069  ost mask {0} Npi
+0002aef0: 783a 207b 317d 5c6e 272e 666f 726d 6174  x: {1}\n'.format
+0002af00: 2869 6d5b 305d 2e68 6561 6465 725b 2750  (im[0].header['P
+0002af10: 5550 494c 275d 2c20 0a20 2020 2020 2020  UPIL'], .       
+0002af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af40: 2020 2020 2020 2020 2020 2020 2067 686f               gho
+0002af50: 7374 5f6d 6173 6b2e 7375 6d28 2929 0a20  st_mask.sum()). 
+0002af60: 2020 206c 6f67 5f63 6f6d 6d65 6e74 284c     log_comment(L
+0002af70: 4f47 4649 4c45 2c20 6d73 672c 2076 6572  OGFILE, msg, ver
+0002af80: 626f 7365 3d76 6572 626f 7365 290a 2020  bose=verbose).  
+0002af90: 2020 0a20 2020 2072 6574 7572 6e20 6768    .    return gh
+0002afa0: 6f73 745f 6d61 736b 0a0a 0a64 6566 2067  ost_mask...def g
+0002afb0: 6574 5f70 686f 746f 6d5f 7363 616c 6528  et_photom_scale(
+0002afc0: 6865 6164 6572 2c20 7665 7262 6f73 653d  header, verbose=
+0002afd0: 5472 7565 293a 0a20 2020 2022 2222 0a20  True):.    """. 
+0002afe0: 2020 2047 6574 2074 6162 756c 6174 6564     Get tabulated
+0002aff0: 2073 6361 6c65 2066 6163 746f 720a 2020   scale factor.  
+0002b000: 2020 0a20 2020 2050 6172 616d 6574 6572    .    Parameter
+0002b010: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+0002b020: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
+0002b030: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+0002b040: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
+0002b050: 496d 6167 6520 6865 6164 6572 0a20 2020  Image header.   
+0002b060: 200a 2020 2020 5265 7475 726e 730a 2020   .    Returns.  
+0002b070: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6b65    -------.    ke
+0002b080: 7920 3a20 7374 720a 2020 2020 2020 2020  y : str.        
+0002b090: 4465 7465 6374 6f72 202b 2066 696c 7465  Detector + filte
+0002b0a0: 7220 6b65 790a 2020 2020 0a20 2020 2073  r key.    .    s
+0002b0b0: 6361 6c65 203a 2066 6c6f 6174 0a20 2020  cale : float.   
+0002b0c0: 2020 2020 2053 6361 6c65 2076 616c 7565       Scale value
+0002b0d0: 2e20 2049 6620 606b 6579 6020 6e6f 7420  .  If `key` not 
+0002b0e0: 666f 756e 6420 696e 2074 6865 2060 6064  found in the ``d
+0002b0f0: 6174 612f 7068 6f74 6f6d 5f63 6f72 7265  ata/photom_corre
+0002b100: 6374 696f 6e2e 796d 6c60 600a 2020 2020  ction.yml``.    
+0002b110: 2020 2020 7461 626c 6520 6f72 2069 6620      table or if 
+0002b120: 7468 6520 4354 5820 6973 206e 6577 6572  the CTX is newer
+0002b130: 2074 6861 6e20 7468 6174 2069 6e64 6963   than that indic
+0002b140: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
+0002b150: 6563 7469 6f6e 0a20 2020 2020 2020 2074  ection.        t
+0002b160: 6162 6c65 2074 6865 6e20 7265 7475 726e  able then return
+0002b170: 2031 2e30 2e0a 2020 2020 2020 2020 0a20   1.0..        . 
+0002b180: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+0002b190: 7420 7961 6d6c 0a20 2020 2069 6620 2754  t yaml.    if 'T
+0002b1a0: 454c 4553 434f 5027 2069 6e20 6865 6164  ELESCOP' in head
+0002b1b0: 6572 3a0a 2020 2020 2020 2020 6966 2068  er:.        if h
+0002b1c0: 6561 6465 725b 2754 454c 4553 434f 5027  eader['TELESCOP'
+0002b1d0: 5d20 6e6f 7420 696e 205b 274a 5753 5427  ] not in ['JWST'
+0002b1e0: 5d3a 0a20 2020 2020 2020 2020 2020 206d  ]:.            m
+0002b1f0: 7367 203d 2066 2267 6574 5f70 686f 746f  sg = f"get_photo
+0002b200: 6d5f 7363 616c 653a 2054 454c 4553 434f  m_scale: TELESCO
+0002b210: 503d 7b68 6561 6465 725b 2754 454c 4553  P={header['TELES
+0002b220: 434f 5027 5d7d 2069 7320 6e6f 7420 274a  COP']} is not 'J
+0002b230: 5753 5427 220a 2020 2020 2020 2020 2020  WST'".          
+0002b240: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
+0002b250: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
+0002b260: 6f73 653d 7665 7262 6f73 6529 0a20 2020  ose=verbose).   
+0002b270: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b280: 6865 6164 6572 5b27 5445 4c45 5343 4f50  header['TELESCOP
+0002b290: 275d 2c20 312e 300a 2020 2020 656c 7365  '], 1.0.    else
+0002b2a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0002b2b0: 204e 6f6e 652c 2031 2e30 0a20 2020 2020   None, 1.0.     
+0002b2c0: 2020 200a 2020 2020 636f 7272 5f66 696c     .    corr_fil
+0002b2d0: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
+0002b2e0: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
+0002b2f0: 285f 5f66 696c 655f 5f29 2c20 0a20 2020  (__file__), .   
+0002b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b310: 2020 2020 2020 2020 2020 2764 6174 612f            'data/
+0002b320: 7068 6f74 6f6d 5f63 6f72 7265 6374 696f  photom_correctio
+0002b330: 6e2e 796d 6c27 290a 2020 2020 0a20 2020  n.yml').    .   
+0002b340: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
+0002b350: 6578 6973 7473 2863 6f72 725f 6669 6c65  exists(corr_file
+0002b360: 293a 0a20 2020 2020 2020 206d 7367 203d  ):.        msg =
+0002b370: 2066 277b 636f 7272 5f66 696c 657d 206e   f'{corr_file} n
+0002b380: 6f74 2066 6f75 6e64 2e27 0a20 2020 2020  ot found.'.     
+0002b390: 2020 206c 6f67 5f63 6f6d 6d65 6e74 284c     log_comment(L
+0002b3a0: 4f47 4649 4c45 2c20 6d73 672c 2076 6572  OGFILE, msg, ver
+0002b3b0: 626f 7365 3d76 6572 626f 7365 290a 2020  bose=verbose).  
+0002b3c0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0002b3d0: 652c 2031 0a20 2020 200a 2020 2020 7769  e, 1.    .    wi
+0002b3e0: 7468 206f 7065 6e28 636f 7272 5f66 696c  th open(corr_fil
+0002b3f0: 6529 2061 7320 6670 3a0a 2020 2020 2020  e) as fp:.      
+0002b400: 2020 636f 7272 203d 2079 616d 6c2e 6c6f    corr = yaml.lo
+0002b410: 6164 2866 702c 204c 6f61 6465 723d 7961  ad(fp, Loader=ya
+0002b420: 6d6c 2e53 6166 654c 6f61 6465 7229 0a20  ml.SafeLoader). 
+0002b430: 2020 2020 2020 200a 2020 2020 6966 2027         .    if '
+0002b440: 4352 4453 5f43 5458 2720 696e 2068 6561  CRDS_CTX' in hea
+0002b450: 6465 723a 0a20 2020 2020 2020 2069 6620  der:.        if 
+0002b460: 6865 6164 6572 5b27 4352 4453 5f43 5458  header['CRDS_CTX
+0002b470: 275d 203e 2063 6f72 725b 2743 5244 535f  '] > corr['CRDS_
+0002b480: 4354 585f 4d41 5827 5d3a 0a20 2020 2020  CTX_MAX']:.     
+0002b490: 2020 2020 2020 206d 7367 203d 2066 2267         msg = f"g
+0002b4a0: 6574 5f70 686f 746f 6d5f 7363 616c 6520  et_photom_scale 
+0002b4b0: 7b63 6f72 725f 6669 6c65 7d3a 207b 6865  {corr_file}: {he
+0002b4c0: 6164 6572 5b27 4352 4453 5f43 5458 275d  ader['CRDS_CTX']
+0002b4d0: 7d20 3e20 7b63 6f72 725b 2743 5244 535f  } > {corr['CRDS_
+0002b4e0: 4354 585f 4d41 5827 5d7d 220a 2020 2020  CTX_MAX']}".    
+0002b4f0: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
+0002b500: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
+0002b510: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
+0002b520: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+0002b530: 6574 7572 6e20 6865 6164 6572 5b27 4352  eturn header['CR
+0002b540: 4453 5f43 5458 275d 2c20 312e 300a 2020  DS_CTX'], 1.0.  
+0002b550: 2020 2020 2020 2020 2020 0a20 2020 206b            .    k
+0002b560: 6579 203d 2027 7b30 7d2d 7b31 7d27 2e66  ey = '{0}-{1}'.f
+0002b570: 6f72 6d61 7428 6865 6164 6572 5b27 4445  ormat(header['DE
+0002b580: 5445 4354 4f52 275d 2c20 6865 6164 6572  TECTOR'], header
+0002b590: 5b27 4649 4c54 4552 275d 290a 2020 2020  ['FILTER']).    
+0002b5a0: 6966 2027 5055 5049 4c27 2069 6e20 6865  if 'PUPIL' in he
+0002b5b0: 6164 6572 3a0a 2020 2020 2020 2020 6b65  ader:.        ke
+0002b5c0: 7920 2b3d 2027 2d7b 307d 272e 666f 726d  y += '-{0}'.form
+0002b5d0: 6174 2868 6561 6465 725b 2750 5550 494c  at(header['PUPIL
+0002b5e0: 275d 290a 2020 2020 0a20 2020 2069 6620  ']).    .    if 
+0002b5f0: 6b65 7920 6e6f 7420 696e 2063 6f72 723a  key not in corr:
+0002b600: 0a20 2020 2020 2020 206d 7367 203d 2066  .        msg = f
+0002b610: 2267 6574 5f70 686f 746f 6d5f 7363 616c  "get_photom_scal
+0002b620: 6520 7b63 6f72 725f 6669 6c65 7d3a 207b  e {corr_file}: {
+0002b630: 6b65 797d 206e 6f74 2066 6f75 6e64 220a  key} not found".
+0002b640: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
+0002b650: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
+0002b660: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
+0002b670: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
+0002b680: 2020 2020 7265 7475 726e 206b 6579 2c20      return key, 
+0002b690: 312e 300a 2020 2020 0a20 2020 2065 6c73  1.0.    .    els
+0002b6a0: 653a 0a20 2020 2020 2020 206d 7367 203d  e:.        msg =
+0002b6b0: 2066 2267 6574 5f70 686f 746f 6d5f 7363   f"get_photom_sc
+0002b6c0: 616c 6520 7b63 6f72 725f 6669 6c65 7d3a  ale {corr_file}:
+0002b6d0: 2053 6361 6c65 207b 6b65 797d 2062 7920   Scale {key} by 
+0002b6e0: 7b31 2e2f 636f 7272 5b6b 6579 5d3a 2e33  {1./corr[key]:.3
+0002b6f0: 667d 220a 2020 2020 2020 2020 6c6f 675f  f}".        log_
+0002b700: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
+0002b710: 206d 7367 2c20 7665 7262 6f73 653d 7665   msg, verbose=ve
+0002b720: 7262 6f73 6529 0a20 2020 2020 2020 200a  rbose).        .
+0002b730: 2020 2020 2020 2020 7265 7475 726e 206b          return k
+0002b740: 6579 2c20 312e 2f63 6f72 725b 6b65 795d  ey, 1./corr[key]
+0002b750: 0a0a 0a64 6566 2064 7269 7a7a 6c65 5f66  ...def drizzle_f
+0002b760: 726f 6d5f 7669 7369 7428 7669 7369 742c  rom_visit(visit,
+0002b770: 206f 7574 7075 743d 4e6f 6e65 2c20 7069   output=None, pi
+0002b780: 7866 7261 633d 312e 2c20 6b65 726e 656c  xfrac=1., kernel
+0002b790: 3d27 706f 696e 7427 2c0a 2020 2020 2020  ='point',.      
+0002b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b7b0: 2063 6c65 616e 3d54 7275 652c 2069 6e63   clean=True, inc
+0002b7c0: 6c75 6465 5f73 6174 7572 6174 6564 3d54  lude_saturated=T
+0002b7d0: 7275 652c 206b 6565 705f 6269 7473 3d4e  rue, keep_bits=N
+0002b7e0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002b7f0: 2020 2020 2020 2020 2020 2020 6472 7972              dryr
+0002b800: 756e 3d46 616c 7365 2c20 736b 6970 3d4e  un=False, skip=N
+0002b810: 6f6e 652c 2065 7874 7261 5f77 6663 3369  one, extra_wfc3i
+0002b820: 725f 6261 6470 6978 3d54 7275 652c 0a20  r_badpix=True,. 
+0002b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b840: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
+0002b850: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0002b860: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+0002b870: 5f70 686f 746f 6d3d 5472 7565 2c0a 2020  _photom=True,.  
+0002b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b890: 2020 2020 2077 6569 6768 745f 7479 7065       weight_type
+0002b8a0: 3d27 6a77 7374 272c 0a20 2020 2020 2020  ='jwst',.       
+0002b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8c0: 726e 6f69 7365 5f70 6572 6365 6e74 696c  rnoise_percentil
+0002b8d0: 653d 3939 2c0a 2020 2020 2020 2020 2020  e=99,.          
+0002b8e0: 2020 2020 2020 2020 2020 2020 2063 616c               cal
+0002b8f0: 635f 7763 736d 6170 3d46 616c 7365 2c0a  c_wcsmap=False,.
+0002b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b910: 2020 2020 2020 206e 6972 6973 735f 6768         niriss_gh
+0002b920: 6f73 745f 6b77 6172 6773 3d7b 7d2c 0a20  ost_kwargs={},. 
+0002b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b940: 2020 2020 2020 6765 745f 6462 6d61 736b        get_dbmask
+0002b950: 3d54 7275 6529 3a0a 2020 2020 2222 220a  =True):.    """.
+0002b960: 2020 2020 4d61 6b65 2064 7269 7a7a 6c65      Make drizzle
+0002b970: 206d 6f73 6169 6320 6672 6f6d 2065 7870   mosaic from exp
+0002b980: 6f73 7572 6573 2069 6e20 6120 7669 7369  osures in a visi
+0002b990: 7420 6469 6374 696f 6e61 7279 0a20 2020  t dictionary.   
+0002b9a0: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
+0002b9b0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0002b9c0: 2020 2020 7669 7369 7420 3a20 6469 6374      visit : dict
+0002b9d0: 0a20 2020 2020 2020 2056 6973 6974 2064  .        Visit d
+0002b9e0: 6963 7469 6f6e 6172 7920 7769 7468 2027  ictionary with '
+0002b9f0: 7072 6f64 7563 7427 2061 6e64 2027 6669  product' and 'fi
+0002ba00: 6c65 7327 206b 6579 730a 2020 2020 0a20  les' keys.    . 
+0002ba10: 2020 206f 7574 7075 7420 3a20 607e 6173     output : `~as
+0002ba20: 7472 6f70 792e 7763 732e 5743 5360 2c20  tropy.wcs.WCS`, 
+0002ba30: 607e 6173 7472 6f70 792e 696f 2e66 6974  `~astropy.io.fit
+0002ba40: 732e 4865 6164 6572 602c 2060 7e61 7374  s.Header`, `~ast
+0002ba50: 726f 7079 2e69 6f2e 496d 6167 6548 4455  ropy.io.ImageHDU
+0002ba60: 600a 2020 2020 2020 2020 4f75 7470 7574  `.        Output
+0002ba70: 2066 7261 6d65 2064 6566 696e 6974 696f   frame definitio
+0002ba80: 6e2e 2020 4361 6e20 6265 2061 2057 4353  n.  Can be a WCS
+0002ba90: 206f 626a 6563 742c 2068 6561 6465 722c   object, header,
+0002baa0: 206f 7220 4649 5453 2048 4455 2e20 2049   or FITS HDU.  I
+0002bab0: 660a 2020 2020 2020 2020 4e6f 6e65 2c20  f.        None, 
+0002bac0: 7468 656e 2067 656e 6572 6174 6573 2061  then generates a
+0002bad0: 2057 4353 2077 6974 6820 6067 7269 7a6c   WCS with `grizl
+0002bae0: 692e 7574 696c 732e 6d61 6b65 5f6d 6178  i.utils.make_max
+0002baf0: 696d 616c 5f77 6373 600a 2020 2020 0a20  imal_wcs`.    . 
+0002bb00: 2020 2070 6978 6672 6163 203a 2066 6c6f     pixfrac : flo
+0002bb10: 6174 0a20 2020 2020 2020 2044 7269 7a7a  at.        Drizz
+0002bb20: 6c65 2060 7069 7866 7261 6360 0a20 2020  le `pixfrac`.   
+0002bb30: 200a 2020 2020 6b65 726e 656c 203a 2073   .    kernel : s
+0002bb40: 7472 0a20 2020 2020 2020 2044 7269 7a7a  tr.        Drizz
+0002bb50: 6c65 2060 6b65 726e 656c 6020 2865 2e67  le `kernel` (e.g
+0002bb60: 2e2c 2027 706f 696e 7427 2c20 2773 7175  ., 'point', 'squ
+0002bb70: 6172 6527 290a 2020 2020 0a20 2020 2063  are').    .    c
+0002bb80: 6c65 616e 203a 2062 6f6f 6c0a 2020 2020  lean : bool.    
+0002bb90: 2020 2020 5265 6d6f 7665 2065 7870 6f73      Remove expos
+0002bba0: 7572 6520 6669 6c65 7320 6166 7465 7220  ure files after 
+0002bbb0: 6164 6469 6e67 2074 6f20 7468 6520 6d6f  adding to the mo
+0002bbc0: 7361 6963 0a20 2020 200a 2020 2020 696e  saic.    .    in
+0002bbd0: 636c 7564 655f 7361 7475 7261 7465 6420  clude_saturated 
+0002bbe0: 3a20 626f 6f6c 0a20 2020 2020 2020 2049  : bool.        I
+0002bbf0: 6e63 6c75 6465 2070 6978 656c 7320 7769  nclude pixels wi
+0002bc00: 7468 2073 6174 7572 6174 6564 2044 5120  th saturated DQ 
+0002bc10: 666c 6167 0a20 2020 200a 2020 2020 6b65  flag.    .    ke
+0002bc20: 6570 5f62 6974 7320 3a20 696e 742c 204e  ep_bits : int, N
+0002bc30: 6f6e 650a 2020 2020 2020 2020 4578 7472  one.        Extr
+0002bc40: 6120 4451 2062 6974 7320 746f 206b 6565  a DQ bits to kee
+0002bc50: 7020 6173 2076 616c 6964 0a20 2020 200a  p as valid.    .
+0002bc60: 2020 2020 6472 7972 756e 203a 2062 6f6f      dryrun : boo
+0002bc70: 6c0a 2020 2020 2020 2020 4966 2054 7275  l.        If Tru
+0002bc80: 652c 2064 6f6e 2774 2061 6374 7561 6c6c  e, don't actuall
+0002bc90: 7920 7072 6f64 7563 6520 7468 6520 6f75  y produce the ou
+0002bca0: 7470 7574 0a20 2020 200a 2020 2020 736b  tput.    .    sk
+0002bcb0: 6970 203a 2069 6e74 0a20 2020 2020 2020  ip : int.       
+0002bcc0: 2053 6c69 6365 2073 6b69 7020 746f 2064   Slice skip to d
+0002bcd0: 7269 7a7a 6c65 2061 2073 7562 7365 7420  rizzle a subset 
+0002bce0: 6f66 2065 7870 6f73 7572 6573 0a20 2020  of exposures.   
+0002bcf0: 200a 2020 2020 6578 7472 615f 7766 6333   .    extra_wfc3
+0002bd00: 6972 5f62 6164 7069 7820 3a20 626f 6f6c  ir_badpix : bool
+0002bd10: 0a20 2020 2020 2020 2041 7070 6c79 2065  .        Apply e
+0002bd20: 7874 7261 2057 4643 332f 4952 2062 6164  xtra WFC3/IR bad
+0002bd30: 2070 6978 2074 6f20 4451 0a20 2020 200a   pix to DQ.    .
+0002bd40: 2020 2020 7665 7262 6f73 6520 3a20 626f      verbose : bo
+0002bd50: 6f6c 0a20 2020 2020 2020 2053 6f6d 6520  ol.        Some 
+0002bd60: 7665 7262 6f73 6520 6d65 7373 6167 6520  verbose message 
+0002bd70: 7072 696e 7469 6e67 0a20 2020 200a 2020  printing.    .  
+0002bd80: 2020 7363 616c 655f 7068 6f74 6f6d 203a    scale_photom :
+0002bd90: 2062 6f6f 6c0a 2020 2020 2020 2020 466f   bool.        Fo
+0002bda0: 7220 4a57 5354 2c20 6170 706c 7920 7068  r JWST, apply ph
+0002bdb0: 6f74 6f6d 6574 7279 2073 6361 6c65 2063  otometry scale c
+0002bdc0: 6f72 7265 6374 696f 6e73 2066 726f 6d20  orrections from 
+0002bdd0: 7468 6520 200a 2020 2020 2020 2020 6067  the  .        `g
+0002bde0: 7269 7a6c 692f 6461 7461 2f70 686f 746f  rizli/data/photo
+0002bdf0: 6d5f 636f 7272 6563 7469 6f6e 2e79 6d6c  m_correction.yml
+0002be00: 6020 7461 626c 650a 2020 2020 0a20 2020  ` table.    .   
+0002be10: 2077 6569 6768 745f 7479 7065 203a 2027   weight_type : '
+0002be20: 6572 7227 2c20 276d 6564 6961 6e5f 6572  err', 'median_er
+0002be30: 7227 2c20 2774 696d 6527 2c20 276a 7773  r', 'time', 'jws
+0002be40: 7427 0a20 2020 2020 2020 2045 7870 6f73  t'.        Expos
+0002be50: 7572 6520 7765 6967 6874 696e 6720 7374  ure weighting st
+0002be60: 7261 7465 6779 2e0a 2020 2020 2020 2020  rategy..        
+0002be70: 0a20 2020 2020 2020 202d 2054 6865 2064  .        - The d
+0002be80: 6566 6175 6c74 2027 6572 7227 2073 7472  efault 'err' str
+0002be90: 6174 6567 7920 7573 6573 2074 6865 2066  ategy uses the f
+0002bea0: 756c 6c20 756e 6365 7274 6169 6e74 7920  ull uncertainty 
+0002beb0: 6172 7261 7920 6465 6669 6e65 6420 696e  array defined in
+0002bec0: 2074 6865 200a 2020 2020 2020 2020 2020   the .          
+0002bed0: 6045 5252 6020 696d 6167 6520 6578 7465  `ERR` image exte
+0002bee0: 6e73 696f 6e73 2e20 2054 6865 2061 6c74  nsions.  The alt
+0002bef0: 6572 6e61 7469 7665 0a20 2020 2020 2020  ernative.       
+0002bf00: 200a 2020 2020 2020 2020 2d20 5468 6520   .        - The 
+0002bf10: 276d 6564 6961 6e5f 6572 7227 2073 7472  'median_err' str
+0002bf20: 6174 6567 7920 7573 6573 2074 6865 206d  ategy uses the m
+0002bf30: 6564 6961 6e20 6f66 2074 6865 2060 4552  edian of the `ER
+0002bf40: 5260 2065 7874 656e 7369 6f6e 0a20 2020  R` extension.   
+0002bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf60: 2020 2020 0a20 2020 2020 2020 202d 2054      .        - T
+0002bf70: 6865 2027 7469 6d65 2720 7374 7261 7465  he 'time' strate
+0002bf80: 6779 2077 6569 6768 7473 2027 6d65 6469  gy weights 'medi
+0002bf90: 616e 5f65 7272 2720 6279 2074 6865 2060  an_err' by the `
+0002bfa0: 5449 4d45 6020 6578 7465 6e73 696f 6e2c  TIME` extension,
+0002bfb0: 2069 660a 2020 2020 2020 2020 2020 6176   if.          av
+0002bfc0: 6169 6c61 626c 650a 2020 2020 0a20 2020  ailable.    .   
+0002bfd0: 2020 2020 202d 2046 6f72 2074 6865 2027       - For the '
+0002bfe0: 6a77 7374 2720 7374 7261 7465 6779 2c20  jwst' strategy, 
+0002bff0: 6966 2027 5641 525f 504f 4953 534f 4e27  if 'VAR_POISSON'
+0002c000: 2061 6e64 2027 5641 525f 524e 4f49 5345   and 'VAR_RNOISE
+0002c010: 2720 6578 7465 6e73 696f 6e73 2066 6f75  ' extensions fou
+0002c020: 6e64 2c0a 2020 2020 2020 2020 2020 7765  nd,.          we
+0002c030: 6967 6874 2062 7920 5641 525f 524e 4f49  ight by VAR_RNOI
+0002c040: 5345 202b 206d 6564 6961 6e28 5641 525f  SE + median(VAR_
+0002c050: 504f 4953 534f 4e29 2e20 2046 616c 6c20  POISSON).  Fall 
+0002c060: 6261 636b 2074 6f20 276d 6564 6961 6e5f  back to 'median_
+0002c070: 6572 7227 0a20 2020 2020 2020 2020 206f  err'.          o
+0002c080: 7468 6572 7769 7365 2e0a 2020 2020 0a20  therwise..    . 
+0002c090: 2020 2072 6e6f 6973 655f 7065 7263 656e     rnoise_percen
+0002c0a0: 7469 6c65 203a 2066 6c6f 6174 0a20 2020  tile : float.   
+0002c0b0: 2020 2020 2050 6572 6365 6e74 696c 6520       Percentile 
+0002c0c0: 6465 6669 6e69 6e67 2074 6865 2075 7070  defining the upp
+0002c0d0: 6572 206c 696d 6974 206f 6620 7661 6c69  er limit of vali
+0002c0e0: 6420 6056 4152 5f52 4e4f 4953 4560 2076  d `VAR_RNOISE` v
+0002c0f0: 616c 7565 732c 2069 6620 7468 6174 200a  alues, if that .
+0002c100: 2020 2020 2020 2020 6578 7465 6e73 696f          extensio
+0002c110: 6e20 6973 2066 6f75 6e64 2069 6e20 7468  n is found in th
+0002c120: 6520 6578 706f 7375 7265 2066 696c 6573  e exposure files
+0002c130: 2865 2e67 2e2c 2066 6f72 204a 5753 5429  (e.g., for JWST)
+0002c140: 0a20 2020 200a 2020 2020 6e69 7269 7373  .    .    niriss
+0002c150: 5f67 686f 7374 5f6b 7761 7267 7320 3a20  _ghost_kwargs : 
+0002c160: 6469 6374 0a20 2020 2020 2020 204b 6579  dict.        Key
+0002c170: 776f 7264 2061 7267 756d 656e 7473 2066  word arguments f
+0002c180: 6f72 2060 7e67 7269 7a6c 692e 7574 696c  or `~grizli.util
+0002c190: 732e 6e69 7269 7373 5f67 686f 7374 5f6d  s.niriss_ghost_m
+0002c1a0: 6173 6b60 0a20 2020 200a 2020 2020 5265  ask`.    .    Re
+0002c1b0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0002c1c0: 2d0a 2020 2020 6f75 7473 6369 203a 2061  -.    outsci : a
+0002c1d0: 7272 6179 2d6c 696b 650a 2020 2020 2020  rray-like.      
+0002c1e0: 2020 5343 4920 6172 7261 790a 2020 2020    SCI array.    
+0002c1f0: 0a20 2020 206f 7574 7768 7420 3a20 6172  .    outwht : ar
+0002c200: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+0002c210: 2049 6e76 6572 7365 2076 6172 6961 6e63   Inverse varianc
+0002c220: 6520 5748 5420 6172 7261 790a 2020 2020  e WHT array.    
+0002c230: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
+0002c240: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+0002c250: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
+0002c260: 496d 6167 6520 6865 6164 6572 0a20 2020  Image header.   
+0002c270: 200a 2020 2020 666c 6973 7420 3a20 6c69   .    flist : li
+0002c280: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+0002c290: 6f66 2066 696c 6573 2074 6861 7420 7765  of files that we
+0002c2a0: 7265 2064 7269 7a7a 6c65 6420 746f 2074  re drizzled to t
+0002c2b0: 6865 206d 6f73 6169 630a 2020 2020 2020  he mosaic.      
+0002c2c0: 2020 0a20 2020 2077 6373 5f74 6162 203a    .    wcs_tab :
+0002c2d0: 2060 7e61 7374 726f 7079 2e74 6162 6c65   `~astropy.table
+0002c2e0: 2e54 6162 6c65 600a 2020 2020 2020 2020  .Table`.        
+0002c2f0: 5461 626c 6520 6f66 2057 4353 2070 6172  Table of WCS par
+0002c300: 616d 6574 6572 7320 6f66 2069 6e64 6976  ameters of indiv
+0002c310: 6964 7561 6c20 6578 706f 7375 7265 730a  idual exposures.
+0002c320: 2020 2020 0a20 2020 2022 2222 0a20 2020      .    """.   
+0002c330: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
+0002c340: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
+0002c350: 6c79 676f 6e0a 2020 2020 696d 706f 7274  lygon.    import
+0002c360: 2062 6f74 6f33 0a20 2020 2066 726f 6d20   boto3.    from 
+0002c370: 626f 746f 636f 7265 2e65 7863 6570 7469  botocore.excepti
+0002c380: 6f6e 7320 696d 706f 7274 2043 6c69 656e  ons import Clien
+0002c390: 7445 7272 6f72 0a20 2020 2069 6d70 6f72  tError.    impor
+0002c3a0: 7420 7363 6970 792e 6e64 696d 6167 6520  t scipy.ndimage 
+0002c3b0: 6173 206e 640a 2020 2020 6672 6f6d 2061  as nd.    from a
+0002c3c0: 7374 726f 7079 2e69 6f2e 6669 7473 2069  stropy.io.fits i
+0002c3d0: 6d70 6f72 7420 5072 696d 6172 7948 4455  mport PrimaryHDU
+0002c3e0: 2c20 496d 6167 6548 4455 0a20 2020 200a  , ImageHDU.    .
+0002c3f0: 2020 2020 6672 6f6d 202e 7072 6570 2069      from .prep i
+0002c400: 6d70 6f72 7420 6170 706c 795f 7265 6769  mport apply_regi
+0002c410: 6f6e 5f6d 6173 6b5f 6672 6f6d 5f64 620a  on_mask_from_db.
+0002c420: 2020 2020 6672 6f6d 202e 7665 7273 696f      from .versio
+0002c430: 6e20 696d 706f 7274 205f 5f76 6572 7369  n import __versi
+0002c440: 6f6e 5f5f 2061 7320 6772 697a 6c69 5f5f  on__ as grizli__
+0002c450: 7665 7273 696f 6e0a 0a20 2020 2062 7563  version..    buc
+0002c460: 6b65 745f 6e61 6d65 203d 204e 6f6e 650a  ket_name = None.
+0002c470: 2020 2020 7333 203d 2062 6f74 6f33 2e72      s3 = boto3.r
+0002c480: 6573 6f75 7263 6528 2773 3327 290a 2020  esource('s3').  
+0002c490: 2020 7333 5f63 6c69 656e 7420 3d20 626f    s3_client = bo
+0002c4a0: 746f 332e 636c 6965 6e74 2827 7333 2729  to3.client('s3')
+0002c4b0: 0a20 2020 200a 2020 2020 6966 2077 6569  .    .    if wei
+0002c4c0: 6768 745f 7479 7065 206e 6f74 2069 6e20  ght_type not in 
+0002c4d0: 5b27 6572 7227 2c20 276d 6564 6961 6e5f  ['err', 'median_
+0002c4e0: 6572 7227 2c20 2774 696d 6527 2c20 276a  err', 'time', 'j
+0002c4f0: 7773 7427 5d3a 0a20 2020 2020 2020 2070  wst']:.        p
+0002c500: 7269 6e74 2866 2257 4152 4e49 4e47 3a20  rint(f"WARNING: 
+0002c510: 7765 6967 6874 5f74 7970 6520 277b 7765  weight_type '{we
+0002c520: 6967 6874 5f74 7970 657d 2720 6d75 7374  ight_type}' must
+0002c530: 2062 6520 2765 7272 272c 2027 6d65 6469   be 'err', 'medi
+0002c540: 616e 5f65 7272 272c 2022 290a 2020 2020  an_err', ").    
+0002c550: 2020 2020 7072 696e 7428 6622 2020 2020      print(f"    
+0002c560: 2020 2020 2027 6a77 7374 272c 206f 7220       'jwst', or 
+0002c570: 2774 696d 6527 3b20 6661 6c6c 696e 6720  'time'; falling 
+0002c580: 6261 636b 2074 6f20 2765 7272 272e 2229  back to 'err'.")
+0002c590: 0a20 2020 2020 2020 2077 6569 6768 745f  .        weight_
+0002c5a0: 7479 7065 203d 2027 6572 7227 0a20 2020  type = 'err'.   
+0002c5b0: 2020 2020 200a 2020 2020 6966 2069 7369       .    if isi
+0002c5c0: 6e73 7461 6e63 6528 6f75 7470 7574 2c20  nstance(output, 
+0002c5d0: 7079 7763 732e 5743 5329 3a0a 2020 2020  pywcs.WCS):.    
+0002c5e0: 2020 2020 6f75 7470 7574 7763 7320 3d20      outputwcs = 
+0002c5f0: 6f75 7470 7574 0a20 2020 2065 6c69 6620  output.    elif 
+0002c600: 6973 696e 7374 616e 6365 286f 7574 7075  isinstance(outpu
+0002c610: 742c 2070 7966 6974 732e 4865 6164 6572  t, pyfits.Header
+0002c620: 293a 0a20 2020 2020 2020 206f 7574 7075  ):.        outpu
+0002c630: 7477 6373 203d 2070 7977 6373 2e57 4353  twcs = pywcs.WCS
+0002c640: 286f 7574 7075 7429 0a20 2020 2065 6c69  (output).    eli
+0002c650: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+0002c660: 7075 742c 2050 7269 6d61 7279 4844 5529  put, PrimaryHDU)
+0002c670: 207c 2069 7369 6e73 7461 6e63 6528 6f75   | isinstance(ou
+0002c680: 7470 7574 2c20 496d 6167 6548 4455 293a  tput, ImageHDU):
+0002c690: 0a20 2020 2020 2020 206f 7574 7075 7477  .        outputw
+0002c6a0: 6373 203d 2070 7977 6373 2e57 4353 286f  cs = pywcs.WCS(o
+0002c6b0: 7574 7075 742e 6865 6164 6572 290a 2020  utput.header).  
+0002c6c0: 2020 656c 6966 206f 7574 7075 7420 6973    elif output is
+0002c6d0: 204e 6f6e 653a 0a20 2020 2020 2020 205f   None:.        _
+0002c6e0: 6864 7520 3d20 6d61 6b65 5f6d 6178 696d  hdu = make_maxim
+0002c6f0: 616c 5f77 6373 2866 696c 6573 3d76 6973  al_wcs(files=vis
+0002c700: 6974 5b27 6669 6c65 7327 5d2c 0a20 2020  it['files'],.   
+0002c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c720: 2020 2020 2020 2020 2020 2020 2070 6978               pix
+0002c730: 656c 5f73 6361 6c65 3d4e 6f6e 652c 0a20  el_scale=None,. 
+0002c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c750: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0002c760: 6574 5f68 6475 3d54 7275 652c 0a20 2020  et_hdu=True,.   
+0002c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c780: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+0002c790: 626f 7365 3d46 616c 7365 2c0a 2020 2020  bose=False,.    
+0002c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7b0: 2020 2020 2020 2020 2020 2020 7061 643d              pad=
+0002c7c0: 3429 0a20 2020 2020 2020 206f 7574 7075  4).        outpu
+0002c7d0: 7477 6373 203d 2070 7977 6373 2e57 4353  twcs = pywcs.WCS
+0002c7e0: 285f 6864 752e 6865 6164 6572 290a 2020  (_hdu.header).  
+0002c7f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002c800: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+0002c810: 0a20 2020 2069 6620 6e6f 7420 6861 7361  .    if not hasa
+0002c820: 7474 7228 6f75 7470 7574 7763 732c 2027  ttr(outputwcs, '
+0002c830: 5f6e 6178 6973 3127 293a 0a20 2020 2020  _naxis1'):.     
+0002c840: 2020 206f 7574 7075 7477 6373 2e5f 6e61     outputwcs._na
+0002c850: 7869 7331 2c20 6f75 7470 7574 7763 732e  xis1, outputwcs.
+0002c860: 5f6e 6178 6973 3220 3d20 6f75 7470 7574  _naxis2 = output
+0002c870: 7763 732e 5f6e 6178 6973 0a0a 2020 2020  wcs._naxis..    
+0002c880: 6f75 7470 7574 7763 732e 7073 6361 6c65  outputwcs.pscale
+0002c890: 203d 2067 6574 5f77 6373 5f70 7363 616c   = get_wcs_pscal
+0002c8a0: 6528 6f75 7470 7574 7763 7329 0a0a 2020  e(outputwcs)..  
+0002c8b0: 2020 6f75 7470 7574 5f70 6f6c 7920 3d20    output_poly = 
+0002c8c0: 506f 6c79 676f 6e28 6f75 7470 7574 7763  Polygon(outputwc
+0002c8d0: 732e 6361 6c63 5f66 6f6f 7470 7269 6e74  s.calc_footprint
+0002c8e0: 2829 290a 2020 2020 636f 756e 7420 3d20  ()).    count = 
+0002c8f0: 300a 0a20 2020 2072 6566 5f70 686f 7466  0..    ref_photf
+0002c900: 6c61 6d20 3d20 4e6f 6e65 0a20 2020 200a  lam = None.    .
+0002c910: 2020 2020 696e 6469 6365 7320 3d20 5b5d      indices = []
+0002c920: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+0002c930: 6e67 6528 6c65 6e28 7669 7369 745b 2766  nge(len(visit['f
+0002c940: 696c 6573 275d 2929 3a0a 2020 2020 2020  iles'])):.      
+0002c950: 2020 6966 2027 666f 6f74 7072 696e 7473    if 'footprints
+0002c960: 2720 696e 2076 6973 6974 3a0a 2020 2020  ' in visit:.    
+0002c970: 2020 2020 2020 2020 6f6c 6170 203d 2076          olap = v
+0002c980: 6973 6974 5b27 666f 6f74 7072 696e 7473  isit['footprints
+0002c990: 275d 5b69 5d2e 696e 7465 7273 6563 7469  '][i].intersecti
+0002c9a0: 6f6e 286f 7574 7075 745f 706f 6c79 290a  on(output_poly).
+0002c9b0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+0002c9c0: 6c61 702e 6172 6561 203e 2030 3a0a 2020  lap.area > 0:.  
+0002c9d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0002c9e0: 6469 6365 732e 6170 7065 6e64 2869 290a  dices.append(i).
+0002c9f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002ca00: 2020 2020 2020 2020 2020 696e 6469 6365            indice
+0002ca10: 732e 6170 7065 6e64 2869 290a 0a20 2020  s.append(i)..   
+0002ca20: 2069 6620 736b 6970 2069 7320 6e6f 7420   if skip is not 
+0002ca30: 4e6f 6e65 3a0a 2020 2020 2020 2020 696e  None:.        in
+0002ca40: 6469 6365 7320 3d20 696e 6469 6365 735b  dices = indices[
+0002ca50: 3a3a 736b 6970 5d0a 0a20 2020 204e 544f  ::skip]..    NTO
+0002ca60: 5441 4c20 3d20 6c65 6e28 696e 6469 6365  TAL = len(indice
+0002ca70: 7329 0a20 2020 200a 2020 2020 7763 735f  s).    .    wcs_
+0002ca80: 726f 7773 203d 205b 5d0a 2020 2020 7763  rows = [].    wc
+0002ca90: 735f 636f 6c6e 616d 6573 203d 204e 6f6e  s_colnames = Non
+0002caa0: 650a 2020 2020 7763 735f 6b65 7973 203d  e.    wcs_keys =
+0002cab0: 207b 7d0a 2020 2020 0a20 2020 2062 7064   {}.    .    bpd
+0002cac0: 6174 6120 3d20 300a 2020 2020 0a20 2020  ata = 0.    .   
+0002cad0: 2066 6f72 2069 2069 6e20 696e 6469 6365   for i in indice
+0002cae0: 733a 0a0a 2020 2020 2020 2020 6669 6c65  s:..        file
+0002caf0: 203d 2076 6973 6974 5b27 6669 6c65 7327   = visit['files'
+0002cb00: 5d5b 695d 0a0a 2020 2020 2020 2020 6d73  ][i]..        ms
+0002cb10: 6720 3d20 275c 6e28 7b30 3a34 647d 2f7b  g = '\n({0:4d}/{
+0002cb20: 313a 3464 7d29 2041 6464 2065 7870 6f73  1:4d}) Add expos
+0002cb30: 7572 6520 7b32 7d20 270a 2020 2020 2020  ure {2} '.      
+0002cb40: 2020 6d73 6720 2b3d 2027 2877 6569 6768    msg += '(weigh
+0002cb50: 745f 7479 7065 3d5c 277b 337d 5c27 2c20  t_type=\'{3}\', 
+0002cb60: 726e 6f69 7365 5f70 6572 6365 6e74 696c  rnoise_percentil
+0002cb70: 653d 7b34 7d29 5c6e 270a 2020 2020 2020  e={4})\n'.      
+0002cb80: 2020 6d73 6720 3d20 6d73 672e 666f 726d    msg = msg.form
+0002cb90: 6174 2863 6f75 6e74 2b31 2c20 4e54 4f54  at(count+1, NTOT
+0002cba0: 414c 2c20 6669 6c65 2c20 7765 6967 6874  AL, file, weight
+0002cbb0: 5f74 7970 652c 2072 6e6f 6973 655f 7065  _type, rnoise_pe
+0002cbc0: 7263 656e 7469 6c65 290a 2020 2020 2020  rcentile).      
+0002cbd0: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
+0002cbe0: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
+0002cbf0: 6f73 653d 7665 7262 6f73 6529 0a0a 2020  ose=verbose)..  
+0002cc00: 2020 2020 2020 6966 2064 7279 7275 6e3a        if dryrun:
+0002cc10: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0002cc20: 7469 6e75 650a 0a20 2020 2020 2020 2069  tinue..        i
+0002cc30: 6620 6e6f 7420 6f73 2e70 6174 682e 6578  f not os.path.ex
+0002cc40: 6973 7473 2866 696c 6529 3a0a 2020 2020  ists(file):.    
+0002cc50: 2020 2020 2020 2020 6275 636b 6574 5f69          bucket_i
+0002cc60: 203d 2076 6973 6974 5b27 6177 7370 6174   = visit['awspat
+0002cc70: 6827 5d5b 695d 2e73 706c 6974 2827 2f27  h'][i].split('/'
+0002cc80: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0002cc90: 2069 6620 6275 636b 6574 5f6e 616d 6520   if bucket_name 
+0002cca0: 213d 2062 7563 6b65 745f 693a 0a20 2020  != bucket_i:.   
+0002ccb0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
+0002ccc0: 6b65 745f 6e61 6d65 203d 2062 7563 6b65  ket_name = bucke
+0002ccd0: 745f 690a 2020 2020 2020 2020 2020 2020  t_i.            
+0002cce0: 2020 2020 626b 7420 3d20 7333 2e42 7563      bkt = s3.Buc
+0002ccf0: 6b65 7428 6275 636b 6574 5f6e 616d 6529  ket(bucket_name)
+0002cd00: 0a0a 2020 2020 2020 2020 2020 2020 7333  ..            s3
+0002cd10: 5f70 6174 6820 3d20 272f 272e 6a6f 696e  _path = '/'.join
+0002cd20: 2876 6973 6974 5b27 6177 7370 6174 6827  (visit['awspath'
+0002cd30: 5d5b 695d 2e73 706c 6974 2827 2f27 295b  ][i].split('/')[
+0002cd40: 313a 5d29 0a20 2020 2020 2020 2020 2020  1:]).           
+0002cd50: 2072 656d 6f74 655f 6669 6c65 203d 206f   remote_file = o
+0002cd60: 732e 7061 7468 2e6a 6f69 6e28 7333 5f70  s.path.join(s3_p
+0002cd70: 6174 682c 2066 696c 6529 0a0a 2020 2020  ath, file)..    
+0002cd80: 2020 2020 2020 2020 7072 696e 7428 2720          print(' 
+0002cd90: 2028 6665 7463 6820 6672 6f6d 2073 333a   (fetch from s3:
+0002cda0: 2f2f 7b30 7d2f 7b31 7d29 272e 666f 726d  //{0}/{1})'.form
+0002cdb0: 6174 2862 7563 6b65 745f 692c 2072 656d  at(bucket_i, rem
+0002cdc0: 6f74 655f 6669 6c65 2929 0a0a 2020 2020  ote_file))..    
+0002cdd0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002cde0: 2020 2020 2020 2020 2020 2020 2062 6b74               bkt
+0002cdf0: 2e64 6f77 6e6c 6f61 645f 6669 6c65 2872  .download_file(r
+0002ce00: 656d 6f74 655f 6669 6c65 2c20 6669 6c65  emote_file, file
+0002ce10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce30: 4578 7472 6141 7267 733d 7b22 5265 7175  ExtraArgs={"Requ
+0002ce40: 6573 7450 6179 6572 223a 2022 7265 7175  estPayer": "requ
+0002ce50: 6573 7465 7222 7d29 0a20 2020 2020 2020  ester"}).       
+0002ce60: 2020 2020 2065 7863 6570 7420 436c 6965       except Clie
+0002ce70: 6e74 4572 726f 723a 0a20 2020 2020 2020  ntError:.       
+0002ce80: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0002ce90: 2020 2866 6169 6c65 6420 7333 3a2f 2f7b    (failed s3://{
+0002cea0: 307d 2f7b 317d 2927 2e66 6f72 6d61 7428  0}/{1})'.format(
+0002ceb0: 6275 636b 6574 5f69 2c20 7265 6d6f 7465  bucket_i, remote
+0002cec0: 5f66 696c 6529 290a 2020 2020 2020 2020  _file)).        
+0002ced0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0002cee0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+0002cef0: 2020 2020 2020 2020 2020 2066 6c74 203d             flt =
+0002cf00: 2070 7966 6974 732e 6f70 656e 2866 696c   pyfits.open(fil
+0002cf10: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+0002cf20: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
+0002cf30: 2020 2020 2020 2070 7269 6e74 2866 276f         print(f'o
+0002cf40: 7065 6e28 7b66 696c 657d 2920 6661 696c  pen({file}) fail
+0002cf50: 6564 2127 290a 2020 2020 2020 2020 2020  ed!').          
+0002cf60: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0002cf70: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002cf80: 7363 695f 6c69 7374 2c20 7768 745f 6c69  sci_list, wht_li
+0002cf90: 7374 2c20 7763 735f 6c69 7374 203d 205b  st, wcs_list = [
+0002cfa0: 5d2c 205b 5d2c 205b 5d0a 2020 2020 2020  ], [], [].      
+0002cfb0: 2020 0a20 2020 2020 2020 206b 6579 7320    .        keys 
+0002cfc0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+0002cfd0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+0002cfe0: 205b 2745 5850 5449 4d45 272c 2027 5445   ['EXPTIME', 'TE
+0002cff0: 4c45 5343 4f50 272c 2027 4649 4c54 4552  LESCOP', 'FILTER
+0002d000: 272c 2746 494c 5445 5231 272c 2027 4649  ','FILTER1', 'FI
+0002d010: 4c54 4552 3227 2c20 0a20 2020 2020 2020  LTER2', .       
+0002d020: 2020 2020 2020 2020 2020 2027 5055 5049             'PUPI
+0002d030: 4c27 2c20 2744 4554 4543 544f 5227 2c20  L', 'DETECTOR', 
+0002d040: 2749 4e53 5452 554d 4527 2c20 2750 484f  'INSTRUME', 'PHO
+0002d050: 5446 4c41 4d27 2c20 2750 484f 5450 4c41  TFLAM', 'PHOTPLA
+0002d060: 4d27 2c20 0a20 2020 2020 2020 2020 2020  M', .           
+0002d070: 2020 2020 2020 2027 5048 4f54 464e 5527         'PHOTFNU'
+0002d080: 2c20 2750 484f 545a 5054 272c 2027 5048  , 'PHOTZPT', 'PH
+0002d090: 4f54 4257 272c 2027 5048 4f54 4d4f 4445  OTBW', 'PHOTMODE
+0002d0a0: 272c 2027 4558 5053 5441 5254 272c 200a  ', 'EXPSTART', .
+0002d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d0c0: 2020 2745 5850 454e 4427 2c20 2744 4154    'EXPEND', 'DAT
+0002d0d0: 452d 4f42 5327 2c20 2754 494d 452d 4f42  E-OBS', 'TIME-OB
+0002d0e0: 5327 2c0a 2020 2020 2020 2020 2020 2020  S',.            
+0002d0f0: 2020 2020 2020 2755 5044 415f 4354 5827        'UPDA_CTX'
+0002d100: 2c20 2743 5244 535f 4354 5827 2c20 2752  , 'CRDS_CTX', 'R
+0002d110: 5f44 4953 544f 5227 2c20 2752 5f50 484f  _DISTOR', 'R_PHO
+0002d120: 544f 4d27 2c20 2752 5f46 4c41 5427 5d3a  TOM', 'R_FLAT']:
+0002d130: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002d140: 6b20 696e 2066 6c74 5b30 5d2e 6865 6164  k in flt[0].head
+0002d150: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0002d160: 2020 2020 6b65 7973 5b6b 5d20 3d20 666c      keys[k] = fl
+0002d170: 745b 305d 2e68 6561 6465 725b 6b5d 0a20  t[0].header[k]. 
+0002d180: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002d190: 6270 6461 7461 203d 204e 6f6e 650a 2020  bpdata = None.  
+0002d1a0: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+0002d1b0: 6620 666c 745b 305d 2e68 6561 6465 725b  f flt[0].header[
+0002d1c0: 2754 454c 4553 434f 5027 5d20 696e 205b  'TELESCOP'] in [
+0002d1d0: 274a 5753 5427 5d3a 0a20 2020 2020 2020  'JWST']:.       
+0002d1e0: 2020 2020 2062 6974 7320 3d20 340a 2020       bits = 4.  
+0002d1f0: 2020 2020 2020 2020 2020 696e 636c 7564            includ
+0002d200: 655f 7361 7475 7261 7465 6420 3d20 4661  e_saturated = Fa
+0002d210: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0002d220: 0a20 2020 2020 2020 2020 2020 2023 6270  .            #bp
+0002d230: 6461 7461 203d 2030 0a20 2020 2020 2020  data = 0.       
+0002d240: 2020 2020 205f 696e 7374 203d 2066 6c74       _inst = flt
+0002d250: 5b30 5d2e 6865 6164 6572 5b27 494e 5354  [0].header['INST
+0002d260: 5255 4d45 275d 0a20 2020 2020 2020 2020  RUME'].         
+0002d270: 2020 2069 6620 2865 7874 7261 5f77 6663     if (extra_wfc
+0002d280: 3369 725f 6261 6470 6978 2920 2620 285f  3ir_badpix) & (_
+0002d290: 696e 7374 2069 6e20 5b27 4e49 5243 414d  inst in ['NIRCAM
+0002d2a0: 272c 274e 4952 4953 5327 5d29 3a0a 2020  ','NIRISS']):.  
+0002d2b0: 2020 2020 2020 2020 2020 2020 2020 5f64                _d
+0002d2c0: 6574 203d 2066 6c74 5b30 5d2e 6865 6164  et = flt[0].head
+0002d2d0: 6572 5b27 4445 5445 4354 4f52 275d 0a20  er['DETECTOR']. 
+0002d2e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0002d2f0: 7066 696c 6573 203d 205b 6f73 2e70 6174  pfiles = [os.pat
+0002d300: 682e 6a6f 696e 286f 732e 7061 7468 2e64  h.join(os.path.d
+0002d310: 6972 6e61 6d65 285f 5f66 696c 655f 5f29  irname(__file__)
+0002d320: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0002d330: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0002d340: 6461 7461 2f6e 7263 5f62 6164 7069 785f  data/nrc_badpix_
+0002d350: 3230 3233 3037 3130 5f7b 5f64 6574 7d2e  20230710_{_det}.
+0002d360: 6669 7473 2e67 7a27 295d 0a20 2020 2020  fits.gz')].     
+0002d370: 2020 2020 2020 2020 2020 2062 7066 696c             bpfil
+0002d380: 6573 202b 3d20 5b6f 732e 7061 7468 2e6a  es += [os.path.j
+0002d390: 6f69 6e28 6f73 2e70 6174 682e 6469 726e  oin(os.path.dirn
+0002d3a0: 616d 6528 5f5f 6669 6c65 5f5f 292c 200a  ame(__file__), .
 0002d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d3c0: 6270 6461 7461 203d 2070 7966 6974 732e  bpdata = pyfits.
-0002d3d0: 6f70 656e 2862 7066 696c 6529 5b30 5d2e  open(bpfile)[0].
-0002d3e0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0002d3f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0002d400: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-0002d410: 6627 5573 6520 6578 7472 6120 6261 6470  f'Use extra badp
-0002d420: 6978 2069 6e20 7b62 7066 696c 657d 270a  ix in {bpfile}'.
-0002d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d440: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
-0002d450: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
-0002d460: 653d 7665 7262 6f73 6529 0a20 2020 2020  e=verbose).     
-0002d470: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002d480: 2020 2020 2062 6974 7320 3d20 3634 2b33       bits = 64+3
-0002d490: 320a 2020 2020 2020 2020 2020 2020 6270  2.            bp
-0002d4a0: 6461 7461 203d 2030 0a20 2020 2020 2020  data = 0.       
-0002d4b0: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-0002d4c0: 2069 6e63 6c75 6465 5f73 6174 7572 6174   include_saturat
-0002d4d0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0002d4e0: 6269 7473 207c 3d20 3235 360a 0a20 2020  bits |= 256..   
-0002d4f0: 2020 2020 2069 6620 6b65 6570 5f62 6974       if keep_bit
-0002d500: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-0002d510: 2020 2020 2020 2020 2020 2062 6974 7320             bits 
-0002d520: 7c3d 206b 6565 705f 6269 7473 0a20 2020  |= keep_bits.   
-0002d530: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-0002d540: 2073 6361 6c65 5f70 686f 746f 6d3a 0a20   scale_photom:. 
-0002d550: 2020 2020 2020 2020 2020 205f 6b65 792c             _key,
-0002d560: 205f 7363 616c 655f 7068 6f74 6f6d 203d   _scale_photom =
-0002d570: 2067 6574 5f70 686f 746f 6d5f 7363 616c   get_photom_scal
-0002d580: 6528 666c 745b 305d 2e68 6561 6465 722c  e(flt[0].header,
-0002d590: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0002d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5c0: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
-0002d5d0: 626f 7365 290a 2020 2020 2020 2020 656c  bose).        el
-0002d5e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002d5f0: 5f73 6361 6c65 5f70 686f 746f 6d20 3d20  _scale_photom = 
-0002d600: 312e 300a 2020 2020 2020 2020 0a20 2020  1.0.        .   
-0002d610: 2020 2020 2069 6620 2750 484f 5446 4c41       if 'PHOTFLA
-0002d620: 4d27 2069 6e20 6b65 7973 3a0a 2020 2020  M' in keys:.    
-0002d630: 2020 2020 2020 2020 6d73 6720 3d20 2720          msg = ' 
-0002d640: 2030 2020 2020 5048 4f54 464c 414d 3d7b   0    PHOTFLAM={
-0002d650: 303a 2e32 657d 2c20 7363 616c 653d 7b31  0:.2e}, scale={1
-0002d660: 3a2e 3366 7d27 0a20 2020 2020 2020 2020  :.3f}'.         
-0002d670: 2020 206d 7367 203d 206d 7367 2e66 6f72     msg = msg.for
-0002d680: 6d61 7428 6b65 7973 5b27 5048 4f54 464c  mat(keys['PHOTFL
-0002d690: 414d 275d 2c20 5f73 6361 6c65 5f70 686f  AM'], _scale_pho
-0002d6a0: 746f 6d29 0a20 2020 2020 2020 2020 2020  tom).           
-0002d6b0: 206c 6f67 5f63 6f6d 6d65 6e74 284c 4f47   log_comment(LOG
-0002d6c0: 4649 4c45 2c20 6d73 672c 2076 6572 626f  FILE, msg, verbo
-0002d6d0: 7365 3d76 6572 626f 7365 290a 2020 2020  se=verbose).    
-0002d6e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002d6f0: 2020 2020 2069 6620 7265 665f 7068 6f74       if ref_phot
-0002d700: 666c 616d 2069 7320 4e6f 6e65 3a0a 2020  flam is None:.  
-0002d710: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002d720: 665f 7068 6f74 666c 616d 203d 206b 6579  f_photflam = key
-0002d730: 735b 2750 484f 5446 4c41 4d27 5d0a 2020  s['PHOTFLAM'].  
-0002d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d750: 2020 0a20 2020 2020 2020 2066 6f72 2065    .        for e
-0002d760: 7874 2069 6e20 5b31 2c20 322c 2033 2c20  xt in [1, 2, 3, 
-0002d770: 345d 3a0a 2020 2020 2020 2020 2020 2020  4]:.            
-0002d780: 6966 2028 2753 4349 272c 2065 7874 2920  if ('SCI', ext) 
-0002d790: 696e 2066 6c74 3a0a 0a20 2020 2020 2020  in flt:..       
-0002d7a0: 2020 2020 2020 2020 2068 203d 2066 6c74           h = flt
-0002d7b0: 5b28 2753 4349 272c 2065 7874 295d 2e68  [('SCI', ext)].h
-0002d7c0: 6561 6465 720a 2020 2020 2020 2020 2020  eader.          
-0002d7d0: 2020 2020 2020 6966 2027 4d44 5249 5a53        if 'MDRIZS
-0002d7e0: 4b59 2720 696e 2068 3a0a 2020 2020 2020  KY' in h:.      
-0002d7f0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
-0002d800: 795f 7661 6c75 6520 3d20 685b 274d 4452  y_value = h['MDR
-0002d810: 495a 534b 5927 5d0a 2020 2020 2020 2020  IZSKY'].        
-0002d820: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d840: 2020 736b 795f 7661 6c75 6520 3d20 300a    sky_value = 0.
-0002d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d870: 2069 6620 2827 424b 4727 2c65 7874 2920   if ('BKG',ext) 
-0002d880: 696e 2066 6c74 3a0a 2020 2020 2020 2020  in flt:.        
-0002d890: 2020 2020 2020 2020 2020 2020 6861 735f              has_
-0002d8a0: 626b 6720 3d20 5472 7565 0a20 2020 2020  bkg = True.     
-0002d8b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002d8c0: 6b79 203d 2066 6c74 5b27 424b 4727 2c65  ky = flt['BKG',e
-0002d8d0: 7874 5d2e 6461 7461 202b 2073 6b79 5f76  xt].data + sky_v
-0002d8e0: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-0002d8f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002d900: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0002d910: 6173 5f62 6b67 203d 2046 616c 7365 0a20  as_bkg = False. 
-0002d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d930: 2020 2073 6b79 203d 2073 6b79 5f76 616c     sky = sky_val
-0002d940: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-0002d950: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002d960: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
-0002d970: 2020 6578 7420 2853 4349 2c7b 6578 747d    ext (SCI,{ext}
-0002d980: 292c 2073 6b79 3d7b 736b 795f 7661 6c75  ), sky={sky_valu
-0002d990: 653a 2e33 667d 270a 2020 2020 2020 2020  e:.3f}'.        
-0002d9a0: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
-0002d9b0: 2720 6861 735f 626b 673a 7b68 6173 5f62  ' has_bkg:{has_b
-0002d9c0: 6b67 7d27 0a20 2020 2020 2020 2020 2020  kg}'.           
-0002d9d0: 2020 2020 206c 6f67 5f63 6f6d 6d65 6e74       log_comment
-0002d9e0: 284c 4f47 4649 4c45 2c20 6d73 672c 2076  (LOGFILE, msg, v
-0002d9f0: 6572 626f 7365 3d76 6572 626f 7365 290a  erbose=verbose).
-0002da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002da20: 2069 6620 685b 2742 554e 4954 275d 203d   if h['BUNIT'] =
-0002da30: 3d20 2745 4c45 4354 524f 4e53 273a 0a20  = 'ELECTRONS':. 
-0002da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da50: 2020 2074 6f5f 7065 725f 7365 6320 3d20     to_per_sec = 
-0002da60: 312e 2f6b 6579 735b 2745 5850 5449 4d45  1./keys['EXPTIME
-0002da70: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-0002da80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002da90: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
-0002daa0: 7065 725f 7365 6320 3d20 312e 0a0a 2020  per_sec = 1...  
-0002dab0: 2020 2020 2020 2020 2020 2020 2020 7068                ph
-0002dac0: 6f74 5f73 6361 6c65 203d 2074 6f5f 7065  ot_scale = to_pe
-0002dad0: 725f 7365 6320 2a20 5f73 6361 6c65 5f70  r_sec * _scale_p
-0002dae0: 686f 746f 6d0a 0a20 2020 2020 2020 2020  hotom..         
-0002daf0: 2020 2020 2020 2069 6620 2750 484f 5446         if 'PHOTF
-0002db00: 4c41 4d27 2069 6e20 683a 0a20 2020 2020  LAM' in h:.     
-0002db10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002db20: 6620 7265 665f 7068 6f74 666c 616d 2069  f ref_photflam i
-0002db30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0002db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002db50: 7265 665f 7068 6f74 666c 616d 203d 2068  ref_photflam = h
-0002db60: 5b27 5048 4f54 464c 414d 275d 0a0a 2020  ['PHOTFLAM']..  
-0002db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002db80: 2020 7068 6f74 5f73 6361 6c65 203d 2068    phot_scale = h
-0002db90: 5b27 5048 4f54 464c 414d 275d 202f 2072  ['PHOTFLAM'] / r
-0002dba0: 6566 5f70 686f 7466 6c61 6d20 2a20 5f73  ef_photflam * _s
-0002dbb0: 6361 6c65 5f70 686f 746f 6d0a 2020 2020  cale_photom.    
-0002dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002dbe0: 2020 2020 2069 6620 2750 484f 5446 4e55       if 'PHOTFNU
-0002dbf0: 2720 6e6f 7420 696e 2068 3a0a 2020 2020  ' not in h:.    
-0002dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc10: 2020 2020 685b 2750 484f 5446 4e55 275d      h['PHOTFNU']
-0002dc20: 203d 2028 7068 6f74 666e 755f 6672 6f6d   = (photfnu_from
-0002dc30: 5f70 686f 7466 6c61 6d28 685b 2750 484f  _photflam(h['PHO
-0002dc40: 5446 4c41 4d27 5d2c 0a20 2020 2020 2020  TFLAM'],.       
-0002dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc80: 2020 2020 2020 685b 2750 484f 5450 4c41        h['PHOTPLA
-0002dc90: 4d27 5d29 2c20 0a20 2020 2020 2020 2020  M']), .         
-0002dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dcb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002dcc0: 496e 7665 7273 6520 7365 6e73 6974 6976  Inverse sensitiv
-0002dcd0: 6974 792c 204a 792f 444e 2729 0a20 2020  ity, Jy/DN').   
-0002dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd10: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0002dd20: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002dd30: 7367 203d 2027 2020 2020 2020 2050 484f  sg = '       PHO
-0002dd40: 5446 4c41 4d3d 7b30 3a2e 3265 7d2c 2073  TFLAM={0:.2e}, s
-0002dd50: 6361 6c65 3d7b 313a 2e33 667d 270a 2020  cale={1:.3f}'.  
-0002dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd70: 2020 6d73 6720 3d20 6d73 672e 666f 726d    msg = msg.form
-0002dd80: 6174 2868 5b27 5048 4f54 464c 414d 275d  at(h['PHOTFLAM']
-0002dd90: 2c20 7068 6f74 5f73 6361 6c65 290a 2020  , phot_scale).  
-0002dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ddb0: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
-0002ddc0: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
-0002ddd0: 6f73 653d 7665 7262 6f73 6529 0a20 2020  ose=verbose).   
-0002dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ddf0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0002de00: 2020 2020 2020 6b65 7973 5b27 5048 4f54        keys['PHOT
-0002de10: 464c 414d 275d 203d 2068 5b27 5048 4f54  FLAM'] = h['PHOT
-0002de20: 464c 414d 275d 0a20 2020 2020 2020 2020  FLAM'].         
-0002de30: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-0002de40: 2069 6e20 5b27 5048 4f54 464c 414d 272c   in ['PHOTFLAM',
-0002de50: 2027 5048 4f54 504c 414d 272c 2027 5048   'PHOTPLAM', 'PH
-0002de60: 4f54 464e 5527 2c0a 2020 2020 2020 2020  OTFNU',.        
-0002de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de80: 2020 2020 2020 2750 484f 545a 5054 272c        'PHOTZPT',
-0002de90: 2027 5048 4f54 4257 272c 2027 5048 4f54   'PHOTBW', 'PHOT
-0002dea0: 4d4f 4445 272c 0a20 2020 2020 2020 2020  MODE',.         
-0002deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dec0: 2020 2020 2027 5048 4f54 4d4a 5352 272c       'PHOTMJSR',
-0002ded0: 2027 5049 5841 525f 5352 275d 3a0a 2020   'PIXAR_SR']:.  
-0002dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002def0: 2020 2020 2020 6966 206b 2069 6e20 683a        if k in h:
-0002df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002df10: 2020 2020 2020 2020 2020 2020 206b 6579               key
-0002df20: 735b 6b5d 203d 2068 5b6b 5d0a 0a20 2020  s[k] = h[k]..   
-0002df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df40: 2070 686f 745f 7363 616c 6520 2a3d 2074   phot_scale *= t
-0002df50: 6f5f 7065 725f 7365 630a 2020 2020 2020  o_per_sec.      
-0002df60: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-0002df70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002df80: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002df90: 2020 2020 2020 2020 7763 735f 6920 3d20          wcs_i = 
-0002dfa0: 7079 7763 732e 5743 5328 6865 6164 6572  pywcs.WCS(header
-0002dfb0: 3d66 6c74 5b28 2753 4349 272c 2065 7874  =flt[('SCI', ext
-0002dfc0: 295d 2e68 6561 6465 722c 200a 2020 2020  )].header, .    
-0002dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dff0: 2020 666f 626a 3d66 6c74 290a 2020 2020    fobj=flt).    
-0002e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e010: 7763 735f 692e 7073 6361 6c65 203d 2067  wcs_i.pscale = g
-0002e020: 6574 5f77 6373 5f70 7363 616c 6528 7763  et_wcs_pscale(wc
-0002e030: 735f 6929 0a20 2020 2020 2020 2020 2020  s_i).           
-0002e040: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-0002e050: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0002e060: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002e070: 6627 4661 696c 6564 2074 6f20 696e 6974  f'Failed to init
-0002e080: 6961 6c69 7a65 2057 4353 206f 6e20 7b66  ialize WCS on {f
-0002e090: 696c 657d 5b53 4349 2c7b 6578 747d 5d27  ile}[SCI,{ext}]'
-0002e0a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002e0b0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0002e0c0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0002e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0e0: 7763 7368 203d 2074 6f5f 6865 6164 6572  wcsh = to_header
-0002e0f0: 2877 6373 5f69 290a 2020 2020 2020 2020  (wcs_i).        
-0002e100: 2020 2020 2020 2020 726f 7720 3d20 5b66          row = [f
-0002e110: 696c 652c 2065 7874 2c20 6b65 7973 5b27  ile, ext, keys['
-0002e120: 4558 5054 494d 4527 5d5d 0a20 2020 2020  EXPTIME']].     
-0002e130: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0002e140: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-0002e150: 6373 5f63 6f6c 6e61 6d65 7320 6973 204e  cs_colnames is N
-0002e160: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002e170: 2020 2020 2020 2020 2077 6373 5f63 6f6c           wcs_col
-0002e180: 6e61 6d65 7320 3d20 5b27 6669 6c65 272c  names = ['file',
-0002e190: 2765 7874 272c 2765 7870 7469 6d65 275d  'ext','exptime']
-0002e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e1b0: 2020 2020 2066 6f72 206b 2069 6e20 7763       for k in wc
-0002e1c0: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
-0002e1d0: 2020 2020 2020 2020 2020 2020 7763 735f              wcs_
-0002e1e0: 636f 6c6e 616d 6573 2e61 7070 656e 6428  colnames.append(
-0002e1f0: 6b2e 6c6f 7765 7228 2929 0a20 2020 2020  k.lower()).     
-0002e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e210: 2020 2077 6373 5f6b 6579 735b 6b2e 6c6f     wcs_keys[k.lo
-0002e220: 7765 7228 295d 203d 2077 6373 685b 6b5d  wer()] = wcsh[k]
-0002e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e240: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0002e250: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
-0002e260: 696e 2077 6373 5f63 6f6c 6e61 6d65 735b  in wcs_colnames[
-0002e270: 333a 5d3a 0a20 2020 2020 2020 2020 2020  3:]:.           
-0002e280: 2020 2020 2020 2020 206b 7520 3d20 6b2e           ku = k.
-0002e290: 7570 7065 7228 290a 2020 2020 2020 2020  upper().        
-0002e2a0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-0002e2b0: 7520 6e6f 7420 696e 2077 6373 683a 0a20  u not in wcsh:. 
-0002e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e2d0: 2020 2020 2020 2070 7269 6e74 2866 274b         print(f'K
-0002e2e0: 6579 776f 7264 207b 6b75 7d20 6e6f 7420  eyword {ku} not 
-0002e2f0: 666f 756e 6420 696e 2057 4353 2068 6561  found in WCS hea
-0002e300: 6465 7227 290a 2020 2020 2020 2020 2020  der').          
-0002e310: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-0002e320: 772e 6170 7065 6e64 2877 6373 5f6b 6579  w.append(wcs_key
-0002e330: 735b 6b5d 2a30 290a 2020 2020 2020 2020  s[k]*0).        
-0002e340: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002e350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e360: 2020 2020 2020 2020 2020 726f 772e 6170            row.ap
-0002e370: 7065 6e64 2877 6373 685b 6b75 5d29 0a20  pend(wcsh[ku]). 
-0002e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e390: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002e3a0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-0002e3b0: 2077 6373 683a 0a20 2020 2020 2020 2020   wcsh:.         
-0002e3c0: 2020 2020 2020 2020 2020 2069 6620 6b2e             if k.
-0002e3d0: 6c6f 7765 7228 2920 6e6f 7420 696e 2077  lower() not in w
-0002e3e0: 6373 5f63 6f6c 6e61 6d65 733a 0a20 2020  cs_colnames:.   
+0002d3c0: 2020 2020 2020 2020 2020 2066 2764 6174             f'dat
+0002d3d0: 612f 7b5f 6465 742e 6c6f 7765 7228 297d  a/{_det.lower()}
+0002d3e0: 5f62 6164 7069 785f 3230 3233 3037 3130  _badpix_20230710
+0002d3f0: 2e66 6974 732e 677a 2729 5d20 2320 4e49  .fits.gz')] # NI
+0002d400: 5249 5353 0a20 2020 2020 2020 2020 2020  RISS.           
+0002d410: 2020 2020 2062 7066 696c 6573 202b 3d20       bpfiles += 
+0002d420: 5b6f 732e 7061 7468 2e6a 6f69 6e28 6f73  [os.path.join(os
+0002d430: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
+0002d440: 6669 6c65 5f5f 292c 200a 2020 2020 2020  file__), .      
+0002d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d460: 2020 2020 2066 2764 6174 612f 6e72 635f       f'data/nrc_
+0002d470: 6261 6470 6978 5f32 3330 3730 315f 7b5f  badpix_230701_{_
+0002d480: 6465 747d 2e66 6974 732e 677a 2729 5d0a  det}.fits.gz')].
+0002d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d4a0: 6270 6669 6c65 7320 2b3d 205b 6f73 2e70  bpfiles += [os.p
+0002d4b0: 6174 682e 6a6f 696e 286f 732e 7061 7468  ath.join(os.path
+0002d4c0: 2e64 6972 6e61 6d65 285f 5f66 696c 655f  .dirname(__file_
+0002d4d0: 5f29 2c0a 2020 2020 2020 2020 2020 2020  _),.            
+0002d4e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002d4f0: 2764 6174 612f 6e72 635f 6261 6470 6978  'data/nrc_badpix
+0002d500: 5f32 3330 3132 305f 7b5f 6465 747d 2e66  _230120_{_det}.f
+0002d510: 6974 732e 677a 2729 5d0a 2020 2020 2020  its.gz')].      
+0002d520: 2020 2020 2020 2020 2020 6270 6669 6c65            bpfile
+0002d530: 7320 2b3d 205b 6f73 2e70 6174 682e 6a6f  s += [os.path.jo
+0002d540: 696e 286f 732e 7061 7468 2e64 6972 6e61  in(os.path.dirna
+0002d550: 6d65 285f 5f66 696c 655f 5f29 2c20 0a20  me(__file__), . 
+0002d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d570: 2020 2020 2020 2020 2020 6627 6461 7461            f'data
+0002d580: 2f6e 7263 5f6c 6f77 7069 785f 3039 3136  /nrc_lowpix_0916
+0002d590: 5f7b 5f64 6574 7d2e 6669 7473 2e67 7a27  _{_det}.fits.gz'
+0002d5a0: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
+0002d5b0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0002d5c0: 2020 2020 666f 7220 6270 6669 6c65 2069      for bpfile i
+0002d5d0: 6e20 6270 6669 6c65 733a 0a20 2020 2020  n bpfiles:.     
+0002d5e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002d5f0: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+0002d600: 2862 7066 696c 6529 3a0a 2020 2020 2020  (bpfile):.      
+0002d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d620: 2020 6270 6461 7461 203d 2070 7966 6974    bpdata = pyfit
+0002d630: 732e 6f70 656e 2862 7066 696c 6529 5b30  s.open(bpfile)[0
+0002d640: 5d2e 6461 7461 0a20 2020 2020 2020 2020  ].data.         
+0002d650: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002d660: 6620 5472 7565 3a0a 2020 2020 2020 2020  f True:.        
+0002d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d680: 2020 2020 6270 6461 7461 203d 206e 642e      bpdata = nd.
+0002d690: 6269 6e61 7279 5f64 696c 6174 696f 6e28  binary_dilation(
+0002d6a0: 6270 6461 7461 203e 2030 292a 3130 3234  bpdata > 0)*1024
+0002d6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d6c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6e0: 2020 2020 2020 2020 2020 2062 7064 6174             bpdat
+0002d6f0: 6120 3d20 2862 7064 6174 6120 3e20 3029  a = (bpdata > 0)
+0002d700: 2a31 3032 340a 2020 2020 2020 2020 2020  *1024.          
+0002d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d720: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0002d730: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+0002d740: 2066 2755 7365 2065 7874 7261 2062 6164   f'Use extra bad
+0002d750: 7069 7820 696e 207b 6270 6669 6c65 7d27  pix in {bpfile}'
+0002d760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d770: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
+0002d780: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
+0002d790: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
+0002d7a0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0002d7b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0002d7c0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+0002d7d0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0002d7e0: 2020 2020 2020 2069 6620 6270 6461 7461         if bpdata
+0002d7f0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0002d800: 2020 2020 2020 2020 2020 6270 6461 7461            bpdata
+0002d810: 203d 206e 702e 7a65 726f 7328 666c 745b   = np.zeros(flt[
+0002d820: 2753 4349 275d 2e64 6174 612e 7368 6170  'SCI'].data.shap
+0002d830: 652c 2064 7479 7065 3d69 6e74 290a 2020  e, dtype=int).  
+0002d840: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0002d850: 2020 2020 2020 2069 6620 6765 745f 6462         if get_db
+0002d860: 6d61 736b 3a0a 2020 2020 2020 2020 2020  mask:.          
+0002d870: 2020 2020 2020 6462 6d61 736b 203d 2061        dbmask = a
+0002d880: 7070 6c79 5f72 6567 696f 6e5f 6d61 736b  pply_region_mask
+0002d890: 5f66 726f 6d5f 6462 286f 732e 7061 7468  _from_db(os.path
+0002d8a0: 2e62 6173 656e 616d 6528 6669 6c65 292c  .basename(file),
+0002d8b0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d8e0: 2020 2020 2069 6e5f 706c 6163 653d 4661       in_place=Fa
+0002d8f0: 6c73 652c 2076 6572 626f 7365 3d54 7275  lse, verbose=Tru
+0002d900: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002d910: 2020 2069 6620 6462 6d61 736b 2069 7320     if dbmask is 
+0002d920: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0002d930: 2020 2020 2020 2020 2020 2020 2020 6270                bp
+0002d940: 6461 7461 207c 3d20 6462 6d61 736b 2a31  data |= dbmask*1
+0002d950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d960: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0002d970: 2020 2320 4e49 5249 5353 2067 686f 7374    # NIRISS ghost
+0002d980: 206d 6173 6b0a 2020 2020 2020 2020 2020   mask.          
+0002d990: 2020 6966 2028 5f69 6e73 7420 696e 205b    if (_inst in [
+0002d9a0: 274e 4952 4953 5327 5d29 2026 2028 6e69  'NIRISS']) & (ni
+0002d9b0: 7269 7373 5f67 686f 7374 5f6b 7761 7267  riss_ghost_kwarg
+0002d9c0: 7320 6973 206e 6f74 204e 6f6e 6529 3a0a  s is not None):.
+0002d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d9e0: 6966 2027 7665 7262 6f73 6527 206e 6f74  if 'verbose' not
+0002d9f0: 2069 6e20 6e69 7269 7373 5f67 686f 7374   in niriss_ghost
+0002da00: 5f6b 7761 7267 733a 0a20 2020 2020 2020  _kwargs:.       
+0002da10: 2020 2020 2020 2020 2020 2020 206e 6972               nir
+0002da20: 6973 735f 6768 6f73 745f 6b77 6172 6773  iss_ghost_kwargs
+0002da30: 5b27 7665 7262 6f73 6527 5d20 3d20 7665  ['verbose'] = ve
+0002da40: 7262 6f73 650a 2020 2020 2020 2020 2020  rbose.          
+0002da50: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002da60: 2020 2020 2020 205f 6768 6f73 7420 3d20         _ghost = 
+0002da70: 6e69 7269 7373 5f67 686f 7374 5f6d 6173  niriss_ghost_mas
+0002da80: 6b28 666c 742c 202a 2a6e 6972 6973 735f  k(flt, **niriss_
+0002da90: 6768 6f73 745f 6b77 6172 6773 290a 2020  ghost_kwargs).  
+0002daa0: 2020 2020 2020 2020 2020 2020 2020 6270                bp
+0002dab0: 6461 7461 207c 3d20 5f67 686f 7374 2a31  data |= _ghost*1
+0002dac0: 3032 340a 2020 2020 2020 2020 2020 2020  024.            
+0002dad0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0002dae0: 6567 6174 6976 650a 2020 2020 2020 2020  egative.        
+0002daf0: 2020 2020 6966 2027 4d44 5249 5a53 4b59      if 'MDRIZSKY
+0002db00: 2720 696e 2066 6c74 5b27 5343 4927 5d2e  ' in flt['SCI'].
+0002db10: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+0002db20: 2020 2020 2020 2020 5f6c 6f77 203d 2028          _low = (
+0002db30: 2866 6c74 5b27 5343 4927 5d2e 6461 7461  (flt['SCI'].data
+0002db40: 202d 2066 6c74 5b27 5343 4927 5d2e 6865   - flt['SCI'].he
+0002db50: 6164 6572 5b27 4d44 5249 5a53 4b59 275d  ader['MDRIZSKY']
+0002db60: 2920 3c20 0a20 2020 2020 2020 2020 2020  ) < .           
+0002db70: 2020 2020 2020 2020 2020 202d 352a 666c             -5*fl
+0002db80: 745b 2745 5252 275d 2e64 6174 6129 0a20  t['ERR'].data). 
+0002db90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002dba0: 7367 203d 2066 2745 7874 7261 202d 3520  sg = f'Extra -5 
+0002dbb0: 7369 676d 6120 6c6f 7720 7069 7865 6c73  sigma low pixels
+0002dbc0: 3a20 4e3d 207b 5f6c 6f77 2e73 756d 2829  : N= {_low.sum()
+0002dbd0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0002dbe0: 2020 2020 6d73 6720 2b3d 2066 2720 2820      msg += f' ( 
+0002dbf0: 7b5f 6c6f 772e 7375 6d28 292f 5f6c 6f77  {_low.sum()/_low
+0002dc00: 2e73 697a 652a 3130 303a 2e31 7d20 2529  .size*100:.1} %)
+0002dc10: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0002dc20: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
+0002dc30: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
+0002dc40: 6f73 653d 7665 7262 6f73 6529 0a20 2020  ose=verbose).   
+0002dc50: 2020 2020 2020 2020 2020 2020 2062 7064               bpd
+0002dc60: 6174 6120 7c3d 205f 6c6f 772a 3130 3234  ata |= _low*1024
+0002dc70: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+0002dc80: 2020 2020 2020 656c 6966 2066 6c74 5b30        elif flt[0
+0002dc90: 5d2e 6865 6164 6572 5b27 4445 5445 4354  ].header['DETECT
+0002dca0: 4f52 275d 203d 3d20 2749 5227 3a0a 2020  OR'] == 'IR':.  
+0002dcb0: 2020 2020 2020 2020 2020 6269 7473 203d            bits =
+0002dcc0: 2035 3736 0a20 2020 2020 2020 2020 2020   576.           
+0002dcd0: 2069 6620 6578 7472 615f 7766 6333 6972   if extra_wfc3ir
+0002dce0: 5f62 6164 7069 783a 0a20 2020 2020 2020  _badpix:.       
+0002dcf0: 2020 2020 2020 2020 2069 6620 2869 203d           if (i =
+0002dd00: 3d20 696e 6469 6365 735b 305d 2920 7c20  = indices[0]) | 
+0002dd10: 286e 6f74 2068 6173 6174 7472 2862 7064  (not hasattr(bpd
+0002dd20: 6174 612c 2027 7368 6170 6527 2929 3a0a  ata, 'shape')):.
+0002dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd40: 2020 2020 6270 6669 6c65 203d 206f 732e      bpfile = os.
+0002dd50: 7061 7468 2e6a 6f69 6e28 6f73 2e70 6174  path.join(os.pat
+0002dd60: 682e 6469 726e 616d 6528 5f5f 6669 6c65  h.dirname(__file
+0002dd70: 5f5f 292c 200a 2020 2020 2020 2020 2020  __), .          
+0002dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd90: 2020 2020 2027 6461 7461 2f77 6663 3369       'data/wfc3i
+0002dda0: 725f 6261 6470 6978 5f73 7061 7273 3230  r_badpix_spars20
+0002ddb0: 305f 3232 2e30 332e 3331 2e66 6974 732e  0_22.03.31.fits.
+0002ddc0: 677a 2729 0a20 2020 2020 2020 2020 2020  gz').           
+0002ddd0: 2020 2020 2020 2020 2062 7064 6174 6120           bpdata 
+0002dde0: 3d20 7079 6669 7473 2e6f 7065 6e28 6270  = pyfits.open(bp
+0002ddf0: 6669 6c65 295b 305d 2e64 6174 610a 2020  file)[0].data.  
+0002de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de10: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0002de20: 2020 206d 7367 203d 2066 2755 7365 2065     msg = f'Use e
+0002de30: 7874 7261 2062 6164 7069 7820 696e 207b  xtra badpix in {
+0002de40: 6270 6669 6c65 7d27 0a20 2020 2020 2020  bpfile}'.       
+0002de50: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
+0002de60: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
+0002de70: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
+0002de80: 7365 290a 2020 2020 2020 2020 656c 7365  se).        else
+0002de90: 3a0a 2020 2020 2020 2020 2020 2020 6269  :.            bi
+0002dea0: 7473 203d 2036 342b 3332 0a20 2020 2020  ts = 64+32.     
+0002deb0: 2020 2020 2020 2062 7064 6174 6120 3d20         bpdata = 
+0002dec0: 300a 2020 2020 2020 2020 2020 2020 0a20  0.            . 
+0002ded0: 2020 2020 2020 2069 6620 696e 636c 7564         if includ
+0002dee0: 655f 7361 7475 7261 7465 643a 0a20 2020  e_saturated:.   
+0002def0: 2020 2020 2020 2020 2062 6974 7320 7c3d           bits |=
+0002df00: 2032 3536 0a0a 2020 2020 2020 2020 6966   256..        if
+0002df10: 206b 6565 705f 6269 7473 2069 7320 6e6f   keep_bits is no
+0002df20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0002df30: 2020 2020 6269 7473 207c 3d20 6b65 6570      bits |= keep
+0002df40: 5f62 6974 730a 2020 2020 2020 2020 0a20  _bits.        . 
+0002df50: 2020 2020 2020 2069 6620 7363 616c 655f         if scale_
+0002df60: 7068 6f74 6f6d 3a0a 2020 2020 2020 2020  photom:.        
+0002df70: 2020 2020 5f6b 6579 2c20 5f73 6361 6c65      _key, _scale
+0002df80: 5f70 686f 746f 6d20 3d20 6765 745f 7068  _photom = get_ph
+0002df90: 6f74 6f6d 5f73 6361 6c65 2866 6c74 5b30  otom_scale(flt[0
+0002dfa0: 5d2e 6865 6164 6572 2c20 0a20 2020 2020  ].header, .     
+0002dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dfd0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+0002dfe0: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
+0002dff0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002e000: 2020 2020 2020 2020 205f 7363 616c 655f           _scale_
+0002e010: 7068 6f74 6f6d 203d 2031 2e30 0a20 2020  photom = 1.0.   
+0002e020: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+0002e030: 2027 5048 4f54 464c 414d 2720 696e 206b   'PHOTFLAM' in k
+0002e040: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+0002e050: 206d 7367 203d 2027 2020 3020 2020 2050   msg = '  0    P
+0002e060: 484f 5446 4c41 4d3d 7b30 3a2e 3265 7d2c  HOTFLAM={0:.2e},
+0002e070: 2073 6361 6c65 3d7b 313a 2e33 667d 270a   scale={1:.3f}'.
+0002e080: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0002e090: 3d20 6d73 672e 666f 726d 6174 286b 6579  = msg.format(key
+0002e0a0: 735b 2750 484f 5446 4c41 4d27 5d2c 205f  s['PHOTFLAM'], _
+0002e0b0: 7363 616c 655f 7068 6f74 6f6d 290a 2020  scale_photom).  
+0002e0c0: 2020 2020 2020 2020 2020 6c6f 675f 636f            log_co
+0002e0d0: 6d6d 656e 7428 4c4f 4746 494c 452c 206d  mment(LOGFILE, m
+0002e0e0: 7367 2c20 7665 7262 6f73 653d 7665 7262  sg, verbose=verb
+0002e0f0: 6f73 6529 0a20 2020 2020 2020 2020 2020  ose).           
+0002e100: 200a 2020 2020 2020 2020 2020 2020 6966   .            if
+0002e110: 2072 6566 5f70 686f 7466 6c61 6d20 6973   ref_photflam is
+0002e120: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0002e130: 2020 2020 2020 2072 6566 5f70 686f 7466         ref_photf
+0002e140: 6c61 6d20 3d20 6b65 7973 5b27 5048 4f54  lam = keys['PHOT
+0002e150: 464c 414d 275d 0a20 2020 2020 2020 200a  FLAM'].        .
+0002e160: 2020 2020 2020 2020 6d65 6469 616e 5f77          median_w
+0002e170: 6569 6768 7420 3d20 4e6f 6e65 0a20 2020  eight = None.   
+0002e180: 2020 2020 200a 2020 2020 2020 2020 666f       .        fo
+0002e190: 7220 6578 7420 696e 205b 312c 2032 2c20  r ext in [1, 2, 
+0002e1a0: 332c 2034 5d3a 0a20 2020 2020 2020 2020  3, 4]:.         
+0002e1b0: 2020 2069 6620 2827 5343 4927 2c20 6578     if ('SCI', ex
+0002e1c0: 7429 2069 6e20 666c 743a 0a0a 2020 2020  t) in flt:..    
+0002e1d0: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
+0002e1e0: 666c 745b 2827 5343 4927 2c20 6578 7429  flt[('SCI', ext)
+0002e1f0: 5d2e 6865 6164 6572 0a20 2020 2020 2020  ].header.       
+0002e200: 2020 2020 2020 2020 2069 6620 274d 4452           if 'MDR
+0002e210: 495a 534b 5927 2069 6e20 683a 0a20 2020  IZSKY' in h:.   
+0002e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e230: 2073 6b79 5f76 616c 7565 203d 2068 5b27   sky_value = h['
+0002e240: 4d44 5249 5a53 4b59 275d 0a20 2020 2020  MDRIZSKY'].     
+0002e250: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002e260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e270: 2020 2020 2073 6b79 5f76 616c 7565 203d       sky_value =
+0002e280: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0002e290: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0002e2a0: 2020 2020 6966 2028 2742 4b47 272c 6578      if ('BKG',ex
+0002e2b0: 7429 2069 6e20 666c 743a 0a20 2020 2020  t) in flt:.     
+0002e2c0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0002e2d0: 6173 5f62 6b67 203d 2054 7275 650a 2020  as_bkg = True.  
+0002e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e2f0: 2020 736b 7920 3d20 666c 745b 2742 4b47    sky = flt['BKG
+0002e300: 272c 6578 745d 2e64 6174 6120 2b20 736b  ',ext].data + sk
+0002e310: 795f 7661 6c75 650a 2020 2020 2020 2020  y_value.        
+0002e320: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e340: 2020 6861 735f 626b 6720 3d20 4661 6c73    has_bkg = Fals
+0002e350: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002e360: 2020 2020 2020 736b 7920 3d20 736b 795f        sky = sky_
+0002e370: 7661 6c75 650a 0a20 2020 2020 2020 2020  value..         
+0002e380: 2020 2020 2020 2069 6620 685b 2742 554e         if h['BUN
+0002e390: 4954 275d 203d 3d20 2745 4c45 4354 524f  IT'] == 'ELECTRO
+0002e3a0: 4e53 273a 0a20 2020 2020 2020 2020 2020  NS':.           
+0002e3b0: 2020 2020 2020 2020 2074 6f5f 7065 725f           to_per_
+0002e3c0: 7365 6320 3d20 312e 2f6b 6579 735b 2745  sec = 1./keys['E
+0002e3d0: 5850 5449 4d45 275d 0a20 2020 2020 2020  XPTIME'].       
+0002e3e0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e400: 2020 2020 2070 7269 6e74 2866 2745 7874       print(f'Ext
-0002e410: 7261 206b 6579 776f 7264 207b 6b75 7d20  ra keyword {ku} 
-0002e420: 666f 756e 6420 696e 2057 4353 2068 6561  found in WCS hea
-0002e430: 6465 7227 290a 2020 2020 2020 2020 2020  der').          
-0002e440: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0002e450: 2020 2020 2020 2077 6373 5f72 6f77 732e         wcs_rows.
-0002e460: 6170 7065 6e64 2872 6f77 290a 2020 2020  append(row).    
-0002e470: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0002e480: 2020 2020 2020 2020 2020 2020 2073 6369               sci
-0002e490: 5f6c 6973 742e 6170 7065 6e64 2828 666c  _list.append((fl
-0002e4a0: 745b 2827 5343 4927 2c20 6578 7429 5d2e  t[('SCI', ext)].
-0002e4b0: 6461 7461 202d 2073 6b79 292a 7068 6f74  data - sky)*phot
-0002e4c0: 5f73 6361 6c65 290a 0a20 2020 2020 2020  _scale)..       
-0002e4d0: 2020 2020 2020 2020 2065 7272 203d 2066           err = f
-0002e4e0: 6c74 5b28 2745 5252 272c 2065 7874 295d  lt[('ERR', ext)]
-0002e4f0: 2e64 6174 612a 7068 6f74 5f73 6361 6c65  .data*phot_scale
-0002e500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e510: 2064 7120 3d20 756e 7365 745f 6471 5f62   dq = unset_dq_b
-0002e520: 6974 7328 666c 745b 2827 4451 272c 2065  its(flt[('DQ', e
-0002e530: 7874 295d 2e64 6174 612c 2062 6974 7329  xt)].data, bits)
-0002e540: 207c 2062 7064 6174 610a 2020 2020 2020   | bpdata.      
-0002e550: 2020 2020 2020 2020 2020 7768 7420 3d20            wht = 
-0002e560: 312f 6572 722a 2a32 0a20 2020 2020 2020  1/err**2.       
-0002e570: 2020 2020 2020 2020 2077 6874 5b28 6572           wht[(er
-0002e580: 7220 3d3d 2030 2920 7c20 2864 7120 3e20  r == 0) | (dq > 
-0002e590: 3029 5d20 3d20 300a 0a20 2020 2020 2020  0)] = 0..       
-0002e5a0: 2020 2020 2020 2020 2077 6874 5f6c 6973           wht_lis
-0002e5b0: 742e 6170 7065 6e64 2877 6874 290a 0a20  t.append(wht).. 
-0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002e5d0: 2077 6373 5f69 203d 2048 5354 5743 5328   wcs_i = HSTWCS(
-0002e5e0: 666f 626a 3d66 6c74 2c20 6578 743d 2827  fobj=flt, ext=('
-0002e5f0: 5343 4927 2c65 7874 292c 206d 696e 6572  SCI',ext), miner
-0002e600: 723d 302e 302c 0a20 2020 2020 2020 2020  r=0.0,.         
-0002e610: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-0002e620: 2020 2020 2020 2020 7763 736b 6579 3d27          wcskey='
-0002e630: 2027 290a 2020 2020 2020 2020 2020 2020   ').            
-0002e640: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
-0002e650: 7472 2877 6373 5f69 2c20 2770 6978 656c  tr(wcs_i, 'pixel
-0002e660: 5f73 6861 7065 2729 3a0a 2020 2020 2020  _shape'):.      
-0002e670: 2020 2020 2020 2020 2020 2020 2020 7763                wc
-0002e680: 735f 692e 7069 7865 6c5f 7368 6170 6520  s_i.pixel_shape 
-0002e690: 3d20 7763 735f 692e 5f6e 6178 6973 312c  = wcs_i._naxis1,
-0002e6a0: 2077 6373 5f69 2e5f 6e61 7869 7332 0a0a   wcs_i._naxis2..
-0002e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e6c0: 6966 206e 6f74 2068 6173 6174 7472 2877  if not hasattr(w
-0002e6d0: 6373 5f69 2c20 275f 6e61 7869 7331 2729  cs_i, '_naxis1')
-0002e6e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e6f0: 2020 2020 2020 7763 735f 692e 5f6e 6178        wcs_i._nax
-0002e700: 6973 312c 2077 6373 5f69 2e5f 6e61 7869  is1, wcs_i._naxi
-0002e710: 7332 203d 2077 6373 5f69 2e5f 6e61 7869  s2 = wcs_i._naxi
-0002e720: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
-0002e730: 2020 2077 6373 5f6c 6973 742e 6170 7065     wcs_list.appe
-0002e740: 6e64 2877 6373 5f69 290a 0a20 2020 2020  nd(wcs_i)..     
-0002e750: 2020 2069 6620 636f 756e 7420 3d3d 2030     if count == 0
-0002e760: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002e770: 7320 3d20 6472 697a 7a6c 655f 6172 7261  s = drizzle_arra
-0002e780: 795f 6772 6f75 7073 2873 6369 5f6c 6973  y_groups(sci_lis
-0002e790: 742c 2077 6874 5f6c 6973 742c 2077 6373  t, wht_list, wcs
-0002e7a0: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
-0002e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7c0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0002e7d0: 7574 7763 733d 6f75 7470 7574 7763 732c  utwcs=outputwcs,
-0002e7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e800: 2020 2020 2020 7363 616c 653d 302e 312c        scale=0.1,
-0002e810: 206b 6572 6e65 6c3d 6b65 726e 656c 2c0a   kernel=kernel,.
-0002e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e840: 2020 2020 2070 6978 6672 6163 3d70 6978       pixfrac=pix
-0002e850: 6672 6163 2c20 6361 6c63 5f77 6373 6d61  frac, calc_wcsma
-0002e860: 703d 6361 6c63 5f77 6373 6d61 702c 0a20  p=calc_wcsmap,. 
+0002e400: 2020 2074 6f5f 7065 725f 7365 6320 3d20     to_per_sec = 
+0002e410: 312e 0a0a 2020 2020 2020 2020 2020 2020  1...            
+0002e420: 2020 2020 7068 6f74 5f73 6361 6c65 203d      phot_scale =
+0002e430: 2074 6f5f 7065 725f 7365 6320 2a20 5f73   to_per_sec * _s
+0002e440: 6361 6c65 5f70 686f 746f 6d0a 0a20 2020  cale_photom..   
+0002e450: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002e460: 2750 484f 5446 4c41 4d27 2069 6e20 683a  'PHOTFLAM' in h:
+0002e470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e480: 2020 2020 2069 6620 7265 665f 7068 6f74       if ref_phot
+0002e490: 666c 616d 2069 7320 4e6f 6e65 3a0a 2020  flam is None:.  
+0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4b0: 2020 2020 2020 7265 665f 7068 6f74 666c        ref_photfl
+0002e4c0: 616d 203d 2068 5b27 5048 4f54 464c 414d  am = h['PHOTFLAM
+0002e4d0: 275d 0a0a 2020 2020 2020 2020 2020 2020  ']..            
+0002e4e0: 2020 2020 2020 2020 7068 6f74 5f73 6361          phot_sca
+0002e4f0: 6c65 203d 2068 5b27 5048 4f54 464c 414d  le = h['PHOTFLAM
+0002e500: 275d 202f 2072 6566 5f70 686f 7466 6c61  '] / ref_photfla
+0002e510: 6d20 2a20 5f73 6361 6c65 5f70 686f 746f  m * _scale_photo
+0002e520: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+0002e530: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002e540: 2020 2020 2020 2020 2020 2069 6620 2750             if 'P
+0002e550: 484f 5446 4e55 2720 6e6f 7420 696e 2068  HOTFNU' not in h
+0002e560: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e570: 2020 2020 2020 2020 2020 685b 2750 484f            h['PHO
+0002e580: 5446 4e55 275d 203d 2028 7068 6f74 666e  TFNU'] = (photfn
+0002e590: 755f 6672 6f6d 5f70 686f 7466 6c61 6d28  u_from_photflam(
+0002e5a0: 685b 2750 484f 5446 4c41 4d27 5d2c 0a20  h['PHOTFLAM'],. 
+0002e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5e0: 2020 2020 2020 2020 2020 2020 685b 2750              h['P
+0002e5f0: 484f 5450 4c41 4d27 5d29 2c20 0a20 2020  HOTPLAM']), .   
+0002e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e620: 2020 2020 2027 496e 7665 7273 6520 7365       'Inverse se
+0002e630: 6e73 6974 6976 6974 792c 204a 792f 444e  nsitivity, Jy/DN
+0002e640: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0002e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e690: 2020 2020 206d 7367 203d 2027 2020 2020       msg = '    
+0002e6a0: 2020 2050 484f 5446 4c41 4d3d 7b30 3a2e     PHOTFLAM={0:.
+0002e6b0: 3265 7d2c 2073 6361 6c65 3d7b 313a 2e33  2e}, scale={1:.3
+0002e6c0: 667d 270a 2020 2020 2020 2020 2020 2020  f}'.            
+0002e6d0: 2020 2020 2020 2020 6d73 6720 3d20 6d73          msg = ms
+0002e6e0: 672e 666f 726d 6174 2868 5b27 5048 4f54  g.format(h['PHOT
+0002e6f0: 464c 414d 275d 2c20 7068 6f74 5f73 6361  FLAM'], phot_sca
+0002e700: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+0002e710: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
+0002e720: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
+0002e730: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
+0002e740: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002e750: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002e760: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+0002e770: 5b27 5048 4f54 464c 414d 275d 203d 2068  ['PHOTFLAM'] = h
+0002e780: 5b27 5048 4f54 464c 414d 275d 0a20 2020  ['PHOTFLAM'].   
+0002e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7a0: 2066 6f72 206b 2069 6e20 5b27 5048 4f54   for k in ['PHOT
+0002e7b0: 464c 414d 272c 2027 5048 4f54 504c 414d  FLAM', 'PHOTPLAM
+0002e7c0: 272c 2027 5048 4f54 464e 5527 2c0a 2020  ', 'PHOTFNU',.  
+0002e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7e0: 2020 2020 2020 2020 2020 2020 2750 484f              'PHO
+0002e7f0: 545a 5054 272c 2027 5048 4f54 4257 272c  TZPT', 'PHOTBW',
+0002e800: 2027 5048 4f54 4d4f 4445 272c 0a20 2020   'PHOTMODE',.   
+0002e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e820: 2020 2020 2020 2020 2020 2027 5048 4f54             'PHOT
+0002e830: 4d4a 5352 272c 2027 5049 5841 525f 5352  MJSR', 'PIXAR_SR
+0002e840: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+0002e850: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0002e860: 2069 6e20 683a 0a20 2020 2020 2020 2020   in h:.         
 0002e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e890: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
-0002e8a0: 6f73 652c 2064 6174 613d 4e6f 6e65 290a  ose, data=None).
-0002e8b0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0002e8c0: 7363 692c 206f 7574 7768 742c 206f 7574  sci, outwht, out
-0002e8d0: 6374 782c 2068 6561 6465 722c 2078 6f75  ctx, header, xou
-0002e8e0: 7477 6373 203d 2072 6573 0a20 2020 2020  twcs = res.     
-0002e8f0: 2020 2020 2020 2068 6561 6465 725b 2745         header['E
-0002e900: 5850 5449 4d45 275d 203d 2066 6c74 5b30  XPTIME'] = flt[0
-0002e910: 5d2e 6865 6164 6572 5b27 4558 5054 494d  ].header['EXPTIM
-0002e920: 4527 5d0a 2020 2020 2020 2020 2020 2020  E'].            
-0002e930: 6865 6164 6572 5b27 4e44 5249 5a49 4d27  header['NDRIZIM'
-0002e940: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
-0002e950: 2020 6865 6164 6572 5b27 5049 5846 5241    header['PIXFRA
-0002e960: 4327 5d20 3d20 7069 7866 7261 630a 2020  C'] = pixfrac.  
-0002e970: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0002e980: 5b27 4b45 524e 454c 275d 203d 206b 6572  ['KERNEL'] = ker
-0002e990: 6e65 6c0a 2020 2020 2020 2020 2020 2020  nel.            
-0002e9a0: 6865 6164 6572 5b27 4f4b 4249 5453 275d  header['OKBITS']
-0002e9b0: 203d 2028 6269 7473 2c20 2246 4c54 2062   = (bits, "FLT b
-0002e9c0: 6974 7320 7472 6561 7465 6420 6173 2076  its treated as v
-0002e9d0: 616c 6964 2229 0a20 2020 2020 2020 2020  alid").         
-0002e9e0: 2020 2068 6561 6465 725b 2750 484f 5453     header['PHOTS
-0002e9f0: 4341 4c27 5d20 3d20 5f73 6361 6c65 5f70  CAL'] = _scale_p
-0002ea00: 686f 746f 6d2c 2027 5363 616c 6520 6661  hotom, 'Scale fa
-0002ea10: 6374 6f72 2061 7070 6c69 6564 270a 2020  ctor applied'.  
-0002ea20: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0002ea30: 2020 2020 2020 2068 6561 6465 725b 2747         header['G
-0002ea40: 5249 5a4c 4956 275d 203d 2067 7269 7a6c  RIZLIV'] = grizl
-0002ea50: 695f 5f76 6572 7369 6f6e 2c20 2747 7269  i__version, 'Gri
-0002ea60: 7a6c 6920 636f 6465 2076 6572 7369 6f6e  zli code version
-0002ea70: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
-0002ea80: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-0002ea90: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
-0002eaa0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0002eab0: 5b6b 5d20 3d20 6b65 7973 5b6b 5d0a 0a20  [k] = keys[k].. 
-0002eac0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002ead0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-0002eae0: 6f75 7473 6369 2c20 6f75 7477 6874 2c20  outsci, outwht, 
-0002eaf0: 6f75 7463 7478 0a20 2020 2020 2020 2020  outctx.         
-0002eb00: 2020 2072 6573 203d 2064 7269 7a7a 6c65     res = drizzle
-0002eb10: 5f61 7272 6179 5f67 726f 7570 7328 7363  _array_groups(sc
-0002eb20: 695f 6c69 7374 2c20 7768 745f 6c69 7374  i_list, wht_list
-0002eb30: 2c20 7763 735f 6c69 7374 2c0a 2020 2020  , wcs_list,.    
-0002eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb60: 206f 7574 7075 7477 6373 3d6f 7574 7075   outputwcs=outpu
-0002eb70: 7477 6373 2c0a 2020 2020 2020 2020 2020  twcs,.          
-0002eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb90: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
-0002eba0: 3d30 2e31 2c20 6b65 726e 656c 3d6b 6572  =0.1, kernel=ker
-0002ebb0: 6e65 6c2c 0a20 2020 2020 2020 2020 2020  nel,.           
-0002ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ebd0: 2020 2020 2020 2020 2020 7069 7866 7261            pixfra
-0002ebe0: 633d 7069 7866 7261 632c 2063 616c 635f  c=pixfrac, calc_
-0002ebf0: 7763 736d 6170 3d63 616c 635f 7763 736d  wcsmap=calc_wcsm
-0002ec00: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
-0002ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec20: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-0002ec30: 3d76 6572 626f 7365 2c20 6461 7461 3d64  =verbose, data=d
-0002ec40: 6174 6129 0a0a 2020 2020 2020 2020 2020  ata)..          
-0002ec50: 2020 6f75 7473 6369 2c20 6f75 7477 6874    outsci, outwht
-0002ec60: 2c20 6f75 7463 7478 203d 2072 6573 5b3a  , outctx = res[:
-0002ec70: 335d 0a20 2020 2020 2020 2020 2020 2068  3].            h
-0002ec80: 6561 6465 725b 2745 5850 5449 4d45 275d  eader['EXPTIME']
-0002ec90: 202b 3d20 666c 745b 305d 2e68 6561 6465   += flt[0].heade
-0002eca0: 725b 2745 5850 5449 4d45 275d 0a20 2020  r['EXPTIME'].   
-0002ecb0: 2020 2020 2020 2020 2068 6561 6465 725b           header[
-0002ecc0: 274e 4452 495a 494d 275d 202b 3d20 310a  'NDRIZIM'] += 1.
-0002ecd0: 0a20 2020 2020 2020 2063 6f75 6e74 202b  .        count +
-0002ece0: 3d20 310a 2020 2020 2020 2020 6865 6164  = 1.        head
-0002ecf0: 6572 5b27 464c 547b 303a 3035 647d 272e  er['FLT{0:05d}'.
-0002ed00: 666f 726d 6174 2863 6f75 6e74 295d 203d  format(count)] =
-0002ed10: 2066 696c 650a 2020 2020 2020 2020 0a20   file.        . 
-0002ed20: 2020 2020 2020 2066 6c74 2e63 6c6f 7365         flt.close
-0002ed30: 2829 0a20 2020 2020 2020 200a 2020 2020  ().        .    
-0002ed40: 2020 2020 2378 6669 6c65 7320 3d20 676c      #xfiles = gl
-0002ed50: 6f62 2e67 6c6f 6228 272a 2729 0a20 2020  ob.glob('*').   
-0002ed60: 2020 2020 2023 7072 696e 7428 2743 6c65       #print('Cle
-0002ed70: 616e 3a20 272c 2063 6c65 616e 2c20 7866  an: ', clean, xf
-0002ed80: 696c 6573 290a 2020 2020 2020 2020 6966  iles).        if
-0002ed90: 2063 6c65 616e 3a0a 2020 2020 2020 2020   clean:.        
-0002eda0: 2020 2020 6f73 2e72 656d 6f76 6528 6669      os.remove(fi
-0002edb0: 6c65 290a 0a20 2020 2069 6620 2761 7773  le)..    if 'aws
-0002edc0: 7061 7468 2720 696e 2076 6973 6974 3a0a  path' in visit:.
-0002edd0: 2020 2020 2020 2020 6177 7370 6174 6820          awspath 
-0002ede0: 3d20 7669 7369 745b 2761 7773 7061 7468  = visit['awspath
-0002edf0: 275d 0a20 2020 2065 6c73 653a 0a20 2020  '].    else:.   
-0002ee00: 2020 2020 2061 7773 7061 7468 203d 205b       awspath = [
-0002ee10: 272e 2720 666f 7220 6620 696e 2076 6973  '.' for f in vis
-0002ee20: 6974 5b27 6669 6c65 7327 5d5d 0a0a 2020  it['files']]..  
-0002ee30: 2020 6966 206c 656e 2861 7773 7061 7468    if len(awspath
-0002ee40: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-0002ee50: 6177 7370 6174 6820 3d20 5b61 7773 7061  awspath = [awspa
-0002ee60: 7468 5b30 5d20 666f 7220 6620 696e 2076  th[0] for f in v
-0002ee70: 6973 6974 5b27 6669 6c65 7327 5d5d 0a20  isit['files']]. 
-0002ee80: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0002ee90: 6365 2861 7773 7061 7468 2c20 7374 7229  ce(awspath, str)
-0002eea0: 3a0a 2020 2020 2020 2020 5f61 7773 7061  :.        _awspa
-0002eeb0: 7468 203d 205b 6177 7370 6174 6820 666f  th = [awspath fo
-0002eec0: 7220 6620 696e 2076 6973 6974 5b27 6669  r f in visit['fi
-0002eed0: 6c65 7327 5d5d 0a20 2020 2020 2020 2061  les']].        a
-0002eee0: 7773 7061 7468 203d 205f 6177 7370 6174  wspath = _awspat
-0002eef0: 680a 0a20 2020 2066 6c69 7374 203d 205b  h..    flist = [
-0002ef00: 277b 307d 2f7b 317d 272e 666f 726d 6174  '{0}/{1}'.format
-0002ef10: 2861 7773 7061 7468 2c20 7669 7369 745b  (awspath, visit[
-0002ef20: 2766 696c 6573 275d 5b69 5d29 0a20 2020  'files'][i]).   
-0002ef30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002ef40: 2069 2069 6e20 696e 6469 6365 735d 0a20   i in indices]. 
-0002ef50: 2020 200a 2020 2020 6966 2064 7279 7275     .    if dryru
-0002ef60: 6e3a 0a20 2020 2020 2020 2072 6574 7572  n:.        retur
-0002ef70: 6e20 666c 6973 740a 0a20 2020 2065 6c69  n flist..    eli
-0002ef80: 6620 636f 756e 7420 3d3d 2030 3a0a 2020  f count == 0:.  
-0002ef90: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0002efa0: 650a 0a20 2020 2065 6c73 653a 2020 2020  e..    else:    
-0002efb0: 2020 2020 0a20 2020 2020 2020 2077 6373      .        wcs
-0002efc0: 5f74 6162 203d 2047 5461 626c 6528 6e61  _tab = GTable(na
-0002efd0: 6d65 733d 7763 735f 636f 6c6e 616d 6573  mes=wcs_colnames
-0002efe0: 2c20 726f 7773 3d77 6373 5f72 6f77 7329  , rows=wcs_rows)
-0002eff0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0002f000: 2020 6f75 7477 6874 202a 3d20 2877 6373    outwht *= (wcs
-0002f010: 5f69 2e70 7363 616c 652f 6f75 7470 7574  _i.pscale/output
-0002f020: 7763 732e 7073 6361 6c65 292a 2a34 0a20  wcs.pscale)**4. 
-0002f030: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-0002f040: 7473 6369 2c20 6f75 7477 6874 2c20 6865  tsci, outwht, he
-0002f050: 6164 6572 2c20 666c 6973 742c 2077 6373  ader, flist, wcs
-0002f060: 5f74 6162 0a0a 0a64 6566 2064 7269 7a7a  _tab...def drizz
-0002f070: 6c65 5f61 7272 6179 5f67 726f 7570 7328  le_array_groups(
-0002f080: 7363 695f 6c69 7374 2c20 7768 745f 6c69  sci_list, wht_li
-0002f090: 7374 2c20 7763 735f 6c69 7374 2c20 6f75  st, wcs_list, ou
-0002f0a0: 7470 7574 7763 733d 4e6f 6e65 2c0a 2020  tputwcs=None,.  
-0002f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0c0: 2020 2020 2020 2073 6361 6c65 3d30 2e31         scale=0.1
-0002f0d0: 2c20 6b65 726e 656c 3d27 706f 696e 7427  , kernel='point'
-0002f0e0: 2c20 7069 7866 7261 633d 312e 2c0a 2020  , pixfrac=1.,.  
-0002f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f100: 2020 2020 2020 2063 616c 635f 7763 736d         calc_wcsm
-0002f110: 6170 3d46 616c 7365 2c20 7665 7262 6f73  ap=False, verbos
-0002f120: 653d 5472 7565 2c20 6461 7461 3d4e 6f6e  e=True, data=Non
-0002f130: 6529 3a0a 2020 2020 2222 2244 7269 7a7a  e):.    """Drizz
-0002f140: 6c65 2061 7272 6179 2064 6174 6120 7769  le array data wi
-0002f150: 7468 2061 7373 6f63 6961 7465 6420 7763  th associated wc
-0002f160: 730a 0a20 2020 2050 6172 616d 6574 6572  s..    Parameter
-0002f170: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-0002f180: 0a20 2020 2073 6369 5f6c 6973 742c 2077  .    sci_list, w
-0002f190: 6874 5f6c 6973 7420 3a20 6c69 7374 0a20  ht_list : list. 
-0002f1a0: 2020 2020 2020 204c 6973 7420 6f66 2073         List of s
-0002f1b0: 6369 656e 6365 2061 6e64 2077 6569 6768  cience and weigh
-0002f1c0: 7420 607e 6e75 6d70 792e 6e64 6172 7261  t `~numpy.ndarra
-0002f1d0: 7960 206f 626a 6563 7473 2e0a 0a20 2020  y` objects...   
-0002f1e0: 2077 6373 5f6c 6973 7420 3a20 6c69 7374   wcs_list : list
-0002f1f0: 0a0a 2020 2020 7363 616c 6520 3a20 666c  ..    scale : fl
-0002f200: 6f61 740a 2020 2020 2020 2020 4f75 7470  oat.        Outp
-0002f210: 7574 2070 6978 656c 2073 6361 6c65 2069  ut pixel scale i
-0002f220: 6e20 6172 6373 6563 2e0a 0a20 2020 206b  n arcsec...    k
-0002f230: 6572 6e65 6c2c 2070 6978 6672 6163 203a  ernel, pixfrac :
-0002f240: 2073 7472 2c20 666c 6f61 740a 2020 2020   str, float.    
-0002f250: 2020 2020 4472 697a 7a6c 6520 7061 7261      Drizzle para
-0002f260: 6d65 7465 7273 0a0a 2020 2020 7665 7262  meters..    verb
-0002f270: 6f73 6520 3a20 626f 6f6c 0a20 2020 2020  ose : bool.     
-0002f280: 2020 2050 7269 6e74 2073 7461 7475 7320     Print status 
-0002f290: 6d65 7373 6167 6573 0a0a 2020 2020 5265  messages..    Re
-0002f2a0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0002f2b0: 2d0a 2020 2020 6f75 7473 6369 2c20 6f75  -.    outsci, ou
-0002f2c0: 7477 6874 2c20 6f75 7463 7478 203a 2060  twht, outctx : `
-0002f2d0: 7e6e 756d 7079 2e6e 6461 7272 6179 600a  ~numpy.ndarray`.
-0002f2e0: 2020 2020 2020 2020 4f75 7470 7574 2064          Output d
-0002f2f0: 7269 7a7a 6c65 6420 7363 6965 6e63 652c  rizzled science,
-0002f300: 2077 6569 6768 7420 616e 6420 636f 6e74   weight and cont
-0002f310: 6578 7420 696d 6167 6573 0a0a 2020 2020  ext images..    
-0002f320: 6865 6164 6572 2c20 6f75 7470 7574 7763  header, outputwc
-0002f330: 7320 3a20 607e 6173 7472 6f70 792e 6669  s : `~astropy.fi
-0002f340: 7473 2e69 6f2e 4865 6164 6572 602c 2060  ts.io.Header`, `
-0002f350: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
-0002f360: 600a 2020 2020 2020 2020 4472 697a 7a6c  `.        Drizzl
-0002f370: 6564 2069 6d61 6765 2068 6561 6465 7220  ed image header 
-0002f380: 616e 6420 5743 532e 0a0a 2020 2020 2222  and WCS...    ""
-0002f390: 220a 2020 2020 6672 6f6d 2064 7269 7a7a  ".    from drizz
-0002f3a0: 6c65 7061 6320 696d 706f 7274 2061 6472  lepac import adr
-0002f3b0: 697a 7a6c 650a 2020 2020 6672 6f6d 2064  izzle.    from d
-0002f3c0: 7269 7a7a 6c65 7061 6320 696d 706f 7274  rizzlepac import
-0002f3d0: 2063 6472 697a 0a0a 2020 2020 2366 726f   cdriz..    #fro
-0002f3e0: 6d20 7374 7363 692e 746f 6f6c 7320 696d  m stsci.tools im
-0002f3f0: 706f 7274 206c 6f67 7574 696c 0a20 2020  port logutil.   
-0002f400: 2023 6c6f 6720 3d20 6c6f 6775 7469 6c2e   #log = logutil.
-0002f410: 6372 6561 7465 5f6c 6f67 6765 7228 5f5f  create_logger(__
-0002f420: 6e61 6d65 5f5f 290a 0a20 2020 2023 204f  name__)..    # O
-0002f430: 7574 7075 7420 6865 6164 6572 202f 2057  utput header / W
-0002f440: 4353 0a20 2020 2069 6620 6f75 7470 7574  CS.    if output
-0002f450: 7763 7320 6973 204e 6f6e 653a 0a20 2020  wcs is None:.   
-0002f460: 2020 2020 2023 6865 6164 6572 2c20 6f75       #header, ou
-0002f470: 7470 7574 7763 7320 3d20 636f 6d70 7574  tputwcs = comput
-0002f480: 655f 6f75 7470 7574 5f77 6373 2877 6373  e_output_wcs(wcs
-0002f490: 5f6c 6973 742c 2070 6978 656c 5f73 6361  _list, pixel_sca
-0002f4a0: 6c65 3d73 6361 6c65 290a 2020 2020 2020  le=scale).      
-0002f4b0: 2020 6865 6164 6572 2c20 6f75 7470 7574    header, output
-0002f4c0: 7763 7320 3d20 6d61 6b65 5f6d 6178 696d  wcs = make_maxim
-0002f4d0: 616c 5f77 6373 2877 6373 5f6c 6973 742c  al_wcs(wcs_list,
-0002f4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f500: 2020 2020 2020 2020 2020 2020 2020 7069                pi
-0002f510: 7865 6c5f 7363 616c 653d 7363 616c 652c  xel_scale=scale,
-0002f520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f540: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-0002f550: 7262 6f73 653d 4661 6c73 652c 0a20 2020  rbose=False,.   
-0002f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f580: 2020 2020 2020 2020 2020 7061 643d 302c            pad=0,
+0002e880: 2020 206b 6579 735b 6b5d 203d 2068 5b6b     keys[k] = h[k
+0002e890: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+0002e8a0: 2020 2020 2020 2070 686f 745f 7363 616c         phot_scal
+0002e8b0: 6520 2a3d 2074 6f5f 7065 725f 7365 630a  e *= to_per_sec.
+0002e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8d0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0002e8e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002e8f0: 2020 2020 2020 2020 2020 2020 2020 7763                wc
+0002e900: 735f 6920 3d20 7079 7763 732e 5743 5328  s_i = pywcs.WCS(
+0002e910: 6865 6164 6572 3d66 6c74 5b28 2753 4349  header=flt[('SCI
+0002e920: 272c 2065 7874 295d 2e68 6561 6465 722c  ', ext)].header,
+0002e930: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e950: 2020 2020 2020 2020 666f 626a 3d66 6c74          fobj=flt
+0002e960: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002e970: 2020 2020 2020 7763 735f 692e 7073 6361        wcs_i.psca
+0002e980: 6c65 203d 2067 6574 5f77 6373 5f70 7363  le = get_wcs_psc
+0002e990: 616c 6528 7763 735f 6929 0a20 2020 2020  ale(wcs_i).     
+0002e9a0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0002e9b0: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+0002e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e9d0: 7072 696e 7428 6627 4661 696c 6564 2074  print(f'Failed t
+0002e9e0: 6f20 696e 6974 6961 6c69 7a65 2057 4353  o initialize WCS
+0002e9f0: 206f 6e20 7b66 696c 657d 5b53 4349 2c7b   on {file}[SCI,{
+0002ea00: 6578 747d 5d27 290a 2020 2020 2020 2020  ext}]').        
+0002ea10: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0002ea20: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+0002ea30: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0002ea40: 2020 2020 2020 7763 7368 203d 2074 6f5f        wcsh = to_
+0002ea50: 6865 6164 6572 2877 6373 5f69 290a 2020  header(wcs_i).  
+0002ea60: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+0002ea70: 7720 3d20 5b66 696c 652c 2065 7874 2c20  w = [file, ext, 
+0002ea80: 6b65 7973 5b27 4558 5054 494d 4527 5d5d  keys['EXPTIME']]
+0002ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002eaa0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002eab0: 2020 6966 2077 6373 5f63 6f6c 6e61 6d65    if wcs_colname
+0002eac0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0002ead0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0002eae0: 6373 5f63 6f6c 6e61 6d65 7320 3d20 5b27  cs_colnames = ['
+0002eaf0: 6669 6c65 272c 2765 7874 272c 2765 7870  file','ext','exp
+0002eb00: 7469 6d65 275d 0a20 2020 2020 2020 2020  time'].         
+0002eb10: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0002eb20: 2069 6e20 7763 7368 3a0a 2020 2020 2020   in wcsh:.      
+0002eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb40: 2020 7763 735f 636f 6c6e 616d 6573 2e61    wcs_colnames.a
+0002eb50: 7070 656e 6428 6b2e 6c6f 7765 7228 2929  ppend(k.lower())
+0002eb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002eb70: 2020 2020 2020 2020 2077 6373 5f6b 6579           wcs_key
+0002eb80: 735b 6b2e 6c6f 7765 7228 295d 203d 2077  s[k.lower()] = w
+0002eb90: 6373 685b 6b5d 0a20 2020 2020 2020 2020  csh[k].         
+0002eba0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0002ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ebc0: 666f 7220 6b20 696e 2077 6373 5f63 6f6c  for k in wcs_col
+0002ebd0: 6e61 6d65 735b 333a 5d3a 0a20 2020 2020  names[3:]:.     
+0002ebe0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0002ebf0: 7520 3d20 6b2e 7570 7065 7228 290a 2020  u = k.upper().  
+0002ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec10: 2020 6966 206b 7520 6e6f 7420 696e 2077    if ku not in w
+0002ec20: 6373 683a 0a20 2020 2020 2020 2020 2020  csh:.           
+0002ec30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0002ec40: 6e74 2866 274b 6579 776f 7264 207b 6b75  nt(f'Keyword {ku
+0002ec50: 7d20 6e6f 7420 666f 756e 6420 696e 2057  } not found in W
+0002ec60: 4353 2068 6561 6465 7227 290a 2020 2020  CS header').    
+0002ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec80: 2020 2020 726f 772e 6170 7065 6e64 2877      row.append(w
+0002ec90: 6373 5f6b 6579 735b 6b5d 2a30 290a 2020  cs_keys[k]*0).  
+0002eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ecb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ecd0: 726f 772e 6170 7065 6e64 2877 6373 685b  row.append(wcsh[
+0002ece0: 6b75 5d29 0a20 2020 2020 2020 2020 2020  ku]).           
+0002ecf0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+0002ed00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002ed10: 7220 6b20 696e 2077 6373 683a 0a20 2020  r k in wcsh:.   
+0002ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ed30: 2069 6620 6b2e 6c6f 7765 7228 2920 6e6f   if k.lower() no
+0002ed40: 7420 696e 2077 6373 5f63 6f6c 6e61 6d65  t in wcs_colname
+0002ed50: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002ed60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0002ed70: 2866 2745 7874 7261 206b 6579 776f 7264  (f'Extra keyword
+0002ed80: 207b 6b75 7d20 666f 756e 6420 696e 2057   {ku} found in W
+0002ed90: 4353 2068 6561 6465 7227 290a 2020 2020  CS header').    
+0002eda0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0002edb0: 2020 2020 2020 2020 2020 2020 2077 6373               wcs
+0002edc0: 5f72 6f77 732e 6170 7065 6e64 2872 6f77  _rows.append(row
+0002edd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002ede0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0002edf0: 2020 2073 6369 5f6c 6973 742e 6170 7065     sci_list.appe
+0002ee00: 6e64 2828 666c 745b 2827 5343 4927 2c20  nd((flt[('SCI', 
+0002ee10: 6578 7429 5d2e 6461 7461 202d 2073 6b79  ext)].data - sky
+0002ee20: 292a 7068 6f74 5f73 6361 6c65 290a 0a20  )*phot_scale).. 
+0002ee30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002ee40: 7272 203d 2066 6c74 5b28 2745 5252 272c  rr = flt[('ERR',
+0002ee50: 2065 7874 295d 2e64 6174 612a 7068 6f74   ext)].data*phot
+0002ee60: 5f73 6361 6c65 0a20 2020 2020 2020 2020  _scale.         
+0002ee70: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002ee80: 2020 2020 2020 2020 2320 4a57 5354 3a20          # JWST: 
+0002ee90: 6a75 7374 2031 2c31 3032 342c 3430 3936  just 1,1024,4096
+0002eea0: 2062 6974 730a 2020 2020 2020 2020 2020   bits.          
+0002eeb0: 2020 2020 2020 6966 2066 6c74 5b30 5d2e        if flt[0].
+0002eec0: 6865 6164 6572 5b27 5445 4c45 5343 4f50  header['TELESCOP
+0002eed0: 275d 2069 6e20 5b27 4a57 5354 275d 3a0a  '] in ['JWST']:.
+0002eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eef0: 2020 2020 6471 203d 2066 6c74 5b28 2744      dq = flt[('D
+0002ef00: 5127 2c20 6578 7429 5d2e 6461 7461 2026  Q', ext)].data &
+0002ef10: 2028 312b 3130 3234 2b34 3039 3629 0a20   (1+1024+4096). 
+0002ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef30: 2020 2064 7120 7c3d 2062 7064 6174 612e     dq |= bpdata.
+0002ef40: 6173 7479 7065 2864 712e 6474 7970 6529  astype(dq.dtype)
+0002ef50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ef60: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0002ef70: 2020 2020 2020 2020 2020 2320 6471 3020            # dq0 
+0002ef80: 3d20 756e 7365 745f 6471 5f62 6974 7328  = unset_dq_bits(
+0002ef90: 666c 745b 2827 4451 272c 2065 7874 295d  flt[('DQ', ext)]
+0002efa0: 2e64 6174 612c 2062 6974 7329 207c 2062  .data, bits) | b
+0002efb0: 7064 6174 610a 2020 2020 2020 2020 2020  pdata.          
+0002efc0: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+0002efd0: 7428 2778 7878 272c 2028 6471 203e 2030  t('xxx', (dq > 0
+0002efe0: 292e 7375 6d28 292c 2028 6471 3020 3e20  ).sum(), (dq0 > 
+0002eff0: 3029 2e73 756d 2829 290a 2020 2020 2020  0).sum()).      
+0002f000: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0002f010: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002f020: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002f030: 2020 2020 2020 2020 2064 7120 3d20 756e           dq = un
+0002f040: 7365 745f 6471 5f62 6974 7328 666c 745b  set_dq_bits(flt[
+0002f050: 2827 4451 272c 2065 7874 295d 2e64 6174  ('DQ', ext)].dat
+0002f060: 612c 2062 6974 7329 207c 2062 7064 6174  a, bits) | bpdat
+0002f070: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0002f080: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002f090: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002f0a0: 2020 2020 2020 2020 2020 2020 7768 7420              wht 
+0002f0b0: 3d20 312f 6572 722a 2a32 0a20 2020 2020  = 1/err**2.     
+0002f0c0: 2020 2020 2020 2020 2020 205f 6d73 6b20             _msk 
+0002f0d0: 3d20 2865 7272 203d 3d20 3029 207c 2028  = (err == 0) | (
+0002f0e0: 6471 203e 2030 290a 2020 2020 2020 2020  dq > 0).        
+0002f0f0: 2020 2020 2020 2020 7768 745b 5f6d 736b          wht[_msk
+0002f100: 5d20 3d20 300a 2020 2020 2020 2020 2020  ] = 0.          
+0002f110: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002f120: 2020 2020 2020 2069 6620 2877 6569 6768         if (weigh
+0002f130: 745f 7479 7065 203d 3d20 276a 7773 7427  t_type == 'jwst'
+0002f140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002f150: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002f160: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0002f170: 2827 5641 525f 524e 4f49 5345 272c 2065  ('VAR_RNOISE', e
+0002f180: 7874 2920 696e 2066 6c74 2920 2620 2872  xt) in flt) & (r
+0002f190: 6e6f 6973 655f 7065 7263 656e 7469 6c65  noise_percentile
+0002f1a0: 2069 7320 6e6f 7420 4e6f 6e65 293a 0a20   is not None):. 
+0002f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1c0: 2020 2020 2020 205f 726e 5f64 6174 6120         _rn_data 
+0002f1d0: 3d20 666c 745b 2827 5641 525f 524e 4f49  = flt[('VAR_RNOI
+0002f1e0: 5345 272c 6578 7429 5d2e 6461 7461 0a20  SE',ext)].data. 
+0002f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f200: 2020 2020 2020 2072 6e6f 6973 655f 7661         rnoise_va
+0002f210: 6c75 6520 3d20 6e70 2e6e 616e 7065 7263  lue = np.nanperc
+0002f220: 656e 7469 6c65 285f 726e 5f64 6174 615b  entile(_rn_data[
+0002f230: 7e5f 6d73 6b5d 2c20 0a20 2020 2020 2020  ~_msk], .       
+0002f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f270: 2072 6e6f 6973 655f 7065 7263 656e 7469   rnoise_percenti
+0002f280: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+0002f290: 2020 2020 2020 2020 2020 2020 5f6d 736b              _msk
+0002f2a0: 207c 3d20 5f72 6e5f 6461 7461 203e 3d20   |= _rn_data >= 
+0002f2b0: 726e 6f69 7365 5f76 616c 7565 0a20 2020  rnoise_value.   
+0002f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2d0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0002f2e0: 2020 2020 2020 2020 2020 6966 2028 2756            if ('V
+0002f2f0: 4152 5f50 4f49 5353 4f4e 272c 6578 7429  AR_POISSON',ext)
+0002f300: 2069 6e20 666c 743a 0a20 2020 2020 2020   in flt:.       
+0002f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f320: 2023 2057 6569 6768 7420 6279 2056 4152   # Weight by VAR
+0002f330: 5f52 4e4f 4953 4520 2b20 6d65 6469 616e  _RNOISE + median
+0002f340: 2856 4152 5f50 4f49 5353 4f4e 290a 2020  (VAR_POISSON).  
+0002f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f360: 2020 2020 2020 6966 2028 7e5f 6d73 6b29        if (~_msk)
+0002f370: 2e73 756d 2829 203e 2030 3a0a 2020 2020  .sum() > 0:.    
+0002f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f390: 2020 2020 2020 2020 5f76 6172 5f64 6174          _var_dat
+0002f3a0: 6120 3d20 666c 745b 2827 5641 525f 504f  a = flt[('VAR_PO
+0002f3b0: 4953 534f 4e27 2c65 7874 295d 2e64 6174  ISSON',ext)].dat
+0002f3c0: 615b 7e5f 6d73 6b5d 0a20 2020 2020 2020  a[~_msk].       
+0002f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3e0: 2020 2020 206d 6564 5f70 6f69 7373 6f6e       med_poisson
+0002f3f0: 203d 206e 702e 6e61 6e6d 6564 6961 6e28   = np.nanmedian(
+0002f400: 5f76 6172 5f64 6174 6129 0a20 2020 2020  _var_data).     
+0002f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f420: 2020 2020 2020 2076 6172 203d 2066 6c74         var = flt
+0002f430: 5b27 5641 525f 524e 4f49 5345 272c 6578  ['VAR_RNOISE',ex
+0002f440: 745d 2e64 6174 6120 2b20 6d65 645f 706f  t].data + med_po
+0002f450: 6973 736f 6e0a 2020 2020 2020 2020 2020  isson.          
+0002f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f470: 2020 7661 7220 2a3d 2070 686f 745f 7363    var *= phot_sc
+0002f480: 616c 652a 2a32 0a20 2020 2020 2020 2020  ale**2.         
+0002f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4a0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4c0: 7768 7420 3d20 312e 2f76 6172 0a20 2020  wht = 1./var.   
+0002f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4e0: 2020 2020 2020 2020 2077 6874 5b5f 6d73           wht[_ms
+0002f4f0: 6b20 7c20 2876 6172 203c 3d20 3029 5d20  k | (var <= 0)] 
+0002f500: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0002f510: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f530: 2020 2020 2020 2320 4661 6c6c 2062 6163        # Fall bac
+0002f540: 6b20 746f 206d 6564 6961 6e5f 6572 720a  k to median_err.
+0002f550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f560: 2020 2020 2020 2020 6d65 6469 616e 5f77          median_w
+0002f570: 6569 6768 7420 3d20 6e70 2e6e 616e 6d65  eight = np.nanme
+0002f580: 6469 616e 2877 6874 5b7e 5f6d 736b 5d29  dian(wht[~_msk])
 0002f590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5b0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-0002f5c0: 745f 6864 753d 4661 6c73 6529 0a20 2020  t_hdu=False).   
-0002f5d0: 2065 6c73 653a 0a20 2020 2020 2020 2068   else:.        h
-0002f5e0: 6561 6465 7220 3d20 746f 5f68 6561 6465  eader = to_heade
-0002f5f0: 7228 6f75 7470 7574 7763 7329 0a0a 2020  r(outputwcs)..  
-0002f600: 2020 6865 6164 6572 5b27 4452 495a 4b45    header['DRIZKE
-0002f610: 524e 275d 203d 206b 6572 6e65 6c2c 2022  RN'] = kernel, "
-0002f620: 4472 697a 7a6c 6520 6b65 726e 656c 220a  Drizzle kernel".
-0002f630: 2020 2020 6865 6164 6572 5b27 4452 495a      header['DRIZ
-0002f640: 5049 5846 275d 203d 2070 6978 6672 6163  PIXF'] = pixfrac
-0002f650: 2c20 2244 7269 7a7a 6c65 2070 6978 6672  , "Drizzle pixfr
-0002f660: 6163 220a 0a20 2020 2069 6620 6e6f 7420  ac"..    if not 
-0002f670: 6861 7361 7474 7228 6f75 7470 7574 7763  hasattr(outputwc
-0002f680: 732c 2027 5f6e 6178 6973 3127 293a 0a20  s, '_naxis1'):. 
-0002f690: 2020 2020 2020 206f 7574 7075 7477 6373         outputwcs
-0002f6a0: 2e5f 6e61 7869 7331 2c20 6f75 7470 7574  ._naxis1, output
-0002f6b0: 7763 732e 5f6e 6178 6973 3220 3d20 6f75  wcs._naxis2 = ou
-0002f6c0: 7470 7574 7763 732e 5f6e 6178 6973 0a0a  tputwcs._naxis..
-0002f6d0: 2020 2020 2320 5472 7920 746f 2066 6978      # Try to fix
-0002f6e0: 2064 6570 7265 6361 7465 6420 5743 530a   deprecated WCS.
-0002f6f0: 2020 2020 666f 7220 7763 735f 6920 696e      for wcs_i in
-0002f700: 2077 6373 5f6c 6973 743a 0a20 2020 2020   wcs_list:.     
-0002f710: 2020 2069 6620 6e6f 7420 6861 7361 7474     if not hasatt
-0002f720: 7228 7763 735f 692c 2027 7069 7865 6c5f  r(wcs_i, 'pixel_
-0002f730: 7368 6170 6527 293a 0a20 2020 2020 2020  shape'):.       
-0002f740: 2020 2020 2077 6373 5f69 2e70 6978 656c       wcs_i.pixel
-0002f750: 5f73 6861 7065 203d 2077 6373 5f69 2e5f  _shape = wcs_i._
-0002f760: 6e61 7869 7331 2c20 7763 735f 692e 5f6e  naxis1, wcs_i._n
-0002f770: 6178 6973 320a 0a20 2020 2020 2020 2069  axis2..        i
-0002f780: 6620 6e6f 7420 6861 7361 7474 7228 7763  f not hasattr(wc
-0002f790: 735f 692c 2027 5f6e 6178 6973 3127 293a  s_i, '_naxis1'):
-0002f7a0: 0a20 2020 2020 2020 2020 2020 2077 6373  .            wcs
-0002f7b0: 5f69 2e5f 6e61 7869 7331 2c20 7763 735f  _i._naxis1, wcs_
-0002f7c0: 692e 5f6e 6178 6973 3220 3d20 7763 735f  i._naxis2 = wcs_
-0002f7d0: 692e 5f6e 6178 6973 5b3a 325d 0a0a 2020  i._naxis[:2]..  
-0002f7e0: 2020 2320 4f75 7470 7574 2057 4353 2072    # Output WCS r
-0002f7f0: 6571 7569 7265 7320 6675 6c6c 2057 4353  equires full WCS
-0002f800: 206d 6170 3f0a 2020 2020 6966 2063 616c   map?.    if cal
-0002f810: 635f 7763 736d 6170 203c 2032 3a0a 2020  c_wcsmap < 2:.  
-0002f820: 2020 2020 2020 6374 7970 6520 3d20 6f75        ctype = ou
-0002f830: 7470 7574 7763 732e 7763 732e 6374 7970  tputwcs.wcs.ctyp
-0002f840: 650a 2020 2020 2020 2020 6966 2027 2d53  e.        if '-S
-0002f850: 4950 2720 696e 2063 7479 7065 5b30 5d3a  IP' in ctype[0]:
-0002f860: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0002f870: 6e74 2827 4f75 7470 7574 2057 4353 2028  nt('Output WCS (
-0002f880: 7b30 7d29 2072 6571 7569 7265 7320 6063  {0}) requires `c
-0002f890: 616c 635f 7763 736d 6170 3d32 6027 2e66  alc_wcsmap=2`'.f
-0002f8a0: 6f72 6d61 7428 6374 7970 6529 290a 2020  ormat(ctype)).  
-0002f8b0: 2020 2020 2020 2020 2020 6361 6c63 5f77            calc_w
-0002f8c0: 6373 6d61 7020 3d20 320a 2020 2020 2020  csmap = 2.      
-0002f8d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002f8e0: 2020 2020 2320 496e 7465 726e 616c 2057      # Internal W
-0002f8f0: 4353 4d41 5020 6e6f 7420 7265 7175 6972  CSMAP not requir
-0002f900: 6564 0a20 2020 2020 2020 2020 2020 2063  ed.            c
-0002f910: 616c 635f 7763 736d 6170 203d 2030 0a0a  alc_wcsmap = 0..
-0002f920: 2020 2020 7368 6170 6520 3d20 2868 6561      shape = (hea
-0002f930: 6465 725b 274e 4158 4953 3227 5d2c 2068  der['NAXIS2'], h
-0002f940: 6561 6465 725b 274e 4158 4953 3127 5d29  eader['NAXIS1'])
-0002f950: 0a0a 2020 2020 2320 4f75 7470 7574 2061  ..    # Output a
-0002f960: 7272 6179 730a 2020 2020 6966 2064 6174  rrays.    if dat
-0002f970: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
-0002f980: 2020 2020 2020 206f 7574 7363 692c 206f         outsci, o
-0002f990: 7574 7768 742c 206f 7574 6374 7820 3d20  utwht, outctx = 
-0002f9a0: 6461 7461 0a20 2020 2065 6c73 653a 0a20  data.    else:. 
-0002f9b0: 2020 2020 2020 206f 7574 7363 6920 3d20         outsci = 
-0002f9c0: 6e70 2e7a 6572 6f73 2873 6861 7065 2c20  np.zeros(shape, 
-0002f9d0: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
-0002f9e0: 290a 2020 2020 2020 2020 6f75 7477 6874  ).        outwht
-0002f9f0: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
-0002fa00: 652c 2064 7479 7065 3d6e 702e 666c 6f61  e, dtype=np.floa
-0002fa10: 7433 3229 0a20 2020 2020 2020 206f 7574  t32).        out
-0002fa20: 6374 7820 3d20 6e70 2e7a 6572 6f73 2873  ctx = np.zeros(s
-0002fa30: 6861 7065 2c20 6474 7970 653d 6e70 2e69  hape, dtype=np.i
-0002fa40: 6e74 3332 290a 0a20 2020 2023 2044 6f20  nt32)..    # Do 
-0002fa50: 6472 697a 7a6c 650a 2020 2020 4e20 3d20  drizzle.    N = 
-0002fa60: 6c65 6e28 7363 695f 6c69 7374 290a 2020  len(sci_list).  
-0002fa70: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0002fa80: 284e 293a 0a20 2020 2020 2020 2069 6620  (N):.        if 
-0002fa90: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0002faa0: 2020 2020 2023 6c6f 672e 696e 666f 2827       #log.info('
-0002fab0: 4472 697a 7a6c 6520 6172 7261 7920 7b30  Drizzle array {0
-0002fac0: 7d2f 7b31 7d27 2e66 6f72 6d61 7428 692b  }/{1}'.format(i+
-0002fad0: 312c 204e 2929 0a20 2020 2020 2020 2020  1, N)).         
-0002fae0: 2020 206d 7367 203d 2027 4472 697a 7a6c     msg = 'Drizzl
-0002faf0: 6520 6172 7261 7920 7b30 7d2f 7b31 7d27  e array {0}/{1}'
-0002fb00: 2e66 6f72 6d61 7428 692b 312c 204e 290a  .format(i+1, N).
-0002fb10: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-0002fb20: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
-0002fb30: 206d 7367 2c20 7665 7262 6f73 653d 7665   msg, verbose=ve
-0002fb40: 7262 6f73 652c 2073 686f 775f 6461 7465  rbose, show_date
-0002fb50: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-0002fb60: 6966 2063 616c 635f 7763 736d 6170 203e  if calc_wcsmap >
-0002fb70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0002fb80: 7763 736d 6170 203d 2057 4353 4d61 7041  wcsmap = WCSMapA
-0002fb90: 6c6c 2020 2320 2877 6373 5f6c 6973 745b  ll  # (wcs_list[
-0002fba0: 695d 2c20 6f75 7470 7574 7763 7329 0a20  i], outputwcs). 
-0002fbb0: 2020 2020 2020 2020 2020 2023 7763 736d             #wcsm
-0002fbc0: 6170 203d 2063 6472 697a 2e44 6566 6175  ap = cdriz.Defau
-0002fbd0: 6c74 5743 534d 6170 7069 6e67 0a20 2020  ltWCSMapping.   
-0002fbe0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002fbf0: 2020 2020 2020 2077 6373 6d61 7020 3d20         wcsmap = 
-0002fc00: 4e6f 6e65 0a0a 2020 2020 2020 2020 6164  None..        ad
-0002fc10: 7269 7a7a 6c65 2e64 6f5f 6472 697a 2873  rizzle.do_driz(s
-0002fc20: 6369 5f6c 6973 745b 695d 2e61 7374 7970  ci_list[i].astyp
-0002fc30: 6528 6e70 2e66 6c6f 6174 3332 2c20 636f  e(np.float32, co
-0002fc40: 7079 3d46 616c 7365 292c 0a20 2020 2020  py=False),.     
-0002fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc60: 2020 2020 7763 735f 6c69 7374 5b69 5d2c      wcs_list[i],
-0002fc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fc80: 2020 2020 2020 2020 2020 7768 745f 6c69            wht_li
-0002fc90: 7374 5b69 5d2e 6173 7479 7065 286e 702e  st[i].astype(np.
-0002fca0: 666c 6f61 7433 322c 2063 6f70 793d 4661  float32, copy=Fa
-0002fcb0: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
-0002fcc0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0002fcd0: 7574 7075 7477 6373 2c20 6f75 7473 6369  utputwcs, outsci
-0002fce0: 2c20 6f75 7477 6874 2c20 6f75 7463 7478  , outwht, outctx
-0002fcf0: 2c20 312e 2c20 2763 7073 272c 2031 2c0a  , 1., 'cps', 1,.
-0002fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd10: 2020 2020 2020 2020 2077 6373 6c69 6e5f           wcslin_
-0002fd20: 7073 6361 6c65 3d77 6373 5f6c 6973 745b  pscale=wcs_list[
-0002fd30: 695d 2e70 7363 616c 652c 2075 6e69 7169  i].pscale, uniqi
-0002fd40: 643d 312c 0a20 2020 2020 2020 2020 2020  d=1,.           
-0002fd50: 2020 2020 2020 2020 2020 2020 2020 7069                pi
-0002fd60: 7866 7261 633d 7069 7866 7261 632c 206b  xfrac=pixfrac, k
-0002fd70: 6572 6e65 6c3d 6b65 726e 656c 2c20 6669  ernel=kernel, fi
-0002fd80: 6c6c 7661 6c3d 2730 272c 0a20 2020 2020  llval='0',.     
-0002fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fda0: 2020 2020 7763 736d 6170 3d77 6373 6d61      wcsmap=wcsma
-0002fdb0: 7029 0a0a 2020 2020 7265 7475 726e 206f  p)..    return o
-0002fdc0: 7574 7363 692c 206f 7574 7768 742c 206f  utsci, outwht, o
-0002fdd0: 7574 6374 782c 2068 6561 6465 722c 206f  utctx, header, o
-0002fde0: 7574 7075 7477 6373 0a0a 0a63 6c61 7373  utputwcs...class
-0002fdf0: 2057 4353 4d61 7041 6c6c 3a0a 2020 2020   WCSMapAll:.    
-0002fe00: 2222 2220 5361 6d70 6c65 2063 6c61 7373  """ Sample class
-0002fe10: 2074 6f20 6465 6d6f 6e73 7472 6174 6520   to demonstrate 
-0002fe20: 686f 7720 746f 2064 6566 696e 6520 6120  how to define a 
-0002fe30: 636f 6f72 6469 6e61 7465 2074 7261 6e73  coordinate trans
-0002fe40: 666f 726d 6174 696f 6e0a 2020 2020 2222  formation.    ""
-0002fe50: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
-0002fe60: 745f 5f28 7365 6c66 2c20 696e 7075 742c  t__(self, input,
-0002fe70: 206f 7574 7075 742c 206f 7269 6769 6e3d   output, origin=
-0002fe80: 3029 3a0a 2020 2020 2020 2020 2320 5665  0):.        # Ve
-0002fe90: 7269 6679 2074 6861 7420 7765 2068 6176  rify that we hav
-0002fea0: 6520 7661 6c69 6420 5743 5320 696e 7075  e valid WCS inpu
-0002feb0: 7420 6f62 6a65 6374 730a 2020 2020 2020  t objects.      
-0002fec0: 2020 696d 706f 7274 2063 6f70 790a 2020    import copy.  
-0002fed0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
-0002fee0: 5743 5328 696e 7075 742c 2027 496e 7075  WCS(input, 'Inpu
-0002fef0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-0002ff00: 2e63 6865 636b 5743 5328 6f75 7470 7574  .checkWCS(output
-0002ff10: 2c20 274f 7574 7075 7427 290a 0a20 2020  , 'Output')..   
-0002ff20: 2020 2020 2073 656c 662e 696e 7075 7420       self.input 
-0002ff30: 3d20 696e 7075 740a 2020 2020 2020 2020  = input.        
-0002ff40: 7365 6c66 2e6f 7574 7075 7420 3d20 636f  self.output = co
-0002ff50: 7079 2e64 6565 7063 6f70 7928 6f75 7470  py.deepcopy(outp
-0002ff60: 7574 290a 2020 2020 2020 2020 2373 656c  ut).        #sel
-0002ff70: 662e 6f75 7470 7574 203d 206f 7574 7075  f.output = outpu
-0002ff80: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-0002ff90: 6f72 6967 696e 203d 2031 2023 6f72 6967  origin = 1 #orig
-0002ffa0: 696e 0a20 2020 2020 2020 2073 656c 662e  in.        self.
-0002ffb0: 7368 6966 7420 3d20 4e6f 6e65 0a20 2020  shift = None.   
-0002ffc0: 2020 2020 2073 656c 662e 726f 7420 3d20       self.rot = 
-0002ffd0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0002ffe0: 662e 7363 616c 6520 3d20 4e6f 6e65 0a0a  f.scale = None..
-0002fff0: 2020 2020 6465 6620 6368 6563 6b57 4353      def checkWCS
-00030000: 2873 656c 662c 206f 626a 2c20 6e61 6d65  (self, obj, name
-00030010: 293a 0a20 2020 2020 2020 2074 7279 3a0a  ):.        try:.
-00030020: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00030030: 7274 2069 7369 6e73 7461 6e63 6528 6f62  rt isinstance(ob
-00030040: 6a2c 2070 7977 6373 2e57 4353 290a 2020  j, pywcs.WCS).  
-00030050: 2020 2020 2020 6578 6365 7074 2041 7373        except Ass
-00030060: 6572 7469 6f6e 4572 726f 723a 0a20 2020  ertionError:.   
-00030070: 2020 2020 2020 2020 2070 7269 6e74 286e           print(n
-00030080: 616d 6520 2b20 2720 6f62 6a65 6374 206e  ame + ' object n
-00030090: 6565 6473 2074 6f20 6265 2061 6e20 696e  eeds to be an in
-000300a0: 7374 616e 6365 206f 7220 7375 6263 6c61  stance or subcla
-000300b0: 7373 206f 6620 6120 5079 5743 5320 6f62  ss of a PyWCS ob
-000300c0: 6a65 6374 2e27 290a 2020 2020 2020 2020  ject.').        
-000300d0: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
-000300e0: 6566 2066 6f72 7761 7264 2873 656c 662c  ef forward(self,
-000300f0: 2070 6978 782c 2070 6978 7929 3a0a 2020   pixx, pixy):.  
-00030100: 2020 2020 2020 2222 2220 5472 616e 7366        """ Transf
-00030110: 6f72 6d20 7468 6520 696e 7075 7420 7069  orm the input pi
-00030120: 7878 2c70 6978 7920 706f 7369 7469 6f6e  xx,pixy position
-00030130: 7320 696e 2074 6865 2069 6e70 7574 2066  s in the input f
-00030140: 7261 6d65 0a20 2020 2020 2020 2020 2020  rame.           
-00030150: 2074 6f20 7069 7865 6c20 706f 7369 7469   to pixel positi
-00030160: 6f6e 7320 696e 2074 6865 206f 7574 7075  ons in the outpu
-00030170: 7420 6672 616d 652e 0a0a 2020 2020 2020  t frame...      
-00030180: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
-00030190: 6420 6765 7473 2070 6173 7365 6420 746f  d gets passed to
-000301a0: 2074 6865 2064 7269 7a7a 6c65 2061 6c67   the drizzle alg
-000301b0: 6f72 6974 686d 2e0a 2020 2020 2020 2020  orithm..        
-000301c0: 2222 220a 2020 2020 2020 2020 2320 5468  """.        # Th
-000301d0: 6973 206d 6174 6368 6573 2057 5452 4158  is matches WTRAX
-000301e0: 5920 7265 7375 6c74 7320 746f 2062 6574  Y results to bet
-000301f0: 7465 7220 7468 616e 2031 652d 3420 7069  ter than 1e-4 pi
-00030200: 7865 6c73 2e0a 2020 2020 2020 2020 736b  xels..        sk
-00030210: 7978 2c20 736b 7979 203d 2073 656c 662e  yx, skyy = self.
-00030220: 696e 7075 742e 616c 6c5f 7069 7832 776f  input.all_pix2wo
-00030230: 726c 6428 7069 7878 2c20 7069 7879 2c20  rld(pixx, pixy, 
-00030240: 7365 6c66 2e6f 7269 6769 6e29 0a20 2020  self.origin).   
-00030250: 2020 2020 2072 6573 756c 7420 3d20 7365       result = se
-00030260: 6c66 2e6f 7574 7075 742e 616c 6c5f 776f  lf.output.all_wo
-00030270: 726c 6432 7069 7828 736b 7978 2c20 736b  rld2pix(skyx, sk
-00030280: 7979 2c20 7365 6c66 2e6f 7269 6769 6e29  yy, self.origin)
-00030290: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000302a0: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
-000302b0: 6261 636b 7761 7264 2873 656c 662c 2070  backward(self, p
-000302c0: 6978 782c 2070 6978 7929 3a0a 2020 2020  ixx, pixy):.    
-000302d0: 2020 2020 2222 2220 5472 616e 7366 6f72      """ Transfor
-000302e0: 6d20 7069 7878 2c70 6978 7920 706f 7369  m pixx,pixy posi
-000302f0: 7469 6f6e 7320 6672 6f6d 2074 6865 206f  tions from the o
-00030300: 7574 7075 7420 6672 616d 6520 6261 636b  utput frame back
-00030310: 206f 6e74 6f20 7468 6569 720a 2020 2020   onto their.    
-00030320: 2020 2020 2020 2020 6f72 6967 696e 616c          original
-00030330: 2070 6f73 6974 696f 6e73 2069 6e20 7468   positions in th
-00030340: 6520 696e 7075 7420 6672 616d 652e 0a20  e input frame.. 
-00030350: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00030360: 2020 2073 6b79 782c 2073 6b79 7920 3d20     skyx, skyy = 
-00030370: 7365 6c66 2e6f 7574 7075 742e 616c 6c5f  self.output.all_
-00030380: 7069 7832 776f 726c 6428 7069 7878 2c20  pix2world(pixx, 
-00030390: 7069 7879 2c20 7365 6c66 2e6f 7269 6769  pixy, self.origi
-000303a0: 6e29 0a20 2020 2020 2020 2072 6573 756c  n).        resul
-000303b0: 7420 3d20 7365 6c66 2e69 6e70 7574 2e61  t = self.input.a
-000303c0: 6c6c 5f77 6f72 6c64 3270 6978 2873 6b79  ll_world2pix(sky
-000303d0: 782c 2073 6b79 792c 2073 656c 662e 6f72  x, skyy, self.or
-000303e0: 6967 696e 290a 2020 2020 2020 2020 7265  igin).        re
-000303f0: 7475 726e 2072 6573 756c 740a 0a20 2020  turn result..   
-00030400: 2064 6566 2067 6574 5f70 6978 5f72 6174   def get_pix_rat
-00030410: 696f 2873 656c 6629 3a0a 2020 2020 2020  io(self):.      
-00030420: 2020 2222 2220 5265 7475 726e 2074 6865    """ Return the
-00030430: 2072 6174 696f 206f 6620 706c 6174 6520   ratio of plate 
-00030440: 7363 616c 6573 2062 6574 7765 656e 2074  scales between t
-00030450: 6865 2069 6e70 7574 2061 6e64 206f 7574  he input and out
-00030460: 7075 7420 5743 532e 0a20 2020 2020 2020  put WCS..       
-00030470: 2020 2020 2054 6869 7320 6973 2075 7365       This is use
-00030480: 6420 746f 2070 726f 7065 726c 7920 6469  d to properly di
-00030490: 7374 7269 6275 7465 2074 6865 2066 6c75  stribute the flu
-000304a0: 7820 696e 2065 6163 6820 7069 7865 6c20  x in each pixel 
-000304b0: 696e 2027 7464 7269 7a27 2e0a 2020 2020  in 'tdriz'..    
-000304c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000304d0: 7265 7475 726e 2073 656c 662e 6f75 7470  return self.outp
-000304e0: 7574 2e70 7363 616c 6520 2f20 7365 6c66  ut.pscale / self
-000304f0: 2e69 6e70 7574 2e70 7363 616c 650a 0a20  .input.pscale.. 
-00030500: 2020 2064 6566 2078 7932 7264 2873 656c     def xy2rd(sel
-00030510: 662c 2077 6373 2c20 7069 7878 2c20 7069  f, wcs, pixx, pi
-00030520: 7879 293a 0a20 2020 2020 2020 2022 2222  xy):.        """
-00030530: 2054 7261 6e73 666f 726d 2069 6e70 7574   Transform input
-00030540: 2070 6978 656c 2070 6f73 6974 696f 6e73   pixel positions
-00030550: 2069 6e74 6f20 736b 7920 706f 7369 7469   into sky positi
-00030560: 6f6e 7320 696e 2074 6865 2057 4353 2070  ons in the WCS p
-00030570: 726f 7669 6465 642e 0a20 2020 2020 2020  rovided..       
-00030580: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00030590: 7572 6e20 7763 732e 616c 6c5f 7069 7832  urn wcs.all_pix2
-000305a0: 776f 726c 6428 7069 7878 2c20 7069 7879  world(pixx, pixy
-000305b0: 2c20 3129 0a0a 2020 2020 6465 6620 7264  , 1)..    def rd
-000305c0: 3278 7928 7365 6c66 2c20 7763 732c 2072  2xy(self, wcs, r
-000305d0: 612c 2064 6563 293a 0a20 2020 2020 2020  a, dec):.       
-000305e0: 2022 2222 2054 7261 6e73 666f 726d 2069   """ Transform i
-000305f0: 6e70 7574 2073 6b79 2070 6f73 6974 696f  nput sky positio
-00030600: 6e73 2069 6e74 6f20 7069 7865 6c20 706f  ns into pixel po
-00030610: 7369 7469 6f6e 7320 696e 2074 6865 2057  sitions in the W
-00030620: 4353 2070 726f 7669 6465 642e 0a20 2020  CS provided..   
-00030630: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00030640: 2072 6574 7572 6e20 7763 732e 616c 6c5f   return wcs.all_
-00030650: 776f 726c 6432 7069 7828 7261 2c20 6465  world2pix(ra, de
-00030660: 632c 2031 290a 0a0a 6465 6620 636f 6d70  c, 1)...def comp
-00030670: 7574 655f 6f75 7470 7574 5f77 6373 2877  ute_output_wcs(w
-00030680: 6373 5f6c 6973 742c 2070 6978 656c 5f73  cs_list, pixel_s
-00030690: 6361 6c65 3d30 2e31 2c20 6d61 785f 7369  cale=0.1, max_si
-000306a0: 7a65 3d31 3030 3030 293a 0a20 2020 2022  ze=10000):.    "
-000306b0: 2222 0a20 2020 2043 6f6d 7075 7465 206f  "".    Compute o
-000306c0: 7574 7075 7420 5743 5320 7468 6174 2063  utput WCS that c
-000306d0: 6f6e 7461 696e 7320 7468 6520 6675 6c6c  ontains the full
-000306e0: 206c 6973 7420 6f66 2069 6e70 7574 2057   list of input W
-000306f0: 4353 0a0a 2020 2020 5061 7261 6d65 7465  CS..    Paramete
-00030700: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00030710: 2d0a 2020 2020 7763 735f 6c69 7374 203a  -.    wcs_list :
-00030720: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
-00030730: 7374 206f 6620 696e 6469 7669 6475 616c  st of individual
-00030740: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
-00030750: 4353 6020 6f62 6a65 6374 732e 0a0a 2020  CS` objects...  
-00030760: 2020 7069 7865 6c5f 7363 616c 6520 3a20    pixel_scale : 
-00030770: 7479 7065 0a20 2020 2020 2020 2050 6978  type.        Pix
-00030780: 656c 2073 6361 6c65 206f 6620 7468 6520  el scale of the 
-00030790: 6f75 7470 7574 2057 4353 0a0a 2020 2020  output WCS..    
-000307a0: 6d61 785f 7369 7a65 203a 2069 6e74 0a20  max_size : int. 
-000307b0: 2020 2020 2020 204d 6178 696d 756d 2073         Maximum s
-000307c0: 697a 6520 6f75 7420 7468 6520 6f75 7470  ize out the outp
-000307d0: 7574 2069 6d61 6765 2064 696d 656e 7369  ut image dimensi
-000307e0: 6f6e 730a 0a20 2020 2052 6574 7572 6e73  ons..    Returns
-000307f0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00030800: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
-00030810: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-00030820: 6572 600a 2020 2020 2020 2020 5743 5320  er`.        WCS 
-00030830: 6865 6164 6572 0a0a 2020 2020 6f75 7470  header..    outp
-00030840: 7574 7763 7320 3a20 607e 6173 7472 6f70  utwcs : `~astrop
-00030850: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
-00030860: 2020 204f 7574 7075 7420 5743 530a 0a20     Output WCS.. 
-00030870: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
-00030880: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
-00030890: 2069 6d70 6f72 7420 506f 6c79 676f 6e0a   import Polygon.
-000308a0: 0a20 2020 2066 6f6f 7470 7269 6e74 203d  .    footprint =
-000308b0: 2050 6f6c 7967 6f6e 2877 6373 5f6c 6973   Polygon(wcs_lis
-000308c0: 745b 305d 2e63 616c 635f 666f 6f74 7072  t[0].calc_footpr
-000308d0: 696e 7428 2929 0a20 2020 2066 6f72 2069  int()).    for i
-000308e0: 2069 6e20 7261 6e67 6528 312c 206c 656e   in range(1, len
-000308f0: 2877 6373 5f6c 6973 7429 293a 0a20 2020  (wcs_list)):.   
-00030900: 2020 2020 2066 705f 6920 3d20 506f 6c79       fp_i = Poly
-00030910: 676f 6e28 7763 735f 6c69 7374 5b69 5d2e  gon(wcs_list[i].
-00030920: 6361 6c63 5f66 6f6f 7470 7269 6e74 2829  calc_footprint()
-00030930: 290a 2020 2020 2020 2020 666f 6f74 7072  ).        footpr
-00030940: 696e 7420 3d20 666f 6f74 7072 696e 742e  int = footprint.
-00030950: 756e 696f 6e28 6670 5f69 290a 0a20 2020  union(fp_i)..   
-00030960: 2078 2c20 7920 3d20 666f 6f74 7072 696e   x, y = footprin
-00030970: 742e 636f 6e76 6578 5f68 756c 6c2e 626f  t.convex_hull.bo
-00030980: 756e 6461 7279 2e78 790a 2020 2020 782c  undary.xy.    x,
-00030990: 2079 203d 206e 702e 6172 7261 7928 7829   y = np.array(x)
-000309a0: 2c20 6e70 2e61 7272 6179 2879 290a 0a20  , np.array(y).. 
-000309b0: 2020 2023 2063 656e 7465 720a 2020 2020     # center.    
-000309c0: 6372 7661 6c20 3d20 6e70 2e61 7272 6179  crval = np.array
-000309d0: 2866 6f6f 7470 7269 6e74 2e63 656e 7472  (footprint.centr
-000309e0: 6f69 642e 7879 292e 666c 6174 7465 6e28  oid.xy).flatten(
-000309f0: 290a 0a20 2020 2023 2064 696d 656e 7369  )..    # dimensi
-00030a00: 6f6e 7320 696e 2061 7263 7365 630a 2020  ons in arcsec.  
-00030a10: 2020 7873 697a 6520 3d20 2878 2e6d 6178    xsize = (x.max
-00030a20: 2829 2d78 2e6d 696e 2829 292a 6e70 2e63  ()-x.min())*np.c
-00030a30: 6f73 2863 7276 616c 5b31 5d2f 3138 302a  os(crval[1]/180*
-00030a40: 6e70 2e70 6929 2a33 3630 300a 2020 2020  np.pi)*3600.    
-00030a50: 7973 697a 6520 3d20 2879 2e6d 6178 2829  ysize = (y.max()
-00030a60: 2d79 2e6d 696e 2829 292a 3336 3030 0a0a  -y.min())*3600..
-00030a70: 2020 2020 7873 697a 6520 3d20 6e70 2e6d      xsize = np.m
-00030a80: 696e 696d 756d 2878 7369 7a65 2c20 6d61  inimum(xsize, ma
-00030a90: 785f 7369 7a65 2a70 6978 656c 5f73 6361  x_size*pixel_sca
-00030aa0: 6c65 290a 2020 2020 7973 697a 6520 3d20  le).    ysize = 
-00030ab0: 6e70 2e6d 696e 696d 756d 2879 7369 7a65  np.minimum(ysize
-00030ac0: 2c20 6d61 785f 7369 7a65 2a70 6978 656c  , max_size*pixel
-00030ad0: 5f73 6361 6c65 290a 0a20 2020 2068 6561  _scale)..    hea
-00030ae0: 6465 722c 206f 7574 7075 7477 6373 203d  der, outputwcs =
-00030af0: 206d 616b 655f 7763 7368 6561 6465 7228   make_wcsheader(
-00030b00: 7261 3d63 7276 616c 5b30 5d2c 2064 6563  ra=crval[0], dec
-00030b10: 3d63 7276 616c 5b31 5d2c 0a20 2020 2020  =crval[1],.     
-00030b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b30: 7369 7a65 3d28 7873 697a 652c 2079 7369  size=(xsize, ysi
-00030b40: 7a65 292c 0a20 2020 2020 2020 2020 2020  ze),.           
-00030b50: 2020 2020 2020 2020 2020 7069 7873 6361            pixsca
-00030b60: 6c65 3d70 6978 656c 5f73 6361 6c65 2c0a  le=pixel_scale,.
-00030b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b80: 2020 2020 2067 6574 5f68 6475 3d46 616c       get_hdu=Fal
-00030b90: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00030ba0: 2020 2020 2020 2020 2074 6865 7461 3d30           theta=0
-00030bb0: 290a 0a20 2020 2072 6574 7572 6e20 6865  )..    return he
-00030bc0: 6164 6572 2c20 6f75 7470 7574 7763 730a  ader, outputwcs.
-00030bd0: 0a0a 6465 6620 7379 6d6c 696e 6b5f 7465  ..def symlink_te
-00030be0: 6d70 6c61 7465 7328 666f 7263 653d 4661  mplates(force=Fa
-00030bf0: 6c73 6529 3a0a 2020 2020 2222 2253 796d  lse):.    """Sym
-00030c00: 6c69 6e6b 2074 656d 706c 6174 6573 2066  link templates f
-00030c10: 726f 6d20 6d6f 6475 6c65 2074 6f20 2447  rom module to $G
-00030c20: 5249 5a4c 492f 7465 6d70 6c61 7465 7320  RIZLI/templates 
-00030c30: 6173 2070 6172 7420 6f66 2074 6865 2069  as part of the i
-00030c40: 6e69 7469 616c 2073 6574 7570 0a20 2020  nitial setup.   
-00030c50: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00030c60: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066  ----------.    f
-00030c70: 6f72 6365 203a 2062 6f6f 6c0a 2020 2020  orce : bool.    
-00030c80: 2020 2020 466f 7263 6520 6c69 6e6b 2066      Force link f
-00030c90: 696c 6573 2065 7665 6e20 6966 2074 6865  iles even if the
-00030ca0: 7920 616c 7265 6164 7920 6578 6973 742e  y already exist.
-00030cb0: 0a20 2020 2022 2222 0a20 2020 2023 2069  .    """.    # i
-00030cc0: 6620 2747 5249 5a4c 4927 206e 6f74 2069  f 'GRIZLI' not i
-00030cd0: 6e20 6f73 2e65 6e76 6972 6f6e 3a0a 2020  n os.environ:.  
-00030ce0: 2020 2320 2020 2020 7072 696e 7428 2722    #     print('"
-00030cf0: 4752 495a 4c49 2220 656e 7669 726f 6e6d  GRIZLI" environm
-00030d00: 656e 7420 7661 7269 6162 6c65 206e 6f74  ent variable not
-00030d10: 2073 6574 2127 290a 2020 2020 2320 2020   set!').    #   
-00030d20: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00030d30: 2020 2020 6d6f 6475 6c65 5f70 6174 6820      module_path 
-00030d40: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-00030d50: 6528 5f5f 6669 6c65 5f5f 290a 2020 2020  e(__file__).    
-00030d60: 7465 6d70 6c61 7465 735f 7061 7468 203d  templates_path =
-00030d70: 206f 732e 7061 7468 2e6a 6f69 6e28 6d6f   os.path.join(mo
-00030d80: 6475 6c65 5f70 6174 682c 2027 6461 7461  dule_path, 'data
-00030d90: 2f74 656d 706c 6174 6573 2729 0a0a 2020  /templates')..  
-00030da0: 2020 6f75 745f 7061 7468 203d 206f 732e    out_path = os.
-00030db0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
-00030dc0: 5f50 4154 482c 2027 7465 6d70 6c61 7465  _PATH, 'template
-00030dd0: 7327 290a 0a20 2020 2069 6620 286e 6f74  s')..    if (not
-00030de0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-00030df0: 6f75 745f 7061 7468 2929 207c 2066 6f72  out_path)) | for
-00030e00: 6365 3a0a 2020 2020 2020 2020 6966 206f  ce:.        if o
-00030e10: 732e 7061 7468 2e65 7869 7374 7328 6f75  s.path.exists(ou
-00030e20: 745f 7061 7468 293a 2020 2320 2866 6f72  t_path):  # (for
-00030e30: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
-00030e40: 7368 7574 696c 2e72 6d74 7265 6528 6f75  shutil.rmtree(ou
-00030e50: 745f 7061 7468 290a 0a20 2020 2020 2020  t_path)..       
-00030e60: 2020 2020 206f 732e 7379 6d6c 696e 6b28       os.symlink(
-00030e70: 7465 6d70 6c61 7465 735f 7061 7468 2c20  templates_path, 
-00030e80: 6f75 745f 7061 7468 290a 2020 2020 2020  out_path).      
-00030e90: 2020 2020 2020 7072 696e 7428 2753 796d        print('Sym
-00030ea0: 6c69 6e6b 3a20 7b30 7d20 2d3e 207b 317d  link: {0} -> {1}
-00030eb0: 272e 666f 726d 6174 2874 656d 706c 6174  '.format(templat
-00030ec0: 6573 5f70 6174 682c 206f 7574 5f70 6174  es_path, out_pat
-00030ed0: 6829 290a 2020 2020 656c 7365 3a0a 2020  h)).    else:.  
-00030ee0: 2020 2020 2020 7072 696e 7428 2754 656d        print('Tem
-00030ef0: 706c 6174 6573 2064 6972 6563 746f 7279  plates directory
-00030f00: 2065 7869 7374 733a 207b 307d 272e 666f   exists: {0}'.fo
-00030f10: 726d 6174 286f 7574 5f70 6174 6829 290a  rmat(out_path)).
-00030f20: 2020 2020 2020 2020 7072 696e 7428 2755          print('U
-00030f30: 7365 2060 666f 7263 653d 5472 7565 6020  se `force=True` 
-00030f40: 746f 2066 6f72 6365 2061 206e 6577 2073  to force a new s
-00030f50: 796d 626f 6c69 6320 6c69 6e6b 2e27 290a  ymbolic link.').
-00030f60: 0a0a 6465 6620 6665 7463 685f 6163 735f  ..def fetch_acs_
-00030f70: 7763 735f 6669 6c65 7328 6265 616d 735f  wcs_files(beams_
-00030f80: 6669 6c65 2c20 6275 636b 6574 5f6e 616d  file, bucket_nam
-00030f90: 653d 2767 7269 7a6c 692d 7631 2729 3a0a  e='grizli-v1'):.
-00030fa0: 2020 2020 2222 220a 2020 2020 4665 7463      """.    Fetc
-00030fb0: 6820 7763 7320 6669 6c65 7320 666f 7220  h wcs files for 
-00030fc0: 6120 6769 7665 6e20 6265 616d 732e 6669  a given beams.fi
-00030fd0: 7473 2066 696c 6573 0a20 2020 2022 2222  ts files.    """
-00030fe0: 0a20 2020 2066 726f 6d20 7572 6c6c 6962  .    from urllib
-00030ff0: 2069 6d70 6f72 7420 7265 7175 6573 740a   import request.
-00031000: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00031010: 2069 6d70 6f72 7420 626f 746f 330a 2020   import boto3.  
-00031020: 2020 2020 2020 4841 535f 424f 544f 203d        HAS_BOTO =
-00031030: 2054 7275 650a 2020 2020 6578 6365 7074   True.    except
-00031040: 3a0a 2020 2020 2020 2020 4841 535f 424f  :.        HAS_BO
-00031050: 544f 203d 2046 616c 7365 0a0a 2020 2020  TO = False..    
-00031060: 696d 203d 2070 7966 6974 732e 6f70 656e  im = pyfits.open
-00031070: 2862 6561 6d73 5f66 696c 6529 0a20 2020  (beams_file).   
-00031080: 2072 6f6f 7420 3d20 275f 272e 6a6f 696e   root = '_'.join
-00031090: 2862 6561 6d73 5f66 696c 652e 7370 6c69  (beams_file.spli
-000310a0: 7428 275f 2729 5b3a 2d31 5d29 0a0a 2020  t('_')[:-1])..  
-000310b0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-000310c0: 286c 656e 2869 6d29 293a 0a20 2020 2020  (len(im)):.     
-000310d0: 2020 2068 203d 2069 6d5b 695d 2e68 6561     h = im[i].hea
-000310e0: 6465 720a 2020 2020 2020 2020 6966 2027  der.        if '
-000310f0: 4558 544e 414d 4527 206e 6f74 2069 6e20  EXTNAME' not in 
-00031100: 683a 0a20 2020 2020 2020 2020 2020 2063  h:.            c
-00031110: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00031120: 2069 6620 2746 494c 5445 5227 206e 6f74   if 'FILTER' not
-00031130: 2069 6e20 683a 0a20 2020 2020 2020 2020   in h:.         
-00031140: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00031150: 2020 2020 2069 6620 2868 5b27 4558 544e       if (h['EXTN
-00031160: 414d 4527 5d20 213d 2027 5343 4927 2920  AME'] != 'SCI') 
-00031170: 7c20 2868 5b27 4649 4c54 4552 275d 206e  | (h['FILTER'] n
-00031180: 6f74 2069 6e20 5b27 4738 3030 4c27 5d29  ot in ['G800L'])
-00031190: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-000311a0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-000311b0: 6578 7420 3d20 7b31 3a20 322c 2032 3a20  ext = {1: 2, 2: 
-000311c0: 317d 5b68 5b27 4343 4443 4849 5027 5d5d  1}[h['CCDCHIP']]
-000311d0: 0a0a 2020 2020 2020 2020 7763 7366 696c  ..        wcsfil
-000311e0: 6520 3d20 685b 2747 5041 5245 4e54 275d  e = h['GPARENT']
-000311f0: 2e72 6570 6c61 6365 2827 2e66 6974 7327  .replace('.fits'
-00031200: 2c20 272e 7b30 3a30 3264 7d2e 7763 732e  , '.{0:02d}.wcs.
-00031210: 6669 7473 272e 666f 726d 6174 2865 7874  fits'.format(ext
-00031220: 2929 0a0a 2020 2020 2020 2020 2320 446f  ))..        # Do
-00031230: 776e 6c6f 6164 2074 6865 2066 696c 6520  wnload the file 
-00031240: 7769 7468 2053 3320 6f72 2048 5454 500a  with S3 or HTTP.
-00031250: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
-00031260: 732e 7061 7468 2e65 7869 7374 7328 7763  s.path.exists(wc
-00031270: 7366 696c 6529 3a0a 2020 2020 2020 2020  sfile):.        
-00031280: 2020 2020 7072 696e 7428 2746 6574 6368      print('Fetch
-00031290: 207b 307d 2066 726f 6d20 7b31 7d2f 5069   {0} from {1}/Pi
-000312a0: 7065 6c69 6e65 2f7b 327d 272e 666f 726d  peline/{2}'.form
-000312b0: 6174 2877 6373 6669 6c65 2c0a 2020 2020  at(wcsfile,.    
-000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312f0: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-00031300: 6d65 2c20 726f 6f74 2929 0a0a 2020 2020  me, root))..    
-00031310: 2020 2020 2020 2020 6966 2048 4153 5f42          if HAS_B
-00031320: 4f54 4f3a 0a20 2020 2020 2020 2020 2020  OTO:.           
-00031330: 2020 2020 2073 3320 3d20 626f 746f 332e       s3 = boto3.
-00031340: 7265 736f 7572 6365 2827 7333 2729 0a20  resource('s3'). 
-00031350: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00031360: 335f 636c 6965 6e74 203d 2062 6f74 6f33  3_client = boto3
-00031370: 2e63 6c69 656e 7428 2773 3327 290a 2020  .client('s3').  
-00031380: 2020 2020 2020 2020 2020 2020 2020 626b                bk
-00031390: 7420 3d20 7333 2e42 7563 6b65 7428 6275  t = s3.Bucket(bu
-000313a0: 636b 6574 5f6e 616d 6529 0a0a 2020 2020  cket_name)..    
-000313b0: 2020 2020 2020 2020 2020 2020 7333 5f70              s3_p
-000313c0: 6174 6820 3d20 2750 6970 656c 696e 652f  ath = 'Pipeline/
-000313d0: 7b30 7d2f 4578 7472 6163 7469 6f6e 732f  {0}/Extractions/
-000313e0: 7b31 7d27 2e66 6f72 6d61 7428 726f 6f74  {1}'.format(root
-000313f0: 2c20 7763 7366 696c 6529 0a20 2020 2020  , wcsfile).     
-00031400: 2020 2020 2020 2020 2020 2062 6b74 2e64             bkt.d
-00031410: 6f77 6e6c 6f61 645f 6669 6c65 2873 335f  ownload_file(s3_
-00031420: 7061 7468 2c20 272e 2f7b 307d 272e 666f  path, './{0}'.fo
-00031430: 726d 6174 2877 6373 6669 6c65 292c 0a20  rmat(wcsfile),. 
-00031440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031460: 2045 7874 7261 4172 6773 3d7b 2252 6571   ExtraArgs={"Req
-00031470: 7565 7374 5061 7965 7222 3a20 2272 6571  uestPayer": "req
-00031480: 7565 7374 6572 227d 290a 0a20 2020 2020  uester"})..     
-00031490: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000314a0: 2020 2020 2020 2020 2020 2020 2075 726c               url
-000314b0: 203d 2027 6874 7470 733a 2f2f 7333 2e61   = 'https://s3.a
-000314c0: 6d61 7a6f 6e61 7773 2e63 6f6d 2f7b 307d  mazonaws.com/{0}
-000314d0: 2f27 2e66 6f72 6d61 7428 6275 636b 6574  /'.format(bucket
-000314e0: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
-000314f0: 2020 2020 2020 2075 726c 202b 3d20 2750         url += 'P
-00031500: 6970 656c 696e 652f 7b30 7d2f 4578 7472  ipeline/{0}/Extr
-00031510: 6163 7469 6f6e 732f 7b31 7d27 2e66 6f72  actions/{1}'.for
-00031520: 6d61 7428 726f 6f74 2c20 7763 7366 696c  mat(root, wcsfil
-00031530: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-00031540: 2020 2020 7072 696e 7428 2746 6574 6368      print('Fetch
-00031550: 2057 4353 2066 696c 653a 207b 307d 272e   WCS file: {0}'.
-00031560: 666f 726d 6174 2875 726c 2929 0a20 2020  format(url)).   
-00031570: 2020 2020 2020 2020 2020 2020 2072 6571               req
-00031580: 203d 2072 6571 7565 7374 2e75 726c 7265   = request.urlre
-00031590: 7472 6965 7665 2875 726c 2c20 7763 7366  trieve(url, wcsf
-000315a0: 696c 6529 0a0a 2020 2020 696d 2e63 6c6f  ile)..    im.clo
-000315b0: 7365 2829 0a0a 0a64 6566 2066 6574 6368  se()...def fetch
-000315c0: 5f68 7374 5f63 616c 6962 2866 696c 653d  _hst_calib(file=
-000315d0: 2769 7265 6624 7563 3732 3131 336f 695f  'iref$uc72113oi_
-000315e0: 7066 6c2e 6669 7473 272c 2020 6674 7064  pfl.fits',  ftpd
-000315f0: 6972 3d27 6874 7470 733a 2f2f 6873 742d  ir='https://hst-
-00031600: 6372 6473 2e73 7473 6369 2e65 6475 2f75  crds.stsci.edu/u
-00031610: 6e63 6865 636b 6564 5f67 6574 2f72 6566  nchecked_get/ref
-00031620: 6572 656e 6365 732f 6873 742f 272c 2076  erences/hst/', v
-00031630: 6572 626f 7365 3d54 7275 652c 2072 6566  erbose=True, ref
-00031640: 5f70 6174 6873 3d7b 7d2c 2072 656d 6f76  _paths={}, remov
-00031650: 655f 636f 7272 7570 743d 5472 7565 293a  e_corrupt=True):
-00031660: 0a20 2020 2022 2222 0a20 2020 2054 4244  .    """.    TBD
-00031670: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-00031680: 6f72 7420 6f73 0a0a 2020 2020 7265 665f  ort os..    ref_
-00031690: 6469 7220 3d20 6669 6c65 2e73 706c 6974  dir = file.split
-000316a0: 2827 2427 295b 305d 0a20 2020 2063 696d  ('$')[0].    cim
-000316b0: 6720 3d20 6669 6c65 2e73 706c 6974 2827  g = file.split('
-000316c0: 7b30 7d24 272e 666f 726d 6174 2872 6566  {0}$'.format(ref
-000316d0: 5f64 6972 2929 5b31 5d0a 2020 2020 0a20  _dir))[1].    . 
-000316e0: 2020 2069 6620 7265 665f 6469 7220 696e     if ref_dir in
-000316f0: 2072 6566 5f70 6174 6873 3a0a 2020 2020   ref_paths:.    
-00031700: 2020 2020 7265 665f 7061 7468 203d 2072      ref_path = r
-00031710: 6566 5f70 6174 6873 5b72 6566 5f64 6972  ef_paths[ref_dir
-00031720: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
-00031730: 2020 2020 7265 665f 7061 7468 203d 206f      ref_path = o
-00031740: 732e 6765 7465 6e76 2872 6566 5f64 6972  s.getenv(ref_dir
-00031750: 290a 2020 2020 2020 2020 0a20 2020 2069  ).        .    i
-00031760: 7265 665f 6669 6c65 203d 206f 732e 7061  ref_file = os.pa
-00031770: 7468 2e6a 6f69 6e28 7265 665f 7061 7468  th.join(ref_path
-00031780: 2c20 6369 6d67 290a 2020 2020 6966 206e  , cimg).    if n
-00031790: 6f74 206f 732e 7061 7468 2e65 7869 7374  ot os.path.exist
-000317a0: 7328 6972 6566 5f66 696c 6529 3a0a 2020  s(iref_file):.  
-000317b0: 2020 2020 2020 6f73 2e73 7973 7465 6d28        os.system(
-000317c0: 2763 7572 6c20 2d6f 207b 307d 207b 317d  'curl -o {0} {1}
-000317d0: 2f7b 327d 272e 666f 726d 6174 2869 7265  /{2}'.format(ire
-000317e0: 665f 6669 6c65 2c20 6674 7064 6972 2c20  f_file, ftpdir, 
-000317f0: 6369 6d67 2929 0a20 2020 2020 2020 2069  cimg)).        i
-00031800: 6620 2766 6974 7327 2069 6e20 6972 6566  f 'fits' in iref
-00031810: 5f66 696c 653a 0a20 2020 2020 2020 2020  _file:.         
-00031820: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00031830: 2020 2020 2020 2020 5f69 6d20 3d20 2070          _im =  p
-00031840: 7966 6974 732e 6f70 656e 2869 7265 665f  yfits.open(iref_
-00031850: 6669 6c65 290a 2020 2020 2020 2020 2020  file).          
-00031860: 2020 2020 2020 5f69 6d2e 636c 6f73 6528        _im.close(
-00031870: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00031880: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00031890: 2020 2020 2020 6d73 6720 3d20 2827 446f        msg = ('Do
-000318a0: 776e 6c6f 6164 6564 2066 696c 6520 7b30  wnloaded file {0
-000318b0: 7d20 6170 7065 6172 7320 746f 2062 6520  } appears to be 
-000318c0: 636f 7272 7570 742e 5c6e 270a 2020 2020  corrupt.\n'.    
-000318d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000318e0: 2020 2027 4368 6563 6b20 7468 6174 207b     'Check that {
-000318f0: 317d 2f7b 327d 2065 7869 7374 7320 616e  1}/{2} exists an
-00031900: 6420 6973 2061 2076 616c 6964 2066 696c  d is a valid fil
-00031910: 6527 290a 0a20 2020 2020 2020 2020 2020  e')..           
-00031920: 2020 2020 2070 7269 6e74 286d 7367 2e66       print(msg.f
-00031930: 6f72 6d61 7428 6972 6566 5f66 696c 652c  ormat(iref_file,
-00031940: 2066 7470 6469 722c 2063 696d 6729 290a   ftpdir, cimg)).
-00031950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031960: 6966 2072 656d 6f76 655f 636f 7272 7570  if remove_corrup
-00031970: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00031980: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
-00031990: 2869 7265 665f 6669 6c65 290a 0a20 2020  (iref_file)..   
-000319a0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000319b0: 7572 6e20 4661 6c73 650a 2020 2020 656c  urn False.    el
-000319c0: 7365 3a0a 2020 2020 2020 2020 6966 2076  se:.        if v
-000319d0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-000319e0: 2020 2020 7072 696e 7428 277b 307d 2065      print('{0} e
-000319f0: 7869 7374 7327 2e66 6f72 6d61 7428 6972  xists'.format(ir
-00031a00: 6566 5f66 696c 6529 290a 0a20 2020 2072  ef_file))..    r
-00031a10: 6574 7572 6e20 6972 6566 5f66 696c 650a  eturn iref_file.
-00031a20: 0a0a 6465 6620 6665 7463 685f 6873 745f  ..def fetch_hst_
-00031a30: 6361 6c69 6273 2866 6c74 5f66 696c 652c  calibs(flt_file,
-00031a40: 2066 7470 6469 723d 2768 7474 7073 3a2f   ftpdir='https:/
-00031a50: 2f68 7374 2d63 7264 732e 7374 7363 692e  /hst-crds.stsci.
-00031a60: 6564 752f 756e 6368 6563 6b65 645f 6765  edu/unchecked_ge
-00031a70: 742f 7265 6665 7265 6e63 6573 2f68 7374  t/references/hst
-00031a80: 2f27 2c20 6361 6c69 625f 7479 7065 733d  /', calib_types=
-00031a90: 5b27 4250 4958 5441 4227 2c20 2743 4344  ['BPIXTAB', 'CCD
-00031aa0: 5441 4227 2c20 274f 5343 4e54 4142 272c  TAB', 'OSCNTAB',
-00031ab0: 2027 4352 5245 4a54 4142 272c 2027 4441   'CRREJTAB', 'DA
-00031ac0: 524b 4649 4c45 272c 2027 4e4c 494e 4649  RKFILE', 'NLINFI
-00031ad0: 4c45 272c 2027 4446 4c54 4649 4c45 272c  LE', 'DFLTFILE',
-00031ae0: 2750 464c 5446 494c 4527 2c20 2749 4d50  'PFLTFILE', 'IMP
-00031af0: 4854 5441 4227 2c20 2749 4443 5441 4227  HTTAB', 'IDCTAB'
-00031b00: 2c20 274e 504f 4c46 494c 4527 5d2c 2076  , 'NPOLFILE'], v
-00031b10: 6572 626f 7365 3d54 7275 652c 2072 6566  erbose=True, ref
-00031b20: 5f70 6174 6873 3d7b 7d29 3a0a 2020 2020  _paths={}):.    
-00031b30: 2222 220a 2020 2020 5442 440a 2020 2020  """.    TBD.    
-00031b40: 4665 7463 6820 6e65 6365 7373 6172 7920  Fetch necessary 
-00031b50: 6361 6c69 6272 6174 696f 6e20 6669 6c65  calibration file
-00031b60: 7320 6e65 6564 6564 2066 6f72 2072 756e  s needed for run
-00031b70: 6e69 6e67 2063 616c 7766 3320 6672 6f6d  ning calwf3 from
-00031b80: 2053 5453 6349 2046 5450 0a0a 2020 2020   STScI FTP..    
-00031b90: 4f6c 6420 4654 5020 6469 723a 2066 7470  Old FTP dir: ftp
-00031ba0: 3a2f 2f66 7470 2e73 7473 6369 2e65 6475  ://ftp.stsci.edu
-00031bb0: 2f63 6462 732f 6972 6566 2f22 2222 0a20  /cdbs/iref/""". 
-00031bc0: 2020 2069 6d70 6f72 7420 6f73 0a0a 2020     import os..  
-00031bd0: 2020 696d 203d 2070 7966 6974 732e 6f70    im = pyfits.op
-00031be0: 656e 2866 6c74 5f66 696c 6529 0a20 2020  en(flt_file).   
-00031bf0: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
-00031c00: 5b27 494e 5354 5255 4d45 275d 203d 3d20  ['INSTRUME'] == 
-00031c10: 2741 4353 273a 0a20 2020 2020 2020 2072  'ACS':.        r
-00031c20: 6566 5f64 6972 203d 2027 6a72 6566 270a  ef_dir = 'jref'.
-00031c30: 0a20 2020 2069 6620 696d 5b30 5d2e 6865  .    if im[0].he
-00031c40: 6164 6572 5b27 494e 5354 5255 4d45 275d  ader['INSTRUME']
-00031c50: 203d 3d20 2757 4643 3327 3a0a 2020 2020   == 'WFC3':.    
-00031c60: 2020 2020 7265 665f 6469 7220 3d20 2769      ref_dir = 'i
-00031c70: 7265 6627 0a0a 2020 2020 6966 2069 6d5b  ref'..    if im[
-00031c80: 305d 2e68 6561 6465 725b 2749 4e53 5452  0].header['INSTR
-00031c90: 554d 4527 5d20 3d3d 2027 5746 5043 3227  UME'] == 'WFPC2'
-00031ca0: 3a0a 2020 2020 2020 2020 7265 665f 6469  :.        ref_di
-00031cb0: 7220 3d20 2775 7265 6627 0a0a 2020 2020  r = 'uref'..    
-00031cc0: 6966 206e 6f74 206f 732e 6765 7465 6e76  if not os.getenv
-00031cd0: 2872 6566 5f64 6972 293a 0a20 2020 2020  (ref_dir):.     
-00031ce0: 2020 2070 7269 6e74 2827 4e6f 2024 7b30     print('No ${0
-00031cf0: 7d20 7365 7421 2020 5075 7420 6974 2069  } set!  Put it i
-00031d00: 6e20 7e2f 2e62 6173 6872 6320 6f72 207e  n ~/.bashrc or ~
-00031d10: 2f2e 6373 6872 632e 272e 666f 726d 6174  /.cshrc.'.format
-00031d20: 2872 6566 5f64 6972 2929 0a20 2020 2020  (ref_dir)).     
-00031d30: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-00031d40: 0a20 2020 2063 616c 6962 5f70 6174 6873  .    calib_paths
-00031d50: 203d 205b 5d0a 0a20 2020 2066 6f72 2063   = []..    for c
-00031d60: 7479 7065 2069 6e20 6361 6c69 625f 7479  type in calib_ty
-00031d70: 7065 733a 0a20 2020 2020 2020 2069 6620  pes:.        if 
-00031d80: 6374 7970 6520 6e6f 7420 696e 2069 6d5b  ctype not in im[
-00031d90: 305d 2e68 6561 6465 723a 0a20 2020 2020  0].header:.     
-00031da0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00031db0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-00031dc0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00031dd0: 2070 7269 6e74 2827 4361 6c69 623a 207b   print('Calib: {
-00031de0: 307d 3d7b 317d 272e 666f 726d 6174 2863  0}={1}'.format(c
-00031df0: 7479 7065 2c20 696d 5b30 5d2e 6865 6164  type, im[0].head
-00031e00: 6572 5b63 7479 7065 5d29 290a 0a20 2020  er[ctype]))..   
-00031e10: 2020 2020 2069 6620 696d 5b30 5d2e 6865       if im[0].he
-00031e20: 6164 6572 5b63 7479 7065 5d20 3d3d 2027  ader[ctype] == '
-00031e30: 4e2f 4127 3a0a 2020 2020 2020 2020 2020  N/A':.          
-00031e40: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00031e50: 2020 2020 7061 7468 203d 2066 6574 6368      path = fetch
-00031e60: 5f68 7374 5f63 616c 6962 2869 6d5b 305d  _hst_calib(im[0]
-00031e70: 2e68 6561 6465 725b 6374 7970 655d 2c20  .header[ctype], 
-00031e80: 6674 7064 6972 3d66 7470 6469 722c 0a20  ftpdir=ftpdir,. 
-00031e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ea0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00031eb0: 7262 6f73 653d 7665 7262 6f73 652c 2072  rbose=verbose, r
-00031ec0: 6566 5f70 6174 6873 3d72 6566 5f70 6174  ef_paths=ref_pat
-00031ed0: 6873 290a 2020 2020 2020 2020 6361 6c69  hs).        cali
-00031ee0: 625f 7061 7468 732e 6170 7065 6e64 2870  b_paths.append(p
-00031ef0: 6174 6829 0a20 2020 200a 2020 2020 696d  ath).    .    im
-00031f00: 2e63 6c6f 7365 2829 0a20 2020 200a 2020  .close().    .  
-00031f10: 2020 7265 7475 726e 2063 616c 6962 5f70    return calib_p
-00031f20: 6174 6873 0a0a 0a64 6566 206d 6173 745f  aths...def mast_
-00031f30: 7175 6572 795f 6672 6f6d 5f66 696c 655f  query_from_file_
-00031f40: 6c69 7374 2866 696c 6573 3d5b 5d2c 206f  list(files=[], o
-00031f50: 735f 6f70 656e 3d54 7275 6529 3a0a 2020  s_open=True):.  
-00031f60: 2020 2222 220a 2020 2020 4765 6e65 7261    """.    Genera
-00031f70: 7465 2061 204d 4153 5420 7175 6572 7920  te a MAST query 
-00031f80: 6f6e 2064 6174 6173 6574 7320 696e 2061  on datasets in a
-00031f90: 206c 6973 742e 0a20 2020 2022 2222 0a20   list..    """. 
-00031fa0: 2020 2069 6620 6c65 6e28 6669 6c65 7329     if len(files)
-00031fb0: 203d 3d20 303a 0a20 2020 2020 2020 2066   == 0:.        f
-00031fc0: 696c 6573 203d 2067 6c6f 622e 676c 6f62  iles = glob.glob
-00031fd0: 2827 2a72 6177 2e66 6974 7327 290a 0a20  ('*raw.fits').. 
-00031fe0: 2020 2069 6620 6c65 6e28 6669 6c65 7329     if len(files)
-00031ff0: 203d 3d20 303a 0a20 2020 2020 2020 2070   == 0:.        p
-00032000: 7269 6e74 2827 4e6f 2060 6669 6c65 7360  rint('No `files`
-00032010: 2073 7065 6369 6669 6564 2e27 290a 2020   specified.').  
-00032020: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00032030: 7365 0a0a 2020 2020 6461 7461 7365 7473  se..    datasets
-00032040: 203d 206e 702e 756e 6971 7565 285b 6669   = np.unique([fi
-00032050: 6c65 5b3a 365d 2b27 2a27 2066 6f72 2066  le[:6]+'*' for f
-00032060: 696c 6520 696e 2066 696c 6573 5d29 2e74  ile in files]).t
-00032070: 6f6c 6973 7428 290a 2020 2020 5552 4c20  olist().    URL 
-00032080: 3d20 2268 7474 703a 2f2f 6172 6368 6976  = "http://archiv
-00032090: 652e 7374 7363 692e 6564 752f 6873 742f  e.stsci.edu/hst/
-000320a0: 7365 6172 6368 2e70 6870 3f61 6374 696f  search.php?actio
-000320b0: 6e3d 5365 6172 6368 2622 0a20 2020 2055  n=Search&".    U
-000320c0: 524c 202b 3d20 2273 6369 5f64 6174 615f  RL += "sci_data_
-000320d0: 7365 745f 6e61 6d65 3d22 2b27 2c27 2e6a  set_name="+','.j
-000320e0: 6f69 6e28 6461 7461 7365 7473 290a 2020  oin(datasets).  
-000320f0: 2020 6966 206f 735f 6f70 656e 3a0a 2020    if os_open:.  
-00032100: 2020 2020 2020 6f73 2e73 7973 7465 6d28        os.system(
-00032110: 276f 7065 6e20 227b 307d 2227 2e66 6f72  'open "{0}"'.for
-00032120: 6d61 7428 5552 4c29 290a 0a20 2020 2072  mat(URL))..    r
-00032130: 6574 7572 6e20 5552 4c0a 0a0a 6465 6620  eturn URL...def 
-00032140: 6665 7463 685f 6465 6661 756c 745f 6361  fetch_default_ca
-00032150: 6c69 6273 2867 6574 5f61 6373 3d46 616c  libs(get_acs=Fal
-00032160: 7365 2c20 2a2a 6b77 6172 6773 293a 0a20  se, **kwargs):. 
-00032170: 2020 2022 2222 0a20 2020 2046 6574 6368     """.    Fetch
-00032180: 2061 2073 6574 206f 6620 6465 6661 756c   a set of defaul
-00032190: 7420 4853 5420 6361 6c69 6272 6174 696f  t HST calibratio
-000321a0: 6e20 6669 6c65 7320 0a20 2020 2022 2222  n files .    """
-000321b0: 0a20 2020 2070 6174 6873 203d 207b 7d0a  .    paths = {}.
-000321c0: 2020 2020 0a20 2020 2066 6f72 2072 6566      .    for ref
-000321d0: 5f64 6972 2069 6e20 5b27 6972 6566 272c  _dir in ['iref',
-000321e0: 2027 6a72 6566 275d 3a0a 2020 2020 2020   'jref']:.      
-000321f0: 2020 6861 735f 6469 7220 3d20 5472 7565    has_dir = True
-00032200: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00032210: 6f73 2e67 6574 656e 7628 7265 665f 6469  os.getenv(ref_di
-00032220: 7229 3a20 2020 200a 2020 2020 2020 2020  r):    .        
-00032230: 2020 2020 6861 735f 6469 7220 3d20 4661      has_dir = Fa
-00032240: 6c73 6520 2020 2020 2020 200a 2020 2020  lse        .    
-00032250: 2020 2020 2020 2020 2320 446f 2064 6972          # Do dir
-00032260: 6563 746f 7269 6573 2065 7869 7374 2069  ectories exist i
-00032270: 6e20 4752 495a 4c49 5f50 4154 483f 0a20  n GRIZLI_PATH?. 
-00032280: 2020 2020 2020 2020 2020 2069 6620 6f73             if os
-00032290: 2e70 6174 682e 6578 6973 7473 286f 732e  .path.exists(os.
-000322a0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
-000322b0: 5f50 4154 482c 2072 6566 5f64 6972 2929  _PATH, ref_dir))
-000322c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000322d0: 2020 6861 735f 6469 7220 3d20 5472 7565    has_dir = True
-000322e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000322f0: 2070 6174 6873 5b72 6566 5f64 6972 5d20   paths[ref_dir] 
-00032300: 3d20 6f73 2e70 6174 682e 6a6f 696e 2847  = os.path.join(G
-00032310: 5249 5a4c 495f 5041 5448 2c20 7265 665f  RIZLI_PATH, ref_
-00032320: 6469 7229 0a20 2020 2020 2020 2065 6c73  dir).        els
-00032330: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-00032340: 6174 6873 5b72 6566 5f64 6972 5d20 3d20  aths[ref_dir] = 
-00032350: 6f73 2e67 6574 656e 7628 7265 665f 6469  os.getenv(ref_di
-00032360: 7229 0a20 2020 2020 2020 2020 2020 200a  r).            .
-00032370: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-00032380: 6173 5f64 6972 3a0a 2020 2020 2020 2020  as_dir:.        
-00032390: 2020 2020 7072 696e 7428 2222 220a 4e6f      print(""".No
-000323a0: 2024 7b30 7d20 7365 7421 2020 4d61 6b65   ${0} set!  Make
-000323b0: 2061 2064 6972 6563 746f 7279 2061 6e64   a directory and
-000323c0: 2070 6f69 6e74 2074 6f20 6974 2069 6e20   point to it in 
-000323d0: 7e2f 2e62 6173 6872 6320 6f72 207e 2f2e  ~/.bashrc or ~/.
-000323e0: 6373 6872 632e 0a46 6f72 2065 7861 6d70  cshrc..For examp
-000323f0: 6c65 2c0a 0a20 2024 206d 6b64 6972 2024  le,..  $ mkdir $
-00032400: 4752 495a 4c49 2f7b 307d 0a20 2024 2065  GRIZLI/{0}.  $ e
-00032410: 7870 6f72 7420 7b30 7d3d 2224 7b47 5249  xport {0}="${GRI
-00032420: 5a4c 497d 2f7b 307d 2f22 2023 2070 7574  ZLI}/{0}/" # put
-00032430: 2074 6869 7320 696e 207e 2f2e 6261 7368   this in ~/.bash
-00032440: 7263 0a22 2222 2e66 6f72 6d61 7428 7265  rc.""".format(re
-00032450: 665f 6469 7229 290a 0a20 2020 2020 2020  f_dir))..       
-00032460: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00032470: 650a 0a20 2020 2023 2057 4643 330a 2020  e..    # WFC3.  
-00032480: 2020 6669 6c65 7320 3d20 5b27 6972 6566    files = ['iref
-00032490: 2475 6337 3231 3133 6f69 5f70 666c 2e66  $uc72113oi_pfl.f
-000324a0: 6974 7327 2c20 2023 2046 3130 3557 2046  its',  # F105W F
-000324b0: 6c61 740a 2020 2020 2020 2020 2020 2020  lat.            
-000324c0: 2027 6972 6566 2475 6337 3231 3134 3369   'iref$uc721143i
-000324d0: 5f70 666c 2e66 6974 7327 2c20 2023 2046  _pfl.fits',  # F
-000324e0: 3134 3057 2066 6c61 740a 2020 2020 2020  140W flat.      
-000324f0: 2020 2020 2020 2027 6972 6566 2475 346d         'iref$u4m
-00032500: 3133 3335 6c69 5f70 666c 2e66 6974 7327  1335li_pfl.fits'
-00032510: 2c20 2023 2047 3130 3220 666c 6174 0a20  ,  # G102 flat. 
-00032520: 2020 2020 2020 2020 2020 2020 2769 7265              'ire
-00032530: 6624 7534 6d31 3333 356d 695f 7066 6c2e  f$u4m1335mi_pfl.
-00032540: 6669 7473 272c 2020 2320 4731 3431 2066  fits',  # G141 f
-00032550: 6c61 740a 2020 2020 2020 2020 2020 2020  lat.            
-00032560: 2027 6972 6566 2477 336d 3138 3532 3569   'iref$w3m18525i
-00032570: 5f69 6463 2e66 6974 7327 2c20 2023 2049  _idc.fits',  # I
-00032580: 4443 5441 4220 6469 7374 6f72 7469 6f6e  DCTAB distortion
-00032590: 2074 6162 6c65 7d0a 2020 2020 2020 2020   table}.        
-000325a0: 2020 2020 205d 0a20 2020 200a 2020 2020       ].    .    
-000325b0: 6966 2027 4143 5327 2069 6e20 6b77 6172  if 'ACS' in kwar
-000325c0: 6773 3a0a 2020 2020 2020 2020 6765 745f  gs:.        get_
-000325d0: 6163 7320 3d20 6b77 6172 6773 5b27 4143  acs = kwargs['AC
-000325e0: 5327 5d0a 2020 2020 2020 2020 0a20 2020  S'].        .   
-000325f0: 2069 6620 6765 745f 6163 733a 0a20 2020   if get_acs:.   
-00032600: 2020 2020 2066 696c 6573 2e65 7874 656e       files.exten
-00032610: 6428 5b27 6a72 6566 246e 3675 3132 3539  d(['jref$n6u1259
-00032620: 326a 5f70 666c 2e66 6974 7327 2c20 2023  2j_pfl.fits',  #
-00032630: 2046 3831 3420 466c 6174 0a20 2020 2020   F814 Flat.     
-00032640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032650: 2027 6a72 6566 246f 3834 3133 3530 6d6a   'jref$o841350mj
-00032660: 5f70 666c 2e66 6974 7327 2c20 2023 2047  _pfl.fits',  # G
-00032670: 3830 304c 2066 6c61 745d 290a 2020 2020  800L flat]).    
-00032680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032690: 2020 276a 7265 6624 7639 3731 3832 366a    'jref$v971826j
-000326a0: 6a5f 6e70 6c2e 6669 7473 275d 290a 0a20  j_npl.fits']).. 
-000326b0: 2020 2066 6f72 2066 696c 6520 696e 2066     for file in f
-000326c0: 696c 6573 3a0a 2020 2020 2020 2020 6665  iles:.        fe
-000326d0: 7463 685f 6873 745f 6361 6c69 6228 6669  tch_hst_calib(fi
-000326e0: 6c65 2c20 7265 665f 7061 7468 733d 7061  le, ref_paths=pa
-000326f0: 7468 7329 0a0a 2020 2020 6261 6470 6978  ths)..    badpix
-00032700: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00032710: 7061 7468 735b 2769 7265 6627 5d2c 2027  paths['iref'], '
-00032720: 6261 6470 6978 5f73 7061 7273 3230 305f  badpix_spars200_
-00032730: 4e6f 7639 2e66 6974 7327 290a 2020 2020  Nov9.fits').    
-00032740: 7072 696e 7428 2745 7874 7261 2057 4643  print('Extra WFC
-00032750: 332f 4952 2062 6164 2070 6978 656c 733a  3/IR bad pixels:
-00032760: 207b 307d 272e 666f 726d 6174 2862 6164   {0}'.format(bad
-00032770: 7069 7829 290a 2020 2020 6966 206e 6f74  pix)).    if not
-00032780: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-00032790: 6261 6470 6978 293a 0a20 2020 2020 2020  badpix):.       
-000327a0: 206f 732e 7379 7374 656d 2827 6375 726c   os.system('curl
-000327b0: 202d 6f20 7b30 7d2f 6261 6470 6978 5f73   -o {0}/badpix_s
-000327c0: 7061 7273 3230 305f 4e6f 7639 2e66 6974  pars200_Nov9.fit
-000327d0: 7320 6874 7470 733a 2f2f 7261 772e 6769  s https://raw.gi
-000327e0: 7468 7562 7573 6572 636f 6e74 656e 742e  thubusercontent.
-000327f0: 636f 6d2f 6762 7261 6d6d 6572 2f77 6663  com/gbrammer/wfc
-00032800: 332f 6d61 7374 6572 2f64 6174 612f 6261  3/master/data/ba
-00032810: 6470 6978 5f73 7061 7273 3230 305f 4e6f  dpix_spars200_No
-00032820: 7639 2e66 6974 7327 2e66 6f72 6d61 7428  v9.fits'.format(
-00032830: 7061 7468 735b 2769 7265 6627 5d29 290a  paths['iref'])).
-00032840: 0a20 2020 2023 2050 6978 656c 2061 7265  .    # Pixel are
-00032850: 6120 6d61 700a 2020 2020 7061 6d20 3d20  a map.    pam = 
-00032860: 6f73 2e70 6174 682e 6a6f 696e 2870 6174  os.path.join(pat
-00032870: 6873 5b27 6972 6566 275d 2c20 2769 725f  hs['iref'], 'ir_
-00032880: 7766 6333 5f6d 6170 2e66 6974 7327 290a  wfc3_map.fits').
-00032890: 2020 2020 7072 696e 7428 2750 6978 656c      print('Pixel
-000328a0: 2061 7265 6120 6d61 703a 207b 307d 272e   area map: {0}'.
-000328b0: 666f 726d 6174 2870 616d 2929 0a20 2020  format(pam)).   
-000328c0: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
-000328d0: 6578 6973 7473 2870 616d 293a 0a20 2020  exists(pam):.   
-000328e0: 2020 2020 206f 732e 7379 7374 656d 2827       os.system('
-000328f0: 6375 726c 202d 6f20 7b30 7d20 6874 7470  curl -o {0} http
-00032900: 733a 2f2f 7777 772e 7374 7363 692e 6564  s://www.stsci.ed
-00032910: 752f 6669 6c65 732f 6c69 7665 2f73 6974  u/files/live/sit
-00032920: 6573 2f77 7777 2f66 696c 6573 2f68 6f6d  es/www/files/hom
-00032930: 652f 6873 742f 696e 7374 7275 6d65 6e74  e/hst/instrument
-00032940: 6174 696f 6e2f 7766 6333 2f64 6174 612d  ation/wfc3/data-
-00032950: 616e 616c 7973 6973 2f70 6978 656c 2d61  analysis/pixel-a
-00032960: 7265 612d 6d61 7073 2f5f 646f 6375 6d65  rea-maps/_docume
-00032970: 6e74 732f 6972 5f77 6663 335f 6d61 702e  nts/ir_wfc3_map.
-00032980: 6669 7473 272e 666f 726d 6174 2870 616d  fits'.format(pam
-00032990: 2929 0a0a 0a64 6566 2066 6574 6368 5f77  ))...def fetch_w
-000329a0: 6670 6332 5f63 616c 6962 2866 696c 653d  fpc2_calib(file=
-000329b0: 2767 3671 3139 3132 6875 5f72 3466 2e66  'g6q1912hu_r4f.f
-000329c0: 6974 7327 2c20 7061 7468 3d6f 732e 6765  its', path=os.ge
-000329d0: 7465 6e76 2827 7572 6566 2729 2c20 7573  tenv('uref'), us
-000329e0: 655f 6d61 7374 3d46 616c 7365 2c20 7665  e_mast=False, ve
-000329f0: 7262 6f73 653d 5472 7565 2c20 6f76 6572  rbose=True, over
-00032a00: 7772 6974 653d 5472 7565 2c20 736b 6970  write=True, skip
-00032a10: 5f65 7869 7374 696e 673d 5472 7565 293a  _existing=True):
-00032a20: 0a20 2020 2022 2222 0a20 2020 2046 6574  .    """.    Fet
-00032a30: 6368 2073 7461 7469 6320 5746 5043 3220  ch static WFPC2 
-00032a40: 6361 6c69 6272 6174 696f 6e20 6669 6c65  calibration file
-00032a50: 2061 6e64 2072 756e 2060 7374 7363 692e   and run `stsci.
-00032a60: 746f 6f6c 732e 636f 6e76 6572 7477 6169  tools.convertwai
-00032a70: 7665 7265 6466 6974 7360 206f 6e20 6974  veredfits` on it
-00032a80: 2e0a 0a20 2020 2070 6174 6820 3a20 7374  ...    path : st
-00032a90: 720a 2020 2020 2020 2020 4f75 7470 7574  r.        Output
-00032aa0: 2070 6174 6820 6f66 2074 6865 2072 6566   path of the ref
-00032ab0: 6572 656e 6365 2066 696c 6520 2867 656e  erence file (gen
-00032ac0: 6572 616c 6c79 2073 686f 756c 6420 6265  erally should be
-00032ad0: 2069 6e20 2475 7265 6629 2e0a 0a20 2020   in $uref)...   
-00032ae0: 2075 7365 5f6d 6173 7420 3a20 626f 6f6c   use_mast : bool
-00032af0: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
-00032b00: 2c20 7472 7920 746f 2066 6574 6368 2066  , try to fetch f
-00032b10: 726f 6d20 226d 6173 742e 7374 7363 692e  rom "mast.stsci.
-00032b20: 6564 752f 2f61 7069 2f76 302f 646f 776e  edu//api/v0/down
-00032b30: 6c6f 6164 2f66 696c 653f 7572 6922 2c0a  load/file?uri",.
-00032b40: 2020 2020 2020 2020 6f74 6865 7277 6973          otherwis
-00032b50: 652c 2066 6574 6368 2066 726f 6d20 6120  e, fetch from a 
-00032b60: 7374 6174 6963 2064 6972 6563 746f 7279  static directory
-00032b70: 0a20 2020 2020 2020 2022 7373 622e 7374  .        "ssb.st
-00032b80: 7363 692e 6564 752f 6364 6273 5f6f 7065  sci.edu/cdbs_ope
-00032b90: 6e2f 6364 6273 2f75 7265 665f 6c69 6e75  n/cdbs/uref_linu
-00032ba0: 782f 222e 0a0a 2020 2020 2222 220a 2020  x/"...    """.  
-00032bb0: 2020 6672 6f6d 2073 7473 6369 2e74 6f6f    from stsci.too
-00032bc0: 6c73 2069 6d70 6f72 7420 636f 6e76 6572  ls import conver
-00032bd0: 7477 6169 7665 7265 6466 6974 730a 0a20  twaiveredfits.. 
-00032be0: 2020 2074 7279 3a20 2023 2050 7974 686f     try:  # Pytho
-00032bf0: 6e20 332e 780a 2020 2020 2020 2020 696d  n 3.x.        im
-00032c00: 706f 7274 2068 7474 702e 636c 6965 6e74  port http.client
-00032c10: 2061 7320 6874 7470 6c69 620a 2020 2020   as httplib.    
-00032c20: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
-00032c30: 6f72 3a20 2023 2050 7974 686f 6e20 322e  or:  # Python 2.
-00032c40: 780a 2020 2020 2020 2020 696d 706f 7274  x.        import
-00032c50: 2068 7474 706c 6962 0a0a 2020 2020 6966   httplib..    if
-00032c60: 2066 696c 652e 656e 6473 7769 7468 2827   file.endswith('
-00032c70: 6827 293a 0a20 2020 2020 2020 2023 2046  h'):.        # F
-00032c80: 696c 6520 6c69 6b65 2022 6736 7131 3931  ile like "g6q191
-00032c90: 3268 752e 7234 6822 0a20 2020 2020 2020  2hu.r4h".       
-00032ca0: 2066 696c 6520 3d20 6669 6c65 5b3a 2d31   file = file[:-1
-00032cb0: 5d2e 7265 706c 6163 6528 272e 272c 2027  ].replace('.', '
-00032cc0: 5f27 292b 2766 2e66 6974 7327 0a0a 2020  _')+'f.fits'..  
-00032cd0: 2020 6f75 7450 6174 6820 3d20 6f73 2e70    outPath = os.p
-00032ce0: 6174 682e 6a6f 696e 2870 6174 682c 2066  ath.join(path, f
-00032cf0: 696c 6529 0a20 2020 2069 6620 6f73 2e70  ile).    if os.p
-00032d00: 6174 682e 6578 6973 7473 286f 7574 5061  ath.exists(outPa
-00032d10: 7468 2920 2620 736b 6970 5f65 7869 7374  th) & skip_exist
-00032d20: 696e 673a 0a20 2020 2020 2020 2070 7269  ing:.        pri
-00032d30: 6e74 2822 2320 6665 7463 685f 7766 7063  nt("# fetch_wfpc
-00032d40: 325f 6361 6c69 623a 207b 307d 2065 7869  2_calib: {0} exi
-00032d50: 7374 7322 2e66 6f72 6d61 7428 6f75 7450  sts".format(outP
-00032d60: 6174 6829 290a 2020 2020 2020 2020 7265  ath)).        re
-00032d70: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
-00032d80: 6620 7573 655f 6d61 7374 3a0a 2020 2020  f use_mast:.    
-00032d90: 2020 2020 7365 7276 6572 203d 2027 6d61      server = 'ma
-00032da0: 7374 2e73 7473 6369 2e65 6475 270a 2020  st.stsci.edu'.  
-00032db0: 2020 2020 2020 7572 6920 3d20 276d 6173        uri = 'mas
-00032dc0: 743a 4853 542f 7072 6f64 7563 742f 272b  t:HST/product/'+
-00032dd0: 6669 6c65 0a20 2020 2020 2020 2072 6571  file.        req
-00032de0: 7565 7374 5f70 6174 6820 3d20 222f 6170  uest_path = "/ap
-00032df0: 692f 7630 2f64 6f77 6e6c 6f61 642f 6669  i/v0/download/fi
-00032e00: 6c65 3f75 7269 3d22 2b75 7269 0a20 2020  le?uri="+uri.   
-00032e10: 2065 6c73 653a 0a20 2020 2020 2020 2073   else:.        s
-00032e20: 6572 7665 7220 3d20 2773 7362 2e73 7473  erver = 'ssb.sts
-00032e30: 6369 2e65 6475 270a 2020 2020 2020 2020  ci.edu'.        
-00032e40: 7265 7175 6573 745f 7061 7468 203d 2027  request_path = '
-00032e50: 2f63 6462 735f 6f70 656e 2f63 6462 732f  /cdbs_open/cdbs/
-00032e60: 7572 6566 5f6c 696e 7578 2f27 2b66 696c  uref_linux/'+fil
-00032e70: 650a 0a20 2020 2069 6620 7665 7262 6f73  e..    if verbos
-00032e80: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-00032e90: 2827 2320 6665 7463 685f 7766 7063 325f  ('# fetch_wfpc2_
-00032ea0: 6361 6c69 623a 2022 7b30 7d22 2074 6f20  calib: "{0}" to 
-00032eb0: 7b31 7d27 2e66 6f72 6d61 7428 7365 7276  {1}'.format(serv
-00032ec0: 6572 2b72 6571 7565 7374 5f70 6174 682c  er+request_path,
-00032ed0: 2070 6174 6829 290a 0a20 2020 2063 6f6e   path))..    con
-00032ee0: 6e20 3d20 6874 7470 6c69 622e 4854 5450  n = httplib.HTTP
-00032ef0: 5343 6f6e 6e65 6374 696f 6e28 7365 7276  SConnection(serv
-00032f00: 6572 290a 0a20 2020 2063 6f6e 6e2e 7265  er)..    conn.re
-00032f10: 7175 6573 7428 2247 4554 222c 2072 6571  quest("GET", req
-00032f20: 7565 7374 5f70 6174 6829 0a20 2020 2072  uest_path).    r
-00032f30: 6573 7020 3d20 636f 6e6e 2e67 6574 7265  esp = conn.getre
-00032f40: 7370 6f6e 7365 2829 0a20 2020 2066 696c  sponse().    fil
-00032f50: 6543 6f6e 7465 6e74 203d 2072 6573 702e  eContent = resp.
-00032f60: 7265 6164 2829 0a20 2020 2063 6f6e 6e2e  read().    conn.
-00032f70: 636c 6f73 6528 290a 0a20 2020 2023 2063  close()..    # c
-00032f80: 6865 636b 2066 6f72 2066 696c 650a 2020  heck for file.  
-00032f90: 2020 6966 206c 656e 2866 696c 6543 6f6e    if len(fileCon
-00032fa0: 7465 6e74 2920 3c20 3430 3936 3a0a 2020  tent) < 4096:.  
-00032fb0: 2020 2020 2020 7072 696e 7428 2745 5252        print('ERR
-00032fc0: 4f52 3a20 227b 307d 2220 6661 696c 6564  OR: "{0}" failed
-00032fd0: 2074 6f20 646f 776e 6c6f 6164 2e20 2054   to download.  T
-00032fe0: 7279 2060 7573 655f 6d61 7374 3d7b 317d  ry `use_mast={1}
-00032ff0: 602e 272e 666f 726d 6174 2873 6572 7665  `.'.format(serve
-00033000: 722b 7265 7175 6573 745f 7061 7468 2c20  r+request_path, 
-00033010: 2875 7365 5f6d 6173 7420 6973 2046 616c  (use_mast is Fal
-00033020: 7365 2929 290a 2020 2020 2020 2020 7374  se))).        st
-00033030: 6174 7573 203d 2046 616c 7365 0a20 2020  atus = False.   
-00033040: 2020 2020 2072 6169 7365 2046 696c 654e       raise FileN
-00033050: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-00033060: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
-00033070: 7269 6e74 2822 2320 6665 7463 685f 7766  rint("# fetch_wf
-00033080: 7063 325f 6361 6c69 623a 207b 307d 2028  pc2_calib: {0} (
-00033090: 434f 4d50 4c45 5445 2922 2e66 6f72 6d61  COMPLETE)".forma
-000330a0: 7428 6f75 7450 6174 6829 290a 2020 2020  t(outPath)).    
-000330b0: 2020 2020 7374 6174 7573 203d 2054 7275      status = Tru
-000330c0: 650a 0a20 2020 2023 2073 6176 6520 746f  e..    # save to
-000330d0: 2066 696c 650a 2020 2020 7769 7468 206f   file.    with o
-000330e0: 7065 6e28 6f75 7450 6174 682c 2027 7762  pen(outPath, 'wb
-000330f0: 2729 2061 7320 464c 453a 0a20 2020 2020  ') as FLE:.     
-00033100: 2020 2046 4c45 2e77 7269 7465 2866 696c     FLE.write(fil
-00033110: 6543 6f6e 7465 6e74 290a 0a20 2020 2069  eContent)..    i
-00033120: 6620 7374 6174 7573 3a0a 2020 2020 2020  f status:.      
-00033130: 2020 2320 436f 6e76 6572 7420 746f 2073    # Convert to s
-00033140: 7461 6e64 6172 6420 4649 5453 0a20 2020  tandard FITS.   
-00033150: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00033160: 2020 2020 2020 6864 7520 3d20 636f 6e76        hdu = conv
-00033170: 6572 7477 6169 7665 7265 6466 6974 732e  ertwaiveredfits.
-00033180: 636f 6e76 6572 7477 6169 7665 7265 6466  convertwaiveredf
-00033190: 6974 7328 6f75 7450 6174 6829 0a20 2020  its(outPath).   
-000331a0: 2020 2020 2020 2020 2077 6869 6c65 2027           while '
-000331b0: 4849 5354 4f52 5927 2069 6e20 6864 755b  HISTORY' in hdu[
-000331c0: 305d 2e68 6561 6465 723a 0a20 2020 2020  0].header:.     
-000331d0: 2020 2020 2020 2020 2020 2068 6475 5b30             hdu[0
-000331e0: 5d2e 6865 6164 6572 2e72 656d 6f76 6528  ].header.remove(
-000331f0: 2748 4953 544f 5259 2729 0a0a 2020 2020  'HISTORY')..    
-00033200: 2020 2020 2020 2020 6864 752e 7772 6974          hdu.writ
-00033210: 6574 6f28 6f75 7450 6174 682e 7265 706c  eto(outPath.repl
-00033220: 6163 6528 272e 6669 7473 272c 2027 5f63  ace('.fits', '_c
-00033230: 3068 2e66 6974 7327 292c 0a20 2020 2020  0h.fits'),.     
-00033240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033250: 2020 206f 7665 7277 7269 7465 3d6f 7665     overwrite=ove
-00033260: 7277 7269 7465 2c20 6f75 7470 7574 5f76  rwrite, output_v
-00033270: 6572 6966 793d 2766 6978 2729 0a20 2020  erify='fix').   
-00033280: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00033290: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000332a0: 5472 7565 0a0a 0a64 6566 2066 6574 6368  True...def fetch
-000332b0: 5f6e 6972 6361 6d5f 736b 7966 6c61 7473  _nircam_skyflats
-000332c0: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
-000332d0: 446f 776e 6c6f 6164 2073 6b79 666c 6174  Download skyflat
-000332e0: 2066 696c 6573 0a20 2020 2022 2222 0a20   files.    """. 
-000332f0: 2020 2063 6f6e 665f 7061 7468 203d 206f     conf_path = o
-00033300: 732e 7061 7468 2e6a 6f69 6e28 4752 495a  s.path.join(GRIZ
-00033310: 4c49 5f50 4154 482c 2027 434f 4e46 272c  LI_PATH, 'CONF',
-00033320: 2027 4e69 7263 616d 536b 7946 6c61 7427   'NircamSkyFlat'
-00033330: 290a 2020 2020 6f73 2e73 7973 7465 6d28  ).    os.system(
-00033340: 6627 6177 7320 7333 2073 796e 6320 7333  f'aws s3 sync s3
-00033350: 3a2f 2f67 7269 7a6c 692d 7632 2f4e 6972  ://grizli-v2/Nir
-00033360: 6361 6d53 6b79 666c 6174 732f 207b 636f  camSkyflats/ {co
-00033370: 6e66 5f70 6174 687d 202d 2d65 7863 6c75  nf_path} --exclu
-00033380: 6465 2022 2a22 202d 2d69 6e63 6c75 6465  de "*" --include
-00033390: 2022 6e72 632a 6669 7473 2227 290a 2020   "nrc*fits"').  
-000333a0: 2020 0a20 2020 205f 6669 6c65 7320 3d20    .    _files = 
-000333b0: 676c 6f62 2e67 6c6f 6228 636f 6e66 5f70  glob.glob(conf_p
-000333c0: 6174 682b 272f 2a66 6974 7327 290a 2020  ath+'/*fits').  
-000333d0: 2020 5f66 696c 6573 2e73 6f72 7428 290a    _files.sort().
-000333e0: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
-000333f0: 5f66 696c 6573 0a0a 0a64 6566 2066 6574  _files...def fet
-00033400: 6368 5f63 6f6e 6669 675f 6669 6c65 7328  ch_config_files(
-00033410: 6765 745f 6163 733d 4661 6c73 652c 2067  get_acs=False, g
-00033420: 6574 5f73 6b79 3d54 7275 652c 2067 6574  et_sky=True, get
-00033430: 5f73 7461 7273 3d54 7275 652c 2067 6574  _stars=True, get
-00033440: 5f65 7073 663d 5472 7565 2c20 6765 745f  _epsf=True, get_
-00033450: 6a77 7374 3d46 616c 7365 2c20 6765 745f  jwst=False, get_
-00033460: 7766 6333 3d54 7275 652c 202a 2a6b 7761  wfc3=True, **kwa
-00033470: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
-00033480: 2020 436f 6e66 6967 2066 696c 6573 206e    Config files n
-00033490: 6565 6465 6420 666f 7220 4772 697a 6c69  eeded for Grizli
-000334a0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-000334b0: 2741 4353 2720 696e 206b 7761 7267 733a  'ACS' in kwargs:
-000334c0: 0a20 2020 2020 2020 2067 6574 5f61 6373  .        get_acs
-000334d0: 203d 206b 7761 7267 735b 2741 4353 275d   = kwargs['ACS']
-000334e0: 0a0a 2020 2020 6377 6420 3d20 6f73 2e67  ..    cwd = os.g
-000334f0: 6574 6377 6428 290a 0a20 2020 2070 7269  etcwd()..    pri
-00033500: 6e74 2827 436f 6e66 6967 2064 6972 6563  nt('Config direc
-00033510: 746f 7279 3a20 7b30 7d2f 434f 4e46 272e  tory: {0}/CONF'.
-00033520: 666f 726d 6174 2847 5249 5a4c 495f 5041  format(GRIZLI_PA
-00033530: 5448 2929 0a0a 2020 2020 6f73 2e63 6864  TH))..    os.chd
-00033540: 6972 286f 732e 7061 7468 2e6a 6f69 6e28  ir(os.path.join(
-00033550: 4752 495a 4c49 5f50 4154 482c 2027 434f  GRIZLI_PATH, 'CO
-00033560: 4e46 2729 290a 0a20 2020 2066 7470 6469  NF'))..    ftpdi
-00033570: 7220 3d20 2766 7470 3a2f 2f66 7470 2e73  r = 'ftp://ftp.s
-00033580: 7473 6369 2e65 6475 2f63 6462 732f 7766  tsci.edu/cdbs/wf
-00033590: 6333 5f61 7578 2f27 0a20 2020 2074 6172  c3_aux/'.    tar
-000335a0: 6669 6c65 7320 3d20 5b5d 0a0a 2020 2020  files = []..    
-000335b0: 2320 436f 6e66 6967 2066 696c 6573 0a20  # Config files. 
-000335c0: 2020 2023 2042 4153 4555 524c 203d 2027     # BASEURL = '
-000335d0: 6874 7470 733a 2f2f 7333 2e61 6d61 7a6f  https://s3.amazo
-000335e0: 6e61 7773 2e63 6f6d 2f67 7269 7a6c 692f  naws.com/grizli/
-000335f0: 434f 4e46 2f27 0a20 2020 2023 2042 4153  CONF/'.    # BAS
-00033600: 4555 524c 203d 2027 6874 7470 733a 2f2f  EURL = 'https://
-00033610: 6572 6461 2e6b 752e 646b 2f76 6772 6964  erda.ku.dk/vgrid
-00033620: 2f47 6162 7269 656c 2532 3042 7261 6d6d  /Gabriel%20Bramm
-00033630: 6572 2f43 4f4e 462f 270a 2020 2020 4241  er/CONF/'.    BA
-00033640: 5345 5552 4c20 3d20 2827 6874 7470 733a  SEURL = ('https:
-00033650: 2f2f 7261 772e 6769 7468 7562 7573 6572  //raw.githubuser
-00033660: 636f 6e74 656e 742e 636f 6d2f 6762 7261  content.com/gbra
-00033670: 6d6d 6572 2f27 202b 0a20 2020 2020 2020  mmer/' +.       
-00033680: 2020 2020 2020 2020 2767 7269 7a6c 692d          'grizli-
-00033690: 636f 6e66 6967 2f6d 6173 7465 7227 290a  config/master').
-000336a0: 0a20 2020 2069 6620 6765 745f 7766 6333  .    if get_wfc3
-000336b0: 3a0a 2020 2020 2020 2020 7461 7266 696c  :.        tarfil
-000336c0: 6573 203d 205b 277b 307d 2f57 4643 332e  es = ['{0}/WFC3.
-000336d0: 4952 2e47 3130 322e 6361 6c2e 5634 2e33  IR.G102.cal.V4.3
-000336e0: 322e 7461 722e 677a 272e 666f 726d 6174  2.tar.gz'.format
-000336f0: 2866 7470 6469 7229 2c0a 2020 2020 2020  (ftpdir),.      
-00033700: 2020 2020 2020 2020 2020 2020 2020 277b                '{
-00033710: 307d 2f57 4643 332e 4952 2e47 3134 312e  0}/WFC3.IR.G141.
-00033720: 6361 6c2e 5634 2e33 322e 7461 722e 677a  cal.V4.32.tar.gz
-00033730: 272e 666f 726d 6174 2866 7470 6469 7229  '.format(ftpdir)
-00033740: 5d0a 2020 2020 2020 2020 7461 7266 696c  ].        tarfil
-00033750: 6573 202b 3d20 5b66 277b 4241 5345 5552  es += [f'{BASEUR
-00033760: 4c7d 2f57 4643 332e 4952 2e47 3130 322e  L}/WFC3.IR.G102.
-00033770: 5744 2e56 342e 3332 2e74 6172 2e67 7a27  WD.V4.32.tar.gz'
-00033780: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00033790: 2020 2020 2020 2066 277b 4241 5345 5552         f'{BASEUR
-000337a0: 4c7d 2f57 4643 332e 4952 2e47 3134 312e  L}/WFC3.IR.G141.
-000337b0: 5744 2e56 342e 3332 2e74 6172 2e67 7a27  WD.V4.32.tar.gz'
-000337c0: 5d0a 0a20 2020 2069 6620 6765 745f 6a77  ]..    if get_jw
-000337d0: 7374 3a0a 2020 2020 2020 2020 7461 7266  st:.        tarf
-000337e0: 696c 6573 202b 3d20 5b66 277b 4241 5345  iles += [f'{BASE
-000337f0: 5552 4c7d 2f6a 7773 742d 6772 6973 6d2d  URL}/jwst-grism-
-00033800: 636f 6e66 2e74 6172 2e67 7a27 2c20 0a20  conf.tar.gz', . 
-00033810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033820: 2020 2020 6627 7b42 4153 4555 524c 7d2f      f'{BASEURL}/
-00033830: 6e69 7269 7373 2e63 6f6e 662e 3232 3037  niriss.conf.2207
-00033840: 3235 2e74 6172 2e67 7a27 2c0a 2020 2020  25.tar.gz',.    
-00033850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033860: 2066 277b 4241 5345 5552 4c7d 2f6e 6972   f'{BASEURL}/nir
-00033870: 6361 6d2d 7769 7370 2d61 7567 3230 3232  cam-wisp-aug2022
-00033880: 2e74 6172 2e67 7a27 5d0a 2020 2020 0a20  .tar.gz'].    . 
-00033890: 2020 2069 6620 6765 745f 736b 793a 0a20     if get_sky:. 
-000338a0: 2020 2020 2020 2066 7470 6469 7220 3d20         ftpdir = 
-000338b0: 4241 5345 5552 4c0a 2020 2020 2020 2020  BASEURL.        
-000338c0: 7461 7266 696c 6573 2e61 7070 656e 6428  tarfiles.append(
-000338d0: 277b 307d 2f67 7269 736d 5f6d 6173 7465  '{0}/grism_maste
-000338e0: 725f 736b 795f 7630 2e35 2e74 6172 2e67  r_sky_v0.5.tar.g
-000338f0: 7a27 2e66 6f72 6d61 7428 6674 7064 6972  z'.format(ftpdir
-00033900: 2929 0a0a 2020 2020 2367 5552 4c20 3d20  ))..    #gURL = 
-00033910: 2768 7474 703a 2f2f 7777 772e 7374 7363  'http://www.stsc
-00033920: 692e 6564 752f 7e62 7261 6d6d 6572 2f47  i.edu/~brammer/G
-00033930: 7269 7a6c 692f 4669 6c65 7327 0a20 2020  rizli/Files'.   
-00033940: 2023 6755 524c 203d 2027 6874 7470 733a   #gURL = 'https:
-00033950: 2f2f 7333 2e61 6d61 7a6f 6e61 7773 2e63  //s3.amazonaws.c
-00033960: 6f6d 2f67 7269 7a6c 692f 434f 4e46 270a  om/grizli/CONF'.
-00033970: 2020 2020 6755 524c 203d 2042 4153 4555      gURL = BASEU
-00033980: 524c 0a20 2020 200a 2020 2020 7461 7266  RL.    .    tarf
-00033990: 696c 6573 2e61 7070 656e 6428 277b 307d  iles.append('{0}
-000339a0: 2f57 4643 3349 525f 6578 7465 6e64 6564  /WFC3IR_extended
-000339b0: 5f50 5346 2e76 312e 7461 722e 677a 272e  _PSF.v1.tar.gz'.
-000339c0: 666f 726d 6174 2867 5552 4c29 290a 0a20  format(gURL)).. 
-000339d0: 2020 2069 6620 6765 745f 6163 733a 0a20     if get_acs:. 
-000339e0: 2020 2020 2020 2074 6172 6669 6c65 7320         tarfiles 
-000339f0: 2b3d 205b 6627 7b42 4153 4555 524c 7d2f  += [f'{BASEURL}/
-00033a00: 4143 532e 5746 432e 4348 4950 312e 5374  ACS.WFC.CHIP1.St
-00033a10: 6172 732e 636f 6e66 272c 200a 2020 2020  ars.conf', .    
-00033a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033a30: 6627 7b42 4153 4555 524c 7d2f 4143 532e  f'{BASEURL}/ACS.
-00033a40: 5746 432e 4348 4950 322e 5374 6172 732e  WFC.CHIP2.Stars.
-00033a50: 636f 6e66 275d 0a20 2020 2020 2020 2074  conf'].        t
-00033a60: 6172 6669 6c65 732e 6170 7065 6e64 2827  arfiles.append('
-00033a70: 7b30 7d2f 4143 532e 5746 432e 736b 792e  {0}/ACS.WFC.sky.
-00033a80: 7461 722e 677a 272e 666f 726d 6174 2867  tar.gz'.format(g
-00033a90: 5552 4c29 290a 2020 2020 2020 2020 7461  URL)).        ta
-00033aa0: 7266 696c 6573 2e61 7070 656e 6428 277b  rfiles.append('{
-00033ab0: 307d 2f41 4353 5f43 4f4e 4649 472e 7461  0}/ACS_CONFIG.ta
-00033ac0: 722e 677a 272e 666f 726d 6174 2867 5552  r.gz'.format(gUR
-00033ad0: 4c29 290a 0a20 2020 2066 6f72 2075 726c  L))..    for url
-00033ae0: 2069 6e20 7461 7266 696c 6573 3a0a 2020   in tarfiles:.  
-00033af0: 2020 2020 2020 6669 6c65 203d 206f 732e        file = os.
-00033b00: 7061 7468 2e62 6173 656e 616d 6528 7572  path.basename(ur
-00033b10: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-00033b20: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
-00033b30: 2866 696c 6529 3a0a 2020 2020 2020 2020  (file):.        
-00033b40: 2020 2020 7072 696e 7428 2747 6574 207b      print('Get {
-00033b50: 307d 272e 666f 726d 6174 2866 696c 6529  0}'.format(file)
-00033b60: 290a 2020 2020 2020 2020 2020 2020 6f73  ).            os
-00033b70: 2e73 7973 7465 6d28 2763 7572 6c20 2d6f  .system('curl -o
-00033b80: 207b 307d 207b 317d 272e 666f 726d 6174   {0} {1}'.format
-00033b90: 2866 696c 652c 2075 726c 2929 0a0a 2020  (file, url))..  
-00033ba0: 2020 2020 2020 6966 2027 2e74 6172 2720        if '.tar' 
-00033bb0: 696e 2066 696c 653a 0a20 2020 2020 2020  in file:.       
-00033bc0: 2020 2020 206f 732e 7379 7374 656d 2827       os.system('
-00033bd0: 7461 7220 787a 7666 207b 307d 272e 666f  tar xzvf {0}'.fo
-00033be0: 726d 6174 2866 696c 6529 290a 0a20 2020  rmat(file))..   
-00033bf0: 2069 6620 6765 745f 6570 7366 3a0a 2020   if get_epsf:.  
-00033c00: 2020 2020 2020 2320 6550 5346 2066 696c        # ePSF fil
-00033c10: 6573 2066 6f72 2066 6974 7469 6e67 2070  es for fitting p
-00033c20: 6f69 6e74 2073 6f75 7263 6573 0a20 2020  oint sources.   
-00033c30: 2020 2020 2023 7073 665f 7061 7468 203d       #psf_path =
-00033c40: 2027 6874 7470 3a2f 2f77 7777 2e73 7473   'http://www.sts
-00033c50: 6369 2e65 6475 2f68 7374 2f77 6663 332f  ci.edu/hst/wfc3/
-00033c60: 616e 616c 7973 6973 2f50 5346 2f70 7366  analysis/PSF/psf
-00033c70: 5f64 6f77 6e6c 6f61 6473 2f77 6663 335f  _downloads/wfc3_
-00033c80: 6972 2f27 0a20 2020 2020 2020 2023 7073  ir/'.        #ps
-00033c90: 665f 7061 7468 203d 2027 6874 7470 733a  f_path = 'https:
-00033ca0: 2f2f 7777 772e 7374 7363 692e 6564 752f  //www.stsci.edu/
-00033cb0: 7e6a 6179 616e 6465 722f 5354 4450 5346  ~jayander/STDPSF
-00033cc0: 732f 5746 4333 4952 2f27 0a20 2020 2020  s/WFC3IR/'.     
-00033cd0: 2020 2023 7073 665f 726f 6f74 203d 2027     #psf_root = '
-00033ce0: 5053 4653 5444 270a 2020 2020 2020 2020  PSFSTD'.        
-00033cf0: 2370 7366 5f70 6174 6820 3d20 2768 7474  #psf_path = 'htt
-00033d00: 7073 3a2f 2f77 7777 2e73 7473 6369 2e65  ps://www.stsci.e
-00033d10: 6475 2f7e 6a61 7961 6e64 6572 2f48 5354  du/~jayander/HST
-00033d20: 3150 4153 532f 270a 2020 2020 2020 2020  1PASS/'.        
-00033d30: 7073 665f 7061 7468 203d 2027 6874 7470  psf_path = 'http
-00033d40: 733a 2f2f 7777 772e 7374 7363 692e 6564  s://www.stsci.ed
-00033d50: 752f 7e6a 6179 616e 6465 722f 4853 5431  u/~jayander/HST1
-00033d60: 5041 5353 2f4c 4942 2f27 0a20 2020 2020  PASS/LIB/'.     
-00033d70: 2020 2070 7366 5f70 6174 6820 2b3d 2027     psf_path += '
-00033d80: 5053 4673 2f53 5444 5053 4673 2f57 4643  PSFs/STDPSFs/WFC
-00033d90: 3349 522f 270a 2020 2020 2020 2020 7073  3IR/'.        ps
-00033da0: 665f 726f 6f74 203d 2027 5354 4450 5346  f_root = 'STDPSF
-00033db0: 270a 2020 2020 2020 2020 0a20 2020 2020  '.        .     
-00033dc0: 2020 2069 725f 7073 665f 6669 6c74 6572     ir_psf_filter
-00033dd0: 7320 3d20 5b27 4631 3035 5727 2c20 2746  s = ['F105W', 'F
-00033de0: 3132 3557 272c 2027 4631 3430 5727 2c20  125W', 'F140W', 
-00033df0: 2746 3136 3057 275d 0a0a 2020 2020 2020  'F160W']..      
-00033e00: 2020 2320 4e65 7720 5053 4673 0a20 2020    # New PSFs.   
-00033e10: 2020 2020 2069 725f 7073 665f 6669 6c74       ir_psf_filt
-00033e20: 6572 7320 2b3d 205b 2746 3131 3057 272c  ers += ['F110W',
-00033e30: 2027 4631 3237 4d27 5d0a 0a20 2020 2020   'F127M']..     
-00033e40: 2020 2066 696c 6573 203d 205b 277b 307d     files = ['{0}
-00033e50: 2f7b 317d 5f57 4643 3349 525f 7b32 7d2e  /{1}_WFC3IR_{2}.
-00033e60: 6669 7473 272e 666f 726d 6174 2870 7366  fits'.format(psf
-00033e70: 5f70 6174 682c 2070 7366 5f72 6f6f 742c  _path, psf_root,
-00033e80: 2066 696c 7429 0a20 2020 2020 2020 2020   filt).         
-00033e90: 2020 2020 2020 2020 666f 7220 6669 6c74          for filt
-00033ea0: 2069 6e20 6972 5f70 7366 5f66 696c 7465   in ir_psf_filte
-00033eb0: 7273 5d0a 0a20 2020 2020 2020 2066 6f72  rs]..        for
-00033ec0: 2075 726c 2069 6e20 6669 6c65 733a 0a20   url in files:. 
-00033ed0: 2020 2020 2020 2020 2020 2066 696c 6520             file 
-00033ee0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00033ef0: 6d65 2875 726c 292e 7265 706c 6163 6528  me(url).replace(
-00033f00: 2753 5444 5053 4627 2c20 2750 5346 5354  'STDPSF', 'PSFST
-00033f10: 4427 290a 2020 2020 2020 2020 2020 2020  D').            
-00033f20: 6966 206e 6f74 206f 732e 7061 7468 2e65  if not os.path.e
-00033f30: 7869 7374 7328 6669 6c65 293a 0a20 2020  xists(file):.   
-00033f40: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00033f50: 6e74 2827 4765 7420 7b30 7d27 2e66 6f72  nt('Get {0}'.for
-00033f60: 6d61 7428 6669 6c65 2929 0a20 2020 2020  mat(file)).     
-00033f70: 2020 2020 2020 2020 2020 206f 732e 7379             os.sy
-00033f80: 7374 656d 2827 6375 726c 202d 6f20 7b30  stem('curl -o {0
-00033f90: 7d20 7b31 7d27 2e66 6f72 6d61 7428 6669  } {1}'.format(fi
-00033fa0: 6c65 2c20 7572 6c29 290a 2020 2020 2020  le, url)).      
-00033fb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00033fc0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00033fd0: 7428 2746 696c 6520 7b30 7d20 6578 6973  t('File {0} exis
-00033fe0: 7473 272e 666f 726d 6174 2866 696c 6529  ts'.format(file)
-00033ff0: 290a 0a20 2020 2069 6620 6765 745f 7374  )..    if get_st
-00034000: 6172 733a 0a20 2020 2020 2020 2023 2053  ars:.        # S
-00034010: 7465 6c6c 6172 2074 656d 706c 6174 6573  tellar templates
-00034020: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-00034030: 5465 6d70 6c61 7465 7320 6469 7265 6374  Templates direct
-00034040: 6f72 793a 207b 307d 2f74 656d 706c 6174  ory: {0}/templat
-00034050: 6573 272e 666f 726d 6174 2847 5249 5a4c  es'.format(GRIZL
-00034060: 495f 5041 5448 2929 0a20 2020 2020 2020  I_PATH)).       
-00034070: 206f 732e 6368 6469 7228 277b 307d 2f74   os.chdir('{0}/t
-00034080: 656d 706c 6174 6573 272e 666f 726d 6174  emplates'.format
-00034090: 2847 5249 5a4c 495f 5041 5448 2929 0a0a  (GRIZLI_PATH))..
-000340a0: 2020 2020 2020 2020 7572 6c20 3d20 2768          url = 'h
-000340b0: 7474 7073 3a2f 2f77 7777 2e73 7473 6369  ttps://www.stsci
-000340c0: 2e65 6475 2f7e 6272 616d 6d65 722f 4772  .edu/~brammer/Gr
-000340d0: 697a 6c69 2f46 696c 6573 2f27 0a20 2020  izli/Files/'.   
-000340e0: 2020 2020 2066 696c 6573 203d 205b 7572       files = [ur
-000340f0: 6c2b 2773 7461 7273 5f70 6963 6b6c 6573  l+'stars_pickles
-00034100: 2e6e 7079 272c 2075 726c 2b27 7374 6172  .npy', url+'star
-00034110: 735f 6270 6773 2e6e 7079 275d 0a0a 2020  s_bpgs.npy']..  
-00034120: 2020 2020 2020 666f 7220 7572 6c20 696e        for url in
-00034130: 2066 696c 6573 3a0a 2020 2020 2020 2020   files:.        
-00034140: 2020 2020 6669 6c65 203d 206f 732e 7061      file = os.pa
-00034150: 7468 2e62 6173 656e 616d 6528 7572 6c29  th.basename(url)
-00034160: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00034170: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-00034180: 7473 2866 696c 6529 3a0a 2020 2020 2020  ts(file):.      
-00034190: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000341a0: 2747 6574 207b 307d 272e 666f 726d 6174  'Get {0}'.format
-000341b0: 2866 696c 6529 290a 2020 2020 2020 2020  (file)).        
-000341c0: 2020 2020 2020 2020 6f73 2e73 7973 7465          os.syste
-000341d0: 6d28 2763 7572 6c20 2d6f 207b 307d 207b  m('curl -o {0} {
-000341e0: 317d 272e 666f 726d 6174 2866 696c 652c  1}'.format(file,
-000341f0: 2075 726c 2929 0a20 2020 2020 2020 2020   url)).         
-00034200: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00034210: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00034220: 4669 6c65 207b 307d 2065 7869 7374 7327  File {0} exists'
-00034230: 2e66 6f72 6d61 7428 6669 6c65 2929 0a0a  .format(file))..
-00034240: 2020 2020 2020 2020 7072 696e 7428 276c          print('l
-00034250: 6e20 2d73 2073 7461 7273 5f70 6963 6b6c  n -s stars_pickl
-00034260: 6573 2e6e 7079 2073 7461 7273 2e6e 7079  es.npy stars.npy
-00034270: 2729 0a20 2020 2020 2020 206f 732e 7379  ').        os.sy
-00034280: 7374 656d 2827 6c6e 202d 7320 7374 6172  stem('ln -s star
-00034290: 735f 7069 636b 6c65 732e 6e70 7920 7374  s_pickles.npy st
-000342a0: 6172 732e 6e70 7927 290a 0a20 2020 206f  ars.npy')..    o
-000342b0: 732e 6368 6469 7228 6377 6429 0a0a 0a63  s.chdir(cwd)...c
-000342c0: 6c61 7373 204d 575f 4639 3928 6f62 6a65  lass MW_F99(obje
-000342d0: 6374 293a 0a20 2020 2022 2222 0a20 2020  ct):.    """.   
-000342e0: 2057 7261 7070 6572 2061 726f 756e 6420   Wrapper around 
-000342f0: 7468 6520 6073 7065 6375 7469 6c73 2e65  the `specutils.e
-00034300: 7874 696e 6374 696f 6e60 202f 2060 6578  xtinction` / `ex
-00034310: 7469 6e63 7469 6f6e 6020 6d6f 6475 6c65  tinction` module
-00034320: 732c 2077 6869 6368 2061 7265 2063 616c  s, which are cal
-00034330: 6c65 6420 6469 6666 6572 656e 746c 790a  led differently.
-00034340: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-00034350: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00034360: 615f 762c 2072 5f76 3d33 2e31 293a 0a20  a_v, r_v=3.1):. 
-00034370: 2020 2020 2020 2073 656c 662e 615f 7620         self.a_v 
-00034380: 3d20 615f 760a 2020 2020 2020 2020 7365  = a_v.        se
-00034390: 6c66 2e72 5f76 203d 2072 5f76 0a0a 2020  lf.r_v = r_v..  
-000343a0: 2020 2020 2020 7365 6c66 2e49 535f 5350        self.IS_SP
-000343b0: 4543 5554 494c 5320 3d20 4661 6c73 650a  ECUTILS = False.
-000343c0: 2020 2020 2020 2020 7365 6c66 2e49 535f          self.IS_
-000343d0: 4558 5449 4e43 5449 4f4e 203d 2046 616c  EXTINCTION = Fal
-000343e0: 7365 0a0a 2020 2020 2020 2020 7472 793a  se..        try:
-000343f0: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00034400: 6d20 7370 6563 7574 696c 732e 6578 7469  m specutils.exti
-00034410: 6e63 7469 6f6e 2069 6d70 6f72 7420 4578  nction import Ex
-00034420: 7469 6e63 7469 6f6e 4639 390a 2020 2020  tinctionF99.    
-00034430: 2020 2020 2020 2020 7365 6c66 2e49 535f          self.IS_
-00034440: 5350 4543 5554 494c 5320 3d20 5472 7565  SPECUTILS = True
-00034450: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00034460: 662e 4639 3920 3d20 4578 7469 6e63 7469  f.F99 = Extincti
-00034470: 6f6e 4639 3928 7365 6c66 2e61 5f76 2c20  onF99(self.a_v, 
-00034480: 725f 763d 7365 6c66 2e72 5f76 290a 2020  r_v=self.r_v).  
-00034490: 2020 2020 2020 6578 6365 7074 2849 6d70        except(Imp
-000344a0: 6f72 7445 7272 6f72 293a 0a20 2020 2020  ortError):.     
-000344b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000344c0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-000344d0: 2065 7874 696e 6374 696f 6e20 696d 706f   extinction impo
-000344e0: 7274 2046 6974 7a70 6174 7269 636b 3939  rt Fitzpatrick99
-000344f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034500: 2073 656c 662e 4953 5f45 5854 494e 4354   self.IS_EXTINCT
-00034510: 494f 4e20 3d20 5472 7565 0a20 2020 2020  ION = True.     
-00034520: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00034530: 4639 3920 3d20 4669 747a 7061 7472 6963  F99 = Fitzpatric
-00034540: 6b39 3928 725f 763d 7365 6c66 2e72 5f76  k99(r_v=self.r_v
-00034550: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-00034560: 7863 6570 7428 496d 706f 7274 4572 726f  xcept(ImportErro
-00034570: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00034580: 2020 2020 7072 696e 7428 2222 220a 436f      print(""".Co
-00034590: 756c 646e 5c27 7420 6669 6e64 2065 7874  uldn\'t find ext
-000345a0: 696e 6374 696f 6e20 6d6f 6475 6c65 7320  inction modules 
-000345b0: 696e 0a60 7370 6563 7574 696c 732e 6578  in.`specutils.ex
-000345c0: 7469 6e63 7469 6f6e 6020 6f72 0a60 6578  tinction` or.`ex
-000345d0: 7469 6e63 7469 6f6e 2e46 6974 7a70 6174  tinction.Fitzpat
-000345e0: 7269 636b 3939 602e 0a0a 4d57 2065 7874  rick99`...MW ext
-000345f0: 696e 6374 696f 6e20 6e6f 7420 696d 706c  inction not impl
-00034600: 656d 656e 7465 642e 0a22 2222 290a 0a20  emented..""").. 
-00034610: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-00034620: 7573 203d 2073 656c 662e 4953 5f53 5045  us = self.IS_SPE
-00034630: 4355 5449 4c53 207c 2073 656c 662e 4953  CUTILS | self.IS
-00034640: 5f45 5854 494e 4354 494f 4e0a 0a20 2020  _EXTINCTION..   
-00034650: 2064 6566 205f 5f63 616c 6c5f 5f28 7365   def __call__(se
-00034660: 6c66 2c20 7761 7665 5f69 6e70 7574 293a  lf, wave_input):
-00034670: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
-00034680: 6173 7472 6f70 792e 756e 6974 7320 6173  astropy.units as
-00034690: 2075 0a0a 2020 2020 2020 2020 6966 2069   u..        if i
-000346a0: 7369 6e73 7461 6e63 6528 7761 7665 5f69  sinstance(wave_i
-000346b0: 6e70 7574 2c20 6c69 7374 293a 0a20 2020  nput, list):.   
-000346c0: 2020 2020 2020 2020 2077 6176 6520 3d20           wave = 
-000346d0: 6e70 2e61 7272 6179 2877 6176 655f 696e  np.array(wave_in
-000346e0: 7075 7429 0a20 2020 2020 2020 2065 6c73  put).        els
-000346f0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00034700: 6176 6520 3d20 7761 7665 5f69 6e70 7574  ave = wave_input
-00034710: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00034720: 662e 7374 6174 7573 2069 7320 4661 6c73  f.status is Fals
-00034730: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00034740: 6574 7572 6e20 6e70 2e7a 6572 6f73 5f6c  eturn np.zeros_l
-00034750: 696b 6528 7761 7665 290a 0a20 2020 2020  ike(wave)..     
-00034760: 2020 2069 6620 7365 6c66 2e49 535f 5350     if self.IS_SP
-00034770: 4543 5554 494c 533a 0a20 2020 2020 2020  ECUTILS:.       
-00034780: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
-00034790: 7761 7665 2c20 2775 6e69 7427 293a 0a20  wave, 'unit'):. 
-000347a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000347b0: 6176 655f 6161 203d 2077 6176 650a 2020  ave_aa = wave.  
-000347c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000347d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347e0: 7761 7665 5f61 6120 3d20 7761 7665 2a75  wave_aa = wave*u
-000347f0: 2e41 410a 0a20 2020 2020 2020 2020 2020  .AA..           
-00034800: 2072 6574 7572 6e20 7365 6c66 2e46 3939   return self.F99
-00034810: 2877 6176 655f 6161 290a 0a20 2020 2020  (wave_aa)..     
-00034820: 2020 2069 6620 7365 6c66 2e49 535f 4558     if self.IS_EX
-00034830: 5449 4e43 5449 4f4e 3a0a 2020 2020 2020  TINCTION:.      
-00034840: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
-00034850: 2877 6176 652c 2027 756e 6974 2729 3a0a  (wave, 'unit'):.
-00034860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034870: 7761 7665 5f61 6120 3d20 7761 7665 2e74  wave_aa = wave.t
-00034880: 6f28 752e 4141 290a 2020 2020 2020 2020  o(u.AA).        
-00034890: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000348a0: 2020 2020 2020 2020 2020 7761 7665 5f61            wave_a
-000348b0: 6120 3d20 7761 7665 0a0a 2020 2020 2020  a = wave..      
-000348c0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000348d0: 662e 4639 3928 7761 7665 5f61 612c 2073  f.F99(wave_aa, s
-000348e0: 656c 662e 615f 762c 2075 6e69 743d 2761  elf.a_v, unit='a
-000348f0: 6127 290a 0a0a 636c 6173 7320 4566 6665  a')...class Effe
-00034900: 6374 6976 6550 5346 3a0a 2020 2020 6465  ctivePSF:.    de
-00034910: 6620 5f5f 696e 6974 5f5f 2873 656c 6629  f __init__(self)
-00034920: 3a0a 2020 2020 2020 2020 2222 2254 6f6f  :.        """Too
-00034930: 6c73 2066 6f72 2068 616e 646c 696e 6720  ls for handling 
-00034940: 5746 4333 2f49 5220 4566 6665 6374 6976  WFC3/IR Effectiv
-00034950: 6520 5053 460a 0a20 2020 2020 2020 2053  e PSF..        S
-00034960: 6565 2064 6f63 756d 656e 7461 7469 6f6e  ee documentation
-00034970: 2061 7420 6874 7470 3a2f 2f77 7777 2e73   at http://www.s
-00034980: 7473 6369 2e65 6475 2f68 7374 2f77 6663  tsci.edu/hst/wfc
-00034990: 332f 616e 616c 7973 6973 2f50 5346 2e0a  3/analysis/PSF..
-000349a0: 0a20 2020 2020 2020 2050 5346 2066 696c  .        PSF fil
-000349b0: 6573 2073 746f 7265 6420 696e 2024 4752  es stored in $GR
-000349c0: 495a 4c49 2f43 4f4e 462f 0a20 2020 2020  IZLI/CONF/.     
-000349d0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-000349e0: 7365 6c66 2e6c 6f61 645f 5053 465f 6461  self.load_PSF_da
-000349f0: 7461 2829 0a0a 2020 2020 6465 6620 6c6f  ta()..    def lo
-00034a00: 6164 5f50 5346 5f64 6174 6128 7365 6c66  ad_PSF_data(self
-00034a10: 293a 0a20 2020 2020 2020 2022 2222 4c6f  ):.        """Lo
-00034a20: 6164 2064 6174 6120 6672 6f6d 2050 5346  ad data from PSF
-00034a30: 5354 4420 6669 6c65 730a 0a20 2020 2020  STD files..     
-00034a40: 2020 2046 696c 6573 2073 686f 756c 6420     Files should 
-00034a50: 6265 206c 6f63 6174 6564 2069 6e20 247b  be located in ${
-00034a60: 4752 495a 4c49 7d2f 434f 4e46 2f20 6469  GRIZLI}/CONF/ di
-00034a70: 7265 6374 6f72 792e 0a20 2020 2020 2020  rectory..       
-00034a80: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
-00034a90: 662e 6570 7366 203d 204f 7264 6572 6564  f.epsf = Ordered
-00034aa0: 4469 6374 2829 0a0a 2020 2020 2020 2020  Dict()..        
-00034ab0: 666f 7220 6669 6c74 6572 2069 6e20 5b27  for filter in ['
-00034ac0: 4631 3035 5727 2c20 2746 3131 3057 272c  F105W', 'F110W',
-00034ad0: 2027 4631 3235 5727 2c20 2746 3134 3057   'F125W', 'F140W
-00034ae0: 272c 2027 4631 3630 5727 2c20 2746 3132  ', 'F160W', 'F12
-00034af0: 374d 275d 3a0a 2020 2020 2020 2020 2020  7M']:.          
-00034b00: 2020 6669 6c65 203d 206f 732e 7061 7468    file = os.path
-00034b10: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
-00034b20: 482c 2027 434f 4e46 272c 0a20 2020 2020  H, 'CONF',.     
-00034b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b40: 2020 2020 2020 2020 2020 2027 5053 4653             'PSFS
-00034b50: 5444 5f57 4643 3349 525f 7b30 7d2e 6669  TD_WFC3IR_{0}.fi
-00034b60: 7473 272e 666f 726d 6174 2866 696c 7465  ts'.format(filte
-00034b70: 7229 290a 0a20 2020 2020 2020 2020 2020  r))..           
-00034b80: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
-00034b90: 6578 6973 7473 2866 696c 6529 3a0a 2020  exists(file):.  
-00034ba0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00034bb0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00034bc0: 2020 2020 7769 7468 2070 7966 6974 732e      with pyfits.
-00034bd0: 6f70 656e 2866 696c 6529 2061 7320 5f69  open(file) as _i
-00034be0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-00034bf0: 2020 2064 6174 6120 3d20 5f69 6d5b 305d     data = _im[0]
-00034c00: 2e64 6174 612e 542a 310a 2020 2020 2020  .data.T*1.      
-00034c10: 2020 2020 2020 2020 2020 6461 7461 5b64            data[d
-00034c20: 6174 6120 3c20 305d 203d 2030 0a0a 2020  ata < 0] = 0..  
-00034c30: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-00034c40: 7073 665b 6669 6c74 6572 5d20 3d20 6461  psf[filter] = da
-00034c50: 7461 0a20 2020 2020 2020 200a 2020 2020  ta.        .    
-00034c60: 2020 2020 2320 5556 4953 0a20 2020 2020      # UVIS.     
-00034c70: 2020 2066 696c 7465 725f 6669 6c65 7320     filter_files 
-00034c80: 3d20 676c 6f62 2e67 6c6f 6228 6f73 2e70  = glob.glob(os.p
-00034c90: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
-00034ca0: 5041 5448 2c20 2743 4f4e 4627 2c0a 2020  PATH, 'CONF',.  
-00034cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034cc0: 2020 2020 2020 2020 2020 2750 5346 5354            'PSFST
-00034cd0: 445f 5746 4333 5556 2a2e 6669 7473 2729  D_WFC3UV*.fits')
-00034ce0: 290a 2020 2020 2020 2020 6669 6c74 6572  ).        filter
-00034cf0: 5f66 696c 6573 2e73 6f72 7428 290a 2020  _files.sort().  
-00034d00: 2020 2020 2020 666f 7220 6669 6c65 2069        for file i
-00034d10: 6e20 6669 6c74 6572 5f66 696c 6573 3a0a  n filter_files:.
-00034d20: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00034d30: 2070 7966 6974 732e 6f70 656e 2866 696c   pyfits.open(fil
-00034d40: 652c 2069 676e 6f72 655f 6d69 7373 696e  e, ignore_missin
-00034d50: 675f 656e 643d 5472 7565 2920 6173 205f  g_end=True) as _
-00034d60: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-00034d70: 2020 2020 6461 7461 203d 205f 696d 5b30      data = _im[0
-00034d80: 5d2e 6461 7461 2e54 2a31 0a20 2020 2020  ].data.T*1.     
-00034d90: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00034da0: 6461 7461 203c 2030 5d20 3d20 300a 2020  data < 0] = 0.  
-00034db0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00034dc0: 2020 2020 2020 2020 2020 2066 696c 7420             filt 
-00034dd0: 3d20 275f 272e 6a6f 696e 2866 696c 652e  = '_'.join(file.
-00034de0: 7374 7269 7028 272e 6669 7473 2729 2e73  strip('.fits').s
-00034df0: 706c 6974 2827 5f27 295b 323a 5d29 0a20  plit('_')[2:]). 
-00034e00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00034e10: 6570 7366 5b66 696c 742b 2755 275d 203d  epsf[filt+'U'] =
-00034e20: 2064 6174 610a 0a20 2020 2020 2020 2023   data..        #
-00034e30: 2041 4353 0a20 2020 2020 2020 2066 696c   ACS.        fil
-00034e40: 7465 725f 6669 6c65 7320 3d20 676c 6f62  ter_files = glob
-00034e50: 2e67 6c6f 6228 6f73 2e70 6174 682e 6a6f  .glob(os.path.jo
-00034e60: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
-00034e70: 2743 4f4e 4627 2c0a 2020 2020 2020 2020  'CONF',.        
-00034e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034e90: 2020 2020 2750 5346 5354 445f 4143 5357      'PSFSTD_ACSW
-00034ea0: 4643 2a2e 6669 7473 2729 290a 2020 2020  FC*.fits')).    
-00034eb0: 2020 2020 6669 6c74 6572 5f66 696c 6573      filter_files
-00034ec0: 2e73 6f72 7428 290a 2020 2020 2020 2020  .sort().        
-00034ed0: 666f 7220 6669 6c65 2069 6e20 6669 6c74  for file in filt
-00034ee0: 6572 5f66 696c 6573 3a0a 2020 2020 2020  er_files:.      
-00034ef0: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
-00034f00: 732e 6f70 656e 2866 696c 652c 2069 676e  s.open(file, ign
-00034f10: 6f72 655f 6d69 7373 696e 675f 656e 643d  ore_missing_end=
-00034f20: 5472 7565 2920 6173 205f 696d 3a0a 2020  True) as _im:.  
-00034f30: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00034f40: 7461 203d 205f 696d 5b30 5d2e 6461 7461  ta = _im[0].data
-00034f50: 2e54 2a31 2e0a 2020 2020 2020 2020 2020  .T*1..          
-00034f60: 2020 2020 2020 6461 7461 5b64 6174 6120        data[data 
-00034f70: 3c20 305d 203d 2030 0a20 2020 2020 2020  < 0] = 0.       
-00034f80: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00034f90: 2020 2020 2020 6669 6c74 203d 2027 5f27        filt = '_'
-00034fa0: 2e6a 6f69 6e28 6669 6c65 2e73 7472 6970  .join(file.strip
-00034fb0: 2827 2e66 6974 7327 292e 7370 6c69 7428  ('.fits').split(
-00034fc0: 275f 2729 5b32 3a5d 290a 2020 2020 2020  '_')[2:]).      
-00034fd0: 2020 2020 2020 7365 6c66 2e65 7073 665b        self.epsf[
-00034fe0: 6669 6c74 5d20 3d20 6461 7461 0a20 2020  filt] = data.   
-00034ff0: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
-00035000: 4a57 5354 0a20 2020 2020 2020 2066 696c  JWST.        fil
-00035010: 7465 725f 6669 6c65 7320 3d20 676c 6f62  ter_files = glob
-00035020: 2e67 6c6f 6228 6f73 2e70 6174 682e 6a6f  .glob(os.path.jo
-00035030: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
-00035040: 2743 4f4e 462f 4a57 5354 6550 5346 272c  'CONF/JWSTePSF',
-00035050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035060: 2020 2020 2020 2020 2020 2020 2027 6e69               'ni
-00035070: 7263 616d 2a2e 6669 7473 2729 290a 2020  rcam*.fits')).  
-00035080: 2020 2020 2020 6669 6c74 6572 5f66 696c        filter_fil
-00035090: 6573 202b 3d20 676c 6f62 2e67 6c6f 6228  es += glob.glob(
-000350a0: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
-000350b0: 5a4c 495f 5041 5448 2c20 2743 4f4e 462f  ZLI_PATH, 'CONF/
-000350c0: 4a57 5354 6550 5346 272c 0a20 2020 2020  JWSTePSF',.     
-000350d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000350e0: 2020 2020 2020 2027 6e69 7269 7373 2a2e         'niriss*.
-000350f0: 6669 7473 2729 290a 2020 2020 2020 2020  fits')).        
-00035100: 6669 6c74 6572 5f66 696c 6573 202b 3d20  filter_files += 
-00035110: 676c 6f62 2e67 6c6f 6228 6f73 2e70 6174  glob.glob(os.pat
-00035120: 682e 6a6f 696e 2847 5249 5a4c 495f 5041  h.join(GRIZLI_PA
-00035130: 5448 2c20 2743 4f4e 462f 4a57 5354 6550  TH, 'CONF/JWSTeP
-00035140: 5346 272c 0a20 2020 2020 2020 2020 2020  SF',.           
-00035150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035160: 2027 6d69 7269 2a2e 6669 7473 2729 290a   'miri*.fits')).
-00035170: 2020 2020 2020 2020 6669 6c74 6572 5f66          filter_f
-00035180: 696c 6573 2e73 6f72 7428 290a 2020 2020  iles.sort().    
-00035190: 2020 2020 666f 7220 6669 6c65 2069 6e20      for file in 
-000351a0: 6669 6c74 6572 5f66 696c 6573 3a0a 2020  filter_files:.  
-000351b0: 2020 2020 2020 2020 2020 7769 7468 2070            with p
-000351c0: 7966 6974 732e 6f70 656e 2866 696c 652c  yfits.open(file,
-000351d0: 2069 676e 6f72 655f 6d69 7373 696e 675f   ignore_missing_
-000351e0: 656e 643d 5472 7565 2920 6173 205f 696d  end=True) as _im
-000351f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00035200: 2020 6461 7461 203d 205f 696d 5b30 5d2e    data = _im[0].
-00035210: 6461 7461 2a31 2023 205b 3a3a 2d31 2c3a  data*1 # [::-1,:
-00035220: 2c3a 5d23 5b3a 2c3a 3a2d 312c 3a5d 0a20  ,:]#[:,::-1,:]. 
-00035230: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00035240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035250: 6461 7461 5b64 6174 6120 3c20 305d 203d  data[data < 0] =
-00035260: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00035270: 2020 206b 6579 203d 2027 7b30 7d2d 7b31     key = '{0}-{1
-00035280: 7d27 2e66 6f72 6d61 7428 5f69 6d5b 305d  }'.format(_im[0]
-00035290: 2e68 6561 6465 725b 2744 4554 4543 544f  .header['DETECTO
-000352a0: 5227 5d2e 7570 7065 7228 292c 0a20 2020  R'].upper(),.   
-000352b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000352c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000352d0: 2020 2020 5f69 6d5b 305d 2e68 6561 6465      _im[0].heade
-000352e0: 725b 2746 494c 5445 5227 5d29 0a20 2020  r['FILTER']).   
-000352f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00035300: 2020 2020 2020 2020 2020 6966 2027 4c41            if 'LA
-00035310: 4245 4c27 2069 6e20 5f69 6d5b 305d 2e68  BEL' in _im[0].h
-00035320: 6561 6465 723a 0a20 2020 2020 2020 2020  eader:.         
-00035330: 2020 2020 2020 2020 2020 206b 6579 202b             key +
-00035340: 3d20 272d 2720 2b20 5f69 6d5b 305d 2e68  = '-' + _im[0].h
-00035350: 6561 6465 725b 274c 4142 454c 275d 0a20  eader['LABEL']. 
-00035360: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00035370: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00035380: 2e65 7073 665b 6b65 795d 203d 2064 6174  .epsf[key] = dat
-00035390: 610a 2020 2020 2020 2020 0a20 2020 2020  a.        .     
-000353a0: 2020 2023 2044 756d 6d79 2c20 7573 6520     # Dummy, use 
-000353b0: 4631 3035 5720 6550 5346 2066 6f72 2046  F105W ePSF for F
-000353c0: 3039 384d 2061 6e64 2046 3131 3057 0a20  098M and F110W. 
-000353d0: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
-000353e0: 5b27 4630 3938 4d27 5d20 3d20 7365 6c66  ['F098M'] = self
-000353f0: 2e65 7073 665b 2746 3130 3557 275d 0a20  .epsf['F105W']. 
-00035400: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
-00035410: 5b27 4631 3238 4e27 5d20 3d20 7365 6c66  ['F128N'] = self
-00035420: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
-00035430: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
-00035440: 5b27 4631 3330 4e27 5d20 3d20 7365 6c66  ['F130N'] = self
-00035450: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
-00035460: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
-00035470: 5b27 4631 3332 4e27 5d20 3d20 7365 6c66  ['F132N'] = self
-00035480: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
-00035490: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-000354a0: 2320 4475 6d6d 7920 6669 6c74 6572 7320  # Dummy filters 
-000354b0: 666f 7220 4952 2067 7269 736d 730a 2020  for IR grisms.  
-000354c0: 2020 2020 2020 7365 6c66 2e65 7073 665b        self.epsf[
-000354d0: 2747 3134 3127 5d20 3d20 7365 6c66 2e65  'G141'] = self.e
-000354e0: 7073 665b 2746 3134 3057 275d 0a20 2020  psf['F140W'].   
-000354f0: 2020 2020 2073 656c 662e 6570 7366 5b27       self.epsf['
-00035500: 4731 3032 275d 203d 2073 656c 662e 6570  G102'] = self.ep
-00035510: 7366 5b27 4631 3035 5727 5d0a 2020 2020  sf['F105W'].    
-00035520: 2020 2020 0a20 2020 2020 2020 2023 2045      .        # E
-00035530: 7874 656e 6465 640a 2020 2020 2020 2020  xtended.        
-00035540: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
-00035550: 7366 203d 207b 7d0a 2020 2020 2020 2020  sf = {}.        
-00035560: 666f 7220 6669 6c74 6572 2069 6e20 5b27  for filter in ['
-00035570: 4631 3035 5727 2c20 2746 3132 3557 272c  F105W', 'F125W',
-00035580: 2027 4631 3430 5727 2c20 2746 3136 3057   'F140W', 'F160W
-00035590: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
-000355a0: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
-000355b0: 6f69 6e28 4752 495a 4c49 5f50 4154 482c  oin(GRIZLI_PATH,
-000355c0: 2027 434f 4e46 272c 0a20 2020 2020 2020   'CONF',.       
-000355d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000355e0: 2020 2020 2020 2020 2027 6578 7465 6e64           'extend
-000355f0: 6564 5f50 5346 5f7b 307d 2e66 6974 7327  ed_PSF_{0}.fits'
-00035600: 2e66 6f72 6d61 7428 6669 6c74 6572 2929  .format(filter))
-00035610: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00035620: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
-00035630: 7374 7328 6669 6c65 293a 0a20 2020 2020  sts(file):.     
-00035640: 2020 2020 2020 2020 2020 2023 4241 5345             #BASE
-00035650: 5552 4c20 3d20 2768 7474 7073 3a2f 2f65  URL = 'https://e
-00035660: 7264 612e 6b75 2e64 6b2f 7667 7269 642f  rda.ku.dk/vgrid/
-00035670: 4761 6272 6965 6c25 3230 4272 616d 6d65  Gabriel%20Bramme
-00035680: 722f 434f 4e46 2f27 0a20 2020 2020 2020  r/CONF/'.       
-00035690: 2020 2020 2020 2020 2042 4153 4555 524c           BASEURL
-000356a0: 203d 2028 2768 7474 7073 3a2f 2f72 6177   = ('https://raw
-000356b0: 2e67 6974 6875 6275 7365 7263 6f6e 7465  .githubuserconte
-000356c0: 6e74 2e63 6f6d 2f67 6272 616d 6d65 722f  nt.com/gbrammer/
-000356d0: 2720 2b0a 2020 2020 2020 2020 2020 2020  ' +.            
-000356e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000356f0: 6772 697a 6c69 2d63 6f6e 6669 672f 6d61  grizli-config/ma
-00035700: 7374 6572 2729 0a0a 2020 2020 2020 2020  ster')..        
-00035710: 2020 2020 2020 2020 6d73 6720 3d20 2745          msg = 'E
-00035720: 7874 656e 6465 6420 5053 4620 6669 6c65  xtended PSF file
-00035730: 205c 277b 307d 5c27 206e 6f74 2066 6f75   \'{0}\' not fou
-00035740: 6e64 2e27 2e66 6f72 6d61 7428 6669 6c65  nd.'.format(file
-00035750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00035760: 2020 6d73 6720 2b3d 2027 4765 7420 7468    msg += 'Get th
-00035770: 6520 6172 6368 6976 6520 6672 6f6d 2027  e archive from '
-00035780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035790: 206d 7367 202b 3d20 6627 207b 4241 5345   msg += f' {BASE
-000357a0: 5552 4c7d 2f57 4643 3349 525f 6578 7465  URL}/WFC3IR_exte
-000357b0: 6e64 6564 5f50 5346 2e76 312e 7461 722e  nded_PSF.v1.tar.
-000357c0: 677a 270a 2020 2020 2020 2020 2020 2020  gz'.            
-000357d0: 2020 2020 6d73 6720 2b3d 2027 2061 6e64      msg += ' and
-000357e0: 2075 6e70 6163 6b20 696e 2024 7b47 5249   unpack in ${GRI
-000357f0: 5a4c 497d 2f43 4f4e 462f 270a 2020 2020  ZLI}/CONF/'.    
-00035800: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00035810: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
-00035820: 726f 7228 6d73 6729 0a0a 2020 2020 2020  ror(msg)..      
-00035830: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
-00035840: 732e 6f70 656e 2866 696c 6529 2061 7320  s.open(file) as 
-00035850: 5f69 6d3a 0a20 2020 2020 2020 2020 2020  _im:.           
-00035860: 2020 2020 2064 6174 6120 3d20 5f69 6d5b       data = _im[
-00035870: 305d 2e64 6174 612a 310a 2020 2020 2020  0].data*1.      
-00035880: 2020 2020 2020 2020 2020 6461 7461 5b64            data[d
-00035890: 6174 6120 3c20 305d 203d 2030 0a0a 2020  ata < 0] = 0..  
-000358a0: 2020 2020 2020 2020 2020 2320 4d61 736b            # Mask
-000358b0: 2063 656e 7465 720a 2020 2020 2020 2020   center.        
-000358c0: 2020 2020 4e58 203d 2064 6174 612e 7368      NX = data.sh
-000358d0: 6170 655b 305d 2f32 2d31 0a20 2020 2020  ape[0]/2-1.     
-000358e0: 2020 2020 2020 2079 702c 2078 7020 3d20         yp, xp = 
-000358f0: 6e70 2e69 6e64 6963 6573 2864 6174 612e  np.indices(data.
-00035900: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
-00035910: 2020 2052 203d 206e 702e 7371 7274 2828     R = np.sqrt((
-00035920: 7870 2d4e 5829 2a2a 322b 2879 702d 4e58  xp-NX)**2+(yp-NX
-00035930: 292a 2a32 290a 2020 2020 2020 2020 2020  )**2).          
-00035940: 2020 6461 7461 5b52 203c 3d20 345d 203d    data[R <= 4] =
-00035950: 2030 2e0a 0a20 2020 2020 2020 2020 2020   0...           
-00035960: 2073 656c 662e 6578 7465 6e64 6564 5f65   self.extended_e
-00035970: 7073 665b 6669 6c74 6572 5d20 3d20 6461  psf[filter] = da
-00035980: 7461 0a20 2020 2020 2020 2020 2020 2073  ta.            s
-00035990: 656c 662e 6578 7465 6e64 6564 5f4e 203d  elf.extended_N =
-000359a0: 2069 6e74 284e 5829 0a0a 2020 2020 2020   int(NX)..      
-000359b0: 2020 7365 6c66 2e65 7874 656e 6465 645f    self.extended_
-000359c0: 6570 7366 5b27 4630 3938 4d27 5d20 3d20  epsf['F098M'] = 
-000359d0: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
-000359e0: 7366 5b27 4631 3035 5727 5d0a 2020 2020  sf['F105W'].    
-000359f0: 2020 2020 7365 6c66 2e65 7874 656e 6465      self.extende
-00035a00: 645f 6570 7366 5b27 4631 3130 5727 5d20  d_epsf['F110W'] 
-00035a10: 3d20 7365 6c66 2e65 7874 656e 6465 645f  = self.extended_
-00035a20: 6570 7366 5b27 4631 3035 5727 5d0a 2020  epsf['F105W'].  
-00035a30: 2020 2020 2020 7365 6c66 2e65 7874 656e        self.exten
-00035a40: 6465 645f 6570 7366 5b27 4631 3238 4e27  ded_epsf['F128N'
-00035a50: 5d20 3d20 7365 6c66 2e65 7874 656e 6465  ] = self.extende
-00035a60: 645f 6570 7366 5b27 4631 3235 5727 5d0a  d_epsf['F125W'].
-00035a70: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
-00035a80: 656e 6465 645f 6570 7366 5b27 4631 3330  ended_epsf['F130
-00035a90: 4e27 5d20 3d20 7365 6c66 2e65 7874 656e  N'] = self.exten
-00035aa0: 6465 645f 6570 7366 5b27 4631 3235 5727  ded_epsf['F125W'
-00035ab0: 5d0a 2020 2020 2020 2020 7365 6c66 2e65  ].        self.e
-00035ac0: 7874 656e 6465 645f 6570 7366 5b27 4631  xtended_epsf['F1
-00035ad0: 3332 4e27 5d20 3d20 7365 6c66 2e65 7874  32N'] = self.ext
-00035ae0: 656e 6465 645f 6570 7366 5b27 4631 3235  ended_epsf['F125
-00035af0: 5727 5d0a 2020 2020 2020 2020 7365 6c66  W'].        self
-00035b00: 2e65 7874 656e 6465 645f 6570 7366 5b27  .extended_epsf['
-00035b10: 4731 3032 275d 203d 2073 656c 662e 6578  G102'] = self.ex
-00035b20: 7465 6e64 6564 5f65 7073 665b 2746 3130  tended_epsf['F10
-00035b30: 3557 275d 0a20 2020 2020 2020 2073 656c  5W'].        sel
-00035b40: 662e 6578 7465 6e64 6564 5f65 7073 665b  f.extended_epsf[
-00035b50: 2747 3134 3127 5d20 3d20 7365 6c66 2e65  'G141'] = self.e
-00035b60: 7874 656e 6465 645f 6570 7366 5b27 4631  xtended_epsf['F1
-00035b70: 3430 5727 5d0a 0a0a 2020 2020 6465 6620  40W']...    def 
-00035b80: 6765 745f 6174 5f70 6f73 6974 696f 6e28  get_at_position(
-00035b90: 7365 6c66 2c20 783d 3530 372c 2079 3d35  self, x=507, y=5
-00035ba0: 3037 2c20 6669 6c74 6572 3d27 4631 3430  07, filter='F140
-00035bb0: 5727 2c20 726f 7439 303d 3029 3a0a 2020  W', rot90=0):.  
-00035bc0: 2020 2020 2020 2222 2245 7661 6c75 6174        """Evaluat
-00035bd0: 6520 6550 5346 2061 7420 6465 7465 6374  e ePSF at detect
-00035be0: 6f72 2063 6f6f 7264 696e 6174 6573 0a20  or coordinates. 
-00035bf0: 2020 2020 2020 2054 4244 0a20 2020 2020         TBD.     
-00035c00: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
-00035c10: 7073 6620 3d20 7365 6c66 2e65 7073 665b  psf = self.epsf[
-00035c20: 6669 6c74 6572 5d0a 2020 2020 2020 2020  filter].        
-00035c30: 0a20 2020 2020 2020 2070 7366 5f74 7970  .        psf_typ
-00035c40: 6520 3d20 2748 5354 2f4f 7074 6963 616c  e = 'HST/Optical
-00035c50: 270a 2020 2020 2020 2020 0a20 2020 2020  '.        .     
-00035c60: 2020 2069 6620 6669 6c74 6572 2069 6e20     if filter in 
-00035c70: 5b27 4630 3938 4d27 2c20 2746 3131 3057  ['F098M', 'F110W
-00035c80: 272c 2027 4631 3035 5727 2c20 2746 3132  ', 'F105W', 'F12
-00035c90: 3557 272c 2027 4631 3430 5727 2c20 2746  5W', 'F140W', 'F
-00035ca0: 3136 3057 272c 0a20 2020 2020 2020 2020  160W',.         
-00035cb0: 2020 2020 2020 2020 2020 2020 2027 4731               'G1
-00035cc0: 3032 272c 2747 3134 3127 2c27 4631 3238  02','G141','F128
-00035cd0: 4e27 2c27 4631 3330 4e27 2c27 4631 3332  N','F130N','F132
-00035ce0: 4e27 5d3a 0a20 2020 2020 2020 2020 2020  N']:.           
-00035cf0: 2070 7366 5f74 7970 6520 3d20 2757 4643   psf_type = 'WFC
-00035d00: 332f 4952 270a 2020 2020 2020 2020 2020  3/IR'.          
-00035d10: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
-00035d20: 6669 6c74 6572 2e73 7461 7274 7377 6974  filter.startswit
-00035d30: 6828 274e 5243 2729 207c 2066 696c 7465  h('NRC') | filte
-00035d40: 722e 7374 6172 7473 7769 7468 2827 4e49  r.startswith('NI
-00035d50: 5327 293a 0a20 2020 2020 2020 2020 2020  S'):.           
-00035d60: 2023 204e 4952 4953 532c 204e 4952 4361   # NIRISS, NIRCa
-00035d70: 6d20 324b 0a20 2020 2020 2020 2020 2020  m 2K.           
-00035d80: 2070 7366 5f74 7970 6520 3d20 274a 5753   psf_type = 'JWS
-00035d90: 542f 324b 270a 2020 2020 2020 2020 2020  T/2K'.          
-00035da0: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
-00035db0: 6669 6c74 6572 2e73 7461 7274 7377 6974  filter.startswit
-00035dc0: 6828 274d 4952 4927 293a 0a20 2020 2020  h('MIRI'):.     
-00035dd0: 2020 2020 2020 2070 7366 5f74 7970 6520         psf_type 
-00035de0: 3d20 274a 5753 542f 4d49 5249 270a 2020  = 'JWST/MIRI'.  
-00035df0: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
-00035e00: 656c 662e 6576 616c 5f70 7366 5f74 7970  elf.eval_psf_typ
-00035e10: 6520 3d20 7073 665f 7479 7065 0a20 2020  e = psf_type.   
-00035e20: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-00035e30: 2070 7366 5f74 7970 6520 3d3d 2027 5746   psf_type == 'WF
-00035e40: 4333 2f49 5227 3a0a 2020 2020 2020 2020  C3/IR':.        
-00035e50: 2020 2020 2320 2049 5220 6465 7465 6374      #  IR detect
-00035e60: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
-00035e70: 7820 3d20 312b 286e 702e 636c 6970 2878  x = 1+(np.clip(x
-00035e80: 2c20 312c 2031 3031 3329 2d30 292f 3530  , 1, 1013)-0)/50
-00035e90: 372e 0a20 2020 2020 2020 2020 2020 2072  7..            r
-00035ea0: 7920 3d20 312b 286e 702e 636c 6970 2879  y = 1+(np.clip(y
-00035eb0: 2c20 312c 2031 3031 3329 2d30 292f 3530  , 1, 1013)-0)/50
-00035ec0: 372e 0a0a 2020 2020 2020 2020 2020 2020  7...            
-00035ed0: 2320 7a65 726f 2069 6e64 6578 0a20 2020  # zero index.   
-00035ee0: 2020 2020 2020 2020 2072 7820 2d3d 2031           rx -= 1
-00035ef0: 0a20 2020 2020 2020 2020 2020 2072 7920  .            ry 
-00035f00: 2d3d 2031 0a0a 2020 2020 2020 2020 2020  -= 1..          
-00035f10: 2020 6e78 203d 206e 702e 636c 6970 2869    nx = np.clip(i
-00035f20: 6e74 2872 7829 2c20 302c 2032 290a 2020  nt(rx), 0, 2).  
-00035f30: 2020 2020 2020 2020 2020 6e79 203d 206e            ny = n
-00035f40: 702e 636c 6970 2869 6e74 2872 7929 2c20  p.clip(int(ry), 
-00035f50: 302c 2032 290a 0a20 2020 2020 2020 2020  0, 2)..         
-00035f60: 2020 2023 2070 7269 6e74 2078 2c20 792c     # print x, y,
-00035f70: 2072 782c 2072 792c 206e 782c 206e 790a   rx, ry, nx, ny.
-00035f80: 0a20 2020 2020 2020 2020 2020 2066 7820  .            fx 
-00035f90: 3d20 7278 2d6e 780a 2020 2020 2020 2020  = rx-nx.        
-00035fa0: 2020 2020 6679 203d 2072 792d 6e79 0a0a      fy = ry-ny..
-00035fb0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
-00035fc0: 7879 203d 2028 312d 6678 292a 2831 2d66  xy = (1-fx)*(1-f
-00035fd0: 7929 2a65 7073 665b 3a2c 203a 2c20 6e78  y)*epsf[:, :, nx
-00035fe0: 2b6e 792a 335d 0a20 2020 2020 2020 2020  +ny*3].         
-00035ff0: 2020 2070 7366 5f78 7920 2b3d 2066 782a     psf_xy += fx*
-00036000: 2831 2d66 7929 2a65 7073 665b 3a2c 203a  (1-fy)*epsf[:, :
-00036010: 2c20 286e 782b 3129 2b6e 792a 335d 0a20  , (nx+1)+ny*3]. 
-00036020: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
-00036030: 7920 2b3d 2028 312d 6678 292a 6679 2a65  y += (1-fx)*fy*e
-00036040: 7073 665b 3a2c 203a 2c20 6e78 2b28 6e79  psf[:, :, nx+(ny
-00036050: 2b31 292a 335d 0a20 2020 2020 2020 2020  +1)*3].         
-00036060: 2020 2070 7366 5f78 7920 2b3d 2066 782a     psf_xy += fx*
-00036070: 6679 2a65 7073 665b 3a2c 203a 2c20 286e  fy*epsf[:, :, (n
-00036080: 782b 3129 2b28 6e79 2b31 292a 335d 0a20  x+1)+(ny+1)*3]. 
-00036090: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000360a0: 2020 2020 2020 2020 7365 6c66 2e65 7661          self.eva
-000360b0: 6c5f 6669 6c74 6572 203d 2066 696c 7465  l_filter = filte
-000360c0: 720a 2020 2020 2020 2020 0a20 2020 2020  r.        .     
-000360d0: 2020 2069 6620 7073 665f 7479 7065 203d     if psf_type =
-000360e0: 3d20 274a 5753 542f 4d49 5249 273a 0a20  = 'JWST/MIRI':. 
-000360f0: 2020 2020 2020 2020 2020 2023 2020 4952             #  IR
-00036100: 2064 6574 6563 746f 720a 2020 2020 2020   detector.      
-00036110: 2020 2020 2020 4e44 4554 203d 2069 6e74        NDET = int
-00036120: 286e 702e 7371 7274 2865 7073 662e 7368  (np.sqrt(epsf.sh
-00036130: 6170 655b 325d 2929 0a20 2020 2020 2020  ape[2])).       
-00036140: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00036150: 2020 7278 203d 2031 2b28 6e70 2e63 6c69    rx = 1+(np.cli
-00036160: 7028 782c 2031 2c20 3130 3233 292d 3029  p(x, 1, 1023)-0)
-00036170: 2f35 3132 2e0a 2020 2020 2020 2020 2020  /512..          
-00036180: 2020 7279 203d 2031 2b28 6e70 2e63 6c69    ry = 1+(np.cli
-00036190: 7028 792c 2031 2c20 3130 3233 292d 3029  p(y, 1, 1023)-0)
-000361a0: 2f35 3132 2e0a 0a20 2020 2020 2020 2020  /512...         
-000361b0: 2020 2023 207a 6572 6f20 696e 6465 780a     # zero index.
-000361c0: 2020 2020 2020 2020 2020 2020 7278 202d              rx -
-000361d0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-000361e0: 7279 202d 3d20 310a 0a20 2020 2020 2020  ry -= 1..       
-000361f0: 2020 2020 2023 206e 7820 3d20 6e70 2e63       # nx = np.c
-00036200: 6c69 7028 696e 7428 7278 292c 2030 2c20  lip(int(rx), 0, 
-00036210: 3229 0a20 2020 2020 2020 2020 2020 2023  2).            #
-00036220: 206e 7920 3d20 6e70 2e63 6c69 7028 696e   ny = np.clip(in
-00036230: 7428 7279 292c 2030 2c20 3229 0a20 2020  t(ry), 0, 2).   
-00036240: 2020 2020 2020 2020 206e 7820 3d20 6e70           nx = np
-00036250: 2e63 6c69 7028 696e 7428 7278 292c 2030  .clip(int(rx), 0
-00036260: 2c20 4e44 4554 2d31 290a 2020 2020 2020  , NDET-1).      
-00036270: 2020 2020 2020 6e79 203d 206e 702e 636c        ny = np.cl
-00036280: 6970 2869 6e74 2872 7929 2c20 302c 204e  ip(int(ry), 0, N
-00036290: 4445 542d 3129 0a20 2020 2020 2020 2020  DET-1).         
-000362a0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-000362b0: 2320 7072 696e 7420 782c 2079 2c20 7278  # print x, y, rx
-000362c0: 2c20 7279 2c20 6e78 2c20 6e79 0a0a 2020  , ry, nx, ny..  
-000362d0: 2020 2020 2020 2020 2020 6678 203d 2072            fx = r
-000362e0: 782d 6e78 0a20 2020 2020 2020 2020 2020  x-nx.           
-000362f0: 2066 7920 3d20 7279 2d6e 790a 0a20 2020   fy = ry-ny..   
-00036300: 2020 2020 2020 2020 2023 2070 7366 5f78           # psf_x
-00036310: 7920 3d20 2831 2d66 7829 2a28 312d 6679  y = (1-fx)*(1-fy
-00036320: 292a 6570 7366 5b3a 2c20 3a2c 206e 782b  )*epsf[:, :, nx+
-00036330: 6e79 2a33 5d0a 2020 2020 2020 2020 2020  ny*3].          
-00036340: 2020 2320 7073 665f 7879 202b 3d20 6678    # psf_xy += fx
-00036350: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
-00036360: 3a2c 2028 6e78 2b31 292b 6e79 2a33 5d0a  :, (nx+1)+ny*3].
-00036370: 2020 2020 2020 2020 2020 2020 2320 7073              # ps
-00036380: 665f 7879 202b 3d20 2831 2d66 7829 2a66  f_xy += (1-fx)*f
-00036390: 792a 6570 7366 5b3a 2c20 3a2c 206e 782b  y*epsf[:, :, nx+
-000363a0: 286e 792b 3129 2a33 5d0a 2020 2020 2020  (ny+1)*3].      
-000363b0: 2020 2020 2020 2320 7073 665f 7879 202b        # psf_xy +
-000363c0: 3d20 6678 2a66 792a 6570 7366 5b3a 2c20  = fx*fy*epsf[:, 
-000363d0: 3a2c 2028 6e78 2b31 292b 286e 792b 3129  :, (nx+1)+(ny+1)
-000363e0: 2a33 5d0a 0a20 2020 2020 2020 2020 2020  *3]..           
-000363f0: 2069 6620 4e44 4554 203d 3d20 313a 0a20   if NDET == 1:. 
-00036400: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00036410: 7366 5f78 7920 3d20 6570 7366 5b3a 2c3a  sf_xy = epsf[:,:
-00036420: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
-00036430: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00036440: 2020 2020 2020 7073 665f 7879 203d 2028        psf_xy = (
-00036450: 312d 6678 292a 2831 2d66 7929 2a65 7073  1-fx)*(1-fy)*eps
-00036460: 665b 3a2c 203a 2c20 6e78 2b6e 792a 4e44  f[:, :, nx+ny*ND
-00036470: 4554 5d0a 2020 2020 2020 2020 2020 2020  ET].            
-00036480: 2020 2020 7073 665f 7879 202b 3d20 6678      psf_xy += fx
-00036490: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
-000364a0: 3a2c 2028 6e78 2b31 292b 6e79 2a4e 4445  :, (nx+1)+ny*NDE
-000364b0: 545d 0a20 2020 2020 2020 2020 2020 2020  T].             
-000364c0: 2020 2070 7366 5f78 7920 2b3d 2028 312d     psf_xy += (1-
-000364d0: 6678 292a 6679 2a65 7073 665b 3a2c 203a  fx)*fy*epsf[:, :
-000364e0: 2c20 6e78 2b28 6e79 2b31 292a 4e44 4554  , nx+(ny+1)*NDET
-000364f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00036500: 2020 7073 665f 7879 202b 3d20 6678 2a66    psf_xy += fx*f
-00036510: 792a 6570 7366 5b3a 2c20 3a2c 2028 6e78  y*epsf[:, :, (nx
-00036520: 2b31 292b 286e 792b 3129 2a4e 4445 545d  +1)+(ny+1)*NDET]
-00036530: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00036540: 2020 2020 2020 2020 2020 2320 7073 665f            # psf_
-00036550: 7879 203d 206e 702e 726f 7439 3028 7073  xy = np.rot90(ps
-00036560: 665f 7879 2e54 2c20 3229 0a20 2020 2020  f_xy.T, 2).     
-00036570: 2020 2020 2020 2070 7366 5f78 7920 3d20         psf_xy = 
-00036580: 7073 665f 7879 2e54 0a20 2020 2020 2020  psf_xy.T.       
-00036590: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-000365a0: 2020 7365 6c66 2e65 7661 6c5f 6669 6c74    self.eval_filt
-000365b0: 6572 203d 2066 696c 7465 720a 2020 2020  er = filter.    
-000365c0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-000365d0: 7073 665f 7479 7065 203d 3d20 274a 5753  psf_type == 'JWS
-000365e0: 542f 324b 273a 0a20 2020 2020 2020 2020  T/2K':.         
-000365f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00036600: 4e44 4554 203d 2069 6e74 286e 702e 7371  NDET = int(np.sq
-00036610: 7274 2865 7073 662e 7368 6170 655b 325d  rt(epsf.shape[2]
-00036620: 2929 0a20 2020 2020 2020 2020 2020 200a  )).            .
-00036630: 2020 2020 2020 2020 2020 2020 2320 2049              #  I
-00036640: 5220 6465 7465 6374 6f72 0a20 2020 2020  R detector.     
-00036650: 2020 2020 2020 2072 7820 3d20 312b 286e         rx = 1+(n
-00036660: 702e 636c 6970 2878 2c20 312c 2032 3034  p.clip(x, 1, 204
-00036670: 3729 2d30 292f 3130 3234 2e0a 2020 2020  7)-0)/1024..    
-00036680: 2020 2020 2020 2020 7279 203d 2031 2b28          ry = 1+(
-00036690: 6e70 2e63 6c69 7028 792c 2031 2c20 3230  np.clip(y, 1, 20
-000366a0: 3437 292d 3029 2f31 3032 342e 0a0a 2020  47)-0)/1024...  
-000366b0: 2020 2020 2020 2020 2020 2320 7a65 726f            # zero
-000366c0: 2069 6e64 6578 0a20 2020 2020 2020 2020   index.         
-000366d0: 2020 2072 7820 2d3d 2031 0a20 2020 2020     rx -= 1.     
-000366e0: 2020 2020 2020 2072 7920 2d3d 2031 0a0a         ry -= 1..
-000366f0: 2020 2020 2020 2020 2020 2020 6e78 203d              nx =
-00036700: 206e 702e 636c 6970 2869 6e74 2872 7829   np.clip(int(rx)
-00036710: 2c20 302c 204e 4445 542d 3129 0a20 2020  , 0, NDET-1).   
-00036720: 2020 2020 2020 2020 206e 7920 3d20 6e70           ny = np
-00036730: 2e63 6c69 7028 696e 7428 7279 292c 2030  .clip(int(ry), 0
-00036740: 2c20 4e44 4554 2d31 290a 0a20 2020 2020  , NDET-1)..     
-00036750: 2020 2020 2020 2023 2070 7269 6e74 2078         # print x
-00036760: 2c20 792c 2072 782c 2072 792c 206e 782c  , y, rx, ry, nx,
-00036770: 206e 790a 0a20 2020 2020 2020 2020 2020   ny..           
-00036780: 2066 7820 3d20 7278 2d6e 780a 2020 2020   fx = rx-nx.    
-00036790: 2020 2020 2020 2020 6679 203d 2072 792d          fy = ry-
-000367a0: 6e79 0a20 2020 2020 2020 2020 2020 200a  ny.            .
-000367b0: 2020 2020 2020 2020 2020 2020 6966 204e              if N
-000367c0: 4445 5420 3d3d 2031 3a0a 2020 2020 2020  DET == 1:.      
-000367d0: 2020 2020 2020 2020 2020 7073 665f 7879            psf_xy
-000367e0: 203d 2065 7073 665b 3a2c 3a2c 305d 0a20   = epsf[:,:,0]. 
-000367f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00036800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036810: 2070 7366 5f78 7920 3d20 2831 2d66 7829   psf_xy = (1-fx)
-00036820: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
-00036830: 3a2c 206e 782b 6e79 2a4e 4445 545d 0a20  :, nx+ny*NDET]. 
-00036840: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00036850: 7366 5f78 7920 2b3d 2066 782a 2831 2d66  sf_xy += fx*(1-f
-00036860: 7929 2a65 7073 665b 3a2c 203a 2c20 286e  y)*epsf[:, :, (n
-00036870: 782b 3129 2b6e 792a 4e44 4554 5d0a 2020  x+1)+ny*NDET].  
-00036880: 2020 2020 2020 2020 2020 2020 2020 7073                ps
-00036890: 665f 7879 202b 3d20 2831 2d66 7829 2a66  f_xy += (1-fx)*f
-000368a0: 792a 6570 7366 5b3a 2c20 3a2c 206e 782b  y*epsf[:, :, nx+
-000368b0: 286e 792b 3129 2a4e 4445 545d 0a20 2020  (ny+1)*NDET].   
-000368c0: 2020 2020 2020 2020 2020 2020 2070 7366               psf
-000368d0: 5f78 7920 2b3d 2066 782a 6679 2a65 7073  _xy += fx*fy*eps
-000368e0: 665b 3a2c 203a 2c20 286e 782b 3129 2b28  f[:, :, (nx+1)+(
-000368f0: 6e79 2b31 292a 4e44 4554 5d0a 2020 2020  ny+1)*NDET].    
-00036900: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00036910: 2020 2020 2070 7366 5f78 7920 3d20 7073       psf_xy = ps
-00036920: 665f 7879 2e54 0a20 2020 2020 2020 2020  f_xy.T.         
-00036930: 2020 2023 2070 7366 5f78 7920 3d20 6e70     # psf_xy = np
-00036940: 2e72 6f74 3930 2870 7366 5f78 792e 542c  .rot90(psf_xy.T,
-00036950: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
-00036960: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00036970: 662e 6576 616c 5f66 696c 7465 7220 3d20  f.eval_filter = 
-00036980: 6669 6c74 6572 0a20 2020 2020 2020 200a  filter.        .
-00036990: 2020 2020 2020 2020 656c 6966 2070 7366          elif psf
-000369a0: 5f74 7970 6520 3d3d 2027 4853 542f 4f70  _type == 'HST/Op
-000369b0: 7469 6361 6c27 3a0a 0a20 2020 2020 2020  tical':..       
-000369c0: 2020 2020 2073 6820 3d20 6570 7366 2e73       sh = epsf.s
-000369d0: 6861 7065 0a0a 2020 2020 2020 2020 2020  hape..          
-000369e0: 2020 6966 2073 685b 325d 203d 3d20 3930    if sh[2] == 90
-000369f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00036a00: 2020 2320 4143 5320 5746 430a 2020 2020    # ACS WFC.    
-00036a10: 2020 2020 2020 2020 2020 2020 6958 2c20              iX, 
-00036a20: 6959 203d 2039 2c20 3130 2020 2320 392c  iY = 9, 10  # 9,
-00036a30: 2031 300a 2020 2020 2020 2020 2020 2020   10.            
-00036a40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00036a50: 2020 2020 2020 2320 5556 4953 0a20 2020        # UVIS.   
-00036a60: 2020 2020 2020 2020 2020 2020 2069 582c               iX,
-00036a70: 2069 5920 3d20 372c 2038 0a0a 2020 2020   iY = 7, 8..    
-00036a80: 2020 2020 2020 2020 7278 203d 2031 2b28          rx = 1+(
-00036a90: 6e70 2e63 6c69 7028 782c 2031 2c20 3430  np.clip(x, 1, 40
-00036aa0: 3935 292d 3029 2f28 3430 3936 2f28 6958  95)-0)/(4096/(iX
-00036ab0: 2d31 2929 0a20 2020 2020 2020 2020 2020  -1)).           
-00036ac0: 2072 7920 3d20 312b 286e 702e 636c 6970   ry = 1+(np.clip
-00036ad0: 2879 2c20 312c 2034 3039 3529 2d30 292f  (y, 1, 4095)-0)/
-00036ae0: 2834 3039 362f 2869 592d 3129 290a 0a20  (4096/(iY-1)).. 
-00036af0: 2020 2020 2020 2020 2020 2023 207a 6572             # zer
-00036b00: 6f20 696e 6465 780a 2020 2020 2020 2020  o index.        
-00036b10: 2020 2020 7278 202d 3d20 310a 2020 2020      rx -= 1.    
-00036b20: 2020 2020 2020 2020 7279 202d 3d20 310a          ry -= 1.
-00036b30: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
-00036b40: 3d20 6e70 2e63 6c69 7028 6e70 2e63 6173  = np.clip(np.cas
-00036b50: 745b 696e 745d 2872 7829 2c20 302c 2069  t[int](rx), 0, i
-00036b60: 582d 3129 0a20 2020 2020 2020 2020 2020  X-1).           
-00036b70: 206e 7920 3d20 6e70 2e63 6c69 7028 6e70   ny = np.clip(np
-00036b80: 2e63 6173 745b 696e 745d 2872 7929 2c20  .cast[int](ry), 
-00036b90: 302c 2069 592d 3129 0a0a 2020 2020 2020  0, iY-1)..      
-00036ba0: 2020 2020 2020 2320 7072 696e 7420 782c        # print x,
-00036bb0: 2079 2c20 7278 2c20 7279 2c20 6e78 2c20   y, rx, ry, nx, 
-00036bc0: 6e79 0a0a 2020 2020 2020 2020 2020 2020  ny..            
-00036bd0: 6678 203d 2072 782d 6e78 0a20 2020 2020  fx = rx-nx.     
-00036be0: 2020 2020 2020 2066 7920 3d20 7279 2d6e         fy = ry-n
-00036bf0: 790a 0a20 2020 2020 2020 2020 2020 2070  y..            p
-00036c00: 7366 5f78 7920 3d20 2831 2d66 7829 2a28  sf_xy = (1-fx)*(
-00036c10: 312d 6679 292a 6570 7366 5b3a 2c20 3a2c  1-fy)*epsf[:, :,
-00036c20: 206e 782b 6e79 2a69 585d 0a20 2020 2020   nx+ny*iX].     
-00036c30: 2020 2020 2020 2070 7366 5f78 7920 2b3d         psf_xy +=
-00036c40: 2066 782a 2831 2d66 7929 2a65 7073 665b   fx*(1-fy)*epsf[
-00036c50: 3a2c 203a 2c20 286e 782b 3129 2b6e 792a  :, :, (nx+1)+ny*
-00036c60: 6958 5d0a 2020 2020 2020 2020 2020 2020  iX].            
-00036c70: 7073 665f 7879 202b 3d20 2831 2d66 7829  psf_xy += (1-fx)
-00036c80: 2a66 792a 6570 7366 5b3a 2c20 3a2c 206e  *fy*epsf[:, :, n
-00036c90: 782b 286e 792b 3129 2a69 585d 0a20 2020  x+(ny+1)*iX].   
-00036ca0: 2020 2020 2020 2020 2070 7366 5f78 7920           psf_xy 
-00036cb0: 2b3d 2066 782a 6679 2a65 7073 665b 3a2c  += fx*fy*epsf[:,
-00036cc0: 203a 2c20 286e 782b 3129 2b28 6e79 2b31   :, (nx+1)+(ny+1
-00036cd0: 292a 6958 5d0a 0a20 2020 2020 2020 2020  )*iX]..         
-00036ce0: 2020 2073 656c 662e 6576 616c 5f66 696c     self.eval_fil
-00036cf0: 7465 7220 3d20 6669 6c74 6572 0a20 2020  ter = filter.   
-00036d00: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-00036d10: 2072 6f74 3930 2021 3d20 303a 0a20 2020   rot90 != 0:.   
-00036d20: 2020 2020 2020 2020 2073 656c 662e 7073           self.ps
-00036d30: 665f 7879 5f72 6f74 3930 203d 2072 6f74  f_xy_rot90 = rot
-00036d40: 3930 0a20 2020 2020 2020 2020 2020 2070  90.            p
-00036d50: 7366 5f78 7920 3d20 6e70 2e72 6f74 3930  sf_xy = np.rot90
-00036d60: 2870 7366 5f78 792c 2072 6f74 3930 290a  (psf_xy, rot90).
-00036d70: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00036d80: 2020 2020 2072 6574 7572 6e20 7073 665f       return psf_
-00036d90: 7879 0a0a 2020 2020 6465 6620 6576 616c  xy..    def eval
-00036da0: 5f65 5053 4628 7365 6c66 2c20 7073 665f  _ePSF(self, psf_
-00036db0: 7879 2c20 6478 2c20 6479 2c20 726f 7439  xy, dx, dy, rot9
-00036dc0: 303d 302c 2065 7874 656e 6465 645f 6461  0=0, extended_da
-00036dd0: 7461 3d4e 6f6e 6529 3a0a 2020 2020 2020  ta=None):.      
-00036de0: 2020 2222 2245 7661 6c75 6174 6520 5053    """Evaluate PS
-00036df0: 4620 6174 2064 782c 6479 2063 6f6f 7264  F at dx,dy coord
-00036e00: 696e 6174 6573 0a0a 2020 2020 2020 2020  inates..        
-00036e10: 5442 440a 2020 2020 2020 2020 2222 220a  TBD.        """.
-00036e20: 2020 2020 2020 2020 2320 536f 206d 7563          # So muc
-00036e30: 6820 6661 7374 6572 2074 6861 6e20 7363  h faster than sc
-00036e40: 6970 792e 696e 7465 7270 6f6c 6174 652e  ipy.interpolate.
-00036e50: 6772 6964 6461 7461 210a 2020 2020 2020  griddata!.      
-00036e60: 2020 6672 6f6d 2073 6369 7079 2e6e 6469    from scipy.ndi
-00036e70: 6d61 6765 2069 6d70 6f72 7420 6d61 705f  mage import map_
-00036e80: 636f 6f72 6469 6e61 7465 730a 0a20 2020  coordinates..   
-00036e90: 2020 2020 2023 2065 5053 4620 6f6e 6c79       # ePSF only
-00036ea0: 2064 6566 696e 6564 2074 6f20 3132 2e35   defined to 12.5
-00036eb0: 2070 6978 656c 730a 2020 2020 2020 2020   pixels.        
-00036ec0: 6966 2073 656c 662e 6576 616c 5f70 7366  if self.eval_psf
-00036ed0: 5f74 7970 6520 696e 205b 2757 4643 332f  _type in ['WFC3/
-00036ee0: 4952 272c 2748 5354 2f4f 7074 6963 616c  IR','HST/Optical
-00036ef0: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
-00036f00: 6f6b 203d 2028 6e70 2e61 6273 2864 7829  ok = (np.abs(dx)
-00036f10: 203c 3d20 3132 2e35 2920 2620 286e 702e   <= 12.5) & (np.
-00036f20: 6162 7328 6479 2920 3c3d 2031 322e 3529  abs(dy) <= 12.5)
-00036f30: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
-00036f40: 7264 7320 3d20 6e70 2e61 7272 6179 285b  rds = np.array([
-00036f50: 3530 2b34 2a64 785b 6f6b 5d2c 2035 302b  50+4*dx[ok], 50+
-00036f60: 342a 6479 5b6f 6b5d 5d29 0a20 2020 2020  4*dy[ok]]).     
-00036f70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00036f80: 2020 2020 2023 204a 5753 5420 6172 6520       # JWST are 
-00036f90: 2b2f 2d20 3332 2070 6978 656c 730a 2020  +/- 32 pixels.  
-00036fa0: 2020 2020 2020 2020 2020 7368 203d 2070            sh = p
-00036fb0: 7366 5f78 792e 7368 6170 650a 2020 2020  sf_xy.shape.    
-00036fc0: 2020 2020 2020 2020 5f73 697a 6520 3d20          _size = 
-00036fd0: 2873 685b 305d 2d31 292f 2f34 0a20 2020  (sh[0]-1)//4.   
-00036fe0: 2020 2020 2020 2020 205f 7830 203d 205f           _x0 = _
-00036ff0: 7369 7a65 2a32 0a20 2020 2020 2020 2020  size*2.         
-00037000: 2020 205f 6365 6e20 3d20 285f 7830 2d31     _cen = (_x0-1
-00037010: 292f 2f32 0a20 2020 2020 2020 2020 2020  )//2.           
-00037020: 206f 6b20 3d20 286e 702e 6162 7328 6478   ok = (np.abs(dx
-00037030: 2920 3c3d 205f 6365 6e29 2026 2028 6e70  ) <= _cen) & (np
-00037040: 2e61 6273 2864 7929 203c 3d20 5f63 656e  .abs(dy) <= _cen
-00037050: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
-00037060: 6f72 6473 203d 206e 702e 6172 7261 7928  ords = np.array(
-00037070: 5b5f 7830 2b34 2a64 785b 6f6b 5d2c 205f  [_x0+4*dx[ok], _
-00037080: 7830 2b34 2a64 795b 6f6b 5d5d 290a 0a20  x0+4*dy[ok]]).. 
-00037090: 2020 2020 2020 2023 2044 6f20 7468 6520         # Do the 
-000370a0: 696e 7465 7270 6f6c 6174 696f 6e0a 2020  interpolation.  
-000370b0: 2020 2020 2020 696e 7465 7270 5f6d 6170        interp_map
-000370c0: 203d 206d 6170 5f63 6f6f 7264 696e 6174   = map_coordinat
-000370d0: 6573 2870 7366 5f78 792c 2063 6f6f 7264  es(psf_xy, coord
-000370e0: 732c 206f 7264 6572 3d33 290a 0a20 2020  s, order=3)..   
-000370f0: 2020 2020 2023 2046 696c 6c20 6f75 7470       # Fill outp
-00037100: 7574 2064 6174 610a 2020 2020 2020 2020  ut data.        
-00037110: 6f75 7420 3d20 6e70 2e7a 6572 6f73 5f6c  out = np.zeros_l
-00037120: 696b 6528 6478 2c20 6474 7970 653d 6e70  ike(dx, dtype=np
-00037130: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
-00037140: 2020 6f75 745b 6f6b 5d20 3d20 696e 7465    out[ok] = inte
-00037150: 7270 5f6d 6170 0a0a 2020 2020 2020 2020  rp_map..        
-00037160: 2320 4578 7465 6e64 6564 2050 5346 0a20  # Extended PSF. 
-00037170: 2020 2020 2020 2069 6620 6578 7465 6e64         if extend
-00037180: 6564 5f64 6174 6120 6973 206e 6f74 204e  ed_data is not N
-00037190: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000371a0: 206f 6b20 3d20 286e 702e 6162 7328 6478   ok = (np.abs(dx
-000371b0: 2920 3c20 7365 6c66 2e65 7874 656e 6465  ) < self.extende
-000371c0: 645f 4e29 200a 2020 2020 2020 2020 2020  d_N) .          
-000371d0: 2020 6f6b 2026 3d20 286e 702e 6162 7328    ok &= (np.abs(
-000371e0: 6479 2920 3c20 7365 6c66 2e65 7874 656e  dy) < self.exten
-000371f0: 6465 645f 4e29 0a20 2020 2020 2020 2020  ded_N).         
-00037200: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00037210: 7830 203d 2073 656c 662e 6578 7465 6e64  x0 = self.extend
-00037220: 6564 5f4e 0a20 2020 2020 2020 2020 2020  ed_N.           
-00037230: 2063 6f6f 7264 7320 3d20 6e70 2e61 7272   coords = np.arr
-00037240: 6179 285b 7830 2b64 795b 6f6b 5d2b 302c  ay([x0+dy[ok]+0,
-00037250: 2078 302b 6478 5b6f 6b5d 5d29 0a20 2020   x0+dx[ok]]).   
-00037260: 2020 2020 2020 2020 2069 6e74 6572 705f           interp_
-00037270: 6d61 7020 3d20 6d61 705f 636f 6f72 6469  map = map_coordi
-00037280: 6e61 7465 7328 6578 7465 6e64 6564 5f64  nates(extended_d
-00037290: 6174 612c 2063 6f6f 7264 732c 206f 7264  ata, coords, ord
-000372a0: 6572 3d30 290a 2020 2020 2020 2020 2020  er=0).          
-000372b0: 2020 6f75 745b 6f6b 5d20 2b3d 2069 6e74    out[ok] += int
-000372c0: 6572 705f 6d61 700a 0a20 2020 2020 2020  erp_map..       
-000372d0: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
-000372e0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-000372f0: 2020 2064 6566 206f 626a 6563 7469 7665     def objective
-00037300: 5f65 7073 665f 6365 6e74 6572 2870 6172  _epsf_center(par
-00037310: 616d 732c 2073 656c 662c 2070 7366 5f78  ams, self, psf_x
-00037320: 792c 2073 6369 2c20 6976 6172 2c20 7870  y, sci, ivar, xp
-00037330: 2c20 7970 2c20 6578 7465 6e64 6564 5f64  , yp, extended_d
-00037340: 6174 612c 2072 6574 2c20 6473 3929 3a0a  ata, ret, ds9):.
-00037350: 2020 2020 2020 2020 2222 224f 626a 6563          """Objec
-00037360: 7469 7665 2066 756e 6374 696f 6e20 666f  tive function fo
-00037370: 7220 6669 7474 696e 6720 6550 5346 730a  r fitting ePSFs.
-00037380: 0a20 2020 2020 2020 2054 4244 0a0a 2020  .        TBD..  
-00037390: 2020 2020 2020 7061 7261 6d73 203d 205b        params = [
-000373a0: 6e6f 726d 616c 697a 6174 696f 6e2c 2078  normalization, x
-000373b0: 632c 2079 632c 2062 6163 6b67 726f 756e  c, yc, backgroun
-000373c0: 645d 0a20 2020 2020 2020 2022 2222 0a20  d].        """. 
-000373d0: 2020 2020 2020 2066 726f 6d20 6e75 6d70         from nump
-000373e0: 792e 6c69 6e61 6c67 2069 6d70 6f72 7420  y.linalg import 
-000373f0: 6c73 7473 710a 0a20 2020 2020 2020 2073  lstsq..        s
-00037400: 6820 3d20 7363 692e 7368 6170 650a 2020  h = sci.shape.  
-00037410: 2020 2020 2020 7930 2c20 7830 203d 206e        y0, x0 = n
-00037420: 702e 6172 7261 7928 7368 292f 322e 2d31  p.array(sh)/2.-1
-00037430: 0a0a 2020 2020 2020 2020 6478 203d 2078  ..        dx = x
-00037440: 702d 7061 7261 6d73 5b30 5d0a 2020 2020  p-params[0].    
-00037450: 2020 2020 6479 203d 2079 702d 7061 7261      dy = yp-para
-00037460: 6d73 5b31 5d0a 0a20 2020 2020 2020 2064  ms[1]..        d
-00037470: 6478 203d 2078 7020 2023 202d 7830 0a20  dx = xp  # -x0. 
-00037480: 2020 2020 2020 2064 6479 203d 2079 7020         ddy = yp 
-00037490: 2023 202d 7930 0a0a 2020 2020 2020 2020   # -y0..        
-000374a0: 6464 7820 3d20 6464 782f 6464 782e 6d61  ddx = ddx/ddx.ma
-000374b0: 7828 290a 2020 2020 2020 2020 6464 7920  x().        ddy 
-000374c0: 3d20 6464 792f 6464 792e 6d61 7828 290a  = ddy/ddy.max().
-000374d0: 0a20 2020 2020 2020 2023 2062 6b67 203d  .        # bkg =
-000374e0: 2070 6172 616d 735b 335d 202b 2070 6172   params[3] + par
-000374f0: 616d 735b 345d 2a64 6478 202b 2070 6172  ams[4]*ddx + par
-00037500: 616d 735b 355d 2a64 6479 2023 2b20 7061  ams[5]*ddy #+ pa
-00037510: 7261 6d73 5b36 5d2a 6464 782a 6464 790a  rams[6]*ddx*ddy.
-00037520: 0a20 2020 2020 2020 2070 7366 5f6f 6666  .        psf_off
-00037530: 7365 7420 3d20 7365 6c66 2e65 7661 6c5f  set = self.eval_
-00037540: 6550 5346 2870 7366 5f78 792c 2064 782c  ePSF(psf_xy, dx,
-00037550: 2064 792c 2065 7874 656e 6465 645f 6461   dy, extended_da
-00037560: 7461 3d65 7874 656e 6465 645f 6461 7461  ta=extended_data
-00037570: 2920 2023 202a 7061 7261 6d73 5b30 5d0a  )  # *params[0].
-00037580: 0a20 2020 2020 2020 2041 203d 2028 6e70  .        A = (np
-00037590: 2e61 7272 6179 285b 7073 665f 6f66 6673  .array([psf_offs
-000375a0: 6574 2c20 6e70 2e6f 6e65 735f 6c69 6b65  et, np.ones_like
-000375b0: 2873 6369 292c 2064 6478 2c20 6464 795d  (sci), ddx, ddy]
-000375c0: 292a 6e70 2e73 7172 7428 6976 6172 2929  )*np.sqrt(ivar))
-000375d0: 2e72 6573 6861 7065 2828 342c 202d 3129  .reshape((4, -1)
-000375e0: 290a 2020 2020 2020 2020 7363 6966 203d  ).        scif =
-000375f0: 2028 7363 692a 6e70 2e73 7172 7428 6976   (sci*np.sqrt(iv
-00037600: 6172 2929 2e66 6c61 7474 656e 2829 0a20  ar)).flatten(). 
-00037610: 2020 2020 2020 206d 6173 6b20 3d20 2873         mask = (s
-00037620: 6369 6620 213d 2030 290a 2020 2020 2020  cif != 0).      
-00037630: 2020 636f 6566 6673 2c20 5f72 6573 6964    coeffs, _resid
-00037640: 2c20 5f72 616e 6b2c 205f 7320 3d20 6c73  , _rank, _s = ls
-00037650: 7473 7128 415b 3a2c 206d 6173 6b5d 2e54  tsq(A[:, mask].T
-00037660: 2c20 7363 6966 5b6d 6173 6b5d 2c20 0a20  , scif[mask], . 
-00037670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037690: 2020 2020 2020 2020 2072 636f 6e64 3d4c           rcond=L
-000376a0: 5354 5351 5f52 434f 4e44 290a 2020 2020  STSQ_RCOND).    
-000376b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376d0: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
-000376e0: 6573 6964 203d 2028 7363 6966 202d 206e  esid = (scif - n
-000376f0: 702e 646f 7428 636f 6566 6673 2c20 4129  p.dot(coeffs, A)
-00037700: 290a 0a20 2020 2020 2020 2069 6620 6473  )..        if ds
-00037710: 393a 0a20 2020 2020 2020 2020 2020 2041  9:.            A
-00037720: 7820 3d20 286e 702e 6172 7261 7928 5b70  x = (np.array([p
-00037730: 7366 5f6f 6666 7365 742c 206e 702e 6f6e  sf_offset, np.on
-00037740: 6573 5f6c 696b 6528 7363 6929 2c20 6464  es_like(sci), dd
-00037750: 782c 2064 6479 5d29 292e 7265 7368 6170  x, ddy])).reshap
-00037760: 6528 2834 2c20 2d31 2929 0a20 2020 2020  e((4, -1)).     
-00037770: 2020 2020 2020 2070 7366 5f6d 6f64 656c         psf_model
-00037780: 203d 206e 702e 646f 7428 636f 6566 6673   = np.dot(coeffs
-00037790: 5b3a 315d 2c20 4178 5b3a 312c 203a 5d29  [:1], Ax[:1, :])
-000377a0: 2e72 6573 6861 7065 2873 6369 2e73 6861  .reshape(sci.sha
-000377b0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-000377c0: 626b 6720 3d20 6e70 2e64 6f74 2863 6f65  bkg = np.dot(coe
-000377d0: 6666 735b 313a 5d2c 2041 785b 313a 2c20  ffs[1:], Ax[1:, 
-000377e0: 3a5d 292e 7265 7368 6170 6528 7363 692e  :]).reshape(sci.
-000377f0: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
-00037800: 2020 2064 7339 2e76 6965 7728 2873 6369     ds9.view((sci
-00037810: 2d70 7366 5f6d 6f64 656c 2d62 6b67 292a  -psf_model-bkg)*
-00037820: 6d61 736b 2e72 6573 6861 7065 2873 6369  mask.reshape(sci
-00037830: 2e73 6861 7065 2929 0a0a 2020 2020 2020  .shape))..      
-00037840: 2020 6966 2072 6574 203d 3d20 2772 6573    if ret == 'res
-00037850: 6964 273a 0a20 2020 2020 2020 2020 2020  id':.           
-00037860: 2072 6574 7572 6e20 7265 7369 640a 2020   return resid.  
-00037870: 2020 2020 2020 656c 6966 2072 6574 203d        elif ret =
-00037880: 3d20 276c 6d27 3a0a 2020 2020 2020 2020  = 'lm':.        
-00037890: 2020 2020 2320 6d61 736b 6564 2072 6573      # masked res
-000378a0: 6964 7561 6c73 2066 6f72 204c 4d20 6f70  iduals for LM op
-000378b0: 7469 6d69 7a61 7469 6f6e 0a20 2020 2020  timization.     
-000378c0: 2020 2020 2020 2069 6620 4661 6c73 653a         if False:
-000378d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000378e0: 2070 7269 6e74 2870 6172 616d 732c 2028   print(params, (
-000378f0: 7265 7369 642a 2a32 292e 7375 6d28 292c  resid**2).sum(),
-00037900: 2063 6f65 6666 735b 305d 290a 0a20 2020   coeffs[0])..   
-00037910: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00037920: 7265 7369 645b 7265 7369 6420 213d 2030  resid[resid != 0
-00037930: 5d0a 2020 2020 2020 2020 656c 6966 2072  ].        elif r
-00037940: 6574 203d 3d20 276d 6f64 656c 273a 0a20  et == 'model':. 
-00037950: 2020 2020 2020 2020 2020 2041 7820 3d20             Ax = 
-00037960: 286e 702e 6172 7261 7928 5b70 7366 5f6f  (np.array([psf_o
-00037970: 6666 7365 742c 206e 702e 6f6e 6573 5f6c  ffset, np.ones_l
-00037980: 696b 6528 7363 6929 2c20 6464 782c 2064  ike(sci), ddx, d
-00037990: 6479 5d29 292e 7265 7368 6170 6528 2834  dy])).reshape((4
-000379a0: 2c20 2d31 2929 0a20 2020 2020 2020 2020  , -1)).         
-000379b0: 2020 2070 7366 5f6d 6f64 656c 203d 206e     psf_model = n
-000379c0: 702e 646f 7428 636f 6566 6673 5b3a 315d  p.dot(coeffs[:1]
-000379d0: 2c20 4178 5b3a 312c 203a 5d29 2e72 6573  , Ax[:1, :]).res
-000379e0: 6861 7065 2873 6369 2e73 6861 7065 290a  hape(sci.shape).
-000379f0: 2020 2020 2020 2020 2020 2020 626b 6720              bkg 
-00037a00: 3d20 6e70 2e64 6f74 2863 6f65 6666 735b  = np.dot(coeffs[
-00037a10: 313a 5d2c 2041 785b 313a 2c20 3a5d 292e  1:], Ax[1:, :]).
-00037a20: 7265 7368 6170 6528 7363 692e 7368 6170  reshape(sci.shap
-00037a30: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
-00037a40: 6574 7572 6e20 7073 665f 6d6f 6465 6c2c  eturn psf_model,
-00037a50: 2062 6b67 2c20 4178 2c20 636f 6566 6673   bkg, Ax, coeffs
-00037a60: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00037a70: 2020 2020 2020 2020 2020 2063 6869 3220             chi2 
-00037a80: 3d20 2872 6573 6964 2a2a 3229 2e73 756d  = (resid**2).sum
-00037a90: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
-00037aa0: 7072 696e 7428 7061 7261 6d73 2c20 6368  print(params, ch
-00037ab0: 6932 2c20 636f 6566 6673 5b30 5d29 0a20  i2, coeffs[0]). 
-00037ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00037ad0: 6e20 6368 6932 0a0a 2020 2020 4073 7461  n chi2..    @sta
-00037ae0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00037af0: 6620 6f62 6a65 6374 6976 655f 6570 7366  f objective_epsf
-00037b00: 2870 6172 616d 732c 2073 656c 662c 2070  (params, self, p
-00037b10: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
-00037b20: 2c20 7870 2c20 7970 2c20 6578 7465 6e64  , xp, yp, extend
-00037b30: 6564 5f64 6174 612c 2072 6574 2c20 6473  ed_data, ret, ds
-00037b40: 3929 3a0a 2020 2020 2020 2020 2222 224f  9):.        """O
-00037b50: 626a 6563 7469 7665 2066 756e 6374 696f  bjective functio
-00037b60: 6e20 666f 7220 6669 7474 696e 6720 6550  n for fitting eP
-00037b70: 5346 730a 0a20 2020 2020 2020 2054 4244  SFs..        TBD
-00037b80: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
-00037b90: 203d 205b 6e6f 726d 616c 697a 6174 696f   = [normalizatio
-00037ba0: 6e2c 2078 632c 2079 632c 2062 6163 6b67  n, xc, yc, backg
-00037bb0: 726f 756e 645d 0a20 2020 2020 2020 2022  round].        "
-00037bc0: 2222 0a20 2020 2020 2020 2064 7820 3d20  "".        dx = 
-00037bd0: 7870 2d70 6172 616d 735b 315d 0a20 2020  xp-params[1].   
-00037be0: 2020 2020 2064 7920 3d20 7970 2d70 6172       dy = yp-par
-00037bf0: 616d 735b 325d 0a0a 2020 2020 2020 2020  ams[2]..        
-00037c00: 6464 7820 3d20 7870 2d78 702e 6d69 6e28  ddx = xp-xp.min(
-00037c10: 290a 2020 2020 2020 2020 6464 7920 3d20  ).        ddy = 
-00037c20: 7970 2d79 702e 6d69 6e28 290a 0a20 2020  yp-yp.min()..   
-00037c30: 2020 2020 2064 6478 203d 2064 6478 2f64       ddx = ddx/d
-00037c40: 6478 2e6d 6178 2829 0a20 2020 2020 2020  dx.max().       
-00037c50: 2064 6479 203d 2064 6479 2f64 6479 2e6d   ddy = ddy/ddy.m
-00037c60: 6178 2829 0a0a 2020 2020 2020 2020 626b  ax()..        bk
-00037c70: 6720 3d20 7061 7261 6d73 5b33 5d20 2b20  g = params[3] + 
-00037c80: 7061 7261 6d73 5b34 5d2a 6464 7820 2b20  params[4]*ddx + 
-00037c90: 7061 7261 6d73 5b35 5d2a 6464 7920 2023  params[5]*ddy  #
-00037ca0: 202b 2070 6172 616d 735b 365d 2a64 6478   + params[6]*ddx
-00037cb0: 2a64 6479 0a0a 2020 2020 2020 2020 7073  *ddy..        ps
-00037cc0: 665f 6f66 6673 6574 203d 2073 656c 662e  f_offset = self.
-00037cd0: 6576 616c 5f65 5053 4628 7073 665f 7879  eval_ePSF(psf_xy
-00037ce0: 2c20 6478 2c20 6479 2c20 6578 7465 6e64  , dx, dy, extend
-00037cf0: 6564 5f64 6174 613d 6578 7465 6e64 6564  ed_data=extended
-00037d00: 5f64 6174 6129 2a70 6172 616d 735b 305d  _data)*params[0]
-00037d10: 0a0a 2020 2020 2020 2020 7265 7369 6420  ..        resid 
-00037d20: 3d20 2873 6369 2d70 7366 5f6f 6666 7365  = (sci-psf_offse
-00037d30: 742d 626b 6729 2a6e 702e 7371 7274 2869  t-bkg)*np.sqrt(i
-00037d40: 7661 7229 0a0a 2020 2020 2020 2020 6966  var)..        if
-00037d50: 2064 7339 3a0a 2020 2020 2020 2020 2020   ds9:.          
-00037d60: 2020 6473 392e 7669 6577 2873 6369 2d70    ds9.view(sci-p
-00037d70: 7366 5f6f 6666 7365 742d 626b 6729 0a0a  sf_offset-bkg)..
-00037d80: 2020 2020 2020 2020 6966 2072 6574 203d          if ret =
-00037d90: 3d20 2772 6573 6964 273a 0a20 2020 2020  = 'resid':.     
-00037da0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00037db0: 7369 640a 2020 2020 2020 2020 656c 6966  sid.        elif
-00037dc0: 2072 6574 203d 3d20 276c 6d27 3a0a 2020   ret == 'lm':.  
-00037dd0: 2020 2020 2020 2020 2020 2320 6d61 736b            # mask
-00037de0: 6564 2072 6573 6964 7561 6c73 2066 6f72  ed residuals for
-00037df0: 204c 4d20 6f70 7469 6d69 7a61 7469 6f6e   LM optimization
-00037e00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00037e10: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00037e20: 2020 2020 2020 2070 7269 6e74 2870 6172         print(par
-00037e30: 616d 732c 2028 7265 7369 642a 2a32 292e  ams, (resid**2).
-00037e40: 7375 6d28 2929 0a0a 2020 2020 2020 2020  sum())..        
-00037e50: 2020 2020 7265 7475 726e 2072 6573 6964      return resid
-00037e60: 5b72 6573 6964 2021 3d20 305d 0a20 2020  [resid != 0].   
-00037e70: 2020 2020 2065 6c69 6620 7265 7420 3d3d       elif ret ==
-00037e80: 2027 6d6f 6465 6c27 3a0a 2020 2020 2020   'model':.      
-00037e90: 2020 2020 2020 7265 7475 726e 2070 7366        return psf
-00037ea0: 5f6f 6666 7365 742c 2062 6b67 2c20 4e6f  _offset, bkg, No
-00037eb0: 6e65 2c20 4e6f 6e65 0a20 2020 2020 2020  ne, None.       
-00037ec0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00037ed0: 2020 2063 6869 3220 3d20 2872 6573 6964     chi2 = (resid
-00037ee0: 2a2a 3229 2e73 756d 2829 0a20 2020 2020  **2).sum().     
-00037ef0: 2020 2020 2020 2023 7072 696e 7428 7061         #print(pa
-00037f00: 7261 6d73 2c20 6368 6932 290a 2020 2020  rams, chi2).    
-00037f10: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00037f20: 6869 320a 0a20 2020 2064 6566 2066 6974  hi2..    def fit
-00037f30: 5f65 5053 4628 7365 6c66 2c20 7363 692c  _ePSF(self, sci,
-00037f40: 2063 656e 7465 723d 4e6f 6e65 2c20 6f72   center=None, or
-00037f50: 6967 696e 3d5b 302c 2030 5d2c 2069 7661  igin=[0, 0], iva
-00037f60: 723d 312c 204e 3d37 2c0a 2020 2020 2020  r=1, N=7,.      
-00037f70: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00037f80: 723d 2746 3134 3057 272c 2074 6f6c 3d31  r='F140W', tol=1
-00037f90: 2e65 2d34 2c20 6775 6573 733d 4e6f 6e65  .e-4, guess=None
-00037fa0: 2c20 6765 745f 6578 7465 6e64 6564 3d46  , get_extended=F
-00037fb0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00037fc0: 2020 2020 2020 206d 6574 686f 643d 276c         method='l
-00037fd0: 6d27 2c20 6473 393d 4e6f 6e65 2c20 7073  m', ds9=None, ps
-00037fe0: 665f 7061 7261 6d73 3d4e 6f6e 652c 206f  f_params=None, o
-00037ff0: 6e6c 795f 6365 6e74 6572 696e 673d 5472  nly_centering=Tr
-00038000: 7565 2c20 0a20 2020 2020 2020 2020 2020  ue, .           
-00038010: 2020 2020 2020 726f 7439 303d 3029 3a0a        rot90=0):.
-00038020: 2020 2020 2020 2020 2222 2246 6974 2065          """Fit e
-00038030: 5053 4620 746f 2069 6e70 7574 2064 6174  PSF to input dat
-00038040: 610a 2020 2020 2020 2020 5442 440a 2020  a.        TBD.  
-00038050: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00038060: 2020 6672 6f6d 2073 6369 7079 2e6f 7074    from scipy.opt
-00038070: 696d 697a 6520 696d 706f 7274 206d 696e  imize import min
-00038080: 696d 697a 652c 206c 6561 7374 5f73 7175  imize, least_squ
-00038090: 6172 6573 0a0a 2020 2020 2020 2020 7368  ares..        sh
-000380a0: 203d 2073 6369 2e73 6861 7065 0a20 2020   = sci.shape.   
-000380b0: 2020 2020 2069 6620 6365 6e74 6572 2069       if center i
-000380c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000380d0: 2020 2020 7930 2c20 7830 203d 206e 702e      y0, x0 = np.
-000380e0: 6172 7261 7928 7368 292f 322e 2d31 0a20  array(sh)/2.-1. 
-000380f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00038100: 2020 2020 2020 2020 2078 302c 2079 3020           x0, y0 
-00038110: 3d20 6365 6e74 6572 0a0a 2020 2020 2020  = center..      
-00038120: 2020 7864 203d 2078 302b 6f72 6967 696e    xd = x0+origin
-00038130: 5b31 5d0a 2020 2020 2020 2020 7964 203d  [1].        yd =
-00038140: 2079 302b 6f72 6967 696e 5b30 5d0a 0a20   y0+origin[0].. 
-00038150: 2020 2020 2020 2078 632c 2079 6320 3d20         xc, yc = 
-00038160: 696e 7428 7830 292c 2069 6e74 2879 3029  int(x0), int(y0)
-00038170: 0a0a 2020 2020 2020 2020 7073 665f 7879  ..        psf_xy
-00038180: 203d 2073 656c 662e 6765 745f 6174 5f70   = self.get_at_p
-00038190: 6f73 6974 696f 6e28 783d 7864 2c20 793d  osition(x=xd, y=
-000381a0: 7964 2c20 6669 6c74 6572 3d66 696c 7465  yd, filter=filte
-000381b0: 722c 2072 6f74 3930 3d72 6f74 3930 290a  r, rot90=rot90).
-000381c0: 0a20 2020 2020 2020 2079 702c 2078 7020  .        yp, xp 
-000381d0: 3d20 6e70 2e69 6e64 6963 6573 2873 6829  = np.indices(sh)
-000381e0: 0a0a 2020 2020 2020 2020 6966 2067 7565  ..        if gue
-000381f0: 7373 2069 7320 4e6f 6e65 3a0a 2020 2020  ss is None:.    
-00038200: 2020 2020 2020 2020 6966 206e 702e 6973          if np.is
-00038210: 7363 616c 6172 2869 7661 7229 3a0a 2020  scalar(ivar):.  
-00038220: 2020 2020 2020 2020 2020 2020 2020 6978                ix
-00038230: 203d 206e 702e 6172 676d 6178 2873 6369   = np.argmax(sci
-00038240: 2e66 6c61 7474 656e 2829 290a 2020 2020  .flatten()).    
-00038250: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00038260: 2020 2020 2020 2020 2020 2020 2020 6978                ix
-00038270: 203d 206e 702e 6172 676d 6178 2828 7363   = np.argmax((sc
-00038280: 692a 2869 7661 7220 3e20 3029 292e 666c  i*(ivar > 0)).fl
-00038290: 6174 7465 6e28 2929 0a0a 2020 2020 2020  atten())..      
-000382a0: 2020 2020 2020 7867 7565 7373 203d 2078        xguess = x
-000382b0: 702e 666c 6174 7465 6e28 295b 6978 5d0a  p.flatten()[ix].
-000382c0: 2020 2020 2020 2020 2020 2020 7967 7565              ygue
-000382d0: 7373 203d 2079 702e 666c 6174 7465 6e28  ss = yp.flatten(
-000382e0: 295b 6978 5d0a 2020 2020 2020 2020 656c  )[ix].        el
-000382f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00038300: 7867 7565 7373 2c20 7967 7565 7373 203d  xguess, yguess =
-00038310: 2067 7565 7373 0a0a 2020 2020 2020 2020   guess..        
-00038320: 6d65 645f 626b 6720 3d20 6e70 2e6d 6564  med_bkg = np.med
-00038330: 6961 6e28 7363 6929 0a0a 2020 2020 2020  ian(sci)..      
-00038340: 2020 6966 206f 6e6c 795f 6365 6e74 6572    if only_center
-00038350: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00038360: 2023 204f 6e6c 7920 6669 7420 666f 7220   # Only fit for 
-00038370: 6365 6e74 6572 696e 6720 616e 6420 636f  centering and co
-00038380: 6d70 7574 6520 6e6f 726d 616c 697a 6174  mpute normalizat
-00038390: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-000383a0: 2067 7565 7373 203d 205b 7867 7565 7373   guess = [xguess
-000383b0: 2c20 7967 7565 7373 5d0a 2020 2020 2020  , yguess].      
-000383c0: 2020 2020 2020 5f6f 626a 6675 6e20 3d20        _objfun = 
-000383d0: 7365 6c66 2e6f 626a 6563 7469 7665 5f65  self.objective_e
-000383e0: 7073 665f 6365 6e74 6572 0a20 2020 2020  psf_center.     
-000383f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00038400: 2020 2020 2023 2046 6974 2066 6f72 2063       # Fit for c
-00038410: 656e 7465 7269 6e67 2061 6e64 206e 6f72  entering and nor
-00038420: 6d61 6c69 7a61 7469 6f6e 0a20 2020 2020  malization.     
-00038430: 2020 2020 2020 2067 7565 7373 203d 205b         guess = [
-00038440: 2873 6369 2d6d 6564 5f62 6b67 295b 7963  (sci-med_bkg)[yc
-00038450: 2d4e 3a79 632b 4e2c 2078 632d 4e3a 7863  -N:yc+N, xc-N:xc
-00038460: 2b4e 5d2e 7375 6d28 292c 2078 6775 6573  +N].sum(), xgues
-00038470: 732c 2079 6775 6573 732c 206d 6564 5f62  s, yguess, med_b
-00038480: 6b67 2c20 302c 2030 5d0a 2020 2020 2020  kg, 0, 0].      
-00038490: 2020 2020 2020 5f6f 626a 6675 6e20 3d20        _objfun = 
-000384a0: 7365 6c66 2e6f 626a 6563 7469 7665 5f65  self.objective_e
-000384b0: 7073 660a 0a20 2020 2020 2020 2073 6c79  psf..        sly
-000384c0: 203d 2073 6c69 6365 2879 632d 4e2c 2079   = slice(yc-N, y
-000384d0: 632b 4e29 0a20 2020 2020 2020 2073 6c78  c+N).        slx
-000384e0: 203d 2073 6c69 6365 2878 632d 4e2c 2078   = slice(xc-N, x
-000384f0: 632b 4e29 0a20 2020 2020 2020 2073 6c79  c+N).        sly
-00038500: 203d 2073 6c69 6365 2879 6775 6573 732d   = slice(yguess-
-00038510: 4e2c 2079 6775 6573 732b 4e29 0a20 2020  N, yguess+N).   
-00038520: 2020 2020 2073 6c78 203d 2073 6c69 6365       slx = slice
-00038530: 2878 6775 6573 732d 4e2c 2078 6775 6573  (xguess-N, xgues
-00038540: 732b 4e29 0a0a 2020 2020 2020 2020 6976  s+N)..        iv
-00038550: 6172 5f6d 6173 6b20 3d20 6e70 2e7a 6572  ar_mask = np.zer
-00038560: 6f73 5f6c 696b 6528 7363 6929 0a20 2020  os_like(sci).   
-00038570: 2020 2020 2069 7661 725f 6d61 736b 5b73       ivar_mask[s
-00038580: 6c79 2c20 736c 785d 203d 2031 0a20 2020  ly, slx] = 1.   
-00038590: 2020 2020 2069 7661 725f 6d61 736b 202a       ivar_mask *
-000385a0: 3d20 6976 6172 0a0a 2020 2020 2020 2020  = ivar..        
-000385b0: 6966 2067 6574 5f65 7874 656e 6465 643a  if get_extended:
-000385c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000385d0: 6669 6c74 6572 2069 6e20 7365 6c66 2e65  filter in self.e
-000385e0: 7874 656e 6465 645f 6570 7366 3a0a 2020  xtended_epsf:.  
-000385f0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00038600: 7465 6e64 6564 5f64 6174 6120 3d20 7365  tended_data = se
-00038610: 6c66 2e65 7874 656e 6465 645f 6570 7366  lf.extended_epsf
-00038620: 5b66 696c 7465 725d 0a20 2020 2020 2020  [filter].       
-00038630: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00038640: 2020 2020 2020 2020 2020 2065 7874 656e             exten
-00038650: 6465 645f 6461 7461 203d 204e 6f6e 650a  ded_data = None.
-00038660: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00038670: 2020 2020 2020 2020 2020 6578 7465 6e64            extend
-00038680: 6564 5f64 6174 6120 3d20 4e6f 6e65 0a0a  ed_data = None..
-00038690: 2020 2020 2020 2020 2320 4765 7420 6d6f          # Get mo
-000386a0: 6465 6c0a 2020 2020 2020 2020 6966 2070  del.        if p
-000386b0: 7366 5f70 6172 616d 7320 6973 206e 6f74  sf_params is not
-000386c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000386d0: 2020 2070 7820 3d20 7073 665f 7061 7261     px = psf_para
-000386e0: 6d73 2a31 0a20 2020 2020 2020 2020 2020  ms*1.           
-000386f0: 2069 6620 6c65 6e28 7078 2920 3d3d 2032   if len(px) == 2
-00038700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038710: 2020 5f6f 626a 6675 6e20 3d20 7365 6c66    _objfun = self
-00038720: 2e6f 626a 6563 7469 7665 5f65 7073 665f  .objective_epsf_
-00038730: 6365 6e74 6572 0a20 2020 2020 2020 2020  center.         
-00038740: 2020 2020 2020 2070 785b 305d 202b 3d20         px[0] += 
-00038750: 7830 0a20 2020 2020 2020 2020 2020 2020  x0.             
-00038760: 2020 2070 785b 315d 202b 3d20 7930 0a20     px[1] += y0. 
-00038770: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00038780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038790: 205f 6f62 6a66 756e 203d 2073 656c 662e   _objfun = self.
-000387a0: 6f62 6a65 6374 6976 655f 6570 7366 0a20  objective_epsf. 
-000387b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000387c0: 785b 315d 202b 3d20 7830 0a20 2020 2020  x[1] += x0.     
-000387d0: 2020 2020 2020 2020 2020 2070 785b 325d             px[2]
-000387e0: 202b 3d20 7930 0a0a 2020 2020 2020 2020   += y0..        
-000387f0: 2020 2020 6172 6773 203d 2028 7365 6c66      args = (self
-00038800: 2c20 7073 665f 7879 2c20 7363 692c 2069  , psf_xy, sci, i
-00038810: 7661 725f 6d61 736b 2c20 7870 2c20 7970  var_mask, xp, yp
-00038820: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
-00038830: 2027 6d6f 6465 6c27 2c20 6473 3929 0a20   'model', ds9). 
-00038840: 2020 2020 2020 2020 2020 2070 7366 5f6d             psf_m
-00038850: 6f64 656c 2c20 626b 672c 2041 2c20 636f  odel, bkg, A, co
-00038860: 6566 6673 203d 205f 6f62 6a66 756e 2870  effs = _objfun(p
-00038870: 782c 202a 6172 6773 290a 2020 2020 2020  x, *args).      
-00038880: 2020 2020 2020 7265 7475 726e 2070 7366        return psf
-00038890: 5f6d 6f64 656c 2c20 626b 672c 2041 2c20  _model, bkg, A, 
-000388a0: 636f 6566 6673 0a0a 2020 2020 2020 2020  coeffs..        
-000388b0: 6966 206d 6574 686f 6420 3d3d 2027 6c6d  if method == 'lm
-000388c0: 273a 0a20 2020 2020 2020 2020 2020 2061  ':.            a
-000388d0: 7267 7320 3d20 2873 656c 662c 2070 7366  rgs = (self, psf
-000388e0: 5f78 792c 2073 6369 2c20 6976 6172 5f6d  _xy, sci, ivar_m
-000388f0: 6173 6b2c 2078 702c 2079 702c 2065 7874  ask, xp, yp, ext
-00038900: 656e 6465 645f 6461 7461 2c20 276c 6d27  ended_data, 'lm'
-00038910: 2c20 6473 3929 0a0a 2020 2020 2020 2020  , ds9)..        
-00038920: 2020 2020 785f 7363 616c 6520 3d20 276a      x_scale = 'j
-00038930: 6163 270a 2020 2020 2020 2020 2020 2020  ac'.            
-00038940: 2378 5f73 6361 6c65 203d 205b 6775 6573  #x_scale = [gues
-00038950: 735b 305d 2c20 312c 2031 2c20 3130 2c20  s[0], 1, 1, 10, 
-00038960: 3130 2c20 3130 5d0a 2020 2020 2020 2020  10, 10].        
-00038970: 2020 2020 236f 7574 203d 206c 6561 7374      #out = least
-00038980: 5f73 7175 6172 6573 285f 6f62 6a66 756e  _squares(_objfun
-00038990: 2c20 6775 6573 732c 2061 7267 733d 6172  , guess, args=ar
-000389a0: 6773 2c20 6d65 7468 6f64 3d27 7472 6627  gs, method='trf'
-000389b0: 2c20 785f 7363 616c 653d 785f 7363 616c  , x_scale=x_scal
-000389c0: 652c 206c 6f73 733d 2768 7562 6572 2729  e, loss='huber')
-000389d0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-000389e0: 203d 206c 6561 7374 5f73 7175 6172 6573   = least_squares
-000389f0: 285f 6f62 6a66 756e 2c20 6775 6573 732c  (_objfun, guess,
-00038a00: 2061 7267 733d 6172 6773 2c20 6d65 7468   args=args, meth
-00038a10: 6f64 3d27 6c6d 272c 2078 5f73 6361 6c65  od='lm', x_scale
-00038a20: 3d78 5f73 6361 6c65 2c20 6c6f 7373 3d27  =x_scale, loss='
-00038a30: 6c69 6e65 6172 2729 0a20 2020 2020 2020  linear').       
-00038a40: 2020 2020 2070 7366 5f70 6172 616d 7320       psf_params 
-00038a50: 3d20 6f75 742e 782a 310a 2020 2020 2020  = out.x*1.      
-00038a60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00038a70: 2020 2020 6172 6773 203d 2028 7365 6c66      args = (self
-00038a80: 2c20 7073 665f 7879 2c20 7363 692c 2069  , psf_xy, sci, i
-00038a90: 7661 725f 6d61 736b 2c20 7870 2c20 7970  var_mask, xp, yp
-00038aa0: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
-00038ab0: 2027 6368 6932 272c 2064 7339 290a 2020   'chi2', ds9).  
-00038ac0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00038ad0: 6d69 6e69 6d69 7a65 285f 6f62 6a66 756e  minimize(_objfun
-00038ae0: 2c20 6775 6573 732c 2061 7267 733d 6172  , guess, args=ar
-00038af0: 6773 2c20 6d65 7468 6f64 3d6d 6574 686f  gs, method=metho
-00038b00: 642c 2074 6f6c 3d74 6f6c 290a 2020 2020  d, tol=tol).    
-00038b10: 2020 2020 2020 2020 7073 665f 7061 7261          psf_para
-00038b20: 6d73 203d 206f 7574 2e78 2a31 0a0a 2020  ms = out.x*1..  
-00038b30: 2020 2020 2020 6966 206c 656e 2867 7565        if len(gue
-00038b40: 7373 2920 3d3d 2032 3a0a 2020 2020 2020  ss) == 2:.      
-00038b50: 2020 2020 2020 7073 665f 7061 7261 6d73        psf_params
-00038b60: 5b30 5d20 2d3d 2078 300a 2020 2020 2020  [0] -= x0.      
-00038b70: 2020 2020 2020 7073 665f 7061 7261 6d73        psf_params
-00038b80: 5b31 5d20 2d3d 2079 300a 2020 2020 2020  [1] -= y0.      
-00038b90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00038ba0: 2020 2020 7073 665f 7061 7261 6d73 5b31      psf_params[1
-00038bb0: 5d20 2d3d 2078 300a 2020 2020 2020 2020  ] -= x0.        
-00038bc0: 2020 2020 7073 665f 7061 7261 6d73 5b32      psf_params[2
-00038bd0: 5d20 2d3d 2079 300a 0a20 2020 2020 2020  ] -= y0..       
-00038be0: 2023 2069 6620 4661 6c73 653a 0a20 2020   # if False:.   
-00038bf0: 2020 2020 2023 200a 2020 2020 2020 2020       # .        
-00038c00: 2320 2020 2020 7073 665f 6669 7420 3d20  #     psf_fit = 
-00038c10: 6570 7366 2e67 6574 5f65 5053 4628 7073  epsf.get_ePSF(ps
-00038c20: 665f 7061 7261 6d73 2c20 6f72 6967 696e  f_params, origin
-00038c30: 3d6f 7269 6769 6e2c 0a20 2020 2020 2020  =origin,.       
-00038c40: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-00038c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038c60: 2020 6669 6c74 6572 3d66 696c 7465 722c    filter=filter,
-00038c70: 2073 6861 7065 3d73 682c 0a20 2020 2020   shape=sh,.     
-00038c80: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00038c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ca0: 2020 2020 6765 745f 6578 7465 6e64 6564      get_extended
-00038cb0: 3d67 6574 5f65 7874 656e 6465 6429 0a20  =get_extended). 
-00038cc0: 2020 2020 2020 2023 200a 2020 2020 2020         # .      
-00038cd0: 2020 2320 2020 2020 7861 7267 7320 3d20    #     xargs = 
-00038ce0: 2873 656c 662c 2070 7366 5f78 792c 2073  (self, psf_xy, s
-00038cf0: 6369 2c20 6976 6172 5f6d 6173 6b2c 2078  ci, ivar_mask, x
-00038d00: 702c 2079 702c 2065 7874 656e 6465 645f  p, yp, extended_
-00038d10: 6461 7461 2c20 276c 6d27 2c20 4e6f 6e65  data, 'lm', None
-00038d20: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00038d30: 6c6d 203d 205f 6f62 6a66 756e 286f 7574  lm = _objfun(out
-00038d40: 2e78 2c20 2a78 6172 6773 290a 2020 2020  .x, *xargs).    
-00038d50: 2020 2020 2320 2020 2020 6361 7267 7320      #     cargs 
-00038d60: 3d20 2873 656c 662c 2070 7366 5f78 792c  = (self, psf_xy,
-00038d70: 2073 6369 2c20 6976 6172 5f6d 6173 6b2c   sci, ivar_mask,
-00038d80: 2078 702c 2079 702c 2065 7874 656e 6465   xp, yp, extende
-00038d90: 645f 6461 7461 2c20 2763 6869 3227 2c20  d_data, 'chi2', 
-00038da0: 4e6f 6e65 290a 2020 2020 2020 2020 2320  None).        # 
-00038db0: 2020 2020 6368 6932 203d 205f 6f62 6a66      chi2 = _objf
-00038dc0: 756e 286f 7574 2e78 2c20 2a63 6172 6773  un(out.x, *cargs
-00038dd0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00038de0: 6e20 7073 665f 7061 7261 6d73 0a0a 2020  n psf_params..  
-00038df0: 2020 2020 2020 2320 6478 203d 2078 702d        # dx = xp-
-00038e00: 7073 665f 7061 7261 6d73 5b31 5d0a 2020  psf_params[1].  
-00038e10: 2020 2020 2020 2320 6479 203d 2079 702d        # dy = yp-
-00038e20: 7073 665f 7061 7261 6d73 5b32 5d0a 2020  psf_params[2].  
-00038e30: 2020 2020 2020 2320 6f75 7470 7574 5f70        # output_p
-00038e40: 7366 203d 2073 656c 662e 6576 616c 5f65  sf = self.eval_e
-00038e50: 5053 4628 7073 665f 7879 2c20 6478 2c20  PSF(psf_xy, dx, 
-00038e60: 6479 292a 7073 665f 7061 7261 6d73 5b30  dy)*psf_params[0
-00038e70: 5d0a 2020 2020 2020 2020 230a 2020 2020  ].        #.    
-00038e80: 2020 2020 2320 7265 7475 726e 206f 7574      # return out
-00038e90: 7075 745f 7073 662c 2070 7366 5f70 6172  put_psf, psf_par
-00038ea0: 616d 730a 0a20 2020 2064 6566 2067 6574  ams..    def get
-00038eb0: 5f65 5053 4628 7365 6c66 2c20 7073 665f  _ePSF(self, psf_
-00038ec0: 7061 7261 6d73 2c20 7363 693d 4e6f 6e65  params, sci=None
-00038ed0: 2c20 6976 6172 3d31 2c20 6f72 6967 696e  , ivar=1, origin
-00038ee0: 3d5b 302c 2030 5d2c 2073 6861 7065 3d5b  =[0, 0], shape=[
-00038ef0: 3230 2c20 3230 5d2c 2066 696c 7465 723d  20, 20], filter=
-00038f00: 2746 3134 3057 272c 2067 6574 5f65 7874  'F140W', get_ext
-00038f10: 656e 6465 643d 4661 6c73 652c 2067 6574  ended=False, get
-00038f20: 5f62 6163 6b67 726f 756e 643d 4661 6c73  _background=Fals
-00038f30: 652c 2072 6f74 3930 3d30 293a 0a20 2020  e, rot90=0):.   
-00038f40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00038f50: 2045 7661 6c75 6174 6520 616e 2045 6666   Evaluate an Eff
-00038f60: 6563 7469 7665 2050 5346 0a20 2020 2020  ective PSF.     
-00038f70: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-00038f80: 6820 3d20 7368 6170 650a 2020 2020 2020  h = shape.      
-00038f90: 2020 7930 2c20 7830 203d 206e 702e 6172    y0, x0 = np.ar
-00038fa0: 7261 7928 7368 292f 322e 2d31 0a0a 2020  ray(sh)/2.-1..  
-00038fb0: 2020 2020 2020 7864 203d 2078 302b 6f72        xd = x0+or
-00038fc0: 6967 696e 5b31 5d0a 2020 2020 2020 2020  igin[1].        
-00038fd0: 7964 203d 2079 302b 6f72 6967 696e 5b30  yd = y0+origin[0
-00038fe0: 5d0a 0a20 2020 2020 2020 2078 632c 2079  ]..        xc, y
-00038ff0: 6320 3d20 696e 7428 7830 292c 2069 6e74  c = int(x0), int
-00039000: 2879 3029 0a0a 2020 2020 2020 2020 7073  (y0)..        ps
-00039010: 665f 7879 203d 2073 656c 662e 6765 745f  f_xy = self.get_
-00039020: 6174 5f70 6f73 6974 696f 6e28 783d 7864  at_position(x=xd
-00039030: 2c20 793d 7964 2c20 6669 6c74 6572 3d66  , y=yd, filter=f
-00039040: 696c 7465 722c 2072 6f74 3930 3d72 6f74  ilter, rot90=rot
-00039050: 3930 290a 0a20 2020 2020 2020 2079 702c  90)..        yp,
-00039060: 2078 7020 3d20 6e70 2e69 6e64 6963 6573   xp = np.indices
-00039070: 2873 6829 0a0a 2020 2020 2020 2020 6966  (sh)..        if
-00039080: 206c 656e 2870 7366 5f70 6172 616d 7329   len(psf_params)
-00039090: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-000390a0: 2020 205f 6f62 6a66 756e 203d 2073 656c     _objfun = sel
-000390b0: 662e 6f62 6a65 6374 6976 655f 6570 7366  f.objective_epsf
-000390c0: 5f63 656e 7465 720a 2020 2020 2020 2020  _center.        
-000390d0: 2020 2020 6478 203d 2078 702d 7073 665f      dx = xp-psf_
-000390e0: 7061 7261 6d73 5b30 5d2d 7830 0a20 2020  params[0]-x0.   
-000390f0: 2020 2020 2020 2020 2064 7920 3d20 7970           dy = yp
-00039100: 2d70 7366 5f70 6172 616d 735b 315d 2d79  -psf_params[1]-y
-00039110: 300a 2020 2020 2020 2020 656c 7365 3a0a  0.        else:.
-00039120: 2020 2020 2020 2020 2020 2020 5f6f 626a              _obj
-00039130: 6675 6e20 3d20 7365 6c66 2e6f 626a 6563  fun = self.objec
-00039140: 7469 7665 5f65 7073 660a 2020 2020 2020  tive_epsf.      
-00039150: 2020 2020 2020 6478 203d 2078 702d 7073        dx = xp-ps
-00039160: 665f 7061 7261 6d73 5b31 5d2d 7830 0a20  f_params[1]-x0. 
-00039170: 2020 2020 2020 2020 2020 2064 7920 3d20             dy = 
-00039180: 7970 2d70 7366 5f70 6172 616d 735b 325d  yp-psf_params[2]
-00039190: 2d79 300a 0a20 2020 2020 2020 2069 6620  -y0..        if 
-000391a0: 6765 745f 6578 7465 6e64 6564 3a0a 2020  get_extended:.  
-000391b0: 2020 2020 2020 2020 2020 6966 2066 696c            if fil
-000391c0: 7465 7220 696e 2073 656c 662e 6578 7465  ter in self.exte
-000391d0: 6e64 6564 5f65 7073 663a 0a20 2020 2020  nded_epsf:.     
-000391e0: 2020 2020 2020 2020 2020 2065 7874 656e             exten
-000391f0: 6465 645f 6461 7461 203d 2073 656c 662e  ded_data = self.
-00039200: 6578 7465 6e64 6564 5f65 7073 665b 6669  extended_epsf[fi
-00039210: 6c74 6572 5d0a 2020 2020 2020 2020 2020  lter].          
-00039220: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00039230: 2020 2020 2020 2020 6578 7465 6e64 6564          extended
-00039240: 5f64 6174 6120 3d20 4e6f 6e65 0a20 2020  _data = None.   
-00039250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00039260: 2020 2020 2020 2065 7874 656e 6465 645f         extended_
-00039270: 6461 7461 203d 204e 6f6e 650a 0a20 2020  data = None..   
-00039280: 2020 2020 2069 6620 7363 6920 6973 206e       if sci is n
-00039290: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000392a0: 2020 2020 2069 7661 725f 6d61 736b 203d       ivar_mask =
-000392b0: 206e 702e 6f6e 6573 5f6c 696b 6528 7363   np.ones_like(sc
-000392c0: 6929 0a20 2020 2020 2020 2020 2020 2069  i).            i
-000392d0: 7661 725f 6d61 736b 202a 3d20 6976 6172  var_mask *= ivar
-000392e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000392f0: 2020 2020 2020 2020 2020 2073 6369 203d             sci =
-00039300: 206e 702e 6f6e 6573 2873 682c 2064 7479   np.ones(sh, dty
-00039310: 7065 3d66 6c6f 6174 290a 2020 2020 2020  pe=float).      
-00039320: 2020 2020 2020 6976 6172 5f6d 6173 6b20        ivar_mask 
-00039330: 3d20 7363 692a 310a 0a20 2020 2020 2020  = sci*1..       
-00039340: 2061 7267 7320 3d20 2873 656c 662c 2070   args = (self, p
-00039350: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
-00039360: 5f6d 6173 6b2c 2078 702d 7830 2c20 7970  _mask, xp-x0, yp
-00039370: 2d79 302c 2065 7874 656e 6465 645f 6461  -y0, extended_da
-00039380: 7461 2c20 276d 6f64 656c 272c 204e 6f6e  ta, 'model', Non
-00039390: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
-000393a0: 745f 7073 662c 2062 6b67 2c20 5f61 2c20  t_psf, bkg, _a, 
-000393b0: 5f62 203d 205f 6f62 6a66 756e 2870 7366  _b = _objfun(psf
-000393c0: 5f70 6172 616d 732c 202a 6172 6773 290a  _params, *args).
-000393d0: 0a20 2020 2020 2020 2023 6f75 7470 7574  .        #output
-000393e0: 5f70 7366 203d 2073 656c 662e 6576 616c  _psf = self.eval
-000393f0: 5f65 5053 4628 7073 665f 7879 2c20 6478  _ePSF(psf_xy, dx
-00039400: 2c20 6479 2c20 6578 7465 6e64 6564 5f64  , dy, extended_d
-00039410: 6174 613d 6578 7465 6e64 6564 5f64 6174  ata=extended_dat
-00039420: 6129 2a70 7366 5f70 6172 616d 735b 305d  a)*psf_params[0]
-00039430: 0a0a 2020 2020 2020 2020 6966 2067 6574  ..        if get
-00039440: 5f62 6163 6b67 726f 756e 643a 0a20 2020  _background:.   
-00039450: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00039460: 6f75 7470 7574 5f70 7366 2c20 626b 670a  output_psf, bkg.
-00039470: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00039480: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00039490: 206f 7574 7075 745f 7073 660a 0a0a 6465   output_psf...de
-000394a0: 6620 7265 6164 5f63 6174 616c 6f67 2866  f read_catalog(f
-000394b0: 696c 652c 2073 6578 7472 6163 746f 723d  ile, sextractor=
-000394c0: 4661 6c73 652c 2066 6f72 6d61 743d 4e6f  False, format=No
-000394d0: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-000394e0: 2057 7261 7070 6572 2061 726f 756e 6420   Wrapper around 
-000394f0: 607e 6772 697a 6c69 2e75 7469 6c73 2e47  `~grizli.utils.G
-00039500: 7461 626c 652e 6772 6561 6460 2e0a 0a20  table.gread`... 
-00039510: 2020 2041 7574 6f2d 6465 7465 6374 7320     Auto-detects 
-00039520: 666f 726d 6174 7320 2763 7376 2720 616e  formats 'csv' an
-00039530: 6420 2766 6974 7327 2061 6e64 2064 6566  d 'fits' and def
-00039540: 6175 6c74 7320 746f 0a20 2020 2027 6173  aults to.    'as
-00039550: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
-00039560: 6164 6572 272e 0a20 2020 2022 2222 0a20  ader'..    """. 
-00039570: 2020 2072 6574 7572 6e20 4754 6162 6c65     return GTable
-00039580: 2e67 7265 6164 2866 696c 652c 2073 6578  .gread(file, sex
-00039590: 7472 6163 746f 723d 7365 7874 7261 6374  tractor=sextract
-000395a0: 6f72 2c20 666f 726d 6174 3d66 6f72 6d61  or, format=forma
-000395b0: 7429 0a0a 0a63 6c61 7373 2047 5461 626c  t)...class GTabl
-000395c0: 6528 6173 7472 6f70 792e 7461 626c 652e  e(astropy.table.
-000395d0: 5461 626c 6529 3a0a 2020 2020 2222 220a  Table):.    """.
-000395e0: 2020 2020 4578 7465 6e64 2060 7e61 7374      Extend `~ast
-000395f0: 726f 7079 2e74 6162 6c65 2e54 6162 6c65  ropy.table.Table
-00039600: 6020 636c 6173 7320 7769 7468 206d 6f72  ` class with mor
-00039610: 6520 6175 746f 6d61 7469 6320 494f 2061  e automatic IO a
-00039620: 6e64 206f 7468 6572 0a20 2020 2068 656c  nd other.    hel
-00039630: 7065 7220 6d65 7468 6f64 732e 0a20 2020  per methods..   
-00039640: 2022 2222 0a20 2020 2040 636c 6173 736d   """.    @classm
-00039650: 6574 686f 640a 2020 2020 6465 6620 6772  ethod.    def gr
-00039660: 6561 6428 636c 732c 2066 696c 652c 2073  ead(cls, file, s
-00039670: 6578 7472 6163 746f 723d 4661 6c73 652c  extractor=False,
-00039680: 2066 6f72 6d61 743d 4e6f 6e65 293a 0a20   format=None):. 
-00039690: 2020 2020 2020 2022 2222 4173 7375 6d65         """Assume
-000396a0: 2060 6173 6369 692e 636f 6d6d 656e 7465   `ascii.commente
-000396b0: 645f 6865 6164 6572 6020 6279 2064 6566  d_header` by def
-000396c0: 6175 6c74 0a0a 2020 2020 2020 2020 5061  ault..        Pa
-000396d0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-000396e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000396f0: 2020 2020 7365 7874 7261 6374 6f72 203a      sextractor :
-00039700: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
-00039710: 2020 5573 6520 6066 6f72 6d61 743d 2761    Use `format='a
-00039720: 7363 6969 2e73 6578 7472 6163 746f 7227  scii.sextractor'
-00039730: 602e 0a0a 2020 2020 2020 2020 666f 726d  `...        form
-00039740: 6174 203a 204e 6f6e 6520 6f72 2073 7472  at : None or str
-00039750: 0a20 2020 2020 2020 2020 2020 204f 7665  .            Ove
-00039760: 7272 6964 6520 666f 726d 6174 2070 6173  rride format pas
-00039770: 7365 6420 746f 2060 7e61 7374 726f 7079  sed to `~astropy
-00039780: 2e74 6162 6c65 2e54 6162 6c65 2e72 6561  .table.Table.rea
-00039790: 6460 2e0a 0a20 2020 2020 2020 2052 6574  d`...        Ret
-000397a0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-000397b0: 2d2d 2d2d 0a20 2020 2020 2020 2074 6162  ----.        tab
-000397c0: 203a 2060 7e61 7374 726f 7079 2e74 6162   : `~astropy.tab
-000397d0: 6c65 2e54 6162 6c65 600a 2020 2020 2020  le.Table`.      
-000397e0: 2020 2020 2020 5461 626c 6520 6f62 6a65        Table obje
-000397f0: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
-00039800: 2020 2020 2020 2069 6d70 6f72 7420 6173         import as
-00039810: 7472 6f70 792e 756e 6974 7320 6173 2075  tropy.units as u
-00039820: 0a0a 2020 2020 2020 2020 6966 2066 6f72  ..        if for
-00039830: 6d61 7420 6973 204e 6f6e 653a 0a20 2020  mat is None:.   
-00039840: 2020 2020 2020 2020 2069 6620 7365 7874           if sext
-00039850: 7261 6374 6f72 3a0a 2020 2020 2020 2020  ractor:.        
-00039860: 2020 2020 2020 2020 666f 726d 6174 203d          format =
-00039870: 2027 6173 6369 692e 7365 7874 7261 6374   'ascii.sextract
-00039880: 6f72 270a 2020 2020 2020 2020 2020 2020  or'.            
-00039890: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-000398a0: 6669 6c65 2c20 7079 6669 7473 2e42 696e  file, pyfits.Bin
-000398b0: 5461 626c 6548 4455 293a 0a20 2020 2020  TableHDU):.     
-000398c0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000398d0: 7420 3d20 2766 6974 7327 0a20 2020 2020  t = 'fits'.     
-000398e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000398f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00039900: 6669 6c65 2e65 6e64 7377 6974 6828 272e  file.endswith('.
-00039910: 6669 7473 2729 3a0a 2020 2020 2020 2020  fits'):.        
-00039920: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00039930: 6174 203d 2027 6669 7473 270a 2020 2020  at = 'fits'.    
-00039940: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00039950: 2066 696c 652e 656e 6473 7769 7468 2827   file.endswith('
-00039960: 2e63 7376 2729 3a0a 2020 2020 2020 2020  .csv'):.        
-00039970: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00039980: 6174 203d 2027 6373 7627 0a20 2020 2020  at = 'csv'.     
-00039990: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000399a0: 6669 6c65 2e65 6e64 7377 6974 6828 272e  file.endswith('.
-000399b0: 766f 7427 293a 0a20 2020 2020 2020 2020  vot'):.         
-000399c0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000399d0: 7420 3d20 2776 6f74 6162 6c65 270a 2020  t = 'votable'.  
-000399e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000399f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00039a00: 2020 2020 2020 2020 666f 726d 6174 203d          format =
-00039a10: 2027 6173 6369 692e 636f 6d6d 656e 7465   'ascii.commente
-00039a20: 645f 6865 6164 6572 270a 0a20 2020 2020  d_header'..     
-00039a30: 2020 2023 7072 696e 7428 6669 6c65 2c20     #print(file, 
-00039a40: 666f 726d 6174 290a 2020 2020 2020 2020  format).        
-00039a50: 7461 6220 3d20 636c 732e 7265 6164 2866  tab = cls.read(f
-00039a60: 696c 652c 2066 6f72 6d61 743d 666f 726d  ile, format=form
-00039a70: 6174 290a 0a20 2020 2020 2020 2072 6574  at)..        ret
-00039a80: 7572 6e20 7461 620a 0a20 2020 2064 6566  urn tab..    def
-00039a90: 2067 7772 6974 6528 7365 6c66 2c20 6f75   gwrite(self, ou
-00039aa0: 7470 7574 2c20 666f 726d 6174 3d27 6173  tput, format='as
-00039ab0: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
-00039ac0: 6164 6572 2729 3a0a 2020 2020 2020 2020  ader'):.        
-00039ad0: 2222 2241 7373 756d 6520 6120 666f 726d  """Assume a form
-00039ae0: 6174 2066 6f72 2074 6865 206f 7574 7075  at for the outpu
-00039af0: 7420 7461 626c 650a 0a20 2020 2020 2020  t table..       
-00039b00: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00039b10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00039b20: 2020 2020 2020 206f 7574 7075 7420 3a20         output : 
-00039b30: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-00039b40: 4f75 7470 7574 2066 696c 656e 616d 650a  Output filename.
-00039b50: 0a20 2020 2020 2020 2066 6f72 6d61 7420  .        format 
-00039b60: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
-00039b70: 2020 466f 726d 6174 2073 7472 696e 6720    Format string 
-00039b80: 7061 7373 6564 2074 6f20 607e 6173 7472  passed to `~astr
-00039b90: 6f70 792e 7461 626c 652e 5461 626c 652e  opy.table.Table.
-00039ba0: 7772 6974 6560 2e0a 0a20 2020 2020 2020  write`...       
-00039bb0: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
-00039bc0: 662e 7772 6974 6528 6f75 7470 7574 2c20  f.write(output, 
-00039bd0: 666f 726d 6174 3d66 6f72 6d61 7429 0a0a  format=format)..
-00039be0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00039bf0: 640a 2020 2020 6465 6620 7061 7273 655f  d.    def parse_
-00039c00: 7261 6465 635f 636f 6c75 6d6e 7328 7365  radec_columns(se
-00039c10: 6c66 2c20 7264 5f70 6169 7273 3d4e 6f6e  lf, rd_pairs=Non
-00039c20: 6529 3a0a 2020 2020 2020 2020 2222 2250  e):.        """P
-00039c30: 6172 7365 2063 6f6c 756d 6e20 6e61 6d65  arse column name
-00039c40: 7320 666f 7220 5241 2f44 6563 2061 6e64  s for RA/Dec and
-00039c50: 2073 6574 2074 6f20 607e 6173 7472 6f70   set to `~astrop
-00039c60: 792e 756e 6974 732e 6465 6772 6565 6020  y.units.degree` 
-00039c70: 756e 6974 7320 6966 206e 6f74 2061 6c72  units if not alr
-00039c80: 6561 6479 2073 6574 0a0a 2020 2020 2020  eady set..      
-00039c90: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00039ca0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-00039cb0: 2020 2020 2020 2020 7264 5f70 6169 7273          rd_pairs
-00039cc0: 203a 2060 7e63 6f6c 6c65 6374 696f 6e73   : `~collections
-00039cd0: 2e4f 7264 6572 6564 4469 6374 6020 6f72  .OrderedDict` or
-00039ce0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00039cf0: 2020 5061 6972 7320 6f66 207b 7261 3a64    Pairs of {ra:d
-00039d00: 6563 7d20 6e61 6d65 7320 746f 2073 6561  ec} names to sea
-00039d10: 7263 6820 696e 2074 6865 2063 6f6c 756d  rch in the colum
-00039d20: 6e20 6c69 7374 2e20 4966 204e 6f6e 652c  n list. If None,
-00039d30: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00039d40: 6e20 7573 6573 2074 6865 2066 6f6c 6c6f  n uses the follo
-00039d50: 7769 6e67 2062 7920 6465 6661 756c 742e  wing by default.
-00039d60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00039d70: 2020 3e3e 3e20 7264 5f70 6169 7273 203d    >>> rd_pairs =
-00039d80: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
-00039d90: 2020 2020 2020 2020 2020 2020 2020 203e                 >
-00039da0: 3e3e 2072 645f 7061 6972 735b 2772 6127  >> rd_pairs['ra'
-00039db0: 5d20 3d20 2764 6563 270a 2020 2020 2020  ] = 'dec'.      
-00039dc0: 2020 2020 2020 2020 2020 3e3e 3e20 7264            >>> rd
-00039dd0: 5f70 6169 7273 5b27 414c 5048 415f 4a32  _pairs['ALPHA_J2
-00039de0: 3030 3027 5d20 3d20 2744 454c 5441 5f4a  000'] = 'DELTA_J
-00039df0: 3230 3030 270a 2020 2020 2020 2020 2020  2000'.          
-00039e00: 2020 2020 2020 3e3e 3e20 7264 5f70 6169        >>> rd_pai
-00039e10: 7273 5b27 585f 574f 524c 4427 5d20 3d20  rs['X_WORLD'] = 
-00039e20: 2759 5f57 4f52 4c44 270a 0a20 2020 2020  'Y_WORLD'..     
-00039e30: 2020 2020 2020 204e 423a 2073 6561 7263         NB: searc
-00039e40: 6820 6973 2070 6572 666f 726d 6564 2069  h is performed i
-00039e50: 6e20 6f72 6465 7220 6f66 2060 6072 645f  n order of ``rd_
-00039e60: 7061 6972 732e 6b65 7973 2829 6060 2061  pairs.keys()`` a
-00039e70: 6e64 2073 746f 7073 0a20 2020 2020 2020  nd stops.       
-00039e80: 2020 2020 2069 662f 7768 656e 2061 206d       if/when a m
-00039e90: 6174 6368 2069 7320 666f 756e 642e 0a0a  atch is found...
-00039ea0: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-00039eb0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-00039ec0: 2020 2020 2020 2020 7264 5f70 6169 7220          rd_pair 
-00039ed0: 3a20 5b73 7472 2c20 7374 725d 0a20 2020  : [str, str].   
-00039ee0: 2020 2020 2020 2020 2043 6f6c 756d 6e20           Column 
-00039ef0: 6e61 6d65 7320 6173 736f 6369 6174 6564  names associated
-00039f00: 2077 6974 6820 5241 2f44 6563 2e20 2052   with RA/Dec.  R
-00039f10: 6574 7572 6e73 2046 616c 7365 2069 6620  eturns False if 
-00039f20: 6e6f 2063 6f6c 756d 6e0a 2020 2020 2020  no column.      
-00039f30: 2020 2020 2020 7061 6972 7320 666f 756e        pairs foun
-00039f40: 6420 6261 7365 6420 6f6e 2060 7264 5f70  d based on `rd_p
-00039f50: 6169 7273 602e 0a0a 2020 2020 2020 2020  airs`...        
-00039f60: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
-00039f70: 2063 6f6c 6c65 6374 696f 6e73 2069 6d70   collections imp
-00039f80: 6f72 7420 4f72 6465 7265 6444 6963 740a  ort OrderedDict.
-00039f90: 2020 2020 2020 2020 696d 706f 7274 2061          import a
-00039fa0: 7374 726f 7079 2e75 6e69 7473 2061 7320  stropy.units as 
-00039fb0: 750a 0a20 2020 2020 2020 2069 6620 7264  u..        if rd
-00039fc0: 5f70 6169 7273 2069 7320 4e6f 6e65 3a0a  _pairs is None:.
-00039fd0: 2020 2020 2020 2020 2020 2020 7264 5f70              rd_p
-00039fe0: 6169 7273 203d 204f 7264 6572 6564 4469  airs = OrderedDi
-00039ff0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
-0003a000: 2072 645f 7061 6972 735b 2752 4127 5d20   rd_pairs['RA'] 
-0003a010: 3d20 2744 4543 270a 2020 2020 2020 2020  = 'DEC'.        
-0003a020: 2020 2020 7264 5f70 6169 7273 5b27 414c      rd_pairs['AL
-0003a030: 5048 415f 4a32 3030 3027 5d20 3d20 2744  PHA_J2000'] = 'D
-0003a040: 454c 5441 5f4a 3230 3030 270a 2020 2020  ELTA_J2000'.    
-0003a050: 2020 2020 2020 2020 7264 5f70 6169 7273          rd_pairs
-0003a060: 5b27 585f 574f 524c 4427 5d20 3d20 2759  ['X_WORLD'] = 'Y
-0003a070: 5f57 4f52 4c44 270a 2020 2020 2020 2020  _WORLD'.        
-0003a080: 2020 2020 7264 5f70 6169 7273 5b27 414c      rd_pairs['AL
-0003a090: 5048 415f 534b 5927 5d20 3d20 2744 454c  PHA_SKY'] = 'DEL
-0003a0a0: 5441 5f53 4b59 270a 2020 2020 2020 2020  TA_SKY'.        
-0003a0b0: 2020 2020 7264 5f70 6169 7273 5b27 5f52      rd_pairs['_R
-0003a0c0: 414a 3230 3030 275d 203d 2027 5f44 454a  AJ2000'] = '_DEJ
-0003a0d0: 3230 3030 270a 0a20 2020 2020 2020 2020  2000'..         
-0003a0e0: 2020 2066 6f72 206b 2069 6e20 6c69 7374     for k in list
-0003a0f0: 2872 645f 7061 6972 732e 6b65 7973 2829  (rd_pairs.keys()
-0003a100: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003a110: 2020 2072 645f 7061 6972 735b 6b2e 6c6f     rd_pairs[k.lo
-0003a120: 7765 7228 295d 203d 2072 645f 7061 6972  wer()] = rd_pair
-0003a130: 735b 6b5d 2e6c 6f77 6572 2829 0a0a 2020  s[k].lower()..  
-0003a140: 2020 2020 2020 7264 5f70 6169 7220 3d20        rd_pair = 
-0003a150: 4e6f 6e65 0a20 2020 2020 2020 2066 6f72  None.        for
-0003a160: 2063 2069 6e20 7264 5f70 6169 7273 3a0a   c in rd_pairs:.
-0003a170: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0003a180: 2069 6e20 7365 6c66 2e63 6f6c 6e61 6d65   in self.colname
-0003a190: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0003a1a0: 2020 2072 645f 7061 6972 203d 205b 632c     rd_pair = [c,
-0003a1b0: 2072 645f 7061 6972 735b 635d 5d0a 2020   rd_pairs[c]].  
-0003a1c0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0003a1d0: 6561 6b0a 0a20 2020 2020 2020 2069 6620  eak..        if 
-0003a1e0: 7264 5f70 6169 7220 6973 204e 6f6e 653a  rd_pair is None:
-0003a1f0: 0a20 2020 2020 2020 2020 2020 2023 7072  .            #pr
-0003a200: 696e 7428 274e 6f20 5241 2f44 6563 2e20  int('No RA/Dec. 
-0003a210: 636f 6c75 6d6e 7320 666f 756e 6420 696e  columns found in
-0003a220: 2069 6e70 7574 2074 6162 6c65 2e27 290a   input table.').
-0003a230: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003a240: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-0003a250: 2020 666f 7220 6320 696e 2072 645f 7061    for c in rd_pa
-0003a260: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-0003a270: 6966 2073 656c 665b 635d 2e75 6e69 7420  if self[c].unit 
-0003a280: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003a290: 2020 2020 2020 2020 2073 656c 665b 635d           self[c]
-0003a2a0: 2e75 6e69 7420 3d20 752e 6465 6772 6565  .unit = u.degree
-0003a2b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0003a2c0: 2072 645f 7061 6972 0a0a 2020 2020 6465   rd_pair..    de
-0003a2d0: 6620 6d61 7463 685f 746f 5f63 6174 616c  f match_to_catal
-0003a2e0: 6f67 5f73 6b79 2873 656c 662c 206f 7468  og_sky(self, oth
-0003a2f0: 6572 2c20 7365 6c66 5f72 6164 6563 3d4e  er, self_radec=N
-0003a300: 6f6e 652c 206f 7468 6572 5f72 6164 6563  one, other_radec
-0003a310: 3d4e 6f6e 652c 206e 7468 6e65 6967 6862  =None, nthneighb
-0003a320: 6f72 3d31 2c20 6765 745f 3264 5f6f 6666  or=1, get_2d_off
-0003a330: 7365 743d 4661 6c73 6529 3a0a 2020 2020  set=False):.    
-0003a340: 2020 2020 2222 2243 6f6d 7075 7465 2060      """Compute `
-0003a350: 7e61 7374 726f 7079 2e63 6f6f 7264 696e  ~astropy.coordin
-0003a360: 6174 6573 2e53 6b79 436f 6f72 6460 2070  ates.SkyCoord` p
-0003a370: 726f 6a65 6374 6564 206d 6174 6368 6573  rojected matches
-0003a380: 2062 6574 7765 656e 2074 776f 2060 4754   between two `GT
-0003a390: 6162 6c65 6020 7461 626c 6573 2e0a 0a20  able` tables... 
-0003a3a0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-0003a3b0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-0003a3c0: 2d2d 2d2d 0a20 2020 2020 2020 206f 7468  ----.        oth
-0003a3d0: 6572 203a 2060 7e61 7374 726f 7079 2e74  er : `~astropy.t
-0003a3e0: 6162 6c65 2e54 6162 6c65 602c 2060 4754  able.Table`, `GT
-0003a3f0: 6162 6c65 602c 206f 7220 606c 6973 7460  able`, or `list`
-0003a400: 2e0a 2020 2020 2020 2020 2020 2020 4f74  ..            Ot
-0003a410: 6865 7220 7461 626c 6520 746f 206d 6174  her table to mat
-0003a420: 6368 2070 6f73 6974 696f 6e73 2066 726f  ch positions fro
-0003a430: 6d2e 0a0a 2020 2020 2020 2020 7365 6c66  m...        self
-0003a440: 5f72 6164 6563 2c20 6f74 6865 725f 7261  _radec, other_ra
-0003a450: 6465 6320 3a20 4e6f 6e65 206f 7220 5b73  dec : None or [s
-0003a460: 7472 2c20 7374 725d 0a20 2020 2020 2020  tr, str].       
-0003a470: 2020 2020 2043 6f6c 756d 6e20 6e61 6d65       Column name
-0003a480: 7320 666f 7220 5241 2061 6e64 2044 6563  s for RA and Dec
-0003a490: 2e20 2049 6620 4e6f 6e65 2c20 7468 656e  .  If None, then
-0003a4a0: 2074 7279 2074 6865 2066 6f6c 6c6f 7769   try the followi
-0003a4b0: 6e67 0a20 2020 2020 2020 2020 2020 2070  ng.            p
-0003a4c0: 6169 7273 2028 696e 2074 6869 7320 6f72  airs (in this or
-0003a4d0: 6465 7229 3a0a 0a20 2020 2020 2020 2020  der):..         
-0003a4e0: 2020 2020 2020 203e 3e3e 2072 645f 7061         >>> rd_pa
-0003a4f0: 6972 7320 3d20 4f72 6465 7265 6444 6963  irs = OrderedDic
-0003a500: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0003a510: 2020 2020 3e3e 3e20 7264 5f70 6169 7273      >>> rd_pairs
-0003a520: 5b27 7261 275d 203d 2027 6465 6327 0a20  ['ra'] = 'dec'. 
-0003a530: 2020 2020 2020 2020 2020 2020 2020 203e                 >
-0003a540: 3e3e 2072 645f 7061 6972 735b 2741 4c50  >> rd_pairs['ALP
-0003a550: 4841 5f4a 3230 3030 275d 203d 2027 4445  HA_J2000'] = 'DE
-0003a560: 4c54 415f 4a32 3030 3027 0a20 2020 2020  LTA_J2000'.     
-0003a570: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
-0003a580: 645f 7061 6972 735b 2758 5f57 4f52 4c44  d_pairs['X_WORLD
-0003a590: 275d 203d 2027 595f 574f 524c 4427 0a0a  '] = 'Y_WORLD'..
-0003a5a0: 2020 2020 2020 2020 6e74 686e 6569 6768          nthneigh
-0003a5b0: 626f 7220 3a20 696e 740a 2020 2020 2020  bor : int.      
-0003a5c0: 2020 2020 2020 5365 6520 607e 6173 7472        See `~astr
-0003a5d0: 6f70 792e 636f 6f72 6469 6e61 7465 732e  opy.coordinates.
-0003a5e0: 536b 7943 6f6f 7264 2e63 6f6f 2e6d 6174  SkyCoord.coo.mat
-0003a5f0: 6368 5f74 6f5f 6361 7461 6c6f 675f 736b  ch_to_catalog_sk
-0003a600: 7960 2e0a 0a20 2020 2020 2020 2052 6574  y`...        Ret
-0003a610: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-0003a620: 2d2d 2d2d 0a20 2020 2020 2020 2069 6478  ----.        idx
-0003a630: 203a 2069 6e74 2061 7272 6179 0a20 2020   : int array.   
-0003a640: 2020 2020 2020 2020 2049 6e64 6963 6573           Indices
-0003a650: 206f 6620 7468 6520 6d61 7463 6865 7320   of the matches 
-0003a660: 6173 2069 6e0a 0a20 2020 2020 2020 2020  as in..         
-0003a670: 2020 2020 2020 203e 3e3e 206d 6174 6368         >>> match
-0003a680: 6564 203d 2073 656c 665b 6964 785d 0a20  ed = self[idx]. 
-0003a690: 2020 2020 2020 2020 2020 2020 2020 203e                 >
-0003a6a0: 3e3e 206c 656e 286d 6174 6368 6564 2920  >> len(matched) 
-0003a6b0: 3d3d 206c 656e 286f 7468 6572 290a 0a20  == len(other).. 
-0003a6c0: 2020 2020 2020 2064 7220 3a20 666c 6f61         dr : floa
-0003a6d0: 7420 6172 7261 790a 2020 2020 2020 2020  t array.        
-0003a6e0: 2020 2020 5072 6f6a 6563 7465 6420 7365      Projected se
-0003a6f0: 7061 7261 7469 6f6e 206f 6620 636c 6f73  paration of clos
-0003a700: 6573 7420 6d61 7463 682e 0a0a 2020 2020  est match...    
-0003a710: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
-0003a720: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 0a20       --------.. 
-0003a730: 2020 2020 2020 2020 2020 2020 2020 203e                 >
-0003a740: 3e3e 2069 6d70 6f72 7420 6173 7472 6f70  >> import astrop
-0003a750: 792e 756e 6974 7320 6173 2075 0a0a 2020  y.units as u..  
-0003a760: 2020 2020 2020 2020 2020 2020 2020 3e3e                >>
-0003a770: 3e20 7265 6620 3d20 4754 6162 6c65 2e67  > ref = GTable.g
-0003a780: 7265 6164 2827 696e 7075 742e 6361 7427  read('input.cat'
-0003a790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003a7a0: 2020 3e3e 3e20 6761 6961 203d 2047 5461    >>> gaia = GTa
-0003a7b0: 626c 652e 6772 6561 6428 2767 6169 612e  ble.gread('gaia.
-0003a7c0: 6361 7427 290a 2020 2020 2020 2020 2020  cat').          
-0003a7d0: 2020 2020 2020 3e3e 3e20 6964 782c 2064        >>> idx, d
-0003a7e0: 7220 3d20 7265 662e 6d61 7463 685f 746f  r = ref.match_to
-0003a7f0: 5f63 6174 616c 6f67 5f73 6b79 2867 6169  _catalog_sky(gai
-0003a800: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
-0003a810: 2020 203e 3e3e 2063 6c6f 7365 203d 2064     >>> close = d
-0003a820: 7220 3c20 312a 752e 6172 6373 6563 0a0a  r < 1*u.arcsec..
-0003a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a840: 3e3e 3e20 7265 665f 6d61 7463 6820 3d20  >>> ref_match = 
-0003a850: 7265 665b 6964 785d 5b63 6c6f 7365 5d0a  ref[idx][close].
-0003a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a870: 3e3e 3e20 6761 6961 5f6d 6174 6368 203d  >>> gaia_match =
-0003a880: 2067 6169 615b 636c 6f73 655d 0a0a 2020   gaia[close]..  
-0003a890: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003a8a0: 2020 6672 6f6d 2061 7374 726f 7079 2e63    from astropy.c
-0003a8b0: 6f6f 7264 696e 6174 6573 2069 6d70 6f72  oordinates impor
-0003a8c0: 7420 536b 7943 6f6f 7264 0a0a 2020 2020  t SkyCoord..    
-0003a8d0: 2020 2020 6966 2073 656c 665f 7261 6465      if self_rade
-0003a8e0: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
-0003a8f0: 2020 2020 2020 2072 6420 3d20 7365 6c66         rd = self
-0003a900: 2e70 6172 7365 5f72 6164 6563 5f63 6f6c  .parse_radec_col
-0003a910: 756d 6e73 2873 656c 6629 0a20 2020 2020  umns(self).     
-0003a920: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003a930: 2020 2020 2072 6420 3d20 7365 6c66 2e70       rd = self.p
-0003a940: 6172 7365 5f72 6164 6563 5f63 6f6c 756d  arse_radec_colum
-0003a950: 6e73 2873 656c 662c 2072 645f 7061 6972  ns(self, rd_pair
-0003a960: 733d 7b73 656c 665f 7261 6465 635b 305d  s={self_radec[0]
-0003a970: 3a20 7365 6c66 5f72 6164 6563 5b31 5d7d  : self_radec[1]}
-0003a980: 290a 0a20 2020 2020 2020 2069 6620 7264  )..        if rd
-0003a990: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
-0003a9a0: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
-0003a9b0: 2052 412f 4465 632e 2063 6f6c 756d 6e73   RA/Dec. columns
-0003a9c0: 2066 6f75 6e64 2069 6e20 696e 7075 7420   found in input 
-0003a9d0: 7461 626c 652e 2729 0a20 2020 2020 2020  table.').       
-0003a9e0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-0003a9f0: 650a 0a20 2020 2020 2020 2073 656c 665f  e..        self_
-0003aa00: 636f 6f20 3d20 536b 7943 6f6f 7264 2872  coo = SkyCoord(r
-0003aa10: 613d 7365 6c66 5b72 645b 305d 5d2c 2064  a=self[rd[0]], d
-0003aa20: 6563 3d73 656c 665b 7264 5b31 5d5d 2c20  ec=self[rd[1]], 
-0003aa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aa40: 2020 2020 2020 2020 2020 2020 2066 7261               fra
-0003aa50: 6d65 3d27 6963 7273 2729 0a0a 2020 2020  me='icrs')..    
-0003aa60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0003aa70: 6528 6f74 6865 722c 206c 6973 7429 207c  e(other, list) |
-0003aa80: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-0003aa90: 722c 2074 7570 6c65 293a 0a20 2020 2020  r, tuple):.     
-0003aaa0: 2020 2020 2020 2072 6420 3d20 5b73 6c69         rd = [sli
-0003aab0: 6365 2830 2c20 3129 2c20 736c 6963 6528  ce(0, 1), slice(
-0003aac0: 312c 2032 295d 0a0a 2020 2020 2020 2020  1, 2)]..        
-0003aad0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003aae0: 2020 6966 206f 7468 6572 5f72 6164 6563    if other_radec
-0003aaf0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003ab00: 2020 2020 2020 2020 2020 7264 203d 2073            rd = s
-0003ab10: 656c 662e 7061 7273 655f 7261 6465 635f  elf.parse_radec_
-0003ab20: 636f 6c75 6d6e 7328 6f74 6865 7229 0a20  columns(other). 
-0003ab30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0003ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ab50: 2072 6420 3d20 7365 6c66 2e70 6172 7365   rd = self.parse
-0003ab60: 5f72 6164 6563 5f63 6f6c 756d 6e73 286f  _radec_columns(o
-0003ab70: 7468 6572 2c20 7264 5f70 6169 7273 3d7b  ther, rd_pairs={
-0003ab80: 6f74 6865 725f 7261 6465 635b 305d 3a20  other_radec[0]: 
-0003ab90: 6f74 6865 725f 7261 6465 635b 315d 7d29  other_radec[1]})
-0003aba0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0003abb0: 2072 6420 6973 2046 616c 7365 3a0a 2020   rd is False:.  
-0003abc0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0003abd0: 696e 7428 274e 6f20 5241 2f44 6563 2e20  int('No RA/Dec. 
-0003abe0: 636f 6c75 6d6e 7320 666f 756e 6420 696e  columns found in
-0003abf0: 2060 6f74 6865 7260 2074 6162 6c65 2e27   `other` table.'
-0003ac00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003ac10: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-0003ac20: 2020 2020 2020 2020 6f74 6865 725f 636f          other_co
-0003ac30: 6f20 3d20 536b 7943 6f6f 7264 2872 613d  o = SkyCoord(ra=
-0003ac40: 6f74 6865 725b 7264 5b30 5d5d 2c20 6465  other[rd[0]], de
-0003ac50: 633d 6f74 6865 725b 7264 5b31 5d5d 2c0a  c=other[rd[1]],.
-0003ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ac70: 2020 2020 2020 2020 2020 2020 2066 7261               fra
-0003ac80: 6d65 3d27 6963 7273 2729 0a0a 2020 2020  me='icrs')..    
-0003ac90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0003aca0: 2020 2020 2069 6478 2c20 6432 642c 2064       idx, d2d, d
-0003acb0: 3364 203d 206f 7468 6572 5f63 6f6f 2e6d  3d = other_coo.m
-0003acc0: 6174 6368 5f74 6f5f 6361 7461 6c6f 675f  atch_to_catalog_
-0003acd0: 736b 7928 7365 6c66 5f63 6f6f 2c20 6e74  sky(self_coo, nt
-0003ace0: 686e 6569 6768 626f 723d 6e74 686e 6569  hneighbor=nthnei
-0003acf0: 6768 626f 7229 0a20 2020 2020 2020 2065  ghbor).        e
-0003ad00: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-0003ad10: 2020 2070 7269 6e74 2827 436f 756c 646e     print('Couldn
-0003ad20: 5c27 7420 7275 6e20 536b 7943 6f6f 7264  \'t run SkyCoord
-0003ad30: 2e6d 6174 6368 5f74 6f5f 6361 7461 6c6f  .match_to_catalo
-0003ad40: 675f 736b 7920 7769 7468 270a 2020 2020  g_sky with'.    
-0003ad50: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-0003ad60: 7468 6e65 6967 6862 6f72 2729 0a0a 2020  thneighbor')..  
-0003ad70: 2020 2020 2020 2020 2020 6964 782c 2064            idx, d
-0003ad80: 3264 2c20 6433 6420 3d20 6f74 6865 725f  2d, d3d = other_
-0003ad90: 636f 6f2e 6d61 7463 685f 746f 5f63 6174  coo.match_to_cat
-0003ada0: 616c 6f67 5f73 6b79 2873 656c 665f 636f  alog_sky(self_co
-0003adb0: 6f29 0a20 2020 2020 2020 200a 2020 2020  o).        .    
-0003adc0: 2020 2020 6966 2067 6574 5f32 645f 6f66      if get_2d_of
-0003add0: 6673 6574 3a0a 2020 2020 2020 2020 2020  fset:.          
-0003ade0: 2020 636f 7364 203d 206e 702e 636f 7328    cosd = np.cos(
-0003adf0: 7365 6c66 5f63 6f6f 2e64 6563 2e64 6567  self_coo.dec.deg
-0003ae00: 2f31 3830 2a6e 702e 7069 290a 2020 2020  /180*np.pi).    
-0003ae10: 2020 2020 2020 2020 6472 6120 3d20 286f          dra = (o
-0003ae20: 7468 6572 5f63 6f6f 2e72 612e 6465 6720  ther_coo.ra.deg 
-0003ae30: 2d20 7365 6c66 5f63 6f6f 2e72 612e 6465  - self_coo.ra.de
-0003ae40: 675b 6964 785d 292a 636f 7364 5b69 6478  g[idx])*cosd[idx
-0003ae50: 5d0a 2020 2020 2020 2020 2020 2020 6464  ].            dd
-0003ae60: 6520 3d20 286f 7468 6572 5f63 6f6f 2e64  e = (other_coo.d
-0003ae70: 6563 2e64 6567 202d 2073 656c 665f 636f  ec.deg - self_co
-0003ae80: 6f2e 6465 632e 6465 675b 6964 785d 290a  o.dec.deg[idx]).
-0003ae90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003aea0: 726e 2069 6478 2c20 6432 642e 746f 2875  rn idx, d2d.to(u
-0003aeb0: 2e61 7263 7365 6329 2c20 6472 612a 3336  .arcsec), dra*36
-0003aec0: 3030 2a75 2e61 7263 7365 632c 2064 6465  00*u.arcsec, dde
-0003aed0: 2a33 3630 302a 752e 6172 6373 6563 0a20  *3600*u.arcsec. 
-0003aee0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003aef0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003af00: 6964 782c 2064 3264 2e74 6f28 752e 6172  idx, d2d.to(u.ar
-0003af10: 6373 6563 290a 0a20 2020 2064 6566 206d  csec)..    def m
-0003af20: 6174 6368 5f74 7269 616e 676c 6573 2873  atch_triangles(s
-0003af30: 656c 662c 206f 7468 6572 2c20 7365 6c66  elf, other, self
-0003af40: 5f77 6373 3d4e 6f6e 652c 2078 5f63 6f6c  _wcs=None, x_col
-0003af50: 756d 6e3d 2758 5f49 4d41 4745 272c 2079  umn='X_IMAGE', y
-0003af60: 5f63 6f6c 756d 6e3d 2759 5f49 4d41 4745  _column='Y_IMAGE
-0003af70: 272c 206d 6167 5f63 6f6c 756d 6e3d 274d  ', mag_column='M
-0003af80: 4147 5f41 5554 4f27 2c20 6f74 6865 725f  AG_AUTO', other_
-0003af90: 7261 3d27 585f 574f 524c 4427 2c20 6f74  ra='X_WORLD', ot
-0003afa0: 6865 725f 6465 633d 2759 5f57 4f52 4c44  her_dec='Y_WORLD
-0003afb0: 272c 2070 6978 656c 5f69 6e64 6578 3d31  ', pixel_index=1
-0003afc0: 2c20 6d61 7463 685f 6b77 6172 6773 3d7b  , match_kwargs={
-0003afd0: 7d2c 2070 6164 3d31 3030 2c20 7368 6f77  }, pad=100, show
-0003afe0: 5f64 6961 676e 6f73 7469 633d 4661 6c73  _diagnostic=Fals
-0003aff0: 652c 2061 7574 6f5f 6b65 6570 3d33 2c20  e, auto_keep=3, 
-0003b000: 6d61 784b 6565 703d 3130 2c20 6175 746f  maxKeep=10, auto
-0003b010: 5f6c 696d 6974 3d33 2c20 6261 5f6d 6178  _limit=3, ba_max
-0003b020: 3d30 2e39 392c 2073 6361 6c65 5f64 656e  =0.99, scale_den
-0003b030: 7369 7479 3d31 3029 3a0a 2020 2020 2020  sity=10):.      
-0003b040: 2020 2222 220a 0a20 2020 2020 2020 2078    """..        x
-0003b050: 5f63 6f6c 756d 6e20 3d20 2758 5f49 4d41  _column = 'X_IMA
-0003b060: 4745 270a 2020 2020 2020 2020 795f 636f  GE'.        y_co
-0003b070: 6c75 6d6e 203d 2027 595f 494d 4147 4527  lumn = 'Y_IMAGE'
-0003b080: 0a20 2020 2020 2020 206d 6167 5f63 6f6c  .        mag_col
-0003b090: 756d 6e20 3d20 274d 4147 5f41 5554 4f27  umn = 'MAG_AUTO'
-0003b0a0: 0a20 2020 2020 2020 2070 6978 656c 5f69  .        pixel_i
-0003b0b0: 6e64 6578 3d31 0a20 2020 2020 2020 2070  ndex=1.        p
-0003b0c0: 6164 3d31 3030 0a0a 2020 2020 2020 2020  ad=100..        
-0003b0d0: 6175 746f 5f6b 6565 703d 330a 2020 2020  auto_keep=3.    
-0003b0e0: 2020 2020 6d61 784b 6565 703d 3130 0a20      maxKeep=10. 
-0003b0f0: 2020 2020 2020 2061 7574 6f5f 6c69 6d69         auto_limi
-0003b100: 743d 330a 2020 2020 2020 2020 6261 5f6d  t=3.        ba_m
-0003b110: 6178 203d 2030 2e39 390a 0a20 2020 2020  ax = 0.99..     
-0003b120: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
-0003b130: 726f 6d20 7472 6973 7461 7273 2069 6d70  rom tristars imp
-0003b140: 6f72 7420 6d61 7463 680a 0a20 2020 2020  ort match..     
-0003b150: 2020 2069 6620 6861 7361 7474 7228 6f74     if hasattr(ot
-0003b160: 6865 722c 2027 7368 6170 6527 293a 0a20  her, 'shape'):. 
-0003b170: 2020 2020 2020 2020 2020 206f 7468 6572             other
-0003b180: 5f72 6164 6563 203d 206f 7468 6572 2a31  _radec = other*1
-0003b190: 2e0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
-0003b1a0: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0003b1b0: 725f 7261 6465 6320 3d20 6e70 2e61 7272  r_radec = np.arr
-0003b1c0: 6179 285b 6f74 6865 725b 6f74 6865 725f  ay([other[other_
-0003b1d0: 7261 5d2c 206f 7468 6572 5b6f 7468 6572  ra], other[other
-0003b1e0: 5f64 6563 5d5d 292e 540a 0a20 2020 2020  _dec]]).T..     
-0003b1f0: 2020 2073 656c 665f 7879 203d 206e 702e     self_xy = np.
-0003b200: 6172 7261 7928 5b73 656c 665b 785f 636f  array([self[x_co
-0003b210: 6c75 6d6e 5d2c 2073 656c 665b 795f 636f  lumn], self[y_co
-0003b220: 6c75 6d6e 5d5d 292e 540a 0a20 2020 2020  lumn]]).T..     
-0003b230: 2020 2023 7879 5f64 727a 203d 206e 702e     #xy_drz = np.
-0003b240: 6172 7261 7928 5b63 6174 5b27 585f 494d  array([cat['X_IM
-0003b250: 4147 4527 5d5b 6f6b 5d2c 2063 6174 5b27  AGE'][ok], cat['
-0003b260: 595f 494d 4147 4527 5d5b 6f6b 5d5d 292e  Y_IMAGE'][ok]]).
-0003b270: 540a 0a20 2020 2020 2020 2069 6620 7365  T..        if se
-0003b280: 6c66 5f77 6373 2069 7320 4e6f 6e65 3a0a  lf_wcs is None:.
-0003b290: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0003b2a0: 725f 7879 203d 206f 7468 6572 5f72 6164  r_xy = other_rad
-0003b2b0: 6563 0a20 2020 2020 2020 2020 2020 2063  ec.            c
-0003b2c0: 7574 203d 2028 6f74 6865 725f 7879 5b3a  ut = (other_xy[:
-0003b2d0: 2c20 305d 203e 202d 7061 6429 2026 2028  , 0] > -pad) & (
-0003b2e0: 6f74 6865 725f 7879 5b3a 2c20 305d 203c  other_xy[:, 0] <
-0003b2f0: 2073 656c 665f 7879 5b3a 2c20 305d 2e6d   self_xy[:, 0].m
-0003b300: 6178 2829 2b70 6164 2920 2620 286f 7468  ax()+pad) & (oth
-0003b310: 6572 5f78 795b 3a2c 2031 5d20 3e20 2d70  er_xy[:, 1] > -p
-0003b320: 6164 2920 2620 286f 7468 6572 5f78 795b  ad) & (other_xy[
-0003b330: 3a2c 2030 5d20 3c20 7365 6c66 5f78 795b  :, 0] < self_xy[
-0003b340: 3a2c 2031 5d2e 6d61 7828 292b 7061 6429  :, 1].max()+pad)
-0003b350: 0a20 2020 2020 2020 2020 2020 206f 7468  .            oth
-0003b360: 6572 5f78 7920 3d20 6f74 6865 725f 7879  er_xy = other_xy
-0003b370: 5b63 7574 2c20 3a5d 0a0a 2020 2020 2020  [cut, :]..      
-0003b380: 2020 2020 2020 7879 5f63 656e 7465 7220        xy_center 
-0003b390: 3d20 6e70 2e7a 6572 6f73 2832 290a 0a20  = np.zeros(2).. 
-0003b3a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003b3b0: 2020 2020 2020 2020 206f 7468 6572 5f78           other_x
-0003b3c0: 7920 3d20 7365 6c66 5f77 6373 2e61 6c6c  y = self_wcs.all
-0003b3d0: 5f77 6f72 6c64 3270 6978 286f 7468 6572  _world2pix(other
-0003b3e0: 5f72 6164 6563 2c20 7069 7865 6c5f 696e  _radec, pixel_in
-0003b3f0: 6465 7829 0a20 2020 2020 2020 2020 2020  dex).           
-0003b400: 2069 6620 6861 7361 7474 7228 7365 6c66   if hasattr(self
-0003b410: 5f77 6373 2c20 2770 6978 656c 5f73 6861  _wcs, 'pixel_sha
-0003b420: 7065 2729 3a0a 2020 2020 2020 2020 2020  pe'):.          
-0003b430: 2020 2020 2020 5f6e 6178 6973 312c 205f        _naxis1, _
-0003b440: 6e61 7869 7332 203d 2073 656c 665f 7763  naxis2 = self_wc
-0003b450: 732e 5f6e 6178 6973 0a20 2020 2020 2020  s._naxis.       
-0003b460: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003b470: 2020 2020 2020 2020 2020 205f 6e61 7869             _naxi
-0003b480: 7331 2c20 5f6e 6178 6973 3220 3d20 7365  s1, _naxis2 = se
-0003b490: 6c66 5f77 6373 2e5f 6e61 7869 7331 2c20  lf_wcs._naxis1, 
-0003b4a0: 7365 6c66 5f77 6373 2e5f 6e61 7869 7332  self_wcs._naxis2
-0003b4b0: 0a0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
-0003b4c0: 7420 3d20 286f 7468 6572 5f78 795b 3a2c  t = (other_xy[:,
-0003b4d0: 2030 5d20 3e20 2d70 6164 2920 2620 286f   0] > -pad) & (o
-0003b4e0: 7468 6572 5f78 795b 3a2c 2030 5d20 3c20  ther_xy[:, 0] < 
-0003b4f0: 5f6e 6178 6973 312b 7061 6429 0a20 2020  _naxis1+pad).   
-0003b500: 2020 2020 2020 2020 2063 7574 2026 3d20           cut &= 
-0003b510: 286f 7468 6572 5f78 795b 3a2c 2031 5d20  (other_xy[:, 1] 
-0003b520: 3e20 2d70 6164 2920 2620 286f 7468 6572  > -pad) & (other
-0003b530: 5f78 795b 3a2c 2031 5d20 3c20 5f6e 6178  _xy[:, 1] < _nax
-0003b540: 6973 322b 7061 6429 0a0a 2020 2020 2020  is2+pad)..      
-0003b550: 2020 2020 2020 6f74 6865 725f 7879 203d        other_xy =
-0003b560: 206f 7468 6572 5f78 795b 6375 742c 203a   other_xy[cut, :
-0003b570: 5d0a 2020 2020 2020 2020 2020 2020 7879  ].            xy
-0003b580: 5f63 656e 7465 7220 3d20 7365 6c66 5f77  _center = self_w
-0003b590: 6373 2e77 6373 2e63 7270 6978 2a31 0a0a  cs.wcs.crpix*1..
-0003b5a0: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
-0003b5b0: 7468 6572 5f78 7929 203c 2033 3a0a 2020  ther_xy) < 3:.  
-0003b5c0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003b5d0: 274e 6f74 2065 6e6f 7567 6820 736f 7572  'Not enough sour
-0003b5e0: 6365 7320 696e 206d 6174 6368 2063 6174  ces in match cat
-0003b5f0: 616c 6f67 2729 0a20 2020 2020 2020 2020  alog').         
-0003b600: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0003b610: 0a20 2020 2020 2020 2073 656c 665f 7879  .        self_xy
-0003b620: 202d 3d20 7879 5f63 656e 7465 720a 2020   -= xy_center.  
-0003b630: 2020 2020 2020 6f74 6865 725f 7879 202d        other_xy -
-0003b640: 3d20 7879 5f63 656e 7465 720a 0a20 2020  = xy_center..   
-0003b650: 2020 2020 2023 2323 2323 2323 230a 2020       ########.  
-0003b660: 2020 2020 2020 2320 4d61 7463 6820 7375        # Match su
-0003b670: 7266 6163 6520 6465 6e73 6974 7920 6f66  rface density of
-0003b680: 2064 7269 7a7a 6c65 6420 616e 6420 7265   drizzled and re
-0003b690: 6665 7265 6e63 6520 6361 7461 6c6f 6773  ference catalogs
-0003b6a0: 0a20 2020 2020 2020 2069 6620 6d61 675f  .        if mag_
-0003b6b0: 636f 6c75 6d6e 2069 7320 6e6f 7420 4e6f  column is not No
-0003b6c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003b6d0: 6963 7574 203d 206e 702e 6d69 6e69 6d75  icut = np.minimu
-0003b6e0: 6d28 6c65 6e28 7365 6c66 292d 322c 2069  m(len(self)-2, i
-0003b6f0: 6e74 2873 6361 6c65 5f64 656e 7369 7479  nt(scale_density
-0003b700: 2a6f 7468 6572 5f78 792e 7368 6170 655b  *other_xy.shape[
-0003b710: 305d 2929 0a20 2020 2020 2020 2020 2020  0])).           
-0003b720: 2073 656c 665f 6978 203d 206e 702e 6172   self_ix = np.ar
-0003b730: 6773 6f72 7428 7365 6c66 5b6d 6167 5f63  gsort(self[mag_c
-0003b740: 6f6c 756d 6e5d 295b 3a69 6375 745d 0a20  olumn])[:icut]. 
-0003b750: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003b760: 2020 2020 2020 2020 2073 656c 665f 6978           self_ix
-0003b770: 203d 206e 702e 6172 616e 6765 2873 656c   = np.arange(sel
-0003b780: 665f 7879 2e73 6861 7065 5b30 5d29 0a0a  f_xy.shape[0])..
-0003b790: 2020 2020 2020 2020 7365 6c66 5f78 7920          self_xy 
-0003b7a0: 3d20 7365 6c66 5f78 795b 7365 6c66 5f69  = self_xy[self_i
-0003b7b0: 782c 203a 5d0a 0a20 2020 2020 2020 2070  x, :]..        p
-0003b7c0: 6169 725f 6978 203d 206d 6174 6368 2e6d  air_ix = match.m
-0003b7d0: 6174 6368 5f63 6174 616c 6f67 5f74 7269  atch_catalog_tri
-0003b7e0: 2873 656c 665f 7879 2c20 6f74 6865 725f  (self_xy, other_
-0003b7f0: 7879 2c20 6d61 784b 6565 703d 6d61 784b  xy, maxKeep=maxK
-0003b800: 6565 702c 2061 7574 6f5f 6b65 6570 3d61  eep, auto_keep=a
-0003b810: 7574 6f5f 6b65 6570 2c20 6175 746f 5f74  uto_keep, auto_t
-0003b820: 7261 6e73 666f 726d 3d4e 6f6e 652c 2061  ransform=None, a
-0003b830: 7574 6f5f 6c69 6d69 743d 6175 746f 5f6c  uto_limit=auto_l
-0003b840: 696d 6974 2c20 7369 7a65 5f6c 696d 6974  imit, size_limit
-0003b850: 3d5b 352c 2031 3030 305d 2c20 6967 6e6f  =[5, 1000], igno
-0003b860: 7265 5f72 6f74 3d46 616c 7365 2c20 6967  re_rot=False, ig
-0003b870: 6e6f 7265 5f73 6361 6c65 3d54 7275 652c  nore_scale=True,
-0003b880: 2062 615f 6d61 783d 6261 5f6d 6178 290a   ba_max=ba_max).
-0003b890: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0003b8a0: 7061 6972 5f69 7829 203d 3d20 303a 0a20  pair_ix) == 0:. 
-0003b8b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0003b8c0: 2827 4e6f 206d 6174 6368 6573 2729 0a20  ('No matches'). 
-0003b8d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003b8e0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-0003b8f0: 2074 662c 2064 782c 2072 6d73 203d 206d   tf, dx, rms = m
-0003b900: 6174 6368 2e67 6574 5f74 7261 6e73 666f  atch.get_transfo
-0003b910: 726d 2873 656c 665f 7879 2c20 6f74 6865  rm(self_xy, othe
-0003b920: 725f 7879 2c20 7061 6972 5f69 782c 2074  r_xy, pair_ix, t
-0003b930: 7261 6e73 666f 726d 3d4e 6f6e 652c 2075  ransform=None, u
-0003b940: 7365 5f72 616e 7361 633d 5472 7565 290a  se_ransac=True).
-0003b950: 0a20 2020 2020 2020 206d 6174 6368 5f69  .        match_i
-0003b960: 7820 3d20 7061 6972 5f69 782a 310a 2020  x = pair_ix*1.  
-0003b970: 2020 2020 2020 6d61 7463 685f 6978 5b3a        match_ix[:
-0003b980: 2c20 305d 203d 2073 656c 665f 6978 5b70  , 0] = self_ix[p
-0003b990: 6169 725f 6978 5b3a 2c20 305d 5d0a 0a20  air_ix[:, 0]].. 
-0003b9a0: 2020 2020 2020 2069 6620 7368 6f77 5f64         if show_d
-0003b9b0: 6961 676e 6f73 7469 633a 0a20 2020 2020  iagnostic:.     
-0003b9c0: 2020 2020 2020 2066 6967 203d 206d 6174         fig = mat
-0003b9d0: 6368 2e6d 6174 6368 5f64 6961 676e 6f73  ch.match_diagnos
-0003b9e0: 7469 635f 706c 6f74 2873 656c 665f 7879  tic_plot(self_xy
-0003b9f0: 2c20 6f74 6865 725f 7879 2c20 7061 6972  , other_xy, pair
-0003ba00: 5f69 782c 2074 663d 4e6f 6e65 2c20 6e65  _ix, tf=None, ne
-0003ba10: 775f 6669 6775 7265 3d54 7275 6529 0a20  w_figure=True). 
-0003ba20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003ba30: 6e20 6d61 7463 685f 6978 2c20 7466 2c20  n match_ix, tf, 
-0003ba40: 6478 2c20 726d 732c 2066 6967 0a20 2020  dx, rms, fig.   
-0003ba50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003ba60: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-0003ba70: 7463 685f 6978 2c20 7466 2c20 6478 2c20  tch_ix, tf, dx, 
-0003ba80: 726d 730a 0a20 2020 2064 6566 2061 6464  rms..    def add
-0003ba90: 5f61 6c61 6464 696e 2873 656c 662c 2072  _aladdin(self, r
-0003baa0: 645f 636f 6c73 3d5b 2772 6127 2c20 2764  d_cols=['ra', 'd
-0003bab0: 6563 275d 2c20 666f 763d 302e 352c 2073  ec'], fov=0.5, s
-0003bac0: 697a 653d 2834 3030 2c20 3230 3029 2c20  ize=(400, 200), 
-0003bad0: 6465 6661 756c 745f 7669 6577 3d22 502f  default_view="P/
-0003bae0: 4453 5332 2f63 6f6c 6f72 2229 3a0a 2020  DSS2/color"):.  
-0003baf0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003bb00: 2020 4164 6420 416c 6164 696e 4c69 7465    Add AladinLite
-0003bb10: 2044 4956 2063 6f6c 756d 6e20 746f 2074   DIV column to t
-0003bb20: 6865 2074 6162 6c65 0a0a 2020 2020 2020  he table..      
-0003bb30: 2020 666f 7620 3a20 666f 7620 696e 2064    fov : fov in d
-0003bb40: 6567 7265 6573 0a20 2020 2020 2020 2073  egrees.        s
-0003bb50: 697a 6520 3a20 7369 7a65 206f 6620 4449  ize : size of DI
-0003bb60: 5673 2028 772c 2068 2920 696e 2070 6978  Vs (w, h) in pix
-0003bb70: 656c 7320 2877 2c20 6829 0a0a 2020 2020  els (w, h)..    
-0003bb80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0003bb90: 2320 3c21 2d2d 2069 6e63 6c75 6465 2041  # <!-- include A
-0003bba0: 6c61 6469 6e20 4c69 7465 2043 5353 2066  ladin Lite CSS f
-0003bbb0: 696c 6520 696e 2074 6865 2068 6561 6420  ile in the head 
-0003bbc0: 7365 6374 696f 6e20 6f66 2079 6f75 7220  section of your 
-0003bbd0: 7061 6765 202d 2d3e 0a20 2020 2020 2020  page -->.       
-0003bbe0: 2023 203c 6c69 6e6b 2072 656c 3d22 7374   # <link rel="st
-0003bbf0: 796c 6573 6865 6574 2220 6872 6566 3d22  ylesheet" href="
-0003bc00: 2f2f 616c 6164 696e 2e75 2d73 7472 6173  //aladin.u-stras
-0003bc10: 6267 2e66 722f 416c 6164 696e 4c69 7465  bg.fr/AladinLite
-0003bc20: 2f61 7069 2f76 322f 6c61 7465 7374 2f61  /api/v2/latest/a
-0003bc30: 6c61 6469 6e2e 6d69 6e2e 6373 7322 202f  ladin.min.css" /
-0003bc40: 3e0a 2020 2020 2020 2020 230a 2020 2020  >.        #.    
-0003bc50: 2020 2020 2320 3c21 2d2d 2079 6f75 2063      # <!-- you c
-0003bc60: 616e 2073 6b69 7020 7468 6520 666f 6c6c  an skip the foll
-0003bc70: 6f77 696e 6720 6c69 6e65 2069 6620 796f  owing line if yo
-0003bc80: 7572 2070 6167 6520 616c 7265 6164 7920  ur page already 
-0003bc90: 696e 7465 6772 6174 6573 2074 6865 206a  integrates the j
-0003bca0: 5175 6572 7920 6c69 6272 6172 7920 2d2d  Query library --
-0003bcb0: 3e0a 2020 2020 2020 2020 2320 3c73 6372  >.        # <scr
-0003bcc0: 6970 7420 7479 7065 3d22 7465 7874 2f6a  ipt type="text/j
-0003bcd0: 6176 6173 6372 6970 7422 2073 7263 3d22  avascript" src="
-0003bce0: 2f2f 636f 6465 2e6a 7175 6572 792e 636f  //code.jquery.co
-0003bcf0: 6d2f 6a71 7565 7279 2d31 2e31 322e 312e  m/jquery-1.12.1.
-0003bd00: 6d69 6e2e 6a73 2220 6368 6172 7365 743d  min.js" charset=
-0003bd10: 2275 7466 2d38 223e 3c2f 7363 7269 7074  "utf-8"></script
-0003bd20: 3e0a 0a20 2020 2020 2020 2061 6c61 203d  >..        ala =
-0003bd30: 205b 2222 2220 2020 203c 6469 7620 6964   ["""    <div id
-0003bd40: 3d22 616c 6164 696e 2d6c 6974 652d 6469  ="aladin-lite-di
-0003bd50: 762d 7b69 7d22 2073 7479 6c65 3d22 7769  v-{i}" style="wi
-0003bd60: 6474 683a 7b77 7369 7a65 7d70 783b 6865  dth:{wsize}px;he
-0003bd70: 6967 6874 3a7b 6873 697a 657d 7078 3b22  ight:{hsize}px;"
-0003bd80: 3e3c 2f64 6976 3e0a 2020 2020 2020 2020  ></div>.        
-0003bd90: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
-0003bda0: 7874 2f6a 6176 6173 6372 6970 7422 2073  xt/javascript" s
-0003bdb0: 7263 3d22 6874 7470 3a2f 2f61 6c61 6469  rc="http://aladi
-0003bdc0: 6e2e 752d 7374 7261 7362 672e 6672 2f41  n.u-strasbg.fr/A
-0003bdd0: 6c61 6469 6e4c 6974 652f 6170 692f 7632  ladinLite/api/v2
-0003bde0: 2f6c 6174 6573 742f 616c 6164 696e 2e6d  /latest/aladin.m
-0003bdf0: 696e 2e6a 7322 2063 6861 7273 6574 3d22  in.js" charset="
-0003be00: 7574 662d 3822 3e3c 2f73 6372 6970 743e  utf-8"></script>
-0003be10: 0a20 2020 2020 2020 203c 7363 7269 7074  .        <script
-0003be20: 2074 7970 653d 2274 6578 742f 6a61 7661   type="text/java
-0003be30: 7363 7269 7074 223e 0a20 2020 2020 2020  script">.       
-0003be40: 2020 2020 2076 6172 2061 6c61 6469 6e20       var aladin 
-0003be50: 3d20 412e 616c 6164 696e 2827 2361 6c61  = A.aladin('#ala
-0003be60: 6469 6e2d 6c69 7465 2d64 6976 2d7b 697d  din-lite-div-{i}
-0003be70: 272c 2078 7878 7375 7276 6579 3a20 227b  ', xxxsurvey: "{
-0003be80: 7375 7276 6579 7d22 2c20 666f 763a 7b66  survey}", fov:{f
-0003be90: 6f76 7d2c 2074 6172 6765 743a 2022 7b72  ov}, target: "{r
-0003bea0: 617d 207b 6465 637d 2279 7979 293b 0a20  a} {dec}"yyy);. 
-0003beb0: 2020 2020 2020 203c 2f73 6372 6970 743e         </script>
-0003bec0: 3c2f 6469 763e 2222 222e 666f 726d 6174  </div>""".format
-0003bed0: 2869 3d69 2c20 7261 3d72 6f77 5b72 645f  (i=i, ra=row[rd_
-0003bee0: 636f 6c73 5b30 5d5d 2c20 6465 633d 726f  cols[0]], dec=ro
-0003bef0: 775b 7264 5f63 6f6c 735b 315d 5d2c 2073  w[rd_cols[1]], s
-0003bf00: 7572 7665 793d 6465 6661 756c 745f 7669  urvey=default_vi
-0003bf10: 6577 2c20 666f 763d 666f 762c 2068 7369  ew, fov=fov, hsi
-0003bf20: 7a65 3d73 697a 655b 315d 2c20 7773 697a  ze=size[1], wsiz
-0003bf30: 653d 7369 7a65 5b30 5d29 2e72 6570 6c61  e=size[0]).repla
-0003bf40: 6365 2827 7878 7827 2c20 277b 2729 2e72  ce('xxx', '{').r
-0003bf50: 6570 6c61 6365 2827 7979 7927 2c20 277d  eplace('yyy', '}
-0003bf60: 2729 2066 6f72 2069 2c20 726f 7720 696e  ') for i, row in
-0003bf70: 2065 6e75 6d65 7261 7465 2873 656c 6629   enumerate(self)
-0003bf80: 5d0a 0a20 2020 2020 2020 2073 656c 665b  ]..        self[
-0003bf90: 2761 6c61 6469 6e27 5d20 3d20 616c 610a  'aladin'] = ala.
-0003bfa0: 0a20 2020 2064 6566 2077 7269 7465 5f73  .    def write_s
-0003bfb0: 6f72 7461 626c 655f 6874 6d6c 2873 656c  ortable_html(sel
-0003bfc0: 662c 206f 7574 7075 742c 2072 6570 6c61  f, output, repla
-0003bfd0: 6365 5f62 7261 6365 733d 5472 7565 2c20  ce_braces=True, 
-0003bfe0: 6c6f 6361 6c68 6f73 743d 5472 7565 2c20  localhost=True, 
-0003bff0: 6d61 785f 6c69 6e65 733d 3530 2c20 7461  max_lines=50, ta
-0003c000: 626c 655f 6964 3d4e 6f6e 652c 2074 6162  ble_id=None, tab
-0003c010: 6c65 5f63 6c61 7373 3d22 6469 7370 6c61  le_class="displa
-0003c020: 7920 636f 6d70 6163 7422 2c20 6373 733d  y compact", css=
-0003c030: 4e6f 6e65 2c20 6669 6c74 6572 5f63 6f6c  None, filter_col
-0003c040: 756d 6e73 3d5b 5d2c 2062 7574 746f 6e73  umns=[], buttons
-0003c050: 3d5b 2763 7376 275d 2c20 746f 6767 6c65  =['csv'], toggle
-0003c060: 3d54 7275 652c 2075 7365 5f6a 736f 6e3d  =True, use_json=
-0003c070: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-0003c080: 2222 2257 7261 7070 6572 2061 726f 756e  """Wrapper aroun
-0003c090: 6420 607e 6173 7472 6f70 792e 7461 626c  d `~astropy.tabl
-0003c0a0: 652e 5461 626c 652e 7772 6974 6528 666f  e.Table.write(fo
-0003c0b0: 726d 6174 3d27 6a73 7669 6577 6572 2729  rmat='jsviewer')
-0003c0c0: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
-0003c0d0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
-0003c0e0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-0003c0f0: 2020 6f75 7470 7574 203a 2073 7472 0a20    output : str. 
-0003c100: 2020 2020 2020 2020 2020 204f 7574 7075             Outpu
-0003c110: 7420 6669 6c65 6e61 6d65 2e0a 0a20 2020  t filename...   
-0003c120: 2020 2020 2072 6570 6c61 6365 5f62 7261       replace_bra
-0003c130: 6365 7320 3a20 626f 6f6c 0a20 2020 2020  ces : bool.     
-0003c140: 2020 2020 2020 2052 6570 6c61 6365 2027         Replace '
-0003c150: 266c 743b 2720 616e 6420 2726 6774 3b27  &lt;' and '&gt;'
-0003c160: 2063 6861 7261 6374 6572 7320 7468 6174   characters that
-0003c170: 2061 7265 2063 6f6e 7665 7274 6564 0a20   are converted. 
-0003c180: 2020 2020 2020 2020 2020 2061 7574 6f6d             autom
-0003c190: 6174 6963 616c 6c79 2066 726f 6d20 223c  atically from "<
-0003c1a0: 3e22 2062 7920 7468 6520 607e 6173 7472  >" by the `~astr
-0003c1b0: 6f70 792e 7461 626c 652e 5461 626c 652e  opy.table.Table.
-0003c1c0: 7772 6974 6560 0a20 2020 2020 2020 2020  write`.         
-0003c1d0: 2020 206d 6574 686f 642e 2054 6865 7265     method. There
-0003c1e0: 2061 7265 2070 6172 616d 6574 6572 7320   are parameters 
-0003c1f0: 666f 7220 646f 696e 6720 7468 6973 2061  for doing this a
-0003c200: 7574 6f6d 6174 6963 616c 6c79 2077 6974  utomatically wit
-0003c210: 680a 2020 2020 2020 2020 2020 2020 6077  h.            `w
-0003c220: 7269 7465 2866 6f72 6d61 743d 2768 746d  rite(format='htm
-0003c230: 6c27 2960 2062 7574 2074 6861 7420 646f  l')` but that do
-0003c240: 6e27 7420 6170 7065 6172 2074 6f20 6265  n't appear to be
-0003c250: 2061 7661 696c 6162 6c65 2077 6974 680a   available with.
-0003c260: 2020 2020 2020 2020 2020 2020 6077 7269              `wri
-0003c270: 7465 2866 6f72 6d61 743d 276a 7376 6965  te(format='jsvie
-0003c280: 7765 7227 2960 2e0a 0a20 2020 2020 2020  wer')`...       
-0003c290: 206c 6f63 616c 686f 7374 203a 2062 6f6f   localhost : boo
-0003c2a0: 6c0a 2020 2020 2020 2020 2020 2020 5573  l.            Us
-0003c2b0: 6520 6c6f 6361 6c20 4a53 2066 696c 6573  e local JS files
-0003c2c0: 2e20 4f74 6865 7277 6973 6520 7573 6520  . Otherwise use 
-0003c2d0: 6669 6c65 7320 686f 7374 6564 2065 7874  files hosted ext
-0003c2e0: 6572 6e61 6c6c 792e 0a0a 2020 2020 2020  ernally...      
-0003c2f0: 2020 6669 6c74 6572 5f63 6f6c 756d 6e73    filter_columns
-0003c300: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-0003c310: 2020 2020 4164 6420 6f70 7469 6f6e 2074      Add option t
-0003c320: 6f20 6c69 6d69 7420 6d69 6e2f 6d61 7820  o limit min/max 
-0003c330: 7661 6c75 6573 206f 6620 636f 6c75 6d6e  values of column
-0003c340: 2064 6174 610a 0a20 2020 2020 2020 2062   data..        b
-0003c350: 7574 746f 6e73 203a 206c 6973 740a 2020  uttons : list.  
-0003c360: 2020 2020 2020 2020 2020 4164 6420 6275            Add bu
-0003c370: 7474 6f6e 7320 666f 7220 6578 706f 7274  ttons for export
-0003c380: 696e 6720 6461 7461 2e20 2041 6c6c 6f77  ing data.  Allow
-0003c390: 6564 206f 7074 696f 6e73 2061 7265 0a20  ed options are. 
-0003c3a0: 2020 2020 2020 2020 2020 2027 636f 7079             'copy
-0003c3b0: 272c 2027 6373 7627 2c20 2765 7863 656c  ', 'csv', 'excel
-0003c3c0: 272c 2027 7064 6627 2c20 2770 7269 6e74  ', 'pdf', 'print
-0003c3d0: 272e 0a0a 2020 2020 2020 2020 746f 6767  '...        togg
-0003c3e0: 6c65 203a 2062 6f6f 6c0a 2020 2020 2020  le : bool.      
-0003c3f0: 2020 2020 2020 4164 6420 6c69 6e6b 7320        Add links 
-0003c400: 6174 2074 6f70 206f 6620 7061 6765 2066  at top of page f
-0003c410: 6f72 2074 6f67 676c 696e 6720 636f 6c75  or toggling colu
-0003c420: 6d6e 7320 6f6e 2f6f 6666 0a0a 2020 2020  mns on/off..    
-0003c430: 2020 2020 7573 655f 6a73 6f6e 203a 2062      use_json : b
-0003c440: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
-0003c450: 5772 6974 6520 7468 6520 6461 7461 2074  Write the data t
-0003c460: 6f20 6120 4a53 4f4e 2066 696c 6520 616e  o a JSON file an
-0003c470: 6420 7374 7269 7020 6f75 7420 6f66 2074  d strip out of t
-0003c480: 6865 2048 544d 4c20 6865 6164 6572 2e0a  he HTML header..
-0003c490: 2020 2020 2020 2020 2020 2020 5573 6520              Use 
-0003c4a0: 7468 6973 2066 6f72 206c 6172 6765 2064  this for large d
-0003c4b0: 6174 6173 6574 7320 6f72 2069 6620 636f  atasets or if co
-0003c4c0: 6c75 6d6e 7320 696e 636c 7564 6520 7265  lumns include re
-0003c4d0: 6e64 6572 6564 0a20 2020 2020 2020 2020  ndered.         
-0003c4e0: 2020 2069 6d61 6765 732e 0a0a 2020 2020     images...    
-0003c4f0: 2020 2020 6574 6320 3a20 2e2e 2e0a 2020      etc : ....  
-0003c500: 2020 2020 2020 2020 2020 4164 6469 7469            Additi
-0003c510: 6f6e 616c 2070 6172 616d 6574 6572 7320  onal parameters 
-0003c520: 7061 7373 6564 2074 6872 6f75 6768 2074  passed through t
-0003c530: 6f20 6077 7269 7465 602e 0a20 2020 2020  o `write`..     
-0003c540: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-0003c550: 6672 6f6d 2061 7374 726f 7079 2e74 6162  from astropy.tab
-0003c560: 6c65 2e6a 7376 6965 7765 7220 696d 706f  le.jsviewer impo
-0003c570: 7274 2044 4546 4155 4c54 5f43 5353 0a20  rt DEFAULT_CSS. 
-0003c580: 2020 2020 2020 2044 4546 4155 4c54 5f43         DEFAULT_C
-0003c590: 5353 203d 2022 2222 0a62 6f64 7920 7b66  SS = """.body {f
-0003c5a0: 6f6e 742d 6661 6d69 6c79 3a20 7361 6e73  ont-family: sans
-0003c5b0: 2d73 6572 6966 3b7d 0a74 6162 6c65 2e64  -serif;}.table.d
-0003c5c0: 6174 6154 6162 6c65 207b 7769 6474 683a  ataTable {width:
-0003c5d0: 2061 7574 6f20 2169 6d70 6f72 7461 6e74   auto !important
-0003c5e0: 3b20 6d61 7267 696e 3a20 3020 2169 6d70  ; margin: 0 !imp
-0003c5f0: 6f72 7461 6e74 3b7d 0a2e 6461 7461 5461  ortant;}..dataTa
-0003c600: 626c 6573 5f66 696c 7465 722c 202e 6461  bles_filter, .da
-0003c610: 7461 5461 626c 6573 5f70 6167 696e 6174  taTables_paginat
-0003c620: 6520 7b66 6c6f 6174 3a20 6c65 6674 2021  e {float: left !
-0003c630: 696d 706f 7274 616e 743b 206d 6172 6769  important; margi
-0003c640: 6e2d 6c65 6674 3a31 656d 7d0a 7464 207b  n-left:1em}.td {
-0003c650: 666f 6e74 2d73 697a 653a 2031 3070 743b  font-size: 10pt;
-0003c660: 7d0a 2020 2020 2020 2020 2222 220a 2020  }.        """.  
-0003c670: 2020 2020 2020 6966 2063 7373 2069 7320        if css is 
-0003c680: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003c690: 2020 2020 2020 4445 4641 554c 545f 4353        DEFAULT_CS
-0003c6a0: 5320 2b3d 2063 7373 0a0a 2020 2020 2020  S += css..      
-0003c6b0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
-0003c6c0: 7374 7328 6f75 7470 7574 293a 0a20 2020  sts(output):.   
-0003c6d0: 2020 2020 2020 2020 206f 732e 7265 6d6f           os.remo
-0003c6e0: 7665 286f 7574 7075 7429 0a0a 2020 2020  ve(output)..    
-0003c6f0: 2020 2020 7365 6c66 2e77 7269 7465 286f      self.write(o
-0003c700: 7574 7075 742c 2066 6f72 6d61 743d 276a  utput, format='j
-0003c710: 7376 6965 7765 7227 2c20 6373 733d 4445  sviewer', css=DE
-0003c720: 4641 554c 545f 4353 532c 0a20 2020 2020  FAULT_CSS,.     
-0003c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c740: 2020 2020 2020 206d 6178 5f6c 696e 6573         max_lines
-0003c750: 3d6d 6178 5f6c 696e 6573 2c0a 2020 2020  =max_lines,.    
-0003c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c770: 2020 2020 2020 2020 6a73 6b77 6172 6773          jskwargs
-0003c780: 3d7b 2775 7365 5f6c 6f63 616c 5f66 696c  ={'use_local_fil
-0003c790: 6573 273a 206c 6f63 616c 686f 7374 7d2c  es': localhost},
-0003c7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c7b0: 2020 2020 2020 2020 2020 2020 2074 6162               tab
-0003c7c0: 6c65 5f69 643d 4e6f 6e65 2c20 7461 626c  le_id=None, tabl
-0003c7d0: 655f 636c 6173 733d 7461 626c 655f 636c  e_class=table_cl
-0003c7e0: 6173 7329 0a0a 2020 2020 2020 2020 6966  ass)..        if
-0003c7f0: 2072 6570 6c61 6365 5f62 7261 6365 733a   replace_braces:
-0003c800: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0003c810: 6573 203d 206f 7065 6e28 6f75 7470 7574  es = open(output
-0003c820: 292e 7265 6164 6c69 6e65 7328 290a 2020  ).readlines().  
-0003c830: 2020 2020 2020 2020 2020 6966 2072 6570            if rep
-0003c840: 6c61 6365 5f62 7261 6365 733a 0a20 2020  lace_braces:.   
-0003c850: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003c860: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-0003c870: 6c69 6e65 7329 293a 0a20 2020 2020 2020  lines)):.       
-0003c880: 2020 2020 2020 2020 2020 2020 206c 696e               lin
-0003c890: 6573 5b69 5d20 3d20 6c69 6e65 735b 695d  es[i] = lines[i]
-0003c8a0: 2e72 6570 6c61 6365 2827 266c 743b 272c  .replace('&lt;',
-0003c8b0: 2027 3c27 290a 2020 2020 2020 2020 2020   '<').          
-0003c8c0: 2020 2020 2020 2020 2020 6c69 6e65 735b            lines[
-0003c8d0: 695d 203d 206c 696e 6573 5b69 5d2e 7265  i] = lines[i].re
-0003c8e0: 706c 6163 6528 2726 6774 3b27 2c20 273e  place('&gt;', '>
-0003c8f0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0003c900: 6670 203d 206f 7065 6e28 6f75 7470 7574  fp = open(output
-0003c910: 2c20 2777 2729 0a20 2020 2020 2020 2020  , 'w').         
-0003c920: 2020 2066 702e 7772 6974 656c 696e 6573     fp.writelines
-0003c930: 286c 696e 6573 290a 2020 2020 2020 2020  (lines).        
-0003c940: 2020 2020 6670 2e63 6c6f 7365 2829 0a0a      fp.close()..
-0003c950: 2020 2020 2020 2020 2320 5265 6164 2061          # Read a
-0003c960: 6c6c 206c 696e 6573 0a20 2020 2020 2020  ll lines.       
-0003c970: 206c 696e 6573 203d 206f 7065 6e28 6f75   lines = open(ou
-0003c980: 7470 7574 292e 7265 6164 6c69 6e65 7328  tput).readlines(
-0003c990: 290a 0a20 2020 2020 2020 2069 6620 2761  )..        if 'a
-0003c9a0: 6c61 6469 6e27 2069 6e20 7365 6c66 2e63  ladin' in self.c
-0003c9b0: 6f6c 6e61 6d65 733a 0a20 2020 2020 2020  olnames:.       
-0003c9c0: 2020 2020 2023 2049 6e73 6572 7420 416c       # Insert Al
-0003c9d0: 6164 696e 2043 5353 0a20 2020 2020 2020  adin CSS.       
-0003c9e0: 2020 2020 2061 6c61 6469 6e5f 6373 7320       aladin_css 
-0003c9f0: 3d20 273c 6c69 6e6b 2072 656c 3d22 7374  = '<link rel="st
-0003ca00: 796c 6573 6865 6574 2220 6872 6566 3d22  ylesheet" href="
-0003ca10: 6874 7470 733a 2f2f 616c 6164 696e 2e75  https://aladin.u
-0003ca20: 2d73 7472 6173 6267 2e66 722f 416c 6164  -strasbg.fr/Alad
-0003ca30: 696e 4c69 7465 2f61 7069 2f76 322f 6c61  inLite/api/v2/la
-0003ca40: 7465 7374 2f61 6c61 6469 6e2e 6d69 6e2e  test/aladin.min.
-0003ca50: 6373 7322 202f 3e5c 6e27 0a0a 2020 2020  css" />\n'..    
-0003ca60: 2020 2020 2020 2020 666f 7220 696c 2c20          for il, 
-0003ca70: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
-0003ca80: 6528 6c69 6e65 7329 3a0a 2020 2020 2020  e(lines):.      
-0003ca90: 2020 2020 2020 2020 2020 6966 2027 3c6c            if '<l
-0003caa0: 696e 6b20 6872 6566 3d27 2069 6e20 6c69  ink href=' in li
-0003cab0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003cac0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-0003cad0: 2020 2020 2020 2020 2020 206c 696e 6573             lines
-0003cae0: 2e69 6e73 6572 7428 696c 2b31 2c20 616c  .insert(il+1, al
-0003caf0: 6164 696e 5f63 7373 290a 0a20 2020 2020  adin_css)..     
-0003cb00: 2020 2023 2045 7870 6f72 7420 6275 7474     # Export butt
-0003cb10: 6f6e 730a 2020 2020 2020 2020 6966 2062  ons.        if b
-0003cb20: 7574 746f 6e73 3a0a 2020 2020 2020 2020  uttons:.        
-0003cb30: 2020 2020 2320 4353 530a 2020 2020 2020      # CSS.      
-0003cb40: 2020 2020 2020 6373 735f 7363 7269 7074        css_script
-0003cb50: 203d 2027 3c6c 696e 6b20 7265 6c3d 2273   = '<link rel="s
-0003cb60: 7479 6c65 7368 6565 7422 2074 7970 653d  tylesheet" type=
-0003cb70: 2274 6578 742f 6373 7322 2068 7265 663d  "text/css" href=
-0003cb80: 2268 7474 7073 3a2f 2f63 646e 2e64 6174  "https://cdn.dat
-0003cb90: 6174 6162 6c65 732e 6e65 742f 6275 7474  atables.net/butt
-0003cba0: 6f6e 732f 312e 352e 312f 6373 732f 6275  ons/1.5.1/css/bu
-0003cbb0: 7474 6f6e 732e 6461 7461 5461 626c 6573  ttons.dataTables
-0003cbc0: 2e6d 696e 2e63 7373 223e 5c6e 270a 2020  .min.css">\n'.  
-0003cbd0: 2020 2020 2020 2020 2020 666f 7220 696c            for il
-0003cbe0: 2c20 6c69 6e65 2069 6e20 656e 756d 6572  , line in enumer
-0003cbf0: 6174 6528 6c69 6e65 7329 3a0a 2020 2020  ate(lines):.    
-0003cc00: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-0003cc10: 6373 732f 6a71 7565 7279 2e64 6174 6154  css/jquery.dataT
-0003cc20: 6162 6c65 2720 696e 206c 696e 653a 0a20  able' in line:. 
-0003cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc40: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003cc50: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
-0003cc60: 7274 2869 6c2b 312c 2063 7373 5f73 6372  rt(il+1, css_scr
-0003cc70: 6970 7429 0a0a 2020 2020 2020 2020 2020  ipt)..          
-0003cc80: 2020 2320 4a53 206c 6962 7261 7269 6573    # JS libraries
-0003cc90: 0a20 2020 2020 2020 2020 2020 206a 735f  .            js_
-0003cca0: 7363 7269 7074 7320 3d20 2222 220a 2020  scripts = """.  
-0003ccb0: 2020 2020 2020 2020 2020 3c73 6372 6970            <scrip
-0003ccc0: 7420 7479 7065 3d22 7465 7874 2f6a 6176  t type="text/jav
-0003ccd0: 6173 6372 6970 7422 206c 616e 6775 6167  ascript" languag
-0003cce0: 653d 226a 6176 6173 6372 6970 7422 2073  e="javascript" s
-0003ccf0: 7263 3d22 6874 7470 733a 2f2f 6364 6e2e  rc="https://cdn.
-0003cd00: 6461 7461 7461 626c 6573 2e6e 6574 2f62  datatables.net/b
-0003cd10: 7574 746f 6e73 2f31 2e35 2e31 2f6a 732f  uttons/1.5.1/js/
-0003cd20: 6461 7461 5461 626c 6573 2e62 7574 746f  dataTables.butto
-0003cd30: 6e73 2e6d 696e 2e6a 7322 3e3c 2f73 6372  ns.min.js"></scr
-0003cd40: 6970 743e 0a20 2020 2020 2020 2020 2020  ipt>.           
-0003cd50: 203c 7363 7269 7074 2074 7970 653d 2274   <script type="t
-0003cd60: 6578 742f 6a61 7661 7363 7269 7074 2220  ext/javascript" 
-0003cd70: 6c61 6e67 7561 6765 3d22 6a61 7661 7363  language="javasc
-0003cd80: 7269 7074 2220 7372 633d 2268 7474 7073  ript" src="https
-0003cd90: 3a2f 2f63 646e 2e64 6174 6174 6162 6c65  ://cdn.datatable
-0003cda0: 732e 6e65 742f 6275 7474 6f6e 732f 312e  s.net/buttons/1.
-0003cdb0: 352e 312f 6a73 2f62 7574 746f 6e73 2e66  5.1/js/buttons.f
-0003cdc0: 6c61 7368 2e6d 696e 2e6a 7322 3e3c 2f73  lash.min.js"></s
-0003cdd0: 6372 6970 743e 0a20 2020 2020 2020 2020  cript>.         
-0003cde0: 2020 203c 7363 7269 7074 2074 7970 653d     <script type=
-0003cdf0: 2274 6578 742f 6a61 7661 7363 7269 7074  "text/javascript
-0003ce00: 2220 6c61 6e67 7561 6765 3d22 6a61 7661  " language="java
-0003ce10: 7363 7269 7074 2220 7372 633d 2268 7474  script" src="htt
-0003ce20: 7073 3a2f 2f63 646e 6a73 2e63 6c6f 7564  ps://cdnjs.cloud
-0003ce30: 666c 6172 652e 636f 6d2f 616a 6178 2f6c  flare.com/ajax/l
-0003ce40: 6962 732f 6a73 7a69 702f 332e 312e 332f  ibs/jszip/3.1.3/
-0003ce50: 6a73 7a69 702e 6d69 6e2e 6a73 223e 3c2f  jszip.min.js"></
-0003ce60: 7363 7269 7074 3e0a 2020 2020 2020 2020  script>.        
-0003ce70: 2020 2020 3c73 6372 6970 7420 7479 7065      <script type
-0003ce80: 3d22 7465 7874 2f6a 6176 6173 6372 6970  ="text/javascrip
-0003ce90: 7422 206c 616e 6775 6167 653d 226a 6176  t" language="jav
-0003cea0: 6173 6372 6970 7422 2073 7263 3d22 6874  ascript" src="ht
-0003ceb0: 7470 733a 2f2f 6364 6e6a 732e 636c 6f75  tps://cdnjs.clou
-0003cec0: 6466 6c61 7265 2e63 6f6d 2f61 6a61 782f  dflare.com/ajax/
-0003ced0: 6c69 6273 2f70 6466 6d61 6b65 2f30 2e31  libs/pdfmake/0.1
-0003cee0: 2e33 322f 7064 666d 616b 652e 6d69 6e2e  .32/pdfmake.min.
-0003cef0: 6a73 223e 3c2f 7363 7269 7074 3e0a 2020  js"></script>.  
-0003cf00: 2020 2020 2020 2020 2020 3c73 6372 6970            <scrip
-0003cf10: 7420 7479 7065 3d22 7465 7874 2f6a 6176  t type="text/jav
-0003cf20: 6173 6372 6970 7422 206c 616e 6775 6167  ascript" languag
-0003cf30: 653d 226a 6176 6173 6372 6970 7422 2073  e="javascript" s
-0003cf40: 7263 3d22 6874 7470 733a 2f2f 6364 6e6a  rc="https://cdnj
-0003cf50: 732e 636c 6f75 6466 6c61 7265 2e63 6f6d  s.cloudflare.com
-0003cf60: 2f61 6a61 782f 6c69 6273 2f70 6466 6d61  /ajax/libs/pdfma
-0003cf70: 6b65 2f30 2e31 2e33 322f 7666 735f 666f  ke/0.1.32/vfs_fo
-0003cf80: 6e74 732e 6a73 223e 3c2f 7363 7269 7074  nts.js"></script
-0003cf90: 3e0a 2020 2020 2020 2020 2020 2020 3c73  >.            <s
-0003cfa0: 6372 6970 7420 7479 7065 3d22 7465 7874  cript type="text
-0003cfb0: 2f6a 6176 6173 6372 6970 7422 206c 616e  /javascript" lan
-0003cfc0: 6775 6167 653d 226a 6176 6173 6372 6970  guage="javascrip
-0003cfd0: 7422 2073 7263 3d22 6874 7470 733a 2f2f  t" src="https://
-0003cfe0: 6364 6e2e 6461 7461 7461 626c 6573 2e6e  cdn.datatables.n
-0003cff0: 6574 2f62 7574 746f 6e73 2f31 2e35 2e31  et/buttons/1.5.1
-0003d000: 2f6a 732f 6275 7474 6f6e 732e 6874 6d6c  /js/buttons.html
-0003d010: 352e 6d69 6e2e 6a73 223e 3c2f 7363 7269  5.min.js"></scri
-0003d020: 7074 3e0a 2020 2020 2020 2020 2020 2020  pt>.            
-0003d030: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
-0003d040: 7874 2f6a 6176 6173 6372 6970 7422 206c  xt/javascript" l
-0003d050: 616e 6775 6167 653d 226a 6176 6173 6372  anguage="javascr
-0003d060: 6970 7422 2073 7263 3d22 6874 7470 733a  ipt" src="https:
-0003d070: 2f2f 6364 6e2e 6461 7461 7461 626c 6573  //cdn.datatables
-0003d080: 2e6e 6574 2f62 7574 746f 6e73 2f31 2e35  .net/buttons/1.5
-0003d090: 2e31 2f6a 732f 6275 7474 6f6e 732e 7072  .1/js/buttons.pr
-0003d0a0: 696e 742e 6d69 6e2e 6a73 223e 3c2f 7363  int.min.js"></sc
-0003d0b0: 7269 7074 3e0a 2020 2020 2020 2020 2020  ript>.          
-0003d0c0: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-0003d0d0: 2020 2066 6f72 2069 6c2c 206c 696e 6520     for il, line 
-0003d0e0: 696e 2065 6e75 6d65 7261 7465 286c 696e  in enumerate(lin
-0003d0f0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
-0003d100: 2020 2020 2069 6620 276a 732f 6a71 7565       if 'js/jque
-0003d110: 7279 2e64 6174 6154 6162 6c65 2720 696e  ry.dataTable' in
-0003d120: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
-0003d130: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0003d140: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0003d150: 6573 2e69 6e73 6572 7428 696c 2b32 2c20  es.insert(il+2, 
-0003d160: 6a73 5f73 6372 6970 7473 290a 0a20 2020  js_scripts)..   
-0003d170: 2020 2020 2020 2020 2066 6f72 2069 6c2c           for il,
-0003d180: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
-0003d190: 7465 286c 696e 6573 293a 0a20 2020 2020  te(lines):.     
-0003d1a0: 2020 2020 2020 2020 2020 2069 6620 2770             if 'p
-0003d1b0: 6167 654c 656e 6774 6827 2069 6e20 6c69  ageLength' in li
-0003d1c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003d1d0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-0003d1e0: 2020 2020 2020 2020 2020 2062 7574 746f             butto
-0003d1f0: 6e5f 6f70 7469 6f6e 203d 2027 7b73 7061  n_option = '{spa
-0003d200: 6365 727d 646f 6d3a 205c 2742 6c66 7274  cer}dom: \'Blfrt
-0003d210: 6970 5c27 2c5c 6e7b 7370 6163 6572 7d62  ip\',\n{spacer}b
-0003d220: 7574 746f 6e73 3a20 7b62 7374 727d 2c5c  uttons: {bstr},\
-0003d230: 6e27 2e66 6f72 6d61 7428 7370 6163 6572  n'.format(spacer
-0003d240: 3d27 2027 2a38 2c20 6273 7472 3d62 7574  =' '*8, bstr=but
-0003d250: 746f 6e73 2e5f 5f72 6570 725f 5f28 2929  tons.__repr__())
-0003d260: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0003d270: 6573 2e69 6e73 6572 7428 696c 2b31 2c20  es.insert(il+1, 
-0003d280: 6275 7474 6f6e 5f6f 7074 696f 6e29 0a0a  button_option)..
-0003d290: 2020 2020 2020 2020 2320 5261 6e67 6520          # Range 
-0003d2a0: 636f 6c75 6d6e 730a 2020 2020 2020 2020  columns.        
-0003d2b0: 6963 5f6c 6973 7420 3d20 5b5d 0a0a 2020  ic_list = []..  
-0003d2c0: 2020 2020 2020 6669 6c74 6572 5f6c 696e        filter_lin
-0003d2d0: 6573 203d 205b 223c 7461 626c 653e 5c6e  es = ["<table>\n
-0003d2e0: 225d 0a20 2020 2020 2020 2064 6573 6372  "].        descr
-0003d2f0: 5f70 6164 203d 2027 203c 7370 616e 2073  _pad = ' <span s
-0003d300: 7479 6c65 3d22 6469 7370 6c61 793a 696e  tyle="display:in
-0003d310: 6c69 6e65 2d62 6c6f 636b 3b20 7769 6474  line-block; widt
-0003d320: 683a 3130 3b22 3e3c 2f73 7061 6e3e 2027  h:10;"></span> '
-0003d330: 0a0a 2020 2020 2020 2020 666f 7220 6963  ..        for ic
-0003d340: 2c20 636f 6c20 696e 2065 6e75 6d65 7261  , col in enumera
-0003d350: 7465 2873 656c 662e 636f 6c6e 616d 6573  te(self.colnames
-0003d360: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0003d370: 6620 636f 6c20 696e 2066 696c 7465 725f  f col in filter_
-0003d380: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0003d390: 2020 2020 2020 2020 2066 6f75 6e64 203d           found =
-0003d3a0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0003d3b0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0003d3c0: 7261 6e67 6528 6c65 6e28 6c69 6e65 7329  range(len(lines)
-0003d3d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003d3e0: 2020 2020 2020 2069 6620 273c 7468 3e7b         if '<th>{
-0003d3f0: 307d 272e 666f 726d 6174 2863 6f6c 2920  0}'.format(col) 
-0003d400: 696e 206c 696e 6573 5b69 5d3a 0a20 2020  in lines[i]:.   
-0003d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d420: 2020 2020 2066 6f75 6e64 203d 2054 7275       found = Tru
-0003d430: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0003d440: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0003d450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d460: 2069 6620 666f 756e 643a 0a20 2020 2020   if found:.     
-0003d470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003d480: 2070 7269 6e74 2863 6f6c 290a 2020 2020   print(col).    
-0003d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4a0: 6963 5f6c 6973 742e 6170 7065 6e64 2869  ic_list.append(i
-0003d4b0: 6329 0a20 2020 2020 2020 2020 2020 2020  c).             
-0003d4c0: 2020 2020 2020 2023 6c69 6e65 735b 695d         #lines[i]
-0003d4d0: 203d 206c 696e 6573 5b69 5d2e 7265 706c   = lines[i].repl
-0003d4e0: 6163 6528 636f 6c2c 2027 7b30 7d20 3c62  ace(col, '{0} <b
-0003d4f0: 723e 203c 696e 7075 7420 7479 7065 3d22  r> <input type="
-0003d500: 7465 7874 2220 6964 3d22 7b30 7d5f 6d69  text" id="{0}_mi
-0003d510: 6e22 206e 616d 653d 227b 307d 5f6d 696e  n" name="{0}_min
-0003d520: 2220 7374 796c 653d 2277 6964 7468 3a33  " style="width:3
-0003d530: 3070 783b 223e 203c 696e 7075 7420 7479  0px;"> <input ty
-0003d540: 7065 3d22 7465 7874 2220 6964 3d22 7b30  pe="text" id="{0
-0003d550: 7d5f 6d61 7822 206e 616d 653d 227b 307d  }_max" name="{0}
-0003d560: 5f6d 6178 2220 7374 796c 653d 2277 6964  _max" style="wid
-0003d570: 7468 3a33 3070 783b 223e 272e 666f 726d  th:30px;">'.form
-0003d580: 6174 2863 6f6c 2929 0a0a 2020 2020 2020  at(col))..      
-0003d590: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0003d5a0: 6c74 6572 5f6c 696e 6573 202b 3d20 273c  lter_lines += '<
-0003d5b0: 7472 3e20 3c74 643e 203c 696e 7075 7420  tr> <td> <input 
-0003d5c0: 7479 7065 3d22 7465 7874 2220 6964 3d22  type="text" id="
-0003d5d0: 7b30 7d5f 6d69 6e22 206e 616d 653d 227b  {0}_min" name="{
-0003d5e0: 307d 5f6d 696e 2220 7374 796c 653d 2277  0}_min" style="w
-0003d5f0: 6964 7468 3a34 3070 783b 223e 2026 2336  idth:40px;"> &#6
-0003d600: 303b 203c 2f74 643e 203c 7464 3e20 7b30  0; </td> <td> {0
-0003d610: 7d20 3c2f 7464 3e20 3c74 643e 2020 2623  } </td> <td>  &#
-0003d620: 3630 3b20 3c69 6e70 7574 2074 7970 653d  60; <input type=
-0003d630: 2274 6578 7422 2069 643d 227b 307d 5f6d  "text" id="{0}_m
-0003d640: 6178 2220 6e61 6d65 3d22 7b30 7d5f 6d61  ax" name="{0}_ma
-0003d650: 7822 2073 7479 6c65 3d22 7769 6474 683a  x" style="width:
-0003d660: 3430 7078 3b22 3e27 2e66 6f72 6d61 7428  40px;">'.format(
-0003d670: 636f 6c29 0a20 2020 2020 2020 2020 2020  col).           
-0003d680: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0003d690: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003d6a0: 7363 7220 3d20 275c 6e27 0a20 2020 2020  scr = '\n'.     
-0003d6b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003d6c0: 6620 6861 7361 7474 7228 7365 6c66 2e63  f hasattr(self.c
-0003d6d0: 6f6c 756d 6e73 5b63 6f6c 5d2c 2027 6465  olumns[col], 'de
-0003d6e0: 7363 7269 7074 696f 6e27 293a 0a20 2020  scription'):.   
-0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d700: 2020 2020 2069 6620 7365 6c66 2e63 6f6c       if self.col
-0003d710: 756d 6e73 5b63 6f6c 5d2e 6465 7363 7269  umns[col].descri
-0003d720: 7074 696f 6e20 6973 206e 6f74 204e 6f6e  ption is not Non
-0003d730: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003d740: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003d750: 6573 6372 203d 2027 7b30 7d20 7b31 7d5c  escr = '{0} {1}\
-0003d760: 6e27 2e66 6f72 6d61 7428 6465 7363 725f  n'.format(descr_
-0003d770: 7061 642c 200a 2020 2020 2020 2020 2020  pad, .          
-0003d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7a0: 2020 7365 6c66 2e63 6f6c 756d 6e73 5b63    self.columns[c
-0003d7b0: 6f6c 5d2e 6465 7363 7269 7074 696f 6e29  ol].description)
-0003d7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0003d800: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0003d810: 6c74 6572 5f6c 696e 6573 202b 3d20 6465  lter_lines += de
-0003d820: 7363 720a 2020 2020 2020 2020 2020 2020  scr.            
-0003d830: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0003d840: 2069 6620 6963 5f6c 6973 743a 0a20 2020   if ic_list:.   
-0003d850: 2020 2020 2020 2020 2023 2049 6e73 6572           # Inser
-0003d860: 7420 696e 7075 7420 6c69 6e65 730a 0a20  t input lines.. 
-0003d870: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0003d880: 6c2c 206c 696e 6520 696e 2065 6e75 6d65  l, line in enume
-0003d890: 7261 7465 286c 696e 6573 293a 0a20 2020  rate(lines):.   
-0003d8a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003d8b0: 277d 2029 3b20 203c 2f73 6372 6970 743e  '} );  </script>
-0003d8c0: 2720 696e 206c 696e 653a 0a20 2020 2020  ' in line:.     
-0003d8d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003d8e0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-0003d8f0: 200a 2020 2020 2020 2020 2020 2020 6669   .            fi
-0003d900: 6c74 6572 5f72 6f77 203d 2027 3c74 723e  lter_row = '<tr>
-0003d910: 203c 7464 3e20 3c69 6e70 7574 2074 7970   <td> <input typ
-0003d920: 653d 2274 6578 7422 2069 643d 227b 307d  e="text" id="{0}
-0003d930: 5f6d 696e 2220 6e61 6d65 3d22 7b30 7d5f  _min" name="{0}_
-0003d940: 6d69 6e22 2073 7479 6c65 3d22 7769 6474  min" style="widt
-0003d950: 683a 3430 7078 3b22 3e20 2623 3630 3b20  h:40px;"> &#60; 
-0003d960: 3c2f 7464 3e20 3c74 6420 7374 796c 653d  </td> <td style=
-0003d970: 2261 6c69 676e 3a63 656e 7465 723b 223e  "align:center;">
-0003d980: 203c 7474 3e7b 307d 3c2f 7474 3e20 3c2f   <tt>{0}</tt> </
-0003d990: 7464 3e20 3c74 643e 2020 2623 3630 3b20  td> <td>  &#60; 
-0003d9a0: 3c69 6e70 7574 2074 7970 653d 2274 6578  <input type="tex
-0003d9b0: 7422 2069 643d 227b 307d 5f6d 6178 2220  t" id="{0}_max" 
-0003d9c0: 6e61 6d65 3d22 7b30 7d5f 6d61 7822 2073  name="{0}_max" s
-0003d9d0: 7479 6c65 3d22 7769 6474 683a 3430 7078  tyle="width:40px
-0003d9e0: 3b22 3e27 0a20 2020 2020 2020 2020 2020  ;">'.           
-0003d9f0: 200a 2020 2020 2020 2020 2020 2020 6669   .            fi
-0003da00: 6c74 6572 5f72 6f77 7320 3d20 5b5d 0a20  lter_rows = []. 
-0003da10: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0003da20: 6320 696e 2069 635f 6c69 7374 3a0a 2020  c in ic_list:.  
-0003da30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003da40: 6c20 3d20 7365 6c66 2e63 6f6c 6e61 6d65  l = self.colname
-0003da50: 735b 6963 5d0a 2020 2020 2020 2020 2020  s[ic].          
-0003da60: 2020 2020 2020 726f 775f 6920 3d20 6669        row_i = fi
-0003da70: 6c74 6572 5f72 6f77 2e66 6f72 6d61 7428  lter_row.format(
-0003da80: 636f 6c29 0a20 2020 2020 2020 2020 2020  col).           
-0003da90: 2020 2020 2064 6573 6372 203d 2027 5c6e       descr = '\n
-0003daa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0003dab0: 2020 6966 2068 6173 6174 7472 2873 656c    if hasattr(sel
-0003dac0: 662e 636f 6c75 6d6e 735b 636f 6c5d 2c20  f.columns[col], 
-0003dad0: 2764 6573 6372 6970 7469 6f6e 2729 3a0a  'description'):.
-0003dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003daf0: 2020 2020 6966 2073 656c 662e 636f 6c75      if self.colu
-0003db00: 6d6e 735b 636f 6c5d 2e64 6573 6372 6970  mns[col].descrip
-0003db10: 7469 6f6e 2069 7320 6e6f 7420 4e6f 6e65  tion is not None
-0003db20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003db30: 2020 2020 2020 2020 2020 6465 7363 7220            descr 
-0003db40: 3d20 277b 307d 207b 317d 5c6e 272e 666f  = '{0} {1}\n'.fo
-0003db50: 726d 6174 2864 6573 6372 5f70 6164 2c20  rmat(descr_pad, 
-0003db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003db80: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-0003db90: 6c75 6d6e 735b 636f 6c5d 2e64 6573 6372  lumns[col].descr
-0003dba0: 6970 7469 6f6e 290a 2020 2020 2020 2020  iption).        
-0003dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dbd0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0003dbe0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0003dbf0: 7465 725f 726f 7773 2e61 7070 656e 6428  ter_rows.append(
-0003dc00: 726f 775f 6920 2b20 6465 7363 7229 0a20  row_i + descr). 
-0003dc10: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0003dc20: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
-0003dc30: 6572 5f69 6e70 7574 203d 2022 2222 0a0a  er_input = """..
-0003dc40: 3c64 6976 2073 7479 6c65 3d22 626f 7264  <div style="bord
-0003dc50: 6572 3a31 7078 2073 6f6c 6964 2062 6c61  er:1px solid bla
-0003dc60: 636b 3b20 7061 6464 696e 673a 3130 7078  ck; padding:10px
-0003dc70: 3b20 6d61 7267 696e 3a31 3070 7822 3e0a  ; margin:10px">.
-0003dc80: 3c62 3e20 4669 6c74 6572 3a20 3c2f 623e  <b> Filter: </b>
-0003dc90: 0a20 2020 203c 7461 626c 653e 0a20 2020  .    <table>.   
-0003dca0: 2020 207b 307d 0a20 2020 203c 2f74 6162     {0}.    </tab
-0003dcb0: 6c65 3e0a 3c2f 6469 763e 0a0a 2222 222e  le>.</div>..""".
-0003dcc0: 666f 726d 6174 2827 5c6e 272e 6a6f 696e  format('\n'.join
-0003dcd0: 2866 696c 7465 725f 726f 7773 2929 0a0a  (filter_rows))..
-0003dce0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0003dcf0: 732e 696e 7365 7274 2869 6c2b 312c 2066  s.insert(il+1, f
-0003dd00: 696c 7465 725f 696e 7075 7429 0a0a 2020  ilter_input)..  
-0003dd10: 2020 2020 2020 2020 2020 2320 4a61 7661            # Java
-0003dd20: 7363 7269 7074 2070 7573 6820 6675 6e63  script push func
-0003dd30: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-0003dd40: 2068 6561 6465 725f 6c69 6e65 7320 3d20   header_lines = 
-0003dd50: 2222 0a20 2020 2020 2020 2020 2020 2074  "".            t
-0003dd60: 6573 7465 7220 3d20 5b5d 0a0a 2020 2020  ester = []..    
-0003dd70: 2020 2020 2020 2020 666f 7220 6963 2069          for ic i
-0003dd80: 6e20 6963 5f6c 6973 743a 0a20 2020 2020  n ic_list:.     
-0003dd90: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-0003dda0: 725f 6c69 6e65 7320 2b3d 2022 2222 0a20  r_lines += """. 
-0003ddb0: 2020 2020 2020 2076 6172 206d 696e 5f7b         var min_{
-0003ddc0: 307d 203d 2070 6172 7365 466c 6f61 7428  0} = parseFloat(
-0003ddd0: 2024 2827 237b 307d 5f6d 696e 2729 2e76   $('#{0}_min').v
-0003dde0: 616c 2829 2920 7c7c 202d 3165 3330 3b0a  al()) || -1e30;.
-0003ddf0: 2020 2020 2020 2020 7661 7220 6d61 785f          var max_
-0003de00: 7b30 7d20 3d20 7061 7273 6546 6c6f 6174  {0} = parseFloat
-0003de10: 2820 2428 2723 7b30 7d5f 6d61 7827 292e  ( $('#{0}_max').
-0003de20: 7661 6c28 2929 207c 7c20 2031 6533 303b  val()) ||  1e30;
-0003de30: 0a20 2020 2020 2020 2076 6172 2064 6174  .        var dat
-0003de40: 615f 7b30 7d20 3d20 7061 7273 6546 6c6f  a_{0} = parseFlo
-0003de50: 6174 2820 6461 7461 5b7b 317d 5d20 2920  at( data[{1}] ) 
-0003de60: 7c7c 2030 3b0a 2020 2020 2020 2020 2020  || 0;.          
-0003de70: 2020 2020 2020 2222 222e 666f 726d 6174        """.format
-0003de80: 2873 656c 662e 636f 6c6e 616d 6573 5b69  (self.colnames[i
-0003de90: 635d 2c20 6963 290a 0a20 2020 2020 2020  c], ic)..       
-0003dea0: 2020 2020 2020 2020 2074 6573 7465 722e           tester.
-0003deb0: 6170 7065 6e64 2822 2222 2820 2820 6973  append("""( ( is
-0003dec0: 4e61 4e28 206d 696e 5f7b 307d 2029 2026  NaN( min_{0} ) &
-0003ded0: 2620 6973 4e61 4e28 206d 6178 5f7b 307d  & isNaN( max_{0}
-0003dee0: 2029 2029 207c 7c20 2820 6973 4e61 4e28   ) ) || ( isNaN(
-0003def0: 206d 696e 5f7b 307d 2029 2026 2620 6461   min_{0} ) && da
-0003df00: 7461 5f7b 307d 203c 3d20 6d61 785f 7b30  ta_{0} <= max_{0
-0003df10: 7d20 2920 7c7c 2028 206d 696e 5f7b 307d  } ) || ( min_{0}
-0003df20: 203c 3d20 6461 7461 5f7b 307d 2020 2626   <= data_{0}  &&
-0003df30: 2069 734e 614e 2820 6d61 785f 7b30 7d20   isNaN( max_{0} 
-0003df40: 2920 2920 7c7c 2028 206d 696e 5f7b 307d  ) ) || ( min_{0}
-0003df50: 203c 3d20 6461 7461 5f7b 307d 2020 2626   <= data_{0}  &&
-0003df60: 2064 6174 615f 7b30 7d20 3c3d 206d 6178   data_{0} <= max
-0003df70: 5f7b 307d 2029 2029 2222 222e 666f 726d  _{0} ) )""".form
-0003df80: 6174 2873 656c 662e 636f 6c6e 616d 6573  at(self.colnames
-0003df90: 5b69 635d 2929 0a0a 2020 2020 2020 2020  [ic]))..        
-0003dfa0: 2020 2020 2320 4a61 7661 7363 7269 7074      # Javascript
-0003dfb0: 2066 696c 7465 7220 6675 6e63 7469 6f6e   filter function
-0003dfc0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0003dfd0: 7465 725f 6675 6e63 7469 6f6e 203d 2022  ter_function = "
-0003dfe0: 2222 0a0a 2f2f 2f2f 2050 6172 7365 720a  ""..//// Parser.
-0003dff0: 2f2f 2068 7474 7073 3a2f 2f73 7461 636b  // https://stack
-0003e000: 6f76 6572 666c 6f77 2e63 6f6d 2f71 7565  overflow.com/que
-0003e010: 7374 696f 6e73 2f31 3934 3931 3333 362f  stions/19491336/
-0003e020: 6765 742d 7572 6c2d 7061 7261 6d65 7465  get-url-paramete
-0003e030: 722d 6a71 7565 7279 2d6f 722d 686f 772d  r-jquery-or-how-
-0003e040: 746f 2d67 6574 2d71 7565 7279 2d73 7472  to-get-query-str
-0003e050: 696e 672d 7661 6c75 6573 2d69 6e2d 6a73  ing-values-in-js
-0003e060: 2040 2052 657a 6120 4261 7261 6461 7261   @ Reza Baradara
-0003e070: 6e0a 242e 7572 6c50 6172 616d 203d 2066  n.$.urlParam = f
-0003e080: 756e 6374 696f 6e28 6e61 6d65 297b 7b0a  unction(name){{.
-0003e090: 2020 2020 7661 7220 7265 7375 6c74 7320      var results 
-0003e0a0: 3d20 6e65 7720 5265 6745 7870 2827 5b5c  = new RegExp('[\
-0003e0b0: 3f26 5d27 202b 206e 616d 6520 2b20 273d  ?&]' + name + '=
-0003e0c0: 285b 5e26 235d 2a29 2729 2e65 7865 6328  ([^&#]*)').exec(
-0003e0d0: 7769 6e64 6f77 2e6c 6f63 6174 696f 6e2e  window.location.
-0003e0e0: 6872 6566 293b 0a20 2020 2069 6620 2872  href);.    if (r
-0003e0f0: 6573 756c 7473 3d3d 6e75 6c6c 297b 7b0a  esults==null){{.
-0003e100: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
-0003e110: 6c6c 3b0a 2020 2020 7d7d 0a20 2020 2065  ll;.    }}.    e
-0003e120: 6c73 657b 7b0a 2020 2020 2020 2072 6574  lse{{.       ret
-0003e130: 7572 6e20 6465 636f 6465 5552 4928 7265  urn decodeURI(re
-0003e140: 7375 6c74 735b 315d 2920 7c7c 2030 3b0a  sults[1]) || 0;.
-0003e150: 2020 2020 7d7d 0a7d 7d0a 0a24 2e66 6e2e      }}.}}..$.fn.
-0003e160: 6461 7461 5461 626c 652e 6578 742e 7365  dataTable.ext.se
-0003e170: 6172 6368 2e70 7573 6828 0a20 2020 2066  arch.push(.    f
-0003e180: 756e 6374 696f 6e28 2073 6574 7469 6e67  unction( setting
-0003e190: 732c 2064 6174 612c 2064 6174 6149 6e64  s, data, dataInd
-0003e1a0: 6578 2029 207b 7b0a 7b30 7d0a 0a20 2020  ex ) {{.{0}..   
-0003e1b0: 2020 2020 2069 6620 2820 7b31 7d20 290a       if ( {1} ).
-0003e1c0: 2020 2020 2020 2020 7b7b 0a20 2020 2020          {{.     
-0003e1d0: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
-0003e1e0: 7565 3b0a 2020 2020 2020 2020 7d7d 0a20  ue;.        }}. 
-0003e1f0: 2020 2020 2020 2072 6574 7572 6e20 6661         return fa
-0003e200: 6c73 653b 0a20 2020 207d 7d0a 293b 0a0a  lse;.    }}.);..
-0003e210: 2f2f 2f2f 2055 7064 6174 6520 5552 4c20  //// Update URL 
-0003e220: 7769 7468 2066 696c 7465 7220 7061 7261  with filter para
-0003e230: 6d65 7465 7273 0a76 6172 2066 696c 7465  meters.var filte
-0003e240: 725f 7061 7261 6d73 203d 207b 327d 3b0a  r_params = {2};.
-0003e250: 0a24 2e55 7064 6174 6546 696c 7465 7255  .$.UpdateFilterU
-0003e260: 524c 203d 2066 756e 6374 696f 6e20 2829  RL = function ()
-0003e270: 207b 7b0a 2020 2020 7661 7220 693b 0a20   {{.    var i;. 
-0003e280: 2020 2076 6172 2066 696c 7465 725f 7572     var filter_ur
-0003e290: 6c20 3d20 2222 3b0a 2020 2020 666f 7220  l = "";.    for 
-0003e2a0: 2869 203d 2030 3b20 6920 3c20 6669 6c74  (i = 0; i < filt
-0003e2b0: 6572 5f70 6172 616d 732e 6c65 6e67 7468  er_params.length
-0003e2c0: 3b20 692b 2b29 207b 7b0a 2020 2020 2020  ; i++) {{.      
-0003e2d0: 2020 6966 2028 2428 2723 272b 6669 6c74    if ($('#'+filt
-0003e2e0: 6572 5f70 6172 616d 735b 695d 2b27 5f6d  er_params[i]+'_m
-0003e2f0: 696e 2729 2e76 616c 2829 2021 3d20 2222  in').val() != ""
-0003e300: 2920 7b7b 0a20 2020 2020 2020 2020 2020  ) {{.           
-0003e310: 2066 696c 7465 725f 7572 6c20 2b3d 2027   filter_url += '
-0003e320: 2627 2b66 696c 7465 725f 7061 7261 6d73  &'+filter_params
-0003e330: 5b69 5d2b 275f 6d69 6e3d 272b 0a20 2020  [i]+'_min='+.   
-0003e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e350: 2024 2827 2327 2b66 696c 7465 725f 7061   $('#'+filter_pa
-0003e360: 7261 6d73 5b69 5d2b 275f 6d69 6e27 292e  rams[i]+'_min').
-0003e370: 7661 6c28 293b 0a20 2020 2020 2020 207d  val();.        }
-0003e380: 7d0a 2020 2020 2020 2020 6966 2028 2428  }.        if ($(
-0003e390: 2723 272b 6669 6c74 6572 5f70 6172 616d  '#'+filter_param
-0003e3a0: 735b 695d 2b27 5f6d 6178 2729 2e76 616c  s[i]+'_max').val
-0003e3b0: 2829 2021 3d20 2222 2920 7b7b 0a20 2020  () != "") {{.   
-0003e3c0: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
-0003e3d0: 7572 6c20 2b3d 2027 2627 2b66 696c 7465  url += '&'+filte
-0003e3e0: 725f 7061 7261 6d73 5b69 5d2b 275f 6d61  r_params[i]+'_ma
-0003e3f0: 783d 272b 0a20 2020 2020 2020 2020 2020  x='+.           
-0003e400: 2020 2020 2020 2020 2024 2827 2327 2b66           $('#'+f
-0003e410: 696c 7465 725f 7061 7261 6d73 5b69 5d2b  ilter_params[i]+
-0003e420: 275f 6d61 7827 292e 7661 6c28 293b 0a20  '_max').val();. 
-0003e430: 2020 2020 2020 207d 7d0a 2020 2020 7d7d         }}.    }}
-0003e440: 0a0a 2020 2020 6966 2028 6669 6c74 6572  ..    if (filter
-0003e450: 5f75 726c 2021 3d20 2222 2920 7b7b 0a20  _url != "") {{. 
-0003e460: 2020 2020 2020 2076 6172 2066 696c 7465         var filte
-0003e470: 7265 645f 7572 6c20 3d20 7769 6e64 6f77  red_url = window
-0003e480: 2e6c 6f63 6174 696f 6e2e 6872 6566 2e73  .location.href.s
-0003e490: 706c 6974 2827 3f27 295b 305d 202b 2027  plit('?')[0] + '
-0003e4a0: 3f27 202b 2066 696c 7465 725f 7572 6c3b  ?' + filter_url;
-0003e4b0: 0a20 2020 2020 2020 2077 696e 646f 772e  .        window.
-0003e4c0: 6869 7374 6f72 792e 7075 7368 5374 6174  history.pushStat
-0003e4d0: 6528 2727 2c20 2727 2c20 6669 6c74 6572  e('', '', filter
-0003e4e0: 6564 5f75 726c 293b 0a20 2020 207d 7d0a  ed_url);.    }}.
-0003e4f0: 7d7d 5c6e 5c6e 2222 222e 666f 726d 6174  }}\n\n""".format
-0003e500: 2868 6561 6465 725f 6c69 6e65 732c 2022  (header_lines, "
-0003e510: 5c6e 2026 2620 222e 6a6f 696e 2874 6573  \n && ".join(tes
-0003e520: 7465 7229 2c20 5b73 656c 662e 636f 6c6e  ter), [self.coln
-0003e530: 616d 6573 5b69 635d 2066 6f72 2069 6320  ames[ic] for ic 
-0003e540: 696e 2069 635f 6c69 7374 5d2e 5f5f 7265  in ic_list].__re
-0003e550: 7072 5f5f 2829 290a 0a20 2020 2020 2020  pr__())..       
-0003e560: 2020 2020 2066 6f72 2069 2c20 6c69 6e65       for i, line
-0003e570: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
-0003e580: 6e65 7329 3a0a 2020 2020 2020 2020 2020  nes):.          
-0003e590: 2020 2020 2020 6966 2022 2428 646f 6375        if "$(docu
-0003e5a0: 6d65 6e74 292e 7265 6164 7928 6675 6e63  ment).ready(func
-0003e5b0: 7469 6f6e 2829 2220 696e 206c 696e 653a  tion()" in line:
-0003e5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e5d0: 2020 2020 2069 7374 6172 7420 3d20 690a       istart = i.
-0003e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e5f0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003e600: 2020 2020 2020 206c 696e 6573 2e69 6e73         lines.ins
-0003e610: 6572 7428 6973 7461 7274 2c20 6669 6c74  ert(istart, filt
-0003e620: 6572 5f66 756e 6374 696f 6e29 0a0a 2020  er_function)..  
-0003e630: 2020 2020 2020 2020 2020 2320 5061 7273            # Pars
-0003e640: 6520 6164 6472 6573 7320 6261 720a 2020  e address bar.  
-0003e650: 2020 2020 2020 2020 2020 6c69 6e65 732e            lines.
-0003e660: 696e 7365 7274 2869 7374 6172 742b 322c  insert(istart+2,
-0003e670: 2022 5c6e 2229 0a20 2020 2020 2020 2020   "\n").         
-0003e680: 2020 2066 6f72 2069 6320 696e 2069 635f     for ic in ic_
-0003e690: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-0003e6a0: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
-0003e6b0: 7274 2869 7374 6172 742b 322c 2022 7b31  rt(istart+2, "{1
-0003e6c0: 7d24 2827 237b 307d 5f6d 6178 2729 2e76  }$('#{0}_max').v
-0003e6d0: 616c 2824 2e75 726c 5061 7261 6d28 277b  al($.urlParam('{
-0003e6e0: 307d 5f6d 6178 2729 293b 5c6e 222e 666f  0}_max'));\n".fo
-0003e6f0: 726d 6174 2873 656c 662e 636f 6c6e 616d  rmat(self.colnam
-0003e700: 6573 5b69 635d 2c20 2720 272a 3329 290a  es[ic], ' '*3)).
-0003e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e720: 6c69 6e65 732e 696e 7365 7274 2869 7374  lines.insert(ist
-0003e730: 6172 742b 322c 2022 7b31 7d24 2827 237b  art+2, "{1}$('#{
-0003e740: 307d 5f6d 696e 2729 2e76 616c 2824 2e75  0}_min').val($.u
-0003e750: 726c 5061 7261 6d28 277b 307d 5f6d 696e  rlParam('{0}_min
-0003e760: 2729 293b 5c6e 222e 666f 726d 6174 2873  '));\n".format(s
-0003e770: 656c 662e 636f 6c6e 616d 6573 5b69 635d  elf.colnames[ic]
-0003e780: 2c20 2720 272a 3329 290a 2020 2020 2020  , ' '*3)).      
-0003e790: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
-0003e7a0: 7274 2869 7374 6172 742b 322c 2022 5c6e  rt(istart+2, "\n
-0003e7b0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-0003e7c0: 2320 496e 7075 7420 6c69 7374 656e 6572  # Input listener
-0003e7d0: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
-0003e7e0: 7465 6e65 7220 3d20 2222 220a 2020 2020  tener = """.    
-0003e7f0: 2f2f 2045 7665 6e74 206c 6973 7465 6e65  // Event listene
-0003e800: 7220 746f 2074 6865 2074 776f 2072 616e  r to the two ran
-0003e810: 6765 2066 696c 7465 7269 6e67 2069 6e70  ge filtering inp
-0003e820: 7574 7320 746f 2072 6564 7261 7720 6f6e  uts to redraw on
-0003e830: 2069 6e70 7574 0a20 2020 2024 2827 7b30   input.    $('{0
-0003e840: 7d27 292e 6b65 7975 7028 2066 756e 6374  }').keyup( funct
-0003e850: 696f 6e28 2920 7b7b 0a20 2020 2020 2020  ion() {{.       
-0003e860: 2074 6162 6c65 2e64 7261 7728 293b 0a20   table.draw();. 
-0003e870: 2020 2020 2020 2024 2e55 7064 6174 6546         $.UpdateF
-0003e880: 696c 7465 7255 524c 2829 3b0a 2020 2020  ilterURL();.    
-0003e890: 7d7d 2029 3b0a 2020 2020 2020 2020 2020  }} );.          
-0003e8a0: 2020 2222 222e 666f 726d 6174 2827 2c20    """.format(', 
-0003e8b0: 272e 6a6f 696e 285b 2723 7b30 7d5f 6d69  '.join(['#{0}_mi
-0003e8c0: 6e2c 2023 7b30 7d5f 6d61 7827 2e66 6f72  n, #{0}_max'.for
-0003e8d0: 6d61 7428 7365 6c66 2e63 6f6c 6e61 6d65  mat(self.colname
-0003e8e0: 735b 6963 5d29 2066 6f72 2069 6320 696e  s[ic]) for ic in
-0003e8f0: 2069 635f 6c69 7374 5d29 290a 0a20 2020   ic_list]))..   
-0003e900: 2020 2020 2020 2020 2066 6f72 2069 6c2c           for il,
-0003e910: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
-0003e920: 7465 286c 696e 6573 293a 0a20 2020 2020  te(lines):.     
-0003e930: 2020 2020 2020 2020 2020 2069 6620 277d             if '}
-0003e940: 2029 3b20 203c 2f73 6372 6970 743e 2720   );  </script>' 
-0003e950: 696e 206c 696e 653a 0a20 2020 2020 2020  in line:.       
-0003e960: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0003e970: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0003e980: 6c69 6e65 732e 696e 7365 7274 2869 6c2c  lines.insert(il,
-0003e990: 206c 6973 7465 6e65 7229 0a0a 2020 2020   listener)..    
-0003e9a0: 2020 2020 2020 2020 6670 203d 206f 7065          fp = ope
-0003e9b0: 6e28 6f75 7470 7574 2c20 2777 2729 0a20  n(output, 'w'). 
-0003e9c0: 2020 2020 2020 2020 2020 2066 702e 7772             fp.wr
-0003e9d0: 6974 656c 696e 6573 286c 696e 6573 290a  itelines(lines).
-0003e9e0: 2020 2020 2020 2020 2020 2020 6670 2e63              fp.c
-0003e9f0: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
-0003ea00: 6966 2074 6f67 676c 653a 0a20 2020 2020  if toggle:.     
-0003ea10: 2020 2020 2020 206c 696e 6573 203d 206f         lines = o
-0003ea20: 7065 6e28 6f75 7470 7574 292e 7265 6164  pen(output).read
-0003ea30: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
-0003ea40: 2020 2020 2023 2043 6861 6e67 6520 6361       # Change ca
-0003ea50: 6c6c 2074 6f20 4461 7461 5461 626c 650a  ll to DataTable.
-0003ea60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0003ea70: 696c 2c20 6c69 6e65 2069 6e20 656e 756d  il, line in enum
-0003ea80: 6572 6174 6528 6c69 6e65 7329 3a0a 2020  erate(lines):.  
-0003ea90: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003eaa0: 2027 6461 7461 5461 626c 6528 2720 696e   'dataTable(' in
-0003eab0: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
-0003eac0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0003ead0: 0a0a 2020 2020 2020 2020 2020 2020 6c69  ..            li
-0003eae0: 6e65 735b 696c 5d20 3d20 2220 2020 7661  nes[il] = "   va
-0003eaf0: 7220 7461 626c 6520 3d20 7b30 7d5c 6e22  r table = {0}\n"
-0003eb00: 2e66 6f72 6d61 7428 6c69 6e65 735b 696c  .format(lines[il
-0003eb10: 5d2e 7374 7269 7028 292e 7265 706c 6163  ].strip().replac
-0003eb20: 6528 2764 6174 6154 6162 6c65 272c 2027  e('dataTable', '
-0003eb30: 4461 7461 5461 626c 6527 2929 0a0a 2020  DataTable'))..  
-0003eb40: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
-0003eb50: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-0003eb60: 2020 2020 2066 6f72 2069 6c2c 206c 696e       for il, lin
-0003eb70: 6520 696e 2065 6e75 6d65 7261 7465 286c  e in enumerate(l
-0003eb80: 696e 6573 293a 0a20 2020 2020 2020 2020  ines):.         
-0003eb90: 2020 2020 2020 2069 6620 277d 2029 3b20         if '} ); 
-0003eba0: 203c 2f73 6372 6970 743e 2720 696e 206c   </script>' in l
-0003ebb0: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
-0003ebc0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0003ebd0: 2020 2020 2020 2020 2020 2020 746f 6767              togg
-0003ebe0: 6c65 7220 3d20 2222 220a 2020 2020 2428  ler = """.    $(
-0003ebf0: 2761 2e74 6f67 676c 652d 7669 7327 292e  'a.toggle-vis').
-0003ec00: 6f6e 2820 2763 6c69 636b 272c 2066 756e  on( 'click', fun
-0003ec10: 6374 696f 6e20 2865 2920 7b0a 2020 2020  ction (e) {.    
-0003ec20: 2020 2020 652e 7072 6576 656e 7444 6566      e.preventDef
-0003ec30: 6175 6c74 2829 3b0a 0a20 2020 2020 2020  ault();..       
-0003ec40: 202f 2f20 4765 7420 7468 6520 636f 6c75   // Get the colu
-0003ec50: 6d6e 2041 5049 206f 626a 6563 740a 2020  mn API object.  
-0003ec60: 2020 2020 2020 7661 7220 636f 6c75 6d6e        var column
-0003ec70: 203d 2074 6162 6c65 2e63 6f6c 756d 6e28   = table.column(
-0003ec80: 2024 2874 6869 7329 2e61 7474 7228 2764   $(this).attr('d
-0003ec90: 6174 612d 636f 6c75 6d6e 2729 2029 3b0a  ata-column') );.
-0003eca0: 0a20 2020 2020 2020 202f 2f20 546f 6767  .        // Togg
-0003ecb0: 6c65 2074 6865 2076 6973 6962 696c 6974  le the visibilit
-0003ecc0: 790a 2020 2020 2020 2020 636f 6c75 6d6e  y.        column
-0003ecd0: 2e76 6973 6962 6c65 2820 2120 636f 6c75  .visible( ! colu
-0003ece0: 6d6e 2e76 6973 6962 6c65 2829 2029 3b0a  mn.visible() );.
-0003ecf0: 2020 2020 7d20 293b 0a0a 2020 2020 2020      } );..      
-0003ed00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003ed10: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
-0003ed20: 7274 2869 6c2c 2074 6f67 676c 6572 290a  rt(il, toggler).
-0003ed30: 0a20 2020 2020 2020 2020 2020 2074 6f67  .            tog
-0003ed40: 676c 655f 6469 7620 3d20 2222 220a 3c64  gle_div = """.<d
-0003ed50: 6976 2073 7479 6c65 3d22 626f 7264 6572  iv style="border
-0003ed60: 3a31 7078 2073 6f6c 6964 2062 6c61 636b  :1px solid black
-0003ed70: 3b20 7061 6464 696e 673a 3130 7078 3b20  ; padding:10px; 
-0003ed80: 6d61 7267 696e 3a31 3070 7822 3e0a 2020  margin:10px">.  
-0003ed90: 2020 3c62 3e54 6f67 676c 6520 636f 6c75    <b>Toggle colu
-0003eda0: 6d6e 3a3c 2f62 3e3c 2f62 723e 207b 307d  mn:</b></br> {0}
-0003edb0: 0a3c 2f64 6976 3e0a 0a20 2020 2020 2020  .</div>..       
-0003edc0: 2020 2020 2022 2222 2e66 6f72 6d61 7428       """.format(
-0003edd0: 2720 3c62 3e2f 3c2f 623e 2027 2e6a 6f69  ' <b>/</b> '.joi
-0003ede0: 6e28 5b27 3c61 2063 6c61 7373 3d22 746f  n(['<a class="to
-0003edf0: 6767 6c65 2d76 6973 2220 6461 7461 2d63  ggle-vis" data-c
-0003ee00: 6f6c 756d 6e3d 227b 307d 223e 203c 7474  olumn="{0}"> <tt
-0003ee10: 3e7b 317d 3c2f 7474 3e20 3c2f 613e 272e  >{1}</tt> </a>'.
-0003ee20: 666f 726d 6174 2869 632c 2063 6f6c 2920  format(ic, col) 
-0003ee30: 666f 7220 6963 2c20 636f 6c20 696e 2065  for ic, col in e
-0003ee40: 6e75 6d65 7261 7465 2873 656c 662e 636f  numerate(self.co
-0003ee50: 6c6e 616d 6573 295d 2929 0a0a 2020 2020  lnames)]))..    
-0003ee60: 2020 2020 2020 2020 6c69 6e65 732e 696e          lines.in
-0003ee70: 7365 7274 2869 6c2b 322c 2074 6f67 676c  sert(il+2, toggl
-0003ee80: 655f 6469 7629 0a0a 2020 2020 2020 2020  e_div)..        
-0003ee90: 2020 2020 6670 203d 206f 7065 6e28 6f75      fp = open(ou
-0003eea0: 7470 7574 2c20 2777 2729 0a20 2020 2020  tput, 'w').     
-0003eeb0: 2020 2020 2020 2066 702e 7772 6974 656c         fp.writel
-0003eec0: 696e 6573 286c 696e 6573 290a 2020 2020  ines(lines).    
-0003eed0: 2020 2020 2020 2020 6670 2e63 6c6f 7365          fp.close
-0003eee0: 2829 0a0a 2020 2020 2020 2020 6966 2075  ()..        if u
-0003eef0: 7365 5f6a 736f 6e3a 0a20 2020 2020 2020  se_json:.       
-0003ef00: 2020 2020 2023 2057 7269 7465 2061 7320       # Write as 
-0003ef10: 6a73 6f6e 0a0a 2020 2020 2020 2020 2020  json..          
-0003ef20: 2020 2320 576f 726b 6172 6f75 6e64 2074    # Workaround t
-0003ef30: 6f20 6765 7420 6173 6369 6920 666f 726d  o get ascii form
-0003ef40: 6174 7469 6e67 0a20 2020 2020 2020 2020  atting.         
-0003ef50: 2020 2023 7064 203d 2073 656c 662e 746f     #pd = self.to
-0003ef60: 5f70 616e 6461 7328 290a 2020 2020 2020  _pandas().      
-0003ef70: 2020 2020 2020 6e65 7720 3d20 4754 6162        new = GTab
-0003ef80: 6c65 2829 0a20 2020 2020 2020 2020 2020  le().           
-0003ef90: 2066 6f72 2063 2069 6e20 7365 6c66 2e63   for c in self.c
-0003efa0: 6f6c 6e61 6d65 733a 0a20 2020 2020 2020  olnames:.       
-0003efb0: 2020 2020 2020 2020 206e 6577 5b63 5d20           new[c] 
-0003efc0: 3d20 7365 6c66 5b63 5d0a 0a20 2020 2020  = self[c]..     
-0003efd0: 2020 2020 2020 2069 6620 2761 6c61 6469         if 'aladi
-0003efe0: 6e27 2069 6e20 7365 6c66 2e63 6f6c 6e61  n' in self.colna
-0003eff0: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
-0003f000: 2020 2020 2070 6420 3d20 4754 6162 6c65       pd = GTable
-0003f010: 286e 6577 292e 746f 5f70 616e 6461 7328  (new).to_pandas(
-0003f020: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0003f030: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003f040: 2020 2020 6e65 772e 7772 6974 6528 272f      new.write('/
-0003f050: 746d 702f 7461 626c 652e 6373 7627 2c20  tmp/table.csv', 
-0003f060: 666f 726d 6174 3d27 6373 7627 2c20 6f76  format='csv', ov
-0003f070: 6572 7772 6974 653d 5472 7565 290a 2020  erwrite=True).  
-0003f080: 2020 2020 2020 2020 2020 2020 2020 7064                pd
-0003f090: 203d 2047 5461 626c 652e 6772 6561 6428   = GTable.gread(
-0003f0a0: 272f 746d 702f 7461 626c 652e 6373 7627  '/tmp/table.csv'
-0003f0b0: 292e 746f 5f70 616e 6461 7328 290a 0a20  ).to_pandas().. 
-0003f0c0: 2020 2020 2020 2020 2020 2023 2052 6566             # Ref
-0003f0d0: 6f72 6d61 7420 746f 206a 736f 6e0a 2020  ormat to json.  
-0003f0e0: 2020 2020 2020 2020 2020 6a73 6f6e 5f64            json_d
-0003f0f0: 6174 6120 3d20 2720 2020 2020 2020 2027  ata = '        '
-0003f100: 202b 2070 642e 746f 5f6a 736f 6e28 6f72   + pd.to_json(or
-0003f110: 6965 6e74 3d27 7661 6c75 6573 2729 2e72  ient='values').r
-0003f120: 6570 6c61 6365 2827 5d2c 5b27 2c20 275c  eplace('],[', '\
-0003f130: 6e20 2020 205d 7878 7878 7878 5c6e 2020  n    ]xxxxxx\n  
-0003f140: 2020 5b5c 6e20 2020 2020 2020 2027 292e    [\n        ').
-0003f150: 7265 706c 6163 6528 272c 2027 2c20 2778  replace(', ', 'x
-0003f160: 636f 6d6d 6173 7061 6365 7827 292e 7265  commaspacex').re
-0003f170: 706c 6163 6528 272c 272c 2027 2c5c 6e20  place(',', ',\n 
-0003f180: 2020 2020 2020 2027 292e 7265 706c 6163         ').replac
-0003f190: 6528 2778 7878 7878 7827 2c20 272c 2729  e('xxxxxx', ',')
-0003f1a0: 2e72 6570 6c61 6365 2827 7863 6f6d 6d61  .replace('xcomma
-0003f1b0: 7370 6163 6578 272c 2027 2c20 2729 0a20  spacex', ', '). 
-0003f1c0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0003f1d0: 7374 7220 3d20 2222 227b 7b0a 2020 2264  str = """{{.  "d
-0003f1e0: 6174 6122 3a0a 7b30 7d0a 0a7d 7d0a 2222  ata":.{0}..}}.""
-0003f1f0: 222e 666f 726d 6174 286a 736f 6e5f 6461  ".format(json_da
-0003f200: 7461 2e72 6570 6c61 6365 2827 5c5c 2222  ta.replace('\\""
-0003f210: 272c 2027 2227 2929 0a0a 2020 2020 2020  ', '"'))..      
-0003f220: 2020 2020 2020 6670 203d 206f 7065 6e28        fp = open(
-0003f230: 6f75 7470 7574 2e72 6570 6c61 6365 2827  output.replace('
-0003f240: 2e68 746d 6c27 2c20 272e 6a73 6f6e 2729  .html', '.json')
-0003f250: 2c20 2777 2729 0a20 2020 2020 2020 2020  , 'w').         
-0003f260: 2020 2066 702e 7772 6974 6528 6a73 6f6e     fp.write(json
-0003f270: 5f73 7472 290a 2020 2020 2020 2020 2020  _str).          
-0003f280: 2020 6670 2e63 6c6f 7365 2829 0a0a 2020    fp.close()..  
-0003f290: 2020 2020 2020 2020 2020 2320 4564 6974            # Edit
-0003f2a0: 2048 544d 4c20 6669 6c65 0a20 2020 2020   HTML file.     
-0003f2b0: 2020 2020 2020 206c 696e 6573 203d 206f         lines = o
-0003f2c0: 7065 6e28 6f75 7470 7574 292e 7265 6164  pen(output).read
-0003f2d0: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
-0003f2e0: 2020 2020 2023 2041 6464 2061 6a61 7820       # Add ajax 
-0003f2f0: 6361 6c6c 2074 6f20 4461 7461 5461 626c  call to DataTabl
-0003f300: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
-0003f310: 7220 696c 2c20 6c69 6e65 2069 6e20 656e  r il, line in en
-0003f320: 756d 6572 6174 6528 6c69 6e65 7329 3a0a  umerate(lines):.
+0002f5a0: 2020 2020 2020 2020 2069 6620 286e 6f74           if (not
+0002f5b0: 206e 702e 6973 6669 6e69 7465 286d 6564   np.isfinite(med
+0002f5c0: 6961 6e5f 7765 6967 6874 2929 207c 2028  ian_weight)) | (
+0002f5d0: 287e 5f6d 736b 292e 7375 6d28 2920 3d3d  (~_msk).sum() ==
+0002f5e0: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+0002f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f600: 206d 6564 6961 6e5f 7765 6967 6874 203d   median_weight =
+0002f610: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0002f620: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f640: 2020 2020 7768 745b 7e5f 6d73 6b5d 203d      wht[~_msk] =
+0002f650: 206d 6564 6961 6e5f 7765 6967 6874 0a20   median_weight. 
+0002f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f670: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002f680: 2020 2020 2020 2020 6d65 6469 616e 5f77          median_w
+0002f690: 6569 6768 7420 3d20 6e70 2e6e 616e 6d65  eight = np.nanme
+0002f6a0: 6469 616e 2877 6874 5b7e 5f6d 736b 5d29  dian(wht[~_msk])
+0002f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f6c0: 2069 6620 286e 6f74 206e 702e 6973 6669   if (not np.isfi
+0002f6d0: 6e69 7465 286d 6564 6961 6e5f 7765 6967  nite(median_weig
+0002f6e0: 6874 2929 207c 2028 287e 5f6d 736b 292e  ht)) | ((~_msk).
+0002f6f0: 7375 6d28 2920 3d3d 2030 293a 0a20 2020  sum() == 0):.   
+0002f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f710: 206d 6564 6961 6e5f 7765 6967 6874 203d   median_weight =
+0002f720: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0002f730: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002f740: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
+0002f750: 2020 6578 7420 2853 4349 2c7b 6578 747d    ext (SCI,{ext}
+0002f760: 292c 2073 6b79 3d7b 736b 795f 7661 6c75  ), sky={sky_valu
+0002f770: 653a 2e33 667d 270a 2020 2020 2020 2020  e:.3f}'.        
+0002f780: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
+0002f790: 2720 6861 735f 626b 673a 7b68 6173 5f62  ' has_bkg:{has_b
+0002f7a0: 6b67 7d27 0a20 2020 2020 2020 2020 2020  kg}'.           
+0002f7b0: 2020 2020 206d 7367 202b 3d20 6627 206d       msg += f' m
+0002f7c0: 6564 6961 6e5f 7765 6967 6874 3a7b 6d65  edian_weight:{me
+0002f7d0: 6469 616e 5f77 6569 6768 743a 2e32 657d  dian_weight:.2e}
+0002f7e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0002f7f0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0002f800: 2020 206c 6f67 5f63 6f6d 6d65 6e74 284c     log_comment(L
+0002f810: 4f47 4649 4c45 2c20 6d73 672c 2076 6572  OGFILE, msg, ver
+0002f820: 626f 7365 3d76 6572 626f 7365 290a 2020  bose=verbose).  
+0002f830: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0002f840: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002f850: 2055 7365 206d 6564 6961 6e28 4552 5229   Use median(ERR)
+0002f860: 2061 7320 7468 6520 6675 6c6c 2069 6d61   as the full ima
+0002f870: 6765 2077 6569 6768 742c 200a 2020 2020  ge weight, .    
+0002f880: 2020 2020 2020 2020 2020 2020 2320 6f70              # op
+0002f890: 7469 6f6e 616c 6c79 2073 6361 6c69 6e67  tionally scaling
+0002f8a0: 2062 7920 7468 6520 5449 4d45 2061 7272   by the TIME arr
+0002f8b0: 6179 0a20 2020 2020 2020 2020 2020 2020  ay.             
+0002f8c0: 2020 2069 6620 7765 6967 6874 5f74 7970     if weight_typ
+0002f8d0: 6520 696e 205b 276d 6564 6961 6e5f 6572  e in ['median_er
+0002f8e0: 7227 2c20 2774 696d 6527 5d3a 0a20 2020  r', 'time']:.   
+0002f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f900: 2077 6874 5b7e 5f6d 736b 5d20 3d20 6d65   wht[~_msk] = me
+0002f910: 6469 616e 5f77 6569 6768 740a 2020 2020  dian_weight.    
+0002f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f940: 2020 2020 2069 6620 7765 6967 6874 5f74       if weight_t
+0002f950: 7970 6520 3d3d 2027 7469 6d65 273a 0a20  ype == 'time':. 
+0002f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f970: 2020 2020 2020 2069 6620 2827 5449 4d45         if ('TIME
+0002f980: 272c 6578 7429 2069 6e20 666c 743a 0a20  ',ext) in flt:. 
+0002f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9a0: 2020 2020 2020 2020 2020 2069 6620 666c             if fl
+0002f9b0: 745b 2827 5449 4d45 272c 6578 7429 5d2e  t[('TIME',ext)].
+0002f9c0: 6461 7461 2069 7320 6e6f 7420 4e6f 6e65  data is not None
+0002f9d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9f0: 2020 5f74 696d 6520 3d20 666c 745b 2827    _time = flt[('
+0002fa00: 5449 4d45 272c 6578 7429 5d2e 6461 7461  TIME',ext)].data
+0002fa10: 2a31 0a20 2020 2020 2020 2020 2020 2020  *1.             
+0002fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa30: 2020 2074 6d61 7820 3d20 6e70 2e6e 616e     tmax = np.nan
+0002fa40: 6d61 7828 5f74 696d 655b 7e5f 6d73 6b5d  max(_time[~_msk]
+0002fa50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa70: 2020 5f74 696d 6520 2f3d 2074 6d61 780a    _time /= tmax.
+0002fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002faa0: 7768 745b 7e5f 6d73 6b5d 202a 3d20 5f74  wht[~_msk] *= _t
+0002fab0: 696d 655b 7e5f 6d73 6b5d 0a20 2020 2020  ime[~_msk].     
+0002fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fad0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002faf0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0002fb00: 3d20 6627 7363 616c 6520 7765 6967 6874  = f'scale weight
+0002fb10: 2062 7920 2854 494d 452c 7b65 7874 7d29   by (TIME,{ext})
+0002fb20: 2f7b 746d 6178 3a2e 3166 7d27 0a20 2020  /{tmax:.1f}'.   
+0002fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fb40: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002fb50: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
+0002fb60: 2c20 6d73 672c 2076 6572 626f 7365 3d76  , msg, verbose=v
+0002fb70: 6572 626f 7365 290a 2020 2020 2020 2020  erbose).        
+0002fb80: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0002fb90: 2020 2020 2020 2020 2077 6874 5f6c 6973           wht_lis
+0002fba0: 742e 6170 7065 6e64 2877 6874 290a 0a20  t.append(wht).. 
+0002fbb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002fbc0: 2077 6373 5f69 203d 2048 5354 5743 5328   wcs_i = HSTWCS(
+0002fbd0: 666f 626a 3d66 6c74 2c20 6578 743d 2827  fobj=flt, ext=('
+0002fbe0: 5343 4927 2c65 7874 292c 206d 696e 6572  SCI',ext), miner
+0002fbf0: 723d 302e 302c 0a20 2020 2020 2020 2020  r=0.0,.         
+0002fc00: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0002fc10: 2020 2020 2020 2020 7763 736b 6579 3d27          wcskey='
+0002fc20: 2027 290a 2020 2020 2020 2020 2020 2020   ').            
+0002fc30: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
+0002fc40: 7472 2877 6373 5f69 2c20 2770 6978 656c  tr(wcs_i, 'pixel
+0002fc50: 5f73 6861 7065 2729 3a0a 2020 2020 2020  _shape'):.      
+0002fc60: 2020 2020 2020 2020 2020 2020 2020 7763                wc
+0002fc70: 735f 692e 7069 7865 6c5f 7368 6170 6520  s_i.pixel_shape 
+0002fc80: 3d20 7763 735f 692e 5f6e 6178 6973 312c  = wcs_i._naxis1,
+0002fc90: 2077 6373 5f69 2e5f 6e61 7869 7332 0a0a   wcs_i._naxis2..
+0002fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fcb0: 6966 206e 6f74 2068 6173 6174 7472 2877  if not hasattr(w
+0002fcc0: 6373 5f69 2c20 275f 6e61 7869 7331 2729  cs_i, '_naxis1')
+0002fcd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002fce0: 2020 2020 2020 7763 735f 692e 5f6e 6178        wcs_i._nax
+0002fcf0: 6973 312c 2077 6373 5f69 2e5f 6e61 7869  is1, wcs_i._naxi
+0002fd00: 7332 203d 2077 6373 5f69 2e5f 6e61 7869  s2 = wcs_i._naxi
+0002fd10: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0002fd20: 2020 2077 6373 5f6c 6973 742e 6170 7065     wcs_list.appe
+0002fd30: 6e64 2877 6373 5f69 290a 0a20 2020 2020  nd(wcs_i)..     
+0002fd40: 2020 2069 6620 636f 756e 7420 3d3d 2030     if count == 0
+0002fd50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002fd60: 7320 3d20 6472 697a 7a6c 655f 6172 7261  s = drizzle_arra
+0002fd70: 795f 6772 6f75 7073 2873 6369 5f6c 6973  y_groups(sci_lis
+0002fd80: 742c 2077 6874 5f6c 6973 742c 2077 6373  t, wht_list, wcs
+0002fd90: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
+0002fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fdb0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0002fdc0: 7574 7763 733d 6f75 7470 7574 7763 732c  utwcs=outputwcs,
+0002fdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fdf0: 2020 2020 2020 7363 616c 653d 302e 312c        scale=0.1,
+0002fe00: 206b 6572 6e65 6c3d 6b65 726e 656c 2c0a   kernel=kernel,.
+0002fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe30: 2020 2020 2070 6978 6672 6163 3d70 6978       pixfrac=pix
+0002fe40: 6672 6163 2c20 6361 6c63 5f77 6373 6d61  frac, calc_wcsma
+0002fe50: 703d 6361 6c63 5f77 6373 6d61 702c 0a20  p=calc_wcsmap,. 
+0002fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe80: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
+0002fe90: 6f73 652c 2064 6174 613d 4e6f 6e65 290a  ose, data=None).
+0002fea0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0002feb0: 7363 692c 206f 7574 7768 742c 206f 7574  sci, outwht, out
+0002fec0: 6374 782c 2068 6561 6465 722c 2078 6f75  ctx, header, xou
+0002fed0: 7477 6373 203d 2072 6573 0a20 2020 2020  twcs = res.     
+0002fee0: 2020 2020 2020 2068 6561 6465 725b 2745         header['E
+0002fef0: 5850 5449 4d45 275d 203d 2066 6c74 5b30  XPTIME'] = flt[0
+0002ff00: 5d2e 6865 6164 6572 5b27 4558 5054 494d  ].header['EXPTIM
+0002ff10: 4527 5d0a 2020 2020 2020 2020 2020 2020  E'].            
+0002ff20: 6865 6164 6572 5b27 4e44 5249 5a49 4d27  header['NDRIZIM'
+0002ff30: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
+0002ff40: 2020 6865 6164 6572 5b27 5049 5846 5241    header['PIXFRA
+0002ff50: 4327 5d20 3d20 7069 7866 7261 630a 2020  C'] = pixfrac.  
+0002ff60: 2020 2020 2020 2020 2020 6865 6164 6572            header
+0002ff70: 5b27 4b45 524e 454c 275d 203d 206b 6572  ['KERNEL'] = ker
+0002ff80: 6e65 6c0a 2020 2020 2020 2020 2020 2020  nel.            
+0002ff90: 6865 6164 6572 5b27 4f4b 4249 5453 275d  header['OKBITS']
+0002ffa0: 203d 2028 6269 7473 2c20 2246 4c54 2062   = (bits, "FLT b
+0002ffb0: 6974 7320 7472 6561 7465 6420 6173 2076  its treated as v
+0002ffc0: 616c 6964 2229 0a20 2020 2020 2020 2020  alid").         
+0002ffd0: 2020 2068 6561 6465 725b 2750 484f 5453     header['PHOTS
+0002ffe0: 4341 4c27 5d20 3d20 5f73 6361 6c65 5f70  CAL'] = _scale_p
+0002fff0: 686f 746f 6d2c 2027 5363 616c 6520 6661  hotom, 'Scale fa
+00030000: 6374 6f72 2061 7070 6c69 6564 270a 2020  ctor applied'.  
+00030010: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00030020: 2020 2020 2020 2068 6561 6465 725b 2747         header['G
+00030030: 5249 5a4c 4956 275d 203d 2067 7269 7a6c  RIZLIV'] = grizl
+00030040: 695f 5f76 6572 7369 6f6e 2c20 2747 7269  i__version, 'Gri
+00030050: 7a6c 6920 636f 6465 2076 6572 7369 6f6e  zli code version
+00030060: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
+00030070: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+00030080: 725b 2757 4854 5459 5045 275d 203d 2077  r['WHTTYPE'] = w
+00030090: 6569 6768 745f 7479 7065 2c20 2745 7870  eight_type, 'Exp
+000300a0: 6f73 7572 6520 7765 6967 6874 696e 6720  osure weighting 
+000300b0: 7374 7261 7465 6779 270a 2020 2020 2020  strategy'.      
+000300c0: 2020 2020 2020 6865 6164 6572 5b27 524e        header['RN
+000300d0: 5045 5243 275d 203d 2072 6e6f 6973 655f  PERC'] = rnoise_
+000300e0: 7065 7263 656e 7469 6c65 2c20 2756 4152  percentile, 'VAR
+000300f0: 5f52 4e4f 4953 4520 636c 6970 2070 6572  _RNOISE clip per
+00030100: 6365 6e74 696c 6520 666f 7220 4a57 5354  centile for JWST
+00030110: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
+00030120: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00030130: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+00030140: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00030150: 5b6b 5d20 3d20 6b65 7973 5b6b 5d0a 0a20  [k] = keys[k].. 
+00030160: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00030170: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00030180: 6f75 7473 6369 2c20 6f75 7477 6874 2c20  outsci, outwht, 
+00030190: 6f75 7463 7478 0a20 2020 2020 2020 2020  outctx.         
+000301a0: 2020 2072 6573 203d 2064 7269 7a7a 6c65     res = drizzle
+000301b0: 5f61 7272 6179 5f67 726f 7570 7328 7363  _array_groups(sc
+000301c0: 695f 6c69 7374 2c20 7768 745f 6c69 7374  i_list, wht_list
+000301d0: 2c20 7763 735f 6c69 7374 2c0a 2020 2020  , wcs_list,.    
+000301e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030200: 206f 7574 7075 7477 6373 3d6f 7574 7075   outputwcs=outpu
+00030210: 7477 6373 2c0a 2020 2020 2020 2020 2020  twcs,.          
+00030220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030230: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+00030240: 3d30 2e31 2c20 6b65 726e 656c 3d6b 6572  =0.1, kernel=ker
+00030250: 6e65 6c2c 0a20 2020 2020 2020 2020 2020  nel,.           
+00030260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030270: 2020 2020 2020 2020 2020 7069 7866 7261            pixfra
+00030280: 633d 7069 7866 7261 632c 2063 616c 635f  c=pixfrac, calc_
+00030290: 7763 736d 6170 3d63 616c 635f 7763 736d  wcsmap=calc_wcsm
+000302a0: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
+000302b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302c0: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+000302d0: 3d76 6572 626f 7365 2c20 6461 7461 3d64  =verbose, data=d
+000302e0: 6174 6129 0a0a 2020 2020 2020 2020 2020  ata)..          
+000302f0: 2020 6f75 7473 6369 2c20 6f75 7477 6874    outsci, outwht
+00030300: 2c20 6f75 7463 7478 203d 2072 6573 5b3a  , outctx = res[:
+00030310: 335d 0a20 2020 2020 2020 2020 2020 2068  3].            h
+00030320: 6561 6465 725b 2745 5850 5449 4d45 275d  eader['EXPTIME']
+00030330: 202b 3d20 666c 745b 305d 2e68 6561 6465   += flt[0].heade
+00030340: 725b 2745 5850 5449 4d45 275d 0a20 2020  r['EXPTIME'].   
+00030350: 2020 2020 2020 2020 2068 6561 6465 725b           header[
+00030360: 274e 4452 495a 494d 275d 202b 3d20 310a  'NDRIZIM'] += 1.
+00030370: 0a20 2020 2020 2020 2063 6f75 6e74 202b  .        count +
+00030380: 3d20 310a 2020 2020 2020 2020 6865 6164  = 1.        head
+00030390: 6572 5b27 464c 547b 303a 3035 647d 272e  er['FLT{0:05d}'.
+000303a0: 666f 726d 6174 2863 6f75 6e74 295d 203d  format(count)] =
+000303b0: 2066 696c 650a 2020 2020 2020 2020 0a20   file.        . 
+000303c0: 2020 2020 2020 2069 6620 6d65 6469 616e         if median
+000303d0: 5f77 6569 6768 7420 6973 206e 6f74 204e  _weight is not N
+000303e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000303f0: 2068 6561 6465 725b 2757 4854 7b30 3a30   header['WHT{0:0
+00030400: 3564 7d27 2e66 6f72 6d61 7428 636f 756e  5d}'.format(coun
+00030410: 7429 5d20 3d20 286d 6564 6961 6e5f 7765  t)] = (median_we
+00030420: 6967 6874 2c20 0a20 2020 2020 2020 2020  ight, .         
+00030430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030450: 2020 2020 2020 2020 2066 274d 6564 6961           f'Media
+00030460: 6e20 7765 6967 6874 206f 6620 6578 706f  n weight of expo
+00030470: 7375 7265 207b 636f 756e 747d 2729 0a20  sure {count}'). 
+00030480: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00030490: 2020 2020 666c 742e 636c 6f73 6528 290a      flt.close().
+000304a0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000304b0: 2023 7866 696c 6573 203d 2067 6c6f 622e   #xfiles = glob.
+000304c0: 676c 6f62 2827 2a27 290a 2020 2020 2020  glob('*').      
+000304d0: 2020 2370 7269 6e74 2827 436c 6561 6e3a    #print('Clean:
+000304e0: 2027 2c20 636c 6561 6e2c 2078 6669 6c65   ', clean, xfile
+000304f0: 7329 0a20 2020 2020 2020 2069 6620 636c  s).        if cl
+00030500: 6561 6e3a 0a20 2020 2020 2020 2020 2020  ean:.           
+00030510: 206f 732e 7265 6d6f 7665 2866 696c 6529   os.remove(file)
+00030520: 0a0a 2020 2020 6966 2027 6177 7370 6174  ..    if 'awspat
+00030530: 6827 2069 6e20 7669 7369 743a 0a20 2020  h' in visit:.   
+00030540: 2020 2020 2061 7773 7061 7468 203d 2076       awspath = v
+00030550: 6973 6974 5b27 6177 7370 6174 6827 5d0a  isit['awspath'].
+00030560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030570: 2020 6177 7370 6174 6820 3d20 5b27 2e27    awspath = ['.'
+00030580: 2066 6f72 2066 2069 6e20 7669 7369 745b   for f in visit[
+00030590: 2766 696c 6573 275d 5d0a 0a20 2020 2069  'files']]..    i
+000305a0: 6620 6c65 6e28 6177 7370 6174 6829 203d  f len(awspath) =
+000305b0: 3d20 313a 0a20 2020 2020 2020 2061 7773  = 1:.        aws
+000305c0: 7061 7468 203d 205b 6177 7370 6174 685b  path = [awspath[
+000305d0: 305d 2066 6f72 2066 2069 6e20 7669 7369  0] for f in visi
+000305e0: 745b 2766 696c 6573 275d 5d0a 2020 2020  t['files']].    
+000305f0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00030600: 6177 7370 6174 682c 2073 7472 293a 0a20  awspath, str):. 
+00030610: 2020 2020 2020 205f 6177 7370 6174 6820         _awspath 
+00030620: 3d20 5b61 7773 7061 7468 2066 6f72 2066  = [awspath for f
+00030630: 2069 6e20 7669 7369 745b 2766 696c 6573   in visit['files
+00030640: 275d 5d0a 2020 2020 2020 2020 6177 7370  ']].        awsp
+00030650: 6174 6820 3d20 5f61 7773 7061 7468 0a0a  ath = _awspath..
+00030660: 2020 2020 666c 6973 7420 3d20 5b27 7b30      flist = ['{0
+00030670: 7d2f 7b31 7d27 2e66 6f72 6d61 7428 6177  }/{1}'.format(aw
+00030680: 7370 6174 682c 2076 6973 6974 5b27 6669  spath, visit['fi
+00030690: 6c65 7327 5d5b 695d 290a 2020 2020 2020  les'][i]).      
+000306a0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+000306b0: 696e 2069 6e64 6963 6573 5d0a 2020 2020  in indices].    
+000306c0: 0a20 2020 2069 6620 6472 7972 756e 3a0a  .    if dryrun:.
+000306d0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+000306e0: 6c69 7374 0a0a 2020 2020 656c 6966 2063  list..    elif c
+000306f0: 6f75 6e74 203d 3d20 303a 0a20 2020 2020  ount == 0:.     
+00030700: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00030710: 2020 2020 656c 7365 3a20 2020 2020 2020      else:       
+00030720: 200a 2020 2020 2020 2020 7763 735f 7461   .        wcs_ta
+00030730: 6220 3d20 4754 6162 6c65 286e 616d 6573  b = GTable(names
+00030740: 3d77 6373 5f63 6f6c 6e61 6d65 732c 2072  =wcs_colnames, r
+00030750: 6f77 733d 7763 735f 726f 7773 290a 2020  ows=wcs_rows).  
+00030760: 2020 2020 2020 0a20 2020 2020 2020 206f        .        o
+00030770: 7574 7768 7420 2a3d 2028 7763 735f 692e  utwht *= (wcs_i.
+00030780: 7073 6361 6c65 2f6f 7574 7075 7477 6373  pscale/outputwcs
+00030790: 2e70 7363 616c 6529 2a2a 340a 2020 2020  .pscale)**4.    
+000307a0: 2020 2020 7265 7475 726e 206f 7574 7363      return outsc
+000307b0: 692c 206f 7574 7768 742c 2068 6561 6465  i, outwht, heade
+000307c0: 722c 2066 6c69 7374 2c20 7763 735f 7461  r, flist, wcs_ta
+000307d0: 620a 0a0a 6465 6620 6472 697a 7a6c 655f  b...def drizzle_
+000307e0: 6172 7261 795f 6772 6f75 7073 2873 6369  array_groups(sci
+000307f0: 5f6c 6973 742c 2077 6874 5f6c 6973 742c  _list, wht_list,
+00030800: 2077 6373 5f6c 6973 742c 206f 7574 7075   wcs_list, outpu
+00030810: 7477 6373 3d4e 6f6e 652c 0a20 2020 2020  twcs=None,.     
+00030820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030830: 2020 2020 7363 616c 653d 302e 312c 206b      scale=0.1, k
+00030840: 6572 6e65 6c3d 2770 6f69 6e74 272c 2070  ernel='point', p
+00030850: 6978 6672 6163 3d31 2e2c 0a20 2020 2020  ixfrac=1.,.     
+00030860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030870: 2020 2020 6361 6c63 5f77 6373 6d61 703d      calc_wcsmap=
+00030880: 4661 6c73 652c 2076 6572 626f 7365 3d54  False, verbose=T
+00030890: 7275 652c 2064 6174 613d 4e6f 6e65 293a  rue, data=None):
+000308a0: 0a20 2020 2022 2222 4472 697a 7a6c 6520  .    """Drizzle 
+000308b0: 6172 7261 7920 6461 7461 2077 6974 6820  array data with 
+000308c0: 6173 736f 6369 6174 6564 2077 6373 0a0a  associated wcs..
+000308d0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000308e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000308f0: 2020 7363 695f 6c69 7374 2c20 7768 745f    sci_list, wht_
+00030900: 6c69 7374 203a 206c 6973 740a 2020 2020  list : list.    
+00030910: 2020 2020 4c69 7374 206f 6620 7363 6965      List of scie
+00030920: 6e63 6520 616e 6420 7765 6967 6874 2060  nce and weight `
+00030930: 7e6e 756d 7079 2e6e 6461 7272 6179 6020  ~numpy.ndarray` 
+00030940: 6f62 6a65 6374 732e 0a0a 2020 2020 7763  objects...    wc
+00030950: 735f 6c69 7374 203a 206c 6973 740a 0a20  s_list : list.. 
+00030960: 2020 2073 6361 6c65 203a 2066 6c6f 6174     scale : float
+00030970: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
+00030980: 7069 7865 6c20 7363 616c 6520 696e 2061  pixel scale in a
+00030990: 7263 7365 632e 0a0a 2020 2020 6b65 726e  rcsec...    kern
+000309a0: 656c 2c20 7069 7866 7261 6320 3a20 7374  el, pixfrac : st
+000309b0: 722c 2066 6c6f 6174 0a20 2020 2020 2020  r, float.       
+000309c0: 2044 7269 7a7a 6c65 2070 6172 616d 6574   Drizzle paramet
+000309d0: 6572 730a 0a20 2020 2076 6572 626f 7365  ers..    verbose
+000309e0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+000309f0: 5072 696e 7420 7374 6174 7573 206d 6573  Print status mes
+00030a00: 7361 6765 730a 0a20 2020 2052 6574 7572  sages..    Retur
+00030a10: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00030a20: 2020 206f 7574 7363 692c 206f 7574 7768     outsci, outwh
+00030a30: 742c 206f 7574 6374 7820 3a20 607e 6e75  t, outctx : `~nu
+00030a40: 6d70 792e 6e64 6172 7261 7960 0a20 2020  mpy.ndarray`.   
+00030a50: 2020 2020 204f 7574 7075 7420 6472 697a       Output driz
+00030a60: 7a6c 6564 2073 6369 656e 6365 2c20 7765  zled science, we
+00030a70: 6967 6874 2061 6e64 2063 6f6e 7465 7874  ight and context
+00030a80: 2069 6d61 6765 730a 0a20 2020 2068 6561   images..    hea
+00030a90: 6465 722c 206f 7574 7075 7477 6373 203a  der, outputwcs :
+00030aa0: 2060 7e61 7374 726f 7079 2e66 6974 732e   `~astropy.fits.
+00030ab0: 696f 2e48 6561 6465 7260 2c20 607e 6173  io.Header`, `~as
+00030ac0: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
+00030ad0: 2020 2020 2020 2044 7269 7a7a 6c65 6420         Drizzled 
+00030ae0: 696d 6167 6520 6865 6164 6572 2061 6e64  image header and
+00030af0: 2057 4353 2e0a 0a20 2020 2022 2222 0a20   WCS...    """. 
+00030b00: 2020 2066 726f 6d20 6472 697a 7a6c 6570     from drizzlep
+00030b10: 6163 2069 6d70 6f72 7420 6164 7269 7a7a  ac import adrizz
+00030b20: 6c65 0a20 2020 2066 726f 6d20 6472 697a  le.    from driz
+00030b30: 7a6c 6570 6163 2069 6d70 6f72 7420 6364  zlepac import cd
+00030b40: 7269 7a0a 0a20 2020 2023 6672 6f6d 2073  riz..    #from s
+00030b50: 7473 6369 2e74 6f6f 6c73 2069 6d70 6f72  tsci.tools impor
+00030b60: 7420 6c6f 6775 7469 6c0a 2020 2020 236c  t logutil.    #l
+00030b70: 6f67 203d 206c 6f67 7574 696c 2e63 7265  og = logutil.cre
+00030b80: 6174 655f 6c6f 6767 6572 285f 5f6e 616d  ate_logger(__nam
+00030b90: 655f 5f29 0a0a 2020 2020 2320 4f75 7470  e__)..    # Outp
+00030ba0: 7574 2068 6561 6465 7220 2f20 5743 530a  ut header / WCS.
+00030bb0: 2020 2020 6966 206f 7574 7075 7477 6373      if outputwcs
+00030bc0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00030bd0: 2020 2368 6561 6465 722c 206f 7574 7075    #header, outpu
+00030be0: 7477 6373 203d 2063 6f6d 7075 7465 5f6f  twcs = compute_o
+00030bf0: 7574 7075 745f 7763 7328 7763 735f 6c69  utput_wcs(wcs_li
+00030c00: 7374 2c20 7069 7865 6c5f 7363 616c 653d  st, pixel_scale=
+00030c10: 7363 616c 6529 0a20 2020 2020 2020 2068  scale).        h
+00030c20: 6561 6465 722c 206f 7574 7075 7477 6373  eader, outputwcs
+00030c30: 203d 206d 616b 655f 6d61 7869 6d61 6c5f   = make_maximal_
+00030c40: 7763 7328 7763 735f 6c69 7374 2c0a 2020  wcs(wcs_list,.  
+00030c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c70: 2020 2020 2020 2020 2020 2070 6978 656c             pixel
+00030c80: 5f73 6361 6c65 3d73 6361 6c65 2c0a 2020  _scale=scale,.  
+00030c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cb0: 2020 2020 2020 2020 2020 2076 6572 626f             verbo
+00030cc0: 7365 3d46 616c 7365 2c0a 2020 2020 2020  se=False,.      
+00030cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cf0: 2020 2020 2020 2070 6164 3d30 2c0a 2020         pad=0,.  
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d20: 2020 2020 2020 2020 2020 2067 6574 5f68             get_h
+00030d30: 6475 3d46 616c 7365 290a 2020 2020 656c  du=False).    el
+00030d40: 7365 3a0a 2020 2020 2020 2020 6865 6164  se:.        head
+00030d50: 6572 203d 2074 6f5f 6865 6164 6572 286f  er = to_header(o
+00030d60: 7574 7075 7477 6373 290a 0a20 2020 2068  utputwcs)..    h
+00030d70: 6561 6465 725b 2744 5249 5a4b 4552 4e27  eader['DRIZKERN'
+00030d80: 5d20 3d20 6b65 726e 656c 2c20 2244 7269  ] = kernel, "Dri
+00030d90: 7a7a 6c65 206b 6572 6e65 6c22 0a20 2020  zzle kernel".   
+00030da0: 2068 6561 6465 725b 2744 5249 5a50 4958   header['DRIZPIX
+00030db0: 4627 5d20 3d20 7069 7866 7261 632c 2022  F'] = pixfrac, "
+00030dc0: 4472 697a 7a6c 6520 7069 7866 7261 6322  Drizzle pixfrac"
+00030dd0: 0a0a 2020 2020 6966 206e 6f74 2068 6173  ..    if not has
+00030de0: 6174 7472 286f 7574 7075 7477 6373 2c20  attr(outputwcs, 
+00030df0: 275f 6e61 7869 7331 2729 3a0a 2020 2020  '_naxis1'):.    
+00030e00: 2020 2020 6f75 7470 7574 7763 732e 5f6e      outputwcs._n
+00030e10: 6178 6973 312c 206f 7574 7075 7477 6373  axis1, outputwcs
+00030e20: 2e5f 6e61 7869 7332 203d 206f 7574 7075  ._naxis2 = outpu
+00030e30: 7477 6373 2e5f 6e61 7869 730a 0a20 2020  twcs._naxis..   
+00030e40: 2023 2054 7279 2074 6f20 6669 7820 6465   # Try to fix de
+00030e50: 7072 6563 6174 6564 2057 4353 0a20 2020  precated WCS.   
+00030e60: 2066 6f72 2077 6373 5f69 2069 6e20 7763   for wcs_i in wc
+00030e70: 735f 6c69 7374 3a0a 2020 2020 2020 2020  s_list:.        
+00030e80: 6966 206e 6f74 2068 6173 6174 7472 2877  if not hasattr(w
+00030e90: 6373 5f69 2c20 2770 6978 656c 5f73 6861  cs_i, 'pixel_sha
+00030ea0: 7065 2729 3a0a 2020 2020 2020 2020 2020  pe'):.          
+00030eb0: 2020 7763 735f 692e 7069 7865 6c5f 7368    wcs_i.pixel_sh
+00030ec0: 6170 6520 3d20 7763 735f 692e 5f6e 6178  ape = wcs_i._nax
+00030ed0: 6973 312c 2077 6373 5f69 2e5f 6e61 7869  is1, wcs_i._naxi
+00030ee0: 7332 0a0a 2020 2020 2020 2020 6966 206e  s2..        if n
+00030ef0: 6f74 2068 6173 6174 7472 2877 6373 5f69  ot hasattr(wcs_i
+00030f00: 2c20 275f 6e61 7869 7331 2729 3a0a 2020  , '_naxis1'):.  
+00030f10: 2020 2020 2020 2020 2020 7763 735f 692e            wcs_i.
+00030f20: 5f6e 6178 6973 312c 2077 6373 5f69 2e5f  _naxis1, wcs_i._
+00030f30: 6e61 7869 7332 203d 2077 6373 5f69 2e5f  naxis2 = wcs_i._
+00030f40: 6e61 7869 735b 3a32 5d0a 0a20 2020 2023  naxis[:2]..    #
+00030f50: 204f 7574 7075 7420 5743 5320 7265 7175   Output WCS requ
+00030f60: 6972 6573 2066 756c 6c20 5743 5320 6d61  ires full WCS ma
+00030f70: 703f 0a20 2020 2069 6620 6361 6c63 5f77  p?.    if calc_w
+00030f80: 6373 6d61 7020 3c20 323a 0a20 2020 2020  csmap < 2:.     
+00030f90: 2020 2063 7479 7065 203d 206f 7574 7075     ctype = outpu
+00030fa0: 7477 6373 2e77 6373 2e63 7479 7065 0a20  twcs.wcs.ctype. 
+00030fb0: 2020 2020 2020 2069 6620 272d 5349 5027         if '-SIP'
+00030fc0: 2069 6e20 6374 7970 655b 305d 3a0a 2020   in ctype[0]:.  
+00030fd0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00030fe0: 274f 7574 7075 7420 5743 5320 287b 307d  'Output WCS ({0}
+00030ff0: 2920 7265 7175 6972 6573 2060 6361 6c63  ) requires `calc
+00031000: 5f77 6373 6d61 703d 3260 272e 666f 726d  _wcsmap=2`'.form
+00031010: 6174 2863 7479 7065 2929 0a20 2020 2020  at(ctype)).     
+00031020: 2020 2020 2020 2063 616c 635f 7763 736d         calc_wcsm
+00031030: 6170 203d 2032 0a20 2020 2020 2020 2065  ap = 2.        e
+00031040: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00031050: 2023 2049 6e74 6572 6e61 6c20 5743 534d   # Internal WCSM
+00031060: 4150 206e 6f74 2072 6571 7569 7265 640a  AP not required.
+00031070: 2020 2020 2020 2020 2020 2020 6361 6c63              calc
+00031080: 5f77 6373 6d61 7020 3d20 300a 0a20 2020  _wcsmap = 0..   
+00031090: 2073 6861 7065 203d 2028 6865 6164 6572   shape = (header
+000310a0: 5b27 4e41 5849 5332 275d 2c20 6865 6164  ['NAXIS2'], head
+000310b0: 6572 5b27 4e41 5849 5331 275d 290a 0a20  er['NAXIS1']).. 
+000310c0: 2020 2023 204f 7574 7075 7420 6172 7261     # Output arra
+000310d0: 7973 0a20 2020 2069 6620 6461 7461 2069  ys.    if data i
+000310e0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000310f0: 2020 2020 6f75 7473 6369 2c20 6f75 7477      outsci, outw
+00031100: 6874 2c20 6f75 7463 7478 203d 2064 6174  ht, outctx = dat
+00031110: 610a 2020 2020 656c 7365 3a0a 2020 2020  a.    else:.    
+00031120: 2020 2020 6f75 7473 6369 203d 206e 702e      outsci = np.
+00031130: 7a65 726f 7328 7368 6170 652c 2064 7479  zeros(shape, dty
+00031140: 7065 3d6e 702e 666c 6f61 7433 3229 0a20  pe=np.float32). 
+00031150: 2020 2020 2020 206f 7574 7768 7420 3d20         outwht = 
+00031160: 6e70 2e7a 6572 6f73 2873 6861 7065 2c20  np.zeros(shape, 
+00031170: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+00031180: 290a 2020 2020 2020 2020 6f75 7463 7478  ).        outctx
+00031190: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
+000311a0: 652c 2064 7479 7065 3d6e 702e 696e 7433  e, dtype=np.int3
+000311b0: 3229 0a0a 2020 2020 2320 446f 2064 7269  2)..    # Do dri
+000311c0: 7a7a 6c65 0a20 2020 204e 203d 206c 656e  zzle.    N = len
+000311d0: 2873 6369 5f6c 6973 7429 0a20 2020 2066  (sci_list).    f
+000311e0: 6f72 2069 2069 6e20 7261 6e67 6528 4e29  or i in range(N)
+000311f0: 3a0a 2020 2020 2020 2020 6966 2076 6572  :.        if ver
+00031200: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00031210: 2020 236c 6f67 2e69 6e66 6f28 2744 7269    #log.info('Dri
+00031220: 7a7a 6c65 2061 7272 6179 207b 307d 2f7b  zzle array {0}/{
+00031230: 317d 272e 666f 726d 6174 2869 2b31 2c20  1}'.format(i+1, 
+00031240: 4e29 290a 2020 2020 2020 2020 2020 2020  N)).            
+00031250: 6d73 6720 3d20 2744 7269 7a7a 6c65 2061  msg = 'Drizzle a
+00031260: 7272 6179 207b 307d 2f7b 317d 272e 666f  rray {0}/{1}'.fo
+00031270: 726d 6174 2869 2b31 2c20 4e29 0a20 2020  rmat(i+1, N).   
+00031280: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
+00031290: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
+000312a0: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
+000312b0: 7365 2c20 7368 6f77 5f64 6174 653d 5472  se, show_date=Tr
+000312c0: 7565 290a 0a20 2020 2020 2020 2069 6620  ue)..        if 
+000312d0: 6361 6c63 5f77 6373 6d61 7020 3e20 313a  calc_wcsmap > 1:
+000312e0: 0a20 2020 2020 2020 2020 2020 2077 6373  .            wcs
+000312f0: 6d61 7020 3d20 5743 534d 6170 416c 6c20  map = WCSMapAll 
+00031300: 2023 2028 7763 735f 6c69 7374 5b69 5d2c   # (wcs_list[i],
+00031310: 206f 7574 7075 7477 6373 290a 2020 2020   outputwcs).    
+00031320: 2020 2020 2020 2020 2377 6373 6d61 7020          #wcsmap 
+00031330: 3d20 6364 7269 7a2e 4465 6661 756c 7457  = cdriz.DefaultW
+00031340: 4353 4d61 7070 696e 670a 2020 2020 2020  CSMapping.      
+00031350: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00031360: 2020 2020 7763 736d 6170 203d 204e 6f6e      wcsmap = Non
+00031370: 650a 0a20 2020 2020 2020 2061 6472 697a  e..        adriz
+00031380: 7a6c 652e 646f 5f64 7269 7a28 7363 695f  zle.do_driz(sci_
+00031390: 6c69 7374 5b69 5d2e 6173 7479 7065 286e  list[i].astype(n
+000313a0: 702e 666c 6f61 7433 322c 2063 6f70 793d  p.float32, copy=
+000313b0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000313c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313d0: 2077 6373 5f6c 6973 745b 695d 2c0a 2020   wcs_list[i],.  
+000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2020 2020 2020 2077 6874 5f6c 6973 745b         wht_list[
+00031400: 695d 2e61 7374 7970 6528 6e70 2e66 6c6f  i].astype(np.flo
+00031410: 6174 3332 2c20 636f 7079 3d46 616c 7365  at32, copy=False
+00031420: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00031430: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00031440: 7574 7763 732c 206f 7574 7363 692c 206f  utwcs, outsci, o
+00031450: 7574 7768 742c 206f 7574 6374 782c 2031  utwht, outctx, 1
+00031460: 2e2c 2027 6370 7327 2c20 312c 0a20 2020  ., 'cps', 1,.   
+00031470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031480: 2020 2020 2020 7763 736c 696e 5f70 7363        wcslin_psc
+00031490: 616c 653d 7763 735f 6c69 7374 5b69 5d2e  ale=wcs_list[i].
+000314a0: 7073 6361 6c65 2c20 756e 6971 6964 3d31  pscale, uniqid=1
+000314b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000314c0: 2020 2020 2020 2020 2020 2070 6978 6672             pixfr
+000314d0: 6163 3d70 6978 6672 6163 2c20 6b65 726e  ac=pixfrac, kern
+000314e0: 656c 3d6b 6572 6e65 6c2c 2066 696c 6c76  el=kernel, fillv
+000314f0: 616c 3d27 3027 2c0a 2020 2020 2020 2020  al='0',.        
+00031500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031510: 2077 6373 6d61 703d 7763 736d 6170 290a   wcsmap=wcsmap).
+00031520: 0a20 2020 2072 6574 7572 6e20 6f75 7473  .    return outs
+00031530: 6369 2c20 6f75 7477 6874 2c20 6f75 7463  ci, outwht, outc
+00031540: 7478 2c20 6865 6164 6572 2c20 6f75 7470  tx, header, outp
+00031550: 7574 7763 730a 0a0a 636c 6173 7320 5743  utwcs...class WC
+00031560: 534d 6170 416c 6c3a 0a20 2020 2022 2222  SMapAll:.    """
+00031570: 2053 616d 706c 6520 636c 6173 7320 746f   Sample class to
+00031580: 2064 656d 6f6e 7374 7261 7465 2068 6f77   demonstrate how
+00031590: 2074 6f20 6465 6669 6e65 2061 2063 6f6f   to define a coo
+000315a0: 7264 696e 6174 6520 7472 616e 7366 6f72  rdinate transfor
+000315b0: 6d61 7469 6f6e 0a20 2020 2022 2222 0a0a  mation.    """..
+000315c0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000315d0: 2873 656c 662c 2069 6e70 7574 2c20 6f75  (self, input, ou
+000315e0: 7470 7574 2c20 6f72 6967 696e 3d30 293a  tput, origin=0):
+000315f0: 0a20 2020 2020 2020 2023 2056 6572 6966  .        # Verif
+00031600: 7920 7468 6174 2077 6520 6861 7665 2076  y that we have v
+00031610: 616c 6964 2057 4353 2069 6e70 7574 206f  alid WCS input o
+00031620: 626a 6563 7473 0a20 2020 2020 2020 2069  bjects.        i
+00031630: 6d70 6f72 7420 636f 7079 0a20 2020 2020  mport copy.     
+00031640: 2020 2073 656c 662e 6368 6563 6b57 4353     self.checkWCS
+00031650: 2869 6e70 7574 2c20 2749 6e70 7574 2729  (input, 'Input')
+00031660: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+00031670: 6563 6b57 4353 286f 7574 7075 742c 2027  eckWCS(output, '
+00031680: 4f75 7470 7574 2729 0a0a 2020 2020 2020  Output')..      
+00031690: 2020 7365 6c66 2e69 6e70 7574 203d 2069    self.input = i
+000316a0: 6e70 7574 0a20 2020 2020 2020 2073 656c  nput.        sel
+000316b0: 662e 6f75 7470 7574 203d 2063 6f70 792e  f.output = copy.
+000316c0: 6465 6570 636f 7079 286f 7574 7075 7429  deepcopy(output)
+000316d0: 0a20 2020 2020 2020 2023 7365 6c66 2e6f  .        #self.o
+000316e0: 7574 7075 7420 3d20 6f75 7470 7574 0a0a  utput = output..
+000316f0: 2020 2020 2020 2020 7365 6c66 2e6f 7269          self.ori
+00031700: 6769 6e20 3d20 3120 236f 7269 6769 6e0a  gin = 1 #origin.
+00031710: 2020 2020 2020 2020 7365 6c66 2e73 6869          self.shi
+00031720: 6674 203d 204e 6f6e 650a 2020 2020 2020  ft = None.      
+00031730: 2020 7365 6c66 2e72 6f74 203d 204e 6f6e    self.rot = Non
+00031740: 650a 2020 2020 2020 2020 7365 6c66 2e73  e.        self.s
+00031750: 6361 6c65 203d 204e 6f6e 650a 0a20 2020  cale = None..   
+00031760: 2064 6566 2063 6865 636b 5743 5328 7365   def checkWCS(se
+00031770: 6c66 2c20 6f62 6a2c 206e 616d 6529 3a0a  lf, obj, name):.
+00031780: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00031790: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000317a0: 6973 696e 7374 616e 6365 286f 626a 2c20  isinstance(obj, 
+000317b0: 7079 7763 732e 5743 5329 0a20 2020 2020  pywcs.WCS).     
+000317c0: 2020 2065 7863 6570 7420 4173 7365 7274     except Assert
+000317d0: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
+000317e0: 2020 2020 2020 7072 696e 7428 6e61 6d65        print(name
+000317f0: 202b 2027 206f 626a 6563 7420 6e65 6564   + ' object need
+00031800: 7320 746f 2062 6520 616e 2069 6e73 7461  s to be an insta
+00031810: 6e63 6520 6f72 2073 7562 636c 6173 7320  nce or subclass 
+00031820: 6f66 2061 2050 7957 4353 206f 626a 6563  of a PyWCS objec
+00031830: 742e 2729 0a20 2020 2020 2020 2020 2020  t.').           
+00031840: 2072 6169 7365 0a0a 2020 2020 6465 6620   raise..    def 
+00031850: 666f 7277 6172 6428 7365 6c66 2c20 7069  forward(self, pi
+00031860: 7878 2c20 7069 7879 293a 0a20 2020 2020  xx, pixy):.     
+00031870: 2020 2022 2222 2054 7261 6e73 666f 726d     """ Transform
+00031880: 2074 6865 2069 6e70 7574 2070 6978 782c   the input pixx,
+00031890: 7069 7879 2070 6f73 6974 696f 6e73 2069  pixy positions i
+000318a0: 6e20 7468 6520 696e 7075 7420 6672 616d  n the input fram
+000318b0: 650a 2020 2020 2020 2020 2020 2020 746f  e.            to
+000318c0: 2070 6978 656c 2070 6f73 6974 696f 6e73   pixel positions
+000318d0: 2069 6e20 7468 6520 6f75 7470 7574 2066   in the output f
+000318e0: 7261 6d65 2e0a 0a20 2020 2020 2020 2020  rame...         
+000318f0: 2020 2054 6869 7320 6d65 7468 6f64 2067     This method g
+00031900: 6574 7320 7061 7373 6564 2074 6f20 7468  ets passed to th
+00031910: 6520 6472 697a 7a6c 6520 616c 676f 7269  e drizzle algori
+00031920: 7468 6d2e 0a20 2020 2020 2020 2022 2222  thm..        """
+00031930: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+00031940: 6d61 7463 6865 7320 5754 5241 5859 2072  matches WTRAXY r
+00031950: 6573 756c 7473 2074 6f20 6265 7474 6572  esults to better
+00031960: 2074 6861 6e20 3165 2d34 2070 6978 656c   than 1e-4 pixel
+00031970: 732e 0a20 2020 2020 2020 2073 6b79 782c  s..        skyx,
+00031980: 2073 6b79 7920 3d20 7365 6c66 2e69 6e70   skyy = self.inp
+00031990: 7574 2e61 6c6c 5f70 6978 3277 6f72 6c64  ut.all_pix2world
+000319a0: 2870 6978 782c 2070 6978 792c 2073 656c  (pixx, pixy, sel
+000319b0: 662e 6f72 6967 696e 290a 2020 2020 2020  f.origin).      
+000319c0: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
+000319d0: 6f75 7470 7574 2e61 6c6c 5f77 6f72 6c64  output.all_world
+000319e0: 3270 6978 2873 6b79 782c 2073 6b79 792c  2pix(skyx, skyy,
+000319f0: 2073 656c 662e 6f72 6967 696e 290a 2020   self.origin).  
+00031a00: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00031a10: 756c 740a 0a20 2020 2064 6566 2062 6163  ult..    def bac
+00031a20: 6b77 6172 6428 7365 6c66 2c20 7069 7878  kward(self, pixx
+00031a30: 2c20 7069 7879 293a 0a20 2020 2020 2020  , pixy):.       
+00031a40: 2022 2222 2054 7261 6e73 666f 726d 2070   """ Transform p
+00031a50: 6978 782c 7069 7879 2070 6f73 6974 696f  ixx,pixy positio
+00031a60: 6e73 2066 726f 6d20 7468 6520 6f75 7470  ns from the outp
+00031a70: 7574 2066 7261 6d65 2062 6163 6b20 6f6e  ut frame back on
+00031a80: 746f 2074 6865 6972 0a20 2020 2020 2020  to their.       
+00031a90: 2020 2020 206f 7269 6769 6e61 6c20 706f       original po
+00031aa0: 7369 7469 6f6e 7320 696e 2074 6865 2069  sitions in the i
+00031ab0: 6e70 7574 2066 7261 6d65 2e0a 2020 2020  nput frame..    
+00031ac0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00031ad0: 736b 7978 2c20 736b 7979 203d 2073 656c  skyx, skyy = sel
+00031ae0: 662e 6f75 7470 7574 2e61 6c6c 5f70 6978  f.output.all_pix
+00031af0: 3277 6f72 6c64 2870 6978 782c 2070 6978  2world(pixx, pix
+00031b00: 792c 2073 656c 662e 6f72 6967 696e 290a  y, self.origin).
+00031b10: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00031b20: 2073 656c 662e 696e 7075 742e 616c 6c5f   self.input.all_
+00031b30: 776f 726c 6432 7069 7828 736b 7978 2c20  world2pix(skyx, 
+00031b40: 736b 7979 2c20 7365 6c66 2e6f 7269 6769  skyy, self.origi
+00031b50: 6e29 0a20 2020 2020 2020 2072 6574 7572  n).        retur
+00031b60: 6e20 7265 7375 6c74 0a0a 2020 2020 6465  n result..    de
+00031b70: 6620 6765 745f 7069 785f 7261 7469 6f28  f get_pix_ratio(
+00031b80: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00031b90: 2222 2052 6574 7572 6e20 7468 6520 7261  "" Return the ra
+00031ba0: 7469 6f20 6f66 2070 6c61 7465 2073 6361  tio of plate sca
+00031bb0: 6c65 7320 6265 7477 6565 6e20 7468 6520  les between the 
+00031bc0: 696e 7075 7420 616e 6420 6f75 7470 7574  input and output
+00031bd0: 2057 4353 2e0a 2020 2020 2020 2020 2020   WCS..          
+00031be0: 2020 5468 6973 2069 7320 7573 6564 2074    This is used t
+00031bf0: 6f20 7072 6f70 6572 6c79 2064 6973 7472  o properly distr
+00031c00: 6962 7574 6520 7468 6520 666c 7578 2069  ibute the flux i
+00031c10: 6e20 6561 6368 2070 6978 656c 2069 6e20  n each pixel in 
+00031c20: 2774 6472 697a 272e 0a20 2020 2020 2020  'tdriz'..       
+00031c30: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00031c40: 7572 6e20 7365 6c66 2e6f 7574 7075 742e  urn self.output.
+00031c50: 7073 6361 6c65 202f 2073 656c 662e 696e  pscale / self.in
+00031c60: 7075 742e 7073 6361 6c65 0a0a 2020 2020  put.pscale..    
+00031c70: 6465 6620 7879 3272 6428 7365 6c66 2c20  def xy2rd(self, 
+00031c80: 7763 732c 2070 6978 782c 2070 6978 7929  wcs, pixx, pixy)
+00031c90: 3a0a 2020 2020 2020 2020 2222 2220 5472  :.        """ Tr
+00031ca0: 616e 7366 6f72 6d20 696e 7075 7420 7069  ansform input pi
+00031cb0: 7865 6c20 706f 7369 7469 6f6e 7320 696e  xel positions in
+00031cc0: 746f 2073 6b79 2070 6f73 6974 696f 6e73  to sky positions
+00031cd0: 2069 6e20 7468 6520 5743 5320 7072 6f76   in the WCS prov
+00031ce0: 6964 6564 2e0a 2020 2020 2020 2020 2222  ided..        ""
+00031cf0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00031d00: 2077 6373 2e61 6c6c 5f70 6978 3277 6f72   wcs.all_pix2wor
+00031d10: 6c64 2870 6978 782c 2070 6978 792c 2031  ld(pixx, pixy, 1
+00031d20: 290a 0a20 2020 2064 6566 2072 6432 7879  )..    def rd2xy
+00031d30: 2873 656c 662c 2077 6373 2c20 7261 2c20  (self, wcs, ra, 
+00031d40: 6465 6329 3a0a 2020 2020 2020 2020 2222  dec):.        ""
+00031d50: 2220 5472 616e 7366 6f72 6d20 696e 7075  " Transform inpu
+00031d60: 7420 736b 7920 706f 7369 7469 6f6e 7320  t sky positions 
+00031d70: 696e 746f 2070 6978 656c 2070 6f73 6974  into pixel posit
+00031d80: 696f 6e73 2069 6e20 7468 6520 5743 5320  ions in the WCS 
+00031d90: 7072 6f76 6964 6564 2e0a 2020 2020 2020  provided..      
+00031da0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00031db0: 7475 726e 2077 6373 2e61 6c6c 5f77 6f72  turn wcs.all_wor
+00031dc0: 6c64 3270 6978 2872 612c 2064 6563 2c20  ld2pix(ra, dec, 
+00031dd0: 3129 0a0a 0a64 6566 2063 6f6d 7075 7465  1)...def compute
+00031de0: 5f6f 7574 7075 745f 7763 7328 7763 735f  _output_wcs(wcs_
+00031df0: 6c69 7374 2c20 7069 7865 6c5f 7363 616c  list, pixel_scal
+00031e00: 653d 302e 312c 206d 6178 5f73 697a 653d  e=0.1, max_size=
+00031e10: 3130 3030 3029 3a0a 2020 2020 2222 220a  10000):.    """.
+00031e20: 2020 2020 436f 6d70 7574 6520 6f75 7470      Compute outp
+00031e30: 7574 2057 4353 2074 6861 7420 636f 6e74  ut WCS that cont
+00031e40: 6169 6e73 2074 6865 2066 756c 6c20 6c69  ains the full li
+00031e50: 7374 206f 6620 696e 7075 7420 5743 530a  st of input WCS.
+00031e60: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00031e70: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00031e80: 2020 2077 6373 5f6c 6973 7420 3a20 6c69     wcs_list : li
+00031e90: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+00031ea0: 6f66 2069 6e64 6976 6964 7561 6c20 607e  of individual `~
+00031eb0: 6173 7472 6f70 792e 7763 732e 5743 5360  astropy.wcs.WCS`
+00031ec0: 206f 626a 6563 7473 2e0a 0a20 2020 2070   objects...    p
+00031ed0: 6978 656c 5f73 6361 6c65 203a 2074 7970  ixel_scale : typ
+00031ee0: 650a 2020 2020 2020 2020 5069 7865 6c20  e.        Pixel 
+00031ef0: 7363 616c 6520 6f66 2074 6865 206f 7574  scale of the out
+00031f00: 7075 7420 5743 530a 0a20 2020 206d 6178  put WCS..    max
+00031f10: 5f73 697a 6520 3a20 696e 740a 2020 2020  _size : int.    
+00031f20: 2020 2020 4d61 7869 6d75 6d20 7369 7a65      Maximum size
+00031f30: 206f 7574 2074 6865 206f 7574 7075 7420   out the output 
+00031f40: 696d 6167 6520 6469 6d65 6e73 696f 6e73  image dimensions
+00031f50: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00031f60: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6865    -------.    he
+00031f70: 6164 6572 203a 2060 7e61 7374 726f 7079  ader : `~astropy
+00031f80: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
+00031f90: 0a20 2020 2020 2020 2057 4353 2068 6561  .        WCS hea
+00031fa0: 6465 720a 0a20 2020 206f 7574 7075 7477  der..    outputw
+00031fb0: 6373 203a 2060 7e61 7374 726f 7079 2e77  cs : `~astropy.w
+00031fc0: 6373 2e57 4353 600a 2020 2020 2020 2020  cs.WCS`.        
+00031fd0: 4f75 7470 7574 2057 4353 0a0a 2020 2020  Output WCS..    
+00031fe0: 2222 220a 2020 2020 6672 6f6d 2073 6861  """.    from sha
+00031ff0: 7065 6c79 2e67 656f 6d65 7472 7920 696d  pely.geometry im
+00032000: 706f 7274 2050 6f6c 7967 6f6e 0a0a 2020  port Polygon..  
+00032010: 2020 666f 6f74 7072 696e 7420 3d20 506f    footprint = Po
+00032020: 6c79 676f 6e28 7763 735f 6c69 7374 5b30  lygon(wcs_list[0
+00032030: 5d2e 6361 6c63 5f66 6f6f 7470 7269 6e74  ].calc_footprint
+00032040: 2829 290a 2020 2020 666f 7220 6920 696e  ()).    for i in
+00032050: 2072 616e 6765 2831 2c20 6c65 6e28 7763   range(1, len(wc
+00032060: 735f 6c69 7374 2929 3a0a 2020 2020 2020  s_list)):.      
+00032070: 2020 6670 5f69 203d 2050 6f6c 7967 6f6e    fp_i = Polygon
+00032080: 2877 6373 5f6c 6973 745b 695d 2e63 616c  (wcs_list[i].cal
+00032090: 635f 666f 6f74 7072 696e 7428 2929 0a20  c_footprint()). 
+000320a0: 2020 2020 2020 2066 6f6f 7470 7269 6e74         footprint
+000320b0: 203d 2066 6f6f 7470 7269 6e74 2e75 6e69   = footprint.uni
+000320c0: 6f6e 2866 705f 6929 0a0a 2020 2020 782c  on(fp_i)..    x,
+000320d0: 2079 203d 2066 6f6f 7470 7269 6e74 2e63   y = footprint.c
+000320e0: 6f6e 7665 785f 6875 6c6c 2e62 6f75 6e64  onvex_hull.bound
+000320f0: 6172 792e 7879 0a20 2020 2078 2c20 7920  ary.xy.    x, y 
+00032100: 3d20 6e70 2e61 7272 6179 2878 292c 206e  = np.array(x), n
+00032110: 702e 6172 7261 7928 7929 0a0a 2020 2020  p.array(y)..    
+00032120: 2320 6365 6e74 6572 0a20 2020 2063 7276  # center.    crv
+00032130: 616c 203d 206e 702e 6172 7261 7928 666f  al = np.array(fo
+00032140: 6f74 7072 696e 742e 6365 6e74 726f 6964  otprint.centroid
+00032150: 2e78 7929 2e66 6c61 7474 656e 2829 0a0a  .xy).flatten()..
+00032160: 2020 2020 2320 6469 6d65 6e73 696f 6e73      # dimensions
+00032170: 2069 6e20 6172 6373 6563 0a20 2020 2078   in arcsec.    x
+00032180: 7369 7a65 203d 2028 782e 6d61 7828 292d  size = (x.max()-
+00032190: 782e 6d69 6e28 2929 2a6e 702e 636f 7328  x.min())*np.cos(
+000321a0: 6372 7661 6c5b 315d 2f31 3830 2a6e 702e  crval[1]/180*np.
+000321b0: 7069 292a 3336 3030 0a20 2020 2079 7369  pi)*3600.    ysi
+000321c0: 7a65 203d 2028 792e 6d61 7828 292d 792e  ze = (y.max()-y.
+000321d0: 6d69 6e28 2929 2a33 3630 300a 0a20 2020  min())*3600..   
+000321e0: 2078 7369 7a65 203d 206e 702e 6d69 6e69   xsize = np.mini
+000321f0: 6d75 6d28 7873 697a 652c 206d 6178 5f73  mum(xsize, max_s
+00032200: 697a 652a 7069 7865 6c5f 7363 616c 6529  ize*pixel_scale)
+00032210: 0a20 2020 2079 7369 7a65 203d 206e 702e  .    ysize = np.
+00032220: 6d69 6e69 6d75 6d28 7973 697a 652c 206d  minimum(ysize, m
+00032230: 6178 5f73 697a 652a 7069 7865 6c5f 7363  ax_size*pixel_sc
+00032240: 616c 6529 0a0a 2020 2020 6865 6164 6572  ale)..    header
+00032250: 2c20 6f75 7470 7574 7763 7320 3d20 6d61  , outputwcs = ma
+00032260: 6b65 5f77 6373 6865 6164 6572 2872 613d  ke_wcsheader(ra=
+00032270: 6372 7661 6c5b 305d 2c20 6465 633d 6372  crval[0], dec=cr
+00032280: 7661 6c5b 315d 2c0a 2020 2020 2020 2020  val[1],.        
+00032290: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+000322a0: 653d 2878 7369 7a65 2c20 7973 697a 6529  e=(xsize, ysize)
+000322b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000322c0: 2020 2020 2020 2070 6978 7363 616c 653d         pixscale=
+000322d0: 7069 7865 6c5f 7363 616c 652c 0a20 2020  pixel_scale,.   
+000322e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322f0: 2020 6765 745f 6864 753d 4661 6c73 652c    get_hdu=False,
+00032300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032310: 2020 2020 2020 7468 6574 613d 3029 0a0a        theta=0)..
+00032320: 2020 2020 7265 7475 726e 2068 6561 6465      return heade
+00032330: 722c 206f 7574 7075 7477 6373 0a0a 0a64  r, outputwcs...d
+00032340: 6566 2073 796d 6c69 6e6b 5f74 656d 706c  ef symlink_templ
+00032350: 6174 6573 2866 6f72 6365 3d46 616c 7365  ates(force=False
+00032360: 293a 0a20 2020 2022 2222 5379 6d6c 696e  ):.    """Symlin
+00032370: 6b20 7465 6d70 6c61 7465 7320 6672 6f6d  k templates from
+00032380: 206d 6f64 756c 6520 746f 2024 4752 495a   module to $GRIZ
+00032390: 4c49 2f74 656d 706c 6174 6573 2061 7320  LI/templates as 
+000323a0: 7061 7274 206f 6620 7468 6520 696e 6974  part of the init
+000323b0: 6961 6c20 7365 7475 700a 2020 2020 5061  ial setup.    Pa
+000323c0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+000323d0: 2d2d 2d2d 2d2d 2d0a 2020 2020 666f 7263  -------.    forc
+000323e0: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
+000323f0: 2046 6f72 6365 206c 696e 6b20 6669 6c65   Force link file
+00032400: 7320 6576 656e 2069 6620 7468 6579 2061  s even if they a
+00032410: 6c72 6561 6479 2065 7869 7374 2e0a 2020  lready exist..  
+00032420: 2020 2222 220a 2020 2020 2320 6966 2027    """.    # if '
+00032430: 4752 495a 4c49 2720 6e6f 7420 696e 206f  GRIZLI' not in o
+00032440: 732e 656e 7669 726f 6e3a 0a20 2020 2023  s.environ:.    #
+00032450: 2020 2020 2070 7269 6e74 2827 2247 5249       print('"GRI
+00032460: 5a4c 4922 2065 6e76 6972 6f6e 6d65 6e74  ZLI" environment
+00032470: 2076 6172 6961 626c 6520 6e6f 7420 7365   variable not se
+00032480: 7421 2729 0a20 2020 2023 2020 2020 2072  t!').    #     r
+00032490: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+000324a0: 206d 6f64 756c 655f 7061 7468 203d 206f   module_path = o
+000324b0: 732e 7061 7468 2e64 6972 6e61 6d65 285f  s.path.dirname(_
+000324c0: 5f66 696c 655f 5f29 0a20 2020 2074 656d  _file__).    tem
+000324d0: 706c 6174 6573 5f70 6174 6820 3d20 6f73  plates_path = os
+000324e0: 2e70 6174 682e 6a6f 696e 286d 6f64 756c  .path.join(modul
+000324f0: 655f 7061 7468 2c20 2764 6174 612f 7465  e_path, 'data/te
+00032500: 6d70 6c61 7465 7327 290a 0a20 2020 206f  mplates')..    o
+00032510: 7574 5f70 6174 6820 3d20 6f73 2e70 6174  ut_path = os.pat
+00032520: 682e 6a6f 696e 2847 5249 5a4c 495f 5041  h.join(GRIZLI_PA
+00032530: 5448 2c20 2774 656d 706c 6174 6573 2729  TH, 'templates')
+00032540: 0a0a 2020 2020 6966 2028 6e6f 7420 6f73  ..    if (not os
+00032550: 2e70 6174 682e 6578 6973 7473 286f 7574  .path.exists(out
+00032560: 5f70 6174 6829 2920 7c20 666f 7263 653a  _path)) | force:
+00032570: 0a20 2020 2020 2020 2069 6620 6f73 2e70  .        if os.p
+00032580: 6174 682e 6578 6973 7473 286f 7574 5f70  ath.exists(out_p
+00032590: 6174 6829 3a20 2023 2028 666f 7263 6529  ath):  # (force)
+000325a0: 0a20 2020 2020 2020 2020 2020 2073 6875  .            shu
+000325b0: 7469 6c2e 726d 7472 6565 286f 7574 5f70  til.rmtree(out_p
+000325c0: 6174 6829 0a0a 2020 2020 2020 2020 2020  ath)..          
+000325d0: 2020 6f73 2e73 796d 6c69 6e6b 2874 656d    os.symlink(tem
+000325e0: 706c 6174 6573 5f70 6174 682c 206f 7574  plates_path, out
+000325f0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+00032600: 2020 2070 7269 6e74 2827 5379 6d6c 696e     print('Symlin
+00032610: 6b3a 207b 307d 202d 3e20 7b31 7d27 2e66  k: {0} -> {1}'.f
+00032620: 6f72 6d61 7428 7465 6d70 6c61 7465 735f  ormat(templates_
+00032630: 7061 7468 2c20 6f75 745f 7061 7468 2929  path, out_path))
+00032640: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00032650: 2020 2070 7269 6e74 2827 5465 6d70 6c61     print('Templa
+00032660: 7465 7320 6469 7265 6374 6f72 7920 6578  tes directory ex
+00032670: 6973 7473 3a20 7b30 7d27 2e66 6f72 6d61  ists: {0}'.forma
+00032680: 7428 6f75 745f 7061 7468 2929 0a20 2020  t(out_path)).   
+00032690: 2020 2020 2070 7269 6e74 2827 5573 6520       print('Use 
+000326a0: 6066 6f72 6365 3d54 7275 6560 2074 6f20  `force=True` to 
+000326b0: 666f 7263 6520 6120 6e65 7720 7379 6d62  force a new symb
+000326c0: 6f6c 6963 206c 696e 6b2e 2729 0a0a 0a64  olic link.')...d
+000326d0: 6566 2066 6574 6368 5f61 6373 5f77 6373  ef fetch_acs_wcs
+000326e0: 5f66 696c 6573 2862 6561 6d73 5f66 696c  _files(beams_fil
+000326f0: 652c 2062 7563 6b65 745f 6e61 6d65 3d27  e, bucket_name='
+00032700: 6772 697a 6c69 2d76 3127 293a 0a20 2020  grizli-v1'):.   
+00032710: 2022 2222 0a20 2020 2046 6574 6368 2077   """.    Fetch w
+00032720: 6373 2066 696c 6573 2066 6f72 2061 2067  cs files for a g
+00032730: 6976 656e 2062 6561 6d73 2e66 6974 7320  iven beams.fits 
+00032740: 6669 6c65 730a 2020 2020 2222 220a 2020  files.    """.  
+00032750: 2020 6672 6f6d 2075 726c 6c69 6220 696d    from urllib im
+00032760: 706f 7274 2072 6571 7565 7374 0a20 2020  port request.   
+00032770: 2074 7279 3a0a 2020 2020 2020 2020 696d   try:.        im
+00032780: 706f 7274 2062 6f74 6f33 0a20 2020 2020  port boto3.     
+00032790: 2020 2048 4153 5f42 4f54 4f20 3d20 5472     HAS_BOTO = Tr
+000327a0: 7565 0a20 2020 2065 7863 6570 743a 0a20  ue.    except:. 
+000327b0: 2020 2020 2020 2048 4153 5f42 4f54 4f20         HAS_BOTO 
+000327c0: 3d20 4661 6c73 650a 0a20 2020 2069 6d20  = False..    im 
+000327d0: 3d20 7079 6669 7473 2e6f 7065 6e28 6265  = pyfits.open(be
+000327e0: 616d 735f 6669 6c65 290a 2020 2020 726f  ams_file).    ro
+000327f0: 6f74 203d 2027 5f27 2e6a 6f69 6e28 6265  ot = '_'.join(be
+00032800: 616d 735f 6669 6c65 2e73 706c 6974 2827  ams_file.split('
+00032810: 5f27 295b 3a2d 315d 290a 0a20 2020 2066  _')[:-1])..    f
+00032820: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00032830: 6e28 696d 2929 3a0a 2020 2020 2020 2020  n(im)):.        
+00032840: 6820 3d20 696d 5b69 5d2e 6865 6164 6572  h = im[i].header
+00032850: 0a20 2020 2020 2020 2069 6620 2745 5854  .        if 'EXT
+00032860: 4e41 4d45 2720 6e6f 7420 696e 2068 3a0a  NAME' not in h:.
+00032870: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00032880: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
+00032890: 2027 4649 4c54 4552 2720 6e6f 7420 696e   'FILTER' not in
+000328a0: 2068 3a0a 2020 2020 2020 2020 2020 2020   h:.            
+000328b0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+000328c0: 2020 6966 2028 685b 2745 5854 4e41 4d45    if (h['EXTNAME
+000328d0: 275d 2021 3d20 2753 4349 2729 207c 2028  '] != 'SCI') | (
+000328e0: 685b 2746 494c 5445 5227 5d20 6e6f 7420  h['FILTER'] not 
+000328f0: 696e 205b 2747 3830 304c 275d 293a 0a20  in ['G800L']):. 
+00032900: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00032910: 6e75 650a 0a20 2020 2020 2020 2065 7874  nue..        ext
+00032920: 203d 207b 313a 2032 2c20 323a 2031 7d5b   = {1: 2, 2: 1}[
+00032930: 685b 2743 4344 4348 4950 275d 5d0a 0a20  h['CCDCHIP']].. 
+00032940: 2020 2020 2020 2077 6373 6669 6c65 203d         wcsfile =
+00032950: 2068 5b27 4750 4152 454e 5427 5d2e 7265   h['GPARENT'].re
+00032960: 706c 6163 6528 272e 6669 7473 272c 2027  place('.fits', '
+00032970: 2e7b 303a 3032 647d 2e77 6373 2e66 6974  .{0:02d}.wcs.fit
+00032980: 7327 2e66 6f72 6d61 7428 6578 7429 290a  s'.format(ext)).
+00032990: 0a20 2020 2020 2020 2023 2044 6f77 6e6c  .        # Downl
+000329a0: 6f61 6420 7468 6520 6669 6c65 2077 6974  oad the file wit
+000329b0: 6820 5333 206f 7220 4854 5450 0a20 2020  h S3 or HTTP.   
+000329c0: 2020 2020 2069 6620 6e6f 7420 6f73 2e70       if not os.p
+000329d0: 6174 682e 6578 6973 7473 2877 6373 6669  ath.exists(wcsfi
+000329e0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+000329f0: 2070 7269 6e74 2827 4665 7463 6820 7b30   print('Fetch {0
+00032a00: 7d20 6672 6f6d 207b 317d 2f50 6970 656c  } from {1}/Pipel
+00032a10: 696e 652f 7b32 7d27 2e66 6f72 6d61 7428  ine/{2}'.format(
+00032a20: 7763 7366 696c 652c 0a20 2020 2020 2020  wcsfile,.       
+00032a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a60: 2020 2020 6275 636b 6574 5f6e 616d 652c      bucket_name,
+00032a70: 2072 6f6f 7429 290a 0a20 2020 2020 2020   root))..       
+00032a80: 2020 2020 2069 6620 4841 535f 424f 544f       if HAS_BOTO
+00032a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032aa0: 2020 7333 203d 2062 6f74 6f33 2e72 6573    s3 = boto3.res
+00032ab0: 6f75 7263 6528 2773 3327 290a 2020 2020  ource('s3').    
+00032ac0: 2020 2020 2020 2020 2020 2020 7333 5f63              s3_c
+00032ad0: 6c69 656e 7420 3d20 626f 746f 332e 636c  lient = boto3.cl
+00032ae0: 6965 6e74 2827 7333 2729 0a20 2020 2020  ient('s3').     
+00032af0: 2020 2020 2020 2020 2020 2062 6b74 203d             bkt =
+00032b00: 2073 332e 4275 636b 6574 2862 7563 6b65   s3.Bucket(bucke
+00032b10: 745f 6e61 6d65 290a 0a20 2020 2020 2020  t_name)..       
+00032b20: 2020 2020 2020 2020 2073 335f 7061 7468           s3_path
+00032b30: 203d 2027 5069 7065 6c69 6e65 2f7b 307d   = 'Pipeline/{0}
+00032b40: 2f45 7874 7261 6374 696f 6e73 2f7b 317d  /Extractions/{1}
+00032b50: 272e 666f 726d 6174 2872 6f6f 742c 2077  '.format(root, w
+00032b60: 6373 6669 6c65 290a 2020 2020 2020 2020  csfile).        
+00032b70: 2020 2020 2020 2020 626b 742e 646f 776e          bkt.down
+00032b80: 6c6f 6164 5f66 696c 6528 7333 5f70 6174  load_file(s3_pat
+00032b90: 682c 2027 2e2f 7b30 7d27 2e66 6f72 6d61  h, './{0}'.forma
+00032ba0: 7428 7763 7366 696c 6529 2c0a 2020 2020  t(wcsfile),.    
+00032bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032bc0: 2020 2020 2020 2020 2020 2020 2020 4578                Ex
+00032bd0: 7472 6141 7267 733d 7b22 5265 7175 6573  traArgs={"Reques
+00032be0: 7450 6179 6572 223a 2022 7265 7175 6573  tPayer": "reques
+00032bf0: 7465 7222 7d29 0a0a 2020 2020 2020 2020  ter"})..        
+00032c00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00032c10: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00032c20: 2768 7474 7073 3a2f 2f73 332e 616d 617a  'https://s3.amaz
+00032c30: 6f6e 6177 732e 636f 6d2f 7b30 7d2f 272e  onaws.com/{0}/'.
+00032c40: 666f 726d 6174 2862 7563 6b65 745f 6e61  format(bucket_na
+00032c50: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00032c60: 2020 2020 7572 6c20 2b3d 2027 5069 7065      url += 'Pipe
+00032c70: 6c69 6e65 2f7b 307d 2f45 7874 7261 6374  line/{0}/Extract
+00032c80: 696f 6e73 2f7b 317d 272e 666f 726d 6174  ions/{1}'.format
+00032c90: 2872 6f6f 742c 2077 6373 6669 6c65 290a  (root, wcsfile).
+00032ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032cb0: 2070 7269 6e74 2827 4665 7463 6820 5743   print('Fetch WC
+00032cc0: 5320 6669 6c65 3a20 7b30 7d27 2e66 6f72  S file: {0}'.for
+00032cd0: 6d61 7428 7572 6c29 290a 2020 2020 2020  mat(url)).      
+00032ce0: 2020 2020 2020 2020 2020 7265 7120 3d20            req = 
+00032cf0: 7265 7175 6573 742e 7572 6c72 6574 7269  request.urlretri
+00032d00: 6576 6528 7572 6c2c 2077 6373 6669 6c65  eve(url, wcsfile
+00032d10: 290a 0a20 2020 2069 6d2e 636c 6f73 6528  )..    im.close(
+00032d20: 290a 0a0a 6465 6620 6665 7463 685f 6873  )...def fetch_hs
+00032d30: 745f 6361 6c69 6228 6669 6c65 3d27 6972  t_calib(file='ir
+00032d40: 6566 2475 6337 3231 3133 6f69 5f70 666c  ef$uc72113oi_pfl
+00032d50: 2e66 6974 7327 2c20 2066 7470 6469 723d  .fits',  ftpdir=
+00032d60: 2768 7474 7073 3a2f 2f68 7374 2d63 7264  'https://hst-crd
+00032d70: 732e 7374 7363 692e 6564 752f 756e 6368  s.stsci.edu/unch
+00032d80: 6563 6b65 645f 6765 742f 7265 6665 7265  ecked_get/refere
+00032d90: 6e63 6573 2f68 7374 2f27 2c20 7665 7262  nces/hst/', verb
+00032da0: 6f73 653d 5472 7565 2c20 7265 665f 7061  ose=True, ref_pa
+00032db0: 7468 733d 7b7d 2c20 7265 6d6f 7665 5f63  ths={}, remove_c
+00032dc0: 6f72 7275 7074 3d54 7275 6529 3a0a 2020  orrupt=True):.  
+00032dd0: 2020 2222 220a 2020 2020 5442 440a 2020    """.    TBD.  
+00032de0: 2020 2222 220a 2020 2020 696d 706f 7274    """.    import
+00032df0: 206f 730a 0a20 2020 2072 6566 5f64 6972   os..    ref_dir
+00032e00: 203d 2066 696c 652e 7370 6c69 7428 2724   = file.split('$
+00032e10: 2729 5b30 5d0a 2020 2020 6369 6d67 203d  ')[0].    cimg =
+00032e20: 2066 696c 652e 7370 6c69 7428 277b 307d   file.split('{0}
+00032e30: 2427 2e66 6f72 6d61 7428 7265 665f 6469  $'.format(ref_di
+00032e40: 7229 295b 315d 0a20 2020 200a 2020 2020  r))[1].    .    
+00032e50: 6966 2072 6566 5f64 6972 2069 6e20 7265  if ref_dir in re
+00032e60: 665f 7061 7468 733a 0a20 2020 2020 2020  f_paths:.       
+00032e70: 2072 6566 5f70 6174 6820 3d20 7265 665f   ref_path = ref_
+00032e80: 7061 7468 735b 7265 665f 6469 725d 0a20  paths[ref_dir]. 
+00032e90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00032ea0: 2072 6566 5f70 6174 6820 3d20 6f73 2e67   ref_path = os.g
+00032eb0: 6574 656e 7628 7265 665f 6469 7229 0a20  etenv(ref_dir). 
+00032ec0: 2020 2020 2020 200a 2020 2020 6972 6566         .    iref
+00032ed0: 5f66 696c 6520 3d20 6f73 2e70 6174 682e  _file = os.path.
+00032ee0: 6a6f 696e 2872 6566 5f70 6174 682c 2063  join(ref_path, c
+00032ef0: 696d 6729 0a20 2020 2069 6620 6e6f 7420  img).    if not 
+00032f00: 6f73 2e70 6174 682e 6578 6973 7473 2869  os.path.exists(i
+00032f10: 7265 665f 6669 6c65 293a 0a20 2020 2020  ref_file):.     
+00032f20: 2020 206f 732e 7379 7374 656d 2827 6375     os.system('cu
+00032f30: 726c 202d 6f20 7b30 7d20 7b31 7d2f 7b32  rl -o {0} {1}/{2
+00032f40: 7d27 2e66 6f72 6d61 7428 6972 6566 5f66  }'.format(iref_f
+00032f50: 696c 652c 2066 7470 6469 722c 2063 696d  ile, ftpdir, cim
+00032f60: 6729 290a 2020 2020 2020 2020 6966 2027  g)).        if '
+00032f70: 6669 7473 2720 696e 2069 7265 665f 6669  fits' in iref_fi
+00032f80: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00032f90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00032fa0: 2020 2020 205f 696d 203d 2020 7079 6669       _im =  pyfi
+00032fb0: 7473 2e6f 7065 6e28 6972 6566 5f66 696c  ts.open(iref_fil
+00032fc0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00032fd0: 2020 205f 696d 2e63 6c6f 7365 2829 0a20     _im.close(). 
+00032fe0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00032ff0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00033000: 2020 206d 7367 203d 2028 2744 6f77 6e6c     msg = ('Downl
+00033010: 6f61 6465 6420 6669 6c65 207b 307d 2061  oaded file {0} a
+00033020: 7070 6561 7273 2074 6f20 6265 2063 6f72  ppears to be cor
+00033030: 7275 7074 2e5c 6e27 0a20 2020 2020 2020  rupt.\n'.       
+00033040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033050: 2743 6865 636b 2074 6861 7420 7b31 7d2f  'Check that {1}/
+00033060: 7b32 7d20 6578 6973 7473 2061 6e64 2069  {2} exists and i
+00033070: 7320 6120 7661 6c69 6420 6669 6c65 2729  s a valid file')
+00033080: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00033090: 2020 7072 696e 7428 6d73 672e 666f 726d    print(msg.form
+000330a0: 6174 2869 7265 665f 6669 6c65 2c20 6674  at(iref_file, ft
+000330b0: 7064 6972 2c20 6369 6d67 2929 0a20 2020  pdir, cimg)).   
+000330c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000330d0: 7265 6d6f 7665 5f63 6f72 7275 7074 3a0a  remove_corrupt:.
+000330e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330f0: 2020 2020 6f73 2e72 656d 6f76 6528 6972      os.remove(ir
+00033100: 6566 5f66 696c 6529 0a0a 2020 2020 2020  ef_file)..      
+00033110: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00033120: 2046 616c 7365 0a20 2020 2065 6c73 653a   False.    else:
+00033130: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
+00033140: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00033150: 2070 7269 6e74 2827 7b30 7d20 6578 6973   print('{0} exis
+00033160: 7473 272e 666f 726d 6174 2869 7265 665f  ts'.format(iref_
+00033170: 6669 6c65 2929 0a0a 2020 2020 7265 7475  file))..    retu
+00033180: 726e 2069 7265 665f 6669 6c65 0a0a 0a64  rn iref_file...d
+00033190: 6566 2066 6574 6368 5f68 7374 5f63 616c  ef fetch_hst_cal
+000331a0: 6962 7328 666c 745f 6669 6c65 2c20 6674  ibs(flt_file, ft
+000331b0: 7064 6972 3d27 6874 7470 733a 2f2f 6873  pdir='https://hs
+000331c0: 742d 6372 6473 2e73 7473 6369 2e65 6475  t-crds.stsci.edu
+000331d0: 2f75 6e63 6865 636b 6564 5f67 6574 2f72  /unchecked_get/r
+000331e0: 6566 6572 656e 6365 732f 6873 742f 272c  eferences/hst/',
+000331f0: 2063 616c 6962 5f74 7970 6573 3d5b 2742   calib_types=['B
+00033200: 5049 5854 4142 272c 2027 4343 4454 4142  PIXTAB', 'CCDTAB
+00033210: 272c 2027 4f53 434e 5441 4227 2c20 2743  ', 'OSCNTAB', 'C
+00033220: 5252 454a 5441 4227 2c20 2744 4152 4b46  RREJTAB', 'DARKF
+00033230: 494c 4527 2c20 274e 4c49 4e46 494c 4527  ILE', 'NLINFILE'
+00033240: 2c20 2744 464c 5446 494c 4527 2c27 5046  , 'DFLTFILE','PF
+00033250: 4c54 4649 4c45 272c 2027 494d 5048 5454  LTFILE', 'IMPHTT
+00033260: 4142 272c 2027 4944 4354 4142 272c 2027  AB', 'IDCTAB', '
+00033270: 4e50 4f4c 4649 4c45 275d 2c20 7665 7262  NPOLFILE'], verb
+00033280: 6f73 653d 5472 7565 2c20 7265 665f 7061  ose=True, ref_pa
+00033290: 7468 733d 7b7d 293a 0a20 2020 2022 2222  ths={}):.    """
+000332a0: 0a20 2020 2054 4244 0a20 2020 2046 6574  .    TBD.    Fet
+000332b0: 6368 206e 6563 6573 7361 7279 2063 616c  ch necessary cal
+000332c0: 6962 7261 7469 6f6e 2066 696c 6573 206e  ibration files n
+000332d0: 6565 6465 6420 666f 7220 7275 6e6e 696e  eeded for runnin
+000332e0: 6720 6361 6c77 6633 2066 726f 6d20 5354  g calwf3 from ST
+000332f0: 5363 4920 4654 500a 0a20 2020 204f 6c64  ScI FTP..    Old
+00033300: 2046 5450 2064 6972 3a20 6674 703a 2f2f   FTP dir: ftp://
+00033310: 6674 702e 7374 7363 692e 6564 752f 6364  ftp.stsci.edu/cd
+00033320: 6273 2f69 7265 662f 2222 220a 2020 2020  bs/iref/""".    
+00033330: 696d 706f 7274 206f 730a 0a20 2020 2069  import os..    i
+00033340: 6d20 3d20 7079 6669 7473 2e6f 7065 6e28  m = pyfits.open(
+00033350: 666c 745f 6669 6c65 290a 2020 2020 6966  flt_file).    if
+00033360: 2069 6d5b 305d 2e68 6561 6465 725b 2749   im[0].header['I
+00033370: 4e53 5452 554d 4527 5d20 3d3d 2027 4143  NSTRUME'] == 'AC
+00033380: 5327 3a0a 2020 2020 2020 2020 7265 665f  S':.        ref_
+00033390: 6469 7220 3d20 276a 7265 6627 0a0a 2020  dir = 'jref'..  
+000333a0: 2020 6966 2069 6d5b 305d 2e68 6561 6465    if im[0].heade
+000333b0: 725b 2749 4e53 5452 554d 4527 5d20 3d3d  r['INSTRUME'] ==
+000333c0: 2027 5746 4333 273a 0a20 2020 2020 2020   'WFC3':.       
+000333d0: 2072 6566 5f64 6972 203d 2027 6972 6566   ref_dir = 'iref
+000333e0: 270a 0a20 2020 2069 6620 696d 5b30 5d2e  '..    if im[0].
+000333f0: 6865 6164 6572 5b27 494e 5354 5255 4d45  header['INSTRUME
+00033400: 275d 203d 3d20 2757 4650 4332 273a 0a20  '] == 'WFPC2':. 
+00033410: 2020 2020 2020 2072 6566 5f64 6972 203d         ref_dir =
+00033420: 2027 7572 6566 270a 0a20 2020 2069 6620   'uref'..    if 
+00033430: 6e6f 7420 6f73 2e67 6574 656e 7628 7265  not os.getenv(re
+00033440: 665f 6469 7229 3a0a 2020 2020 2020 2020  f_dir):.        
+00033450: 7072 696e 7428 274e 6f20 247b 307d 2073  print('No ${0} s
+00033460: 6574 2120 2050 7574 2069 7420 696e 207e  et!  Put it in ~
+00033470: 2f2e 6261 7368 7263 206f 7220 7e2f 2e63  /.bashrc or ~/.c
+00033480: 7368 7263 2e27 2e66 6f72 6d61 7428 7265  shrc.'.format(re
+00033490: 665f 6469 7229 290a 2020 2020 2020 2020  f_dir)).        
+000334a0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+000334b0: 2020 6361 6c69 625f 7061 7468 7320 3d20    calib_paths = 
+000334c0: 5b5d 0a0a 2020 2020 666f 7220 6374 7970  []..    for ctyp
+000334d0: 6520 696e 2063 616c 6962 5f74 7970 6573  e in calib_types
+000334e0: 3a0a 2020 2020 2020 2020 6966 2063 7479  :.        if cty
+000334f0: 7065 206e 6f74 2069 6e20 696d 5b30 5d2e  pe not in im[0].
+00033500: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+00033510: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00033520: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00033530: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00033540: 696e 7428 2743 616c 6962 3a20 7b30 7d3d  int('Calib: {0}=
+00033550: 7b31 7d27 2e66 6f72 6d61 7428 6374 7970  {1}'.format(ctyp
+00033560: 652c 2069 6d5b 305d 2e68 6561 6465 725b  e, im[0].header[
+00033570: 6374 7970 655d 2929 0a0a 2020 2020 2020  ctype]))..      
+00033580: 2020 6966 2069 6d5b 305d 2e68 6561 6465    if im[0].heade
+00033590: 725b 6374 7970 655d 203d 3d20 274e 2f41  r[ctype] == 'N/A
+000335a0: 273a 0a20 2020 2020 2020 2020 2020 2063  ':.            c
+000335b0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+000335c0: 2070 6174 6820 3d20 6665 7463 685f 6873   path = fetch_hs
+000335d0: 745f 6361 6c69 6228 696d 5b30 5d2e 6865  t_calib(im[0].he
+000335e0: 6164 6572 5b63 7479 7065 5d2c 2066 7470  ader[ctype], ftp
+000335f0: 6469 723d 6674 7064 6972 2c0a 2020 2020  dir=ftpdir,.    
+00033600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033610: 2020 2020 2020 2020 2020 2076 6572 626f             verbo
+00033620: 7365 3d76 6572 626f 7365 2c20 7265 665f  se=verbose, ref_
+00033630: 7061 7468 733d 7265 665f 7061 7468 7329  paths=ref_paths)
+00033640: 0a20 2020 2020 2020 2063 616c 6962 5f70  .        calib_p
+00033650: 6174 6873 2e61 7070 656e 6428 7061 7468  aths.append(path
+00033660: 290a 2020 2020 0a20 2020 2069 6d2e 636c  ).    .    im.cl
+00033670: 6f73 6528 290a 2020 2020 0a20 2020 2072  ose().    .    r
+00033680: 6574 7572 6e20 6361 6c69 625f 7061 7468  eturn calib_path
+00033690: 730a 0a0a 6465 6620 6d61 7374 5f71 7565  s...def mast_que
+000336a0: 7279 5f66 726f 6d5f 6669 6c65 5f6c 6973  ry_from_file_lis
+000336b0: 7428 6669 6c65 733d 5b5d 2c20 6f73 5f6f  t(files=[], os_o
+000336c0: 7065 6e3d 5472 7565 293a 0a20 2020 2022  pen=True):.    "
+000336d0: 2222 0a20 2020 2047 656e 6572 6174 6520  "".    Generate 
+000336e0: 6120 4d41 5354 2071 7565 7279 206f 6e20  a MAST query on 
+000336f0: 6461 7461 7365 7473 2069 6e20 6120 6c69  datasets in a li
+00033700: 7374 2e0a 2020 2020 2222 220a 2020 2020  st..    """.    
+00033710: 6966 206c 656e 2866 696c 6573 2920 3d3d  if len(files) ==
+00033720: 2030 3a0a 2020 2020 2020 2020 6669 6c65   0:.        file
+00033730: 7320 3d20 676c 6f62 2e67 6c6f 6228 272a  s = glob.glob('*
+00033740: 7261 772e 6669 7473 2729 0a0a 2020 2020  raw.fits')..    
+00033750: 6966 206c 656e 2866 696c 6573 2920 3d3d  if len(files) ==
+00033760: 2030 3a0a 2020 2020 2020 2020 7072 696e   0:.        prin
+00033770: 7428 274e 6f20 6066 696c 6573 6020 7370  t('No `files` sp
+00033780: 6563 6966 6965 642e 2729 0a20 2020 2020  ecified.').     
+00033790: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000337a0: 0a20 2020 2064 6174 6173 6574 7320 3d20  .    datasets = 
+000337b0: 6e70 2e75 6e69 7175 6528 5b66 696c 655b  np.unique([file[
+000337c0: 3a36 5d2b 272a 2720 666f 7220 6669 6c65  :6]+'*' for file
+000337d0: 2069 6e20 6669 6c65 735d 292e 746f 6c69   in files]).toli
+000337e0: 7374 2829 0a20 2020 2055 524c 203d 2022  st().    URL = "
+000337f0: 6874 7470 3a2f 2f61 7263 6869 7665 2e73  http://archive.s
+00033800: 7473 6369 2e65 6475 2f68 7374 2f73 6561  tsci.edu/hst/sea
+00033810: 7263 682e 7068 703f 6163 7469 6f6e 3d53  rch.php?action=S
+00033820: 6561 7263 6826 220a 2020 2020 5552 4c20  earch&".    URL 
+00033830: 2b3d 2022 7363 695f 6461 7461 5f73 6574  += "sci_data_set
+00033840: 5f6e 616d 653d 222b 272c 272e 6a6f 696e  _name="+','.join
+00033850: 2864 6174 6173 6574 7329 0a20 2020 2069  (datasets).    i
+00033860: 6620 6f73 5f6f 7065 6e3a 0a20 2020 2020  f os_open:.     
+00033870: 2020 206f 732e 7379 7374 656d 2827 6f70     os.system('op
+00033880: 656e 2022 7b30 7d22 272e 666f 726d 6174  en "{0}"'.format
+00033890: 2855 524c 2929 0a0a 2020 2020 7265 7475  (URL))..    retu
+000338a0: 726e 2055 524c 0a0a 0a64 6566 2066 6574  rn URL...def fet
+000338b0: 6368 5f64 6566 6175 6c74 5f63 616c 6962  ch_default_calib
+000338c0: 7328 6765 745f 6163 733d 4661 6c73 652c  s(get_acs=False,
+000338d0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+000338e0: 2222 220a 2020 2020 4665 7463 6820 6120  """.    Fetch a 
+000338f0: 7365 7420 6f66 2064 6566 6175 6c74 2048  set of default H
+00033900: 5354 2063 616c 6962 7261 7469 6f6e 2066  ST calibration f
+00033910: 696c 6573 200a 2020 2020 2222 220a 2020  iles .    """.  
+00033920: 2020 7061 7468 7320 3d20 7b7d 0a20 2020    paths = {}.   
+00033930: 200a 2020 2020 666f 7220 7265 665f 6469   .    for ref_di
+00033940: 7220 696e 205b 2769 7265 6627 2c20 276a  r in ['iref', 'j
+00033950: 7265 6627 5d3a 0a20 2020 2020 2020 2068  ref']:.        h
+00033960: 6173 5f64 6972 203d 2054 7275 650a 2020  as_dir = True.  
+00033970: 2020 2020 2020 6966 206e 6f74 206f 732e        if not os.
+00033980: 6765 7465 6e76 2872 6566 5f64 6972 293a  getenv(ref_dir):
+00033990: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+000339a0: 2068 6173 5f64 6972 203d 2046 616c 7365   has_dir = False
+000339b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000339c0: 2020 2020 2023 2044 6f20 6469 7265 6374       # Do direct
+000339d0: 6f72 6965 7320 6578 6973 7420 696e 2047  ories exist in G
+000339e0: 5249 5a4c 495f 5041 5448 3f0a 2020 2020  RIZLI_PATH?.    
+000339f0: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
+00033a00: 7468 2e65 7869 7374 7328 6f73 2e70 6174  th.exists(os.pat
+00033a10: 682e 6a6f 696e 2847 5249 5a4c 495f 5041  h.join(GRIZLI_PA
+00033a20: 5448 2c20 7265 665f 6469 7229 293a 0a20  TH, ref_dir)):. 
+00033a30: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00033a40: 6173 5f64 6972 203d 2054 7275 650a 2020  as_dir = True.  
+00033a50: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00033a60: 7468 735b 7265 665f 6469 725d 203d 206f  ths[ref_dir] = o
+00033a70: 732e 7061 7468 2e6a 6f69 6e28 4752 495a  s.path.join(GRIZ
+00033a80: 4c49 5f50 4154 482c 2072 6566 5f64 6972  LI_PATH, ref_dir
+00033a90: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00033aa0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00033ab0: 735b 7265 665f 6469 725d 203d 206f 732e  s[ref_dir] = os.
+00033ac0: 6765 7465 6e76 2872 6566 5f64 6972 290a  getenv(ref_dir).
+00033ad0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00033ae0: 2020 2020 2069 6620 6e6f 7420 6861 735f       if not has_
+00033af0: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
+00033b00: 2070 7269 6e74 2822 2222 0a4e 6f20 247b   print(""".No ${
+00033b10: 307d 2073 6574 2120 204d 616b 6520 6120  0} set!  Make a 
+00033b20: 6469 7265 6374 6f72 7920 616e 6420 706f  directory and po
+00033b30: 696e 7420 746f 2069 7420 696e 207e 2f2e  int to it in ~/.
+00033b40: 6261 7368 7263 206f 7220 7e2f 2e63 7368  bashrc or ~/.csh
+00033b50: 7263 2e0a 466f 7220 6578 616d 706c 652c  rc..For example,
+00033b60: 0a0a 2020 2420 6d6b 6469 7220 2447 5249  ..  $ mkdir $GRI
+00033b70: 5a4c 492f 7b30 7d0a 2020 2420 6578 706f  ZLI/{0}.  $ expo
+00033b80: 7274 207b 307d 3d22 247b 4752 495a 4c49  rt {0}="${GRIZLI
+00033b90: 7d2f 7b30 7d2f 2220 2320 7075 7420 7468  }/{0}/" # put th
+00033ba0: 6973 2069 6e20 7e2f 2e62 6173 6872 630a  is in ~/.bashrc.
+00033bb0: 2222 222e 666f 726d 6174 2872 6566 5f64  """.format(ref_d
+00033bc0: 6972 2929 0a0a 2020 2020 2020 2020 2020  ir))..          
+00033bd0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00033be0: 2020 2020 2320 5746 4333 0a20 2020 2066      # WFC3.    f
+00033bf0: 696c 6573 203d 205b 2769 7265 6624 7563  iles = ['iref$uc
+00033c00: 3732 3131 336f 695f 7066 6c2e 6669 7473  72113oi_pfl.fits
+00033c10: 272c 2020 2320 4631 3035 5720 466c 6174  ',  # F105W Flat
+00033c20: 0a20 2020 2020 2020 2020 2020 2020 2769  .             'i
+00033c30: 7265 6624 7563 3732 3131 3433 695f 7066  ref$uc721143i_pf
+00033c40: 6c2e 6669 7473 272c 2020 2320 4631 3430  l.fits',  # F140
+00033c50: 5720 666c 6174 0a20 2020 2020 2020 2020  W flat.         
+00033c60: 2020 2020 2769 7265 6624 7534 6d31 3333      'iref$u4m133
+00033c70: 356c 695f 7066 6c2e 6669 7473 272c 2020  5li_pfl.fits',  
+00033c80: 2320 4731 3032 2066 6c61 740a 2020 2020  # G102 flat.    
+00033c90: 2020 2020 2020 2020 2027 6972 6566 2475           'iref$u
+00033ca0: 346d 3133 3335 6d69 5f70 666c 2e66 6974  4m1335mi_pfl.fit
+00033cb0: 7327 2c20 2023 2047 3134 3120 666c 6174  s',  # G141 flat
+00033cc0: 0a20 2020 2020 2020 2020 2020 2020 2769  .             'i
+00033cd0: 7265 6624 7733 6d31 3835 3235 695f 6964  ref$w3m18525i_id
+00033ce0: 632e 6669 7473 272c 2020 2320 4944 4354  c.fits',  # IDCT
+00033cf0: 4142 2064 6973 746f 7274 696f 6e20 7461  AB distortion ta
+00033d00: 626c 657d 0a20 2020 2020 2020 2020 2020  ble}.           
+00033d10: 2020 5d0a 2020 2020 0a20 2020 2069 6620    ].    .    if 
+00033d20: 2741 4353 2720 696e 206b 7761 7267 733a  'ACS' in kwargs:
+00033d30: 0a20 2020 2020 2020 2067 6574 5f61 6373  .        get_acs
+00033d40: 203d 206b 7761 7267 735b 2741 4353 275d   = kwargs['ACS']
+00033d50: 0a20 2020 2020 2020 200a 2020 2020 6966  .        .    if
+00033d60: 2067 6574 5f61 6373 3a0a 2020 2020 2020   get_acs:.      
+00033d70: 2020 6669 6c65 732e 6578 7465 6e64 285b    files.extend([
+00033d80: 276a 7265 6624 6e36 7531 3235 3932 6a5f  'jref$n6u12592j_
+00033d90: 7066 6c2e 6669 7473 272c 2020 2320 4638  pfl.fits',  # F8
+00033da0: 3134 2046 6c61 740a 2020 2020 2020 2020  14 Flat.        
+00033db0: 2020 2020 2020 2020 2020 2020 2020 276a                'j
+00033dc0: 7265 6624 6f38 3431 3335 306d 6a5f 7066  ref$o841350mj_pf
+00033dd0: 6c2e 6669 7473 272c 2020 2320 4738 3030  l.fits',  # G800
+00033de0: 4c20 666c 6174 5d29 0a20 2020 2020 2020  L flat]).       
+00033df0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00033e00: 6a72 6566 2476 3937 3138 3236 6a6a 5f6e  jref$v971826jj_n
+00033e10: 706c 2e66 6974 7327 5d29 0a0a 2020 2020  pl.fits'])..    
+00033e20: 666f 7220 6669 6c65 2069 6e20 6669 6c65  for file in file
+00033e30: 733a 0a20 2020 2020 2020 2066 6574 6368  s:.        fetch
+00033e40: 5f68 7374 5f63 616c 6962 2866 696c 652c  _hst_calib(file,
+00033e50: 2072 6566 5f70 6174 6873 3d70 6174 6873   ref_paths=paths
+00033e60: 290a 0a20 2020 2062 6164 7069 7820 3d20  )..    badpix = 
+00033e70: 6f73 2e70 6174 682e 6a6f 696e 2870 6174  os.path.join(pat
+00033e80: 6873 5b27 6972 6566 275d 2c20 2762 6164  hs['iref'], 'bad
+00033e90: 7069 785f 7370 6172 7332 3030 5f4e 6f76  pix_spars200_Nov
+00033ea0: 392e 6669 7473 2729 0a20 2020 2070 7269  9.fits').    pri
+00033eb0: 6e74 2827 4578 7472 6120 5746 4333 2f49  nt('Extra WFC3/I
+00033ec0: 5220 6261 6420 7069 7865 6c73 3a20 7b30  R bad pixels: {0
+00033ed0: 7d27 2e66 6f72 6d61 7428 6261 6470 6978  }'.format(badpix
+00033ee0: 2929 0a20 2020 2069 6620 6e6f 7420 6f73  )).    if not os
+00033ef0: 2e70 6174 682e 6578 6973 7473 2862 6164  .path.exists(bad
+00033f00: 7069 7829 3a0a 2020 2020 2020 2020 6f73  pix):.        os
+00033f10: 2e73 7973 7465 6d28 2763 7572 6c20 2d6f  .system('curl -o
+00033f20: 207b 307d 2f62 6164 7069 785f 7370 6172   {0}/badpix_spar
+00033f30: 7332 3030 5f4e 6f76 392e 6669 7473 2068  s200_Nov9.fits h
+00033f40: 7474 7073 3a2f 2f72 6177 2e67 6974 6875  ttps://raw.githu
+00033f50: 6275 7365 7263 6f6e 7465 6e74 2e63 6f6d  busercontent.com
+00033f60: 2f67 6272 616d 6d65 722f 7766 6333 2f6d  /gbrammer/wfc3/m
+00033f70: 6173 7465 722f 6461 7461 2f62 6164 7069  aster/data/badpi
+00033f80: 785f 7370 6172 7332 3030 5f4e 6f76 392e  x_spars200_Nov9.
+00033f90: 6669 7473 272e 666f 726d 6174 2870 6174  fits'.format(pat
+00033fa0: 6873 5b27 6972 6566 275d 2929 0a0a 2020  hs['iref']))..  
+00033fb0: 2020 2320 5069 7865 6c20 6172 6561 206d    # Pixel area m
+00033fc0: 6170 0a20 2020 2070 616d 203d 206f 732e  ap.    pam = os.
+00033fd0: 7061 7468 2e6a 6f69 6e28 7061 7468 735b  path.join(paths[
+00033fe0: 2769 7265 6627 5d2c 2027 6972 5f77 6663  'iref'], 'ir_wfc
+00033ff0: 335f 6d61 702e 6669 7473 2729 0a20 2020  3_map.fits').   
+00034000: 2070 7269 6e74 2827 5069 7865 6c20 6172   print('Pixel ar
+00034010: 6561 206d 6170 3a20 7b30 7d27 2e66 6f72  ea map: {0}'.for
+00034020: 6d61 7428 7061 6d29 290a 2020 2020 6966  mat(pam)).    if
+00034030: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
+00034040: 7374 7328 7061 6d29 3a0a 2020 2020 2020  sts(pam):.      
+00034050: 2020 6f73 2e73 7973 7465 6d28 2763 7572    os.system('cur
+00034060: 6c20 2d6f 207b 307d 2068 7474 7073 3a2f  l -o {0} https:/
+00034070: 2f77 7777 2e73 7473 6369 2e65 6475 2f66  /www.stsci.edu/f
+00034080: 696c 6573 2f6c 6976 652f 7369 7465 732f  iles/live/sites/
+00034090: 7777 772f 6669 6c65 732f 686f 6d65 2f68  www/files/home/h
+000340a0: 7374 2f69 6e73 7472 756d 656e 7461 7469  st/instrumentati
+000340b0: 6f6e 2f77 6663 332f 6461 7461 2d61 6e61  on/wfc3/data-ana
+000340c0: 6c79 7369 732f 7069 7865 6c2d 6172 6561  lysis/pixel-area
+000340d0: 2d6d 6170 732f 5f64 6f63 756d 656e 7473  -maps/_documents
+000340e0: 2f69 725f 7766 6333 5f6d 6170 2e66 6974  /ir_wfc3_map.fit
+000340f0: 7327 2e66 6f72 6d61 7428 7061 6d29 290a  s'.format(pam)).
+00034100: 0a0a 6465 6620 6665 7463 685f 7766 7063  ..def fetch_wfpc
+00034110: 325f 6361 6c69 6228 6669 6c65 3d27 6736  2_calib(file='g6
+00034120: 7131 3931 3268 755f 7234 662e 6669 7473  q1912hu_r4f.fits
+00034130: 272c 2070 6174 683d 6f73 2e67 6574 656e  ', path=os.geten
+00034140: 7628 2775 7265 6627 292c 2075 7365 5f6d  v('uref'), use_m
+00034150: 6173 743d 4661 6c73 652c 2076 6572 626f  ast=False, verbo
+00034160: 7365 3d54 7275 652c 206f 7665 7277 7269  se=True, overwri
+00034170: 7465 3d54 7275 652c 2073 6b69 705f 6578  te=True, skip_ex
+00034180: 6973 7469 6e67 3d54 7275 6529 3a0a 2020  isting=True):.  
+00034190: 2020 2222 220a 2020 2020 4665 7463 6820    """.    Fetch 
+000341a0: 7374 6174 6963 2057 4650 4332 2063 616c  static WFPC2 cal
+000341b0: 6962 7261 7469 6f6e 2066 696c 6520 616e  ibration file an
+000341c0: 6420 7275 6e20 6073 7473 6369 2e74 6f6f  d run `stsci.too
+000341d0: 6c73 2e63 6f6e 7665 7274 7761 6976 6572  ls.convertwaiver
+000341e0: 6564 6669 7473 6020 6f6e 2069 742e 0a0a  edfits` on it...
+000341f0: 2020 2020 7061 7468 203a 2073 7472 0a20      path : str. 
+00034200: 2020 2020 2020 204f 7574 7075 7420 7061         Output pa
+00034210: 7468 206f 6620 7468 6520 7265 6665 7265  th of the refere
+00034220: 6e63 6520 6669 6c65 2028 6765 6e65 7261  nce file (genera
+00034230: 6c6c 7920 7368 6f75 6c64 2062 6520 696e  lly should be in
+00034240: 2024 7572 6566 292e 0a0a 2020 2020 7573   $uref)...    us
+00034250: 655f 6d61 7374 203a 2062 6f6f 6c0a 2020  e_mast : bool.  
+00034260: 2020 2020 2020 4966 2054 7275 652c 2074        If True, t
+00034270: 7279 2074 6f20 6665 7463 6820 6672 6f6d  ry to fetch from
+00034280: 2022 6d61 7374 2e73 7473 6369 2e65 6475   "mast.stsci.edu
+00034290: 2f2f 6170 692f 7630 2f64 6f77 6e6c 6f61  //api/v0/downloa
+000342a0: 642f 6669 6c65 3f75 7269 222c 0a20 2020  d/file?uri",.   
+000342b0: 2020 2020 206f 7468 6572 7769 7365 2c20       otherwise, 
+000342c0: 6665 7463 6820 6672 6f6d 2061 2073 7461  fetch from a sta
+000342d0: 7469 6320 6469 7265 6374 6f72 790a 2020  tic directory.  
+000342e0: 2020 2020 2020 2273 7362 2e73 7473 6369        "ssb.stsci
+000342f0: 2e65 6475 2f63 6462 735f 6f70 656e 2f63  .edu/cdbs_open/c
+00034300: 6462 732f 7572 6566 5f6c 696e 7578 2f22  dbs/uref_linux/"
+00034310: 2e0a 0a20 2020 2022 2222 0a20 2020 2066  ...    """.    f
+00034320: 726f 6d20 7374 7363 692e 746f 6f6c 7320  rom stsci.tools 
+00034330: 696d 706f 7274 2063 6f6e 7665 7274 7761  import convertwa
+00034340: 6976 6572 6564 6669 7473 0a0a 2020 2020  iveredfits..    
+00034350: 7472 793a 2020 2320 5079 7468 6f6e 2033  try:  # Python 3
+00034360: 2e78 0a20 2020 2020 2020 2069 6d70 6f72  .x.        impor
+00034370: 7420 6874 7470 2e63 6c69 656e 7420 6173  t http.client as
+00034380: 2068 7474 706c 6962 0a20 2020 2065 7863   httplib.    exc
+00034390: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
+000343a0: 2020 2320 5079 7468 6f6e 2032 2e78 0a20    # Python 2.x. 
+000343b0: 2020 2020 2020 2069 6d70 6f72 7420 6874         import ht
+000343c0: 7470 6c69 620a 0a20 2020 2069 6620 6669  tplib..    if fi
+000343d0: 6c65 2e65 6e64 7377 6974 6828 2768 2729  le.endswith('h')
+000343e0: 3a0a 2020 2020 2020 2020 2320 4669 6c65  :.        # File
+000343f0: 206c 696b 6520 2267 3671 3139 3132 6875   like "g6q1912hu
+00034400: 2e72 3468 220a 2020 2020 2020 2020 6669  .r4h".        fi
+00034410: 6c65 203d 2066 696c 655b 3a2d 315d 2e72  le = file[:-1].r
+00034420: 6570 6c61 6365 2827 2e27 2c20 275f 2729  eplace('.', '_')
+00034430: 2b27 662e 6669 7473 270a 0a20 2020 206f  +'f.fits'..    o
+00034440: 7574 5061 7468 203d 206f 732e 7061 7468  utPath = os.path
+00034450: 2e6a 6f69 6e28 7061 7468 2c20 6669 6c65  .join(path, file
+00034460: 290a 2020 2020 6966 206f 732e 7061 7468  ).    if os.path
+00034470: 2e65 7869 7374 7328 6f75 7450 6174 6829  .exists(outPath)
+00034480: 2026 2073 6b69 705f 6578 6973 7469 6e67   & skip_existing
+00034490: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+000344a0: 2223 2066 6574 6368 5f77 6670 6332 5f63  "# fetch_wfpc2_c
+000344b0: 616c 6962 3a20 7b30 7d20 6578 6973 7473  alib: {0} exists
+000344c0: 222e 666f 726d 6174 286f 7574 5061 7468  ".format(outPath
+000344d0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+000344e0: 6e20 5472 7565 0a0a 2020 2020 6966 2075  n True..    if u
+000344f0: 7365 5f6d 6173 743a 0a20 2020 2020 2020  se_mast:.       
+00034500: 2073 6572 7665 7220 3d20 276d 6173 742e   server = 'mast.
+00034510: 7374 7363 692e 6564 7527 0a20 2020 2020  stsci.edu'.     
+00034520: 2020 2075 7269 203d 2027 6d61 7374 3a48     uri = 'mast:H
+00034530: 5354 2f70 726f 6475 6374 2f27 2b66 696c  ST/product/'+fil
+00034540: 650a 2020 2020 2020 2020 7265 7175 6573  e.        reques
+00034550: 745f 7061 7468 203d 2022 2f61 7069 2f76  t_path = "/api/v
+00034560: 302f 646f 776e 6c6f 6164 2f66 696c 653f  0/download/file?
+00034570: 7572 693d 222b 7572 690a 2020 2020 656c  uri="+uri.    el
+00034580: 7365 3a0a 2020 2020 2020 2020 7365 7276  se:.        serv
+00034590: 6572 203d 2027 7373 622e 7374 7363 692e  er = 'ssb.stsci.
+000345a0: 6564 7527 0a20 2020 2020 2020 2072 6571  edu'.        req
+000345b0: 7565 7374 5f70 6174 6820 3d20 272f 6364  uest_path = '/cd
+000345c0: 6273 5f6f 7065 6e2f 6364 6273 2f75 7265  bs_open/cdbs/ure
+000345d0: 665f 6c69 6e75 782f 272b 6669 6c65 0a0a  f_linux/'+file..
+000345e0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+000345f0: 2020 2020 2020 2020 7072 696e 7428 2723          print('#
+00034600: 2066 6574 6368 5f77 6670 6332 5f63 616c   fetch_wfpc2_cal
+00034610: 6962 3a20 227b 307d 2220 746f 207b 317d  ib: "{0}" to {1}
+00034620: 272e 666f 726d 6174 2873 6572 7665 722b  '.format(server+
+00034630: 7265 7175 6573 745f 7061 7468 2c20 7061  request_path, pa
+00034640: 7468 2929 0a0a 2020 2020 636f 6e6e 203d  th))..    conn =
+00034650: 2068 7474 706c 6962 2e48 5454 5053 436f   httplib.HTTPSCo
+00034660: 6e6e 6563 7469 6f6e 2873 6572 7665 7229  nnection(server)
+00034670: 0a0a 2020 2020 636f 6e6e 2e72 6571 7565  ..    conn.reque
+00034680: 7374 2822 4745 5422 2c20 7265 7175 6573  st("GET", reques
+00034690: 745f 7061 7468 290a 2020 2020 7265 7370  t_path).    resp
+000346a0: 203d 2063 6f6e 6e2e 6765 7472 6573 706f   = conn.getrespo
+000346b0: 6e73 6528 290a 2020 2020 6669 6c65 436f  nse().    fileCo
+000346c0: 6e74 656e 7420 3d20 7265 7370 2e72 6561  ntent = resp.rea
+000346d0: 6428 290a 2020 2020 636f 6e6e 2e63 6c6f  d().    conn.clo
+000346e0: 7365 2829 0a0a 2020 2020 2320 6368 6563  se()..    # chec
+000346f0: 6b20 666f 7220 6669 6c65 0a20 2020 2069  k for file.    i
+00034700: 6620 6c65 6e28 6669 6c65 436f 6e74 656e  f len(fileConten
+00034710: 7429 203c 2034 3039 363a 0a20 2020 2020  t) < 4096:.     
+00034720: 2020 2070 7269 6e74 2827 4552 524f 523a     print('ERROR:
+00034730: 2022 7b30 7d22 2066 6169 6c65 6420 746f   "{0}" failed to
+00034740: 2064 6f77 6e6c 6f61 642e 2020 5472 7920   download.  Try 
+00034750: 6075 7365 5f6d 6173 743d 7b31 7d60 2e27  `use_mast={1}`.'
+00034760: 2e66 6f72 6d61 7428 7365 7276 6572 2b72  .format(server+r
+00034770: 6571 7565 7374 5f70 6174 682c 2028 7573  equest_path, (us
+00034780: 655f 6d61 7374 2069 7320 4661 6c73 6529  e_mast is False)
+00034790: 2929 0a20 2020 2020 2020 2073 7461 7475  )).        statu
+000347a0: 7320 3d20 4661 6c73 650a 2020 2020 2020  s = False.      
+000347b0: 2020 7261 6973 6520 4669 6c65 4e6f 7446    raise FileNotF
+000347c0: 6f75 6e64 4572 726f 720a 2020 2020 656c  oundError.    el
+000347d0: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+000347e0: 7428 2223 2066 6574 6368 5f77 6670 6332  t("# fetch_wfpc2
+000347f0: 5f63 616c 6962 3a20 7b30 7d20 2843 4f4d  _calib: {0} (COM
+00034800: 504c 4554 4529 222e 666f 726d 6174 286f  PLETE)".format(o
+00034810: 7574 5061 7468 2929 0a20 2020 2020 2020  utPath)).       
+00034820: 2073 7461 7475 7320 3d20 5472 7565 0a0a   status = True..
+00034830: 2020 2020 2320 7361 7665 2074 6f20 6669      # save to fi
+00034840: 6c65 0a20 2020 2077 6974 6820 6f70 656e  le.    with open
+00034850: 286f 7574 5061 7468 2c20 2777 6227 2920  (outPath, 'wb') 
+00034860: 6173 2046 4c45 3a0a 2020 2020 2020 2020  as FLE:.        
+00034870: 464c 452e 7772 6974 6528 6669 6c65 436f  FLE.write(fileCo
+00034880: 6e74 656e 7429 0a0a 2020 2020 6966 2073  ntent)..    if s
+00034890: 7461 7475 733a 0a20 2020 2020 2020 2023  tatus:.        #
+000348a0: 2043 6f6e 7665 7274 2074 6f20 7374 616e   Convert to stan
+000348b0: 6461 7264 2046 4954 530a 2020 2020 2020  dard FITS.      
+000348c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000348d0: 2020 2068 6475 203d 2063 6f6e 7665 7274     hdu = convert
+000348e0: 7761 6976 6572 6564 6669 7473 2e63 6f6e  waiveredfits.con
+000348f0: 7665 7274 7761 6976 6572 6564 6669 7473  vertwaiveredfits
+00034900: 286f 7574 5061 7468 290a 2020 2020 2020  (outPath).      
+00034910: 2020 2020 2020 7768 696c 6520 2748 4953        while 'HIS
+00034920: 544f 5259 2720 696e 2068 6475 5b30 5d2e  TORY' in hdu[0].
+00034930: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+00034940: 2020 2020 2020 2020 6864 755b 305d 2e68          hdu[0].h
+00034950: 6561 6465 722e 7265 6d6f 7665 2827 4849  eader.remove('HI
+00034960: 5354 4f52 5927 290a 0a20 2020 2020 2020  STORY')..       
+00034970: 2020 2020 2068 6475 2e77 7269 7465 746f       hdu.writeto
+00034980: 286f 7574 5061 7468 2e72 6570 6c61 6365  (outPath.replace
+00034990: 2827 2e66 6974 7327 2c20 275f 6330 682e  ('.fits', '_c0h.
+000349a0: 6669 7473 2729 2c0a 2020 2020 2020 2020  fits'),.        
+000349b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000349c0: 6f76 6572 7772 6974 653d 6f76 6572 7772  overwrite=overwr
+000349d0: 6974 652c 206f 7574 7075 745f 7665 7269  ite, output_veri
+000349e0: 6679 3d27 6669 7827 290a 2020 2020 2020  fy='fix').      
+000349f0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+00034a00: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00034a10: 650a 0a0a 6465 6620 6665 7463 685f 6e69  e...def fetch_ni
+00034a20: 7263 616d 5f73 6b79 666c 6174 7328 293a  rcam_skyflats():
+00034a30: 0a20 2020 2022 2222 0a20 2020 2044 6f77  .    """.    Dow
+00034a40: 6e6c 6f61 6420 736b 7966 6c61 7420 6669  nload skyflat fi
+00034a50: 6c65 730a 2020 2020 2222 220a 2020 2020  les.    """.    
+00034a60: 636f 6e66 5f70 6174 6820 3d20 6f73 2e70  conf_path = os.p
+00034a70: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
+00034a80: 5041 5448 2c20 2743 4f4e 4627 2c20 274e  PATH, 'CONF', 'N
+00034a90: 6972 6361 6d53 6b79 466c 6174 2729 0a20  ircamSkyFlat'). 
+00034aa0: 2020 206f 732e 7379 7374 656d 2866 2761     os.system(f'a
+00034ab0: 7773 2073 3320 7379 6e63 2073 333a 2f2f  ws s3 sync s3://
+00034ac0: 6772 697a 6c69 2d76 322f 4e69 7263 616d  grizli-v2/Nircam
+00034ad0: 536b 7966 6c61 7473 2f20 7b63 6f6e 665f  Skyflats/ {conf_
+00034ae0: 7061 7468 7d20 2d2d 6578 636c 7564 6520  path} --exclude 
+00034af0: 222a 2220 2d2d 696e 636c 7564 6520 226e  "*" --include "n
+00034b00: 7263 2a66 6974 7322 2729 0a20 2020 200a  rc*fits"').    .
+00034b10: 2020 2020 5f66 696c 6573 203d 2067 6c6f      _files = glo
+00034b20: 622e 676c 6f62 2863 6f6e 665f 7061 7468  b.glob(conf_path
+00034b30: 2b27 2f2a 6669 7473 2729 0a20 2020 205f  +'/*fits').    _
+00034b40: 6669 6c65 732e 736f 7274 2829 0a20 2020  files.sort().   
+00034b50: 200a 2020 2020 7265 7475 726e 205f 6669   .    return _fi
+00034b60: 6c65 730a 0a0a 6465 6620 6665 7463 685f  les...def fetch_
+00034b70: 636f 6e66 6967 5f66 696c 6573 2867 6574  config_files(get
+00034b80: 5f61 6373 3d46 616c 7365 2c20 6765 745f  _acs=False, get_
+00034b90: 736b 793d 5472 7565 2c20 6765 745f 7374  sky=True, get_st
+00034ba0: 6172 733d 5472 7565 2c20 6765 745f 6570  ars=True, get_ep
+00034bb0: 7366 3d54 7275 652c 2067 6574 5f6a 7773  sf=True, get_jws
+00034bc0: 743d 4661 6c73 652c 2067 6574 5f77 6663  t=False, get_wfc
+00034bd0: 333d 5472 7565 2c20 2a2a 6b77 6172 6773  3=True, **kwargs
+00034be0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+00034bf0: 6f6e 6669 6720 6669 6c65 7320 6e65 6564  onfig files need
+00034c00: 6564 2066 6f72 2047 7269 7a6c 690a 2020  ed for Grizli.  
+00034c10: 2020 2222 220a 2020 2020 6966 2027 4143    """.    if 'AC
+00034c20: 5327 2069 6e20 6b77 6172 6773 3a0a 2020  S' in kwargs:.  
+00034c30: 2020 2020 2020 6765 745f 6163 7320 3d20        get_acs = 
+00034c40: 6b77 6172 6773 5b27 4143 5327 5d0a 0a20  kwargs['ACS'].. 
+00034c50: 2020 2063 7764 203d 206f 732e 6765 7463     cwd = os.getc
+00034c60: 7764 2829 0a0a 2020 2020 7072 696e 7428  wd()..    print(
+00034c70: 2743 6f6e 6669 6720 6469 7265 6374 6f72  'Config director
+00034c80: 793a 207b 307d 2f43 4f4e 4627 2e66 6f72  y: {0}/CONF'.for
+00034c90: 6d61 7428 4752 495a 4c49 5f50 4154 4829  mat(GRIZLI_PATH)
+00034ca0: 290a 0a20 2020 206f 732e 6368 6469 7228  )..    os.chdir(
+00034cb0: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
+00034cc0: 5a4c 495f 5041 5448 2c20 2743 4f4e 4627  ZLI_PATH, 'CONF'
+00034cd0: 2929 0a0a 2020 2020 6674 7064 6972 203d  ))..    ftpdir =
+00034ce0: 2027 6674 703a 2f2f 6674 702e 7374 7363   'ftp://ftp.stsc
+00034cf0: 692e 6564 752f 6364 6273 2f77 6663 335f  i.edu/cdbs/wfc3_
+00034d00: 6175 782f 270a 2020 2020 7461 7266 696c  aux/'.    tarfil
+00034d10: 6573 203d 205b 5d0a 0a20 2020 2023 2043  es = []..    # C
+00034d20: 6f6e 6669 6720 6669 6c65 730a 2020 2020  onfig files.    
+00034d30: 2320 4241 5345 5552 4c20 3d20 2768 7474  # BASEURL = 'htt
+00034d40: 7073 3a2f 2f73 332e 616d 617a 6f6e 6177  ps://s3.amazonaw
+00034d50: 732e 636f 6d2f 6772 697a 6c69 2f43 4f4e  s.com/grizli/CON
+00034d60: 462f 270a 2020 2020 2320 4241 5345 5552  F/'.    # BASEUR
+00034d70: 4c20 3d20 2768 7474 7073 3a2f 2f65 7264  L = 'https://erd
+00034d80: 612e 6b75 2e64 6b2f 7667 7269 642f 4761  a.ku.dk/vgrid/Ga
+00034d90: 6272 6965 6c25 3230 4272 616d 6d65 722f  briel%20Brammer/
+00034da0: 434f 4e46 2f27 0a20 2020 2042 4153 4555  CONF/'.    BASEU
+00034db0: 524c 203d 2028 2768 7474 7073 3a2f 2f72  RL = ('https://r
+00034dc0: 6177 2e67 6974 6875 6275 7365 7263 6f6e  aw.githubusercon
+00034dd0: 7465 6e74 2e63 6f6d 2f67 6272 616d 6d65  tent.com/gbramme
+00034de0: 722f 2720 2b0a 2020 2020 2020 2020 2020  r/' +.          
+00034df0: 2020 2020 2027 6772 697a 6c69 2d63 6f6e       'grizli-con
+00034e00: 6669 672f 6d61 7374 6572 2729 0a0a 2020  fig/master')..  
+00034e10: 2020 6966 2067 6574 5f77 6663 333a 0a20    if get_wfc3:. 
+00034e20: 2020 2020 2020 2074 6172 6669 6c65 7320         tarfiles 
+00034e30: 3d20 5b27 7b30 7d2f 5746 4333 2e49 522e  = ['{0}/WFC3.IR.
+00034e40: 4731 3032 2e63 616c 2e56 342e 3332 2e74  G102.cal.V4.32.t
+00034e50: 6172 2e67 7a27 2e66 6f72 6d61 7428 6674  ar.gz'.format(ft
+00034e60: 7064 6972 292c 0a20 2020 2020 2020 2020  pdir),.         
+00034e70: 2020 2020 2020 2020 2020 2027 7b30 7d2f             '{0}/
+00034e80: 5746 4333 2e49 522e 4731 3431 2e63 616c  WFC3.IR.G141.cal
+00034e90: 2e56 342e 3332 2e74 6172 2e67 7a27 2e66  .V4.32.tar.gz'.f
+00034ea0: 6f72 6d61 7428 6674 7064 6972 295d 0a20  ormat(ftpdir)]. 
+00034eb0: 2020 2020 2020 2074 6172 6669 6c65 7320         tarfiles 
+00034ec0: 2b3d 205b 6627 7b42 4153 4555 524c 7d2f  += [f'{BASEURL}/
+00034ed0: 5746 4333 2e49 522e 4731 3032 2e57 442e  WFC3.IR.G102.WD.
+00034ee0: 5634 2e33 322e 7461 722e 677a 272c 200a  V4.32.tar.gz', .
+00034ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f00: 2020 2020 6627 7b42 4153 4555 524c 7d2f      f'{BASEURL}/
+00034f10: 5746 4333 2e49 522e 4731 3431 2e57 442e  WFC3.IR.G141.WD.
+00034f20: 5634 2e33 322e 7461 722e 677a 275d 0a0a  V4.32.tar.gz']..
+00034f30: 2020 2020 6966 2067 6574 5f6a 7773 743a      if get_jwst:
+00034f40: 0a20 2020 2020 2020 2074 6172 6669 6c65  .        tarfile
+00034f50: 7320 2b3d 205b 6627 7b42 4153 4555 524c  s += [f'{BASEURL
+00034f60: 7d2f 6a77 7374 2d67 7269 736d 2d63 6f6e  }/jwst-grism-con
+00034f70: 662e 7461 722e 677a 272c 200a 2020 2020  f.tar.gz', .    
+00034f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f90: 2066 277b 4241 5345 5552 4c7d 2f6e 6972   f'{BASEURL}/nir
+00034fa0: 6973 732e 636f 6e66 2e32 3230 3732 352e  iss.conf.220725.
+00034fb0: 7461 722e 677a 272c 0a20 2020 2020 2020  tar.gz',.       
+00034fc0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00034fd0: 7b42 4153 4555 524c 7d2f 6e69 7263 616d  {BASEURL}/nircam
+00034fe0: 2d77 6973 702d 6175 6732 3032 322e 7461  -wisp-aug2022.ta
+00034ff0: 722e 677a 275d 0a20 2020 200a 2020 2020  r.gz'].    .    
+00035000: 6966 2067 6574 5f73 6b79 3a0a 2020 2020  if get_sky:.    
+00035010: 2020 2020 6674 7064 6972 203d 2042 4153      ftpdir = BAS
+00035020: 4555 524c 0a20 2020 2020 2020 2074 6172  EURL.        tar
+00035030: 6669 6c65 732e 6170 7065 6e64 2827 7b30  files.append('{0
+00035040: 7d2f 6772 6973 6d5f 6d61 7374 6572 5f73  }/grism_master_s
+00035050: 6b79 5f76 302e 352e 7461 722e 677a 272e  ky_v0.5.tar.gz'.
+00035060: 666f 726d 6174 2866 7470 6469 7229 290a  format(ftpdir)).
+00035070: 0a20 2020 2023 6755 524c 203d 2027 6874  .    #gURL = 'ht
+00035080: 7470 3a2f 2f77 7777 2e73 7473 6369 2e65  tp://www.stsci.e
+00035090: 6475 2f7e 6272 616d 6d65 722f 4772 697a  du/~brammer/Griz
+000350a0: 6c69 2f46 696c 6573 270a 2020 2020 2367  li/Files'.    #g
+000350b0: 5552 4c20 3d20 2768 7474 7073 3a2f 2f73  URL = 'https://s
+000350c0: 332e 616d 617a 6f6e 6177 732e 636f 6d2f  3.amazonaws.com/
+000350d0: 6772 697a 6c69 2f43 4f4e 4627 0a20 2020  grizli/CONF'.   
+000350e0: 2067 5552 4c20 3d20 4241 5345 5552 4c0a   gURL = BASEURL.
+000350f0: 2020 2020 0a20 2020 2074 6172 6669 6c65      .    tarfile
+00035100: 732e 6170 7065 6e64 2827 7b30 7d2f 5746  s.append('{0}/WF
+00035110: 4333 4952 5f65 7874 656e 6465 645f 5053  C3IR_extended_PS
+00035120: 462e 7631 2e74 6172 2e67 7a27 2e66 6f72  F.v1.tar.gz'.for
+00035130: 6d61 7428 6755 524c 2929 0a0a 2020 2020  mat(gURL))..    
+00035140: 6966 2067 6574 5f61 6373 3a0a 2020 2020  if get_acs:.    
+00035150: 2020 2020 7461 7266 696c 6573 202b 3d20      tarfiles += 
+00035160: 5b66 277b 4241 5345 5552 4c7d 2f41 4353  [f'{BASEURL}/ACS
+00035170: 2e57 4643 2e43 4849 5031 2e53 7461 7273  .WFC.CHIP1.Stars
+00035180: 2e63 6f6e 6627 2c20 0a20 2020 2020 2020  .conf', .       
+00035190: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+000351a0: 4241 5345 5552 4c7d 2f41 4353 2e57 4643  BASEURL}/ACS.WFC
+000351b0: 2e43 4849 5032 2e53 7461 7273 2e63 6f6e  .CHIP2.Stars.con
+000351c0: 6627 5d0a 2020 2020 2020 2020 7461 7266  f'].        tarf
+000351d0: 696c 6573 2e61 7070 656e 6428 277b 307d  iles.append('{0}
+000351e0: 2f41 4353 2e57 4643 2e73 6b79 2e74 6172  /ACS.WFC.sky.tar
+000351f0: 2e67 7a27 2e66 6f72 6d61 7428 6755 524c  .gz'.format(gURL
+00035200: 2929 0a20 2020 2020 2020 2074 6172 6669  )).        tarfi
+00035210: 6c65 732e 6170 7065 6e64 2827 7b30 7d2f  les.append('{0}/
+00035220: 4143 535f 434f 4e46 4947 2e74 6172 2e67  ACS_CONFIG.tar.g
+00035230: 7a27 2e66 6f72 6d61 7428 6755 524c 2929  z'.format(gURL))
+00035240: 0a0a 2020 2020 666f 7220 7572 6c20 696e  ..    for url in
+00035250: 2074 6172 6669 6c65 733a 0a20 2020 2020   tarfiles:.     
+00035260: 2020 2066 696c 6520 3d20 6f73 2e70 6174     file = os.pat
+00035270: 682e 6261 7365 6e61 6d65 2875 726c 290a  h.basename(url).
+00035280: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
+00035290: 732e 7061 7468 2e65 7869 7374 7328 6669  s.path.exists(fi
+000352a0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+000352b0: 2070 7269 6e74 2827 4765 7420 7b30 7d27   print('Get {0}'
+000352c0: 2e66 6f72 6d61 7428 6669 6c65 2929 0a20  .format(file)). 
+000352d0: 2020 2020 2020 2020 2020 206f 732e 7379             os.sy
+000352e0: 7374 656d 2827 6375 726c 202d 6f20 7b30  stem('curl -o {0
+000352f0: 7d20 7b31 7d27 2e66 6f72 6d61 7428 6669  } {1}'.format(fi
+00035300: 6c65 2c20 7572 6c29 290a 0a20 2020 2020  le, url))..     
+00035310: 2020 2069 6620 272e 7461 7227 2069 6e20     if '.tar' in 
+00035320: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+00035330: 2020 6f73 2e73 7973 7465 6d28 2774 6172    os.system('tar
+00035340: 2078 7a76 6620 7b30 7d27 2e66 6f72 6d61   xzvf {0}'.forma
+00035350: 7428 6669 6c65 2929 0a0a 2020 2020 6966  t(file))..    if
+00035360: 2067 6574 5f65 7073 663a 0a20 2020 2020   get_epsf:.     
+00035370: 2020 2023 2065 5053 4620 6669 6c65 7320     # ePSF files 
+00035380: 666f 7220 6669 7474 696e 6720 706f 696e  for fitting poin
+00035390: 7420 736f 7572 6365 730a 2020 2020 2020  t sources.      
+000353a0: 2020 2370 7366 5f70 6174 6820 3d20 2768    #psf_path = 'h
+000353b0: 7474 703a 2f2f 7777 772e 7374 7363 692e  ttp://www.stsci.
+000353c0: 6564 752f 6873 742f 7766 6333 2f61 6e61  edu/hst/wfc3/ana
+000353d0: 6c79 7369 732f 5053 462f 7073 665f 646f  lysis/PSF/psf_do
+000353e0: 776e 6c6f 6164 732f 7766 6333 5f69 722f  wnloads/wfc3_ir/
+000353f0: 270a 2020 2020 2020 2020 2370 7366 5f70  '.        #psf_p
+00035400: 6174 6820 3d20 2768 7474 7073 3a2f 2f77  ath = 'https://w
+00035410: 7777 2e73 7473 6369 2e65 6475 2f7e 6a61  ww.stsci.edu/~ja
+00035420: 7961 6e64 6572 2f53 5444 5053 4673 2f57  yander/STDPSFs/W
+00035430: 4643 3349 522f 270a 2020 2020 2020 2020  FC3IR/'.        
+00035440: 2370 7366 5f72 6f6f 7420 3d20 2750 5346  #psf_root = 'PSF
+00035450: 5354 4427 0a20 2020 2020 2020 2023 7073  STD'.        #ps
+00035460: 665f 7061 7468 203d 2027 6874 7470 733a  f_path = 'https:
+00035470: 2f2f 7777 772e 7374 7363 692e 6564 752f  //www.stsci.edu/
+00035480: 7e6a 6179 616e 6465 722f 4853 5431 5041  ~jayander/HST1PA
+00035490: 5353 2f27 0a20 2020 2020 2020 2070 7366  SS/'.        psf
+000354a0: 5f70 6174 6820 3d20 2768 7474 7073 3a2f  _path = 'https:/
+000354b0: 2f77 7777 2e73 7473 6369 2e65 6475 2f7e  /www.stsci.edu/~
+000354c0: 6a61 7961 6e64 6572 2f48 5354 3150 4153  jayander/HST1PAS
+000354d0: 532f 4c49 422f 270a 2020 2020 2020 2020  S/LIB/'.        
+000354e0: 7073 665f 7061 7468 202b 3d20 2750 5346  psf_path += 'PSF
+000354f0: 732f 5354 4450 5346 732f 5746 4333 4952  s/STDPSFs/WFC3IR
+00035500: 2f27 0a20 2020 2020 2020 2070 7366 5f72  /'.        psf_r
+00035510: 6f6f 7420 3d20 2753 5444 5053 4627 0a20  oot = 'STDPSF'. 
+00035520: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00035530: 6972 5f70 7366 5f66 696c 7465 7273 203d  ir_psf_filters =
+00035540: 205b 2746 3130 3557 272c 2027 4631 3235   ['F105W', 'F125
+00035550: 5727 2c20 2746 3134 3057 272c 2027 4631  W', 'F140W', 'F1
+00035560: 3630 5727 5d0a 0a20 2020 2020 2020 2023  60W']..        #
+00035570: 204e 6577 2050 5346 730a 2020 2020 2020   New PSFs.      
+00035580: 2020 6972 5f70 7366 5f66 696c 7465 7273    ir_psf_filters
+00035590: 202b 3d20 5b27 4631 3130 5727 2c20 2746   += ['F110W', 'F
+000355a0: 3132 374d 275d 0a0a 2020 2020 2020 2020  127M']..        
+000355b0: 6669 6c65 7320 3d20 5b27 7b30 7d2f 7b31  files = ['{0}/{1
+000355c0: 7d5f 5746 4333 4952 5f7b 327d 2e66 6974  }_WFC3IR_{2}.fit
+000355d0: 7327 2e66 6f72 6d61 7428 7073 665f 7061  s'.format(psf_pa
+000355e0: 7468 2c20 7073 665f 726f 6f74 2c20 6669  th, psf_root, fi
+000355f0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+00035600: 2020 2020 2066 6f72 2066 696c 7420 696e       for filt in
+00035610: 2069 725f 7073 665f 6669 6c74 6572 735d   ir_psf_filters]
+00035620: 0a0a 2020 2020 2020 2020 666f 7220 7572  ..        for ur
+00035630: 6c20 696e 2066 696c 6573 3a0a 2020 2020  l in files:.    
+00035640: 2020 2020 2020 2020 6669 6c65 203d 206f          file = o
+00035650: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+00035660: 7572 6c29 2e72 6570 6c61 6365 2827 5354  url).replace('ST
+00035670: 4450 5346 272c 2027 5053 4653 5444 2729  DPSF', 'PSFSTD')
+00035680: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00035690: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
+000356a0: 7473 2866 696c 6529 3a0a 2020 2020 2020  ts(file):.      
+000356b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000356c0: 2747 6574 207b 307d 272e 666f 726d 6174  'Get {0}'.format
+000356d0: 2866 696c 6529 290a 2020 2020 2020 2020  (file)).        
+000356e0: 2020 2020 2020 2020 6f73 2e73 7973 7465          os.syste
+000356f0: 6d28 2763 7572 6c20 2d6f 207b 307d 207b  m('curl -o {0} {
+00035700: 317d 272e 666f 726d 6174 2866 696c 652c  1}'.format(file,
+00035710: 2075 726c 2929 0a20 2020 2020 2020 2020   url)).         
+00035720: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00035730: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00035740: 4669 6c65 207b 307d 2065 7869 7374 7327  File {0} exists'
+00035750: 2e66 6f72 6d61 7428 6669 6c65 2929 0a0a  .format(file))..
+00035760: 2020 2020 6966 2067 6574 5f73 7461 7273      if get_stars
+00035770: 3a0a 2020 2020 2020 2020 2320 5374 656c  :.        # Stel
+00035780: 6c61 7220 7465 6d70 6c61 7465 730a 2020  lar templates.  
+00035790: 2020 2020 2020 7072 696e 7428 2754 656d        print('Tem
+000357a0: 706c 6174 6573 2064 6972 6563 746f 7279  plates directory
+000357b0: 3a20 7b30 7d2f 7465 6d70 6c61 7465 7327  : {0}/templates'
+000357c0: 2e66 6f72 6d61 7428 4752 495a 4c49 5f50  .format(GRIZLI_P
+000357d0: 4154 4829 290a 2020 2020 2020 2020 6f73  ATH)).        os
+000357e0: 2e63 6864 6972 2827 7b30 7d2f 7465 6d70  .chdir('{0}/temp
+000357f0: 6c61 7465 7327 2e66 6f72 6d61 7428 4752  lates'.format(GR
+00035800: 495a 4c49 5f50 4154 4829 290a 0a20 2020  IZLI_PATH))..   
+00035810: 2020 2020 2075 726c 203d 2027 6874 7470       url = 'http
+00035820: 733a 2f2f 7777 772e 7374 7363 692e 6564  s://www.stsci.ed
+00035830: 752f 7e62 7261 6d6d 6572 2f47 7269 7a6c  u/~brammer/Grizl
+00035840: 692f 4669 6c65 732f 270a 2020 2020 2020  i/Files/'.      
+00035850: 2020 6669 6c65 7320 3d20 5b75 726c 2b27    files = [url+'
+00035860: 7374 6172 735f 7069 636b 6c65 732e 6e70  stars_pickles.np
+00035870: 7927 2c20 7572 6c2b 2773 7461 7273 5f62  y', url+'stars_b
+00035880: 7067 732e 6e70 7927 5d0a 0a20 2020 2020  pgs.npy']..     
+00035890: 2020 2066 6f72 2075 726c 2069 6e20 6669     for url in fi
+000358a0: 6c65 733a 0a20 2020 2020 2020 2020 2020  les:.           
+000358b0: 2066 696c 6520 3d20 6f73 2e70 6174 682e   file = os.path.
+000358c0: 6261 7365 6e61 6d65 2875 726c 290a 2020  basename(url).  
+000358d0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000358e0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
+000358f0: 6669 6c65 293a 0a20 2020 2020 2020 2020  file):.         
+00035900: 2020 2020 2020 2070 7269 6e74 2827 4765         print('Ge
+00035910: 7420 7b30 7d27 2e66 6f72 6d61 7428 6669  t {0}'.format(fi
+00035920: 6c65 2929 0a20 2020 2020 2020 2020 2020  le)).           
+00035930: 2020 2020 206f 732e 7379 7374 656d 2827       os.system('
+00035940: 6375 726c 202d 6f20 7b30 7d20 7b31 7d27  curl -o {0} {1}'
+00035950: 2e66 6f72 6d61 7428 6669 6c65 2c20 7572  .format(file, ur
+00035960: 6c29 290a 2020 2020 2020 2020 2020 2020  l)).            
+00035970: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00035980: 2020 2020 2020 7072 696e 7428 2746 696c        print('Fil
+00035990: 6520 7b30 7d20 6578 6973 7473 272e 666f  e {0} exists'.fo
+000359a0: 726d 6174 2866 696c 6529 290a 0a20 2020  rmat(file))..   
+000359b0: 2020 2020 2070 7269 6e74 2827 6c6e 202d       print('ln -
+000359c0: 7320 7374 6172 735f 7069 636b 6c65 732e  s stars_pickles.
+000359d0: 6e70 7920 7374 6172 732e 6e70 7927 290a  npy stars.npy').
+000359e0: 2020 2020 2020 2020 6f73 2e73 7973 7465          os.syste
+000359f0: 6d28 276c 6e20 2d73 2073 7461 7273 5f70  m('ln -s stars_p
+00035a00: 6963 6b6c 6573 2e6e 7079 2073 7461 7273  ickles.npy stars
+00035a10: 2e6e 7079 2729 0a0a 2020 2020 6f73 2e63  .npy')..    os.c
+00035a20: 6864 6972 2863 7764 290a 0a0a 636c 6173  hdir(cwd)...clas
+00035a30: 7320 4d57 5f46 3939 286f 626a 6563 7429  s MW_F99(object)
+00035a40: 3a0a 2020 2020 2222 220a 2020 2020 5772  :.    """.    Wr
+00035a50: 6170 7065 7220 6172 6f75 6e64 2074 6865  apper around the
+00035a60: 2060 7370 6563 7574 696c 732e 6578 7469   `specutils.exti
+00035a70: 6e63 7469 6f6e 6020 2f20 6065 7874 696e  nction` / `extin
+00035a80: 6374 696f 6e60 206d 6f64 756c 6573 2c20  ction` modules, 
+00035a90: 7768 6963 6820 6172 6520 6361 6c6c 6564  which are called
+00035aa0: 2064 6966 6665 7265 6e74 6c79 0a20 2020   differently.   
+00035ab0: 2022 2222 0a0a 2020 2020 6465 6620 5f5f   """..    def __
+00035ac0: 696e 6974 5f5f 2873 656c 662c 2061 5f76  init__(self, a_v
+00035ad0: 2c20 725f 763d 332e 3129 3a0a 2020 2020  , r_v=3.1):.    
+00035ae0: 2020 2020 7365 6c66 2e61 5f76 203d 2061      self.a_v = a
+00035af0: 5f76 0a20 2020 2020 2020 2073 656c 662e  _v.        self.
+00035b00: 725f 7620 3d20 725f 760a 0a20 2020 2020  r_v = r_v..     
+00035b10: 2020 2073 656c 662e 4953 5f53 5045 4355     self.IS_SPECU
+00035b20: 5449 4c53 203d 2046 616c 7365 0a20 2020  TILS = False.   
+00035b30: 2020 2020 2073 656c 662e 4953 5f45 5854       self.IS_EXT
+00035b40: 494e 4354 494f 4e20 3d20 4661 6c73 650a  INCTION = False.
+00035b50: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00035b60: 2020 2020 2020 2020 2020 6672 6f6d 2073            from s
+00035b70: 7065 6375 7469 6c73 2e65 7874 696e 6374  pecutils.extinct
+00035b80: 696f 6e20 696d 706f 7274 2045 7874 696e  ion import Extin
+00035b90: 6374 696f 6e46 3939 0a20 2020 2020 2020  ctionF99.       
+00035ba0: 2020 2020 2073 656c 662e 4953 5f53 5045       self.IS_SPE
+00035bb0: 4355 5449 4c53 203d 2054 7275 650a 2020  CUTILS = True.  
+00035bc0: 2020 2020 2020 2020 2020 7365 6c66 2e46            self.F
+00035bd0: 3939 203d 2045 7874 696e 6374 696f 6e46  99 = ExtinctionF
+00035be0: 3939 2873 656c 662e 615f 762c 2072 5f76  99(self.a_v, r_v
+00035bf0: 3d73 656c 662e 725f 7629 0a20 2020 2020  =self.r_v).     
+00035c00: 2020 2065 7863 6570 7428 496d 706f 7274     except(Import
+00035c10: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00035c20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00035c30: 2020 2020 2020 2020 2066 726f 6d20 6578           from ex
+00035c40: 7469 6e63 7469 6f6e 2069 6d70 6f72 7420  tinction import 
+00035c50: 4669 747a 7061 7472 6963 6b39 390a 2020  Fitzpatrick99.  
+00035c60: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00035c70: 6c66 2e49 535f 4558 5449 4e43 5449 4f4e  lf.IS_EXTINCTION
+00035c80: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00035c90: 2020 2020 2020 2020 7365 6c66 2e46 3939          self.F99
+00035ca0: 203d 2046 6974 7a70 6174 7269 636b 3939   = Fitzpatrick99
+00035cb0: 2872 5f76 3d73 656c 662e 725f 7629 0a0a  (r_v=self.r_v)..
+00035cc0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00035cd0: 7074 2849 6d70 6f72 7445 7272 6f72 293a  pt(ImportError):
+00035ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035cf0: 2070 7269 6e74 2822 2222 0a43 6f75 6c64   print(""".Could
+00035d00: 6e5c 2774 2066 696e 6420 6578 7469 6e63  n\'t find extinc
+00035d10: 7469 6f6e 206d 6f64 756c 6573 2069 6e0a  tion modules in.
+00035d20: 6073 7065 6375 7469 6c73 2e65 7874 696e  `specutils.extin
+00035d30: 6374 696f 6e60 206f 720a 6065 7874 696e  ction` or.`extin
+00035d40: 6374 696f 6e2e 4669 747a 7061 7472 6963  ction.Fitzpatric
+00035d50: 6b39 3960 2e0a 0a4d 5720 6578 7469 6e63  k99`...MW extinc
+00035d60: 7469 6f6e 206e 6f74 2069 6d70 6c65 6d65  tion not impleme
+00035d70: 6e74 6564 2e0a 2222 2229 0a0a 2020 2020  nted..""")..    
+00035d80: 2020 2020 7365 6c66 2e73 7461 7475 7320      self.status 
+00035d90: 3d20 7365 6c66 2e49 535f 5350 4543 5554  = self.IS_SPECUT
+00035da0: 494c 5320 7c20 7365 6c66 2e49 535f 4558  ILS | self.IS_EX
+00035db0: 5449 4e43 5449 4f4e 0a0a 2020 2020 6465  TINCTION..    de
+00035dc0: 6620 5f5f 6361 6c6c 5f5f 2873 656c 662c  f __call__(self,
+00035dd0: 2077 6176 655f 696e 7075 7429 3a0a 2020   wave_input):.  
+00035de0: 2020 2020 2020 696d 706f 7274 2061 7374        import ast
+00035df0: 726f 7079 2e75 6e69 7473 2061 7320 750a  ropy.units as u.
+00035e00: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00035e10: 7374 616e 6365 2877 6176 655f 696e 7075  stance(wave_inpu
+00035e20: 742c 206c 6973 7429 3a0a 2020 2020 2020  t, list):.      
+00035e30: 2020 2020 2020 7761 7665 203d 206e 702e        wave = np.
+00035e40: 6172 7261 7928 7761 7665 5f69 6e70 7574  array(wave_input
+00035e50: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00035e60: 2020 2020 2020 2020 2020 2020 7761 7665              wave
+00035e70: 203d 2077 6176 655f 696e 7075 740a 0a20   = wave_input.. 
+00035e80: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00035e90: 7461 7475 7320 6973 2046 616c 7365 3a0a  tatus is False:.
+00035ea0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00035eb0: 726e 206e 702e 7a65 726f 735f 6c69 6b65  rn np.zeros_like
+00035ec0: 2877 6176 6529 0a0a 2020 2020 2020 2020  (wave)..        
+00035ed0: 6966 2073 656c 662e 4953 5f53 5045 4355  if self.IS_SPECU
+00035ee0: 5449 4c53 3a0a 2020 2020 2020 2020 2020  TILS:.          
+00035ef0: 2020 6966 2068 6173 6174 7472 2877 6176    if hasattr(wav
+00035f00: 652c 2027 756e 6974 2729 3a0a 2020 2020  e, 'unit'):.    
+00035f10: 2020 2020 2020 2020 2020 2020 7761 7665              wave
+00035f20: 5f61 6120 3d20 7761 7665 0a20 2020 2020  _aa = wave.     
+00035f30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00035f40: 2020 2020 2020 2020 2020 2020 2077 6176               wav
+00035f50: 655f 6161 203d 2077 6176 652a 752e 4141  e_aa = wave*u.AA
+00035f60: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00035f70: 7475 726e 2073 656c 662e 4639 3928 7761  turn self.F99(wa
+00035f80: 7665 5f61 6129 0a0a 2020 2020 2020 2020  ve_aa)..        
+00035f90: 6966 2073 656c 662e 4953 5f45 5854 494e  if self.IS_EXTIN
+00035fa0: 4354 494f 4e3a 0a20 2020 2020 2020 2020  CTION:.         
+00035fb0: 2020 2069 6620 6861 7361 7474 7228 7761     if hasattr(wa
+00035fc0: 7665 2c20 2775 6e69 7427 293a 0a20 2020  ve, 'unit'):.   
+00035fd0: 2020 2020 2020 2020 2020 2020 2077 6176               wav
+00035fe0: 655f 6161 203d 2077 6176 652e 746f 2875  e_aa = wave.to(u
+00035ff0: 2e41 4129 0a20 2020 2020 2020 2020 2020  .AA).           
+00036000: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00036010: 2020 2020 2020 2077 6176 655f 6161 203d         wave_aa =
+00036020: 2077 6176 650a 0a20 2020 2020 2020 2020   wave..         
+00036030: 2020 2072 6574 7572 6e20 7365 6c66 2e46     return self.F
+00036040: 3939 2877 6176 655f 6161 2c20 7365 6c66  99(wave_aa, self
+00036050: 2e61 5f76 2c20 756e 6974 3d27 6161 2729  .a_v, unit='aa')
+00036060: 0a0a 0a63 6c61 7373 2045 6666 6563 7469  ...class Effecti
+00036070: 7665 5053 463a 0a20 2020 2064 6566 205f  vePSF:.    def _
+00036080: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00036090: 2020 2020 2020 2022 2222 546f 6f6c 7320         """Tools 
+000360a0: 666f 7220 6861 6e64 6c69 6e67 2057 4643  for handling WFC
+000360b0: 332f 4952 2045 6666 6563 7469 7665 2050  3/IR Effective P
+000360c0: 5346 0a0a 2020 2020 2020 2020 5365 6520  SF..        See 
+000360d0: 646f 6375 6d65 6e74 6174 696f 6e20 6174  documentation at
+000360e0: 2068 7474 703a 2f2f 7777 772e 7374 7363   http://www.stsc
+000360f0: 692e 6564 752f 6873 742f 7766 6333 2f61  i.edu/hst/wfc3/a
+00036100: 6e61 6c79 7369 732f 5053 462e 0a0a 2020  nalysis/PSF...  
+00036110: 2020 2020 2020 5053 4620 6669 6c65 7320        PSF files 
+00036120: 7374 6f72 6564 2069 6e20 2447 5249 5a4c  stored in $GRIZL
+00036130: 492f 434f 4e46 2f0a 2020 2020 2020 2020  I/CONF/.        
+00036140: 2222 220a 0a20 2020 2020 2020 2073 656c  """..        sel
+00036150: 662e 6c6f 6164 5f50 5346 5f64 6174 6128  f.load_PSF_data(
+00036160: 290a 0a20 2020 2064 6566 206c 6f61 645f  )..    def load_
+00036170: 5053 465f 6461 7461 2873 656c 6629 3a0a  PSF_data(self):.
+00036180: 2020 2020 2020 2020 2222 224c 6f61 6420          """Load 
+00036190: 6461 7461 2066 726f 6d20 5053 4653 5444  data from PSFSTD
+000361a0: 2066 696c 6573 0a0a 2020 2020 2020 2020   files..        
+000361b0: 4669 6c65 7320 7368 6f75 6c64 2062 6520  Files should be 
+000361c0: 6c6f 6361 7465 6420 696e 2024 7b47 5249  located in ${GRI
+000361d0: 5a4c 497d 2f43 4f4e 462f 2064 6972 6563  ZLI}/CONF/ direc
+000361e0: 746f 7279 2e0a 2020 2020 2020 2020 2222  tory..        ""
+000361f0: 220a 2020 2020 2020 2020 7365 6c66 2e65  ".        self.e
+00036200: 7073 6620 3d20 4f72 6465 7265 6444 6963  psf = OrderedDic
+00036210: 7428 290a 0a20 2020 2020 2020 2066 6f72  t()..        for
+00036220: 2066 696c 7465 7220 696e 205b 2746 3130   filter in ['F10
+00036230: 3557 272c 2027 4631 3130 5727 2c20 2746  5W', 'F110W', 'F
+00036240: 3132 3557 272c 2027 4631 3430 5727 2c20  125W', 'F140W', 
+00036250: 2746 3136 3057 272c 2027 4631 3237 4d27  'F160W', 'F127M'
+00036260: 5d3a 0a20 2020 2020 2020 2020 2020 2066  ]:.            f
+00036270: 696c 6520 3d20 6f73 2e70 6174 682e 6a6f  ile = os.path.jo
+00036280: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
+00036290: 2743 4f4e 4627 2c0a 2020 2020 2020 2020  'CONF',.        
+000362a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000362b0: 2020 2020 2020 2020 2750 5346 5354 445f          'PSFSTD_
+000362c0: 5746 4333 4952 5f7b 307d 2e66 6974 7327  WFC3IR_{0}.fits'
+000362d0: 2e66 6f72 6d61 7428 6669 6c74 6572 2929  .format(filter))
+000362e0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000362f0: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
+00036300: 7374 7328 6669 6c65 293a 0a20 2020 2020  sts(file):.     
+00036310: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00036320: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00036330: 2077 6974 6820 7079 6669 7473 2e6f 7065   with pyfits.ope
+00036340: 6e28 6669 6c65 2920 6173 205f 696d 3a0a  n(file) as _im:.
+00036350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036360: 6461 7461 203d 205f 696d 5b30 5d2e 6461  data = _im[0].da
+00036370: 7461 2e54 2a31 0a20 2020 2020 2020 2020  ta.T*1.         
+00036380: 2020 2020 2020 2064 6174 615b 6461 7461         data[data
+00036390: 203c 2030 5d20 3d20 300a 0a20 2020 2020   < 0] = 0..     
+000363a0: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
+000363b0: 5b66 696c 7465 725d 203d 2064 6174 610a  [filter] = data.
+000363c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000363d0: 2023 2055 5649 530a 2020 2020 2020 2020   # UVIS.        
+000363e0: 6669 6c74 6572 5f66 696c 6573 203d 2067  filter_files = g
+000363f0: 6c6f 622e 676c 6f62 286f 732e 7061 7468  lob.glob(os.path
+00036400: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
+00036410: 482c 2027 434f 4e46 272c 0a20 2020 2020  H, 'CONF',.     
+00036420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036430: 2020 2020 2020 2027 5053 4653 5444 5f57         'PSFSTD_W
+00036440: 4643 3355 562a 2e66 6974 7327 2929 0a20  FC3UV*.fits')). 
+00036450: 2020 2020 2020 2066 696c 7465 725f 6669         filter_fi
+00036460: 6c65 732e 736f 7274 2829 0a20 2020 2020  les.sort().     
+00036470: 2020 2066 6f72 2066 696c 6520 696e 2066     for file in f
+00036480: 696c 7465 725f 6669 6c65 733a 0a20 2020  ilter_files:.   
+00036490: 2020 2020 2020 2020 2077 6974 6820 7079           with py
+000364a0: 6669 7473 2e6f 7065 6e28 6669 6c65 2c20  fits.open(file, 
+000364b0: 6967 6e6f 7265 5f6d 6973 7369 6e67 5f65  ignore_missing_e
+000364c0: 6e64 3d54 7275 6529 2061 7320 5f69 6d3a  nd=True) as _im:
+000364d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000364e0: 2064 6174 6120 3d20 5f69 6d5b 305d 2e64   data = _im[0].d
+000364f0: 6174 612e 542a 310a 2020 2020 2020 2020  ata.T*1.        
+00036500: 2020 2020 2020 2020 6461 7461 5b64 6174          data[dat
+00036510: 6120 3c20 305d 203d 2030 0a20 2020 2020  a < 0] = 0.     
+00036520: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00036530: 2020 2020 2020 2020 6669 6c74 203d 2027          filt = '
+00036540: 5f27 2e6a 6f69 6e28 6669 6c65 2e73 7472  _'.join(file.str
+00036550: 6970 2827 2e66 6974 7327 292e 7370 6c69  ip('.fits').spli
+00036560: 7428 275f 2729 5b32 3a5d 290a 2020 2020  t('_')[2:]).    
+00036570: 2020 2020 2020 2020 7365 6c66 2e65 7073          self.eps
+00036580: 665b 6669 6c74 2b27 5527 5d20 3d20 6461  f[filt+'U'] = da
+00036590: 7461 0a0a 2020 2020 2020 2020 2320 4143  ta..        # AC
+000365a0: 530a 2020 2020 2020 2020 6669 6c74 6572  S.        filter
+000365b0: 5f66 696c 6573 203d 2067 6c6f 622e 676c  _files = glob.gl
+000365c0: 6f62 286f 732e 7061 7468 2e6a 6f69 6e28  ob(os.path.join(
+000365d0: 4752 495a 4c49 5f50 4154 482c 2027 434f  GRIZLI_PATH, 'CO
+000365e0: 4e46 272c 0a20 2020 2020 2020 2020 2020  NF',.           
+000365f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036600: 2027 5053 4653 5444 5f41 4353 5746 432a   'PSFSTD_ACSWFC*
+00036610: 2e66 6974 7327 2929 0a20 2020 2020 2020  .fits')).       
+00036620: 2066 696c 7465 725f 6669 6c65 732e 736f   filter_files.so
+00036630: 7274 2829 0a20 2020 2020 2020 2066 6f72  rt().        for
+00036640: 2066 696c 6520 696e 2066 696c 7465 725f   file in filter_
+00036650: 6669 6c65 733a 0a20 2020 2020 2020 2020  files:.         
+00036660: 2020 2077 6974 6820 7079 6669 7473 2e6f     with pyfits.o
+00036670: 7065 6e28 6669 6c65 2c20 6967 6e6f 7265  pen(file, ignore
+00036680: 5f6d 6973 7369 6e67 5f65 6e64 3d54 7275  _missing_end=Tru
+00036690: 6529 2061 7320 5f69 6d3a 0a20 2020 2020  e) as _im:.     
+000366a0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+000366b0: 3d20 5f69 6d5b 305d 2e64 6174 612e 542a  = _im[0].data.T*
+000366c0: 312e 0a20 2020 2020 2020 2020 2020 2020  1..             
+000366d0: 2020 2064 6174 615b 6461 7461 203c 2030     data[data < 0
+000366e0: 5d20 3d20 300a 2020 2020 2020 2020 2020  ] = 0.          
+000366f0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00036700: 2020 2066 696c 7420 3d20 275f 272e 6a6f     filt = '_'.jo
+00036710: 696e 2866 696c 652e 7374 7269 7028 272e  in(file.strip('.
+00036720: 6669 7473 2729 2e73 706c 6974 2827 5f27  fits').split('_'
+00036730: 295b 323a 5d29 0a20 2020 2020 2020 2020  )[2:]).         
+00036740: 2020 2073 656c 662e 6570 7366 5b66 696c     self.epsf[fil
+00036750: 745d 203d 2064 6174 610a 2020 2020 2020  t] = data.      
+00036760: 2020 0a20 2020 2020 2020 2023 204a 5753    .        # JWS
+00036770: 540a 2020 2020 2020 2020 6669 6c74 6572  T.        filter
+00036780: 5f66 696c 6573 203d 2067 6c6f 622e 676c  _files = glob.gl
+00036790: 6f62 286f 732e 7061 7468 2e6a 6f69 6e28  ob(os.path.join(
+000367a0: 4752 495a 4c49 5f50 4154 482c 2027 434f  GRIZLI_PATH, 'CO
+000367b0: 4e46 2f4a 5753 5465 5053 4627 2c0a 2020  NF/JWSTePSF',.  
+000367c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000367d0: 2020 2020 2020 2020 2020 276e 6972 6361            'nirca
+000367e0: 6d2a 2e66 6974 7327 2929 0a20 2020 2020  m*.fits')).     
+000367f0: 2020 2066 696c 7465 725f 6669 6c65 7320     filter_files 
+00036800: 2b3d 2067 6c6f 622e 676c 6f62 286f 732e  += glob.glob(os.
+00036810: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
+00036820: 5f50 4154 482c 2027 434f 4e46 2f4a 5753  _PATH, 'CONF/JWS
+00036830: 5465 5053 4627 2c0a 2020 2020 2020 2020  TePSF',.        
+00036840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036850: 2020 2020 276e 6972 6973 732a 2e66 6974      'niriss*.fit
+00036860: 7327 2929 0a20 2020 2020 2020 2066 696c  s')).        fil
+00036870: 7465 725f 6669 6c65 7320 2b3d 2067 6c6f  ter_files += glo
+00036880: 622e 676c 6f62 286f 732e 7061 7468 2e6a  b.glob(os.path.j
+00036890: 6f69 6e28 4752 495a 4c49 5f50 4154 482c  oin(GRIZLI_PATH,
+000368a0: 2027 434f 4e46 2f4a 5753 5465 5053 4627   'CONF/JWSTePSF'
+000368b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000368c0: 2020 2020 2020 2020 2020 2020 2020 276d                'm
+000368d0: 6972 692a 2e66 6974 7327 2929 0a20 2020  iri*.fits')).   
+000368e0: 2020 2020 2066 696c 7465 725f 6669 6c65       filter_file
+000368f0: 732e 736f 7274 2829 0a20 2020 2020 2020  s.sort().       
+00036900: 2066 6f72 2066 696c 6520 696e 2066 696c   for file in fil
+00036910: 7465 725f 6669 6c65 733a 0a20 2020 2020  ter_files:.     
+00036920: 2020 2020 2020 2077 6974 6820 7079 6669         with pyfi
+00036930: 7473 2e6f 7065 6e28 6669 6c65 2c20 6967  ts.open(file, ig
+00036940: 6e6f 7265 5f6d 6973 7369 6e67 5f65 6e64  nore_missing_end
+00036950: 3d54 7275 6529 2061 7320 5f69 6d3a 0a20  =True) as _im:. 
+00036960: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00036970: 6174 6120 3d20 5f69 6d5b 305d 2e64 6174  ata = _im[0].dat
+00036980: 612a 3120 2320 5b3a 3a2d 312c 3a2c 3a5d  a*1 # [::-1,:,:]
+00036990: 235b 3a2c 3a3a 2d31 2c3a 5d0a 2020 2020  #[:,::-1,:].    
+000369a0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+000369b0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000369c0: 615b 6461 7461 203c 2030 5d20 3d20 300a  a[data < 0] = 0.
+000369d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000369e0: 6b65 7920 3d20 277b 307d 2d7b 317d 272e  key = '{0}-{1}'.
+000369f0: 666f 726d 6174 285f 696d 5b30 5d2e 6865  format(_im[0].he
+00036a00: 6164 6572 5b27 4445 5445 4354 4f52 275d  ader['DETECTOR']
+00036a10: 2e75 7070 6572 2829 2c0a 2020 2020 2020  .upper(),.      
+00036a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036a40: 205f 696d 5b30 5d2e 6865 6164 6572 5b27   _im[0].header['
+00036a50: 4649 4c54 4552 275d 290a 2020 2020 2020  FILTER']).      
+00036a60: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00036a70: 2020 2020 2020 2069 6620 274c 4142 454c         if 'LABEL
+00036a80: 2720 696e 205f 696d 5b30 5d2e 6865 6164  ' in _im[0].head
+00036a90: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00036aa0: 2020 2020 2020 2020 6b65 7920 2b3d 2027          key += '
+00036ab0: 2d27 202b 205f 696d 5b30 5d2e 6865 6164  -' + _im[0].head
+00036ac0: 6572 5b27 4c41 4245 4c27 5d0a 2020 2020  er['LABEL'].    
+00036ad0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00036ae0: 2020 2020 2020 2020 2073 656c 662e 6570           self.ep
+00036af0: 7366 5b6b 6579 5d20 3d20 6461 7461 0a20  sf[key] = data. 
+00036b00: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00036b10: 2320 4475 6d6d 792c 2075 7365 2046 3130  # Dummy, use F10
+00036b20: 3557 2065 5053 4620 666f 7220 4630 3938  5W ePSF for F098
+00036b30: 4d20 616e 6420 4631 3130 570a 2020 2020  M and F110W.    
+00036b40: 2020 2020 7365 6c66 2e65 7073 665b 2746      self.epsf['F
+00036b50: 3039 384d 275d 203d 2073 656c 662e 6570  098M'] = self.ep
+00036b60: 7366 5b27 4631 3035 5727 5d0a 2020 2020  sf['F105W'].    
+00036b70: 2020 2020 7365 6c66 2e65 7073 665b 2746      self.epsf['F
+00036b80: 3132 384e 275d 203d 2073 656c 662e 6570  128N'] = self.ep
+00036b90: 7366 5b27 4631 3235 5727 5d0a 2020 2020  sf['F125W'].    
+00036ba0: 2020 2020 7365 6c66 2e65 7073 665b 2746      self.epsf['F
+00036bb0: 3133 304e 275d 203d 2073 656c 662e 6570  130N'] = self.ep
+00036bc0: 7366 5b27 4631 3235 5727 5d0a 2020 2020  sf['F125W'].    
+00036bd0: 2020 2020 7365 6c66 2e65 7073 665b 2746      self.epsf['F
+00036be0: 3133 324e 275d 203d 2073 656c 662e 6570  132N'] = self.ep
+00036bf0: 7366 5b27 4631 3235 5727 5d0a 2020 2020  sf['F125W'].    
+00036c00: 2020 2020 0a20 2020 2020 2020 2023 2044      .        # D
+00036c10: 756d 6d79 2066 696c 7465 7273 2066 6f72  ummy filters for
+00036c20: 2049 5220 6772 6973 6d73 0a20 2020 2020   IR grisms.     
+00036c30: 2020 2073 656c 662e 6570 7366 5b27 4731     self.epsf['G1
+00036c40: 3431 275d 203d 2073 656c 662e 6570 7366  41'] = self.epsf
+00036c50: 5b27 4631 3430 5727 5d0a 2020 2020 2020  ['F140W'].      
+00036c60: 2020 7365 6c66 2e65 7073 665b 2747 3130    self.epsf['G10
+00036c70: 3227 5d20 3d20 7365 6c66 2e65 7073 665b  2'] = self.epsf[
+00036c80: 2746 3130 3557 275d 0a20 2020 2020 2020  'F105W'].       
+00036c90: 200a 2020 2020 2020 2020 2320 4578 7465   .        # Exte
+00036ca0: 6e64 6564 0a20 2020 2020 2020 2073 656c  nded.        sel
+00036cb0: 662e 6578 7465 6e64 6564 5f65 7073 6620  f.extended_epsf 
+00036cc0: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+00036cd0: 2066 696c 7465 7220 696e 205b 2746 3130   filter in ['F10
+00036ce0: 3557 272c 2027 4631 3235 5727 2c20 2746  5W', 'F125W', 'F
+00036cf0: 3134 3057 272c 2027 4631 3630 5727 5d3a  140W', 'F160W']:
+00036d00: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00036d10: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
+00036d20: 2847 5249 5a4c 495f 5041 5448 2c20 2743  (GRIZLI_PATH, 'C
+00036d30: 4f4e 4627 2c0a 2020 2020 2020 2020 2020  ONF',.          
+00036d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036d50: 2020 2020 2020 2765 7874 656e 6465 645f        'extended_
+00036d60: 5053 465f 7b30 7d2e 6669 7473 272e 666f  PSF_{0}.fits'.fo
+00036d70: 726d 6174 2866 696c 7465 7229 290a 0a20  rmat(filter)).. 
+00036d80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00036d90: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00036da0: 2866 696c 6529 3a0a 2020 2020 2020 2020  (file):.        
+00036db0: 2020 2020 2020 2020 2342 4153 4555 524c          #BASEURL
+00036dc0: 203d 2027 6874 7470 733a 2f2f 6572 6461   = 'https://erda
+00036dd0: 2e6b 752e 646b 2f76 6772 6964 2f47 6162  .ku.dk/vgrid/Gab
+00036de0: 7269 656c 2532 3042 7261 6d6d 6572 2f43  riel%20Brammer/C
+00036df0: 4f4e 462f 270a 2020 2020 2020 2020 2020  ONF/'.          
+00036e00: 2020 2020 2020 4241 5345 5552 4c20 3d20        BASEURL = 
+00036e10: 2827 6874 7470 733a 2f2f 7261 772e 6769  ('https://raw.gi
+00036e20: 7468 7562 7573 6572 636f 6e74 656e 742e  thubusercontent.
+00036e30: 636f 6d2f 6762 7261 6d6d 6572 2f27 202b  com/gbrammer/' +
+00036e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036e50: 2020 2020 2020 2020 2020 2020 2767 7269              'gri
+00036e60: 7a6c 692d 636f 6e66 6967 2f6d 6173 7465  zli-config/maste
+00036e70: 7227 290a 0a20 2020 2020 2020 2020 2020  r')..           
+00036e80: 2020 2020 206d 7367 203d 2027 4578 7465       msg = 'Exte
+00036e90: 6e64 6564 2050 5346 2066 696c 6520 5c27  nded PSF file \'
+00036ea0: 7b30 7d5c 2720 6e6f 7420 666f 756e 642e  {0}\' not found.
+00036eb0: 272e 666f 726d 6174 2866 696c 6529 0a20  '.format(file). 
+00036ec0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00036ed0: 7367 202b 3d20 2747 6574 2074 6865 2061  sg += 'Get the a
+00036ee0: 7263 6869 7665 2066 726f 6d20 270a 2020  rchive from '.  
+00036ef0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00036f00: 6720 2b3d 2066 2720 7b42 4153 4555 524c  g += f' {BASEURL
+00036f10: 7d2f 5746 4333 4952 5f65 7874 656e 6465  }/WFC3IR_extende
+00036f20: 645f 5053 462e 7631 2e74 6172 2e67 7a27  d_PSF.v1.tar.gz'
+00036f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036f40: 206d 7367 202b 3d20 2720 616e 6420 756e   msg += ' and un
+00036f50: 7061 636b 2069 6e20 247b 4752 495a 4c49  pack in ${GRIZLI
+00036f60: 7d2f 434f 4e46 2f27 0a20 2020 2020 2020  }/CONF/'.       
+00036f70: 2020 2020 2020 2020 2072 6169 7365 2046           raise F
+00036f80: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+00036f90: 286d 7367 290a 0a20 2020 2020 2020 2020  (msg)..         
+00036fa0: 2020 2077 6974 6820 7079 6669 7473 2e6f     with pyfits.o
+00036fb0: 7065 6e28 6669 6c65 2920 6173 205f 696d  pen(file) as _im
+00036fc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00036fd0: 2020 6461 7461 203d 205f 696d 5b30 5d2e    data = _im[0].
+00036fe0: 6461 7461 2a31 0a20 2020 2020 2020 2020  data*1.         
+00036ff0: 2020 2020 2020 2064 6174 615b 6461 7461         data[data
+00037000: 203c 2030 5d20 3d20 300a 0a20 2020 2020   < 0] = 0..     
+00037010: 2020 2020 2020 2023 204d 6173 6b20 6365         # Mask ce
+00037020: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+00037030: 204e 5820 3d20 6461 7461 2e73 6861 7065   NX = data.shape
+00037040: 5b30 5d2f 322d 310a 2020 2020 2020 2020  [0]/2-1.        
+00037050: 2020 2020 7970 2c20 7870 203d 206e 702e      yp, xp = np.
+00037060: 696e 6469 6365 7328 6461 7461 2e73 6861  indices(data.sha
+00037070: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+00037080: 5220 3d20 6e70 2e73 7172 7428 2878 702d  R = np.sqrt((xp-
+00037090: 4e58 292a 2a32 2b28 7970 2d4e 5829 2a2a  NX)**2+(yp-NX)**
+000370a0: 3229 0a20 2020 2020 2020 2020 2020 2064  2).            d
+000370b0: 6174 615b 5220 3c3d 2034 5d20 3d20 302e  ata[R <= 4] = 0.
+000370c0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000370d0: 6c66 2e65 7874 656e 6465 645f 6570 7366  lf.extended_epsf
+000370e0: 5b66 696c 7465 725d 203d 2064 6174 610a  [filter] = data.
+000370f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00037100: 2e65 7874 656e 6465 645f 4e20 3d20 696e  .extended_N = in
+00037110: 7428 4e58 290a 0a20 2020 2020 2020 2073  t(NX)..        s
+00037120: 656c 662e 6578 7465 6e64 6564 5f65 7073  elf.extended_eps
+00037130: 665b 2746 3039 384d 275d 203d 2073 656c  f['F098M'] = sel
+00037140: 662e 6578 7465 6e64 6564 5f65 7073 665b  f.extended_epsf[
+00037150: 2746 3130 3557 275d 0a20 2020 2020 2020  'F105W'].       
+00037160: 2073 656c 662e 6578 7465 6e64 6564 5f65   self.extended_e
+00037170: 7073 665b 2746 3131 3057 275d 203d 2073  psf['F110W'] = s
+00037180: 656c 662e 6578 7465 6e64 6564 5f65 7073  elf.extended_eps
+00037190: 665b 2746 3130 3557 275d 0a20 2020 2020  f['F105W'].     
+000371a0: 2020 2073 656c 662e 6578 7465 6e64 6564     self.extended
+000371b0: 5f65 7073 665b 2746 3132 384e 275d 203d  _epsf['F128N'] =
+000371c0: 2073 656c 662e 6578 7465 6e64 6564 5f65   self.extended_e
+000371d0: 7073 665b 2746 3132 3557 275d 0a20 2020  psf['F125W'].   
+000371e0: 2020 2020 2073 656c 662e 6578 7465 6e64       self.extend
+000371f0: 6564 5f65 7073 665b 2746 3133 304e 275d  ed_epsf['F130N']
+00037200: 203d 2073 656c 662e 6578 7465 6e64 6564   = self.extended
+00037210: 5f65 7073 665b 2746 3132 3557 275d 0a20  _epsf['F125W']. 
+00037220: 2020 2020 2020 2073 656c 662e 6578 7465         self.exte
+00037230: 6e64 6564 5f65 7073 665b 2746 3133 324e  nded_epsf['F132N
+00037240: 275d 203d 2073 656c 662e 6578 7465 6e64  '] = self.extend
+00037250: 6564 5f65 7073 665b 2746 3132 3557 275d  ed_epsf['F125W']
+00037260: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+00037270: 7465 6e64 6564 5f65 7073 665b 2747 3130  tended_epsf['G10
+00037280: 3227 5d20 3d20 7365 6c66 2e65 7874 656e  2'] = self.exten
+00037290: 6465 645f 6570 7366 5b27 4631 3035 5727  ded_epsf['F105W'
+000372a0: 5d0a 2020 2020 2020 2020 7365 6c66 2e65  ].        self.e
+000372b0: 7874 656e 6465 645f 6570 7366 5b27 4731  xtended_epsf['G1
+000372c0: 3431 275d 203d 2073 656c 662e 6578 7465  41'] = self.exte
+000372d0: 6e64 6564 5f65 7073 665b 2746 3134 3057  nded_epsf['F140W
+000372e0: 275d 0a0a 0a20 2020 2064 6566 2067 6574  ']...    def get
+000372f0: 5f61 745f 706f 7369 7469 6f6e 2873 656c  _at_position(sel
+00037300: 662c 2078 3d35 3037 2c20 793d 3530 372c  f, x=507, y=507,
+00037310: 2066 696c 7465 723d 2746 3134 3057 272c   filter='F140W',
+00037320: 2072 6f74 3930 3d30 293a 0a20 2020 2020   rot90=0):.     
+00037330: 2020 2022 2222 4576 616c 7561 7465 2065     """Evaluate e
+00037340: 5053 4620 6174 2064 6574 6563 746f 7220  PSF at detector 
+00037350: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
+00037360: 2020 2020 5442 440a 2020 2020 2020 2020      TBD.        
+00037370: 2222 220a 2020 2020 2020 2020 6570 7366  """.        epsf
+00037380: 203d 2073 656c 662e 6570 7366 5b66 696c   = self.epsf[fil
+00037390: 7465 725d 0a20 2020 2020 2020 200a 2020  ter].        .  
+000373a0: 2020 2020 2020 7073 665f 7479 7065 203d        psf_type =
+000373b0: 2027 4853 542f 4f70 7469 6361 6c27 0a20   'HST/Optical'. 
+000373c0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+000373d0: 6966 2066 696c 7465 7220 696e 205b 2746  if filter in ['F
+000373e0: 3039 384d 272c 2027 4631 3130 5727 2c20  098M', 'F110W', 
+000373f0: 2746 3130 3557 272c 2027 4631 3235 5727  'F105W', 'F125W'
+00037400: 2c20 2746 3134 3057 272c 2027 4631 3630  , 'F140W', 'F160
+00037410: 5727 2c0a 2020 2020 2020 2020 2020 2020  W',.            
+00037420: 2020 2020 2020 2020 2020 2747 3130 3227            'G102'
+00037430: 2c27 4731 3431 272c 2746 3132 384e 272c  ,'G141','F128N',
+00037440: 2746 3133 304e 272c 2746 3133 324e 275d  'F130N','F132N']
+00037450: 3a0a 2020 2020 2020 2020 2020 2020 7073  :.            ps
+00037460: 665f 7479 7065 203d 2027 5746 4333 2f49  f_type = 'WFC3/I
+00037470: 5227 0a20 2020 2020 2020 2020 2020 200a  R'.            .
+00037480: 2020 2020 2020 2020 656c 6966 2066 696c          elif fil
+00037490: 7465 722e 7374 6172 7473 7769 7468 2827  ter.startswith('
+000374a0: 4e52 4327 2920 7c20 6669 6c74 6572 2e73  NRC') | filter.s
+000374b0: 7461 7274 7377 6974 6828 274e 4953 2729  tartswith('NIS')
+000374c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000374d0: 4e49 5249 5353 2c20 4e49 5243 616d 2032  NIRISS, NIRCam 2
+000374e0: 4b0a 2020 2020 2020 2020 2020 2020 7073  K.            ps
+000374f0: 665f 7479 7065 203d 2027 4a57 5354 2f32  f_type = 'JWST/2
+00037500: 4b27 0a20 2020 2020 2020 2020 2020 200a  K'.            .
+00037510: 2020 2020 2020 2020 656c 6966 2066 696c          elif fil
+00037520: 7465 722e 7374 6172 7473 7769 7468 2827  ter.startswith('
+00037530: 4d49 5249 2729 3a0a 2020 2020 2020 2020  MIRI'):.        
+00037540: 2020 2020 7073 665f 7479 7065 203d 2027      psf_type = '
+00037550: 4a57 5354 2f4d 4952 4927 0a20 2020 2020  JWST/MIRI'.     
+00037560: 2020 200a 2020 2020 2020 2020 7365 6c66     .        self
+00037570: 2e65 7661 6c5f 7073 665f 7479 7065 203d  .eval_psf_type =
+00037580: 2070 7366 5f74 7970 650a 2020 2020 2020   psf_type.      
+00037590: 2020 0a20 2020 2020 2020 2069 6620 7073    .        if ps
+000375a0: 665f 7479 7065 203d 3d20 2757 4643 332f  f_type == 'WFC3/
+000375b0: 4952 273a 0a20 2020 2020 2020 2020 2020  IR':.           
+000375c0: 2023 2020 4952 2064 6574 6563 746f 720a   #  IR detector.
+000375d0: 2020 2020 2020 2020 2020 2020 7278 203d              rx =
+000375e0: 2031 2b28 6e70 2e63 6c69 7028 782c 2031   1+(np.clip(x, 1
+000375f0: 2c20 3130 3133 292d 3029 2f35 3037 2e0a  , 1013)-0)/507..
+00037600: 2020 2020 2020 2020 2020 2020 7279 203d              ry =
+00037610: 2031 2b28 6e70 2e63 6c69 7028 792c 2031   1+(np.clip(y, 1
+00037620: 2c20 3130 3133 292d 3029 2f35 3037 2e0a  , 1013)-0)/507..
+00037630: 0a20 2020 2020 2020 2020 2020 2023 207a  .            # z
+00037640: 6572 6f20 696e 6465 780a 2020 2020 2020  ero index.      
+00037650: 2020 2020 2020 7278 202d 3d20 310a 2020        rx -= 1.  
+00037660: 2020 2020 2020 2020 2020 7279 202d 3d20            ry -= 
+00037670: 310a 0a20 2020 2020 2020 2020 2020 206e  1..            n
+00037680: 7820 3d20 6e70 2e63 6c69 7028 696e 7428  x = np.clip(int(
+00037690: 7278 292c 2030 2c20 3229 0a20 2020 2020  rx), 0, 2).     
+000376a0: 2020 2020 2020 206e 7920 3d20 6e70 2e63         ny = np.c
+000376b0: 6c69 7028 696e 7428 7279 292c 2030 2c20  lip(int(ry), 0, 
+000376c0: 3229 0a0a 2020 2020 2020 2020 2020 2020  2)..            
+000376d0: 2320 7072 696e 7420 782c 2079 2c20 7278  # print x, y, rx
+000376e0: 2c20 7279 2c20 6e78 2c20 6e79 0a0a 2020  , ry, nx, ny..  
+000376f0: 2020 2020 2020 2020 2020 6678 203d 2072            fx = r
+00037700: 782d 6e78 0a20 2020 2020 2020 2020 2020  x-nx.           
+00037710: 2066 7920 3d20 7279 2d6e 790a 0a20 2020   fy = ry-ny..   
+00037720: 2020 2020 2020 2020 2070 7366 5f78 7920           psf_xy 
+00037730: 3d20 2831 2d66 7829 2a28 312d 6679 292a  = (1-fx)*(1-fy)*
+00037740: 6570 7366 5b3a 2c20 3a2c 206e 782b 6e79  epsf[:, :, nx+ny
+00037750: 2a33 5d0a 2020 2020 2020 2020 2020 2020  *3].            
+00037760: 7073 665f 7879 202b 3d20 6678 2a28 312d  psf_xy += fx*(1-
+00037770: 6679 292a 6570 7366 5b3a 2c20 3a2c 2028  fy)*epsf[:, :, (
+00037780: 6e78 2b31 292b 6e79 2a33 5d0a 2020 2020  nx+1)+ny*3].    
+00037790: 2020 2020 2020 2020 7073 665f 7879 202b          psf_xy +
+000377a0: 3d20 2831 2d66 7829 2a66 792a 6570 7366  = (1-fx)*fy*epsf
+000377b0: 5b3a 2c20 3a2c 206e 782b 286e 792b 3129  [:, :, nx+(ny+1)
+000377c0: 2a33 5d0a 2020 2020 2020 2020 2020 2020  *3].            
+000377d0: 7073 665f 7879 202b 3d20 6678 2a66 792a  psf_xy += fx*fy*
+000377e0: 6570 7366 5b3a 2c20 3a2c 2028 6e78 2b31  epsf[:, :, (nx+1
+000377f0: 292b 286e 792b 3129 2a33 5d0a 2020 2020  )+(ny+1)*3].    
+00037800: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00037810: 2020 2020 2073 656c 662e 6576 616c 5f66       self.eval_f
+00037820: 696c 7465 7220 3d20 6669 6c74 6572 0a20  ilter = filter. 
+00037830: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00037840: 6966 2070 7366 5f74 7970 6520 3d3d 2027  if psf_type == '
+00037850: 4a57 5354 2f4d 4952 4927 3a0a 2020 2020  JWST/MIRI':.    
+00037860: 2020 2020 2020 2020 2320 2049 5220 6465          #  IR de
+00037870: 7465 6374 6f72 0a20 2020 2020 2020 2020  tector.         
+00037880: 2020 204e 4445 5420 3d20 696e 7428 6e70     NDET = int(np
+00037890: 2e73 7172 7428 6570 7366 2e73 6861 7065  .sqrt(epsf.shape
+000378a0: 5b32 5d29 290a 2020 2020 2020 2020 2020  [2])).          
+000378b0: 2020 0a20 2020 2020 2020 2020 2020 2072    .            r
+000378c0: 7820 3d20 312b 286e 702e 636c 6970 2878  x = 1+(np.clip(x
+000378d0: 2c20 312c 2031 3032 3329 2d30 292f 3531  , 1, 1023)-0)/51
+000378e0: 322e 0a20 2020 2020 2020 2020 2020 2072  2..            r
+000378f0: 7920 3d20 312b 286e 702e 636c 6970 2879  y = 1+(np.clip(y
+00037900: 2c20 312c 2031 3032 3329 2d30 292f 3531  , 1, 1023)-0)/51
+00037910: 322e 0a0a 2020 2020 2020 2020 2020 2020  2...            
+00037920: 2320 7a65 726f 2069 6e64 6578 0a20 2020  # zero index.   
+00037930: 2020 2020 2020 2020 2072 7820 2d3d 2031           rx -= 1
+00037940: 0a20 2020 2020 2020 2020 2020 2072 7920  .            ry 
+00037950: 2d3d 2031 0a0a 2020 2020 2020 2020 2020  -= 1..          
+00037960: 2020 2320 6e78 203d 206e 702e 636c 6970    # nx = np.clip
+00037970: 2869 6e74 2872 7829 2c20 302c 2032 290a  (int(rx), 0, 2).
+00037980: 2020 2020 2020 2020 2020 2020 2320 6e79              # ny
+00037990: 203d 206e 702e 636c 6970 2869 6e74 2872   = np.clip(int(r
+000379a0: 7929 2c20 302c 2032 290a 2020 2020 2020  y), 0, 2).      
+000379b0: 2020 2020 2020 6e78 203d 206e 702e 636c        nx = np.cl
+000379c0: 6970 2869 6e74 2872 7829 2c20 302c 204e  ip(int(rx), 0, N
+000379d0: 4445 542d 3129 0a20 2020 2020 2020 2020  DET-1).         
+000379e0: 2020 206e 7920 3d20 6e70 2e63 6c69 7028     ny = np.clip(
+000379f0: 696e 7428 7279 292c 2030 2c20 4e44 4554  int(ry), 0, NDET
+00037a00: 2d31 290a 2020 2020 2020 2020 2020 2020  -1).            
+00037a10: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
+00037a20: 7269 6e74 2078 2c20 792c 2072 782c 2072  rint x, y, rx, r
+00037a30: 792c 206e 782c 206e 790a 0a20 2020 2020  y, nx, ny..     
+00037a40: 2020 2020 2020 2066 7820 3d20 7278 2d6e         fx = rx-n
+00037a50: 780a 2020 2020 2020 2020 2020 2020 6679  x.            fy
+00037a60: 203d 2072 792d 6e79 0a0a 2020 2020 2020   = ry-ny..      
+00037a70: 2020 2020 2020 2320 7073 665f 7879 203d        # psf_xy =
+00037a80: 2028 312d 6678 292a 2831 2d66 7929 2a65   (1-fx)*(1-fy)*e
+00037a90: 7073 665b 3a2c 203a 2c20 6e78 2b6e 792a  psf[:, :, nx+ny*
+00037aa0: 335d 0a20 2020 2020 2020 2020 2020 2023  3].            #
+00037ab0: 2070 7366 5f78 7920 2b3d 2066 782a 2831   psf_xy += fx*(1
+00037ac0: 2d66 7929 2a65 7073 665b 3a2c 203a 2c20  -fy)*epsf[:, :, 
+00037ad0: 286e 782b 3129 2b6e 792a 335d 0a20 2020  (nx+1)+ny*3].   
+00037ae0: 2020 2020 2020 2020 2023 2070 7366 5f78           # psf_x
+00037af0: 7920 2b3d 2028 312d 6678 292a 6679 2a65  y += (1-fx)*fy*e
+00037b00: 7073 665b 3a2c 203a 2c20 6e78 2b28 6e79  psf[:, :, nx+(ny
+00037b10: 2b31 292a 335d 0a20 2020 2020 2020 2020  +1)*3].         
+00037b20: 2020 2023 2070 7366 5f78 7920 2b3d 2066     # psf_xy += f
+00037b30: 782a 6679 2a65 7073 665b 3a2c 203a 2c20  x*fy*epsf[:, :, 
+00037b40: 286e 782b 3129 2b28 6e79 2b31 292a 335d  (nx+1)+(ny+1)*3]
+00037b50: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00037b60: 204e 4445 5420 3d3d 2031 3a0a 2020 2020   NDET == 1:.    
+00037b70: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+00037b80: 7879 203d 2065 7073 665b 3a2c 3a2c 305d  xy = epsf[:,:,0]
+00037b90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00037ba0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00037bb0: 2020 2070 7366 5f78 7920 3d20 2831 2d66     psf_xy = (1-f
+00037bc0: 7829 2a28 312d 6679 292a 6570 7366 5b3a  x)*(1-fy)*epsf[:
+00037bd0: 2c20 3a2c 206e 782b 6e79 2a4e 4445 545d  , :, nx+ny*NDET]
+00037be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037bf0: 2070 7366 5f78 7920 2b3d 2066 782a 2831   psf_xy += fx*(1
+00037c00: 2d66 7929 2a65 7073 665b 3a2c 203a 2c20  -fy)*epsf[:, :, 
+00037c10: 286e 782b 3129 2b6e 792a 4e44 4554 5d0a  (nx+1)+ny*NDET].
+00037c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037c30: 7073 665f 7879 202b 3d20 2831 2d66 7829  psf_xy += (1-fx)
+00037c40: 2a66 792a 6570 7366 5b3a 2c20 3a2c 206e  *fy*epsf[:, :, n
+00037c50: 782b 286e 792b 3129 2a4e 4445 545d 0a20  x+(ny+1)*NDET]. 
+00037c60: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00037c70: 7366 5f78 7920 2b3d 2066 782a 6679 2a65  sf_xy += fx*fy*e
+00037c80: 7073 665b 3a2c 203a 2c20 286e 782b 3129  psf[:, :, (nx+1)
+00037c90: 2b28 6e79 2b31 292a 4e44 4554 5d0a 2020  +(ny+1)*NDET].  
+00037ca0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00037cb0: 2020 2020 2020 2023 2070 7366 5f78 7920         # psf_xy 
+00037cc0: 3d20 6e70 2e72 6f74 3930 2870 7366 5f78  = np.rot90(psf_x
+00037cd0: 792e 542c 2032 290a 2020 2020 2020 2020  y.T, 2).        
+00037ce0: 2020 2020 7073 665f 7879 203d 2070 7366      psf_xy = psf
+00037cf0: 5f78 792e 540a 2020 2020 2020 2020 2020  _xy.T.          
+00037d00: 2020 0a20 2020 2020 2020 2020 2020 2073    .            s
+00037d10: 656c 662e 6576 616c 5f66 696c 7465 7220  elf.eval_filter 
+00037d20: 3d20 6669 6c74 6572 0a20 2020 2020 2020  = filter.       
+00037d30: 200a 2020 2020 2020 2020 6966 2070 7366   .        if psf
+00037d40: 5f74 7970 6520 3d3d 2027 4a57 5354 2f32  _type == 'JWST/2
+00037d50: 4b27 3a0a 2020 2020 2020 2020 2020 2020  K':.            
+00037d60: 0a20 2020 2020 2020 2020 2020 204e 4445  .            NDE
+00037d70: 5420 3d20 696e 7428 6e70 2e73 7172 7428  T = int(np.sqrt(
+00037d80: 6570 7366 2e73 6861 7065 5b32 5d29 290a  epsf.shape[2])).
+00037d90: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00037da0: 2020 2020 2020 2020 2023 2020 4952 2064           #  IR d
+00037db0: 6574 6563 746f 720a 2020 2020 2020 2020  etector.        
+00037dc0: 2020 2020 7278 203d 2031 2b28 6e70 2e63      rx = 1+(np.c
+00037dd0: 6c69 7028 782c 2031 2c20 3230 3437 292d  lip(x, 1, 2047)-
+00037de0: 3029 2f31 3032 342e 0a20 2020 2020 2020  0)/1024..       
+00037df0: 2020 2020 2072 7920 3d20 312b 286e 702e       ry = 1+(np.
+00037e00: 636c 6970 2879 2c20 312c 2032 3034 3729  clip(y, 1, 2047)
+00037e10: 2d30 292f 3130 3234 2e0a 0a20 2020 2020  -0)/1024...     
+00037e20: 2020 2020 2020 2023 207a 6572 6f20 696e         # zero in
+00037e30: 6465 780a 2020 2020 2020 2020 2020 2020  dex.            
+00037e40: 7278 202d 3d20 310a 2020 2020 2020 2020  rx -= 1.        
+00037e50: 2020 2020 7279 202d 3d20 310a 0a20 2020      ry -= 1..   
+00037e60: 2020 2020 2020 2020 206e 7820 3d20 6e70           nx = np
+00037e70: 2e63 6c69 7028 696e 7428 7278 292c 2030  .clip(int(rx), 0
+00037e80: 2c20 4e44 4554 2d31 290a 2020 2020 2020  , NDET-1).      
+00037e90: 2020 2020 2020 6e79 203d 206e 702e 636c        ny = np.cl
+00037ea0: 6970 2869 6e74 2872 7929 2c20 302c 204e  ip(int(ry), 0, N
+00037eb0: 4445 542d 3129 0a0a 2020 2020 2020 2020  DET-1)..        
+00037ec0: 2020 2020 2320 7072 696e 7420 782c 2079      # print x, y
+00037ed0: 2c20 7278 2c20 7279 2c20 6e78 2c20 6e79  , rx, ry, nx, ny
+00037ee0: 0a0a 2020 2020 2020 2020 2020 2020 6678  ..            fx
+00037ef0: 203d 2072 782d 6e78 0a20 2020 2020 2020   = rx-nx.       
+00037f00: 2020 2020 2066 7920 3d20 7279 2d6e 790a       fy = ry-ny.
+00037f10: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00037f20: 2020 2020 2020 2020 2069 6620 4e44 4554           if NDET
+00037f30: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+00037f40: 2020 2020 2020 2070 7366 5f78 7920 3d20         psf_xy = 
+00037f50: 6570 7366 5b3a 2c3a 2c30 5d0a 2020 2020  epsf[:,:,0].    
+00037f60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00037f70: 2020 2020 2020 2020 2020 2020 2020 7073                ps
+00037f80: 665f 7879 203d 2028 312d 6678 292a 2831  f_xy = (1-fx)*(1
+00037f90: 2d66 7929 2a65 7073 665b 3a2c 203a 2c20  -fy)*epsf[:, :, 
+00037fa0: 6e78 2b6e 792a 4e44 4554 5d0a 2020 2020  nx+ny*NDET].    
+00037fb0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+00037fc0: 7879 202b 3d20 6678 2a28 312d 6679 292a  xy += fx*(1-fy)*
+00037fd0: 6570 7366 5b3a 2c20 3a2c 2028 6e78 2b31  epsf[:, :, (nx+1
+00037fe0: 292b 6e79 2a4e 4445 545d 0a20 2020 2020  )+ny*NDET].     
+00037ff0: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
+00038000: 7920 2b3d 2028 312d 6678 292a 6679 2a65  y += (1-fx)*fy*e
+00038010: 7073 665b 3a2c 203a 2c20 6e78 2b28 6e79  psf[:, :, nx+(ny
+00038020: 2b31 292a 4e44 4554 5d0a 2020 2020 2020  +1)*NDET].      
+00038030: 2020 2020 2020 2020 2020 7073 665f 7879            psf_xy
+00038040: 202b 3d20 6678 2a66 792a 6570 7366 5b3a   += fx*fy*epsf[:
+00038050: 2c20 3a2c 2028 6e78 2b31 292b 286e 792b  , :, (nx+1)+(ny+
+00038060: 3129 2a4e 4445 545d 0a20 2020 2020 2020  1)*NDET].       
+00038070: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00038080: 2020 7073 665f 7879 203d 2070 7366 5f78    psf_xy = psf_x
+00038090: 792e 540a 2020 2020 2020 2020 2020 2020  y.T.            
+000380a0: 2320 7073 665f 7879 203d 206e 702e 726f  # psf_xy = np.ro
+000380b0: 7439 3028 7073 665f 7879 2e54 2c20 3229  t90(psf_xy.T, 2)
+000380c0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+000380d0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+000380e0: 7661 6c5f 6669 6c74 6572 203d 2066 696c  val_filter = fil
+000380f0: 7465 720a 2020 2020 2020 2020 0a20 2020  ter.        .   
+00038100: 2020 2020 2065 6c69 6620 7073 665f 7479       elif psf_ty
+00038110: 7065 203d 3d20 2748 5354 2f4f 7074 6963  pe == 'HST/Optic
+00038120: 616c 273a 0a0a 2020 2020 2020 2020 2020  al':..          
+00038130: 2020 7368 203d 2065 7073 662e 7368 6170    sh = epsf.shap
+00038140: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
+00038150: 6620 7368 5b32 5d20 3d3d 2039 303a 0a20  f sh[2] == 90:. 
+00038160: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00038170: 2041 4353 2057 4643 0a20 2020 2020 2020   ACS WFC.       
+00038180: 2020 2020 2020 2020 2069 582c 2069 5920           iX, iY 
+00038190: 3d20 392c 2031 3020 2023 2039 2c20 3130  = 9, 10  # 9, 10
+000381a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000381b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000381c0: 2020 2023 2055 5649 530a 2020 2020 2020     # UVIS.      
+000381d0: 2020 2020 2020 2020 2020 6958 2c20 6959            iX, iY
+000381e0: 203d 2037 2c20 380a 0a20 2020 2020 2020   = 7, 8..       
+000381f0: 2020 2020 2072 7820 3d20 312b 286e 702e       rx = 1+(np.
+00038200: 636c 6970 2878 2c20 312c 2034 3039 3529  clip(x, 1, 4095)
+00038210: 2d30 292f 2834 3039 362f 2869 582d 3129  -0)/(4096/(iX-1)
+00038220: 290a 2020 2020 2020 2020 2020 2020 7279  ).            ry
+00038230: 203d 2031 2b28 6e70 2e63 6c69 7028 792c   = 1+(np.clip(y,
+00038240: 2031 2c20 3430 3935 292d 3029 2f28 3430   1, 4095)-0)/(40
+00038250: 3936 2f28 6959 2d31 2929 0a0a 2020 2020  96/(iY-1))..    
+00038260: 2020 2020 2020 2020 2320 7a65 726f 2069          # zero i
+00038270: 6e64 6578 0a20 2020 2020 2020 2020 2020  ndex.           
+00038280: 2072 7820 2d3d 2031 0a20 2020 2020 2020   rx -= 1.       
+00038290: 2020 2020 2072 7920 2d3d 2031 0a0a 2020       ry -= 1..  
+000382a0: 2020 2020 2020 2020 2020 6e78 203d 206e            nx = n
+000382b0: 702e 636c 6970 286e 702e 6361 7374 5b69  p.clip(np.cast[i
+000382c0: 6e74 5d28 7278 292c 2030 2c20 6958 2d31  nt](rx), 0, iX-1
+000382d0: 290a 2020 2020 2020 2020 2020 2020 6e79  ).            ny
+000382e0: 203d 206e 702e 636c 6970 286e 702e 6361   = np.clip(np.ca
+000382f0: 7374 5b69 6e74 5d28 7279 292c 2030 2c20  st[int](ry), 0, 
+00038300: 6959 2d31 290a 0a20 2020 2020 2020 2020  iY-1)..         
+00038310: 2020 2023 2070 7269 6e74 2078 2c20 792c     # print x, y,
+00038320: 2072 782c 2072 792c 206e 782c 206e 790a   rx, ry, nx, ny.
+00038330: 0a20 2020 2020 2020 2020 2020 2066 7820  .            fx 
+00038340: 3d20 7278 2d6e 780a 2020 2020 2020 2020  = rx-nx.        
+00038350: 2020 2020 6679 203d 2072 792d 6e79 0a0a      fy = ry-ny..
+00038360: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+00038370: 7879 203d 2028 312d 6678 292a 2831 2d66  xy = (1-fx)*(1-f
+00038380: 7929 2a65 7073 665b 3a2c 203a 2c20 6e78  y)*epsf[:, :, nx
+00038390: 2b6e 792a 6958 5d0a 2020 2020 2020 2020  +ny*iX].        
+000383a0: 2020 2020 7073 665f 7879 202b 3d20 6678      psf_xy += fx
+000383b0: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
+000383c0: 3a2c 2028 6e78 2b31 292b 6e79 2a69 585d  :, (nx+1)+ny*iX]
+000383d0: 0a20 2020 2020 2020 2020 2020 2070 7366  .            psf
+000383e0: 5f78 7920 2b3d 2028 312d 6678 292a 6679  _xy += (1-fx)*fy
+000383f0: 2a65 7073 665b 3a2c 203a 2c20 6e78 2b28  *epsf[:, :, nx+(
+00038400: 6e79 2b31 292a 6958 5d0a 2020 2020 2020  ny+1)*iX].      
+00038410: 2020 2020 2020 7073 665f 7879 202b 3d20        psf_xy += 
+00038420: 6678 2a66 792a 6570 7366 5b3a 2c20 3a2c  fx*fy*epsf[:, :,
+00038430: 2028 6e78 2b31 292b 286e 792b 3129 2a69   (nx+1)+(ny+1)*i
+00038440: 585d 0a0a 2020 2020 2020 2020 2020 2020  X]..            
+00038450: 7365 6c66 2e65 7661 6c5f 6669 6c74 6572  self.eval_filter
+00038460: 203d 2066 696c 7465 720a 2020 2020 2020   = filter.      
+00038470: 2020 0a20 2020 2020 2020 2069 6620 726f    .        if ro
+00038480: 7439 3020 213d 2030 3a0a 2020 2020 2020  t90 != 0:.      
+00038490: 2020 2020 2020 7365 6c66 2e70 7366 5f78        self.psf_x
+000384a0: 795f 726f 7439 3020 3d20 726f 7439 300a  y_rot90 = rot90.
+000384b0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+000384c0: 7879 203d 206e 702e 726f 7439 3028 7073  xy = np.rot90(ps
+000384d0: 665f 7879 2c20 726f 7439 3029 0a20 2020  f_xy, rot90).   
+000384e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+000384f0: 2020 7265 7475 726e 2070 7366 5f78 790a    return psf_xy.
+00038500: 0a20 2020 2064 6566 2065 7661 6c5f 6550  .    def eval_eP
+00038510: 5346 2873 656c 662c 2070 7366 5f78 792c  SF(self, psf_xy,
+00038520: 2064 782c 2064 792c 2072 6f74 3930 3d30   dx, dy, rot90=0
+00038530: 2c20 6578 7465 6e64 6564 5f64 6174 613d  , extended_data=
+00038540: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
+00038550: 2222 4576 616c 7561 7465 2050 5346 2061  ""Evaluate PSF a
+00038560: 7420 6478 2c64 7920 636f 6f72 6469 6e61  t dx,dy coordina
+00038570: 7465 730a 0a20 2020 2020 2020 2054 4244  tes..        TBD
+00038580: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00038590: 2020 2020 2023 2053 6f20 6d75 6368 2066       # So much f
+000385a0: 6173 7465 7220 7468 616e 2073 6369 7079  aster than scipy
+000385b0: 2e69 6e74 6572 706f 6c61 7465 2e67 7269  .interpolate.gri
+000385c0: 6464 6174 6121 0a20 2020 2020 2020 2066  ddata!.        f
+000385d0: 726f 6d20 7363 6970 792e 6e64 696d 6167  rom scipy.ndimag
+000385e0: 6520 696d 706f 7274 206d 6170 5f63 6f6f  e import map_coo
+000385f0: 7264 696e 6174 6573 0a0a 2020 2020 2020  rdinates..      
+00038600: 2020 2320 6550 5346 206f 6e6c 7920 6465    # ePSF only de
+00038610: 6669 6e65 6420 746f 2031 322e 3520 7069  fined to 12.5 pi
+00038620: 7865 6c73 0a20 2020 2020 2020 2069 6620  xels.        if 
+00038630: 7365 6c66 2e65 7661 6c5f 7073 665f 7479  self.eval_psf_ty
+00038640: 7065 2069 6e20 5b27 5746 4333 2f49 5227  pe in ['WFC3/IR'
+00038650: 2c27 4853 542f 4f70 7469 6361 6c27 5d3a  ,'HST/Optical']:
+00038660: 0a20 2020 2020 2020 2020 2020 206f 6b20  .            ok 
+00038670: 3d20 286e 702e 6162 7328 6478 2920 3c3d  = (np.abs(dx) <=
+00038680: 2031 322e 3529 2026 2028 6e70 2e61 6273   12.5) & (np.abs
+00038690: 2864 7929 203c 3d20 3132 2e35 290a 2020  (dy) <= 12.5).  
+000386a0: 2020 2020 2020 2020 2020 636f 6f72 6473            coords
+000386b0: 203d 206e 702e 6172 7261 7928 5b35 302b   = np.array([50+
+000386c0: 342a 6478 5b6f 6b5d 2c20 3530 2b34 2a64  4*dx[ok], 50+4*d
+000386d0: 795b 6f6b 5d5d 290a 2020 2020 2020 2020  y[ok]]).        
+000386e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000386f0: 2020 2320 4a57 5354 2061 7265 202b 2f2d    # JWST are +/-
+00038700: 2033 3220 7069 7865 6c73 0a20 2020 2020   32 pixels.     
+00038710: 2020 2020 2020 2073 6820 3d20 7073 665f         sh = psf_
+00038720: 7879 2e73 6861 7065 0a20 2020 2020 2020  xy.shape.       
+00038730: 2020 2020 205f 7369 7a65 203d 2028 7368       _size = (sh
+00038740: 5b30 5d2d 3129 2f2f 340a 2020 2020 2020  [0]-1)//4.      
+00038750: 2020 2020 2020 5f78 3020 3d20 5f73 697a        _x0 = _siz
+00038760: 652a 320a 2020 2020 2020 2020 2020 2020  e*2.            
+00038770: 5f63 656e 203d 2028 5f78 302d 3129 2f2f  _cen = (_x0-1)//
+00038780: 320a 2020 2020 2020 2020 2020 2020 6f6b  2.            ok
+00038790: 203d 2028 6e70 2e61 6273 2864 7829 203c   = (np.abs(dx) <
+000387a0: 3d20 5f63 656e 2920 2620 286e 702e 6162  = _cen) & (np.ab
+000387b0: 7328 6479 2920 3c3d 205f 6365 6e29 0a20  s(dy) <= _cen). 
+000387c0: 2020 2020 2020 2020 2020 2063 6f6f 7264             coord
+000387d0: 7320 3d20 6e70 2e61 7272 6179 285b 5f78  s = np.array([_x
+000387e0: 302b 342a 6478 5b6f 6b5d 2c20 5f78 302b  0+4*dx[ok], _x0+
+000387f0: 342a 6479 5b6f 6b5d 5d29 0a0a 2020 2020  4*dy[ok]])..    
+00038800: 2020 2020 2320 446f 2074 6865 2069 6e74      # Do the int
+00038810: 6572 706f 6c61 7469 6f6e 0a20 2020 2020  erpolation.     
+00038820: 2020 2069 6e74 6572 705f 6d61 7020 3d20     interp_map = 
+00038830: 6d61 705f 636f 6f72 6469 6e61 7465 7328  map_coordinates(
+00038840: 7073 665f 7879 2c20 636f 6f72 6473 2c20  psf_xy, coords, 
+00038850: 6f72 6465 723d 3329 0a0a 2020 2020 2020  order=3)..      
+00038860: 2020 2320 4669 6c6c 206f 7574 7075 7420    # Fill output 
+00038870: 6461 7461 0a20 2020 2020 2020 206f 7574  data.        out
+00038880: 203d 206e 702e 7a65 726f 735f 6c69 6b65   = np.zeros_like
+00038890: 2864 782c 2064 7479 7065 3d6e 702e 666c  (dx, dtype=np.fl
+000388a0: 6f61 7433 3229 0a20 2020 2020 2020 206f  oat32).        o
+000388b0: 7574 5b6f 6b5d 203d 2069 6e74 6572 705f  ut[ok] = interp_
+000388c0: 6d61 700a 0a20 2020 2020 2020 2023 2045  map..        # E
+000388d0: 7874 656e 6465 6420 5053 460a 2020 2020  xtended PSF.    
+000388e0: 2020 2020 6966 2065 7874 656e 6465 645f      if extended_
+000388f0: 6461 7461 2069 7320 6e6f 7420 4e6f 6e65  data is not None
+00038900: 3a0a 2020 2020 2020 2020 2020 2020 6f6b  :.            ok
+00038910: 203d 2028 6e70 2e61 6273 2864 7829 203c   = (np.abs(dx) <
+00038920: 2073 656c 662e 6578 7465 6e64 6564 5f4e   self.extended_N
+00038930: 2920 0a20 2020 2020 2020 2020 2020 206f  ) .            o
+00038940: 6b20 263d 2028 6e70 2e61 6273 2864 7929  k &= (np.abs(dy)
+00038950: 203c 2073 656c 662e 6578 7465 6e64 6564   < self.extended
+00038960: 5f4e 290a 2020 2020 2020 2020 2020 2020  _N).            
+00038970: 0a20 2020 2020 2020 2020 2020 2078 3020  .            x0 
+00038980: 3d20 7365 6c66 2e65 7874 656e 6465 645f  = self.extended_
+00038990: 4e0a 2020 2020 2020 2020 2020 2020 636f  N.            co
+000389a0: 6f72 6473 203d 206e 702e 6172 7261 7928  ords = np.array(
+000389b0: 5b78 302b 6479 5b6f 6b5d 2b30 2c20 7830  [x0+dy[ok]+0, x0
+000389c0: 2b64 785b 6f6b 5d5d 290a 2020 2020 2020  +dx[ok]]).      
+000389d0: 2020 2020 2020 696e 7465 7270 5f6d 6170        interp_map
+000389e0: 203d 206d 6170 5f63 6f6f 7264 696e 6174   = map_coordinat
+000389f0: 6573 2865 7874 656e 6465 645f 6461 7461  es(extended_data
+00038a00: 2c20 636f 6f72 6473 2c20 6f72 6465 723d  , coords, order=
+00038a10: 3029 0a20 2020 2020 2020 2020 2020 206f  0).            o
+00038a20: 7574 5b6f 6b5d 202b 3d20 696e 7465 7270  ut[ok] += interp
+00038a30: 5f6d 6170 0a0a 2020 2020 2020 2020 7265  _map..        re
+00038a40: 7475 726e 206f 7574 0a0a 2020 2020 4073  turn out..    @s
+00038a50: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00038a60: 6465 6620 6f62 6a65 6374 6976 655f 6570  def objective_ep
+00038a70: 7366 5f63 656e 7465 7228 7061 7261 6d73  sf_center(params
+00038a80: 2c20 7365 6c66 2c20 7073 665f 7879 2c20  , self, psf_xy, 
+00038a90: 7363 692c 2069 7661 722c 2078 702c 2079  sci, ivar, xp, y
+00038aa0: 702c 2065 7874 656e 6465 645f 6461 7461  p, extended_data
+00038ab0: 2c20 7265 742c 2064 7339 293a 0a20 2020  , ret, ds9):.   
+00038ac0: 2020 2020 2022 2222 4f62 6a65 6374 6976       """Objectiv
+00038ad0: 6520 6675 6e63 7469 6f6e 2066 6f72 2066  e function for f
+00038ae0: 6974 7469 6e67 2065 5053 4673 0a0a 2020  itting ePSFs..  
+00038af0: 2020 2020 2020 5442 440a 0a20 2020 2020        TBD..     
+00038b00: 2020 2070 6172 616d 7320 3d20 5b6e 6f72     params = [nor
+00038b10: 6d61 6c69 7a61 7469 6f6e 2c20 7863 2c20  malization, xc, 
+00038b20: 7963 2c20 6261 636b 6772 6f75 6e64 5d0a  yc, background].
+00038b30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00038b40: 2020 2020 6672 6f6d 206e 756d 7079 2e6c      from numpy.l
+00038b50: 696e 616c 6720 696d 706f 7274 206c 7374  inalg import lst
+00038b60: 7371 0a0a 2020 2020 2020 2020 7368 203d  sq..        sh =
+00038b70: 2073 6369 2e73 6861 7065 0a20 2020 2020   sci.shape.     
+00038b80: 2020 2079 302c 2078 3020 3d20 6e70 2e61     y0, x0 = np.a
+00038b90: 7272 6179 2873 6829 2f32 2e2d 310a 0a20  rray(sh)/2.-1.. 
+00038ba0: 2020 2020 2020 2064 7820 3d20 7870 2d70         dx = xp-p
+00038bb0: 6172 616d 735b 305d 0a20 2020 2020 2020  arams[0].       
+00038bc0: 2064 7920 3d20 7970 2d70 6172 616d 735b   dy = yp-params[
+00038bd0: 315d 0a0a 2020 2020 2020 2020 6464 7820  1]..        ddx 
+00038be0: 3d20 7870 2020 2320 2d78 300a 2020 2020  = xp  # -x0.    
+00038bf0: 2020 2020 6464 7920 3d20 7970 2020 2320      ddy = yp  # 
+00038c00: 2d79 300a 0a20 2020 2020 2020 2064 6478  -y0..        ddx
+00038c10: 203d 2064 6478 2f64 6478 2e6d 6178 2829   = ddx/ddx.max()
+00038c20: 0a20 2020 2020 2020 2064 6479 203d 2064  .        ddy = d
+00038c30: 6479 2f64 6479 2e6d 6178 2829 0a0a 2020  dy/ddy.max()..  
+00038c40: 2020 2020 2020 2320 626b 6720 3d20 7061        # bkg = pa
+00038c50: 7261 6d73 5b33 5d20 2b20 7061 7261 6d73  rams[3] + params
+00038c60: 5b34 5d2a 6464 7820 2b20 7061 7261 6d73  [4]*ddx + params
+00038c70: 5b35 5d2a 6464 7920 232b 2070 6172 616d  [5]*ddy #+ param
+00038c80: 735b 365d 2a64 6478 2a64 6479 0a0a 2020  s[6]*ddx*ddy..  
+00038c90: 2020 2020 2020 7073 665f 6f66 6673 6574        psf_offset
+00038ca0: 203d 2073 656c 662e 6576 616c 5f65 5053   = self.eval_ePS
+00038cb0: 4628 7073 665f 7879 2c20 6478 2c20 6479  F(psf_xy, dx, dy
+00038cc0: 2c20 6578 7465 6e64 6564 5f64 6174 613d  , extended_data=
+00038cd0: 6578 7465 6e64 6564 5f64 6174 6129 2020  extended_data)  
+00038ce0: 2320 2a70 6172 616d 735b 305d 0a0a 2020  # *params[0]..  
+00038cf0: 2020 2020 2020 4120 3d20 286e 702e 6172        A = (np.ar
+00038d00: 7261 7928 5b70 7366 5f6f 6666 7365 742c  ray([psf_offset,
+00038d10: 206e 702e 6f6e 6573 5f6c 696b 6528 7363   np.ones_like(sc
+00038d20: 6929 2c20 6464 782c 2064 6479 5d29 2a6e  i), ddx, ddy])*n
+00038d30: 702e 7371 7274 2869 7661 7229 292e 7265  p.sqrt(ivar)).re
+00038d40: 7368 6170 6528 2834 2c20 2d31 2929 0a20  shape((4, -1)). 
+00038d50: 2020 2020 2020 2073 6369 6620 3d20 2873         scif = (s
+00038d60: 6369 2a6e 702e 7371 7274 2869 7661 7229  ci*np.sqrt(ivar)
+00038d70: 292e 666c 6174 7465 6e28 290a 2020 2020  ).flatten().    
+00038d80: 2020 2020 6d61 736b 203d 2028 7363 6966      mask = (scif
+00038d90: 2021 3d20 3029 0a20 2020 2020 2020 2063   != 0).        c
+00038da0: 6f65 6666 732c 205f 7265 7369 642c 205f  oeffs, _resid, _
+00038db0: 7261 6e6b 2c20 5f73 203d 206c 7374 7371  rank, _s = lstsq
+00038dc0: 2841 5b3a 2c20 6d61 736b 5d2e 542c 2073  (A[:, mask].T, s
+00038dd0: 6369 665b 6d61 736b 5d2c 200a 2020 2020  cif[mask], .    
+00038de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038e00: 2020 2020 2020 7263 6f6e 643d 4c53 5453        rcond=LSTS
+00038e10: 515f 5243 4f4e 4429 0a20 2020 2020 2020  Q_RCOND).       
+00038e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038e40: 2020 200a 2020 2020 2020 2020 7265 7369     .        resi
+00038e50: 6420 3d20 2873 6369 6620 2d20 6e70 2e64  d = (scif - np.d
+00038e60: 6f74 2863 6f65 6666 732c 2041 2929 0a0a  ot(coeffs, A))..
+00038e70: 2020 2020 2020 2020 6966 2064 7339 3a0a          if ds9:.
+00038e80: 2020 2020 2020 2020 2020 2020 4178 203d              Ax =
+00038e90: 2028 6e70 2e61 7272 6179 285b 7073 665f   (np.array([psf_
+00038ea0: 6f66 6673 6574 2c20 6e70 2e6f 6e65 735f  offset, np.ones_
+00038eb0: 6c69 6b65 2873 6369 292c 2064 6478 2c20  like(sci), ddx, 
+00038ec0: 6464 795d 2929 2e72 6573 6861 7065 2828  ddy])).reshape((
+00038ed0: 342c 202d 3129 290a 2020 2020 2020 2020  4, -1)).        
+00038ee0: 2020 2020 7073 665f 6d6f 6465 6c20 3d20      psf_model = 
+00038ef0: 6e70 2e64 6f74 2863 6f65 6666 735b 3a31  np.dot(coeffs[:1
+00038f00: 5d2c 2041 785b 3a31 2c20 3a5d 292e 7265  ], Ax[:1, :]).re
+00038f10: 7368 6170 6528 7363 692e 7368 6170 6529  shape(sci.shape)
+00038f20: 0a20 2020 2020 2020 2020 2020 2062 6b67  .            bkg
+00038f30: 203d 206e 702e 646f 7428 636f 6566 6673   = np.dot(coeffs
+00038f40: 5b31 3a5d 2c20 4178 5b31 3a2c 203a 5d29  [1:], Ax[1:, :])
+00038f50: 2e72 6573 6861 7065 2873 6369 2e73 6861  .reshape(sci.sha
+00038f60: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+00038f70: 6473 392e 7669 6577 2828 7363 692d 7073  ds9.view((sci-ps
+00038f80: 665f 6d6f 6465 6c2d 626b 6729 2a6d 6173  f_model-bkg)*mas
+00038f90: 6b2e 7265 7368 6170 6528 7363 692e 7368  k.reshape(sci.sh
+00038fa0: 6170 6529 290a 0a20 2020 2020 2020 2069  ape))..        i
+00038fb0: 6620 7265 7420 3d3d 2027 7265 7369 6427  f ret == 'resid'
+00038fc0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00038fd0: 7475 726e 2072 6573 6964 0a20 2020 2020  turn resid.     
+00038fe0: 2020 2065 6c69 6620 7265 7420 3d3d 2027     elif ret == '
+00038ff0: 6c6d 273a 0a20 2020 2020 2020 2020 2020  lm':.           
+00039000: 2023 206d 6173 6b65 6420 7265 7369 6475   # masked residu
+00039010: 616c 7320 666f 7220 4c4d 206f 7074 696d  als for LM optim
+00039020: 697a 6174 696f 6e0a 2020 2020 2020 2020  ization.        
+00039030: 2020 2020 6966 2046 616c 7365 3a0a 2020      if False:.  
+00039040: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00039050: 696e 7428 7061 7261 6d73 2c20 2872 6573  int(params, (res
+00039060: 6964 2a2a 3229 2e73 756d 2829 2c20 636f  id**2).sum(), co
+00039070: 6566 6673 5b30 5d29 0a0a 2020 2020 2020  effs[0])..      
+00039080: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00039090: 6964 5b72 6573 6964 2021 3d20 305d 0a20  id[resid != 0]. 
+000390a0: 2020 2020 2020 2065 6c69 6620 7265 7420         elif ret 
+000390b0: 3d3d 2027 6d6f 6465 6c27 3a0a 2020 2020  == 'model':.    
+000390c0: 2020 2020 2020 2020 4178 203d 2028 6e70          Ax = (np
+000390d0: 2e61 7272 6179 285b 7073 665f 6f66 6673  .array([psf_offs
+000390e0: 6574 2c20 6e70 2e6f 6e65 735f 6c69 6b65  et, np.ones_like
+000390f0: 2873 6369 292c 2064 6478 2c20 6464 795d  (sci), ddx, ddy]
+00039100: 2929 2e72 6573 6861 7065 2828 342c 202d  )).reshape((4, -
+00039110: 3129 290a 2020 2020 2020 2020 2020 2020  1)).            
+00039120: 7073 665f 6d6f 6465 6c20 3d20 6e70 2e64  psf_model = np.d
+00039130: 6f74 2863 6f65 6666 735b 3a31 5d2c 2041  ot(coeffs[:1], A
+00039140: 785b 3a31 2c20 3a5d 292e 7265 7368 6170  x[:1, :]).reshap
+00039150: 6528 7363 692e 7368 6170 6529 0a20 2020  e(sci.shape).   
+00039160: 2020 2020 2020 2020 2062 6b67 203d 206e           bkg = n
+00039170: 702e 646f 7428 636f 6566 6673 5b31 3a5d  p.dot(coeffs[1:]
+00039180: 2c20 4178 5b31 3a2c 203a 5d29 2e72 6573  , Ax[1:, :]).res
+00039190: 6861 7065 2873 6369 2e73 6861 7065 290a  hape(sci.shape).
+000391a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000391b0: 726e 2070 7366 5f6d 6f64 656c 2c20 626b  rn psf_model, bk
+000391c0: 672c 2041 782c 2063 6f65 6666 730a 2020  g, Ax, coeffs.  
+000391d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000391e0: 2020 2020 2020 2020 6368 6932 203d 2028          chi2 = (
+000391f0: 7265 7369 642a 2a32 292e 7375 6d28 290a  resid**2).sum().
+00039200: 2020 2020 2020 2020 2020 2020 2370 7269              #pri
+00039210: 6e74 2870 6172 616d 732c 2063 6869 322c  nt(params, chi2,
+00039220: 2063 6f65 6666 735b 305d 290a 2020 2020   coeffs[0]).    
+00039230: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00039240: 6869 320a 0a20 2020 2040 7374 6174 6963  hi2..    @static
+00039250: 6d65 7468 6f64 0a20 2020 2064 6566 206f  method.    def o
+00039260: 626a 6563 7469 7665 5f65 7073 6628 7061  bjective_epsf(pa
+00039270: 7261 6d73 2c20 7365 6c66 2c20 7073 665f  rams, self, psf_
+00039280: 7879 2c20 7363 692c 2069 7661 722c 2078  xy, sci, ivar, x
+00039290: 702c 2079 702c 2065 7874 656e 6465 645f  p, yp, extended_
+000392a0: 6461 7461 2c20 7265 742c 2064 7339 293a  data, ret, ds9):
+000392b0: 0a20 2020 2020 2020 2022 2222 4f62 6a65  .        """Obje
+000392c0: 6374 6976 6520 6675 6e63 7469 6f6e 2066  ctive function f
+000392d0: 6f72 2066 6974 7469 6e67 2065 5053 4673  or fitting ePSFs
+000392e0: 0a0a 2020 2020 2020 2020 5442 440a 0a20  ..        TBD.. 
+000392f0: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
+00039300: 5b6e 6f72 6d61 6c69 7a61 7469 6f6e 2c20  [normalization, 
+00039310: 7863 2c20 7963 2c20 6261 636b 6772 6f75  xc, yc, backgrou
+00039320: 6e64 5d0a 2020 2020 2020 2020 2222 220a  nd].        """.
+00039330: 2020 2020 2020 2020 6478 203d 2078 702d          dx = xp-
+00039340: 7061 7261 6d73 5b31 5d0a 2020 2020 2020  params[1].      
+00039350: 2020 6479 203d 2079 702d 7061 7261 6d73    dy = yp-params
+00039360: 5b32 5d0a 0a20 2020 2020 2020 2064 6478  [2]..        ddx
+00039370: 203d 2078 702d 7870 2e6d 696e 2829 0a20   = xp-xp.min(). 
+00039380: 2020 2020 2020 2064 6479 203d 2079 702d         ddy = yp-
+00039390: 7970 2e6d 696e 2829 0a0a 2020 2020 2020  yp.min()..      
+000393a0: 2020 6464 7820 3d20 6464 782f 6464 782e    ddx = ddx/ddx.
+000393b0: 6d61 7828 290a 2020 2020 2020 2020 6464  max().        dd
+000393c0: 7920 3d20 6464 792f 6464 792e 6d61 7828  y = ddy/ddy.max(
+000393d0: 290a 0a20 2020 2020 2020 2062 6b67 203d  )..        bkg =
+000393e0: 2070 6172 616d 735b 335d 202b 2070 6172   params[3] + par
+000393f0: 616d 735b 345d 2a64 6478 202b 2070 6172  ams[4]*ddx + par
+00039400: 616d 735b 355d 2a64 6479 2020 2320 2b20  ams[5]*ddy  # + 
+00039410: 7061 7261 6d73 5b36 5d2a 6464 782a 6464  params[6]*ddx*dd
+00039420: 790a 0a20 2020 2020 2020 2070 7366 5f6f  y..        psf_o
+00039430: 6666 7365 7420 3d20 7365 6c66 2e65 7661  ffset = self.eva
+00039440: 6c5f 6550 5346 2870 7366 5f78 792c 2064  l_ePSF(psf_xy, d
+00039450: 782c 2064 792c 2065 7874 656e 6465 645f  x, dy, extended_
+00039460: 6461 7461 3d65 7874 656e 6465 645f 6461  data=extended_da
+00039470: 7461 292a 7061 7261 6d73 5b30 5d0a 0a20  ta)*params[0].. 
+00039480: 2020 2020 2020 2072 6573 6964 203d 2028         resid = (
+00039490: 7363 692d 7073 665f 6f66 6673 6574 2d62  sci-psf_offset-b
+000394a0: 6b67 292a 6e70 2e73 7172 7428 6976 6172  kg)*np.sqrt(ivar
+000394b0: 290a 0a20 2020 2020 2020 2069 6620 6473  )..        if ds
+000394c0: 393a 0a20 2020 2020 2020 2020 2020 2064  9:.            d
+000394d0: 7339 2e76 6965 7728 7363 692d 7073 665f  s9.view(sci-psf_
+000394e0: 6f66 6673 6574 2d62 6b67 290a 0a20 2020  offset-bkg)..   
+000394f0: 2020 2020 2069 6620 7265 7420 3d3d 2027       if ret == '
+00039500: 7265 7369 6427 3a0a 2020 2020 2020 2020  resid':.        
+00039510: 2020 2020 7265 7475 726e 2072 6573 6964      return resid
+00039520: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
+00039530: 7420 3d3d 2027 6c6d 273a 0a20 2020 2020  t == 'lm':.     
+00039540: 2020 2020 2020 2023 206d 6173 6b65 6420         # masked 
+00039550: 7265 7369 6475 616c 7320 666f 7220 4c4d  residuals for LM
+00039560: 206f 7074 696d 697a 6174 696f 6e0a 2020   optimization.  
+00039570: 2020 2020 2020 2020 2020 6966 2046 616c            if Fal
+00039580: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00039590: 2020 2020 7072 696e 7428 7061 7261 6d73      print(params
+000395a0: 2c20 2872 6573 6964 2a2a 3229 2e73 756d  , (resid**2).sum
+000395b0: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
+000395c0: 2072 6574 7572 6e20 7265 7369 645b 7265   return resid[re
+000395d0: 7369 6420 213d 2030 5d0a 2020 2020 2020  sid != 0].      
+000395e0: 2020 656c 6966 2072 6574 203d 3d20 276d    elif ret == 'm
+000395f0: 6f64 656c 273a 0a20 2020 2020 2020 2020  odel':.         
+00039600: 2020 2072 6574 7572 6e20 7073 665f 6f66     return psf_of
+00039610: 6673 6574 2c20 626b 672c 204e 6f6e 652c  fset, bkg, None,
+00039620: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
+00039630: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00039640: 6368 6932 203d 2028 7265 7369 642a 2a32  chi2 = (resid**2
+00039650: 292e 7375 6d28 290a 2020 2020 2020 2020  ).sum().        
+00039660: 2020 2020 2370 7269 6e74 2870 6172 616d      #print(param
+00039670: 732c 2063 6869 3229 0a20 2020 2020 2020  s, chi2).       
+00039680: 2020 2020 2072 6574 7572 6e20 6368 6932       return chi2
+00039690: 0a0a 2020 2020 6465 6620 6669 745f 6550  ..    def fit_eP
+000396a0: 5346 2873 656c 662c 2073 6369 2c20 6365  SF(self, sci, ce
+000396b0: 6e74 6572 3d4e 6f6e 652c 206f 7269 6769  nter=None, origi
+000396c0: 6e3d 5b30 2c20 305d 2c20 6976 6172 3d31  n=[0, 0], ivar=1
+000396d0: 2c20 4e3d 372c 0a20 2020 2020 2020 2020  , N=7,.         
+000396e0: 2020 2020 2020 2020 6669 6c74 6572 3d27          filter='
+000396f0: 4631 3430 5727 2c20 746f 6c3d 312e 652d  F140W', tol=1.e-
+00039700: 342c 2067 7565 7373 3d4e 6f6e 652c 2067  4, guess=None, g
+00039710: 6574 5f65 7874 656e 6465 643d 4661 6c73  et_extended=Fals
+00039720: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00039730: 2020 2020 6d65 7468 6f64 3d27 6c6d 272c      method='lm',
+00039740: 2064 7339 3d4e 6f6e 652c 2070 7366 5f70   ds9=None, psf_p
+00039750: 6172 616d 733d 4e6f 6e65 2c20 6f6e 6c79  arams=None, only
+00039760: 5f63 656e 7465 7269 6e67 3d54 7275 652c  _centering=True,
+00039770: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00039780: 2020 2072 6f74 3930 3d30 293a 0a20 2020     rot90=0):.   
+00039790: 2020 2020 2022 2222 4669 7420 6550 5346       """Fit ePSF
+000397a0: 2074 6f20 696e 7075 7420 6461 7461 0a20   to input data. 
+000397b0: 2020 2020 2020 2054 4244 0a20 2020 2020         TBD.     
+000397c0: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+000397d0: 726f 6d20 7363 6970 792e 6f70 7469 6d69  rom scipy.optimi
+000397e0: 7a65 2069 6d70 6f72 7420 6d69 6e69 6d69  ze import minimi
+000397f0: 7a65 2c20 6c65 6173 745f 7371 7561 7265  ze, least_square
+00039800: 730a 0a20 2020 2020 2020 2073 6820 3d20  s..        sh = 
+00039810: 7363 692e 7368 6170 650a 2020 2020 2020  sci.shape.      
+00039820: 2020 6966 2063 656e 7465 7220 6973 204e    if center is N
+00039830: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00039840: 2079 302c 2078 3020 3d20 6e70 2e61 7272   y0, x0 = np.arr
+00039850: 6179 2873 6829 2f32 2e2d 310a 2020 2020  ay(sh)/2.-1.    
+00039860: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00039870: 2020 2020 2020 7830 2c20 7930 203d 2063        x0, y0 = c
+00039880: 656e 7465 720a 0a20 2020 2020 2020 2078  enter..        x
+00039890: 6420 3d20 7830 2b6f 7269 6769 6e5b 315d  d = x0+origin[1]
+000398a0: 0a20 2020 2020 2020 2079 6420 3d20 7930  .        yd = y0
+000398b0: 2b6f 7269 6769 6e5b 305d 0a0a 2020 2020  +origin[0]..    
+000398c0: 2020 2020 7863 2c20 7963 203d 2069 6e74      xc, yc = int
+000398d0: 2878 3029 2c20 696e 7428 7930 290a 0a20  (x0), int(y0).. 
+000398e0: 2020 2020 2020 2070 7366 5f78 7920 3d20         psf_xy = 
+000398f0: 7365 6c66 2e67 6574 5f61 745f 706f 7369  self.get_at_posi
+00039900: 7469 6f6e 2878 3d78 642c 2079 3d79 642c  tion(x=xd, y=yd,
+00039910: 2066 696c 7465 723d 6669 6c74 6572 2c20   filter=filter, 
+00039920: 726f 7439 303d 726f 7439 3029 0a0a 2020  rot90=rot90)..  
+00039930: 2020 2020 2020 7970 2c20 7870 203d 206e        yp, xp = n
+00039940: 702e 696e 6469 6365 7328 7368 290a 0a20  p.indices(sh).. 
+00039950: 2020 2020 2020 2069 6620 6775 6573 7320         if guess 
+00039960: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00039970: 2020 2020 2069 6620 6e70 2e69 7373 6361       if np.issca
+00039980: 6c61 7228 6976 6172 293a 0a20 2020 2020  lar(ivar):.     
+00039990: 2020 2020 2020 2020 2020 2069 7820 3d20             ix = 
+000399a0: 6e70 2e61 7267 6d61 7828 7363 692e 666c  np.argmax(sci.fl
+000399b0: 6174 7465 6e28 2929 0a20 2020 2020 2020  atten()).       
+000399c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000399d0: 2020 2020 2020 2020 2020 2069 7820 3d20             ix = 
+000399e0: 6e70 2e61 7267 6d61 7828 2873 6369 2a28  np.argmax((sci*(
+000399f0: 6976 6172 203e 2030 2929 2e66 6c61 7474  ivar > 0)).flatt
+00039a00: 656e 2829 290a 0a20 2020 2020 2020 2020  en())..         
+00039a10: 2020 2078 6775 6573 7320 3d20 7870 2e66     xguess = xp.f
+00039a20: 6c61 7474 656e 2829 5b69 785d 0a20 2020  latten()[ix].   
+00039a30: 2020 2020 2020 2020 2079 6775 6573 7320           yguess 
+00039a40: 3d20 7970 2e66 6c61 7474 656e 2829 5b69  = yp.flatten()[i
+00039a50: 785d 0a20 2020 2020 2020 2065 6c73 653a  x].        else:
+00039a60: 0a20 2020 2020 2020 2020 2020 2078 6775  .            xgu
+00039a70: 6573 732c 2079 6775 6573 7320 3d20 6775  ess, yguess = gu
+00039a80: 6573 730a 0a20 2020 2020 2020 206d 6564  ess..        med
+00039a90: 5f62 6b67 203d 206e 702e 6d65 6469 616e  _bkg = np.median
+00039aa0: 2873 6369 290a 0a20 2020 2020 2020 2069  (sci)..        i
+00039ab0: 6620 6f6e 6c79 5f63 656e 7465 7269 6e67  f only_centering
+00039ac0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00039ad0: 4f6e 6c79 2066 6974 2066 6f72 2063 656e  Only fit for cen
+00039ae0: 7465 7269 6e67 2061 6e64 2063 6f6d 7075  tering and compu
+00039af0: 7465 206e 6f72 6d61 6c69 7a61 7469 6f6e  te normalization
+00039b00: 730a 2020 2020 2020 2020 2020 2020 6775  s.            gu
+00039b10: 6573 7320 3d20 5b78 6775 6573 732c 2079  ess = [xguess, y
+00039b20: 6775 6573 735d 0a20 2020 2020 2020 2020  guess].         
+00039b30: 2020 205f 6f62 6a66 756e 203d 2073 656c     _objfun = sel
+00039b40: 662e 6f62 6a65 6374 6976 655f 6570 7366  f.objective_epsf
+00039b50: 5f63 656e 7465 720a 2020 2020 2020 2020  _center.        
+00039b60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00039b70: 2020 2320 4669 7420 666f 7220 6365 6e74    # Fit for cent
+00039b80: 6572 696e 6720 616e 6420 6e6f 726d 616c  ering and normal
+00039b90: 697a 6174 696f 6e0a 2020 2020 2020 2020  ization.        
+00039ba0: 2020 2020 6775 6573 7320 3d20 5b28 7363      guess = [(sc
+00039bb0: 692d 6d65 645f 626b 6729 5b79 632d 4e3a  i-med_bkg)[yc-N:
+00039bc0: 7963 2b4e 2c20 7863 2d4e 3a78 632b 4e5d  yc+N, xc-N:xc+N]
+00039bd0: 2e73 756d 2829 2c20 7867 7565 7373 2c20  .sum(), xguess, 
+00039be0: 7967 7565 7373 2c20 6d65 645f 626b 672c  yguess, med_bkg,
+00039bf0: 2030 2c20 305d 0a20 2020 2020 2020 2020   0, 0].         
+00039c00: 2020 205f 6f62 6a66 756e 203d 2073 656c     _objfun = sel
+00039c10: 662e 6f62 6a65 6374 6976 655f 6570 7366  f.objective_epsf
+00039c20: 0a0a 2020 2020 2020 2020 736c 7920 3d20  ..        sly = 
+00039c30: 736c 6963 6528 7963 2d4e 2c20 7963 2b4e  slice(yc-N, yc+N
+00039c40: 290a 2020 2020 2020 2020 736c 7820 3d20  ).        slx = 
+00039c50: 736c 6963 6528 7863 2d4e 2c20 7863 2b4e  slice(xc-N, xc+N
+00039c60: 290a 2020 2020 2020 2020 736c 7920 3d20  ).        sly = 
+00039c70: 736c 6963 6528 7967 7565 7373 2d4e 2c20  slice(yguess-N, 
+00039c80: 7967 7565 7373 2b4e 290a 2020 2020 2020  yguess+N).      
+00039c90: 2020 736c 7820 3d20 736c 6963 6528 7867    slx = slice(xg
+00039ca0: 7565 7373 2d4e 2c20 7867 7565 7373 2b4e  uess-N, xguess+N
+00039cb0: 290a 0a20 2020 2020 2020 2069 7661 725f  )..        ivar_
+00039cc0: 6d61 736b 203d 206e 702e 7a65 726f 735f  mask = np.zeros_
+00039cd0: 6c69 6b65 2873 6369 290a 2020 2020 2020  like(sci).      
+00039ce0: 2020 6976 6172 5f6d 6173 6b5b 736c 792c    ivar_mask[sly,
+00039cf0: 2073 6c78 5d20 3d20 310a 2020 2020 2020   slx] = 1.      
+00039d00: 2020 6976 6172 5f6d 6173 6b20 2a3d 2069    ivar_mask *= i
+00039d10: 7661 720a 0a20 2020 2020 2020 2069 6620  var..        if 
+00039d20: 6765 745f 6578 7465 6e64 6564 3a0a 2020  get_extended:.  
+00039d30: 2020 2020 2020 2020 2020 6966 2066 696c            if fil
+00039d40: 7465 7220 696e 2073 656c 662e 6578 7465  ter in self.exte
+00039d50: 6e64 6564 5f65 7073 663a 0a20 2020 2020  nded_epsf:.     
+00039d60: 2020 2020 2020 2020 2020 2065 7874 656e             exten
+00039d70: 6465 645f 6461 7461 203d 2073 656c 662e  ded_data = self.
+00039d80: 6578 7465 6e64 6564 5f65 7073 665b 6669  extended_epsf[fi
+00039d90: 6c74 6572 5d0a 2020 2020 2020 2020 2020  lter].          
+00039da0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00039db0: 2020 2020 2020 2020 6578 7465 6e64 6564          extended
+00039dc0: 5f64 6174 6120 3d20 4e6f 6e65 0a20 2020  _data = None.   
+00039dd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00039de0: 2020 2020 2020 2065 7874 656e 6465 645f         extended_
+00039df0: 6461 7461 203d 204e 6f6e 650a 0a20 2020  data = None..   
+00039e00: 2020 2020 2023 2047 6574 206d 6f64 656c       # Get model
+00039e10: 0a20 2020 2020 2020 2069 6620 7073 665f  .        if psf_
+00039e20: 7061 7261 6d73 2069 7320 6e6f 7420 4e6f  params is not No
+00039e30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00039e40: 7078 203d 2070 7366 5f70 6172 616d 732a  px = psf_params*
+00039e50: 310a 2020 2020 2020 2020 2020 2020 6966  1.            if
+00039e60: 206c 656e 2870 7829 203d 3d20 323a 0a20   len(px) == 2:. 
+00039e70: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00039e80: 6f62 6a66 756e 203d 2073 656c 662e 6f62  objfun = self.ob
+00039e90: 6a65 6374 6976 655f 6570 7366 5f63 656e  jective_epsf_cen
+00039ea0: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
+00039eb0: 2020 2020 7078 5b30 5d20 2b3d 2078 300a      px[0] += x0.
+00039ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ed0: 7078 5b31 5d20 2b3d 2079 300a 2020 2020  px[1] += y0.    
+00039ee0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00039ef0: 2020 2020 2020 2020 2020 2020 2020 5f6f                _o
+00039f00: 626a 6675 6e20 3d20 7365 6c66 2e6f 626a  bjfun = self.obj
+00039f10: 6563 7469 7665 5f65 7073 660a 2020 2020  ective_epsf.    
+00039f20: 2020 2020 2020 2020 2020 2020 7078 5b31              px[1
+00039f30: 5d20 2b3d 2078 300a 2020 2020 2020 2020  ] += x0.        
+00039f40: 2020 2020 2020 2020 7078 5b32 5d20 2b3d          px[2] +=
+00039f50: 2079 300a 0a20 2020 2020 2020 2020 2020   y0..           
+00039f60: 2061 7267 7320 3d20 2873 656c 662c 2070   args = (self, p
+00039f70: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
+00039f80: 5f6d 6173 6b2c 2078 702c 2079 702c 2065  _mask, xp, yp, e
+00039f90: 7874 656e 6465 645f 6461 7461 2c20 276d  xtended_data, 'm
+00039fa0: 6f64 656c 272c 2064 7339 290a 2020 2020  odel', ds9).    
+00039fb0: 2020 2020 2020 2020 7073 665f 6d6f 6465          psf_mode
+00039fc0: 6c2c 2062 6b67 2c20 412c 2063 6f65 6666  l, bkg, A, coeff
+00039fd0: 7320 3d20 5f6f 626a 6675 6e28 7078 2c20  s = _objfun(px, 
+00039fe0: 2a61 7267 7329 0a20 2020 2020 2020 2020  *args).         
+00039ff0: 2020 2072 6574 7572 6e20 7073 665f 6d6f     return psf_mo
+0003a000: 6465 6c2c 2062 6b67 2c20 412c 2063 6f65  del, bkg, A, coe
+0003a010: 6666 730a 0a20 2020 2020 2020 2069 6620  ffs..        if 
+0003a020: 6d65 7468 6f64 203d 3d20 276c 6d27 3a0a  method == 'lm':.
+0003a030: 2020 2020 2020 2020 2020 2020 6172 6773              args
+0003a040: 203d 2028 7365 6c66 2c20 7073 665f 7879   = (self, psf_xy
+0003a050: 2c20 7363 692c 2069 7661 725f 6d61 736b  , sci, ivar_mask
+0003a060: 2c20 7870 2c20 7970 2c20 6578 7465 6e64  , xp, yp, extend
+0003a070: 6564 5f64 6174 612c 2027 6c6d 272c 2064  ed_data, 'lm', d
+0003a080: 7339 290a 0a20 2020 2020 2020 2020 2020  s9)..           
+0003a090: 2078 5f73 6361 6c65 203d 2027 6a61 6327   x_scale = 'jac'
+0003a0a0: 0a20 2020 2020 2020 2020 2020 2023 785f  .            #x_
+0003a0b0: 7363 616c 6520 3d20 5b67 7565 7373 5b30  scale = [guess[0
+0003a0c0: 5d2c 2031 2c20 312c 2031 302c 2031 302c  ], 1, 1, 10, 10,
+0003a0d0: 2031 305d 0a20 2020 2020 2020 2020 2020   10].           
+0003a0e0: 2023 6f75 7420 3d20 6c65 6173 745f 7371   #out = least_sq
+0003a0f0: 7561 7265 7328 5f6f 626a 6675 6e2c 2067  uares(_objfun, g
+0003a100: 7565 7373 2c20 6172 6773 3d61 7267 732c  uess, args=args,
+0003a110: 206d 6574 686f 643d 2774 7266 272c 2078   method='trf', x
+0003a120: 5f73 6361 6c65 3d78 5f73 6361 6c65 2c20  _scale=x_scale, 
+0003a130: 6c6f 7373 3d27 6875 6265 7227 290a 2020  loss='huber').  
+0003a140: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+0003a150: 6c65 6173 745f 7371 7561 7265 7328 5f6f  least_squares(_o
+0003a160: 626a 6675 6e2c 2067 7565 7373 2c20 6172  bjfun, guess, ar
+0003a170: 6773 3d61 7267 732c 206d 6574 686f 643d  gs=args, method=
+0003a180: 276c 6d27 2c20 785f 7363 616c 653d 785f  'lm', x_scale=x_
+0003a190: 7363 616c 652c 206c 6f73 733d 276c 696e  scale, loss='lin
+0003a1a0: 6561 7227 290a 2020 2020 2020 2020 2020  ear').          
+0003a1b0: 2020 7073 665f 7061 7261 6d73 203d 206f    psf_params = o
+0003a1c0: 7574 2e78 2a31 0a20 2020 2020 2020 2065  ut.x*1.        e
+0003a1d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003a1e0: 2061 7267 7320 3d20 2873 656c 662c 2070   args = (self, p
+0003a1f0: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
+0003a200: 5f6d 6173 6b2c 2078 702c 2079 702c 2065  _mask, xp, yp, e
+0003a210: 7874 656e 6465 645f 6461 7461 2c20 2763  xtended_data, 'c
+0003a220: 6869 3227 2c20 6473 3929 0a20 2020 2020  hi2', ds9).     
+0003a230: 2020 2020 2020 206f 7574 203d 206d 696e         out = min
+0003a240: 696d 697a 6528 5f6f 626a 6675 6e2c 2067  imize(_objfun, g
+0003a250: 7565 7373 2c20 6172 6773 3d61 7267 732c  uess, args=args,
+0003a260: 206d 6574 686f 643d 6d65 7468 6f64 2c20   method=method, 
+0003a270: 746f 6c3d 746f 6c29 0a20 2020 2020 2020  tol=tol).       
+0003a280: 2020 2020 2070 7366 5f70 6172 616d 7320       psf_params 
+0003a290: 3d20 6f75 742e 782a 310a 0a20 2020 2020  = out.x*1..     
+0003a2a0: 2020 2069 6620 6c65 6e28 6775 6573 7329     if len(guess)
+0003a2b0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+0003a2c0: 2020 2070 7366 5f70 6172 616d 735b 305d     psf_params[0]
+0003a2d0: 202d 3d20 7830 0a20 2020 2020 2020 2020   -= x0.         
+0003a2e0: 2020 2070 7366 5f70 6172 616d 735b 315d     psf_params[1]
+0003a2f0: 202d 3d20 7930 0a20 2020 2020 2020 2065   -= y0.        e
+0003a300: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003a310: 2070 7366 5f70 6172 616d 735b 315d 202d   psf_params[1] -
+0003a320: 3d20 7830 0a20 2020 2020 2020 2020 2020  = x0.           
+0003a330: 2070 7366 5f70 6172 616d 735b 325d 202d   psf_params[2] -
+0003a340: 3d20 7930 0a0a 2020 2020 2020 2020 2320  = y0..        # 
+0003a350: 6966 2046 616c 7365 3a0a 2020 2020 2020  if False:.      
+0003a360: 2020 2320 0a20 2020 2020 2020 2023 2020    # .        #  
+0003a370: 2020 2070 7366 5f66 6974 203d 2065 7073     psf_fit = eps
+0003a380: 662e 6765 745f 6550 5346 2870 7366 5f70  f.get_ePSF(psf_p
+0003a390: 6172 616d 732c 206f 7269 6769 6e3d 6f72  arams, origin=or
+0003a3a0: 6967 696e 2c0a 2020 2020 2020 2020 2320  igin,.        # 
+0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a3c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003a3d0: 696c 7465 723d 6669 6c74 6572 2c20 7368  ilter=filter, sh
+0003a3e0: 6170 653d 7368 2c0a 2020 2020 2020 2020  ape=sh,.        
+0003a3f0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+0003a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a410: 2067 6574 5f65 7874 656e 6465 643d 6765   get_extended=ge
+0003a420: 745f 6578 7465 6e64 6564 290a 2020 2020  t_extended).    
+0003a430: 2020 2020 2320 0a20 2020 2020 2020 2023      # .        #
+0003a440: 2020 2020 2078 6172 6773 203d 2028 7365       xargs = (se
+0003a450: 6c66 2c20 7073 665f 7879 2c20 7363 692c  lf, psf_xy, sci,
+0003a460: 2069 7661 725f 6d61 736b 2c20 7870 2c20   ivar_mask, xp, 
+0003a470: 7970 2c20 6578 7465 6e64 6564 5f64 6174  yp, extended_dat
+0003a480: 612c 2027 6c6d 272c 204e 6f6e 6529 0a20  a, 'lm', None). 
+0003a490: 2020 2020 2020 2023 2020 2020 206c 6d20         #     lm 
+0003a4a0: 3d20 5f6f 626a 6675 6e28 6f75 742e 782c  = _objfun(out.x,
+0003a4b0: 202a 7861 7267 7329 0a20 2020 2020 2020   *xargs).       
+0003a4c0: 2023 2020 2020 2063 6172 6773 203d 2028   #     cargs = (
+0003a4d0: 7365 6c66 2c20 7073 665f 7879 2c20 7363  self, psf_xy, sc
+0003a4e0: 692c 2069 7661 725f 6d61 736b 2c20 7870  i, ivar_mask, xp
+0003a4f0: 2c20 7970 2c20 6578 7465 6e64 6564 5f64  , yp, extended_d
+0003a500: 6174 612c 2027 6368 6932 272c 204e 6f6e  ata, 'chi2', Non
+0003a510: 6529 0a20 2020 2020 2020 2023 2020 2020  e).        #    
+0003a520: 2063 6869 3220 3d20 5f6f 626a 6675 6e28   chi2 = _objfun(
+0003a530: 6f75 742e 782c 202a 6361 7267 7329 0a0a  out.x, *cargs)..
+0003a540: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0003a550: 7366 5f70 6172 616d 730a 0a20 2020 2020  sf_params..     
+0003a560: 2020 2023 2064 7820 3d20 7870 2d70 7366     # dx = xp-psf
+0003a570: 5f70 6172 616d 735b 315d 0a20 2020 2020  _params[1].     
+0003a580: 2020 2023 2064 7920 3d20 7970 2d70 7366     # dy = yp-psf
+0003a590: 5f70 6172 616d 735b 325d 0a20 2020 2020  _params[2].     
+0003a5a0: 2020 2023 206f 7574 7075 745f 7073 6620     # output_psf 
+0003a5b0: 3d20 7365 6c66 2e65 7661 6c5f 6550 5346  = self.eval_ePSF
+0003a5c0: 2870 7366 5f78 792c 2064 782c 2064 7929  (psf_xy, dx, dy)
+0003a5d0: 2a70 7366 5f70 6172 616d 735b 305d 0a20  *psf_params[0]. 
+0003a5e0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+0003a5f0: 2023 2072 6574 7572 6e20 6f75 7470 7574   # return output
+0003a600: 5f70 7366 2c20 7073 665f 7061 7261 6d73  _psf, psf_params
+0003a610: 0a0a 2020 2020 6465 6620 6765 745f 6550  ..    def get_eP
+0003a620: 5346 2873 656c 662c 2070 7366 5f70 6172  SF(self, psf_par
+0003a630: 616d 732c 2073 6369 3d4e 6f6e 652c 2069  ams, sci=None, i
+0003a640: 7661 723d 312c 206f 7269 6769 6e3d 5b30  var=1, origin=[0
+0003a650: 2c20 305d 2c20 7368 6170 653d 5b32 302c  , 0], shape=[20,
+0003a660: 2032 305d 2c20 6669 6c74 6572 3d27 4631   20], filter='F1
+0003a670: 3430 5727 2c20 6765 745f 6578 7465 6e64  40W', get_extend
+0003a680: 6564 3d46 616c 7365 2c20 6765 745f 6261  ed=False, get_ba
+0003a690: 636b 6772 6f75 6e64 3d46 616c 7365 2c20  ckground=False, 
+0003a6a0: 726f 7439 303d 3029 3a0a 2020 2020 2020  rot90=0):.      
+0003a6b0: 2020 2222 220a 2020 2020 2020 2020 4576    """.        Ev
+0003a6c0: 616c 7561 7465 2061 6e20 4566 6665 6374  aluate an Effect
+0003a6d0: 6976 6520 5053 460a 2020 2020 2020 2020  ive PSF.        
+0003a6e0: 2222 220a 2020 2020 2020 2020 7368 203d  """.        sh =
+0003a6f0: 2073 6861 7065 0a20 2020 2020 2020 2079   shape.        y
+0003a700: 302c 2078 3020 3d20 6e70 2e61 7272 6179  0, x0 = np.array
+0003a710: 2873 6829 2f32 2e2d 310a 0a20 2020 2020  (sh)/2.-1..     
+0003a720: 2020 2078 6420 3d20 7830 2b6f 7269 6769     xd = x0+origi
+0003a730: 6e5b 315d 0a20 2020 2020 2020 2079 6420  n[1].        yd 
+0003a740: 3d20 7930 2b6f 7269 6769 6e5b 305d 0a0a  = y0+origin[0]..
+0003a750: 2020 2020 2020 2020 7863 2c20 7963 203d          xc, yc =
+0003a760: 2069 6e74 2878 3029 2c20 696e 7428 7930   int(x0), int(y0
+0003a770: 290a 0a20 2020 2020 2020 2070 7366 5f78  )..        psf_x
+0003a780: 7920 3d20 7365 6c66 2e67 6574 5f61 745f  y = self.get_at_
+0003a790: 706f 7369 7469 6f6e 2878 3d78 642c 2079  position(x=xd, y
+0003a7a0: 3d79 642c 2066 696c 7465 723d 6669 6c74  =yd, filter=filt
+0003a7b0: 6572 2c20 726f 7439 303d 726f 7439 3029  er, rot90=rot90)
+0003a7c0: 0a0a 2020 2020 2020 2020 7970 2c20 7870  ..        yp, xp
+0003a7d0: 203d 206e 702e 696e 6469 6365 7328 7368   = np.indices(sh
+0003a7e0: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+0003a7f0: 6e28 7073 665f 7061 7261 6d73 2920 3d3d  n(psf_params) ==
+0003a800: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+0003a810: 5f6f 626a 6675 6e20 3d20 7365 6c66 2e6f  _objfun = self.o
+0003a820: 626a 6563 7469 7665 5f65 7073 665f 6365  bjective_epsf_ce
+0003a830: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+0003a840: 2064 7820 3d20 7870 2d70 7366 5f70 6172   dx = xp-psf_par
+0003a850: 616d 735b 305d 2d78 300a 2020 2020 2020  ams[0]-x0.      
+0003a860: 2020 2020 2020 6479 203d 2079 702d 7073        dy = yp-ps
+0003a870: 665f 7061 7261 6d73 5b31 5d2d 7930 0a20  f_params[1]-y0. 
+0003a880: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003a890: 2020 2020 2020 2020 205f 6f62 6a66 756e           _objfun
+0003a8a0: 203d 2073 656c 662e 6f62 6a65 6374 6976   = self.objectiv
+0003a8b0: 655f 6570 7366 0a20 2020 2020 2020 2020  e_epsf.         
+0003a8c0: 2020 2064 7820 3d20 7870 2d70 7366 5f70     dx = xp-psf_p
+0003a8d0: 6172 616d 735b 315d 2d78 300a 2020 2020  arams[1]-x0.    
+0003a8e0: 2020 2020 2020 2020 6479 203d 2079 702d          dy = yp-
+0003a8f0: 7073 665f 7061 7261 6d73 5b32 5d2d 7930  psf_params[2]-y0
+0003a900: 0a0a 2020 2020 2020 2020 6966 2067 6574  ..        if get
+0003a910: 5f65 7874 656e 6465 643a 0a20 2020 2020  _extended:.     
+0003a920: 2020 2020 2020 2069 6620 6669 6c74 6572         if filter
+0003a930: 2069 6e20 7365 6c66 2e65 7874 656e 6465   in self.extende
+0003a940: 645f 6570 7366 3a0a 2020 2020 2020 2020  d_epsf:.        
+0003a950: 2020 2020 2020 2020 6578 7465 6e64 6564          extended
+0003a960: 5f64 6174 6120 3d20 7365 6c66 2e65 7874  _data = self.ext
+0003a970: 656e 6465 645f 6570 7366 5b66 696c 7465  ended_epsf[filte
+0003a980: 725d 0a20 2020 2020 2020 2020 2020 2065  r].            e
+0003a990: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003a9a0: 2020 2020 2065 7874 656e 6465 645f 6461       extended_da
+0003a9b0: 7461 203d 204e 6f6e 650a 2020 2020 2020  ta = None.      
+0003a9c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003a9d0: 2020 2020 6578 7465 6e64 6564 5f64 6174      extended_dat
+0003a9e0: 6120 3d20 4e6f 6e65 0a0a 2020 2020 2020  a = None..      
+0003a9f0: 2020 6966 2073 6369 2069 7320 6e6f 7420    if sci is not 
+0003aa00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003aa10: 2020 6976 6172 5f6d 6173 6b20 3d20 6e70    ivar_mask = np
+0003aa20: 2e6f 6e65 735f 6c69 6b65 2873 6369 290a  .ones_like(sci).
+0003aa30: 2020 2020 2020 2020 2020 2020 6976 6172              ivar
+0003aa40: 5f6d 6173 6b20 2a3d 2069 7661 720a 2020  _mask *= ivar.  
+0003aa50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003aa60: 2020 2020 2020 2020 7363 6920 3d20 6e70          sci = np
+0003aa70: 2e6f 6e65 7328 7368 2c20 6474 7970 653d  .ones(sh, dtype=
+0003aa80: 666c 6f61 7429 0a20 2020 2020 2020 2020  float).         
+0003aa90: 2020 2069 7661 725f 6d61 736b 203d 2073     ivar_mask = s
+0003aaa0: 6369 2a31 0a0a 2020 2020 2020 2020 6172  ci*1..        ar
+0003aab0: 6773 203d 2028 7365 6c66 2c20 7073 665f  gs = (self, psf_
+0003aac0: 7879 2c20 7363 692c 2069 7661 725f 6d61  xy, sci, ivar_ma
+0003aad0: 736b 2c20 7870 2d78 302c 2079 702d 7930  sk, xp-x0, yp-y0
+0003aae0: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
+0003aaf0: 2027 6d6f 6465 6c27 2c20 4e6f 6e65 290a   'model', None).
+0003ab00: 2020 2020 2020 2020 6f75 7470 7574 5f70          output_p
+0003ab10: 7366 2c20 626b 672c 205f 612c 205f 6220  sf, bkg, _a, _b 
+0003ab20: 3d20 5f6f 626a 6675 6e28 7073 665f 7061  = _objfun(psf_pa
+0003ab30: 7261 6d73 2c20 2a61 7267 7329 0a0a 2020  rams, *args)..  
+0003ab40: 2020 2020 2020 236f 7574 7075 745f 7073        #output_ps
+0003ab50: 6620 3d20 7365 6c66 2e65 7661 6c5f 6550  f = self.eval_eP
+0003ab60: 5346 2870 7366 5f78 792c 2064 782c 2064  SF(psf_xy, dx, d
+0003ab70: 792c 2065 7874 656e 6465 645f 6461 7461  y, extended_data
+0003ab80: 3d65 7874 656e 6465 645f 6461 7461 292a  =extended_data)*
+0003ab90: 7073 665f 7061 7261 6d73 5b30 5d0a 0a20  psf_params[0].. 
+0003aba0: 2020 2020 2020 2069 6620 6765 745f 6261         if get_ba
+0003abb0: 636b 6772 6f75 6e64 3a0a 2020 2020 2020  ckground:.      
+0003abc0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
+0003abd0: 7075 745f 7073 662c 2062 6b67 0a20 2020  put_psf, bkg.   
+0003abe0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003abf0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+0003ac00: 7470 7574 5f70 7366 0a0a 0a64 6566 2072  tput_psf...def r
+0003ac10: 6561 645f 6361 7461 6c6f 6728 6669 6c65  ead_catalog(file
+0003ac20: 2c20 7365 7874 7261 6374 6f72 3d46 616c  , sextractor=Fal
+0003ac30: 7365 2c20 666f 726d 6174 3d4e 6f6e 6529  se, format=None)
+0003ac40: 3a0a 2020 2020 2222 220a 2020 2020 5772  :.    """.    Wr
+0003ac50: 6170 7065 7220 6172 6f75 6e64 2060 7e67  apper around `~g
+0003ac60: 7269 7a6c 692e 7574 696c 732e 4774 6162  rizli.utils.Gtab
+0003ac70: 6c65 2e67 7265 6164 602e 0a0a 2020 2020  le.gread`...    
+0003ac80: 4175 746f 2d64 6574 6563 7473 2066 6f72  Auto-detects for
+0003ac90: 6d61 7473 2027 6373 7627 2061 6e64 2027  mats 'csv' and '
+0003aca0: 6669 7473 2720 616e 6420 6465 6661 756c  fits' and defaul
+0003acb0: 7473 2074 6f0a 2020 2020 2761 7363 6969  ts to.    'ascii
+0003acc0: 2e63 6f6d 6d65 6e74 6564 5f68 6561 6465  .commented_heade
+0003acd0: 7227 2e0a 2020 2020 2222 220a 2020 2020  r'..    """.    
+0003ace0: 7265 7475 726e 2047 5461 626c 652e 6772  return GTable.gr
+0003acf0: 6561 6428 6669 6c65 2c20 7365 7874 7261  ead(file, sextra
+0003ad00: 6374 6f72 3d73 6578 7472 6163 746f 722c  ctor=sextractor,
+0003ad10: 2066 6f72 6d61 743d 666f 726d 6174 290a   format=format).
+0003ad20: 0a0a 636c 6173 7320 4754 6162 6c65 2861  ..class GTable(a
+0003ad30: 7374 726f 7079 2e74 6162 6c65 2e54 6162  stropy.table.Tab
+0003ad40: 6c65 293a 0a20 2020 2022 2222 0a20 2020  le):.    """.   
+0003ad50: 2045 7874 656e 6420 607e 6173 7472 6f70   Extend `~astrop
+0003ad60: 792e 7461 626c 652e 5461 626c 6560 2063  y.table.Table` c
+0003ad70: 6c61 7373 2077 6974 6820 6d6f 7265 2061  lass with more a
+0003ad80: 7574 6f6d 6174 6963 2049 4f20 616e 6420  utomatic IO and 
+0003ad90: 6f74 6865 720a 2020 2020 6865 6c70 6572  other.    helper
+0003ada0: 206d 6574 686f 6473 2e0a 2020 2020 2222   methods..    ""
+0003adb0: 220a 2020 2020 4063 6c61 7373 6d65 7468  ".    @classmeth
+0003adc0: 6f64 0a20 2020 2064 6566 2067 7265 6164  od.    def gread
+0003add0: 2863 6c73 2c20 6669 6c65 2c20 7365 7874  (cls, file, sext
+0003ade0: 7261 6374 6f72 3d46 616c 7365 2c20 666f  ractor=False, fo
+0003adf0: 726d 6174 3d4e 6f6e 6529 3a0a 2020 2020  rmat=None):.    
+0003ae00: 2020 2020 2222 2241 7373 756d 6520 6061      """Assume `a
+0003ae10: 7363 6969 2e63 6f6d 6d65 6e74 6564 5f68  scii.commented_h
+0003ae20: 6561 6465 7260 2062 7920 6465 6661 756c  eader` by defaul
+0003ae30: 740a 0a20 2020 2020 2020 2050 6172 616d  t..        Param
+0003ae40: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
+0003ae50: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0003ae60: 2073 6578 7472 6163 746f 7220 3a20 626f   sextractor : bo
+0003ae70: 6f6c 0a20 2020 2020 2020 2020 2020 2055  ol.            U
+0003ae80: 7365 2060 666f 726d 6174 3d27 6173 6369  se `format='asci
+0003ae90: 692e 7365 7874 7261 6374 6f72 2760 2e0a  i.sextractor'`..
+0003aea0: 0a20 2020 2020 2020 2066 6f72 6d61 7420  .        format 
+0003aeb0: 3a20 4e6f 6e65 206f 7220 7374 720a 2020  : None or str.  
+0003aec0: 2020 2020 2020 2020 2020 4f76 6572 7269            Overri
+0003aed0: 6465 2066 6f72 6d61 7420 7061 7373 6564  de format passed
+0003aee0: 2074 6f20 607e 6173 7472 6f70 792e 7461   to `~astropy.ta
+0003aef0: 626c 652e 5461 626c 652e 7265 6164 602e  ble.Table.read`.
+0003af00: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0003af10: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0003af20: 2d0a 2020 2020 2020 2020 7461 6220 3a20  -.        tab : 
+0003af30: 607e 6173 7472 6f70 792e 7461 626c 652e  `~astropy.table.
+0003af40: 5461 626c 6560 0a20 2020 2020 2020 2020  Table`.         
+0003af50: 2020 2054 6162 6c65 206f 626a 6563 740a     Table object.
+0003af60: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003af70: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
+0003af80: 7079 2e75 6e69 7473 2061 7320 750a 0a20  py.units as u.. 
+0003af90: 2020 2020 2020 2069 6620 666f 726d 6174         if format
+0003afa0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003afb0: 2020 2020 2020 6966 2073 6578 7472 6163        if sextrac
+0003afc0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+0003afd0: 2020 2020 2066 6f72 6d61 7420 3d20 2761       format = 'a
+0003afe0: 7363 6969 2e73 6578 7472 6163 746f 7227  scii.sextractor'
+0003aff0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0003b000: 6620 6973 696e 7374 616e 6365 2866 696c  f isinstance(fil
+0003b010: 652c 2070 7966 6974 732e 4269 6e54 6162  e, pyfits.BinTab
+0003b020: 6c65 4844 5529 3a0a 2020 2020 2020 2020  leHDU):.        
+0003b030: 2020 2020 2020 2020 666f 726d 6174 203d          format =
+0003b040: 2027 6669 7473 270a 2020 2020 2020 2020   'fits'.        
+0003b050: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003b060: 2020 2020 2020 2020 2020 6966 2066 696c            if fil
+0003b070: 652e 656e 6473 7769 7468 2827 2e66 6974  e.endswith('.fit
+0003b080: 7327 293a 0a20 2020 2020 2020 2020 2020  s'):.           
+0003b090: 2020 2020 2020 2020 2066 6f72 6d61 7420           format 
+0003b0a0: 3d20 2766 6974 7327 0a20 2020 2020 2020  = 'fits'.       
+0003b0b0: 2020 2020 2020 2020 2065 6c69 6620 6669           elif fi
+0003b0c0: 6c65 2e65 6e64 7377 6974 6828 272e 6373  le.endswith('.cs
+0003b0d0: 7627 293a 0a20 2020 2020 2020 2020 2020  v'):.           
+0003b0e0: 2020 2020 2020 2020 2066 6f72 6d61 7420           format 
+0003b0f0: 3d20 2763 7376 270a 2020 2020 2020 2020  = 'csv'.        
+0003b100: 2020 2020 2020 2020 656c 6966 2066 696c          elif fil
+0003b110: 652e 656e 6473 7769 7468 2827 2e76 6f74  e.endswith('.vot
+0003b120: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0003b130: 2020 2020 2020 2020 666f 726d 6174 203d          format =
+0003b140: 2027 766f 7461 626c 6527 0a20 2020 2020   'votable'.     
+0003b150: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003b160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b170: 2020 2020 2066 6f72 6d61 7420 3d20 2761       format = 'a
+0003b180: 7363 6969 2e63 6f6d 6d65 6e74 6564 5f68  scii.commented_h
+0003b190: 6561 6465 7227 0a0a 2020 2020 2020 2020  eader'..        
+0003b1a0: 2370 7269 6e74 2866 696c 652c 2066 6f72  #print(file, for
+0003b1b0: 6d61 7429 0a20 2020 2020 2020 2074 6162  mat).        tab
+0003b1c0: 203d 2063 6c73 2e72 6561 6428 6669 6c65   = cls.read(file
+0003b1d0: 2c20 666f 726d 6174 3d66 6f72 6d61 7429  , format=format)
+0003b1e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0003b1f0: 2074 6162 0a0a 2020 2020 6465 6620 6777   tab..    def gw
+0003b200: 7269 7465 2873 656c 662c 206f 7574 7075  rite(self, outpu
+0003b210: 742c 2066 6f72 6d61 743d 2761 7363 6969  t, format='ascii
+0003b220: 2e63 6f6d 6d65 6e74 6564 5f68 6561 6465  .commented_heade
+0003b230: 7227 293a 0a20 2020 2020 2020 2022 2222  r'):.        """
+0003b240: 4173 7375 6d65 2061 2066 6f72 6d61 7420  Assume a format 
+0003b250: 666f 7220 7468 6520 6f75 7470 7574 2074  for the output t
+0003b260: 6162 6c65 0a0a 2020 2020 2020 2020 5061  able..        Pa
+0003b270: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+0003b280: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0003b290: 2020 2020 6f75 7470 7574 203a 2073 7472      output : str
+0003b2a0: 0a20 2020 2020 2020 2020 2020 204f 7574  .            Out
+0003b2b0: 7075 7420 6669 6c65 6e61 6d65 0a0a 2020  put filename..  
+0003b2c0: 2020 2020 2020 666f 726d 6174 203a 2073        format : s
+0003b2d0: 7472 0a20 2020 2020 2020 2020 2020 2046  tr.            F
+0003b2e0: 6f72 6d61 7420 7374 7269 6e67 2070 6173  ormat string pas
+0003b2f0: 7365 6420 746f 2060 7e61 7374 726f 7079  sed to `~astropy
+0003b300: 2e74 6162 6c65 2e54 6162 6c65 2e77 7269  .table.Table.wri
+0003b310: 7465 602e 0a0a 2020 2020 2020 2020 2222  te`...        ""
+0003b320: 220a 2020 2020 2020 2020 7365 6c66 2e77  ".        self.w
+0003b330: 7269 7465 286f 7574 7075 742c 2066 6f72  rite(output, for
+0003b340: 6d61 743d 666f 726d 6174 290a 0a20 2020  mat=format)..   
+0003b350: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0003b360: 2020 2064 6566 2070 6172 7365 5f72 6164     def parse_rad
+0003b370: 6563 5f63 6f6c 756d 6e73 2873 656c 662c  ec_columns(self,
+0003b380: 2072 645f 7061 6972 733d 4e6f 6e65 293a   rd_pairs=None):
+0003b390: 0a20 2020 2020 2020 2022 2222 5061 7273  .        """Pars
+0003b3a0: 6520 636f 6c75 6d6e 206e 616d 6573 2066  e column names f
+0003b3b0: 6f72 2052 412f 4465 6320 616e 6420 7365  or RA/Dec and se
+0003b3c0: 7420 746f 2060 7e61 7374 726f 7079 2e75  t to `~astropy.u
+0003b3d0: 6e69 7473 2e64 6567 7265 6560 2075 6e69  nits.degree` uni
+0003b3e0: 7473 2069 6620 6e6f 7420 616c 7265 6164  ts if not alread
+0003b3f0: 7920 7365 740a 0a20 2020 2020 2020 2050  y set..        P
+0003b400: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+0003b410: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0003b420: 2020 2020 2072 645f 7061 6972 7320 3a20       rd_pairs : 
+0003b430: 607e 636f 6c6c 6563 7469 6f6e 732e 4f72  `~collections.Or
+0003b440: 6465 7265 6444 6963 7460 206f 7220 4e6f  deredDict` or No
+0003b450: 6e65 0a20 2020 2020 2020 2020 2020 2050  ne.            P
+0003b460: 6169 7273 206f 6620 7b72 613a 6465 637d  airs of {ra:dec}
+0003b470: 206e 616d 6573 2074 6f20 7365 6172 6368   names to search
+0003b480: 2069 6e20 7468 6520 636f 6c75 6d6e 206c   in the column l
+0003b490: 6973 742e 2049 6620 4e6f 6e65 2c0a 2020  ist. If None,.  
+0003b4a0: 2020 2020 2020 2020 2020 7468 656e 2075            then u
+0003b4b0: 7365 7320 7468 6520 666f 6c6c 6f77 696e  ses the followin
+0003b4c0: 6720 6279 2064 6566 6175 6c74 2e0a 0a20  g by default... 
+0003b4d0: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+0003b4e0: 3e3e 2072 645f 7061 6972 7320 3d20 4f72  >> rd_pairs = Or
+0003b4f0: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
+0003b500: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+0003b510: 7264 5f70 6169 7273 5b27 7261 275d 203d  rd_pairs['ra'] =
+0003b520: 2027 6465 6327 0a20 2020 2020 2020 2020   'dec'.         
+0003b530: 2020 2020 2020 203e 3e3e 2072 645f 7061         >>> rd_pa
+0003b540: 6972 735b 2741 4c50 4841 5f4a 3230 3030  irs['ALPHA_J2000
+0003b550: 275d 203d 2027 4445 4c54 415f 4a32 3030  '] = 'DELTA_J200
+0003b560: 3027 0a20 2020 2020 2020 2020 2020 2020  0'.             
+0003b570: 2020 203e 3e3e 2072 645f 7061 6972 735b     >>> rd_pairs[
+0003b580: 2758 5f57 4f52 4c44 275d 203d 2027 595f  'X_WORLD'] = 'Y_
+0003b590: 574f 524c 4427 0a0a 2020 2020 2020 2020  WORLD'..        
+0003b5a0: 2020 2020 4e42 3a20 7365 6172 6368 2069      NB: search i
+0003b5b0: 7320 7065 7266 6f72 6d65 6420 696e 206f  s performed in o
+0003b5c0: 7264 6572 206f 6620 6060 7264 5f70 6169  rder of ``rd_pai
+0003b5d0: 7273 2e6b 6579 7328 2960 6020 616e 6420  rs.keys()`` and 
+0003b5e0: 7374 6f70 730a 2020 2020 2020 2020 2020  stops.          
+0003b5f0: 2020 6966 2f77 6865 6e20 6120 6d61 7463    if/when a matc
+0003b600: 6820 6973 2066 6f75 6e64 2e0a 0a20 2020  h is found...   
+0003b610: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+0003b620: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+0003b630: 2020 2020 2072 645f 7061 6972 203a 205b       rd_pair : [
+0003b640: 7374 722c 2073 7472 5d0a 2020 2020 2020  str, str].      
+0003b650: 2020 2020 2020 436f 6c75 6d6e 206e 616d        Column nam
+0003b660: 6573 2061 7373 6f63 6961 7465 6420 7769  es associated wi
+0003b670: 7468 2052 412f 4465 632e 2020 5265 7475  th RA/Dec.  Retu
+0003b680: 726e 7320 4661 6c73 6520 6966 206e 6f20  rns False if no 
+0003b690: 636f 6c75 6d6e 0a20 2020 2020 2020 2020  column.         
+0003b6a0: 2020 2070 6169 7273 2066 6f75 6e64 2062     pairs found b
+0003b6b0: 6173 6564 206f 6e20 6072 645f 7061 6972  ased on `rd_pair
+0003b6c0: 7360 2e0a 0a20 2020 2020 2020 2022 2222  s`...        """
+0003b6d0: 0a20 2020 2020 2020 2066 726f 6d20 636f  .        from co
+0003b6e0: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
+0003b6f0: 204f 7264 6572 6564 4469 6374 0a20 2020   OrderedDict.   
+0003b700: 2020 2020 2069 6d70 6f72 7420 6173 7472       import astr
+0003b710: 6f70 792e 756e 6974 7320 6173 2075 0a0a  opy.units as u..
+0003b720: 2020 2020 2020 2020 6966 2072 645f 7061          if rd_pa
+0003b730: 6972 7320 6973 204e 6f6e 653a 0a20 2020  irs is None:.   
+0003b740: 2020 2020 2020 2020 2072 645f 7061 6972           rd_pair
+0003b750: 7320 3d20 4f72 6465 7265 6444 6963 7428  s = OrderedDict(
+0003b760: 290a 2020 2020 2020 2020 2020 2020 7264  ).            rd
+0003b770: 5f70 6169 7273 5b27 5241 275d 203d 2027  _pairs['RA'] = '
+0003b780: 4445 4327 0a20 2020 2020 2020 2020 2020  DEC'.           
+0003b790: 2072 645f 7061 6972 735b 2741 4c50 4841   rd_pairs['ALPHA
+0003b7a0: 5f4a 3230 3030 275d 203d 2027 4445 4c54  _J2000'] = 'DELT
+0003b7b0: 415f 4a32 3030 3027 0a20 2020 2020 2020  A_J2000'.       
+0003b7c0: 2020 2020 2072 645f 7061 6972 735b 2758       rd_pairs['X
+0003b7d0: 5f57 4f52 4c44 275d 203d 2027 595f 574f  _WORLD'] = 'Y_WO
+0003b7e0: 524c 4427 0a20 2020 2020 2020 2020 2020  RLD'.           
+0003b7f0: 2072 645f 7061 6972 735b 2741 4c50 4841   rd_pairs['ALPHA
+0003b800: 5f53 4b59 275d 203d 2027 4445 4c54 415f  _SKY'] = 'DELTA_
+0003b810: 534b 5927 0a20 2020 2020 2020 2020 2020  SKY'.           
+0003b820: 2072 645f 7061 6972 735b 275f 5241 4a32   rd_pairs['_RAJ2
+0003b830: 3030 3027 5d20 3d20 275f 4445 4a32 3030  000'] = '_DEJ200
+0003b840: 3027 0a0a 2020 2020 2020 2020 2020 2020  0'..            
+0003b850: 666f 7220 6b20 696e 206c 6973 7428 7264  for k in list(rd
+0003b860: 5f70 6169 7273 2e6b 6579 7328 2929 3a0a  _pairs.keys()):.
+0003b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b880: 7264 5f70 6169 7273 5b6b 2e6c 6f77 6572  rd_pairs[k.lower
+0003b890: 2829 5d20 3d20 7264 5f70 6169 7273 5b6b  ()] = rd_pairs[k
+0003b8a0: 5d2e 6c6f 7765 7228 290a 0a20 2020 2020  ].lower()..     
+0003b8b0: 2020 2072 645f 7061 6972 203d 204e 6f6e     rd_pair = Non
+0003b8c0: 650a 2020 2020 2020 2020 666f 7220 6320  e.        for c 
+0003b8d0: 696e 2072 645f 7061 6972 733a 0a20 2020  in rd_pairs:.   
+0003b8e0: 2020 2020 2020 2020 2069 6620 6320 696e           if c in
+0003b8f0: 2073 656c 662e 636f 6c6e 616d 6573 3a0a   self.colnames:.
+0003b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b910: 7264 5f70 6169 7220 3d20 5b63 2c20 7264  rd_pair = [c, rd
+0003b920: 5f70 6169 7273 5b63 5d5d 0a20 2020 2020  _pairs[c]].     
+0003b930: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003b940: 0a0a 2020 2020 2020 2020 6966 2072 645f  ..        if rd_
+0003b950: 7061 6972 2069 7320 4e6f 6e65 3a0a 2020  pair is None:.  
+0003b960: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
+0003b970: 2827 4e6f 2052 412f 4465 632e 2063 6f6c  ('No RA/Dec. col
+0003b980: 756d 6e73 2066 6f75 6e64 2069 6e20 696e  umns found in in
+0003b990: 7075 7420 7461 626c 652e 2729 0a20 2020  put table.').   
+0003b9a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003b9b0: 4661 6c73 650a 0a20 2020 2020 2020 2066  False..        f
+0003b9c0: 6f72 2063 2069 6e20 7264 5f70 6169 723a  or c in rd_pair:
+0003b9d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003b9e0: 7365 6c66 5b63 5d2e 756e 6974 2069 7320  self[c].unit is 
+0003b9f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003ba00: 2020 2020 2020 7365 6c66 5b63 5d2e 756e        self[c].un
+0003ba10: 6974 203d 2075 2e64 6567 7265 650a 0a20  it = u.degree.. 
+0003ba20: 2020 2020 2020 2072 6574 7572 6e20 7264         return rd
+0003ba30: 5f70 6169 720a 0a20 2020 2064 6566 206d  _pair..    def m
+0003ba40: 6174 6368 5f74 6f5f 6361 7461 6c6f 675f  atch_to_catalog_
+0003ba50: 736b 7928 7365 6c66 2c20 6f74 6865 722c  sky(self, other,
+0003ba60: 2073 656c 665f 7261 6465 633d 4e6f 6e65   self_radec=None
+0003ba70: 2c20 6f74 6865 725f 7261 6465 633d 4e6f  , other_radec=No
+0003ba80: 6e65 2c20 6e74 686e 6569 6768 626f 723d  ne, nthneighbor=
+0003ba90: 312c 2067 6574 5f32 645f 6f66 6673 6574  1, get_2d_offset
+0003baa0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+0003bab0: 2022 2222 436f 6d70 7574 6520 607e 6173   """Compute `~as
+0003bac0: 7472 6f70 792e 636f 6f72 6469 6e61 7465  tropy.coordinate
+0003bad0: 732e 536b 7943 6f6f 7264 6020 7072 6f6a  s.SkyCoord` proj
+0003bae0: 6563 7465 6420 6d61 7463 6865 7320 6265  ected matches be
+0003baf0: 7477 6565 6e20 7477 6f20 6047 5461 626c  tween two `GTabl
+0003bb00: 6560 2074 6162 6c65 732e 0a0a 2020 2020  e` tables...    
+0003bb10: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+0003bb20: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+0003bb30: 2d0a 2020 2020 2020 2020 6f74 6865 7220  -.        other 
+0003bb40: 3a20 607e 6173 7472 6f70 792e 7461 626c  : `~astropy.tabl
+0003bb50: 652e 5461 626c 6560 2c20 6047 5461 626c  e.Table`, `GTabl
+0003bb60: 6560 2c20 6f72 2060 6c69 7374 602e 0a20  e`, or `list`.. 
+0003bb70: 2020 2020 2020 2020 2020 204f 7468 6572             Other
+0003bb80: 2074 6162 6c65 2074 6f20 6d61 7463 6820   table to match 
+0003bb90: 706f 7369 7469 6f6e 7320 6672 6f6d 2e0a  positions from..
+0003bba0: 0a20 2020 2020 2020 2073 656c 665f 7261  .        self_ra
+0003bbb0: 6465 632c 206f 7468 6572 5f72 6164 6563  dec, other_radec
+0003bbc0: 203a 204e 6f6e 6520 6f72 205b 7374 722c   : None or [str,
+0003bbd0: 2073 7472 5d0a 2020 2020 2020 2020 2020   str].          
+0003bbe0: 2020 436f 6c75 6d6e 206e 616d 6573 2066    Column names f
+0003bbf0: 6f72 2052 4120 616e 6420 4465 632e 2020  or RA and Dec.  
+0003bc00: 4966 204e 6f6e 652c 2074 6865 6e20 7472  If None, then tr
+0003bc10: 7920 7468 6520 666f 6c6c 6f77 696e 670a  y the following.
+0003bc20: 2020 2020 2020 2020 2020 2020 7061 6972              pair
+0003bc30: 7320 2869 6e20 7468 6973 206f 7264 6572  s (in this order
+0003bc40: 293a 0a0a 2020 2020 2020 2020 2020 2020  ):..            
+0003bc50: 2020 2020 3e3e 3e20 7264 5f70 6169 7273      >>> rd_pairs
+0003bc60: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
+0003bc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bc80: 203e 3e3e 2072 645f 7061 6972 735b 2772   >>> rd_pairs['r
+0003bc90: 6127 5d20 3d20 2764 6563 270a 2020 2020  a'] = 'dec'.    
+0003bca0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+0003bcb0: 7264 5f70 6169 7273 5b27 414c 5048 415f  rd_pairs['ALPHA_
+0003bcc0: 4a32 3030 3027 5d20 3d20 2744 454c 5441  J2000'] = 'DELTA
+0003bcd0: 5f4a 3230 3030 270a 2020 2020 2020 2020  _J2000'.        
+0003bce0: 2020 2020 2020 2020 3e3e 3e20 7264 5f70          >>> rd_p
+0003bcf0: 6169 7273 5b27 585f 574f 524c 4427 5d20  airs['X_WORLD'] 
+0003bd00: 3d20 2759 5f57 4f52 4c44 270a 0a20 2020  = 'Y_WORLD'..   
+0003bd10: 2020 2020 206e 7468 6e65 6967 6862 6f72       nthneighbor
+0003bd20: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
+0003bd30: 2020 2053 6565 2060 7e61 7374 726f 7079     See `~astropy
+0003bd40: 2e63 6f6f 7264 696e 6174 6573 2e53 6b79  .coordinates.Sky
+0003bd50: 436f 6f72 642e 636f 6f2e 6d61 7463 685f  Coord.coo.match_
+0003bd60: 746f 5f63 6174 616c 6f67 5f73 6b79 602e  to_catalog_sky`.
+0003bd70: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0003bd80: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0003bd90: 2d0a 2020 2020 2020 2020 6964 7820 3a20  -.        idx : 
+0003bda0: 696e 7420 6172 7261 790a 2020 2020 2020  int array.      
+0003bdb0: 2020 2020 2020 496e 6469 6365 7320 6f66        Indices of
+0003bdc0: 2074 6865 206d 6174 6368 6573 2061 7320   the matches as 
+0003bdd0: 696e 0a0a 2020 2020 2020 2020 2020 2020  in..            
+0003bde0: 2020 2020 3e3e 3e20 6d61 7463 6865 6420      >>> matched 
+0003bdf0: 3d20 7365 6c66 5b69 6478 5d0a 2020 2020  = self[idx].    
+0003be00: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+0003be10: 6c65 6e28 6d61 7463 6865 6429 203d 3d20  len(matched) == 
+0003be20: 6c65 6e28 6f74 6865 7229 0a0a 2020 2020  len(other)..    
+0003be30: 2020 2020 6472 203a 2066 6c6f 6174 2061      dr : float a
+0003be40: 7272 6179 0a20 2020 2020 2020 2020 2020  rray.           
+0003be50: 2050 726f 6a65 6374 6564 2073 6570 6172   Projected separ
+0003be60: 6174 696f 6e20 6f66 2063 6c6f 7365 7374  ation of closest
+0003be70: 206d 6174 6368 2e0a 0a20 2020 2020 2020   match...       
+0003be80: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
+0003be90: 2020 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020    --------..    
+0003bea0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+0003beb0: 696d 706f 7274 2061 7374 726f 7079 2e75  import astropy.u
+0003bec0: 6e69 7473 2061 7320 750a 0a20 2020 2020  nits as u..     
+0003bed0: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
+0003bee0: 6566 203d 2047 5461 626c 652e 6772 6561  ef = GTable.grea
+0003bef0: 6428 2769 6e70 7574 2e63 6174 2729 0a20  d('input.cat'). 
+0003bf00: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+0003bf10: 3e3e 2067 6169 6120 3d20 4754 6162 6c65  >> gaia = GTable
+0003bf20: 2e67 7265 6164 2827 6761 6961 2e63 6174  .gread('gaia.cat
+0003bf30: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0003bf40: 2020 203e 3e3e 2069 6478 2c20 6472 203d     >>> idx, dr =
+0003bf50: 2072 6566 2e6d 6174 6368 5f74 6f5f 6361   ref.match_to_ca
+0003bf60: 7461 6c6f 675f 736b 7928 6761 6961 290a  talog_sky(gaia).
+0003bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf80: 3e3e 3e20 636c 6f73 6520 3d20 6472 203c  >>> close = dr <
+0003bf90: 2031 2a75 2e61 7263 7365 630a 0a20 2020   1*u.arcsec..   
+0003bfa0: 2020 2020 2020 2020 2020 2020 203e 3e3e               >>>
+0003bfb0: 2072 6566 5f6d 6174 6368 203d 2072 6566   ref_match = ref
+0003bfc0: 5b69 6478 5d5b 636c 6f73 655d 0a20 2020  [idx][close].   
+0003bfd0: 2020 2020 2020 2020 2020 2020 203e 3e3e               >>>
+0003bfe0: 2067 6169 615f 6d61 7463 6820 3d20 6761   gaia_match = ga
+0003bff0: 6961 5b63 6c6f 7365 5d0a 0a20 2020 2020  ia[close]..     
+0003c000: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+0003c010: 726f 6d20 6173 7472 6f70 792e 636f 6f72  rom astropy.coor
+0003c020: 6469 6e61 7465 7320 696d 706f 7274 2053  dinates import S
+0003c030: 6b79 436f 6f72 640a 0a20 2020 2020 2020  kyCoord..       
+0003c040: 2069 6620 7365 6c66 5f72 6164 6563 2069   if self_radec i
+0003c050: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003c060: 2020 2020 7264 203d 2073 656c 662e 7061      rd = self.pa
+0003c070: 7273 655f 7261 6465 635f 636f 6c75 6d6e  rse_radec_column
+0003c080: 7328 7365 6c66 290a 2020 2020 2020 2020  s(self).        
+0003c090: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003c0a0: 2020 7264 203d 2073 656c 662e 7061 7273    rd = self.pars
+0003c0b0: 655f 7261 6465 635f 636f 6c75 6d6e 7328  e_radec_columns(
+0003c0c0: 7365 6c66 2c20 7264 5f70 6169 7273 3d7b  self, rd_pairs={
+0003c0d0: 7365 6c66 5f72 6164 6563 5b30 5d3a 2073  self_radec[0]: s
+0003c0e0: 656c 665f 7261 6465 635b 315d 7d29 0a0a  elf_radec[1]})..
+0003c0f0: 2020 2020 2020 2020 6966 2072 6420 6973          if rd is
+0003c100: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+0003c110: 2020 2020 7072 696e 7428 274e 6f20 5241      print('No RA
+0003c120: 2f44 6563 2e20 636f 6c75 6d6e 7320 666f  /Dec. columns fo
+0003c130: 756e 6420 696e 2069 6e70 7574 2074 6162  und in input tab
+0003c140: 6c65 2e27 290a 2020 2020 2020 2020 2020  le.').          
+0003c150: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+0003c160: 2020 2020 2020 2020 7365 6c66 5f63 6f6f          self_coo
+0003c170: 203d 2053 6b79 436f 6f72 6428 7261 3d73   = SkyCoord(ra=s
+0003c180: 656c 665b 7264 5b30 5d5d 2c20 6465 633d  elf[rd[0]], dec=
+0003c190: 7365 6c66 5b72 645b 315d 5d2c 200a 2020  self[rd[1]], .  
+0003c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c1b0: 2020 2020 2020 2020 2020 6672 616d 653d            frame=
+0003c1c0: 2769 6372 7327 290a 0a20 2020 2020 2020  'icrs')..       
+0003c1d0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+0003c1e0: 7468 6572 2c20 6c69 7374 2920 7c20 6973  ther, list) | is
+0003c1f0: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+0003c200: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
+0003c210: 2020 2020 7264 203d 205b 736c 6963 6528      rd = [slice(
+0003c220: 302c 2031 292c 2073 6c69 6365 2831 2c20  0, 1), slice(1, 
+0003c230: 3229 5d0a 0a20 2020 2020 2020 2065 6c73  2)]..        els
+0003c240: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0003c250: 6620 6f74 6865 725f 7261 6465 6320 6973  f other_radec is
+0003c260: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003c270: 2020 2020 2020 2072 6420 3d20 7365 6c66         rd = self
+0003c280: 2e70 6172 7365 5f72 6164 6563 5f63 6f6c  .parse_radec_col
+0003c290: 756d 6e73 286f 7468 6572 290a 2020 2020  umns(other).    
+0003c2a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003c2b0: 2020 2020 2020 2020 2020 2020 2020 7264                rd
+0003c2c0: 203d 2073 656c 662e 7061 7273 655f 7261   = self.parse_ra
+0003c2d0: 6465 635f 636f 6c75 6d6e 7328 6f74 6865  dec_columns(othe
+0003c2e0: 722c 2072 645f 7061 6972 733d 7b6f 7468  r, rd_pairs={oth
+0003c2f0: 6572 5f72 6164 6563 5b30 5d3a 206f 7468  er_radec[0]: oth
+0003c300: 6572 5f72 6164 6563 5b31 5d7d 290a 0a20  er_radec[1]}).. 
+0003c310: 2020 2020 2020 2020 2020 2069 6620 7264             if rd
+0003c320: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
+0003c330: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0003c340: 2827 4e6f 2052 412f 4465 632e 2063 6f6c  ('No RA/Dec. col
+0003c350: 756d 6e73 2066 6f75 6e64 2069 6e20 606f  umns found in `o
+0003c360: 7468 6572 6020 7461 626c 652e 2729 0a20  ther` table.'). 
+0003c370: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003c380: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+0003c390: 2020 2020 206f 7468 6572 5f63 6f6f 203d       other_coo =
+0003c3a0: 2053 6b79 436f 6f72 6428 7261 3d6f 7468   SkyCoord(ra=oth
+0003c3b0: 6572 5b72 645b 305d 5d2c 2064 6563 3d6f  er[rd[0]], dec=o
+0003c3c0: 7468 6572 5b72 645b 315d 5d2c 0a20 2020  ther[rd[1]],.   
+0003c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c3e0: 2020 2020 2020 2020 2020 6672 616d 653d            frame=
+0003c3f0: 2769 6372 7327 290a 0a20 2020 2020 2020  'icrs')..       
+0003c400: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0003c410: 2020 6964 782c 2064 3264 2c20 6433 6420    idx, d2d, d3d 
+0003c420: 3d20 6f74 6865 725f 636f 6f2e 6d61 7463  = other_coo.matc
+0003c430: 685f 746f 5f63 6174 616c 6f67 5f73 6b79  h_to_catalog_sky
+0003c440: 2873 656c 665f 636f 6f2c 206e 7468 6e65  (self_coo, nthne
+0003c450: 6967 6862 6f72 3d6e 7468 6e65 6967 6862  ighbor=nthneighb
+0003c460: 6f72 290a 2020 2020 2020 2020 6578 6365  or).        exce
+0003c470: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+0003c480: 7072 696e 7428 2743 6f75 6c64 6e5c 2774  print('Couldn\'t
+0003c490: 2072 756e 2053 6b79 436f 6f72 642e 6d61   run SkyCoord.ma
+0003c4a0: 7463 685f 746f 5f63 6174 616c 6f67 5f73  tch_to_catalog_s
+0003c4b0: 6b79 2077 6974 6827 0a20 2020 2020 2020  ky with'.       
+0003c4c0: 2020 2020 2020 2020 2020 2027 6e74 686e             'nthn
+0003c4d0: 6569 6768 626f 7227 290a 0a20 2020 2020  eighbor')..     
+0003c4e0: 2020 2020 2020 2069 6478 2c20 6432 642c         idx, d2d,
+0003c4f0: 2064 3364 203d 206f 7468 6572 5f63 6f6f   d3d = other_coo
+0003c500: 2e6d 6174 6368 5f74 6f5f 6361 7461 6c6f  .match_to_catalo
+0003c510: 675f 736b 7928 7365 6c66 5f63 6f6f 290a  g_sky(self_coo).
+0003c520: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0003c530: 2069 6620 6765 745f 3264 5f6f 6666 7365   if get_2d_offse
+0003c540: 743a 0a20 2020 2020 2020 2020 2020 2063  t:.            c
+0003c550: 6f73 6420 3d20 6e70 2e63 6f73 2873 656c  osd = np.cos(sel
+0003c560: 665f 636f 6f2e 6465 632e 6465 672f 3138  f_coo.dec.deg/18
+0003c570: 302a 6e70 2e70 6929 0a20 2020 2020 2020  0*np.pi).       
+0003c580: 2020 2020 2064 7261 203d 2028 6f74 6865       dra = (othe
+0003c590: 725f 636f 6f2e 7261 2e64 6567 202d 2073  r_coo.ra.deg - s
+0003c5a0: 656c 665f 636f 6f2e 7261 2e64 6567 5b69  elf_coo.ra.deg[i
+0003c5b0: 6478 5d29 2a63 6f73 645b 6964 785d 0a20  dx])*cosd[idx]. 
+0003c5c0: 2020 2020 2020 2020 2020 2064 6465 203d             dde =
+0003c5d0: 2028 6f74 6865 725f 636f 6f2e 6465 632e   (other_coo.dec.
+0003c5e0: 6465 6720 2d20 7365 6c66 5f63 6f6f 2e64  deg - self_coo.d
+0003c5f0: 6563 2e64 6567 5b69 6478 5d29 0a20 2020  ec.deg[idx]).   
+0003c600: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003c610: 6964 782c 2064 3264 2e74 6f28 752e 6172  idx, d2d.to(u.ar
+0003c620: 6373 6563 292c 2064 7261 2a33 3630 302a  csec), dra*3600*
+0003c630: 752e 6172 6373 6563 2c20 6464 652a 3336  u.arcsec, dde*36
+0003c640: 3030 2a75 2e61 7263 7365 630a 2020 2020  00*u.arcsec.    
+0003c650: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003c660: 2020 2020 2020 7265 7475 726e 2069 6478        return idx
+0003c670: 2c20 6432 642e 746f 2875 2e61 7263 7365  , d2d.to(u.arcse
+0003c680: 6329 0a0a 2020 2020 6465 6620 6d61 7463  c)..    def matc
+0003c690: 685f 7472 6961 6e67 6c65 7328 7365 6c66  h_triangles(self
+0003c6a0: 2c20 6f74 6865 722c 2073 656c 665f 7763  , other, self_wc
+0003c6b0: 733d 4e6f 6e65 2c20 785f 636f 6c75 6d6e  s=None, x_column
+0003c6c0: 3d27 585f 494d 4147 4527 2c20 795f 636f  ='X_IMAGE', y_co
+0003c6d0: 6c75 6d6e 3d27 595f 494d 4147 4527 2c20  lumn='Y_IMAGE', 
+0003c6e0: 6d61 675f 636f 6c75 6d6e 3d27 4d41 475f  mag_column='MAG_
+0003c6f0: 4155 544f 272c 206f 7468 6572 5f72 613d  AUTO', other_ra=
+0003c700: 2758 5f57 4f52 4c44 272c 206f 7468 6572  'X_WORLD', other
+0003c710: 5f64 6563 3d27 595f 574f 524c 4427 2c20  _dec='Y_WORLD', 
+0003c720: 7069 7865 6c5f 696e 6465 783d 312c 206d  pixel_index=1, m
+0003c730: 6174 6368 5f6b 7761 7267 733d 7b7d 2c20  atch_kwargs={}, 
+0003c740: 7061 643d 3130 302c 2073 686f 775f 6469  pad=100, show_di
+0003c750: 6167 6e6f 7374 6963 3d46 616c 7365 2c20  agnostic=False, 
+0003c760: 6175 746f 5f6b 6565 703d 332c 206d 6178  auto_keep=3, max
+0003c770: 4b65 6570 3d31 302c 2061 7574 6f5f 6c69  Keep=10, auto_li
+0003c780: 6d69 743d 332c 2062 615f 6d61 783d 302e  mit=3, ba_max=0.
+0003c790: 3939 2c20 7363 616c 655f 6465 6e73 6974  99, scale_densit
+0003c7a0: 793d 3130 293a 0a20 2020 2020 2020 2022  y=10):.        "
+0003c7b0: 2222 0a0a 2020 2020 2020 2020 785f 636f  ""..        x_co
+0003c7c0: 6c75 6d6e 203d 2027 585f 494d 4147 4527  lumn = 'X_IMAGE'
+0003c7d0: 0a20 2020 2020 2020 2079 5f63 6f6c 756d  .        y_colum
+0003c7e0: 6e20 3d20 2759 5f49 4d41 4745 270a 2020  n = 'Y_IMAGE'.  
+0003c7f0: 2020 2020 2020 6d61 675f 636f 6c75 6d6e        mag_column
+0003c800: 203d 2027 4d41 475f 4155 544f 270a 2020   = 'MAG_AUTO'.  
+0003c810: 2020 2020 2020 7069 7865 6c5f 696e 6465        pixel_inde
+0003c820: 783d 310a 2020 2020 2020 2020 7061 643d  x=1.        pad=
+0003c830: 3130 300a 0a20 2020 2020 2020 2061 7574  100..        aut
+0003c840: 6f5f 6b65 6570 3d33 0a20 2020 2020 2020  o_keep=3.       
+0003c850: 206d 6178 4b65 6570 3d31 300a 2020 2020   maxKeep=10.    
+0003c860: 2020 2020 6175 746f 5f6c 696d 6974 3d33      auto_limit=3
+0003c870: 0a20 2020 2020 2020 2062 615f 6d61 7820  .        ba_max 
+0003c880: 3d20 302e 3939 0a0a 2020 2020 2020 2020  = 0.99..        
+0003c890: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
+0003c8a0: 2074 7269 7374 6172 7320 696d 706f 7274   tristars import
+0003c8b0: 206d 6174 6368 0a0a 2020 2020 2020 2020   match..        
+0003c8c0: 6966 2068 6173 6174 7472 286f 7468 6572  if hasattr(other
+0003c8d0: 2c20 2773 6861 7065 2729 3a0a 2020 2020  , 'shape'):.    
+0003c8e0: 2020 2020 2020 2020 6f74 6865 725f 7261          other_ra
+0003c8f0: 6465 6320 3d20 6f74 6865 722a 312e 0a20  dec = other*1.. 
+0003c900: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003c910: 2020 2020 2020 2020 206f 7468 6572 5f72           other_r
+0003c920: 6164 6563 203d 206e 702e 6172 7261 7928  adec = np.array(
+0003c930: 5b6f 7468 6572 5b6f 7468 6572 5f72 615d  [other[other_ra]
+0003c940: 2c20 6f74 6865 725b 6f74 6865 725f 6465  , other[other_de
+0003c950: 635d 5d29 2e54 0a0a 2020 2020 2020 2020  c]]).T..        
+0003c960: 7365 6c66 5f78 7920 3d20 6e70 2e61 7272  self_xy = np.arr
+0003c970: 6179 285b 7365 6c66 5b78 5f63 6f6c 756d  ay([self[x_colum
+0003c980: 6e5d 2c20 7365 6c66 5b79 5f63 6f6c 756d  n], self[y_colum
+0003c990: 6e5d 5d29 2e54 0a0a 2020 2020 2020 2020  n]]).T..        
+0003c9a0: 2378 795f 6472 7a20 3d20 6e70 2e61 7272  #xy_drz = np.arr
+0003c9b0: 6179 285b 6361 745b 2758 5f49 4d41 4745  ay([cat['X_IMAGE
+0003c9c0: 275d 5b6f 6b5d 2c20 6361 745b 2759 5f49  '][ok], cat['Y_I
+0003c9d0: 4d41 4745 275d 5b6f 6b5d 5d29 2e54 0a0a  MAGE'][ok]]).T..
+0003c9e0: 2020 2020 2020 2020 6966 2073 656c 665f          if self_
+0003c9f0: 7763 7320 6973 204e 6f6e 653a 0a20 2020  wcs is None:.   
+0003ca00: 2020 2020 2020 2020 206f 7468 6572 5f78           other_x
+0003ca10: 7920 3d20 6f74 6865 725f 7261 6465 630a  y = other_radec.
+0003ca20: 2020 2020 2020 2020 2020 2020 6375 7420              cut 
+0003ca30: 3d20 286f 7468 6572 5f78 795b 3a2c 2030  = (other_xy[:, 0
+0003ca40: 5d20 3e20 2d70 6164 2920 2620 286f 7468  ] > -pad) & (oth
+0003ca50: 6572 5f78 795b 3a2c 2030 5d20 3c20 7365  er_xy[:, 0] < se
+0003ca60: 6c66 5f78 795b 3a2c 2030 5d2e 6d61 7828  lf_xy[:, 0].max(
+0003ca70: 292b 7061 6429 2026 2028 6f74 6865 725f  )+pad) & (other_
+0003ca80: 7879 5b3a 2c20 315d 203e 202d 7061 6429  xy[:, 1] > -pad)
+0003ca90: 2026 2028 6f74 6865 725f 7879 5b3a 2c20   & (other_xy[:, 
+0003caa0: 305d 203c 2073 656c 665f 7879 5b3a 2c20  0] < self_xy[:, 
+0003cab0: 315d 2e6d 6178 2829 2b70 6164 290a 2020  1].max()+pad).  
+0003cac0: 2020 2020 2020 2020 2020 6f74 6865 725f            other_
+0003cad0: 7879 203d 206f 7468 6572 5f78 795b 6375  xy = other_xy[cu
+0003cae0: 742c 203a 5d0a 0a20 2020 2020 2020 2020  t, :]..         
+0003caf0: 2020 2078 795f 6365 6e74 6572 203d 206e     xy_center = n
+0003cb00: 702e 7a65 726f 7328 3229 0a0a 2020 2020  p.zeros(2)..    
+0003cb10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003cb20: 2020 2020 2020 6f74 6865 725f 7879 203d        other_xy =
+0003cb30: 2073 656c 665f 7763 732e 616c 6c5f 776f   self_wcs.all_wo
+0003cb40: 726c 6432 7069 7828 6f74 6865 725f 7261  rld2pix(other_ra
+0003cb50: 6465 632c 2070 6978 656c 5f69 6e64 6578  dec, pixel_index
+0003cb60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0003cb70: 2068 6173 6174 7472 2873 656c 665f 7763   hasattr(self_wc
+0003cb80: 732c 2027 7069 7865 6c5f 7368 6170 6527  s, 'pixel_shape'
+0003cb90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003cba0: 2020 205f 6e61 7869 7331 2c20 5f6e 6178     _naxis1, _nax
+0003cbb0: 6973 3220 3d20 7365 6c66 5f77 6373 2e5f  is2 = self_wcs._
+0003cbc0: 6e61 7869 730a 2020 2020 2020 2020 2020  naxis.          
+0003cbd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003cbe0: 2020 2020 2020 2020 5f6e 6178 6973 312c          _naxis1,
+0003cbf0: 205f 6e61 7869 7332 203d 2073 656c 665f   _naxis2 = self_
+0003cc00: 7763 732e 5f6e 6178 6973 312c 2073 656c  wcs._naxis1, sel
+0003cc10: 665f 7763 732e 5f6e 6178 6973 320a 0a20  f_wcs._naxis2.. 
+0003cc20: 2020 2020 2020 2020 2020 2063 7574 203d             cut =
+0003cc30: 2028 6f74 6865 725f 7879 5b3a 2c20 305d   (other_xy[:, 0]
+0003cc40: 203e 202d 7061 6429 2026 2028 6f74 6865   > -pad) & (othe
+0003cc50: 725f 7879 5b3a 2c20 305d 203c 205f 6e61  r_xy[:, 0] < _na
+0003cc60: 7869 7331 2b70 6164 290a 2020 2020 2020  xis1+pad).      
+0003cc70: 2020 2020 2020 6375 7420 263d 2028 6f74        cut &= (ot
+0003cc80: 6865 725f 7879 5b3a 2c20 315d 203e 202d  her_xy[:, 1] > -
+0003cc90: 7061 6429 2026 2028 6f74 6865 725f 7879  pad) & (other_xy
+0003cca0: 5b3a 2c20 315d 203c 205f 6e61 7869 7332  [:, 1] < _naxis2
+0003ccb0: 2b70 6164 290a 0a20 2020 2020 2020 2020  +pad)..         
+0003ccc0: 2020 206f 7468 6572 5f78 7920 3d20 6f74     other_xy = ot
+0003ccd0: 6865 725f 7879 5b63 7574 2c20 3a5d 0a20  her_xy[cut, :]. 
+0003cce0: 2020 2020 2020 2020 2020 2078 795f 6365             xy_ce
+0003ccf0: 6e74 6572 203d 2073 656c 665f 7763 732e  nter = self_wcs.
+0003cd00: 7763 732e 6372 7069 782a 310a 0a20 2020  wcs.crpix*1..   
+0003cd10: 2020 2020 2069 6620 6c65 6e28 6f74 6865       if len(othe
+0003cd20: 725f 7879 2920 3c20 333a 0a20 2020 2020  r_xy) < 3:.     
+0003cd30: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
+0003cd40: 7420 656e 6f75 6768 2073 6f75 7263 6573  t enough sources
+0003cd50: 2069 6e20 6d61 7463 6820 6361 7461 6c6f   in match catalo
+0003cd60: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
+0003cd70: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+0003cd80: 2020 2020 2020 7365 6c66 5f78 7920 2d3d        self_xy -=
+0003cd90: 2078 795f 6365 6e74 6572 0a20 2020 2020   xy_center.     
+0003cda0: 2020 206f 7468 6572 5f78 7920 2d3d 2078     other_xy -= x
+0003cdb0: 795f 6365 6e74 6572 0a0a 2020 2020 2020  y_center..      
+0003cdc0: 2020 2323 2323 2323 2323 0a20 2020 2020    ########.     
+0003cdd0: 2020 2023 204d 6174 6368 2073 7572 6661     # Match surfa
+0003cde0: 6365 2064 656e 7369 7479 206f 6620 6472  ce density of dr
+0003cdf0: 697a 7a6c 6564 2061 6e64 2072 6566 6572  izzled and refer
+0003ce00: 656e 6365 2063 6174 616c 6f67 730a 2020  ence catalogs.  
+0003ce10: 2020 2020 2020 6966 206d 6167 5f63 6f6c        if mag_col
+0003ce20: 756d 6e20 6973 206e 6f74 204e 6f6e 653a  umn is not None:
+0003ce30: 0a20 2020 2020 2020 2020 2020 2069 6375  .            icu
+0003ce40: 7420 3d20 6e70 2e6d 696e 696d 756d 286c  t = np.minimum(l
+0003ce50: 656e 2873 656c 6629 2d32 2c20 696e 7428  en(self)-2, int(
+0003ce60: 7363 616c 655f 6465 6e73 6974 792a 6f74  scale_density*ot
+0003ce70: 6865 725f 7879 2e73 6861 7065 5b30 5d29  her_xy.shape[0])
+0003ce80: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0003ce90: 6c66 5f69 7820 3d20 6e70 2e61 7267 736f  lf_ix = np.argso
+0003cea0: 7274 2873 656c 665b 6d61 675f 636f 6c75  rt(self[mag_colu
+0003ceb0: 6d6e 5d29 5b3a 6963 7574 5d0a 2020 2020  mn])[:icut].    
+0003cec0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003ced0: 2020 2020 2020 7365 6c66 5f69 7820 3d20        self_ix = 
+0003cee0: 6e70 2e61 7261 6e67 6528 7365 6c66 5f78  np.arange(self_x
+0003cef0: 792e 7368 6170 655b 305d 290a 0a20 2020  y.shape[0])..   
+0003cf00: 2020 2020 2073 656c 665f 7879 203d 2073       self_xy = s
+0003cf10: 656c 665f 7879 5b73 656c 665f 6978 2c20  elf_xy[self_ix, 
+0003cf20: 3a5d 0a0a 2020 2020 2020 2020 7061 6972  :]..        pair
+0003cf30: 5f69 7820 3d20 6d61 7463 682e 6d61 7463  _ix = match.matc
+0003cf40: 685f 6361 7461 6c6f 675f 7472 6928 7365  h_catalog_tri(se
+0003cf50: 6c66 5f78 792c 206f 7468 6572 5f78 792c  lf_xy, other_xy,
+0003cf60: 206d 6178 4b65 6570 3d6d 6178 4b65 6570   maxKeep=maxKeep
+0003cf70: 2c20 6175 746f 5f6b 6565 703d 6175 746f  , auto_keep=auto
+0003cf80: 5f6b 6565 702c 2061 7574 6f5f 7472 616e  _keep, auto_tran
+0003cf90: 7366 6f72 6d3d 4e6f 6e65 2c20 6175 746f  sform=None, auto
+0003cfa0: 5f6c 696d 6974 3d61 7574 6f5f 6c69 6d69  _limit=auto_limi
+0003cfb0: 742c 2073 697a 655f 6c69 6d69 743d 5b35  t, size_limit=[5
+0003cfc0: 2c20 3130 3030 5d2c 2069 676e 6f72 655f  , 1000], ignore_
+0003cfd0: 726f 743d 4661 6c73 652c 2069 676e 6f72  rot=False, ignor
+0003cfe0: 655f 7363 616c 653d 5472 7565 2c20 6261  e_scale=True, ba
+0003cff0: 5f6d 6178 3d62 615f 6d61 7829 0a0a 2020  _max=ba_max)..  
+0003d000: 2020 2020 2020 6966 206c 656e 2870 6169        if len(pai
+0003d010: 725f 6978 2920 3d3d 2030 3a0a 2020 2020  r_ix) == 0:.    
+0003d020: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+0003d030: 6f20 6d61 7463 6865 7327 290a 2020 2020  o matches').    
+0003d040: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0003d050: 616c 7365 0a0a 2020 2020 2020 2020 7466  alse..        tf
+0003d060: 2c20 6478 2c20 726d 7320 3d20 6d61 7463  , dx, rms = matc
+0003d070: 682e 6765 745f 7472 616e 7366 6f72 6d28  h.get_transform(
+0003d080: 7365 6c66 5f78 792c 206f 7468 6572 5f78  self_xy, other_x
+0003d090: 792c 2070 6169 725f 6978 2c20 7472 616e  y, pair_ix, tran
+0003d0a0: 7366 6f72 6d3d 4e6f 6e65 2c20 7573 655f  sform=None, use_
+0003d0b0: 7261 6e73 6163 3d54 7275 6529 0a0a 2020  ransac=True)..  
+0003d0c0: 2020 2020 2020 6d61 7463 685f 6978 203d        match_ix =
+0003d0d0: 2070 6169 725f 6978 2a31 0a20 2020 2020   pair_ix*1.     
+0003d0e0: 2020 206d 6174 6368 5f69 785b 3a2c 2030     match_ix[:, 0
+0003d0f0: 5d20 3d20 7365 6c66 5f69 785b 7061 6972  ] = self_ix[pair
+0003d100: 5f69 785b 3a2c 2030 5d5d 0a0a 2020 2020  _ix[:, 0]]..    
+0003d110: 2020 2020 6966 2073 686f 775f 6469 6167      if show_diag
+0003d120: 6e6f 7374 6963 3a0a 2020 2020 2020 2020  nostic:.        
+0003d130: 2020 2020 6669 6720 3d20 6d61 7463 682e      fig = match.
+0003d140: 6d61 7463 685f 6469 6167 6e6f 7374 6963  match_diagnostic
+0003d150: 5f70 6c6f 7428 7365 6c66 5f78 792c 206f  _plot(self_xy, o
+0003d160: 7468 6572 5f78 792c 2070 6169 725f 6978  ther_xy, pair_ix
+0003d170: 2c20 7466 3d4e 6f6e 652c 206e 6577 5f66  , tf=None, new_f
+0003d180: 6967 7572 653d 5472 7565 290a 2020 2020  igure=True).    
+0003d190: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0003d1a0: 6174 6368 5f69 782c 2074 662c 2064 782c  atch_ix, tf, dx,
+0003d1b0: 2072 6d73 2c20 6669 670a 2020 2020 2020   rms, fig.      
+0003d1c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003d1d0: 2020 2020 7265 7475 726e 206d 6174 6368      return match
+0003d1e0: 5f69 782c 2074 662c 2064 782c 2072 6d73  _ix, tf, dx, rms
+0003d1f0: 0a0a 2020 2020 6465 6620 6164 645f 616c  ..    def add_al
+0003d200: 6164 6469 6e28 7365 6c66 2c20 7264 5f63  addin(self, rd_c
+0003d210: 6f6c 733d 5b27 7261 272c 2027 6465 6327  ols=['ra', 'dec'
+0003d220: 5d2c 2066 6f76 3d30 2e35 2c20 7369 7a65  ], fov=0.5, size
+0003d230: 3d28 3430 302c 2032 3030 292c 2064 6566  =(400, 200), def
+0003d240: 6175 6c74 5f76 6965 773d 2250 2f44 5353  ault_view="P/DSS
+0003d250: 322f 636f 6c6f 7222 293a 0a20 2020 2020  2/color"):.     
+0003d260: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+0003d270: 6464 2041 6c61 6469 6e4c 6974 6520 4449  dd AladinLite DI
+0003d280: 5620 636f 6c75 6d6e 2074 6f20 7468 6520  V column to the 
+0003d290: 7461 626c 650a 0a20 2020 2020 2020 2066  table..        f
+0003d2a0: 6f76 203a 2066 6f76 2069 6e20 6465 6772  ov : fov in degr
+0003d2b0: 6565 730a 2020 2020 2020 2020 7369 7a65  ees.        size
+0003d2c0: 203a 2073 697a 6520 6f66 2044 4956 7320   : size of DIVs 
+0003d2d0: 2877 2c20 6829 2069 6e20 7069 7865 6c73  (w, h) in pixels
+0003d2e0: 2028 772c 2068 290a 0a20 2020 2020 2020   (w, h)..       
+0003d2f0: 2022 2222 0a20 2020 2020 2020 2023 203c   """.        # <
+0003d300: 212d 2d20 696e 636c 7564 6520 416c 6164  !-- include Alad
+0003d310: 696e 204c 6974 6520 4353 5320 6669 6c65  in Lite CSS file
+0003d320: 2069 6e20 7468 6520 6865 6164 2073 6563   in the head sec
+0003d330: 7469 6f6e 206f 6620 796f 7572 2070 6167  tion of your pag
+0003d340: 6520 2d2d 3e0a 2020 2020 2020 2020 2320  e -->.        # 
+0003d350: 3c6c 696e 6b20 7265 6c3d 2273 7479 6c65  <link rel="style
+0003d360: 7368 6565 7422 2068 7265 663d 222f 2f61  sheet" href="//a
+0003d370: 6c61 6469 6e2e 752d 7374 7261 7362 672e  ladin.u-strasbg.
+0003d380: 6672 2f41 6c61 6469 6e4c 6974 652f 6170  fr/AladinLite/ap
+0003d390: 692f 7632 2f6c 6174 6573 742f 616c 6164  i/v2/latest/alad
+0003d3a0: 696e 2e6d 696e 2e63 7373 2220 2f3e 0a20  in.min.css" />. 
+0003d3b0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+0003d3c0: 2023 203c 212d 2d20 796f 7520 6361 6e20   # <!-- you can 
+0003d3d0: 736b 6970 2074 6865 2066 6f6c 6c6f 7769  skip the followi
+0003d3e0: 6e67 206c 696e 6520 6966 2079 6f75 7220  ng line if your 
+0003d3f0: 7061 6765 2061 6c72 6561 6479 2069 6e74  page already int
+0003d400: 6567 7261 7465 7320 7468 6520 6a51 7565  egrates the jQue
+0003d410: 7279 206c 6962 7261 7279 202d 2d3e 0a20  ry library -->. 
+0003d420: 2020 2020 2020 2023 203c 7363 7269 7074         # <script
+0003d430: 2074 7970 653d 2274 6578 742f 6a61 7661   type="text/java
+0003d440: 7363 7269 7074 2220 7372 633d 222f 2f63  script" src="//c
+0003d450: 6f64 652e 6a71 7565 7279 2e63 6f6d 2f6a  ode.jquery.com/j
+0003d460: 7175 6572 792d 312e 3132 2e31 2e6d 696e  query-1.12.1.min
+0003d470: 2e6a 7322 2063 6861 7273 6574 3d22 7574  .js" charset="ut
+0003d480: 662d 3822 3e3c 2f73 6372 6970 743e 0a0a  f-8"></script>..
+0003d490: 2020 2020 2020 2020 616c 6120 3d20 5b22          ala = ["
+0003d4a0: 2222 2020 2020 3c64 6976 2069 643d 2261  ""    <div id="a
+0003d4b0: 6c61 6469 6e2d 6c69 7465 2d64 6976 2d7b  ladin-lite-div-{
+0003d4c0: 697d 2220 7374 796c 653d 2277 6964 7468  i}" style="width
+0003d4d0: 3a7b 7773 697a 657d 7078 3b68 6569 6768  :{wsize}px;heigh
+0003d4e0: 743a 7b68 7369 7a65 7d70 783b 223e 3c2f  t:{hsize}px;"></
+0003d4f0: 6469 763e 0a20 2020 2020 2020 203c 7363  div>.        <sc
+0003d500: 7269 7074 2074 7970 653d 2274 6578 742f  ript type="text/
+0003d510: 6a61 7661 7363 7269 7074 2220 7372 633d  javascript" src=
+0003d520: 2268 7474 703a 2f2f 616c 6164 696e 2e75  "http://aladin.u
+0003d530: 2d73 7472 6173 6267 2e66 722f 416c 6164  -strasbg.fr/Alad
+0003d540: 696e 4c69 7465 2f61 7069 2f76 322f 6c61  inLite/api/v2/la
+0003d550: 7465 7374 2f61 6c61 6469 6e2e 6d69 6e2e  test/aladin.min.
+0003d560: 6a73 2220 6368 6172 7365 743d 2275 7466  js" charset="utf
+0003d570: 2d38 223e 3c2f 7363 7269 7074 3e0a 2020  -8"></script>.  
+0003d580: 2020 2020 2020 3c73 6372 6970 7420 7479        <script ty
+0003d590: 7065 3d22 7465 7874 2f6a 6176 6173 6372  pe="text/javascr
+0003d5a0: 6970 7422 3e0a 2020 2020 2020 2020 2020  ipt">.          
+0003d5b0: 2020 7661 7220 616c 6164 696e 203d 2041    var aladin = A
+0003d5c0: 2e61 6c61 6469 6e28 2723 616c 6164 696e  .aladin('#aladin
+0003d5d0: 2d6c 6974 652d 6469 762d 7b69 7d27 2c20  -lite-div-{i}', 
+0003d5e0: 7878 7873 7572 7665 793a 2022 7b73 7572  xxxsurvey: "{sur
+0003d5f0: 7665 797d 222c 2066 6f76 3a7b 666f 767d  vey}", fov:{fov}
+0003d600: 2c20 7461 7267 6574 3a20 227b 7261 7d20  , target: "{ra} 
+0003d610: 7b64 6563 7d22 7979 7929 3b0a 2020 2020  {dec}"yyy);.    
+0003d620: 2020 2020 3c2f 7363 7269 7074 3e3c 2f64      </script></d
+0003d630: 6976 3e22 2222 2e66 6f72 6d61 7428 693d  iv>""".format(i=
+0003d640: 692c 2072 613d 726f 775b 7264 5f63 6f6c  i, ra=row[rd_col
+0003d650: 735b 305d 5d2c 2064 6563 3d72 6f77 5b72  s[0]], dec=row[r
+0003d660: 645f 636f 6c73 5b31 5d5d 2c20 7375 7276  d_cols[1]], surv
+0003d670: 6579 3d64 6566 6175 6c74 5f76 6965 772c  ey=default_view,
+0003d680: 2066 6f76 3d66 6f76 2c20 6873 697a 653d   fov=fov, hsize=
+0003d690: 7369 7a65 5b31 5d2c 2077 7369 7a65 3d73  size[1], wsize=s
+0003d6a0: 697a 655b 305d 292e 7265 706c 6163 6528  ize[0]).replace(
+0003d6b0: 2778 7878 272c 2027 7b27 292e 7265 706c  'xxx', '{').repl
+0003d6c0: 6163 6528 2779 7979 272c 2027 7d27 2920  ace('yyy', '}') 
+0003d6d0: 666f 7220 692c 2072 6f77 2069 6e20 656e  for i, row in en
+0003d6e0: 756d 6572 6174 6528 7365 6c66 295d 0a0a  umerate(self)]..
+0003d6f0: 2020 2020 2020 2020 7365 6c66 5b27 616c          self['al
+0003d700: 6164 696e 275d 203d 2061 6c61 0a0a 2020  adin'] = ala..  
+0003d710: 2020 6465 6620 7772 6974 655f 736f 7274    def write_sort
+0003d720: 6162 6c65 5f68 746d 6c28 7365 6c66 2c20  able_html(self, 
+0003d730: 6f75 7470 7574 2c20 7265 706c 6163 655f  output, replace_
+0003d740: 6272 6163 6573 3d54 7275 652c 206c 6f63  braces=True, loc
+0003d750: 616c 686f 7374 3d54 7275 652c 206d 6178  alhost=True, max
+0003d760: 5f6c 696e 6573 3d35 302c 2074 6162 6c65  _lines=50, table
+0003d770: 5f69 643d 4e6f 6e65 2c20 7461 626c 655f  _id=None, table_
+0003d780: 636c 6173 733d 2264 6973 706c 6179 2063  class="display c
+0003d790: 6f6d 7061 6374 222c 2063 7373 3d4e 6f6e  ompact", css=Non
+0003d7a0: 652c 2066 696c 7465 725f 636f 6c75 6d6e  e, filter_column
+0003d7b0: 733d 5b5d 2c20 6275 7474 6f6e 733d 5b27  s=[], buttons=['
+0003d7c0: 6373 7627 5d2c 2074 6f67 676c 653d 5472  csv'], toggle=Tr
+0003d7d0: 7565 2c20 7573 655f 6a73 6f6e 3d46 616c  ue, use_json=Fal
+0003d7e0: 7365 293a 0a20 2020 2020 2020 2022 2222  se):.        """
+0003d7f0: 5772 6170 7065 7220 6172 6f75 6e64 2060  Wrapper around `
+0003d800: 7e61 7374 726f 7079 2e74 6162 6c65 2e54  ~astropy.table.T
+0003d810: 6162 6c65 2e77 7269 7465 2866 6f72 6d61  able.write(forma
+0003d820: 743d 276a 7376 6965 7765 7227 2960 2e0a  t='jsviewer')`..
+0003d830: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0003d840: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+0003d850: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206f  ------.        o
+0003d860: 7574 7075 7420 3a20 7374 720a 2020 2020  utput : str.    
+0003d870: 2020 2020 2020 2020 4f75 7470 7574 2066          Output f
+0003d880: 696c 656e 616d 652e 0a0a 2020 2020 2020  ilename...      
+0003d890: 2020 7265 706c 6163 655f 6272 6163 6573    replace_braces
+0003d8a0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+0003d8b0: 2020 2020 5265 706c 6163 6520 2726 6c74      Replace '&lt
+0003d8c0: 3b27 2061 6e64 2027 2667 743b 2720 6368  ;' and '&gt;' ch
+0003d8d0: 6172 6163 7465 7273 2074 6861 7420 6172  aracters that ar
+0003d8e0: 6520 636f 6e76 6572 7465 640a 2020 2020  e converted.    
+0003d8f0: 2020 2020 2020 2020 6175 746f 6d61 7469          automati
+0003d900: 6361 6c6c 7920 6672 6f6d 2022 3c3e 2220  cally from "<>" 
+0003d910: 6279 2074 6865 2060 7e61 7374 726f 7079  by the `~astropy
+0003d920: 2e74 6162 6c65 2e54 6162 6c65 2e77 7269  .table.Table.wri
+0003d930: 7465 600a 2020 2020 2020 2020 2020 2020  te`.            
+0003d940: 6d65 7468 6f64 2e20 5468 6572 6520 6172  method. There ar
+0003d950: 6520 7061 7261 6d65 7465 7273 2066 6f72  e parameters for
+0003d960: 2064 6f69 6e67 2074 6869 7320 6175 746f   doing this auto
+0003d970: 6d61 7469 6361 6c6c 7920 7769 7468 0a20  matically with. 
+0003d980: 2020 2020 2020 2020 2020 2060 7772 6974             `writ
+0003d990: 6528 666f 726d 6174 3d27 6874 6d6c 2729  e(format='html')
+0003d9a0: 6020 6275 7420 7468 6174 2064 6f6e 2774  ` but that don't
+0003d9b0: 2061 7070 6561 7220 746f 2062 6520 6176   appear to be av
+0003d9c0: 6169 6c61 626c 6520 7769 7468 0a20 2020  ailable with.   
+0003d9d0: 2020 2020 2020 2020 2060 7772 6974 6528           `write(
+0003d9e0: 666f 726d 6174 3d27 6a73 7669 6577 6572  format='jsviewer
+0003d9f0: 2729 602e 0a0a 2020 2020 2020 2020 6c6f  ')`...        lo
+0003da00: 6361 6c68 6f73 7420 3a20 626f 6f6c 0a20  calhost : bool. 
+0003da10: 2020 2020 2020 2020 2020 2055 7365 206c             Use l
+0003da20: 6f63 616c 204a 5320 6669 6c65 732e 204f  ocal JS files. O
+0003da30: 7468 6572 7769 7365 2075 7365 2066 696c  therwise use fil
+0003da40: 6573 2068 6f73 7465 6420 6578 7465 726e  es hosted extern
+0003da50: 616c 6c79 2e0a 0a20 2020 2020 2020 2066  ally...        f
+0003da60: 696c 7465 725f 636f 6c75 6d6e 7320 3a20  ilter_columns : 
+0003da70: 6c69 7374 0a20 2020 2020 2020 2020 2020  list.           
+0003da80: 2041 6464 206f 7074 696f 6e20 746f 206c   Add option to l
+0003da90: 696d 6974 206d 696e 2f6d 6178 2076 616c  imit min/max val
+0003daa0: 7565 7320 6f66 2063 6f6c 756d 6e20 6461  ues of column da
+0003dab0: 7461 0a0a 2020 2020 2020 2020 6275 7474  ta..        butt
+0003dac0: 6f6e 7320 3a20 6c69 7374 0a20 2020 2020  ons : list.     
+0003dad0: 2020 2020 2020 2041 6464 2062 7574 746f         Add butto
+0003dae0: 6e73 2066 6f72 2065 7870 6f72 7469 6e67  ns for exporting
+0003daf0: 2064 6174 612e 2020 416c 6c6f 7765 6420   data.  Allowed 
+0003db00: 6f70 7469 6f6e 7320 6172 650a 2020 2020  options are.    
+0003db10: 2020 2020 2020 2020 2763 6f70 7927 2c20          'copy', 
+0003db20: 2763 7376 272c 2027 6578 6365 6c27 2c20  'csv', 'excel', 
+0003db30: 2770 6466 272c 2027 7072 696e 7427 2e0a  'pdf', 'print'..
+0003db40: 0a20 2020 2020 2020 2074 6f67 676c 6520  .        toggle 
+0003db50: 3a20 626f 6f6c 0a20 2020 2020 2020 2020  : bool.         
+0003db60: 2020 2041 6464 206c 696e 6b73 2061 7420     Add links at 
+0003db70: 746f 7020 6f66 2070 6167 6520 666f 7220  top of page for 
+0003db80: 746f 6767 6c69 6e67 2063 6f6c 756d 6e73  toggling columns
+0003db90: 206f 6e2f 6f66 660a 0a20 2020 2020 2020   on/off..       
+0003dba0: 2075 7365 5f6a 736f 6e20 3a20 626f 6f6c   use_json : bool
+0003dbb0: 0a20 2020 2020 2020 2020 2020 2057 7269  .            Wri
+0003dbc0: 7465 2074 6865 2064 6174 6120 746f 2061  te the data to a
+0003dbd0: 204a 534f 4e20 6669 6c65 2061 6e64 2073   JSON file and s
+0003dbe0: 7472 6970 206f 7574 206f 6620 7468 6520  trip out of the 
+0003dbf0: 4854 4d4c 2068 6561 6465 722e 0a20 2020  HTML header..   
+0003dc00: 2020 2020 2020 2020 2055 7365 2074 6869           Use thi
+0003dc10: 7320 666f 7220 6c61 7267 6520 6461 7461  s for large data
+0003dc20: 7365 7473 206f 7220 6966 2063 6f6c 756d  sets or if colum
+0003dc30: 6e73 2069 6e63 6c75 6465 2072 656e 6465  ns include rende
+0003dc40: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
+0003dc50: 696d 6167 6573 2e0a 0a20 2020 2020 2020  images...       
+0003dc60: 2065 7463 203a 202e 2e2e 0a20 2020 2020   etc : ....     
+0003dc70: 2020 2020 2020 2041 6464 6974 696f 6e61         Additiona
+0003dc80: 6c20 7061 7261 6d65 7465 7273 2070 6173  l parameters pas
+0003dc90: 7365 6420 7468 726f 7567 6820 746f 2060  sed through to `
+0003dca0: 7772 6974 6560 2e0a 2020 2020 2020 2020  write`..        
+0003dcb0: 2222 220a 2020 2020 2020 2020 2366 726f  """.        #fro
+0003dcc0: 6d20 6173 7472 6f70 792e 7461 626c 652e  m astropy.table.
+0003dcd0: 6a73 7669 6577 6572 2069 6d70 6f72 7420  jsviewer import 
+0003dce0: 4445 4641 554c 545f 4353 530a 2020 2020  DEFAULT_CSS.    
+0003dcf0: 2020 2020 4445 4641 554c 545f 4353 5320      DEFAULT_CSS 
+0003dd00: 3d20 2222 220a 626f 6479 207b 666f 6e74  = """.body {font
+0003dd10: 2d66 616d 696c 793a 2073 616e 732d 7365  -family: sans-se
+0003dd20: 7269 663b 7d0a 7461 626c 652e 6461 7461  rif;}.table.data
+0003dd30: 5461 626c 6520 7b77 6964 7468 3a20 6175  Table {width: au
+0003dd40: 746f 2021 696d 706f 7274 616e 743b 206d  to !important; m
+0003dd50: 6172 6769 6e3a 2030 2021 696d 706f 7274  argin: 0 !import
+0003dd60: 616e 743b 7d0a 2e64 6174 6154 6162 6c65  ant;}..dataTable
+0003dd70: 735f 6669 6c74 6572 2c20 2e64 6174 6154  s_filter, .dataT
+0003dd80: 6162 6c65 735f 7061 6769 6e61 7465 207b  ables_paginate {
+0003dd90: 666c 6f61 743a 206c 6566 7420 2169 6d70  float: left !imp
+0003dda0: 6f72 7461 6e74 3b20 6d61 7267 696e 2d6c  ortant; margin-l
+0003ddb0: 6566 743a 3165 6d7d 0a74 6420 7b66 6f6e  eft:1em}.td {fon
+0003ddc0: 742d 7369 7a65 3a20 3130 7074 3b7d 0a20  t-size: 10pt;}. 
+0003ddd0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003dde0: 2020 2069 6620 6373 7320 6973 206e 6f74     if css is not
+0003ddf0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003de00: 2020 2044 4546 4155 4c54 5f43 5353 202b     DEFAULT_CSS +
+0003de10: 3d20 6373 730a 0a20 2020 2020 2020 2069  = css..        i
+0003de20: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+0003de30: 286f 7574 7075 7429 3a0a 2020 2020 2020  (output):.      
+0003de40: 2020 2020 2020 6f73 2e72 656d 6f76 6528        os.remove(
+0003de50: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
+0003de60: 2073 656c 662e 7772 6974 6528 6f75 7470   self.write(outp
+0003de70: 7574 2c20 666f 726d 6174 3d27 6a73 7669  ut, format='jsvi
+0003de80: 6577 6572 272c 2063 7373 3d44 4546 4155  ewer', css=DEFAU
+0003de90: 4c54 5f43 5353 2c0a 2020 2020 2020 2020  LT_CSS,.        
+0003dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003deb0: 2020 2020 6d61 785f 6c69 6e65 733d 6d61      max_lines=ma
+0003dec0: 785f 6c69 6e65 732c 0a20 2020 2020 2020  x_lines,.       
+0003ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dee0: 2020 2020 206a 736b 7761 7267 733d 7b27       jskwargs={'
+0003def0: 7573 655f 6c6f 6361 6c5f 6669 6c65 7327  use_local_files'
+0003df00: 3a20 6c6f 6361 6c68 6f73 747d 2c0a 2020  : localhost},.  
+0003df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003df20: 2020 2020 2020 2020 2020 7461 626c 655f            table_
+0003df30: 6964 3d4e 6f6e 652c 2074 6162 6c65 5f63  id=None, table_c
+0003df40: 6c61 7373 3d74 6162 6c65 5f63 6c61 7373  lass=table_class
+0003df50: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+0003df60: 706c 6163 655f 6272 6163 6573 3a0a 2020  place_braces:.  
+0003df70: 2020 2020 2020 2020 2020 6c69 6e65 7320            lines 
+0003df80: 3d20 6f70 656e 286f 7574 7075 7429 2e72  = open(output).r
+0003df90: 6561 646c 696e 6573 2829 0a20 2020 2020  eadlines().     
+0003dfa0: 2020 2020 2020 2069 6620 7265 706c 6163         if replac
+0003dfb0: 655f 6272 6163 6573 3a0a 2020 2020 2020  e_braces:.      
+0003dfc0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0003dfd0: 696e 2072 616e 6765 286c 656e 286c 696e  in range(len(lin
+0003dfe0: 6573 2929 3a0a 2020 2020 2020 2020 2020  es)):.          
+0003dff0: 2020 2020 2020 2020 2020 6c69 6e65 735b            lines[
+0003e000: 695d 203d 206c 696e 6573 5b69 5d2e 7265  i] = lines[i].re
+0003e010: 706c 6163 6528 2726 6c74 3b27 2c20 273c  place('&lt;', '<
+0003e020: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0003e030: 2020 2020 2020 206c 696e 6573 5b69 5d20         lines[i] 
+0003e040: 3d20 6c69 6e65 735b 695d 2e72 6570 6c61  = lines[i].repla
+0003e050: 6365 2827 2667 743b 272c 2027 3e27 290a  ce('&gt;', '>').
+0003e060: 0a20 2020 2020 2020 2020 2020 2066 7020  .            fp 
+0003e070: 3d20 6f70 656e 286f 7574 7075 742c 2027  = open(output, '
+0003e080: 7727 290a 2020 2020 2020 2020 2020 2020  w').            
+0003e090: 6670 2e77 7269 7465 6c69 6e65 7328 6c69  fp.writelines(li
+0003e0a0: 6e65 7329 0a20 2020 2020 2020 2020 2020  nes).           
+0003e0b0: 2066 702e 636c 6f73 6528 290a 0a20 2020   fp.close()..   
+0003e0c0: 2020 2020 2023 2052 6561 6420 616c 6c20       # Read all 
+0003e0d0: 6c69 6e65 730a 2020 2020 2020 2020 6c69  lines.        li
+0003e0e0: 6e65 7320 3d20 6f70 656e 286f 7574 7075  nes = open(outpu
+0003e0f0: 7429 2e72 6561 646c 696e 6573 2829 0a0a  t).readlines()..
+0003e100: 2020 2020 2020 2020 6966 2027 616c 6164          if 'alad
+0003e110: 696e 2720 696e 2073 656c 662e 636f 6c6e  in' in self.coln
+0003e120: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+0003e130: 2020 2320 496e 7365 7274 2041 6c61 6469    # Insert Aladi
+0003e140: 6e20 4353 530a 2020 2020 2020 2020 2020  n CSS.          
+0003e150: 2020 616c 6164 696e 5f63 7373 203d 2027    aladin_css = '
+0003e160: 3c6c 696e 6b20 7265 6c3d 2273 7479 6c65  <link rel="style
+0003e170: 7368 6565 7422 2068 7265 663d 2268 7474  sheet" href="htt
+0003e180: 7073 3a2f 2f61 6c61 6469 6e2e 752d 7374  ps://aladin.u-st
+0003e190: 7261 7362 672e 6672 2f41 6c61 6469 6e4c  rasbg.fr/AladinL
+0003e1a0: 6974 652f 6170 692f 7632 2f6c 6174 6573  ite/api/v2/lates
+0003e1b0: 742f 616c 6164 696e 2e6d 696e 2e63 7373  t/aladin.min.css
+0003e1c0: 2220 2f3e 5c6e 270a 0a20 2020 2020 2020  " />\n'..       
+0003e1d0: 2020 2020 2066 6f72 2069 6c2c 206c 696e       for il, lin
+0003e1e0: 6520 696e 2065 6e75 6d65 7261 7465 286c  e in enumerate(l
+0003e1f0: 696e 6573 293a 0a20 2020 2020 2020 2020  ines):.         
+0003e200: 2020 2020 2020 2069 6620 273c 6c69 6e6b         if '<link
+0003e210: 2068 7265 663d 2720 696e 206c 696e 653a   href=' in line:
+0003e220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e230: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003e240: 2020 2020 2020 2020 6c69 6e65 732e 696e          lines.in
+0003e250: 7365 7274 2869 6c2b 312c 2061 6c61 6469  sert(il+1, aladi
+0003e260: 6e5f 6373 7329 0a0a 2020 2020 2020 2020  n_css)..        
+0003e270: 2320 4578 706f 7274 2062 7574 746f 6e73  # Export buttons
+0003e280: 0a20 2020 2020 2020 2069 6620 6275 7474  .        if butt
+0003e290: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0003e2a0: 2023 2043 5353 0a20 2020 2020 2020 2020   # CSS.         
+0003e2b0: 2020 2063 7373 5f73 6372 6970 7420 3d20     css_script = 
+0003e2c0: 273c 6c69 6e6b 2072 656c 3d22 7374 796c  '<link rel="styl
+0003e2d0: 6573 6865 6574 2220 7479 7065 3d22 7465  esheet" type="te
+0003e2e0: 7874 2f63 7373 2220 6872 6566 3d22 6874  xt/css" href="ht
+0003e2f0: 7470 733a 2f2f 6364 6e2e 6461 7461 7461  tps://cdn.datata
+0003e300: 626c 6573 2e6e 6574 2f62 7574 746f 6e73  bles.net/buttons
+0003e310: 2f31 2e35 2e31 2f63 7373 2f62 7574 746f  /1.5.1/css/butto
+0003e320: 6e73 2e64 6174 6154 6162 6c65 732e 6d69  ns.dataTables.mi
+0003e330: 6e2e 6373 7322 3e5c 6e27 0a20 2020 2020  n.css">\n'.     
+0003e340: 2020 2020 2020 2066 6f72 2069 6c2c 206c         for il, l
+0003e350: 696e 6520 696e 2065 6e75 6d65 7261 7465  ine in enumerate
+0003e360: 286c 696e 6573 293a 0a20 2020 2020 2020  (lines):.       
+0003e370: 2020 2020 2020 2020 2069 6620 2763 7373           if 'css
+0003e380: 2f6a 7175 6572 792e 6461 7461 5461 626c  /jquery.dataTabl
+0003e390: 6527 2069 6e20 6c69 6e65 3a0a 2020 2020  e' in line:.    
+0003e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e3b0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+0003e3c0: 2020 206c 696e 6573 2e69 6e73 6572 7428     lines.insert(
+0003e3d0: 696c 2b31 2c20 6373 735f 7363 7269 7074  il+1, css_script
+0003e3e0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0003e3f0: 204a 5320 6c69 6272 6172 6965 730a 2020   JS libraries.  
+0003e400: 2020 2020 2020 2020 2020 6a73 5f73 6372            js_scr
+0003e410: 6970 7473 203d 2022 2222 0a20 2020 2020  ipts = """.     
+0003e420: 2020 2020 2020 203c 7363 7269 7074 2074         <script t
+0003e430: 7970 653d 2274 6578 742f 6a61 7661 7363  ype="text/javasc
+0003e440: 7269 7074 2220 6c61 6e67 7561 6765 3d22  ript" language="
+0003e450: 6a61 7661 7363 7269 7074 2220 7372 633d  javascript" src=
+0003e460: 2268 7474 7073 3a2f 2f63 646e 2e64 6174  "https://cdn.dat
+0003e470: 6174 6162 6c65 732e 6e65 742f 6275 7474  atables.net/butt
+0003e480: 6f6e 732f 312e 352e 312f 6a73 2f64 6174  ons/1.5.1/js/dat
+0003e490: 6154 6162 6c65 732e 6275 7474 6f6e 732e  aTables.buttons.
+0003e4a0: 6d69 6e2e 6a73 223e 3c2f 7363 7269 7074  min.js"></script
+0003e4b0: 3e0a 2020 2020 2020 2020 2020 2020 3c73  >.            <s
+0003e4c0: 6372 6970 7420 7479 7065 3d22 7465 7874  cript type="text
+0003e4d0: 2f6a 6176 6173 6372 6970 7422 206c 616e  /javascript" lan
+0003e4e0: 6775 6167 653d 226a 6176 6173 6372 6970  guage="javascrip
+0003e4f0: 7422 2073 7263 3d22 6874 7470 733a 2f2f  t" src="https://
+0003e500: 6364 6e2e 6461 7461 7461 626c 6573 2e6e  cdn.datatables.n
+0003e510: 6574 2f62 7574 746f 6e73 2f31 2e35 2e31  et/buttons/1.5.1
+0003e520: 2f6a 732f 6275 7474 6f6e 732e 666c 6173  /js/buttons.flas
+0003e530: 682e 6d69 6e2e 6a73 223e 3c2f 7363 7269  h.min.js"></scri
+0003e540: 7074 3e0a 2020 2020 2020 2020 2020 2020  pt>.            
+0003e550: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
+0003e560: 7874 2f6a 6176 6173 6372 6970 7422 206c  xt/javascript" l
+0003e570: 616e 6775 6167 653d 226a 6176 6173 6372  anguage="javascr
+0003e580: 6970 7422 2073 7263 3d22 6874 7470 733a  ipt" src="https:
+0003e590: 2f2f 6364 6e6a 732e 636c 6f75 6466 6c61  //cdnjs.cloudfla
+0003e5a0: 7265 2e63 6f6d 2f61 6a61 782f 6c69 6273  re.com/ajax/libs
+0003e5b0: 2f6a 737a 6970 2f33 2e31 2e33 2f6a 737a  /jszip/3.1.3/jsz
+0003e5c0: 6970 2e6d 696e 2e6a 7322 3e3c 2f73 6372  ip.min.js"></scr
+0003e5d0: 6970 743e 0a20 2020 2020 2020 2020 2020  ipt>.           
+0003e5e0: 203c 7363 7269 7074 2074 7970 653d 2274   <script type="t
+0003e5f0: 6578 742f 6a61 7661 7363 7269 7074 2220  ext/javascript" 
+0003e600: 6c61 6e67 7561 6765 3d22 6a61 7661 7363  language="javasc
+0003e610: 7269 7074 2220 7372 633d 2268 7474 7073  ript" src="https
+0003e620: 3a2f 2f63 646e 6a73 2e63 6c6f 7564 666c  ://cdnjs.cloudfl
+0003e630: 6172 652e 636f 6d2f 616a 6178 2f6c 6962  are.com/ajax/lib
+0003e640: 732f 7064 666d 616b 652f 302e 312e 3332  s/pdfmake/0.1.32
+0003e650: 2f70 6466 6d61 6b65 2e6d 696e 2e6a 7322  /pdfmake.min.js"
+0003e660: 3e3c 2f73 6372 6970 743e 0a20 2020 2020  ></script>.     
+0003e670: 2020 2020 2020 203c 7363 7269 7074 2074         <script t
+0003e680: 7970 653d 2274 6578 742f 6a61 7661 7363  ype="text/javasc
+0003e690: 7269 7074 2220 6c61 6e67 7561 6765 3d22  ript" language="
+0003e6a0: 6a61 7661 7363 7269 7074 2220 7372 633d  javascript" src=
+0003e6b0: 2268 7474 7073 3a2f 2f63 646e 6a73 2e63  "https://cdnjs.c
+0003e6c0: 6c6f 7564 666c 6172 652e 636f 6d2f 616a  loudflare.com/aj
+0003e6d0: 6178 2f6c 6962 732f 7064 666d 616b 652f  ax/libs/pdfmake/
+0003e6e0: 302e 312e 3332 2f76 6673 5f66 6f6e 7473  0.1.32/vfs_fonts
+0003e6f0: 2e6a 7322 3e3c 2f73 6372 6970 743e 0a20  .js"></script>. 
+0003e700: 2020 2020 2020 2020 2020 203c 7363 7269             <scri
+0003e710: 7074 2074 7970 653d 2274 6578 742f 6a61  pt type="text/ja
+0003e720: 7661 7363 7269 7074 2220 6c61 6e67 7561  vascript" langua
+0003e730: 6765 3d22 6a61 7661 7363 7269 7074 2220  ge="javascript" 
+0003e740: 7372 633d 2268 7474 7073 3a2f 2f63 646e  src="https://cdn
+0003e750: 2e64 6174 6174 6162 6c65 732e 6e65 742f  .datatables.net/
+0003e760: 6275 7474 6f6e 732f 312e 352e 312f 6a73  buttons/1.5.1/js
+0003e770: 2f62 7574 746f 6e73 2e68 746d 6c35 2e6d  /buttons.html5.m
+0003e780: 696e 2e6a 7322 3e3c 2f73 6372 6970 743e  in.js"></script>
+0003e790: 0a20 2020 2020 2020 2020 2020 203c 7363  .            <sc
+0003e7a0: 7269 7074 2074 7970 653d 2274 6578 742f  ript type="text/
+0003e7b0: 6a61 7661 7363 7269 7074 2220 6c61 6e67  javascript" lang
+0003e7c0: 7561 6765 3d22 6a61 7661 7363 7269 7074  uage="javascript
+0003e7d0: 2220 7372 633d 2268 7474 7073 3a2f 2f63  " src="https://c
+0003e7e0: 646e 2e64 6174 6174 6162 6c65 732e 6e65  dn.datatables.ne
+0003e7f0: 742f 6275 7474 6f6e 732f 312e 352e 312f  t/buttons/1.5.1/
+0003e800: 6a73 2f62 7574 746f 6e73 2e70 7269 6e74  js/buttons.print
+0003e810: 2e6d 696e 2e6a 7322 3e3c 2f73 6372 6970  .min.js"></scrip
+0003e820: 743e 0a20 2020 2020 2020 2020 2020 2022  t>.            "
+0003e830: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+0003e840: 666f 7220 696c 2c20 6c69 6e65 2069 6e20  for il, line in 
+0003e850: 656e 756d 6572 6174 6528 6c69 6e65 7329  enumerate(lines)
+0003e860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e870: 2020 6966 2027 6a73 2f6a 7175 6572 792e    if 'js/jquery.
+0003e880: 6461 7461 5461 626c 6527 2069 6e20 6c69  dataTable' in li
+0003e890: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003e8a0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0003e8b0: 2020 2020 2020 2020 2020 6c69 6e65 732e            lines.
+0003e8c0: 696e 7365 7274 2869 6c2b 322c 206a 735f  insert(il+2, js_
+0003e8d0: 7363 7269 7074 7329 0a0a 2020 2020 2020  scripts)..      
+0003e8e0: 2020 2020 2020 666f 7220 696c 2c20 6c69        for il, li
+0003e8f0: 6e65 2069 6e20 656e 756d 6572 6174 6528  ne in enumerate(
+0003e900: 6c69 6e65 7329 3a0a 2020 2020 2020 2020  lines):.        
+0003e910: 2020 2020 2020 2020 6966 2027 7061 6765          if 'page
+0003e920: 4c65 6e67 7468 2720 696e 206c 696e 653a  Length' in line:
+0003e930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e940: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003e950: 2020 2020 2020 2020 6275 7474 6f6e 5f6f          button_o
+0003e960: 7074 696f 6e20 3d20 277b 7370 6163 6572  ption = '{spacer
+0003e970: 7d64 6f6d 3a20 5c27 426c 6672 7469 705c  }dom: \'Blfrtip\
+0003e980: 272c 5c6e 7b73 7061 6365 727d 6275 7474  ',\n{spacer}butt
+0003e990: 6f6e 733a 207b 6273 7472 7d2c 5c6e 272e  ons: {bstr},\n'.
+0003e9a0: 666f 726d 6174 2873 7061 6365 723d 2720  format(spacer=' 
+0003e9b0: 272a 382c 2062 7374 723d 6275 7474 6f6e  '*8, bstr=button
+0003e9c0: 732e 5f5f 7265 7072 5f5f 2829 290a 2020  s.__repr__()).  
+0003e9d0: 2020 2020 2020 2020 2020 6c69 6e65 732e            lines.
+0003e9e0: 696e 7365 7274 2869 6c2b 312c 2062 7574  insert(il+1, but
+0003e9f0: 746f 6e5f 6f70 7469 6f6e 290a 0a20 2020  ton_option)..   
+0003ea00: 2020 2020 2023 2052 616e 6765 2063 6f6c       # Range col
+0003ea10: 756d 6e73 0a20 2020 2020 2020 2069 635f  umns.        ic_
+0003ea20: 6c69 7374 203d 205b 5d0a 0a20 2020 2020  list = []..     
+0003ea30: 2020 2066 696c 7465 725f 6c69 6e65 7320     filter_lines 
+0003ea40: 3d20 5b22 3c74 6162 6c65 3e5c 6e22 5d0a  = ["<table>\n"].
+0003ea50: 2020 2020 2020 2020 6465 7363 725f 7061          descr_pa
+0003ea60: 6420 3d20 2720 3c73 7061 6e20 7374 796c  d = ' <span styl
+0003ea70: 653d 2264 6973 706c 6179 3a69 6e6c 696e  e="display:inlin
+0003ea80: 652d 626c 6f63 6b3b 2077 6964 7468 3a31  e-block; width:1
+0003ea90: 303b 223e 3c2f 7370 616e 3e20 270a 0a20  0;"></span> '.. 
+0003eaa0: 2020 2020 2020 2066 6f72 2069 632c 2063         for ic, c
+0003eab0: 6f6c 2069 6e20 656e 756d 6572 6174 6528  ol in enumerate(
+0003eac0: 7365 6c66 2e63 6f6c 6e61 6d65 7329 3a0a  self.colnames):.
+0003ead0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0003eae0: 6f6c 2069 6e20 6669 6c74 6572 5f63 6f6c  ol in filter_col
+0003eaf0: 756d 6e73 3a0a 2020 2020 2020 2020 2020  umns:.          
+0003eb00: 2020 2020 2020 666f 756e 6420 3d20 4661        found = Fa
+0003eb10: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0003eb20: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0003eb30: 6765 286c 656e 286c 696e 6573 2929 3a0a  ge(len(lines)):.
+0003eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eb50: 2020 2020 6966 2027 3c74 683e 7b30 7d27      if '<th>{0}'
+0003eb60: 2e66 6f72 6d61 7428 636f 6c29 2069 6e20  .format(col) in 
+0003eb70: 6c69 6e65 735b 695d 3a0a 2020 2020 2020  lines[i]:.      
+0003eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eb90: 2020 666f 756e 6420 3d20 5472 7565 0a20    found = True. 
+0003eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ebb0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+0003ebc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003ebd0: 2066 6f75 6e64 3a0a 2020 2020 2020 2020   found:.        
+0003ebe0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0003ebf0: 696e 7428 636f 6c29 0a20 2020 2020 2020  int(col).       
+0003ec00: 2020 2020 2020 2020 2020 2020 2069 635f               ic_
+0003ec10: 6c69 7374 2e61 7070 656e 6428 6963 290a  list.append(ic).
+0003ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ec30: 2020 2020 236c 696e 6573 5b69 5d20 3d20      #lines[i] = 
+0003ec40: 6c69 6e65 735b 695d 2e72 6570 6c61 6365  lines[i].replace
+0003ec50: 2863 6f6c 2c20 277b 307d 203c 6272 3e20  (col, '{0} <br> 
+0003ec60: 3c69 6e70 7574 2074 7970 653d 2274 6578  <input type="tex
+0003ec70: 7422 2069 643d 227b 307d 5f6d 696e 2220  t" id="{0}_min" 
+0003ec80: 6e61 6d65 3d22 7b30 7d5f 6d69 6e22 2073  name="{0}_min" s
+0003ec90: 7479 6c65 3d22 7769 6474 683a 3330 7078  tyle="width:30px
+0003eca0: 3b22 3e20 3c69 6e70 7574 2074 7970 653d  ;"> <input type=
+0003ecb0: 2274 6578 7422 2069 643d 227b 307d 5f6d  "text" id="{0}_m
+0003ecc0: 6178 2220 6e61 6d65 3d22 7b30 7d5f 6d61  ax" name="{0}_ma
+0003ecd0: 7822 2073 7479 6c65 3d22 7769 6474 683a  x" style="width:
+0003ece0: 3330 7078 3b22 3e27 2e66 6f72 6d61 7428  30px;">'.format(
+0003ecf0: 636f 6c29 290a 0a20 2020 2020 2020 2020  col))..         
+0003ed00: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+0003ed10: 725f 6c69 6e65 7320 2b3d 2027 3c74 723e  r_lines += '<tr>
+0003ed20: 203c 7464 3e20 3c69 6e70 7574 2074 7970   <td> <input typ
+0003ed30: 653d 2274 6578 7422 2069 643d 227b 307d  e="text" id="{0}
+0003ed40: 5f6d 696e 2220 6e61 6d65 3d22 7b30 7d5f  _min" name="{0}_
+0003ed50: 6d69 6e22 2073 7479 6c65 3d22 7769 6474  min" style="widt
+0003ed60: 683a 3430 7078 3b22 3e20 2623 3630 3b20  h:40px;"> &#60; 
+0003ed70: 3c2f 7464 3e20 3c74 643e 207b 307d 203c  </td> <td> {0} <
+0003ed80: 2f74 643e 203c 7464 3e20 2026 2336 303b  /td> <td>  &#60;
+0003ed90: 203c 696e 7075 7420 7479 7065 3d22 7465   <input type="te
+0003eda0: 7874 2220 6964 3d22 7b30 7d5f 6d61 7822  xt" id="{0}_max"
+0003edb0: 206e 616d 653d 227b 307d 5f6d 6178 2220   name="{0}_max" 
+0003edc0: 7374 796c 653d 2277 6964 7468 3a34 3070  style="width:40p
+0003edd0: 783b 223e 272e 666f 726d 6174 2863 6f6c  x;">'.format(col
+0003ede0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003edf0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0003ee00: 2020 2020 2020 2020 2020 2064 6573 6372             descr
+0003ee10: 203d 2027 5c6e 270a 2020 2020 2020 2020   = '\n'.        
+0003ee20: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0003ee30: 6173 6174 7472 2873 656c 662e 636f 6c75  asattr(self.colu
+0003ee40: 6d6e 735b 636f 6c5d 2c20 2764 6573 6372  mns[col], 'descr
+0003ee50: 6970 7469 6f6e 2729 3a0a 2020 2020 2020  iption'):.      
+0003ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ee70: 2020 6966 2073 656c 662e 636f 6c75 6d6e    if self.column
+0003ee80: 735b 636f 6c5d 2e64 6573 6372 6970 7469  s[col].descripti
+0003ee90: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
+0003eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eeb0: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+0003eec0: 7220 3d20 277b 307d 207b 317d 5c6e 272e  r = '{0} {1}\n'.
+0003eed0: 666f 726d 6174 2864 6573 6372 5f70 6164  format(descr_pad
+0003eee0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0003eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003ef10: 656c 662e 636f 6c75 6d6e 735b 636f 6c5d  elf.columns[col]
+0003ef20: 2e64 6573 6372 6970 7469 6f6e 290a 2020  .description).  
+0003ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef60: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0003ef70: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+0003ef80: 725f 6c69 6e65 7320 2b3d 2064 6573 6372  r_lines += descr
+0003ef90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003efa0: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+0003efb0: 2069 635f 6c69 7374 3a0a 2020 2020 2020   ic_list:.      
+0003efc0: 2020 2020 2020 2320 496e 7365 7274 2069        # Insert i
+0003efd0: 6e70 7574 206c 696e 6573 0a0a 2020 2020  nput lines..    
+0003efe0: 2020 2020 2020 2020 666f 7220 696c 2c20          for il, 
+0003eff0: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
+0003f000: 6528 6c69 6e65 7329 3a0a 2020 2020 2020  e(lines):.      
+0003f010: 2020 2020 2020 2020 2020 6966 2027 7d20            if '} 
+0003f020: 293b 2020 3c2f 7363 7269 7074 3e27 2069  );  </script>' i
+0003f030: 6e20 6c69 6e65 3a0a 2020 2020 2020 2020  n line:.        
+0003f040: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0003f050: 6b0a 2020 2020 2020 2020 2020 2020 0a20  k.            . 
+0003f060: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+0003f070: 725f 726f 7720 3d20 273c 7472 3e20 3c74  r_row = '<tr> <t
+0003f080: 643e 203c 696e 7075 7420 7479 7065 3d22  d> <input type="
+0003f090: 7465 7874 2220 6964 3d22 7b30 7d5f 6d69  text" id="{0}_mi
+0003f0a0: 6e22 206e 616d 653d 227b 307d 5f6d 696e  n" name="{0}_min
+0003f0b0: 2220 7374 796c 653d 2277 6964 7468 3a34  " style="width:4
+0003f0c0: 3070 783b 223e 2026 2336 303b 203c 2f74  0px;"> &#60; </t
+0003f0d0: 643e 203c 7464 2073 7479 6c65 3d22 616c  d> <td style="al
+0003f0e0: 6967 6e3a 6365 6e74 6572 3b22 3e20 3c74  ign:center;"> <t
+0003f0f0: 743e 7b30 7d3c 2f74 743e 203c 2f74 643e  t>{0}</tt> </td>
+0003f100: 203c 7464 3e20 2026 2336 303b 203c 696e   <td>  &#60; <in
+0003f110: 7075 7420 7479 7065 3d22 7465 7874 2220  put type="text" 
+0003f120: 6964 3d22 7b30 7d5f 6d61 7822 206e 616d  id="{0}_max" nam
+0003f130: 653d 227b 307d 5f6d 6178 2220 7374 796c  e="{0}_max" styl
+0003f140: 653d 2277 6964 7468 3a34 3070 783b 223e  e="width:40px;">
+0003f150: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
+0003f160: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+0003f170: 725f 726f 7773 203d 205b 5d0a 2020 2020  r_rows = [].    
+0003f180: 2020 2020 2020 2020 666f 7220 6963 2069          for ic i
+0003f190: 6e20 6963 5f6c 6973 743a 0a20 2020 2020  n ic_list:.     
+0003f1a0: 2020 2020 2020 2020 2020 2063 6f6c 203d             col =
+0003f1b0: 2073 656c 662e 636f 6c6e 616d 6573 5b69   self.colnames[i
+0003f1c0: 635d 0a20 2020 2020 2020 2020 2020 2020  c].             
+0003f1d0: 2020 2072 6f77 5f69 203d 2066 696c 7465     row_i = filte
+0003f1e0: 725f 726f 772e 666f 726d 6174 2863 6f6c  r_row.format(col
+0003f1f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003f200: 2020 6465 7363 7220 3d20 275c 6e27 0a20    descr = '\n'. 
+0003f210: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003f220: 6620 6861 7361 7474 7228 7365 6c66 2e63  f hasattr(self.c
+0003f230: 6f6c 756d 6e73 5b63 6f6c 5d2c 2027 6465  olumns[col], 'de
+0003f240: 7363 7269 7074 696f 6e27 293a 0a20 2020  scription'):.   
+0003f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f260: 2069 6620 7365 6c66 2e63 6f6c 756d 6e73   if self.columns
+0003f270: 5b63 6f6c 5d2e 6465 7363 7269 7074 696f  [col].descriptio
+0003f280: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
+0003f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2a0: 2020 2020 2020 2064 6573 6372 203d 2027         descr = '
+0003f2b0: 7b30 7d20 7b31 7d5c 6e27 2e66 6f72 6d61  {0} {1}\n'.forma
+0003f2c0: 7428 6465 7363 725f 7061 642c 200a 2020  t(descr_pad, .  
+0003f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2f0: 2020 2020 2020 7365 6c66 2e63 6f6c 756d        self.colum
+0003f300: 6e73 5b63 6f6c 5d2e 6465 7363 7269 7074  ns[col].descript
+0003f310: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+0003f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f340: 6966 2027 7061 6765 4c65 6e67 7468 2720  if 'pageLength' 
-0003f350: 696e 206c 696e 653a 0a20 2020 2020 2020  in line:.       
-0003f360: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0003f370: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0003f380: 616a 6178 5f63 616c 6c20 3d20 277b 7370  ajax_call = '{sp
-0003f390: 6163 6572 7d22 616a 6178 223a 2022 7b6a  acer}"ajax": "{j
-0003f3a0: 736f 6e7d 222c 5c6e 7b73 7061 6365 727d  son}",\n{spacer}
-0003f3b0: 2264 6566 6572 5265 6e64 6572 223a 2074  "deferRender": t
-0003f3c0: 7275 652c 5c6e 272e 666f 726d 6174 2873  rue,\n'.format(s
-0003f3d0: 7061 6365 723d 2720 272a 382c 206a 736f  pacer=' '*8, jso
-0003f3e0: 6e3d 6f75 7470 7574 2e72 6570 6c61 6365  n=output.replace
-0003f3f0: 2827 2e68 746d 6c27 2c20 272e 6a73 6f6e  ('.html', '.json
-0003f400: 2729 290a 2020 2020 2020 2020 2020 2020  ')).            
-0003f410: 6c69 6e65 732e 696e 7365 7274 2869 6c2b  lines.insert(il+
-0003f420: 312c 2061 6a61 785f 6361 6c6c 290a 0a20  1, ajax_call).. 
-0003f430: 2020 2020 2020 2020 2020 2023 2053 7472             # Str
-0003f440: 6970 206f 7574 2074 6162 6c65 2062 6f64  ip out table bod
-0003f450: 790a 2020 2020 2020 2020 2020 2020 666f  y.            fo
-0003f460: 7220 6968 6561 642c 206c 696e 6520 696e  r ihead, line in
-0003f470: 2065 6e75 6d65 7261 7465 286c 696e 6573   enumerate(lines
-0003f480: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003f490: 2020 2069 6620 273c 2f74 6865 6164 3e27     if '</thead>'
-0003f4a0: 2069 6e20 6c69 6e65 3a0a 2020 2020 2020   in line:.      
-0003f4b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0003f4c0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
-0003f4d0: 2066 6f72 2069 7461 696c 2c20 6c69 6e65   for itail, line
-0003f4e0: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
-0003f4f0: 6e65 735b 3a3a 2d31 5d29 3a0a 2020 2020  nes[::-1]):.    
-0003f500: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-0003f510: 3c2f 7472 3e27 2069 6e20 6c69 6e65 3a0a  </tr>' in line:.
-0003f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f530: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003f540: 2020 2020 2020 2066 7020 3d20 6f70 656e         fp = open
-0003f550: 286f 7574 7075 742c 2027 7727 290a 2020  (output, 'w').  
-0003f560: 2020 2020 2020 2020 2020 6670 2e77 7269            fp.wri
-0003f570: 7465 6c69 6e65 7328 6c69 6e65 735b 3a69  telines(lines[:i
-0003f580: 6865 6164 2b31 5d29 0a20 2020 2020 2020  head+1]).       
-0003f590: 2020 2020 2066 702e 7772 6974 656c 696e       fp.writelin
-0003f5a0: 6573 286c 696e 6573 5b2d 6974 6169 6c3a  es(lines[-itail:
-0003f5b0: 5d29 0a20 2020 2020 2020 2020 2020 2066  ]).            f
-0003f5c0: 702e 636c 6f73 6528 290a 0a0a 6465 6620  p.close()...def 
-0003f5d0: 636f 6c75 6d6e 5f73 7472 696e 675f 6f70  column_string_op
-0003f5e0: 6572 6174 696f 6e28 636f 6c2c 2074 6573  eration(col, tes
-0003f5f0: 742c 206d 6574 686f 643d 2763 6f6e 7461  t, method='conta
-0003f600: 696e 7327 2c20 6c6f 6769 6361 6c3d 276f  ins', logical='o
-0003f610: 7227 293a 0a20 2020 2022 2222 0a20 2020  r'):.    """.   
-0003f620: 2041 6e61 6c6f 676f 7573 2074 6f20 6060   Analogous to ``
-0003f630: 7374 722e 636f 6e74 6169 6e73 6060 2062  str.contains`` b
-0003f640: 7574 2066 6f72 2074 6162 6c65 2063 6f6c  ut for table col
-0003f650: 756d 6e2e 0a0a 2020 2020 5061 7261 6d65  umn...    Parame
-0003f660: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-0003f670: 2d2d 2d0a 2020 2020 636f 6c20 3a20 6974  ---.    col : it
-0003f680: 6572 6162 6c65 206c 6973 7420 6f66 2073  erable list of s
-0003f690: 7472 696e 6773 0a20 2020 2020 2020 204c  trings.        L
-0003f6a0: 6973 7420 6f66 2073 7472 696e 6773 2074  ist of strings t
-0003f6b0: 6f20 7465 7374 2e20 2041 6e79 7468 696e  o test.  Anythin
-0003f6c0: 6720 6974 6572 6162 6c65 2c20 652e 672e  g iterable, e.g.
-0003f6d0: 2c20 6c69 7374 206f 7220 0a20 2020 2020  , list or .     
-0003f6e0: 2020 2060 7e61 7374 726f 7079 2e74 6162     `~astropy.tab
-0003f6f0: 6c65 2e63 6f6c 756d 6e2e 436f 6c75 6d6e  le.column.Column
-0003f700: 602e 0a0a 2020 2020 7465 7374 203a 2073  `...    test : s
-0003f710: 7472 2c20 6c69 7374 206f 6620 7374 7269  tr, list of stri
-0003f720: 6e67 732c 204e 6f6e 652c 206f 7220 736c  ngs, None, or sl
-0003f730: 6963 650a 0a20 2020 2020 2020 2049 6620  ice..        If 
-0003f740: 6060 7465 7374 6060 2069 7320 6120 7374  ``test`` is a st
-0003f750: 7269 6e67 2c20 6f72 206c 6973 7420 6f66  ring, or list of
-0003f760: 2073 7472 696e 6773 2c20 7468 656e 2072   strings, then r
-0003f770: 756e 2074 6865 2073 7472 696e 670a 2020  un the string.  
-0003f780: 2020 2020 2020 6060 6d65 7468 6f64 6060        ``method``
-0003f790: 206f 6e20 6561 6368 2065 6e74 7279 206f   on each entry o
-0003f7a0: 6620 6060 636f 6c60 6020 7769 7468 2060  f ``col`` with `
-0003f7b0: 6074 6573 7460 6020 6173 2074 6865 2061  `test`` as the a
-0003f7c0: 7267 756d 656e 7420 6f72 0a20 2020 2020  rgument or.     
-0003f7d0: 2020 2065 6163 6820 656c 656d 656e 7420     each element 
-0003f7e0: 6f66 2074 6865 2060 6074 6573 7460 6020  of the ``test`` 
-0003f7f0: 6c69 7374 2061 7320 6172 6775 6d65 6e74  list as argument
-0003f800: 732e 0a0a 2020 2020 2020 2020 4966 2060  s...        If `
-0003f810: 6074 6573 7460 6020 6973 204e 6f6e 652c  `test`` is None,
-0003f820: 2072 756e 2060 6d65 7468 6f64 6020 6f6e   run `method` on
-0003f830: 2065 6163 6820 656e 7472 7920 7769 7468   each entry with
-0003f840: 206e 6f20 6172 6775 6d65 6e74 732c 200a   no arguments, .
-0003f850: 2020 2020 2020 2020 652e 672e 2c20 2775          e.g., 'u
-0003f860: 7070 6572 272e 0a0a 2020 2020 2020 2020  pper'...        
-0003f870: 4966 2060 6074 6573 7460 6020 6973 2061  If ``test`` is a
-0003f880: 2060 6073 6c69 6365 6060 2c20 7265 7475   ``slice``, retu
-0003f890: 726e 2073 6c69 6365 6420 7374 7269 6e67  rn sliced string
-0003f8a0: 7320 666f 7220 6561 6368 2065 6e74 7279  s for each entry
-0003f8b0: 2e0a 0a20 2020 206d 6574 686f 6420 3a20  ...    method : 
-0003f8c0: 7374 720a 2020 2020 2020 2020 5374 7269  str.        Stri
-0003f8d0: 6e67 206d 6574 686f 6420 746f 2061 7070  ng method to app
-0003f8e0: 6c79 2074 6f20 6561 6368 2065 6e74 7279  ly to each entry
-0003f8f0: 206f 6620 6060 636f 6c60 602e 2020 452e   of ``col``.  E.
-0003f900: 672e 2c20 2763 6f6e 7461 696e 7327 2c0a  g., 'contains',.
-0003f910: 2020 2020 2020 2020 2773 7461 7274 7377          'startsw
-0003f920: 6974 6827 2c20 2765 6e64 7377 6974 6827  ith', 'endswith'
-0003f930: 2c20 2769 6e64 6578 272e 0a0a 2020 2020  , 'index'...    
-0003f940: 6c6f 6769 6361 6c20 3a20 5b27 6f72 272c  logical : ['or',
-0003f950: 2761 6e64 272c 276e 6f74 275d 0a20 2020  'and','not'].   
-0003f960: 2020 2020 204c 6f67 6963 616c 2074 6573       Logical tes
-0003f970: 7420 746f 2075 7365 2077 6865 6e20 6060  t to use when ``
-0003f980: 7465 7374 6060 2069 7320 6120 6c69 7374  test`` is a list
-0003f990: 206f 6620 7374 7269 6e67 732e 2020 466f   of strings.  Fo
-0003f9a0: 7220 6578 616d 706c 652c 0a20 2020 2020  r example,.     
-0003f9b0: 2020 2069 6620 796f 7520 7761 6e74 2074     if you want t
-0003f9c0: 6f20 7465 7374 2069 6620 7468 6520 636f  o test if the co
-0003f9d0: 6c75 6d6e 2068 6173 2076 616c 7565 7320  lumn has values 
-0003f9e0: 7468 6174 206d 6174 6368 2065 6974 6865  that match eithe
-0003f9f0: 720a 2020 2020 2020 2020 2776 616c 7565  r.        'value
-0003fa00: 3127 206f 7220 2776 616c 7565 3227 2c20  1' or 'value2', 
-0003fa10: 7468 656e 2072 756e 2077 6974 680a 0a20  then run with.. 
-0003fa20: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
-0003fa30: 6573 203d 2063 6f6c 756d 6e5f 746f 5f73  es = column_to_s
-0003fa40: 7472 696e 675f 6f70 6572 6174 696f 6e28  tring_operation(
-0003fa50: 636f 6c2c 205b 2776 616c 7565 3127 2c27  col, ['value1','
-0003fa60: 7661 6c75 6532 275d 2c20 6d65 7468 6f64  value2'], method
-0003fa70: 3d27 636f 6e74 6169 6e73 272c 206c 6f67  ='contains', log
-0003fa80: 6963 616c 3d27 6f72 2729 0a0a 2020 2020  ical='or')..    
-0003fa90: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-0003faa0: 2d2d 2d0a 2020 2020 7265 7375 6c74 203a  ---.    result :
-0003fab0: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
-0003fac0: 7374 206f 6620 6974 6572 6174 6564 2072  st of iterated r
-0003fad0: 6573 756c 7473 206f 6e20 7468 6520 656e  esults on the en
-0003fae0: 7472 6965 7320 6f66 2060 6063 6f6c 6060  tries of ``col``
-0003faf0: 2c20 652e 672e 2c20 6c69 7374 206f 6620  , e.g., list of 
-0003fb00: 0a20 2020 2020 2020 2060 6062 6f6f 6c60  .        ``bool`
-0003fb10: 6020 6f72 2060 6073 7472 696e 6760 602e  ` or ``string``.
-0003fb20: 0a0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-0003fb30: 2069 7369 6e73 7461 6e63 6528 7465 7374   isinstance(test
-0003fb40: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
-0003fb50: 2074 6573 745f 6c69 7374 203d 2074 6573   test_list = tes
-0003fb60: 740a 2020 2020 656c 7365 3a0a 2020 2020  t.    else:.    
-0003fb70: 2020 2020 7465 7374 5f6c 6973 7420 3d20      test_list = 
-0003fb80: 5b74 6573 745d 0a0a 2020 2020 6f75 745f  [test]..    out_
-0003fb90: 7465 7374 203d 205b 5d0a 0a20 2020 2066  test = []..    f
-0003fba0: 6f72 2069 2c20 635f 6920 696e 2065 6e75  or i, c_i in enu
-0003fbb0: 6d65 7261 7465 2863 6f6c 293a 0a20 2020  merate(col):.   
-0003fbc0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0003fbd0: 6365 2874 6573 742c 2073 6c69 6365 293a  ce(test, slice):
-0003fbe0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0003fbf0: 5f74 6573 742e 6170 7065 6e64 2863 5f69  _test.append(c_i
-0003fc00: 5b74 6573 745d 290a 2020 2020 2020 2020  [test]).        
-0003fc10: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0003fc20: 2020 2020 2020 6675 6e63 203d 2067 6574        func = get
-0003fc30: 6174 7472 2863 5f69 2c20 6d65 7468 6f64  attr(c_i, method
-0003fc40: 290a 2020 2020 2020 2020 6966 2074 6573  ).        if tes
-0003fc50: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
-0003fc60: 2020 2020 2020 206f 7574 5f74 6573 742e         out_test.
-0003fc70: 6170 7065 6e64 2866 756e 6328 2929 0a20  append(func()). 
-0003fc80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003fc90: 6e75 650a 0a20 2020 2020 2020 206c 6973  nue..        lis
-0003fca0: 745f 6920 3d20 5b5d 0a20 2020 2020 2020  t_i = [].       
-0003fcb0: 2066 6f72 2074 5f69 2069 6e20 7465 7374   for t_i in test
-0003fcc0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-0003fcd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0003fce0: 2020 2020 2020 2020 6c69 7374 5f69 2e61          list_i.a
-0003fcf0: 7070 656e 6428 6675 6e63 2874 5f69 2929  ppend(func(t_i))
-0003fd00: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0003fd10: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0003fd20: 2020 2020 206c 6973 745f 692e 6170 7065       list_i.appe
-0003fd30: 6e64 2846 616c 7365 290a 0a20 2020 2020  nd(False)..     
-0003fd40: 2020 206f 7574 5f74 6573 742e 6170 7065     out_test.appe
-0003fd50: 6e64 286c 6973 745f 6929 0a0a 2020 2020  nd(list_i)..    
-0003fd60: 6172 7220 3d20 6e70 2e61 7272 6179 286f  arr = np.array(o
-0003fd70: 7574 5f74 6573 7429 0a20 2020 2073 6820  ut_test).    sh 
-0003fd80: 3d20 6172 722e 7368 6170 650a 0a20 2020  = arr.shape..   
-0003fd90: 2069 6620 6c6f 6769 6361 6c20 6973 204e   if logical is N
-0003fda0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-0003fdb0: 7572 6e20 6e70 2e73 7175 6565 7a65 2861  urn np.squeeze(a
-0003fdc0: 7272 290a 2020 2020 656c 6966 206c 6f67  rr).    elif log
-0003fdd0: 6963 616c 2e75 7070 6572 2829 203d 3d20  ical.upper() == 
-0003fde0: 2741 4e44 273a 0a20 2020 2020 2020 2072  'AND':.        r
-0003fdf0: 6574 7572 6e20 6e70 2e73 756d 2861 7272  eturn np.sum(arr
-0003fe00: 2c20 6178 6973 3d31 2920 3e3d 2073 685b  , axis=1) >= sh[
-0003fe10: 315d 0a20 2020 2065 6c69 6620 6c6f 6769  1].    elif logi
-0003fe20: 6361 6c2e 7570 7065 7228 2920 3d3d 2027  cal.upper() == '
-0003fe30: 4e4f 5427 3a0a 2020 2020 2020 2020 7265  NOT':.        re
-0003fe40: 7475 726e 206e 702e 7375 6d28 6172 722c  turn np.sum(arr,
-0003fe50: 2061 7869 733d 3129 203d 3d20 300a 2020   axis=1) == 0.  
-0003fe60: 2020 656c 7365 3a20 2023 204f 520a 2020    else:  # OR.  
-0003fe70: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
-0003fe80: 7375 6d28 6172 722c 2061 7869 733d 3129  sum(arr, axis=1)
-0003fe90: 203e 2030 0a0a 0a64 6566 2063 6f6c 756d   > 0...def colum
-0003fea0: 6e5f 7661 6c75 6573 5f69 6e5f 6c69 7374  n_values_in_list
-0003feb0: 2863 6f6c 2c20 7465 7374 5f6c 6973 7429  (col, test_list)
-0003fec0: 3a0a 2020 2020 2222 2254 6573 7420 6966  :.    """Test if
-0003fed0: 2063 6f6c 756d 6e20 656c 656d 656e 7473   column elements
-0003fee0: 2022 696e 2220 616e 2069 7465 7261 626c   "in" an iterabl
-0003fef0: 6520 2865 2e67 2e2c 2061 206c 6973 7420  e (e.g., a list 
-0003ff00: 6f66 2073 7472 696e 6773 290a 0a20 2020  of strings)..   
-0003ff10: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0003ff20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-0003ff30: 6f6c 203a 2060 6173 7472 6f70 792e 7461  ol : `astropy.ta
-0003ff40: 626c 652e 436f 6c75 6d6e 6020 6f72 206f  ble.Column` or o
-0003ff50: 7468 6572 2069 7465 7261 626c 650a 2020  ther iterable.  
-0003ff60: 2020 2020 2020 4772 6f75 7020 6f66 2065        Group of e
-0003ff70: 6e74 7269 6573 2074 6f20 7465 7374 0a0a  ntries to test..
-0003ff80: 2020 2020 7465 7374 5f6c 6973 7420 3a20      test_list : 
-0003ff90: 6974 6572 6162 6c65 0a20 2020 2020 2020  iterable.       
-0003ffa0: 204c 6973 7420 6f66 2076 616c 7565 7320   List of values 
-0003ffb0: 746f 2073 6561 7263 680a 0a20 2020 2052  to search..    R
-0003ffc0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-0003ffd0: 2d2d 0a20 2020 2074 6573 7420 3a20 626f  --.    test : bo
-0003ffe0: 6f6c 2061 7272 6179 0a20 2020 2020 2020  ol array.       
-0003fff0: 2053 696d 706c 6520 7465 7374 3a0a 2020   Simple test:.  
-00040000: 2020 2020 2020 2020 2020 3e3e 3e20 5b63            >>> [c
-00040010: 5f69 2069 6e20 7465 7374 5f6c 6973 7420  _i in test_list 
-00040020: 666f 7220 635f 6920 696e 2063 6f6c 5d0a  for c_i in col].
-00040030: 2020 2020 2222 220a 2020 2020 7465 7374      """.    test
-00040040: 203d 206e 702e 6172 7261 7928 5b63 5f69   = np.array([c_i
-00040050: 2069 6e20 7465 7374 5f6c 6973 7420 666f   in test_list fo
-00040060: 7220 635f 6920 696e 2063 6f6c 5d29 0a20  r c_i in col]). 
-00040070: 2020 2072 6574 7572 6e20 7465 7374 0a0a     return test..
-00040080: 0a64 6566 2066 696c 6c5f 6265 7477 6565  .def fill_betwee
-00040090: 6e5f 7374 6570 7328 782c 2079 302c 2079  n_steps(x, y0, y
-000400a0: 312c 2061 783d 4e6f 6e65 2c20 2a61 7267  1, ax=None, *arg
-000400b0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-000400c0: 2020 2222 220a 2020 2020 4d61 6b65 2060    """.    Make `
-000400d0: 6669 6c6c 5f62 6574 7765 656e 6020 776f  fill_between` wo
-000400e0: 726b 206c 696b 6520 6c69 6e65 7374 796c  rk like linestyl
-000400f0: 653d 2773 7465 7073 2d6d 6964 272e 0a20  e='steps-mid'.. 
-00040100: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
-00040110: 7420 6d61 7470 6c6f 746c 6962 2e70 7970  t matplotlib.pyp
-00040120: 6c6f 7420 6173 2070 6c74 0a20 2020 200a  lot as plt.    .
-00040130: 2020 2020 736f 203d 206e 702e 6172 6773      so = np.args
-00040140: 6f72 7428 7829 0a20 2020 2064 7820 3d20  ort(x).    dx = 
-00040150: 6e70 2e64 6966 6628 785b 736f 5d29 2f32  np.diff(x[so])/2
-00040160: 2e0a 2020 2020 6d69 6420 3d20 785b 736f  ..    mid = x[so
-00040170: 5d5b 3a2d 315d 202b 2064 780a 2020 2020  ][:-1] + dx.    
-00040180: 0a20 2020 2078 6675 6c6c 203d 206e 702e  .    xfull = np.
-00040190: 6873 7461 636b 285b 785b 736f 5d5b 305d  hstack([x[so][0]
-000401a0: 2d64 785b 305d 2c20 6d69 642c 206d 6964  -dx[0], mid, mid
-000401b0: 2b64 782a 322f 312e 6536 2c20 785b 736f  +dx*2/1.e6, x[so
-000401c0: 5d5b 2d31 5d2b 6478 5b2d 315d 5d29 0a20  ][-1]+dx[-1]]). 
-000401d0: 2020 2079 3066 756c 6c20 3d20 6e70 2e68     y0full = np.h
-000401e0: 7374 6163 6b28 5b79 305b 305d 2c20 7930  stack([y0[0], y0
-000401f0: 5b3a 2d31 5d2c 2079 305b 313a 5d2c 2079  [:-1], y0[1:], y
-00040200: 305b 2d31 5d5d 290a 2020 2020 7931 6675  0[-1]]).    y1fu
-00040210: 6c6c 203d 206e 702e 6873 7461 636b 285b  ll = np.hstack([
-00040220: 7931 5b30 5d2c 2079 315b 3a2d 315d 2c20  y1[0], y1[:-1], 
-00040230: 7931 5b31 3a5d 2c20 7931 5b2d 315d 5d29  y1[1:], y1[-1]])
-00040240: 0a20 2020 200a 2020 2020 2320 7866 756c  .    .    # xful
-00040250: 6c20 3d20 6e70 2e61 7070 656e 6428 6e70  l = np.append(np
-00040260: 2e61 7070 656e 6428 782c 206d 6964 292c  .append(x, mid),
-00040270: 206d 6964 2b6e 702e 6469 6666 2878 5b73   mid+np.diff(x[s
-00040280: 6f5d 292f 312e 6536 290a 2020 2020 2320  o])/1.e6).    # 
-00040290: 7930 6675 6c6c 203d 206e 702e 6170 7065  y0full = np.appe
-000402a0: 6e64 286e 702e 6170 7065 6e64 2879 302c  nd(np.append(y0,
-000402b0: 2079 305b 3a2d 315d 292c 2079 305b 313a   y0[:-1]), y0[1:
-000402c0: 5d29 0a20 2020 2023 2079 3166 756c 6c20  ]).    # y1full 
-000402d0: 3d20 6e70 2e61 7070 656e 6428 6e70 2e61  = np.append(np.a
-000402e0: 7070 656e 6428 7931 2c20 7931 5b3a 2d31  ppend(y1, y1[:-1
-000402f0: 5d29 2c20 7931 5b31 3a5d 290a 0a20 2020  ]), y1[1:])..   
-00040300: 2073 6f20 3d20 6e70 2e61 7267 736f 7274   so = np.argsort
-00040310: 2878 6675 6c6c 290a 2020 2020 6966 2061  (xfull).    if a
-00040320: 7820 6973 204e 6f6e 653a 0a20 2020 2020  x is None:.     
-00040330: 2020 2061 7820 3d20 706c 742e 6763 6128     ax = plt.gca(
-00040340: 290a 0a20 2020 2061 782e 6669 6c6c 5f62  )..    ax.fill_b
-00040350: 6574 7765 656e 2878 6675 6c6c 5b73 6f5d  etween(xfull[so]
-00040360: 2c20 7930 6675 6c6c 5b73 6f5d 2c20 7931  , y0full[so], y1
-00040370: 6675 6c6c 5b73 6f5d 2c20 2a61 7267 732c  full[so], *args,
-00040380: 202a 2a6b 7761 7267 7329 0a0a 0a64 6566   **kwargs)...def
-00040390: 2066 696c 6c5f 6d61 736b 6564 5f63 6f76   fill_masked_cov
-000403a0: 6172 2863 6f76 6172 2c20 6d61 736b 293a  ar(covar, mask):
-000403b0: 0a20 2020 2022 2222 4669 6c6c 2061 2063  .    """Fill a c
-000403c0: 6f76 6172 6961 6e63 6520 6d61 7472 6978  ovariance matrix
-000403d0: 2069 6e20 6120 6c61 7267 6572 2061 7272   in a larger arr
-000403e0: 6179 2074 6861 7420 6861 6420 6d61 736b  ay that had mask
-000403f0: 6564 2076 616c 7565 730a 0a20 2020 2050  ed values..    P
-00040400: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00040410: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6f76  --------.    cov
-00040420: 6172 203a 2060 284d 2c4d 2960 2073 7175  ar : `(M,M)` squ
-00040430: 6172 6520 607e 6e70 2e6e 6461 7272 6179  are `~np.ndarray
-00040440: 600a 2020 2020 2020 2020 4d61 736b 6564  `.        Masked
-00040450: 2063 6f76 6172 6961 6e63 6520 6172 7261   covariance arra
-00040460: 792e 0a0a 2020 2020 6d61 736b 203a 2062  y...    mask : b
-00040470: 6f6f 6c20 6d61 736b 2c20 604e 3e4d 600a  ool mask, `N>M`.
-00040480: 2020 2020 2020 2020 5468 6520 6f72 6967          The orig
-00040490: 696e 616c 206d 6173 6b2e 0a0a 2020 2020  inal mask...    
-000404a0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-000404b0: 2d2d 2d0a 2020 2020 636f 7661 725f 6675  ---.    covar_fu
-000404c0: 6c6c 203a 2060 7e6e 702e 6e64 6172 7261  ll : `~np.ndarra
-000404d0: 7960 0a20 2020 2020 2020 2046 756c 6c20  y`.        Full 
-000404e0: 636f 7661 7269 616e 6365 2061 7272 6179  covariance array
-000404f0: 2077 6974 6820 6469 6d65 6e73 696f 6e73   with dimensions
-00040500: 2060 284e 2c4e 2960 2e0a 0a20 2020 2022   `(N,N)`...    "
-00040510: 2222 0a20 2020 204e 203d 206d 6173 6b2e  "".    N = mask.
-00040520: 7368 6170 655b 305d 0a20 2020 2069 6478  shape[0].    idx
-00040530: 203d 206e 702e 6172 616e 6765 284e 295b   = np.arange(N)[
-00040540: 6d61 736b 5d0a 2020 2020 636f 7661 725f  mask].    covar_
-00040550: 6675 6c6c 203d 206e 702e 7a65 726f 7328  full = np.zeros(
-00040560: 284e 2c20 4e29 2c20 6474 7970 653d 636f  (N, N), dtype=co
-00040570: 7661 722e 6474 7970 6529 0a20 2020 2066  var.dtype).    f
-00040580: 6f72 2069 2c20 6969 2069 6e20 656e 756d  or i, ii in enum
-00040590: 6572 6174 6528 6964 7829 3a0a 2020 2020  erate(idx):.    
-000405a0: 2020 2020 666f 7220 6a2c 206a 6a20 696e      for j, jj in
-000405b0: 2065 6e75 6d65 7261 7465 2869 6478 293a   enumerate(idx):
-000405c0: 0a20 2020 2020 2020 2020 2020 2063 6f76  .            cov
-000405d0: 6172 5f66 756c 6c5b 6969 2c20 6a6a 5d20  ar_full[ii, jj] 
-000405e0: 3d20 636f 7661 725b 692c 206a 5d0a 0a20  = covar[i, j].. 
-000405f0: 2020 2072 6574 7572 6e20 636f 7661 725f     return covar_
-00040600: 6675 6c6c 0a0a 0a64 6566 206c 6f67 5f73  full...def log_s
-00040610: 6361 6c65 5f64 7339 2869 6d2c 206c 6578  cale_ds9(im, lex
-00040620: 703d 312e 6531 322c 2063 6d61 703d 5b37  p=1.e12, cmap=[7
-00040630: 2e39 3739 3137 2c20 302e 3837 3830 3439  .97917, 0.878049
-00040640: 335d 2c20 7363 616c 653d 5b2d 302e 312c  3], scale=[-0.1,
-00040650: 2031 305d 293a 0a20 2020 2022 2222 0a20   10]):.    """. 
-00040660: 2020 2053 6361 6c65 2061 6e20 6172 7261     Scale an arra
-00040670: 7920 6c69 6b65 2064 7339 206c 6f67 2073  y like ds9 log s
-00040680: 6361 6c69 6e67 0a20 2020 2022 2222 0a20  caling.    """. 
-00040690: 2020 2069 6d70 6f72 7420 6e75 6d70 7920     import numpy 
-000406a0: 6173 206e 700a 0a20 2020 2063 6f6e 7472  as np..    contr
-000406b0: 6173 742c 2062 6961 7320 3d20 636d 6170  ast, bias = cmap
-000406c0: 0a20 2020 2063 6c69 7020 3d20 286e 702e  .    clip = (np.
-000406d0: 636c 6970 2869 6d2c 2073 6361 6c65 5b30  clip(im, scale[0
-000406e0: 5d2c 2073 6361 6c65 5b31 5d29 2d73 6361  ], scale[1])-sca
-000406f0: 6c65 5b30 5d29 2f28 7363 616c 655b 315d  le[0])/(scale[1]
-00040700: 2d73 6361 6c65 5b30 5d29 0a20 2020 2063  -scale[0]).    c
-00040710: 6c69 705f 6c6f 6720 3d20 6e70 2e63 6c69  lip_log = np.cli
-00040720: 7028 286e 702e 6c6f 6731 3028 6c65 7870  p((np.log10(lexp
-00040730: 2a63 6c69 702b 3129 2f6e 702e 6c6f 6731  *clip+1)/np.log1
-00040740: 3028 6c65 7870 292d 6269 6173 292a 636f  0(lexp)-bias)*co
-00040750: 6e74 7261 7374 2b30 2e35 2c20 302c 2031  ntrast+0.5, 0, 1
-00040760: 290a 0a20 2020 2072 6574 7572 6e20 636c  )..    return cl
-00040770: 6970 5f6c 6f67 0a0a 0a64 6566 206d 6f64  ip_log...def mod
-00040780: 655f 7374 6174 6973 7469 6328 6461 7461  e_statistic(data
-00040790: 2c20 7065 7263 656e 7469 6c65 733d 7261  , percentiles=ra
-000407a0: 6e67 6528 3130 2c20 3931 2c20 3130 2929  nge(10, 91, 10))
-000407b0: 3a0a 2020 2020 2222 220a 2020 2020 4765  :.    """.    Ge
-000407c0: 7420 6d6f 6461 6c20 7661 6c75 6520 6f66  t modal value of
-000407d0: 2061 2064 6973 7472 6962 7574 696f 6e20   a distribution 
-000407e0: 6f66 2064 6174 6120 666f 6c6c 6f77 696e  of data followin
-000407f0: 6720 436f 6e6e 6f72 2065 7420 616c 2e20  g Connor et al. 
-00040800: 3230 3137 0a20 2020 2068 7474 7073 3a2f  2017.    https:/
-00040810: 2f61 7278 6976 2e6f 7267 2f70 6466 2f31  /arxiv.org/pdf/1
-00040820: 3730 392e 3031 3932 352e 7064 660a 0a20  709.01925.pdf.. 
-00040830: 2020 2048 6572 6520 7765 2066 6974 2061     Here we fit a
-00040840: 2073 706c 696e 6520 746f 2074 6865 2063   spline to the c
-00040850: 756d 756c 6174 6976 6520 6469 7374 7269  umulative distri
-00040860: 6275 7469 6f6e 2065 7661 6c75 6174 6564  bution evaluated
-00040870: 2061 7420 6b6e 6f74 730a 2020 2020 7365   at knots.    se
-00040880: 7420 746f 2074 6865 2060 7065 7263 656e  t to the `percen
-00040890: 7469 6c65 7360 206f 6620 7468 6520 6469  tiles` of the di
-000408a0: 7374 7269 6275 7469 6f6e 2074 6f20 696d  stribution to im
-000408b0: 7072 6f76 6520 736d 6f6f 7468 6e65 7373  prove smoothness
-000408c0: 2e0a 2020 2020 2222 220a 2020 2020 6672  ..    """.    fr
-000408d0: 6f6d 2073 6369 7079 2e69 6e74 6572 706f  om scipy.interpo
-000408e0: 6c61 7465 2069 6d70 6f72 7420 556e 6976  late import Univ
-000408f0: 6172 6961 7465 5370 6c69 6e65 2c20 4c53  ariateSpline, LS
-00040900: 5155 6e69 7661 7269 6174 6553 706c 696e  QUnivariateSplin
-00040910: 650a 0a20 2020 2073 6f20 3d20 6e70 2e61  e..    so = np.a
-00040920: 7267 736f 7274 2864 6174 6129 0a20 2020  rgsort(data).   
-00040930: 206f 7264 6572 203d 206e 702e 6172 616e   order = np.aran
-00040940: 6765 286c 656e 2864 6174 6129 290a 2020  ge(len(data)).  
-00040950: 2020 2373 706c 203d 2055 6e69 7661 7269    #spl = Univari
-00040960: 6174 6553 706c 696e 6528 6461 7461 5b73  ateSpline(data[s
-00040970: 6f5d 2c20 6f72 6465 7229 0a0a 2020 2020  o], order)..    
-00040980: 6b6e 6f74 7320 3d20 6e70 2e70 6572 6365  knots = np.perce
-00040990: 6e74 696c 6528 6461 7461 2c20 7065 7263  ntile(data, perc
-000409a0: 656e 7469 6c65 7329 0a20 2020 2064 7820  entiles).    dx 
-000409b0: 3d20 6e70 2e64 6966 6628 6b6e 6f74 7329  = np.diff(knots)
-000409c0: 0a20 2020 206d 6173 6b20 3d20 2864 6174  .    mask = (dat
-000409d0: 615b 736f 5d20 3e3d 206b 6e6f 7473 5b30  a[so] >= knots[0
-000409e0: 5d2d 6478 5b30 5d29 2026 2028 6461 7461  ]-dx[0]) & (data
-000409f0: 5b73 6f5d 203c 3d20 6b6e 6f74 735b 2d31  [so] <= knots[-1
-00040a00: 5d2b 6478 5b2d 315d 290a 2020 2020 7370  ]+dx[-1]).    sp
-00040a10: 6c20 3d20 4c53 5155 6e69 7661 7269 6174  l = LSQUnivariat
-00040a20: 6553 706c 696e 6528 6461 7461 5b73 6f5d  eSpline(data[so]
-00040a30: 5b6d 6173 6b5d 2c20 6f72 6465 725b 6d61  [mask], order[ma
-00040a40: 736b 5d2c 206b 6e6f 7473 2c20 6578 743d  sk], knots, ext=
-00040a50: 277a 6572 6f73 2729 0a0a 2020 2020 6d61  'zeros')..    ma
-00040a60: 736b 203d 2028 6461 7461 5b73 6f5d 203e  sk = (data[so] >
-00040a70: 3d20 6b6e 6f74 735b 305d 2920 2620 2864  = knots[0]) & (d
-00040a80: 6174 615b 736f 5d20 3c3d 206b 6e6f 7473  ata[so] <= knots
-00040a90: 5b2d 315d 290a 2020 2020 6978 203d 2028  [-1]).    ix = (
-00040aa0: 7370 6c28 6461 7461 5b73 6f5d 2c20 6e75  spl(data[so], nu
-00040ab0: 3d31 2c20 6578 743d 277a 6572 6f73 2729  =1, ext='zeros')
-00040ac0: 2a6d 6173 6b29 2e61 7267 6d61 7828 290a  *mask).argmax().
-00040ad0: 2020 2020 6d6f 6465 203d 2064 6174 615b      mode = data[
-00040ae0: 736f 5d5b 6978 5d0a 2020 2020 7265 7475  so][ix].    retu
-00040af0: 726e 206d 6f64 650a 0a0a 6465 6620 6d61  rn mode...def ma
-00040b00: 6b65 5f61 6c66 5f74 656d 706c 6174 6528  ke_alf_template(
-00040b10: 293a 0a20 2020 2022 2222 0a20 2020 204d  ):.    """.    M
-00040b20: 616b 6520 416c 6620 2b20 4653 5053 2074  ake Alf + FSPS t
-00040b30: 656d 706c 6174 650a 2020 2020 2222 220a  emplate.    """.
-00040b40: 2020 2020 696d 706f 7274 2061 6c66 2e61      import alf.a
-00040b50: 6c66 0a20 2020 2069 6d70 6f72 7420 6673  lf.    import fs
-00040b60: 7073 0a0a 2020 2020 7373 7020 3d20 616c  ps..    ssp = al
-00040b70: 662e 616c 662e 416c 6628 290a 0a20 2020  f.alf.Alf()..   
-00040b80: 2073 7020 3d20 6673 7073 2e53 7465 6c6c   sp = fsps.Stell
-00040b90: 6172 506f 7075 6c61 7469 6f6e 287a 636f  arPopulation(zco
-00040ba0: 6e74 696e 756f 7573 3d31 290a 2020 2020  ntinuous=1).    
-00040bb0: 7370 2e70 6172 616d 735b 276c 6f67 7a73  sp.params['logzs
-00040bc0: 6f6c 275d 203d 2030 2e32 0a0a 2020 2020  ol'] = 0.2..    
-00040bd0: 2320 416c 660a 2020 2020 6d20 3d20 7373  # Alf.    m = ss
-00040be0: 702e 6765 745f 6d6f 6465 6c28 696e 5f70  p.get_model(in_p
-00040bf0: 6c61 6365 3d46 616c 7365 2c20 6c6f 6761  lace=False, loga
-00040c00: 6765 3d30 2e39 362c 207a 683d 302e 322c  ge=0.96, zh=0.2,
-00040c10: 206d 6768 3d30 2e32 290a 0a20 2020 2023   mgh=0.2)..    #
-00040c20: 2046 5350 530a 2020 2020 772c 2073 7065   FSPS.    w, spe
-00040c30: 6320 3d20 7370 2e67 6574 5f73 7065 6374  c = sp.get_spect
-00040c40: 7275 6d28 7461 6765 3d31 302a 2a30 2e39  rum(tage=10**0.9
-00040c50: 362c 2070 6572 6161 3d54 7275 6529 0a0a  6, peraa=True)..
-00040c60: 2020 2020 2320 626c 7565 0a20 2020 2062      # blue.    b
-00040c70: 6c75 655f 6e6f 726d 203d 2073 7065 635b  lue_norm = spec[
-00040c80: 7720 3e20 3336 3030 5d5b 305d 202f 206d  w > 3600][0] / m
-00040c90: 5b73 7370 2e77 6176 6520 3e20 3336 3030  [ssp.wave > 3600
-00040ca0: 5d5b 305d 0a20 2020 2072 6564 5f6e 6f72  ][0].    red_nor
-00040cb0: 6d20 3d20 7370 6563 5b77 203e 2031 2e37  m = spec[w > 1.7
-00040cc0: 6534 5d5b 305d 202f 206d 5b73 7370 2e77  e4][0] / m[ssp.w
-00040cd0: 6176 6520 3e20 312e 3765 345d 5b30 5d0a  ave > 1.7e4][0].
-00040ce0: 0a20 2020 2074 656d 706c 7820 3d20 6e70  .    templx = np
-00040cf0: 2e68 7374 6163 6b28 5b77 5b77 203c 2033  .hstack([w[w < 3
-00040d00: 3630 305d 2c20 7373 702e 7761 7665 5b28  600], ssp.wave[(
-00040d10: 7373 702e 7761 7665 203e 2033 3630 3029  ssp.wave > 3600)
-00040d20: 2026 2028 7373 702e 7761 7665 203c 2031   & (ssp.wave < 1
-00040d30: 2e37 6534 295d 2c20 775b 7720 3e20 312e  .7e4)], w[w > 1.
-00040d40: 3765 345d 5d29 0a20 2020 2074 656d 706c  7e4]]).    templ
-00040d50: 7920 3d20 6e70 2e68 7374 6163 6b28 5b73  y = np.hstack([s
-00040d60: 7065 635b 7720 3c20 3336 3030 5d2f 626c  pec[w < 3600]/bl
-00040d70: 7565 5f6e 6f72 6d2c 206d 5b28 7373 702e  ue_norm, m[(ssp.
-00040d80: 7761 7665 203e 2033 3630 3029 2026 2028  wave > 3600) & (
-00040d90: 7373 702e 7761 7665 203c 2031 2e37 6534  ssp.wave < 1.7e4
-00040da0: 295d 2c20 7370 6563 5b77 203e 2031 2e37  )], spec[w > 1.7
-00040db0: 6534 5d2f 7265 645f 6e6f 726d 5d29 0a0a  e4]/red_norm])..
-00040dc0: 2020 2020 6e70 2e73 6176 6574 7874 2827      np.savetxt('
-00040dd0: 616c 665f 5353 502e 6461 7427 2c20 6e70  alf_SSP.dat', np
-00040de0: 2e61 7272 6179 285b 7465 6d70 6c78 2c20  .array([templx, 
-00040df0: 7465 6d70 6c79 5d29 2e54 2c20 666d 743d  temply]).T, fmt=
-00040e00: 2725 2e35 6527 2c20 6865 6164 6572 3d27  '%.5e', header='
-00040e10: 7761 7665 2066 6c75 785c 6e6c 6f67 6167  wave flux\nlogag
-00040e20: 6520 3d20 302e 3936 5c6e 7a68 3d30 2e32  e = 0.96\nzh=0.2
-00040e30: 5c6e 6d67 683d 302e 325c 6e66 7370 733a  \nmgh=0.2\nfsps:
-00040e40: 2077 203c 2033 3630 302c 2077 203e 2031   w < 3600, w > 1
-00040e50: 2e37 6534 2729 0a0a 0a64 6566 2063 6174  .7e4')...def cat
-00040e60: 616c 6f67 5f61 7265 6128 7261 3d5b 5d2c  alog_area(ra=[],
-00040e70: 2064 6563 3d5b 5d2c 206d 616b 655f 706c   dec=[], make_pl
-00040e80: 6f74 3d54 7275 652c 204e 4d41 583d 3530  ot=True, NMAX=50
-00040e90: 3030 2c20 6275 6666 3d30 2e38 2c20 7665  00, buff=0.8, ve
-00040ea0: 7262 6f73 653d 5472 7565 293a 0a20 2020  rbose=True):.   
-00040eb0: 2022 2222 436f 6d70 7574 6520 7468 6520   """Compute the 
-00040ec0: 7375 7266 6163 6520 6172 6561 206f 6620  surface area of 
-00040ed0: 6120 6c69 7374 206f 6620 5241 2f44 4543  a list of RA/DEC
-00040ee0: 2063 6f6f 7264 696e 6174 6573 0a0a 2020   coordinates..  
-00040ef0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00040f00: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00040f10: 7261 2c20 6465 6320 3a20 607e 6e75 6d70  ra, dec : `~nump
-00040f20: 792e 6e64 6172 7261 7960 0a20 2020 2020  y.ndarray`.     
-00040f30: 2020 2052 4120 616e 6420 4465 632e 2063     RA and Dec. c
-00040f40: 6f6f 7264 696e 6174 6573 2069 6e20 6465  oordinates in de
-00040f50: 6369 6d61 6c20 6465 6772 6565 730a 0a20  cimal degrees.. 
-00040f60: 2020 206d 616b 655f 706c 6f74 203a 2062     make_plot : b
-00040f70: 6f6f 6c0a 2020 2020 2020 2020 4d61 6b65  ool.        Make
-00040f80: 2061 2066 6967 7572 652e 0a0a 2020 2020   a figure...    
-00040f90: 4e4d 4158 203a 2069 6e74 0a20 2020 2020  NMAX : int.     
-00040fa0: 2020 2049 6620 7468 6520 6361 7461 6c6f     If the catalo
-00040fb0: 6720 6861 7320 6d6f 7265 2074 6865 6e20  g has more then 
-00040fc0: 604e 4d41 5860 2065 6e74 7269 6573 2c20  `NMAX` entries, 
-00040fd0: 6472 6177 2060 4e4d 4158 6020 7261 6e64  draw `NMAX` rand
-00040fe0: 6f6d 0a20 2020 2020 2020 2073 616d 706c  om.        sampl
-00040ff0: 6573 2e0a 0a20 2020 2062 7566 6620 3a20  es...    buff : 
-00041000: 666c 6f61 740a 2020 2020 2020 2020 4275  float.        Bu
-00041010: 6666 6572 2069 6e20 6172 636d 696e 2074  ffer in arcmin t
-00041020: 6f20 6164 6420 6172 6f75 6e64 2065 6163  o add around eac
-00041030: 6820 6361 7461 6c6f 6720 706f 696e 742e  h catalog point.
-00041040: 0a0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-00041050: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2061     -------.    a
-00041060: 7265 6120 3a20 666c 6f61 740a 2020 2020  rea : float.    
-00041070: 2020 2020 436f 6d70 7574 6564 2063 6174      Computed cat
-00041080: 616c 6f67 2061 7265 6120 696e 2073 7175  alog area in squ
-00041090: 6172 6520 6172 636d 696e 7574 6573 0a0a  are arcminutes..
-000410a0: 2020 2020 6669 6720 3a20 607e 6d61 7470      fig : `~matp
-000410b0: 6c6f 746c 6962 2e66 6967 7572 652e 4669  lotlib.figure.Fi
-000410c0: 6775 7265 600a 2020 2020 2020 2020 4669  gure`.        Fi
-000410d0: 6775 7265 206f 626a 6563 7420 7265 7475  gure object retu
-000410e0: 726e 6564 2069 6620 606d 616b 655f 706c  rned if `make_pl
-000410f0: 6f74 3d3d 5472 7565 602e 0a0a 2020 2020  ot==True`...    
-00041100: 2222 220a 2020 2020 696d 706f 7274 206d  """.    import m
-00041110: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
-00041120: 2061 7320 706c 740a 2020 2020 6672 6f6d   as plt.    from
-00041130: 2073 6861 7065 6c79 2e67 656f 6d65 7472   shapely.geometr
-00041140: 7920 696d 706f 7274 2050 6f6c 7967 6f6e  y import Polygon
-00041150: 2c20 506f 696e 742c 204d 756c 7469 506f  , Point, MultiPo
-00041160: 6c79 676f 6e2c 204d 756c 7469 4c69 6e65  lygon, MultiLine
-00041170: 5374 7269 6e67 0a20 2020 2066 726f 6d20  String.    from 
-00041180: 7363 6970 7920 696d 706f 7274 2073 7061  scipy import spa
-00041190: 7469 616c 0a0a 2020 2020 706f 696e 7473  tial..    points
-000411a0: 203d 206e 702e 6172 7261 7928 5b72 612c   = np.array([ra,
-000411b0: 2064 6563 5d29 2a31 2e0a 2020 2020 6365   dec])*1..    ce
-000411c0: 6e74 6572 203d 206e 702e 6d65 616e 2870  nter = np.mean(p
-000411d0: 6f69 6e74 732c 2061 7869 733d 3129 0a20  oints, axis=1). 
-000411e0: 2020 2070 6f69 6e74 7320 3d20 2870 6f69     points = (poi
-000411f0: 6e74 732e 5420 2d20 6365 6e74 6572 292a  nts.T - center)*
-00041200: 3630 2e20 2023 2061 7263 6d69 6e0a 2020  60.  # arcmin.  
-00041210: 2020 706f 696e 7473 5b3a 2c20 305d 202a    points[:, 0] *
-00041220: 3d20 6e70 2e63 6f73 2863 656e 7465 725b  = np.cos(center[
-00041230: 315d 2f31 3830 2a6e 702e 7069 290a 0a20  1]/180*np.pi).. 
-00041240: 2020 2068 756c 6c20 3d20 7370 6174 6961     hull = spatia
-00041250: 6c2e 436f 6e76 6578 4875 6c6c 2870 6f69  l.ConvexHull(poi
-00041260: 6e74 7329 0a20 2020 2065 6467 6520 3d20  nts).    edge = 
-00041270: 706f 696e 7473 5b68 756c 6c2e 7665 7274  points[hull.vert
-00041280: 6963 6573 2c20 3a5d 0a0a 2020 2020 2370  ices, :]..    #p
-00041290: 6275 6666 203d 2031 0a0a 2020 2020 6966  buff = 1..    if
-000412a0: 206c 656e 2872 6129 203e 204e 4d41 583a   len(ra) > NMAX:
-000412b0: 0a20 2020 2020 2020 2072 6e64 5f69 6478  .        rnd_idx
-000412c0: 203d 206e 702e 756e 6971 7565 286e 702e   = np.unique(np.
-000412d0: 6361 7374 5b69 6e74 5d28 6e70 2e72 6f75  cast[int](np.rou
-000412e0: 6e64 286e 702e 7261 6e64 6f6d 2e72 616e  nd(np.random.ran
-000412f0: 6428 4e4d 4158 292a 6c65 6e28 7261 2929  d(NMAX)*len(ra))
-00041300: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-00041310: 2020 2020 2072 6e64 5f69 6478 203d 206e       rnd_idx = n
-00041320: 702e 6172 616e 6765 286c 656e 2872 6129  p.arange(len(ra)
-00041330: 290a 0a20 2020 2070 6f6c 7920 3d20 506f  )..    poly = Po
-00041340: 696e 7428 706f 696e 7473 5b72 6e64 5f69  int(points[rnd_i
-00041350: 6478 5b30 5d2c 203a 5d29 2e62 7566 6665  dx[0], :]).buffe
-00041360: 7228 6275 6666 290a 2020 2020 666f 7220  r(buff).    for 
-00041370: 692c 2069 7820 696e 2065 6e75 6d65 7261  i, ix in enumera
-00041380: 7465 2872 6e64 5f69 6478 293a 0a20 2020  te(rnd_idx):.   
-00041390: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-000413a0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-000413b0: 6e74 284e 4f5f 4e45 574c 494e 4520 2b20  nt(NO_NEWLINE + 
-000413c0: 277b 307d 207b 317d 272e 666f 726d 6174  '{0} {1}'.format
-000413d0: 2869 2c20 6978 2929 0a0a 2020 2020 2020  (i, ix))..      
-000413e0: 2020 706f 6c79 203d 2070 6f6c 792e 756e    poly = poly.un
-000413f0: 696f 6e28 506f 696e 7428 706f 696e 7473  ion(Point(points
-00041400: 5b69 782c 203a 5d29 2e62 7566 6665 7228  [ix, :]).buffer(
-00041410: 6275 6666 2929 0a0a 2020 2020 2320 4669  buff))..    # Fi
-00041420: 6e61 6c20 286d 756c 7469 2950 6f6c 7967  nal (multi)Polyg
-00041430: 6f6e 0a20 2020 2070 6a6f 696e 203d 2070  on.    pjoin = p
-00041440: 6f6c 792e 6275 6666 6572 282d 6275 6666  oly.buffer(-buff
-00041450: 290a 0a20 2020 2069 6620 6d61 6b65 5f70  )..    if make_p
-00041460: 6c6f 743a 0a0a 2020 2020 2020 2020 6669  lot:..        fi
-00041470: 6720 3d20 706c 742e 6669 6775 7265 2829  g = plt.figure()
-00041480: 0a20 2020 2020 2020 2061 7820 3d20 6669  .        ax = fi
-00041490: 672e 6164 645f 7375 6270 6c6f 7428 3131  g.add_subplot(11
-000414a0: 3129 0a0a 2020 2020 2020 2020 6966 2069  1)..        if i
-000414b0: 7369 6e73 7461 6e63 6528 706a 6f69 6e2c  sinstance(pjoin,
-000414c0: 204d 756c 7469 506f 6c79 676f 6e29 3a0a   MultiPolygon):.
-000414d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000414e0: 705f 6920 696e 2070 6a6f 696e 3a0a 2020  p_i in pjoin:.  
-000414f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00041500: 2069 7369 6e73 7461 6e63 6528 705f 692e   isinstance(p_i.
-00041510: 626f 756e 6461 7279 2c20 4d75 6c74 694c  boundary, MultiL
-00041520: 696e 6553 7472 696e 6729 3a0a 2020 2020  ineString):.    
-00041530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041540: 666f 7220 7320 696e 2070 5f69 2e62 6f75  for s in p_i.bou
-00041550: 6e64 6172 793a 0a20 2020 2020 2020 2020  ndary:.         
-00041560: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00041570: 203d 2073 2e78 790a 2020 2020 2020 2020   = s.xy.        
-00041580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041590: 6178 2e70 6c6f 7428 705b 305d 2c20 705b  ax.plot(p[0], p[
-000415a0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-000415b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000415c0: 2020 2020 2020 2020 2020 2020 2020 7020                p 
-000415d0: 3d20 705f 692e 626f 756e 6461 7279 2e78  = p_i.boundary.x
-000415e0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-000415f0: 2020 2020 2020 6178 2e70 6c6f 7428 705b        ax.plot(p[
-00041600: 305d 2c20 705b 315d 290a 2020 2020 2020  0], p[1]).      
-00041610: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00041620: 2020 2020 705f 6920 3d20 706a 6f69 6e0a      p_i = pjoin.
-00041630: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00041640: 7369 6e73 7461 6e63 6528 705f 692e 626f  sinstance(p_i.bo
-00041650: 756e 6461 7279 2c20 4d75 6c74 694c 696e  undary, MultiLin
-00041660: 6553 7472 696e 6729 3a0a 2020 2020 2020  eString):.      
-00041670: 2020 2020 2020 2020 2020 666f 7220 7320            for s 
-00041680: 696e 2070 5f69 2e62 6f75 6e64 6172 793a  in p_i.boundary:
-00041690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000416a0: 2020 2020 2070 203d 2073 2e78 790a 2020       p = s.xy.  
-000416b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000416c0: 2020 6178 2e70 6c6f 7428 705b 305d 2c20    ax.plot(p[0], 
-000416d0: 705b 315d 290a 2020 2020 2020 2020 2020  p[1]).          
-000416e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000416f0: 2020 2020 2020 2020 7020 3d20 705f 692e          p = p_i.
-00041700: 626f 756e 6461 7279 2e78 790a 2020 2020  boundary.xy.    
-00041710: 2020 2020 2020 2020 2020 2020 6178 2e70              ax.p
-00041720: 6c6f 7428 705b 305d 2c20 705b 315d 290a  lot(p[0], p[1]).
-00041730: 0a20 2020 2020 2020 2061 782e 7363 6174  .        ax.scat
-00041740: 7465 7228 706f 696e 7473 5b72 6e64 5f69  ter(points[rnd_i
-00041750: 6478 2c20 305d 2c20 706f 696e 7473 5b72  dx, 0], points[r
-00041760: 6e64 5f69 6478 2c20 315d 2c20 616c 7068  nd_idx, 1], alph
-00041770: 613d 302e 312c 206d 6172 6b65 723d 272b  a=0.1, marker='+
-00041780: 2729 0a0a 2020 2020 2020 2020 6178 2e73  ')..        ax.s
-00041790: 6574 5f78 6c69 6d28 6178 2e67 6574 5f78  et_xlim(ax.get_x
-000417a0: 6c69 6d28 295b 3a3a 2d31 5d29 0a20 2020  lim()[::-1]).   
-000417b0: 2020 2020 2061 782e 7365 745f 786c 6162       ax.set_xlab
-000417c0: 656c 2872 2724 5c44 656c 7461 2452 4120  el(r'$\Delta$RA 
-000417d0: 287b 303a 2e35 667d 2927 2e66 6f72 6d61  ({0:.5f})'.forma
-000417e0: 7428 6365 6e74 6572 5b30 5d29 290a 2020  t(center[0])).  
-000417f0: 2020 2020 2020 6178 2e73 6574 5f79 6c61        ax.set_yla
-00041800: 6265 6c28 7227 245c 4465 6c74 6124 4465  bel(r'$\Delta$De
-00041810: 632e 2028 7b30 3a2e 3566 7d29 272e 666f  c. ({0:.5f})'.fo
-00041820: 726d 6174 2863 656e 7465 725b 315d 2929  rmat(center[1]))
-00041830: 0a20 2020 2020 2020 2061 782e 7365 745f  .        ax.set_
-00041840: 7469 746c 6528 2754 6f74 616c 2061 7265  title('Total are
-00041850: 613a 207b 303a 2e31 667d 2061 7263 6d69  a: {0:.1f} arcmi
-00041860: 6e24 5e32 2427 2e66 6f72 6d61 7428 706a  n$^2$'.format(pj
-00041870: 6f69 6e2e 6172 6561 2929 0a20 2020 2020  oin.area)).     
-00041880: 2020 2061 782e 6772 6964 2829 0a20 2020     ax.grid().   
-00041890: 2020 2020 2066 6967 2e74 6967 6874 5f6c       fig.tight_l
-000418a0: 6179 6f75 7428 7061 643d 302e 3129 0a0a  ayout(pad=0.1)..
-000418b0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-000418c0: 6a6f 696e 2e61 7265 612c 2066 6967 0a0a  join.area, fig..
-000418d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000418e0: 2020 7265 7475 726e 2070 6a6f 696e 2e61    return pjoin.a
-000418f0: 7265 610a 0a0a 6465 6620 6669 785f 666c  rea...def fix_fl
-00041900: 745f 6e61 6e28 666c 745f 6669 6c65 2c20  t_nan(flt_file, 
-00041910: 6261 645f 6269 743d 3430 3936 2c20 7665  bad_bit=4096, ve
-00041920: 7262 6f73 653d 5472 7565 293a 0a20 2020  rbose=True):.   
-00041930: 2022 2222 0a20 2020 2046 6978 204e 614e   """.    Fix NaN
-00041940: 2076 616c 7565 7320 696e 2046 4c54 2066   values in FLT f
-00041950: 696c 6573 0a20 2020 2022 2222 0a20 2020  iles.    """.   
-00041960: 2069 6d20 3d20 7079 6669 7473 2e6f 7065   im = pyfits.ope
-00041970: 6e28 666c 745f 6669 6c65 2c20 6d6f 6465  n(flt_file, mode
-00041980: 3d27 7570 6461 7465 2729 0a20 2020 2066  ='update').    f
-00041990: 6f72 2065 7874 2069 6e20 7261 6e67 6528  or ext in range(
-000419a0: 312c 2035 293a 0a20 2020 2020 2020 2069  1, 5):.        i
-000419b0: 6620 2827 5343 4927 2c20 6578 7429 2069  f ('SCI', ext) i
-000419c0: 6e20 696d 3a0a 2020 2020 2020 2020 2020  n im:.          
-000419d0: 2020 6d61 736b 203d 207e 6e70 2e69 7366    mask = ~np.isf
-000419e0: 696e 6974 6528 696d 5b27 5343 4927 2c20  inite(im['SCI', 
-000419f0: 6578 745d 2e64 6174 6129 0a20 2020 2020  ext].data).     
-00041a00: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00041a10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00041a20: 2020 206c 6162 656c 203d 2027 7574 696c     label = 'util
-00041a30: 732e 6669 785f 666c 745f 6e61 6e3a 207b  s.fix_flt_nan: {
-00041a40: 307d 5b53 4349 2c7b 317d 5d20 4e61 4e50  0}[SCI,{1}] NaNP
-00041a50: 6978 656c 733d 7b32 7d27 0a20 2020 2020  ixels={2}'.     
-00041a60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00041a70: 286c 6162 656c 2e66 6f72 6d61 7428 666c  (label.format(fl
-00041a80: 745f 6669 6c65 2c20 6578 742c 206d 6173  t_file, ext, mas
-00041a90: 6b2e 7375 6d28 2929 290a 0a20 2020 2020  k.sum()))..     
-00041aa0: 2020 2020 2020 2069 6620 6d61 736b 2e73         if mask.s
-00041ab0: 756d 2829 203d 3d20 303a 0a20 2020 2020  um() == 0:.     
-00041ac0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00041ad0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00041ae0: 2069 6d5b 2753 4349 272c 2065 7874 5d2e   im['SCI', ext].
-00041af0: 6461 7461 5b6d 6173 6b5d 203d 2030 0a20  data[mask] = 0. 
-00041b00: 2020 2020 2020 2020 2020 2069 6d5b 2744             im['D
-00041b10: 5127 2c20 6578 745d 2e64 6174 615b 6d61  Q', ext].data[ma
-00041b20: 736b 5d20 7c3d 2062 6164 5f62 6974 0a0a  sk] |= bad_bit..
-00041b30: 2020 2020 696d 2e66 6c75 7368 2829 0a20      im.flush(). 
-00041b40: 2020 2069 6d2e 636c 6f73 6528 290a 0a0a     im.close()...
-00041b50: 6465 6620 6475 6d70 5f66 6c74 5f64 7128  def dump_flt_dq(
-00041b60: 6669 6c65 6e61 6d65 2c20 7265 706c 6163  filename, replac
-00041b70: 653d 2827 2e66 6974 7327 2c20 272e 6471  e=('.fits', '.dq
-00041b80: 2e66 6974 732e 677a 2729 2c20 7665 7262  .fits.gz'), verb
-00041b90: 6f73 653d 5472 7565 293a 0a20 2020 2022  ose=True):.    "
-00041ba0: 2222 4475 6d70 2046 4c54 2f46 4c43 2068  ""Dump FLT/FLC h
-00041bb0: 6561 6465 7220 2620 4451 2065 7874 656e  eader & DQ exten
-00041bc0: 7369 6f6e 7320 746f 2061 2063 6f6d 7061  sions to a compa
-00041bd0: 6374 2066 696c 650a 0a20 2020 2050 6172  ct file..    Par
-00041be0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00041bf0: 2d2d 2d2d 2d2d 0a20 2020 2066 696c 656e  ------.    filen
-00041c00: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
-00041c10: 2020 464c 542f 464c 4320 6669 6c65 6e61    FLT/FLC filena
-00041c20: 6d65 2e0a 0a20 2020 2072 6570 6c61 6365  me...    replace
-00041c30: 203a 2028 7374 722c 2073 7472 290a 2020   : (str, str).  
-00041c40: 2020 2020 2020 5265 706c 6163 6520 6172        Replace ar
-00041c50: 6775 6d65 6e74 7320 666f 7220 6f75 7470  guments for outp
-00041c60: 7574 2066 696c 656e 616d 653a 0a0a 2020  ut filename:..  
-00041c70: 2020 2020 2020 3e3e 3e20 6f75 7470 7574        >>> output
-00041c80: 5f66 696c 656e 616d 6520 3d20 6669 6c65  _filename = file
-00041c90: 6e61 6d65 2e72 6570 6c61 6365 2872 6570  name.replace(rep
-00041ca0: 6c61 6365 5b30 5d2c 2072 6570 6c61 6365  lace[0], replace
-00041cb0: 5b31 5d29 0a0a 2020 2020 5265 7475 726e  [1])..    Return
-00041cc0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00041cd0: 2020 5772 6974 6573 2068 6561 6465 7220    Writes header 
-00041ce0: 616e 6420 636f 6d70 6163 7420 4451 2061  and compact DQ a
-00041cf0: 7272 6179 2074 6f20 606f 7574 7075 745f  rray to `output_
-00041d00: 6669 6c65 6e61 6d65 602e 0a0a 2020 2020  filename`...    
-00041d10: 2222 220a 2020 2020 696d 203d 2070 7966  """.    im = pyf
-00041d20: 6974 732e 6f70 656e 2866 696c 656e 616d  its.open(filenam
-00041d30: 6529 0a20 2020 2068 6475 7320 3d20 5b5d  e).    hdus = []
-00041d40: 0a20 2020 2066 6f72 2069 2069 6e20 5b31  .    for i in [1
-00041d50: 2c20 322c 2033 2c20 345d 3a0a 2020 2020  , 2, 3, 4]:.    
-00041d60: 2020 2020 6966 2028 2753 4349 272c 2069      if ('SCI', i
-00041d70: 2920 696e 2069 6d3a 0a20 2020 2020 2020  ) in im:.       
-00041d80: 2020 2020 2068 6561 6465 7220 3d20 696d       header = im
-00041d90: 5b27 5343 4927 2c20 695d 2e68 6561 6465  ['SCI', i].heade
-00041da0: 720a 2020 2020 2020 2020 2020 2020 6471  r.            dq
-00041db0: 203d 2069 6d5b 2744 5127 2c20 695d 2e64   = im['DQ', i].d
-00041dc0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
-00041dd0: 6e7a 203d 206e 702e 7768 6572 6528 6471  nz = np.where(dq
-00041de0: 203e 2030 290a 2020 2020 2020 2020 2020   > 0).          
-00041df0: 2020 6471 5f64 6174 6120 3d20 6e70 2e61    dq_data = np.a
-00041e00: 7272 6179 285b 6e7a 5b30 5d2c 206e 7a5b  rray([nz[0], nz[
-00041e10: 315d 2c20 6471 5b64 7120 3e20 305d 5d2c  1], dq[dq > 0]],
-00041e20: 2064 7479 7065 3d6e 702e 696e 7431 3629   dtype=np.int16)
-00041e30: 0a20 2020 2020 2020 2020 2020 2068 6475  .            hdu
-00041e40: 203d 2070 7966 6974 732e 496d 6167 6548   = pyfits.ImageH
-00041e50: 4455 2868 6561 6465 723d 6865 6164 6572  DU(header=header
-00041e60: 2c20 6461 7461 3d64 715f 6461 7461 290a  , data=dq_data).
-00041e70: 2020 2020 2020 2020 2020 2020 6864 7573              hdus
-00041e80: 2e61 7070 656e 6428 6864 7529 0a0a 2020  .append(hdu)..  
-00041e90: 2020 6f75 7470 7574 5f66 696c 656e 616d    output_filenam
-00041ea0: 6520 3d20 6669 6c65 6e61 6d65 2e72 6570  e = filename.rep
-00041eb0: 6c61 6365 2872 6570 6c61 6365 5b30 5d2c  lace(replace[0],
-00041ec0: 2072 6570 6c61 6365 5b31 5d29 0a0a 2020   replace[1])..  
-00041ed0: 2020 6d73 6720 3d20 2723 2064 756d 705f    msg = '# dump_
-00041ee0: 666c 745f 6471 3a20 7b30 7d20 3e20 7b31  flt_dq: {0} > {1
-00041ef0: 7d27 2e66 6f72 6d61 7428 6669 6c65 6e61  }'.format(filena
-00041f00: 6d65 2c20 6f75 7470 7574 5f66 696c 656e  me, output_filen
-00041f10: 616d 6529 0a20 2020 206c 6f67 5f63 6f6d  ame).    log_com
-00041f20: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
-00041f30: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
-00041f40: 7365 2c20 7368 6f77 5f64 6174 653d 5472  se, show_date=Tr
-00041f50: 7565 290a 0a20 2020 2070 7966 6974 732e  ue)..    pyfits.
-00041f60: 4844 554c 6973 7428 6864 7573 292e 7772  HDUList(hdus).wr
-00041f70: 6974 6574 6f28 6f75 7470 7574 5f66 696c  iteto(output_fil
-00041f80: 656e 616d 652c 206f 7665 7277 7269 7465  ename, overwrite
-00041f90: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00041fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041fb0: 2020 2020 2020 2020 6f75 7470 7574 5f76          output_v
-00041fc0: 6572 6966 793d 2766 6978 2729 0a20 2020  erify='fix').   
-00041fd0: 200a 2020 2020 696d 2e63 6c6f 7365 2829   .    im.close()
-00041fe0: 0a0a 0a64 6566 2061 7070 6c79 5f66 6c74  ...def apply_flt
-00041ff0: 5f64 7128 6669 6c65 6e61 6d65 2c20 7265  _dq(filename, re
-00042000: 706c 6163 653d 2827 2e66 6974 7327 2c20  place=('.fits', 
-00042010: 272e 6471 2e66 6974 732e 677a 2729 2c20  '.dq.fits.gz'), 
-00042020: 7665 7262 6f73 653d 5472 7565 2c20 6f72  verbose=True, or
-00042030: 5f63 6f6d 6269 6e65 3d46 616c 7365 293a  _combine=False):
-00042040: 0a20 2020 2022 2222 0a20 2020 2052 6561  .    """.    Rea
-00042050: 6420 616e 6420 6170 706c 7920 7468 6520  d and apply the 
-00042060: 636f 6d70 6163 7420 6578 706f 7375 7265  compact exposure
-00042070: 2069 6e66 6f72 6d61 7469 6f6e 2066 696c   information fil
-00042080: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
-00042090: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-000420a0: 0a20 2020 2066 696c 656e 616d 6520 3a20  .    filename : 
-000420b0: 7374 720a 2020 2020 2020 2020 464c 542f  str.        FLT/
-000420c0: 464c 4320 6669 6c65 6e61 6d65 2e0a 0a20  FLC filename... 
-000420d0: 2020 2072 6570 6c61 6365 203a 2028 7374     replace : (st
-000420e0: 722c 2073 7472 290a 2020 2020 2020 2020  r, str).        
-000420f0: 5265 706c 6163 6520 6172 6775 6d65 6e74  Replace argument
-00042100: 7320 666f 7220 6f75 7470 7574 2044 5120  s for output DQ 
-00042110: 6669 6c65 6e61 6d65 3a0a 0a20 2020 2020  filename:..     
-00042120: 2020 203e 3e3e 206f 7574 7075 745f 6669     >>> output_fi
-00042130: 6c65 6e61 6d65 203d 2066 696c 656e 616d  lename = filenam
-00042140: 652e 7265 706c 6163 6528 7265 706c 6163  e.replace(replac
-00042150: 655b 305d 2c20 7265 706c 6163 655b 315d  e[0], replace[1]
-00042160: 290a 0a20 2020 206f 725f 636f 6d62 696e  )..    or_combin
-00042170: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
-00042180: 2049 6620 5472 7565 2c20 7468 656e 2061   If True, then a
-00042190: 7070 6c79 2044 5120 6461 7461 2069 6e20  pply DQ data in 
-000421a0: 606f 7574 7075 745f 6669 6c65 6e61 6d65  `output_filename
-000421b0: 6020 7769 7468 204f 5220 6c6f 6769 632e  ` with OR logic.
-000421c0: 0a0a 2020 2020 2020 2020 4966 2046 616c  ..        If Fal
-000421d0: 7365 2c20 7468 656e 2072 6573 6574 2074  se, then reset t
-000421e0: 6865 2044 5120 6578 7465 6e73 696f 6e73  he DQ extensions
-000421f0: 2074 6f20 6265 2065 7861 6374 6c79 2074   to be exactly t
-00042200: 686f 7365 2069 6e0a 2020 2020 2020 2020  hose in.        
-00042210: 606f 7574 7075 745f 6669 6c65 6e61 6d65  `output_filename
-00042220: 602e 0a0a 2020 2020 5265 7475 726e 730a  `...    Returns.
-00042230: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00042240: 5772 6974 6573 2068 6561 6465 7220 616e  Writes header an
-00042250: 6420 636f 6d70 6163 7420 4451 2061 7272  d compact DQ arr
-00042260: 6179 2074 6f20 606f 7574 7075 745f 6669  ay to `output_fi
-00042270: 6c65 6e61 6d65 602e 0a0a 2020 2020 2222  lename`...    ""
-00042280: 220a 0a20 2020 206f 7574 7075 745f 6669  "..    output_fi
-00042290: 6c65 6e61 6d65 203d 2066 696c 656e 616d  lename = filenam
-000422a0: 652e 7265 706c 6163 6528 7265 706c 6163  e.replace(replac
-000422b0: 655b 305d 2c20 7265 706c 6163 655b 315d  e[0], replace[1]
-000422c0: 290a 0a20 2020 2069 6620 6e6f 7420 6f73  )..    if not os
-000422d0: 2e70 6174 682e 6578 6973 7473 286f 7574  .path.exists(out
-000422e0: 7075 745f 6669 6c65 6e61 6d65 293a 0a20  put_filename):. 
-000422f0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00042300: 6c73 650a 0a20 2020 2069 6d20 3d20 7079  lse..    im = py
-00042310: 6669 7473 2e6f 7065 6e28 6669 6c65 6e61  fits.open(filena
-00042320: 6d65 2c20 6d6f 6465 3d27 7570 6461 7465  me, mode='update
-00042330: 2729 0a0a 2020 2020 6d73 6720 3d20 2723  ')..    msg = '#
-00042340: 2061 7070 6c79 5f66 6c74 5f64 713a 207b   apply_flt_dq: {
-00042350: 317d 203e 207b 307d 272e 666f 726d 6174  1} > {0}'.format
-00042360: 2866 696c 656e 616d 652c 206f 7574 7075  (filename, outpu
-00042370: 745f 6669 6c65 6e61 6d65 290a 2020 2020  t_filename).    
-00042380: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
-00042390: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
-000423a0: 653d 7665 7262 6f73 652c 2073 686f 775f  e=verbose, show_
-000423b0: 6461 7465 3d54 7275 6529 0a0a 2020 2020  date=True)..    
-000423c0: 6471 203d 2070 7966 6974 732e 6f70 656e  dq = pyfits.open
-000423d0: 286f 7574 7075 745f 6669 6c65 6e61 6d65  (output_filename
-000423e0: 290a 2020 2020 666f 7220 6578 7420 696e  ).    for ext in
-000423f0: 205b 312c 2032 2c20 332c 2034 5d3a 0a20   [1, 2, 3, 4]:. 
-00042400: 2020 2020 2020 2069 6620 2828 2753 4349         if (('SCI
-00042410: 272c 2065 7874 2920 696e 2069 6d29 2026  ', ext) in im) &
-00042420: 2028 2827 5343 4927 2c20 6578 7429 2069   (('SCI', ext) i
-00042430: 6e20 6471 293a 0a20 2020 2020 2020 2020  n dq):.         
-00042440: 2020 2073 6820 3d20 6471 5b27 5343 4927     sh = dq['SCI'
-00042450: 2c20 6578 745d 2e64 6174 612e 7368 6170  , ext].data.shap
-00042460: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00042470: 2073 685b 305d 203d 3d20 333a 0a20 2020   sh[0] == 3:.   
-00042480: 2020 2020 2020 2020 2020 2020 2069 2c20               i, 
-00042490: 6a2c 2064 715f 6920 3d20 6471 5b27 5343  j, dq_i = dq['SC
-000424a0: 4927 2c20 6578 745d 2e64 6174 610a 2020  I', ext].data.  
-000424b0: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-000424c0: 685b 315d 203d 3d20 323a 0a20 2020 2020  h[1] == 2:.     
-000424d0: 2020 2020 2020 2020 2020 206e 7a2c 2064             nz, d
-000424e0: 715f 6920 3d20 6471 5b27 5343 4927 2c20  q_i = dq['SCI', 
-000424f0: 6578 745d 2e64 6174 610a 2020 2020 2020  ext].data.      
-00042500: 2020 2020 2020 2020 2020 692c 206a 203d            i, j =
-00042510: 206e 702e 756e 7261 7665 6c5f 696e 6465   np.unravel_inde
-00042520: 7828 6e7a 2c20 7368 290a 2020 2020 2020  x(nz, sh).      
-00042530: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00042540: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00042550: 6520 494f 4572 726f 7228 2764 715b 7b30  e IOError('dq[{0
-00042560: 7d5d 2073 6861 7065 207b 317d 206e 6f74  }] shape {1} not
-00042570: 2072 6563 6f67 6e69 7a65 6427 2e66 6f72   recognized'.for
-00042580: 6d61 7428 6578 742c 2073 6829 290a 2020  mat(ext, sh)).  
-00042590: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-000425a0: 2020 2020 2020 2020 2020 2023 2041 7070             # App
-000425b0: 6c79 2044 510a 2020 2020 2020 2020 2020  ly DQ.          
-000425c0: 2020 6966 206f 725f 636f 6d62 696e 653a    if or_combine:
-000425d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000425e0: 2069 6d5b 2744 5127 2c20 6578 745d 2e64   im['DQ', ext].d
-000425f0: 6174 615b 692c 206a 5d20 213d 2064 715f  ata[i, j] != dq_
-00042600: 690a 2020 2020 2020 2020 2020 2020 656c  i.            el
-00042610: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00042620: 2020 2020 696d 5b27 4451 272c 2065 7874      im['DQ', ext
-00042630: 5d2e 6461 7461 202a 3d20 300a 2020 2020  ].data *= 0.    
-00042640: 2020 2020 2020 2020 2020 2020 696d 5b27              im['
-00042650: 4451 272c 2065 7874 5d2e 6461 7461 5b69  DQ', ext].data[i
-00042660: 2c20 6a5d 203d 2064 715f 690a 0a20 2020  , j] = dq_i..   
-00042670: 2020 2020 2020 2020 2023 2043 6f70 7920           # Copy 
-00042680: 6865 6164 6572 0a20 2020 2020 2020 2020  header.         
-00042690: 2020 2068 6173 5f62 6c6f 7473 6b79 203d     has_blotsky =
-000426a0: 2027 424c 4f54 534b 5927 2069 6e20 696d   'BLOTSKY' in im
-000426b0: 5b27 5343 4927 2c20 6578 745d 2e68 6561  ['SCI', ext].hea
-000426c0: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
-000426d0: 666f 7220 6b20 696e 2064 715b 2753 4349  for k in dq['SCI
-000426e0: 272c 2065 7874 5d2e 6865 6164 6572 3a0a  ', ext].header:.
-000426f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042700: 6966 206b 2069 6e20 5b27 4249 5450 4958  if k in ['BITPIX
-00042710: 272c 2027 4e41 5849 5331 272c 2027 4e41  ', 'NAXIS1', 'NA
-00042720: 5849 5332 272c 2027 272c 2027 4849 5354  XIS2', '', 'HIST
-00042730: 4f52 5927 5d3a 0a20 2020 2020 2020 2020  ORY']:.         
-00042740: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00042750: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00042760: 2020 2020 2069 6d5b 2753 4349 272c 2065       im['SCI', e
-00042770: 7874 5d2e 6865 6164 6572 5b6b 5d20 3d20  xt].header[k] = 
-00042780: 6471 5b27 5343 4927 2c20 6578 745d 2e68  dq['SCI', ext].h
-00042790: 6561 6465 725b 6b5d 0a0a 2020 2020 2020  eader[k]..      
-000427a0: 2020 2020 2020 6966 2028 6e6f 7420 6861        if (not ha
-000427b0: 735f 626c 6f74 736b 7929 2026 2028 2742  s_blotsky) & ('B
-000427c0: 4c4f 5453 4b59 2720 696e 2064 715b 2753  LOTSKY' in dq['S
-000427d0: 4349 272c 2065 7874 5d2e 6865 6164 6572  CI', ext].header
-000427e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000427f0: 2020 2069 6d5b 2753 4349 272c 2065 7874     im['SCI', ext
-00042800: 5d2e 6865 6164 6572 5b27 424c 4f54 534b  ].header['BLOTSK
-00042810: 5927 5d20 3d20 4661 6c73 650a 0a20 2020  Y'] = False..   
-00042820: 2069 6d2e 666c 7573 6828 290a 2020 2020   im.flush().    
-00042830: 696d 2e63 6c6f 7365 2829 0a0a 0a64 6566  im.close()...def
-00042840: 2052 4742 746f 4865 7828 7661 6c73 2c20   RGBtoHex(vals, 
-00042850: 7267 6274 7970 653d 3129 3a0a 2020 2020  rgbtype=1):.    
-00042860: 2222 2243 6f6e 7665 7274 7320 5247 4220  """Converts RGB 
-00042870: 7661 6c75 6573 2069 6e20 6120 7661 7269  values in a vari
-00042880: 6574 7920 6f66 2066 6f72 6d61 7473 2074  ety of formats t
-00042890: 6f20 4865 7820 7661 6c75 6573 2e0a 0a20  o Hex values... 
-000428a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-000428b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-000428c0: 2076 616c 7320 3a20 7475 706c 650a 2020   vals : tuple.  
-000428d0: 2020 2020 2020 2041 6e20 5247 422f 5247         An RGB/RG
-000428e0: 4241 2074 7570 6c65 0a0a 2020 2020 7267  BA tuple..    rg
-000428f0: 625f 7479 7065 203a 2069 6e74 0a20 2020  b_type : int.   
-00042900: 2020 2020 2056 616c 6964 2076 616c 7573       Valid valus
-00042910: 2061 7265 3a0a 2020 2020 2020 2020 202d   are:.         -
-00042920: 2031 203d 2049 6e70 7574 7320 6172 6520   1 = Inputs are 
-00042930: 696e 2074 6865 2072 616e 6765 2030 2074  in the range 0 t
-00042940: 6f20 310a 2020 2020 2020 2020 202d 2032  o 1.         - 2
-00042950: 3536 203d 2049 6e70 7574 7320 6172 6520  56 = Inputs are 
-00042960: 696e 2074 6865 2072 616e 6765 2030 2074  in the range 0 t
-00042970: 6f20 3235 350a 200a 2020 2020 5265 7475  o 255. .    Retu
-00042980: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00042990: 2020 2020 6865 7874 7374 7220 3a20 7374      hextstr : st
-000429a0: 720a 2020 2020 2020 2020 4120 6865 7820  r.        A hex 
-000429b0: 7374 7269 6e67 2069 6e20 7468 6520 666f  string in the fo
-000429c0: 726d 2027 2352 5247 4742 4227 206f 7220  rm '#RRGGBB' or 
-000429d0: 2723 5252 4747 4242 4141 270a 0a20 2020  '#RRGGBBAA'..   
-000429e0: 2052 6566 6572 656e 6365 730a 2020 2020   References.    
-000429f0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2028  ----------.    (
-00042a00: 6372 6564 6974 3a20 5279 6368 6172 6420  credit: Rychard 
-00042a10: 4020 6874 7470 733a 2f2f 7374 6163 6b6f  @ https://stacko
-00042a20: 7665 7266 6c6f 772e 636f 6d2f 612f 3438  verflow.com/a/48
-00042a30: 3238 3831 3733 290a 0a20 2020 2022 2222  288173)..    """
-00042a40: 0a0a 2020 2020 6d73 6720 3d20 2252 4742  ..    msg = "RGB
-00042a50: 206f 7220 5247 4241 2069 6e70 7574 7320   or RGBA inputs 
-00042a60: 746f 2052 4742 746f 4865 7820 6d75 7374  to RGBtoHex must
-00042a70: 2068 6176 6520 7468 7265 6520 6f72 2066   have three or f
-00042a80: 6f75 7220 656c 656d 656e 7473 2122 0a20  our elements!". 
-00042a90: 2020 2069 6620 286c 656e 2876 616c 7329     if (len(vals)
-00042aa0: 2021 3d20 3329 2026 2028 6c65 6e28 7661   != 3) & (len(va
-00042ab0: 6c73 2920 213d 2034 293a 0a20 2020 2020  ls) != 4):.     
-00042ac0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00042ad0: 6f6e 286d 7367 290a 0a20 2020 2069 6620  on(msg)..    if 
-00042ae0: 2872 6762 7479 7065 2021 3d20 3129 2026  (rgbtype != 1) &
-00042af0: 2028 7267 6274 7970 6520 213d 2032 3536   (rgbtype != 256
-00042b00: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-00042b10: 2045 7863 6570 7469 6f6e 2822 7267 6274   Exception("rgbt
-00042b20: 7970 6520 6d75 7374 2062 6520 3120 6f72  ype must be 1 or
-00042b30: 2032 3536 2122 290a 0a20 2020 2023 2043   256!")..    # C
-00042b40: 6f6e 7665 7274 2066 726f 6d20 302d 3120  onvert from 0-1 
-00042b50: 5247 422f 5247 4241 2074 6f20 302d 3235  RGB/RGBA to 0-25
-00042b60: 3520 5247 422f 5247 4241 0a20 2020 2069  5 RGB/RGBA.    i
-00042b70: 6620 7267 6274 7970 6520 3d3d 2031 3a0a  f rgbtype == 1:.
-00042b80: 2020 2020 2020 2020 7661 6c73 203d 205b          vals = [
-00042b90: 3235 352a 7820 666f 7220 7820 696e 2076  255*x for x in v
-00042ba0: 616c 735b 3a33 5d5d 0a0a 2020 2020 2320  als[:3]]..    # 
-00042bb0: 456e 7375 7265 2076 616c 7565 7320 6172  Ensure values ar
-00042bc0: 6520 726f 756e 6465 6420 696e 7465 6765  e rounded intege
-00042bd0: 7273 2c20 636f 6e76 6572 7420 746f 2068  rs, convert to h
-00042be0: 6578 2c20 616e 6420 636f 6e63 6174 656e  ex, and concaten
-00042bf0: 6174 650a 2020 2020 7265 7475 726e 2027  ate.    return '
-00042c00: 2327 202b 2027 272e 6a6f 696e 285b 277b  #' + ''.join(['{
-00042c10: 3a30 3258 7d27 2e66 6f72 6d61 7428 696e  :02X}'.format(in
-00042c20: 7428 726f 756e 6428 7829 2929 2066 6f72  t(round(x))) for
-00042c30: 2078 2069 6e20 7661 6c73 5d29 0a0a 0a64   x in vals])...d
-00042c40: 6566 2063 6174 616c 6f67 5f6d 6173 6b28  ef catalog_mask(
-00042c50: 6361 742c 2065 636f 6c3d 2746 4c55 5845  cat, ecol='FLUXE
-00042c60: 5252 5f41 5045 525f 3027 2c20 6d61 785f  RR_APER_0', max_
-00042c70: 6572 725f 7065 7263 656e 7469 6c65 3d39  err_percentile=9
-00042c80: 302c 2070 6164 3d30 2e30 352c 2070 6164  0, pad=0.05, pad
-00042c90: 5f69 735f 6162 736f 6c75 7465 3d46 616c  _is_absolute=Fal
-00042ca0: 7365 2c20 6d69 6e5f 666c 7578 5f72 6164  se, min_flux_rad
-00042cb0: 6975 733d 312e 293a 0a20 2020 2022 2222  ius=1.):.    """
-00042cc0: 0a20 2020 2043 6f6d 7075 7465 2061 2063  .    Compute a c
-00042cd0: 6174 616c 6f67 206d 6173 6b20 666f 720a  atalog mask for.
-00042ce0: 2020 2020 2020 3129 204f 626a 6563 7473        1) Objects
-00042cf0: 2077 6974 6869 6e20 6070 6164 6020 6f66   within `pad` of
-00042d00: 2074 6865 2065 6467 6520 6f66 2074 6865   the edge of the
-00042d10: 2063 6174 616c 6f67 2063 6f6e 7665 7820   catalog convex 
-00042d20: 6875 6c6c 0a20 2020 2020 2032 2920 556e  hull.      2) Un
-00042d30: 6365 7274 6169 6e74 6965 7320 3c20 606d  certainties < `m
-00042d40: 6178 5f65 7272 5f70 6572 6365 6e74 696c  ax_err_percentil
-00042d50: 6560 0a0a 2020 2020 2222 220a 2020 2020  e`..    """.    
-00042d60: 7465 7374 203d 206e 702e 6973 6669 6e69  test = np.isfini
-00042d70: 7465 2863 6174 5b27 464c 5558 5f41 5554  te(cat['FLUX_AUT
-00042d80: 4f27 5d29 0a20 2020 2069 6620 2746 4c55  O']).    if 'FLU
-00042d90: 585f 5241 4449 5553 2720 696e 2063 6174  X_RADIUS' in cat
-00042da0: 2e63 6f6c 6e61 6d65 733a 0a20 2020 2020  .colnames:.     
-00042db0: 2020 2074 6573 7420 263d 2063 6174 5b27     test &= cat['
-00042dc0: 464c 5558 5f52 4144 4955 5327 5d20 3e20  FLUX_RADIUS'] > 
-00042dd0: 6d69 6e5f 666c 7578 5f72 6164 6975 730a  min_flux_radius.
-00042de0: 0a20 2020 2074 6573 7420 263d 2028 6361  .    test &= (ca
-00042df0: 745b 2754 4852 4553 4827 5d20 3e20 3029  t['THRESH'] > 0)
-00042e00: 2026 2028 6361 745b 2754 4852 4553 4827   & (cat['THRESH'
-00042e10: 5d20 3c20 3165 3238 290a 0a20 2020 206e  ] < 1e28)..    n
-00042e20: 6f74 5f65 6467 6520 3d20 6875 6c6c 5f65  ot_edge = hull_e
-00042e30: 6467 655f 6d61 736b 2863 6174 5b27 585f  dge_mask(cat['X_
-00042e40: 494d 4147 4527 5d2c 2063 6174 5b27 595f  IMAGE'], cat['Y_
-00042e50: 494d 4147 4527 5d2c 0a20 2020 2020 2020  IMAGE'],.       
-00042e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042e70: 2020 2020 2020 2070 6164 3d70 6164 2c20         pad=pad, 
-00042e80: 7061 645f 6973 5f61 6273 6f6c 7574 653d  pad_is_absolute=
-00042e90: 7061 645f 6973 5f61 6273 6f6c 7574 6529  pad_is_absolute)
-00042ea0: 0a0a 2020 2020 7465 7374 2026 3d20 6e6f  ..    test &= no
-00042eb0: 745f 6564 6765 0a0a 2020 2020 6966 2065  t_edge..    if e
-00042ec0: 636f 6c20 696e 2063 6174 2e63 6f6c 6e61  col in cat.colna
-00042ed0: 6d65 733a 0a20 2020 2020 2020 2076 616c  mes:.        val
-00042ee0: 6964 203d 206e 702e 6973 6669 6e69 7465  id = np.isfinite
-00042ef0: 2863 6174 5b65 636f 6c5d 290a 2020 2020  (cat[ecol]).    
-00042f00: 2020 2020 6966 206d 6178 5f65 7272 5f70      if max_err_p
-00042f10: 6572 6365 6e74 696c 6520 3c20 3130 303a  ercentile < 100:
-00042f20: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-00042f30: 7420 263d 2063 6174 5b65 636f 6c5d 203c  t &= cat[ecol] <
-00042f40: 206e 702e 7065 7263 656e 7469 6c65 2863   np.percentile(c
-00042f50: 6174 5b65 636f 6c5d 5b28 7e6e 6f74 5f65  at[ecol][(~not_e
-00042f60: 6467 6529 2026 2076 616c 6964 5d2c 0a20  dge) & valid],. 
-00042f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042f90: 2020 2020 2020 2020 206d 6178 5f65 7272           max_err
-00042fa0: 5f70 6572 6365 6e74 696c 6529 0a0a 2020  _percentile)..  
-00042fb0: 2020 7265 7475 726e 2074 6573 740a 0a0a    return test...
-00042fc0: 6465 6620 6875 6c6c 5f65 6467 655f 6d61  def hull_edge_ma
-00042fd0: 736b 2878 2c20 792c 2070 6164 3d31 3030  sk(x, y, pad=100
-00042fe0: 2c20 7061 645f 6973 5f61 6273 6f6c 7574  , pad_is_absolut
-00042ff0: 653d 5472 7565 2c20 6d61 736b 3d4e 6f6e  e=True, mask=Non
-00043000: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00043010: 436f 6d70 7574 6520 6765 6f6d 6574 7269  Compute geometri
-00043020: 6361 6c20 6564 6765 206d 6173 6b20 666f  cal edge mask fo
-00043030: 7220 706f 696e 7473 2077 6974 6869 6e20  r points within 
-00043040: 6120 636f 6e76 6578 2068 756c 6c0a 0a20  a convex hull.. 
-00043050: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00043060: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00043070: 2078 2c20 7920 3a20 6172 7261 790a 2020   x, y : array.  
-00043080: 2020 2020 2020 436f 6f72 6469 6e61 7465        Coordinate
-00043090: 7320 6f66 2074 6865 2063 6174 616c 6f67  s of the catalog
-000430a0: 0a0a 2020 2020 7061 6420 3a20 666c 6f61  ..    pad : floa
-000430b0: 740a 2020 2020 2020 2020 4275 6666 6572  t.        Buffer
-000430c0: 2070 6164 6469 6e67 0a0a 2020 2020 7061   padding..    pa
-000430d0: 645f 6973 5f61 6273 6f6c 7574 6520 3a20  d_is_absolute : 
-000430e0: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-000430f0: 5472 7565 2c20 7468 656e 2074 6865 2062  True, then the b
-00043100: 7566 6665 7220 6973 2074 616b 656e 2066  uffer is taken f
-00043110: 726f 6d20 6070 6164 6020 2865 2e67 2e2c  rom `pad` (e.g.,
-00043120: 2070 6978 656c 7329 2e20 2049 660a 2020   pixels).  If.  
-00043130: 2020 2020 2020 4661 6c73 652c 2074 6865        False, the
-00043140: 6e20 6070 6164 6020 6973 2074 7265 6174  n `pad` is treat
-00043150: 6564 2061 7320 6120 6672 6163 7469 6f6e  ed as a fraction
-00043160: 206f 6620 7468 6520 6c69 6e65 6172 2064   of the linear d
-00043170: 696d 656e 7369 6f6e 0a20 2020 2020 2020  imension.       
-00043180: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
-00043190: 2860 7e73 7172 7428 6875 6c6c 2061 7265  (`~sqrt(hull are
-000431a0: 6129 6029 2e0a 0a20 2020 206d 6173 6b20  a)`)...    mask 
-000431b0: 3a20 626f 6f6c 2061 7272 6179 0a20 2020  : bool array.   
-000431c0: 2020 2020 204d 6173 6b20 746f 2061 7070       Mask to app
-000431d0: 6c79 2074 6f20 782f 7920 6265 666f 7265  ly to x/y before
-000431e0: 2063 6f6d 7075 7469 6e67 2074 6865 2063   computing the c
-000431f0: 6f6e 7665 7820 6875 6c6c 0a0a 2020 2020  onvex hull..    
-00043200: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00043210: 2d2d 2d0a 2020 2020 6d61 736b 203a 2062  ---.    mask : b
-00043220: 6f6f 6c20 6172 7261 790a 2020 2020 2020  ool array.      
-00043230: 2020 5472 7565 2069 6620 706f 696e 7473    True if points
-00043240: 2077 6974 6869 6e20 7468 6520 6275 6666   within the buff
-00043250: 6572 6564 2068 756c 6c0a 0a20 2020 2022  ered hull..    "
-00043260: 2222 0a0a 2020 2020 6672 6f6d 2073 6369  ""..    from sci
-00043270: 7079 2e73 7061 7469 616c 2069 6d70 6f72  py.spatial impor
-00043280: 7420 436f 6e76 6578 4875 6c6c 0a20 2020  t ConvexHull.   
-00043290: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
-000432a0: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
-000432b0: 6c79 676f 6e2c 2050 6f69 6e74 0a0a 2020  lygon, Point..  
-000432c0: 2020 7879 203d 206e 702e 6172 7261 7928    xy = np.array(
-000432d0: 5b78 2c20 795d 292e 540a 0a20 2020 2069  [x, y]).T..    i
-000432e0: 6620 6d61 736b 2069 7320 4e6f 6e65 3a0a  f mask is None:.
-000432f0: 2020 2020 2020 2020 6875 6c6c 203d 2043          hull = C
-00043300: 6f6e 7665 7848 756c 6c28 7879 290a 2020  onvexHull(xy).  
-00043310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00043320: 6875 6c6c 203d 2043 6f6e 7665 7848 756c  hull = ConvexHul
-00043330: 6c28 7879 5b6d 6173 6b2c 203a 5d29 0a0a  l(xy[mask, :])..
-00043340: 2020 2020 7078 7920 3d20 7879 5b68 756c      pxy = xy[hul
-00043350: 6c2e 7665 7274 6963 6573 2c20 3a5d 0a20  l.vertices, :]. 
-00043360: 2020 2070 6f6c 7920 3d20 506f 6c79 676f     poly = Polygo
-00043370: 6e28 7078 7929 0a0a 2020 2020 6966 2070  n(pxy)..    if p
-00043380: 6164 5f69 735f 6162 736f 6c75 7465 3a0a  ad_is_absolute:.
-00043390: 2020 2020 2020 2020 6275 6666 203d 202d          buff = -
-000433a0: 7061 640a 2020 2020 656c 7365 3a0a 2020  pad.    else:.  
-000433b0: 2020 2020 2020 2320 6c69 6e65 6172 2064        # linear d
-000433c0: 696d 656e 7369 6f6e 207e 2073 7172 7428  imension ~ sqrt(
-000433d0: 6172 6561 290a 2020 2020 2020 2020 6275  area).        bu
-000433e0: 6666 203d 202d 7061 642a 6e70 2e73 7172  ff = -pad*np.sqr
-000433f0: 7428 706f 6c79 2e61 7265 6129 0a0a 2020  t(poly.area)..  
-00043400: 2020 7062 7566 6620 3d20 706f 6c79 2e62    pbuff = poly.b
-00043410: 7566 6665 7228 6275 6666 290a 2020 2020  uffer(buff).    
-00043420: 696e 5f62 7566 6620 3d20 6e70 2e61 7272  in_buff = np.arr
-00043430: 6179 285b 7062 7566 662e 636f 6e74 6169  ay([pbuff.contai
-00043440: 6e73 2850 6f69 6e74 285b 785b 695d 2c20  ns(Point([x[i], 
-00043450: 795b 695d 5d29 2920 666f 7220 6920 696e  y[i]])) for i in
-00043460: 2072 616e 6765 286c 656e 2878 2929 5d29   range(len(x))])
-00043470: 0a0a 2020 2020 7265 7475 726e 2069 6e5f  ..    return in_
-00043480: 6275 6666 0a0a 0a64 6566 2063 6f6e 7665  buff...def conve
-00043490: 785f 6875 6c6c 5f77 7261 7070 6572 2878  x_hull_wrapper(x
-000434a0: 2c20 7929 3a0a 2020 2020 2222 220a 2020  , y):.    """.  
-000434b0: 2020 4765 6e65 7261 7465 2061 2063 6f6e    Generate a con
-000434c0: 7665 7820 6875 6c6c 2066 726f 6d20 6120  vex hull from a 
-000434d0: 6c69 7374 206f 6620 706f 696e 7473 0a20  list of points. 
-000434e0: 2020 200a 2020 2020 5265 7475 726e 733a     .    Returns:
-000434f0: 0a20 2020 200a 2020 2020 7078 7920 3a20  .    .    pxy : 
-00043500: 2861 7272 6179 2c20 6172 7261 7929 0a20  (array, array). 
-00043510: 2020 2020 2020 2054 7570 6c65 206f 6620         Tuple of 
-00043520: 6875 6c6c 2076 6572 7469 6365 730a 2020  hull vertices.  
-00043530: 2020 0a20 2020 2070 6f6c 7920 3a20 607e    .    poly : `~
-00043540: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
-00043550: 2e50 6f6c 7967 6f6e 600a 2020 2020 2020  .Polygon`.      
-00043560: 2020 506f 6c79 676f 6e20 6f62 6a65 6374    Polygon object
-00043570: 2e0a 2020 2020 0a20 2020 2068 756c 6c20  ..    .    hull 
-00043580: 3a20 607e 7363 6970 792e 7370 6174 6961  : `~scipy.spatia
-00043590: 6c2e 436f 6e76 6578 4875 6c6c 600a 2020  l.ConvexHull`.  
-000435a0: 2020 2020 2020 5468 6520 6875 6c6c 206f        The hull o
-000435b0: 626a 6563 742e 0a20 2020 2020 2020 200a  bject..        .
-000435c0: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
-000435d0: 2073 6369 7079 2e73 7061 7469 616c 2069   scipy.spatial i
-000435e0: 6d70 6f72 7420 436f 6e76 6578 4875 6c6c  mport ConvexHull
-000435f0: 0a20 2020 2066 726f 6d20 7368 6170 656c  .    from shapel
-00043600: 792e 6765 6f6d 6574 7279 2069 6d70 6f72  y.geometry impor
-00043610: 7420 506f 6c79 676f 6e2c 2050 6f69 6e74  t Polygon, Point
-00043620: 0a0a 2020 2020 7879 203d 206e 702e 6172  ..    xy = np.ar
-00043630: 7261 7928 5b78 2c20 795d 292e 540a 2020  ray([x, y]).T.  
-00043640: 2020 6875 6c6c 203d 2043 6f6e 7665 7848    hull = ConvexH
-00043650: 756c 6c28 7879 290a 2020 2020 7078 7920  ull(xy).    pxy 
-00043660: 3d20 7879 5b68 756c 6c2e 7665 7274 6963  = xy[hull.vertic
-00043670: 6573 2c20 3a5d 0a20 2020 2070 6f6c 7920  es, :].    poly 
-00043680: 3d20 506f 6c79 676f 6e28 7078 7929 0a20  = Polygon(pxy). 
-00043690: 2020 200a 2020 2020 7265 7475 726e 2070     .    return p
-000436a0: 7879 2c20 706f 6c79 2c20 6875 6c6c 0a0a  xy, poly, hull..
-000436b0: 0a64 6566 2068 756c 6c5f 6172 6561 2878  .def hull_area(x
-000436c0: 2c20 7929 3a0a 2020 2020 2222 220a 2020  , y):.    """.  
-000436d0: 2020 5265 7475 726e 2074 6865 2061 7265    Return the are
-000436e0: 6120 6f66 2061 2063 6f6e 7665 7820 6875  a of a convex hu
-000436f0: 6c6c 206f 6620 6120 6c69 7374 206f 6620  ll of a list of 
-00043700: 706f 696e 7473 0a20 2020 2022 2222 0a20  points.    """. 
-00043710: 2020 2070 7879 2c20 706f 6c79 2c20 6875     pxy, poly, hu
-00043720: 6c6c 203d 2063 6f6e 7665 785f 6875 6c6c  ll = convex_hull
-00043730: 5f77 7261 7070 6572 2878 2c20 7929 0a0a  _wrapper(x, y)..
-00043740: 2020 2020 7265 7475 726e 2070 6f6c 792e      return poly.
-00043750: 6172 6561 0a20 2020 200a 2020 2020 0a64  area.    .    .d
-00043760: 6566 2072 656d 6f76 655f 7465 7874 5f6c  ef remove_text_l
-00043770: 6162 656c 7328 6669 6729 3a0a 2020 2020  abels(fig):.    
-00043780: 2222 220a 2020 2020 5265 6d6f 7665 2061  """.    Remove a
-00043790: 6c6c 2054 6578 7420 616e 6e6f 7461 7469  ll Text annotati
-000437a0: 6f6e 7320 6672 6f6d 2060 6066 6967 2e61  ons from ``fig.a
-000437b0: 7865 7360 602e 0a20 2020 2022 2222 0a20  xes``..    """. 
-000437c0: 2020 2069 6d70 6f72 7420 6d61 7470 6c6f     import matplo
-000437d0: 746c 6962 0a20 2020 200a 2020 2020 666f  tlib.    .    fo
-000437e0: 7220 6178 2069 6e20 6669 672e 6178 6573  r ax in fig.axes
-000437f0: 3a0a 2020 2020 2020 2020 666f 7220 6368  :.        for ch
-00043800: 696c 6420 696e 2061 782e 6765 745f 6368  ild in ax.get_ch
-00043810: 696c 6472 656e 2829 3a0a 2020 2020 2020  ildren():.      
-00043820: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00043830: 6e63 6528 6368 696c 642c 206d 6174 706c  nce(child, matpl
-00043840: 6f74 6c69 622e 7465 7874 2e54 6578 7429  otlib.text.Text)
-00043850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00043860: 2020 6966 2063 6869 6c64 2e67 6574 5f74    if child.get_t
-00043870: 6578 7428 293a 2023 2044 6f6e 2774 2072  ext(): # Don't r
-00043880: 656d 6f76 6520 656d 7074 7920 6c61 6265  emove empty labe
-00043890: 6c73 0a20 2020 2020 2020 2020 2020 2020  ls.             
-000438a0: 2020 2020 2020 2063 6869 6c64 2e73 6574         child.set
-000438b0: 5f76 6973 6962 6c65 2846 616c 7365 290a  _visible(False).
-000438c0: 0a20 2020 200a 4c4f 4746 494c 4520 3d20  .    .LOGFILE = 
-000438d0: 272f 746d 702f 6772 697a 6c69 2e6c 6f67  '/tmp/grizli.log
-000438e0: 270a 0a0a 6465 6620 6c6f 675f 6675 6e63  '...def log_func
-000438f0: 7469 6f6e 5f61 7267 756d 656e 7473 284c  tion_arguments(L
-00043900: 4f47 4649 4c45 2c20 6672 616d 652c 2066  OGFILE, frame, f
-00043910: 756e 633d 2766 756e 6327 2c20 6967 6e6f  unc='func', igno
-00043920: 7265 3d5b 5d2c 2076 6572 626f 7365 3d54  re=[], verbose=T
-00043930: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
-00043940: 2020 4c6f 6720 6c6f 6361 6c20 7661 7269    Log local vari
-00043950: 6162 6c65 732c 2065 2e67 2e2c 2070 6172  ables, e.g., par
-00043960: 616d 6574 6572 2061 7267 7565 6d65 6e74  ameter arguement
-00043970: 7320 746f 2061 2066 696c 650a 0a20 2020  s to a file..   
-00043980: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00043990: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 204c  ----------.    L
-000439a0: 4f47 4649 4c45 203a 2073 7472 206f 7220  OGFILE : str or 
-000439b0: 4e6f 6e65 0a20 2020 2020 2020 204f 7574  None.        Out
-000439c0: 7075 7420 6669 6c65 2e20 2049 6620 604e  put file.  If `N
-000439d0: 6f6e 6560 2c20 7468 656e 2066 6f72 6365  one`, then force
-000439e0: 2060 7665 7262 6f73 653d 5472 7565 602e   `verbose=True`.
-000439f0: 0a0a 2020 2020 6672 616d 6520 3a20 607e  ..    frame : `~
-00043a00: 696e 7370 6563 742e 6375 7272 656e 7466  inspect.currentf
-00043a10: 7261 6d65 2829 600a 2020 2020 2020 2020  rame()`.        
-00043a20: 4e61 6d65 7370 6163 6520 6f62 6a65 6374  Namespace object
-00043a30: 2e0a 0a20 2020 2066 756e 6320 3a20 7374  ...    func : st
-00043a40: 720a 2020 2020 2020 2020 4675 6e63 7469  r.        Functi
-00043a50: 6f6e 206e 616d 6520 746f 2075 7365 0a20  on name to use. 
-00043a60: 2020 200a 2020 2020 6967 6e6f 7265 203a     .    ignore :
-00043a70: 206c 6973 740a 2020 2020 2020 2020 5661   list.        Va
-00043a80: 7269 6162 6c65 206e 616d 6573 2074 6f20  riable names to 
-00043a90: 6967 6e6f 7265 0a20 2020 200a 2020 2020  ignore.    .    
-00043aa0: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
-00043ab0: 2020 2020 2020 2050 7269 6e74 206d 6573         Print mes
-00043ac0: 7361 6167 6520 746f 2073 7464 6f75 742e  saage to stdout.
-00043ad0: 0a0a 2020 2020 2222 220a 2020 2020 6172  ..    """.    ar
-00043ae0: 6773 203d 2069 6e73 7065 6374 2e67 6574  gs = inspect.get
-00043af0: 6172 6776 616c 7565 7328 6672 616d 6529  argvalues(frame)
-00043b00: 2e6c 6f63 616c 730a 2020 2020 6172 6773  .locals.    args
-00043b10: 2e70 6f70 2827 6672 616d 6527 290a 2020  .pop('frame').  
-00043b20: 2020 666f 7220 6b20 696e 206c 6973 7428    for k in list(
-00043b30: 6172 6773 2e6b 6579 7328 2929 3a0a 2020  args.keys()):.  
-00043b40: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
-00043b50: 2861 7267 735b 6b5d 2c20 275f 5f62 7569  (args[k], '__bui
-00043b60: 6c74 696e 735f 5f27 293a 0a20 2020 2020  ltins__'):.     
-00043b70: 2020 2020 2020 2061 7267 732e 706f 7028         args.pop(
-00043b80: 6b29 0a20 2020 200a 2020 2020 666f 7220  k).    .    for 
-00043b90: 6b20 696e 2069 676e 6f72 653a 0a20 2020  k in ignore:.   
-00043ba0: 2020 2020 2069 6620 6b20 696e 2061 7267       if k in arg
-00043bb0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-00043bc0: 7267 732e 706f 7028 6b29 0a20 2020 2020  rgs.pop(k).     
-00043bd0: 2020 2020 2020 200a 2020 2020 6966 2066         .    if f
-00043be0: 756e 6320 6973 206e 6f74 204e 6f6e 653a  unc is not None:
-00043bf0: 0a20 2020 2020 2020 206c 6f67 7374 7220  .        logstr 
-00043c00: 3d20 275c 6e7b 307d 282a 2a7b 317d 295c  = '\n{0}(**{1})\
-00043c10: 6e27 0a20 2020 2065 6c73 653a 0a20 2020  n'.    else:.   
-00043c20: 2020 2020 206c 6f67 7374 7220 3d20 275c       logstr = '\
-00043c30: 6e7b 317d 270a 0a20 2020 206c 6f67 7374  n{1}'..    logst
-00043c40: 7220 3d20 6c6f 6773 7472 2e66 6f72 6d61  r = logstr.forma
-00043c50: 7428 6675 6e63 2c20 6172 6773 290a 2020  t(func, args).  
-00043c60: 2020 6d73 6720 3d20 6c6f 675f 636f 6d6d    msg = log_comm
-00043c70: 656e 7428 4c4f 4746 494c 452c 206c 6f67  ent(LOGFILE, log
-00043c80: 7374 722c 2076 6572 626f 7365 3d76 6572  str, verbose=ver
-00043c90: 626f 7365 2c20 7368 6f77 5f64 6174 653d  bose, show_date=
-00043ca0: 5472 7565 290a 0a20 2020 2072 6574 7572  True)..    retur
-00043cb0: 6e20 6d73 670a 0a0a 6465 6620 6374 696d  n msg...def ctim
-00043cc0: 655f 746f 5f69 736f 286d 7469 6d65 2c20  e_to_iso(mtime, 
-00043cd0: 666f 726d 6174 3d27 2561 2025 6220 2564  format='%a %b %d
-00043ce0: 2025 483a 254d 3a25 5320 2559 272c 2073   %H:%M:%S %Y', s
-00043cf0: 7472 6970 5f64 6563 696d 616c 3d54 7275  trip_decimal=Tru
-00043d00: 652c 2076 6572 626f 7365 3d54 7275 6529  e, verbose=True)
-00043d10: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
-00043d20: 6e76 6572 7420 6074 696d 652e 6374 696d  nvert `time.ctim
-00043d30: 6560 2073 7472 696e 6773 2074 6f20 4953  e` strings to IS
-00043d40: 4f20 6461 7465 730a 0a20 2020 2050 6172  O dates..    Par
-00043d50: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00043d60: 2d2d 2d2d 2d2d 0a20 2020 206d 7469 6d65  ------.    mtime
-00043d70: 203a 2073 7472 0a20 2020 2020 2020 2054   : str.        T
-00043d80: 696d 6520 7374 7269 6e67 2c20 6765 6e65  ime string, gene
-00043d90: 7261 6c6c 7920 6173 206f 7574 7075 7420  rally as output 
-00043da0: 6672 6f6d 2060 7469 6d65 2e63 7469 6d65  from `time.ctime
-00043db0: 602c 2065 2e67 2e2c 200a 2020 2020 2020  `, e.g., .      
-00043dc0: 2020 6060 274d 6f6e 2053 6570 2031 3620    ``'Mon Sep 16 
-00043dd0: 3131 3a32 333a 3237 2032 3031 3927 6060  11:23:27 2019'``
-00043de0: 0a0a 2020 2020 666f 726d 6174 203a 2073  ..    format : s
-00043df0: 7472 0a20 2020 2020 2020 2060 6461 7465  tr.        `date
-00043e00: 7469 6d65 2e73 7472 7074 696d 6560 2066  time.strptime` f
-00043e10: 6f72 6d61 7420 7374 7269 6e67 2c20 636f  ormat string, co
-00043e20: 6465 7320 6174 200a 2020 2020 2020 2020  des at .        
-00043e30: 6874 7470 733a 2f2f 7777 772e 7072 6f67  https://www.prog
-00043e40: 7261 6d69 7a2e 636f 6d2f 7079 7468 6f6e  ramiz.com/python
-00043e50: 2d70 726f 6772 616d 6d69 6e67 2f64 6174  -programming/dat
-00043e60: 6574 696d 652f 7374 7270 7469 6d65 0a0a  etime/strptime..
-00043e70: 2020 2020 7374 7269 705f 6465 6369 6d61      strip_decima
-00043e80: 6c20 3a20 626f 6f6c 0a20 2020 2020 2020  l : bool.       
-00043e90: 2053 7472 6970 2064 6563 696d 616c 2073   Strip decimal s
-00043ea0: 6563 6f6e 6473 2066 726f 6d20 656e 6420  econds from end 
-00043eb0: 6f66 2049 534f 2073 7472 696e 670a 0a20  of ISO string.. 
-00043ec0: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
-00043ed0: 6c0a 2020 2020 2020 2020 5072 696e 7420  l.        Print 
-00043ee0: 6120 6d65 7373 6167 6520 6966 2063 6f6e  a message if con
-00043ef0: 7665 7273 696f 6e20 6661 696c 730a 0a20  version fails.. 
-00043f00: 2020 2052 6574 7572 6e73 200a 2020 2020     Returns .    
-00043f10: 2d2d 2d2d 2d2d 2d0a 2020 2020 6973 6f20  -------.    iso 
-00043f20: 3a20 7374 720a 2020 2020 2020 2020 5374  : str.        St
-00043f30: 7269 6e67 2069 6e20 2873 6f72 7461 626c  ring in (sortabl
-00043f40: 6529 2049 534f 2066 6f72 6d61 742c 2065  e) ISO format, e
-00043f50: 2e67 2e2c 2060 6027 3230 3139 2d30 392d  .g., ``'2019-09-
-00043f60: 3136 2031 313a 3233 3a32 372e 3030 3027  16 11:23:27.000'
-00043f70: 6060 0a0a 2020 2020 2222 220a 2020 2020  ``..    """.    
-00043f80: 6672 6f6d 2061 7374 726f 7079 2e74 696d  from astropy.tim
-00043f90: 6520 696d 706f 7274 2054 696d 650a 2020  e import Time.  
-00043fa0: 2020 6672 6f6d 2064 6174 6574 696d 6520    from datetime 
-00043fb0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
-00043fc0: 0a20 2020 2023 2049 7320 616c 7265 6164  .    # Is alread
-00043fd0: 7920 4953 4f20 666f 726d 6174 0a20 2020  y ISO format.   
-00043fe0: 2069 6620 6d74 696d 652e 636f 756e 7428   if mtime.count(
-00043ff0: 272d 2729 203d 3d20 323a 0a20 2020 2020  '-') == 2:.     
-00044000: 2020 2069 736f 203d 206d 7469 6d65 202b     iso = mtime +
-00044010: 2027 270a 0a20 2020 2065 6c73 653a 0a20   ''..    else:. 
-00044020: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00044030: 2020 2020 2020 2020 6973 6f20 3d20 5469          iso = Ti
-00044040: 6d65 2864 6174 6574 696d 652e 7374 7270  me(datetime.strp
-00044050: 7469 6d65 286d 7469 6d65 2c20 666f 726d  time(mtime, form
-00044060: 6174 292c 200a 2020 2020 2020 2020 2020  at), .          
-00044070: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00044080: 6d61 743d 2764 6174 6574 696d 6527 292e  mat='datetime').
-00044090: 6973 6f0a 2020 2020 2020 2020 6578 6365  iso.        exce
-000440a0: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
-000440b0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-000440c0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-000440d0: 2020 2020 2020 2070 7269 6e74 2866 2743         print(f'C
-000440e0: 6f75 6c64 6e5c 2774 2063 6f6e 7665 7274  ouldn\'t convert
-000440f0: 205c 277b 6d74 696d 657d 5c27 2077 6974   \'{mtime}\' wit
-00044100: 6820 270a 2020 2020 2020 2020 2020 2020  h '.            
-00044110: 2020 2020 2020 2020 2020 6627 666f 726d            f'form
-00044120: 6174 205c 277b 666f 726d 6174 7d5c 2727  at \'{format}\''
-00044130: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00044140: 736f 203d 206d 7469 6d65 202b 2027 270a  so = mtime + ''.
-00044150: 0a20 2020 2069 6620 7374 7269 705f 6465  .    if strip_de
-00044160: 6369 6d61 6c3a 0a20 2020 2020 2020 2069  cimal:.        i
-00044170: 736f 203d 2069 736f 2e73 706c 6974 2827  so = iso.split('
-00044180: 2e27 295b 305d 0a0a 2020 2020 7265 7475  .')[0]..    retu
-00044190: 726e 2069 736f 0a0a 0a64 6566 206e 6f77  rn iso...def now
-000441a0: 7469 6d65 2869 736f 3d54 7275 6529 3a0a  time(iso=True):.
-000441b0: 2020 2020 2222 220a 2020 2020 5772 6170      """.    Wrap
-000441c0: 7065 7220 666f 7220 6061 7374 726f 7079  per for `astropy
-000441d0: 2e74 696d 652e 6e6f 7760 0a0a 2020 2020  .time.now`..    
-000441e0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000441f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6973  ---------.    is
-00044200: 6f20 3a20 626f 6f6c 0a20 2020 2020 2020  o : bool.       
-00044210: 2049 6620 5472 7565 2c20 7265 7475 726e   If True, return
-00044220: 2074 696d 6520 696e 2049 534f 2073 7472   time in ISO str
-00044230: 696e 672c 2065 6c73 6520 7265 7475 726e  ing, else return
-00044240: 2054 696d 6520 6f62 6a65 6374 0a0a 2020   Time object..  
-00044250: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-00044260: 2d2d 2d2d 2d0a 2020 2020 746e 6f77 203a  -----.    tnow :
-00044270: 2073 7472 0a20 2020 2020 2020 2053 6565   str.        See
-00044280: 2060 6973 6f60 0a0a 2020 2020 2222 220a   `iso`..    """.
-00044290: 2020 2020 6672 6f6d 2061 7374 726f 7079      from astropy
-000442a0: 2e74 696d 6520 696d 706f 7274 2054 696d  .time import Tim
-000442b0: 650a 2020 2020 746e 6f77 203d 2054 696d  e.    tnow = Tim
-000442c0: 652e 6e6f 7728 290a 2020 2020 6966 2069  e.now().    if i
-000442d0: 736f 3a0a 2020 2020 2020 2020 7265 7475  so:.        retu
-000442e0: 726e 2074 6e6f 772e 6973 6f0a 2020 2020  rn tnow.iso.    
-000442f0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-00044300: 7475 726e 2074 6e6f 770a 0a0a 6465 6620  turn tnow...def 
-00044310: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
-00044320: 494c 452c 2063 6f6d 6d65 6e74 2c20 7665  ILE, comment, ve
-00044330: 7262 6f73 653d 4661 6c73 652c 2073 686f  rbose=False, sho
-00044340: 775f 6461 7465 3d46 616c 7365 2c20 6d6f  w_date=False, mo
-00044350: 6465 3d27 6127 293a 0a20 2020 2022 2222  de='a'):.    """
-00044360: 0a20 2020 204c 6f67 2061 206d 6573 7361  .    Log a messa
-00044370: 6765 2074 6f20 6120 6669 6c65 2c20 6f70  ge to a file, op
-00044380: 7469 6f6e 616c 6c79 2069 6e63 6c75 6469  tionally includi
-00044390: 6e67 2061 2064 6174 6520 7461 670a 2020  ng a date tag.  
-000443a0: 2020 2222 220a 2020 2020 696d 706f 7274    """.    import
-000443b0: 2074 696d 650a 0a20 2020 2069 6620 7368   time..    if sh
-000443c0: 6f77 5f64 6174 653a 0a20 2020 2020 2020  ow_date:.       
-000443d0: 206d 7367 203d 2027 2320 287b 307d 295c   msg = '# ({0})\
-000443e0: 6e27 2e66 6f72 6d61 7428 6e6f 7774 696d  n'.format(nowtim
-000443f0: 6528 2929 0a20 2020 2065 6c73 653a 0a20  e()).    else:. 
-00044400: 2020 2020 2020 206d 7367 203d 2027 270a         msg = ''.
-00044410: 0a20 2020 206d 7367 202b 3d20 277b 307d  .    msg += '{0}
-00044420: 5c6e 272e 666f 726d 6174 2863 6f6d 6d65  \n'.format(comme
-00044430: 6e74 290a 0a20 2020 2069 6620 4c4f 4746  nt)..    if LOGF
-00044440: 494c 4520 6973 206e 6f74 204e 6f6e 653a  ILE is not None:
-00044450: 0a20 2020 2020 2020 2066 7020 3d20 6f70  .        fp = op
-00044460: 656e 284c 4f47 4649 4c45 2c20 6d6f 6465  en(LOGFILE, mode
-00044470: 290a 2020 2020 2020 2020 6670 2e77 7269  ).        fp.wri
-00044480: 7465 286d 7367 290a 2020 2020 2020 2020  te(msg).        
-00044490: 6670 2e63 6c6f 7365 2829 0a0a 2020 2020  fp.close()..    
-000444a0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-000444b0: 2020 2020 7072 696e 7428 6d73 675b 3a2d      print(msg[:-
-000444c0: 315d 290a 0a20 2020 2072 6574 7572 6e20  1])..    return 
-000444d0: 6d73 670a 0a0a 6465 6620 6c6f 675f 6578  msg...def log_ex
-000444e0: 6365 7074 696f 6e28 4c4f 4746 494c 452c  ception(LOGFILE,
-000444f0: 2074 7261 6365 6261 636b 2c20 7665 7262   traceback, verb
-00044500: 6f73 653d 5472 7565 2c20 6d6f 6465 3d27  ose=True, mode='
-00044510: 6127 293a 0a20 2020 2022 2222 0a20 2020  a'):.    """.   
-00044520: 204c 6f67 2065 7863 6570 7469 6f6e 2069   Log exception i
-00044530: 6e66 6f72 6d61 7469 6f6e 2074 6f20 6120  nformation to a 
-00044540: 6669 6c65 2c20 6f72 2070 7269 6e74 2074  file, or print t
-00044550: 6f20 7363 7265 656e 0a0a 2020 2020 5061  o screen..    Pa
-00044560: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00044570: 2d2d 2d2d 2d2d 2d0a 2020 2020 4c4f 4746  -------.    LOGF
-00044580: 494c 4520 3a20 7374 7220 6f72 204e 6f6e  ILE : str or Non
-00044590: 650a 2020 2020 2020 2020 4f75 7470 7574  e.        Output
-000445a0: 2066 696c 652e 2020 4966 2060 4e6f 6e65   file.  If `None
-000445b0: 602c 2074 6865 6e20 666f 7263 6520 6076  `, then force `v
-000445c0: 6572 626f 7365 3d54 7275 6560 2e0a 0a20  erbose=True`... 
-000445d0: 2020 2074 7261 6365 6261 636b 203a 2062     traceback : b
-000445e0: 7569 6c74 696e 2074 7261 6365 6261 636b  uiltin traceback
-000445f0: 206d 6f64 756c 650a 2020 2020 2020 2020   module.        
-00044600: 4578 6365 7074 696f 6e20 7472 6163 6562  Exception traceb
-00044610: 6163 6b2c 2066 726f 6d20 676c 6f62 616c  ack, from global
-00044620: 2060 696d 706f 7274 2074 7261 6365 6261   `import traceba
-00044630: 636b 602e 0a0a 2020 2020 7665 7262 6f73  ck`...    verbos
-00044640: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
-00044650: 2050 7269 6e74 2065 7863 6570 7469 6f6e   Print exception
-00044660: 2074 6f20 7374 646f 7574 2e0a 0a20 2020   to stdout...   
-00044670: 206d 6f64 6520 3a20 2761 272c 2027 7727   mode : 'a', 'w'
-00044680: 0a20 2020 2020 2020 2046 696c 6520 6d6f  .        File mo
-00044690: 6465 206f 6e20 606f 7065 6e28 4c4f 4746  de on `open(LOGF
-000446a0: 494c 452c 206d 6f64 6529 602c 2069 2e65  ILE, mode)`, i.e
-000446b0: 2e2c 2061 7070 656e 6420 6f72 2077 7269  ., append or wri
-000446c0: 7465 2e0a 0a20 2020 2022 2222 0a20 2020  te...    """.   
-000446d0: 2069 6d70 6f72 7420 7469 6d65 0a0a 2020   import time..  
-000446e0: 2020 7472 6163 6520 3d20 7472 6163 6562    trace = traceb
-000446f0: 6163 6b2e 666f 726d 6174 5f65 7863 286c  ack.format_exc(l
-00044700: 696d 6974 3d32 290a 2020 2020 6c6f 6720  imit=2).    log 
-00044710: 3d20 275c 6e23 2323 2323 2323 2323 2323  = '\n###########
-00044720: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00044730: 2323 2323 2323 2323 2323 2323 2323 2320  ############### 
-00044740: 5c6e 270a 2020 2020 6c6f 6720 2b3d 2027  \n'.    log += '
-00044750: 2320 2120 4578 6365 7074 696f 6e20 287b  # ! Exception ({
-00044760: 307d 295c 6e27 2e66 6f72 6d61 7428 6e6f  0})\n'.format(no
-00044770: 7774 696d 6528 2929 0a20 2020 206c 6f67  wtime()).    log
-00044780: 202b 3d20 2723 5c6e 2320 2127 2b27 5c6e   += '#\n# !'+'\n
-00044790: 2320 2127 2e6a 6f69 6e28 7472 6163 652e  # !'.join(trace.
-000447a0: 7370 6c69 7428 275c 6e27 2929 0a20 2020  split('\n')).   
-000447b0: 206c 6f67 202b 3d20 275c 6e23 2323 2323   log += '\n#####
-000447c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000447d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000447e0: 2323 2323 205c 6e5c 6e27 0a20 2020 2069  #### \n\n'.    i
-000447f0: 6620 7665 7262 6f73 6520 7c20 284c 4f47  f verbose | (LOG
-00044800: 4649 4c45 2069 7320 4e6f 6e65 293a 0a20  FILE is None):. 
-00044810: 2020 2020 2020 2070 7269 6e74 286c 6f67         print(log
-00044820: 290a 0a20 2020 2069 6620 4c4f 4746 494c  )..    if LOGFIL
-00044830: 4520 6973 206e 6f74 204e 6f6e 653a 0a20  E is not None:. 
-00044840: 2020 2020 2020 2066 7020 3d20 6f70 656e         fp = open
-00044850: 284c 4f47 4649 4c45 2c20 6d6f 6465 290a  (LOGFILE, mode).
-00044860: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
-00044870: 286c 6f67 290a 2020 2020 2020 2020 6670  (log).        fp
-00044880: 2e63 6c6f 7365 2829 0a0a 6465 6620 7369  .close()..def si
-00044890: 6d70 6c65 5f4c 4344 4d28 4f6d 303d 302e  mple_LCDM(Om0=0.
-000448a0: 332c 204f 6465 303d 302e 372c 2048 303d  3, Ode0=0.7, H0=
-000448b0: 3730 2c20 4f62 303d 302e 3034 3633 2c20  70, Ob0=0.0463, 
-000448c0: 5463 6d62 303d 322e 3732 352c 206e 616d  Tcmb0=2.725, nam
-000448d0: 653d 4e6f 6e65 293a 0a20 2020 2022 2222  e=None):.    """
-000448e0: 0a20 2020 2053 696d 706c 6520 4c61 6d62  .    Simple Lamb
-000448f0: 6461 4344 4d20 636f 736d 6f6c 6f67 790a  daCDM cosmology.
-00044900: 2020 2020 0a20 2020 2050 6172 616d 6574      .    Paramet
-00044910: 6572 7320 6172 6520 6465 6669 6e65 6420  ers are defined 
-00044920: 6173 2069 6e20 607e 6173 7472 6f70 792e  as in `~astropy.
-00044930: 636f 736d 6f6c 6f67 792e 4c61 6d62 6461  cosmology.Lambda
-00044940: 4344 4d60 2e0a 2020 2020 0a20 2020 2022  CDM`..    .    "
-00044950: 2222 0a20 2020 2066 726f 6d20 6173 7472  "".    from astr
-00044960: 6f70 792e 636f 736d 6f6c 6f67 7920 696d  opy.cosmology im
-00044970: 706f 7274 204c 616d 6264 6143 444d 0a20  port LambdaCDM. 
-00044980: 2020 2063 6f73 6d6f 6c6f 6779 203d 204c     cosmology = L
-00044990: 616d 6264 6143 444d 2848 302c 204f 6d30  ambdaCDM(H0, Om0
-000449a0: 2c20 4f64 6530 2c20 5463 6d62 303d 5463  , Ode0, Tcmb0=Tc
-000449b0: 6d62 302c 206e 616d 653d 6e61 6d65 290a  mb0, name=name).
-000449c0: 2020 2020 7265 7475 726e 2063 6f73 6d6f      return cosmo
-000449d0: 6c6f 6779 0a0a 0a64 6566 2070 6978 656c  logy...def pixel
-000449e0: 5f70 6f6c 7967 6f6e 5f6d 6173 6b28 706f  _polygon_mask(po
-000449f0: 6c79 676f 6e2c 2073 6861 7065 2c20 7763  lygon, shape, wc
-00044a00: 733d 4e6f 6e65 293a 0a20 2020 2022 2222  s=None):.    """
-00044a10: 0a20 2020 204d 616b 6520 6120 6d61 736b  .    Make a mask
-00044a20: 2070 6f69 6e74 7320 696e 2061 2032 4420   points in a 2D 
-00044a30: 6172 7261 7920 696e 7369 6465 2061 2070  array inside a p
-00044a40: 6f6c 7967 6f6e 0a20 2020 200a 2020 2020  olygon.    .    
-00044a50: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00044a60: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 706f  ---------.    po
-00044a70: 6c79 676f 6e20 3a20 7374 722c 2028 322c  lygon : str, (2,
-00044a80: 4d29 2061 7272 6179 0a20 2020 2020 2020  M) array.       
-00044a90: 2053 6f6d 6574 6869 6e67 2074 6861 7420   Something that 
-00044aa0: 6067 7269 7a6c 692e 7574 696c 732e 5352  `grizli.utils.SR
-00044ab0: 6567 696f 6e60 2063 616e 2070 6172 7365  egion` can parse
-00044ac0: 2061 7320 6120 706f 6c79 676f 6e0a 2020   as a polygon.  
-00044ad0: 2020 0a20 2020 2073 6861 7065 203a 2074    .    shape : t
-00044ae0: 7570 6c65 0a20 2020 2020 2020 2032 2d74  uple.        2-t
-00044af0: 7570 6c65 206f 6620 696d 6167 6520 6469  uple of image di
-00044b00: 6d65 6e73 696f 6e73 0a20 2020 200a 2020  mensions.    .  
-00044b10: 2020 7763 7320 3a20 6061 7374 726f 7079    wcs : `astropy
-00044b20: 2e77 6373 2e57 4353 600a 2020 2020 2020  .wcs.WCS`.      
-00044b30: 2020 4966 2073 7065 6369 6669 6564 2c20    If specified, 
-00044b40: 6173 7375 6d65 2060 6070 6f6c 7967 6f6e  assume ``polygon
-00044b50: 6060 2069 7320 736b 7920 636f 6f72 6469  `` is sky coordi
-00044b60: 6e61 7465 7320 616e 6420 7472 616e 7366  nates and transf
-00044b70: 6f72 6d20 746f 0a20 2020 2020 2020 2069  orm to.        i
-00044b80: 6d61 6765 2e0a 2020 2020 0a20 2020 2052  mage..    .    R
-00044b90: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00044ba0: 2d2d 0a20 2020 206d 6173 6b20 3a20 6172  --.    mask : ar
-00044bb0: 7261 790a 2020 2020 2020 2020 6060 626f  ray.        ``bo
-00044bc0: 6f6c 6060 2061 7272 6179 2077 6974 6820  ol`` array with 
-00044bd0: 6060 7368 6170 6560 6020 7468 6174 2069  ``shape`` that i
-00044be0: 7320 6054 7275 6560 2069 6e73 6964 6520  s `True` inside 
-00044bf0: 6070 6f6c 7967 6f6e 600a 2020 2020 2222  `polygon`.    ""
-00044c00: 220a 2020 2020 7372 203d 2053 5265 6769  ".    sr = SRegi
-00044c10: 6f6e 2870 6f6c 7967 6f6e 2c20 7772 6170  on(polygon, wrap
-00044c20: 3d46 616c 7365 290a 2020 2020 0a20 2020  =False).    .   
-00044c30: 2079 702c 2078 7020 3d20 6e70 2e69 6e64   yp, xp = np.ind
-00044c40: 6963 6573 2873 6861 7065 290a 2020 2020  ices(shape).    
-00044c50: 7074 7320 3d20 6e70 2e61 7272 6179 285b  pts = np.array([
-00044c60: 7870 2e66 6c61 7474 656e 2829 2c20 7970  xp.flatten(), yp
-00044c70: 2e66 6c61 7474 656e 2829 5d29 2e54 0a20  .flatten()]).T. 
-00044c80: 2020 200a 2020 2020 6966 2077 6373 2069     .    if wcs i
-00044c90: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00044ca0: 2020 2020 7074 7320 3d20 7763 732e 616c      pts = wcs.al
-00044cb0: 6c5f 7069 7832 776f 726c 6428 7074 732c  l_pix2world(pts,
-00044cc0: 2030 290a 2020 2020 2020 2020 0a20 2020   0).        .   
-00044cd0: 206d 6173 6b20 3d20 6e70 2e7a 6572 6f73   mask = np.zeros
-00044ce0: 2873 6861 7065 2c20 6474 7970 653d 626f  (shape, dtype=bo
-00044cf0: 6f6c 292e 666c 6174 7465 6e28 290a 2020  ol).flatten().  
-00044d00: 2020 666f 7220 7020 696e 2073 722e 7061    for p in sr.pa
-00044d10: 7468 3a0a 2020 2020 2020 2020 6d61 736b  th:.        mask
-00044d20: 207c 3d20 702e 636f 6e74 6169 6e73 5f70   |= p.contains_p
-00044d30: 6f69 6e74 7328 7074 7329 0a20 2020 200a  oints(pts).    .
-00044d40: 2020 2020 7265 7475 726e 206d 6173 6b2e      return mask.
-00044d50: 7265 7368 6170 6528 7368 6170 6529 0a0a  reshape(shape)..
-00044d60: 0a64 6566 206d 616b 655f 6669 6c74 6572  .def make_filter
-00044d70: 5f66 6f6f 7470 7269 6e74 2866 696c 7465  _footprint(filte
-00044d80: 725f 7369 7a65 3d37 312c 2066 696c 7465  r_size=71, filte
-00044d90: 725f 6365 6e74 7261 6c3d 302c 202a 2a6b  r_central=0, **k
-00044da0: 7761 7267 7329 3a0a 2020 2020 2222 220a  wargs):.    """.
-00044db0: 2020 2020 4d61 6b65 2061 2066 6f6f 7470      Make a footp
-00044dc0: 7269 6e74 2066 6f72 2069 6d61 6765 2066  rint for image f
-00044dd0: 696c 7465 7269 6e67 0a20 2020 2022 2222  iltering.    """
-00044de0: 0a20 2020 2066 696c 7465 725f 666f 6f74  .    filter_foot
-00044df0: 7072 696e 7420 3d20 6e70 2e6f 6e65 7328  print = np.ones(
-00044e00: 6669 6c74 6572 5f73 697a 652c 2064 7479  filter_size, dty
-00044e10: 7065 3d69 6e74 290a 2020 2020 0a20 2020  pe=int).    .   
-00044e20: 2069 6620 6669 6c74 6572 5f63 656e 7472   if filter_centr
-00044e30: 616c 203e 2030 3a0a 2020 2020 2020 2020  al > 0:.        
-00044e40: 6630 203d 2028 6669 6c74 6572 5f73 697a  f0 = (filter_siz
-00044e50: 652d 3129 2f2f 320a 2020 2020 2020 2020  e-1)//2.        
-00044e60: 6669 6c74 6572 5f66 6f6f 7470 7269 6e74  filter_footprint
-00044e70: 5b66 302d 6669 6c74 6572 5f63 656e 7472  [f0-filter_centr
-00044e80: 616c 3a66 302b 6669 6c74 6572 5f63 656e  al:f0+filter_cen
-00044e90: 7472 616c 5d20 3d20 300a 2020 2020 0a20  tral] = 0.    . 
-00044ea0: 2020 2072 6574 7572 6e20 6669 6c74 6572     return filter
-00044eb0: 5f66 6f6f 7470 7269 6e74 0a0a 0a64 6566  _footprint...def
-00044ec0: 2073 6166 655f 6e61 6e6d 6564 6961 6e5f   safe_nanmedian_
-00044ed0: 6669 6c74 6572 2864 6174 612c 2066 696c  filter(data, fil
-00044ee0: 7465 725f 6b77 6172 6773 3d7b 7d2c 2066  ter_kwargs={}, f
-00044ef0: 696c 7465 725f 666f 6f74 7072 696e 743d  ilter_footprint=
-00044f00: 4e6f 6e65 2c20 6178 6973 3d31 2c20 636c  None, axis=1, cl
-00044f10: 6561 6e3d 5472 7565 2c20 6376 616c 3d30  ean=True, cval=0
-00044f20: 2e30 293a 0a20 2020 2022 2222 0a20 2020  .0):.    """.   
-00044f30: 2052 756e 206e 616e 6d65 6469 616e 2066   Run nanmedian f
-00044f40: 696c 7465 7220 6f6e 2060 6461 7461 600a  ilter on `data`.
-00044f50: 2020 2020 0a20 2020 2050 6172 616d 6574      .    Paramet
-00044f60: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00044f70: 2d2d 0a20 2020 2064 6174 6120 3a20 6172  --.    data : ar
-00044f80: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
-00044f90: 2054 6865 2032 4420 6461 7461 2074 6f20   The 2D data to 
-00044fa0: 6669 6c74 6572 0a20 2020 200a 2020 2020  filter.    .    
-00044fb0: 6669 6c74 6572 5f6b 7761 7267 7320 3a20  filter_kwargs : 
-00044fc0: 6469 6374 0a20 2020 2020 2020 2041 7267  dict.        Arg
-00044fd0: 756d 656e 7473 2074 6f20 607e 6772 697a  uments to `~griz
-00044fe0: 6c69 2e75 7469 6c73 2e6d 616b 655f 6669  li.utils.make_fi
-00044ff0: 6c74 6572 5f66 6f6f 7470 7269 6e74 6020  lter_footprint` 
-00045000: 746f 206d 616b 6520 6120 3144 2066 696c  to make a 1D fil
-00045010: 7465 720a 2020 2020 0a20 2020 2066 696c  ter.    .    fil
-00045020: 7465 725f 666f 6f74 7072 696e 7420 3a20  ter_footprint : 
-00045030: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
-00045040: 2020 2053 7065 6369 6679 2074 6865 2066     Specify the f
-00045050: 696c 7465 7220 6578 706c 6963 6974 6c79  ilter explicitly
-00045060: 2e20 2049 6620 3144 2c20 7468 656e 2077  .  If 1D, then w
-00045070: 696c 6c20 6170 706c 7920 7468 6520 6669  ill apply the fi
-00045080: 6c74 6572 206f 7665 720a 2020 2020 2020  lter over.      
-00045090: 2020 6061 7869 733d 3160 2028 692e 652e    `axis=1` (i.e.
-000450a0: 2c20 6078 6029 206f 6620 6060 6461 7461  , `x`) of ``data
-000450b0: 6060 0a20 2020 200a 2020 2020 6178 6973  ``.    .    axis
-000450c0: 203a 2030 206f 7220 310a 2020 2020 2020   : 0 or 1.      
-000450d0: 2020 2041 7869 7320 6f76 6572 2077 6869     Axis over whi
-000450e0: 6368 2074 6f20 6170 706c 7920 7468 6520  ch to apply the 
-000450f0: 6669 6c74 6572 2028 6060 6178 6973 3d31  filter (``axis=1
-00045100: 6060 2066 696c 7465 7273 206f 6e20 726f  `` filters on ro
-00045110: 7773 290a 2020 2020 0a20 2020 2063 6c65  ws).    .    cle
-00045120: 616e 2c20 6376 616c 203a 2062 6f6f 6c2c  an, cval : bool,
-00045130: 2073 6361 6c61 720a 2020 2020 2020 2020   scalar.        
-00045140: 5265 706c 6163 6520 607e 6e75 6d70 792e  Replace `~numpy.
-00045150: 6e61 6e60 2069 6e20 7468 6520 6f75 7470  nan` in the outp
-00045160: 7574 2077 6974 6820 6060 6376 616c 6060  ut with ``cval``
-00045170: 0a20 2020 200a 2020 2020 5265 7475 726e  .    .    Return
-00045180: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00045190: 2020 6669 6c74 6572 5f64 6174 6120 3a20    filter_data : 
-000451a0: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
-000451b0: 2020 2046 696c 7465 7265 6420 6461 7461     Filtered data
-000451c0: 0a20 2020 200a 2020 2020 6669 6c74 6572  .    .    filter
-000451d0: 5f6e 616d 6520 3a20 7374 720a 2020 2020  _name : str.    
-000451e0: 2020 2020 5468 6520 7479 7065 206f 6620      The type of 
-000451f0: 6669 6c74 6572 2074 6861 7420 7761 7320  filter that was 
-00045200: 6170 706c 6965 643a 2060 6e62 7574 696c  applied: `nbutil
-00045210: 732e 6e61 6e6d 6564 6961 6e60 2069 6620  s.nanmedian` if 
-00045220: 0a20 2020 2020 2020 2060 7e67 7269 7a6c  .        `~grizl
-00045230: 692e 6e62 7574 696c 732e 6e61 6e6d 6564  i.nbutils.nanmed
-00045240: 6961 6e60 2077 6173 2069 6d70 6f72 7465  ian` was importe
-00045250: 6420 7375 6363 6573 7366 756c 6c79 2061  d successfully a
-00045260: 6e64 200a 2020 2020 2020 2020 606d 6564  nd .        `med
-00045270: 6961 6e5f 6669 6c74 6572 6020 666f 7220  ian_filter` for 
-00045280: 7468 6520 6661 6c6c 6261 636b 2074 6f20  the fallback to 
-00045290: 6073 6369 702e 6e64 696d 6167 652e 6d65  `scip.ndimage.me
-000452a0: 6469 616e 5f66 696c 7465 7260 200a 2020  dian_filter` .  
-000452b0: 2020 2020 2020 6f74 6865 7277 6973 652e        otherwise.
-000452c0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-000452d0: 6f72 7420 7363 6970 792e 6e64 696d 6167  ort scipy.ndimag
-000452e0: 6520 6173 206e 640a 2020 2020 0a20 2020  e as nd.    .   
-000452f0: 2074 7279 3a0a 2020 2020 2020 2020 6672   try:.        fr
-00045300: 6f6d 202e 2069 6d70 6f72 7420 6e62 7574  om . import nbut
-00045310: 696c 730a 2020 2020 2020 2020 5f66 696c  ils.        _fil
-00045320: 7465 725f 6e61 6d65 203d 2027 6e62 7574  ter_name = 'nbut
-00045330: 696c 732e 6e61 6e6d 6564 6961 6e27 0a20  ils.nanmedian'. 
-00045340: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00045350: 2020 206e 6275 7469 6c73 203d 204e 6f6e     nbutils = Non
-00045360: 650a 2020 2020 2020 2020 5f66 696c 7465  e.        _filte
-00045370: 725f 6e61 6d65 203d 2027 6d65 6469 616e  r_name = 'median
-00045380: 5f66 696c 7465 7227 0a20 2020 200a 2020  _filter'.    .  
-00045390: 2020 6966 2066 696c 7465 725f 666f 6f74    if filter_foot
-000453a0: 7072 696e 7420 6973 204e 6f6e 653a 0a20  print is None:. 
-000453b0: 2020 2020 2020 205f 6669 6c74 6572 5f66         _filter_f
-000453c0: 6f6f 7470 7269 6e74 203d 206d 616b 655f  ootprint = make_
-000453d0: 6669 6c74 6572 5f66 6f6f 7470 7269 6e74  filter_footprint
-000453e0: 282a 2a66 696c 7465 725f 6b77 6172 6773  (**filter_kwargs
-000453f0: 290a 2020 2020 2020 2020 6966 2061 7869  ).        if axi
-00045400: 7320 3d3d 2031 3a0a 2020 2020 2020 2020  s == 1:.        
-00045410: 2020 2020 5f66 696c 7465 725f 666f 6f74      _filter_foot
-00045420: 7072 696e 7420 3d20 5f66 696c 7465 725f  print = _filter_
-00045430: 666f 6f74 7072 696e 745b 4e6f 6e65 2c3a  footprint[None,:
-00045440: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-00045450: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
-00045460: 7465 725f 666f 6f74 7072 696e 7420 3d20  ter_footprint = 
-00045470: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
-00045480: 745b 3a2c 4e6f 6e65 5d0a 2020 2020 656c  t[:,None].    el
-00045490: 7365 3a0a 2020 2020 2020 2020 6966 2066  se:.        if f
-000454a0: 696c 7465 725f 666f 6f74 7072 696e 742e  ilter_footprint.
-000454b0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-000454c0: 2020 2020 2020 2069 6620 6178 6973 203d         if axis =
-000454d0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-000454e0: 2020 2020 205f 6669 6c74 6572 5f66 6f6f       _filter_foo
-000454f0: 7470 7269 6e74 203d 2066 696c 7465 725f  tprint = filter_
-00045500: 666f 6f74 7072 696e 745b 4e6f 6e65 2c3a  footprint[None,:
-00045510: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-00045520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00045530: 2020 2020 5f66 696c 7465 725f 666f 6f74      _filter_foot
-00045540: 7072 696e 7420 3d20 6669 6c74 6572 5f66  print = filter_f
-00045550: 6f6f 7470 7269 6e74 5b3a 2c4e 6f6e 655d  ootprint[:,None]
-00045560: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00045570: 2020 2020 2020 2020 2020 205f 6669 6c74             _filt
-00045580: 6572 5f66 6f6f 7470 7269 6e74 203d 2066  er_footprint = f
-00045590: 696c 7465 725f 666f 6f74 7072 696e 740a  ilter_footprint.
-000455a0: 2020 2020 0a20 2020 2069 6620 6e62 7574      .    if nbut
-000455b0: 696c 7320 6973 204e 6f6e 653a 0a20 2020  ils is None:.   
-000455c0: 2020 2020 2066 696c 7465 725f 6461 7461       filter_data
-000455d0: 203d 206e 642e 6d65 6469 616e 5f66 696c   = nd.median_fil
-000455e0: 7465 7228 6461 7461 2c20 666f 6f74 7072  ter(data, footpr
-000455f0: 696e 743d 5f66 696c 7465 725f 666f 6f74  int=_filter_foot
-00045600: 7072 696e 7429 0a20 2020 2065 6c73 653a  print).    else:
-00045610: 0a20 2020 2020 2020 2066 696c 7465 725f  .        filter_
-00045620: 6461 7461 203d 206e 642e 6765 6e65 7269  data = nd.generi
-00045630: 635f 6669 6c74 6572 2864 6174 612c 206e  c_filter(data, n
-00045640: 6275 7469 6c73 2e6e 616e 6d65 6469 616e  butils.nanmedian
-00045650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00045660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045670: 2020 2020 2020 2020 2020 666f 6f74 7072            footpr
-00045680: 696e 743d 5f66 696c 7465 725f 666f 6f74  int=_filter_foot
-00045690: 7072 696e 7429 0a20 2020 2020 2020 2069  print).        i
-000456a0: 6620 636c 6561 6e3a 0a20 2020 2020 2020  f clean:.       
-000456b0: 2020 2020 2066 696c 7465 725f 6461 7461       filter_data
-000456c0: 5b7e 6e70 2e69 7366 696e 6974 6528 6669  [~np.isfinite(fi
-000456d0: 6c74 6572 5f64 6174 6129 5d20 3d20 6376  lter_data)] = cv
-000456e0: 616c 0a20 2020 2020 2020 2020 2020 200a  al.            .
-000456f0: 2020 2020 7265 7475 726e 2066 696c 7465      return filte
-00045700: 725f 6461 7461 2c20 5f66 696c 7465 725f  r_data, _filter_
-00045710: 6e61 6d65 0a0a 0a64 6566 2061 7267 765f  name...def argv_
-00045720: 746f 5f64 6963 7428 6172 6776 2c20 6465  to_dict(argv, de
-00045730: 6661 756c 7473 3d7b 7d2c 2064 6f74 5f64  faults={}, dot_d
-00045740: 6963 743d 5472 7565 293a 0a20 2020 2022  ict=True):.    "
-00045750: 2222 0a20 2020 2043 6f6e 7665 7274 2061  "".    Convert a
-00045760: 206c 6973 7420 6f66 2028 7369 6d70 6c65   list of (simple
-00045770: 2920 636f 6d6d 616e 642d 6c69 6e65 2061  ) command-line a
-00045780: 7267 756d 656e 7473 2074 6f20 6120 6469  rguments to a di
-00045790: 6374 696f 6e61 7279 2e0a 2020 2020 0a20  ctionary..    . 
-000457a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-000457b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-000457c0: 2061 7267 7620 3a20 6c69 7374 206f 6620   argv : list of 
-000457d0: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
-000457e0: 452e 672e 2c20 6060 7379 732e 6172 6776  E.g., ``sys.argv
-000457f0: 5b31 3a5d 6060 2e0a 2020 2020 0a20 2020  [1:]``..    .   
-00045800: 2064 6566 6175 6c74 7320 3a20 6469 6374   defaults : dict
-00045810: 0a20 2020 2020 2020 2044 6566 6175 6c74  .        Default
-00045820: 2064 6963 7469 6f6e 6172 790a 2020 2020   dictionary.    
-00045830: 0a20 2020 2064 6f74 5f64 6963 7420 3a20  .    dot_dict : 
-00045840: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-00045850: 7472 7565 2c20 7468 656e 2069 6e74 6570  true, then intep
-00045860: 7265 7420 6b65 7977 6f72 6473 2077 6974  ret keywords wit
-00045870: 6820 272e 2720 6173 206e 6573 7465 6420  h '.' as nested 
-00045880: 6469 6374 696f 6e61 7279 206b 6579 732c  dictionary keys,
-00045890: 200a 2020 2020 2020 2020 652e 672e 2c20   .        e.g., 
-000458a0: 6060 2d2d 642e 6b65 793d 7661 6c60 6020  ``--d.key=val`` 
-000458b0: 3e3e 207b 2764 273a 207b 276b 6579 273a  >> {'d': {'key':
-000458c0: 2027 7661 6c27 7d7d 0a20 2020 2020 2020   'val'}}.       
-000458d0: 200a 2020 2020 4578 616d 706c 6573 0a20   .    Examples. 
-000458e0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-000458f0: 0a20 2020 2020 2020 2023 2024 206d 7966  .        # $ myf
-00045900: 756e 6320 6172 6731 202d 2d70 313d 3120  unc arg1 --p1=1 
-00045910: 2d2d 6c31 3d31 2c32 2c33 202d 2d70 6469  --l1=1,2,3 --pdi
-00045920: 6374 2e6b 313d 3120 2d66 6c61 670a 2020  ct.k1=1 -flag.  
-00045930: 2020 2020 2020 3e3e 3e20 6172 6776 203d        >>> argv =
-00045940: 2027 6172 6731 202d 2d70 313d 3120 2d2d   'arg1 --p1=1 --
-00045950: 6c31 3d31 2c32 2c33 202d 2d70 6469 6374  l1=1,2,3 --pdict
-00045960: 2e6b 313d 3120 2d66 6c61 6727 2e73 706c  .k1=1 -flag'.spl
-00045970: 6974 2829 0a20 2020 2020 2020 203e 3e3e  it().        >>>
-00045980: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
-00045990: 6172 6776 5f74 6f5f 6469 6374 2861 7267  argv_to_dict(arg
-000459a0: 7629 0a20 2020 2020 2020 203e 3e3e 2070  v).        >>> p
-000459b0: 7269 6e74 2861 7267 7329 0a20 2020 2020  rint(args).     
-000459c0: 2020 205b 2761 7267 3127 5d0a 2020 2020     ['arg1'].    
-000459d0: 2020 2020 3e3e 3e20 7072 696e 7428 6b77      >>> print(kw
-000459e0: 6172 6773 290a 2020 2020 2020 2020 7b27  args).        {'
-000459f0: 7031 273a 2031 2c20 276c 3127 3a20 5b31  p1': 1, 'l1': [1
-00045a00: 2c20 322c 2033 5d2c 2027 7064 6963 7427  , 2, 3], 'pdict'
-00045a10: 3a20 7b27 6b31 273a 2031 7d2c 2027 666c  : {'k1': 1}, 'fl
-00045a20: 6167 273a 2054 7275 657d 0a20 2020 2020  ag': True}.     
-00045a30: 2020 200a 2020 2020 2020 2020 2320 5769     .        # Wi
-00045a40: 7468 2064 6566 6175 6c74 730a 2020 2020  th defaults.    
-00045a50: 2020 2020 6465 6661 756c 7473 203d 207b      defaults = {
-00045a60: 2770 6469 6374 273a 7b27 6b32 273a 322e  'pdict':{'k2':2.
-00045a70: 307d 2c20 2770 3227 3a32 2e30 7d0a 2020  0}, 'p2':2.0}.  
-00045a80: 2020 2020 2020 3e3e 3e20 6172 6773 2c20        >>> args, 
-00045a90: 6b77 6172 6773 203d 2061 7267 765f 746f  kwargs = argv_to
-00045aa0: 5f64 6963 7428 6172 6776 2c20 6465 6661  _dict(argv, defa
-00045ab0: 756c 7473 3d64 6566 6175 6c74 7329 0a20  ults=defaults). 
-00045ac0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
-00045ad0: 286b 7761 7267 7329 0a20 2020 2020 2020  (kwargs).       
-00045ae0: 207b 2770 6469 6374 273a 207b 276b 3227   {'pdict': {'k2'
-00045af0: 3a20 322e 302c 2027 6b31 273a 2031 7d2c  : 2.0, 'k1': 1},
-00045b00: 2027 7032 273a 2032 2e30 2c20 2770 3127   'p2': 2.0, 'p1'
-00045b10: 3a20 312c 2027 6c31 273a 205b 312c 2032  : 1, 'l1': [1, 2
-00045b20: 2c20 335d 2c20 2766 6c61 6727 3a20 5472  , 3], 'flag': Tr
-00045b30: 7565 7d0a 2020 2020 2020 2020 0a20 2020  ue}.        .   
-00045b40: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-00045b50: 636f 7079 0a20 2020 2069 6d70 6f72 7420  copy.    import 
-00045b60: 6a73 6f6e 0a20 2020 200a 2020 2020 6b77  json.    .    kw
-00045b70: 6172 6773 203d 2063 6f70 792e 6465 6570  args = copy.deep
-00045b80: 636f 7079 2864 6566 6175 6c74 7329 0a20  copy(defaults). 
-00045b90: 2020 2061 7267 7320 3d20 5b5d 0a20 2020     args = [].   
-00045ba0: 200a 2020 2020 666f 7220 692c 2061 7267   .    for i, arg
-00045bb0: 2069 6e20 656e 756d 6572 6174 6528 6172   in enumerate(ar
-00045bc0: 6776 293a 2020 2020 2020 2020 0a20 2020  gv):        .   
-00045bd0: 2020 2020 2069 6620 6e6f 7420 6172 672e       if not arg.
-00045be0: 7374 6172 7473 7769 7468 2827 2d27 293a  startswith('-'):
-00045bf0: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-00045c00: 7267 756d 656e 7473 0a20 2020 2020 2020  rguments.       
-00045c10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00045c20: 2020 2020 2020 2020 2020 6172 6773 2e61            args.a
-00045c30: 7070 656e 6428 6a73 6f6e 2e6c 6f61 6473  ppend(json.loads
-00045c40: 2861 7267 2929 0a20 2020 2020 2020 2020  (arg)).         
-00045c50: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00045c60: 2020 2020 2020 2020 2020 2061 7267 732e             args.
-00045c70: 6170 7065 6e64 286a 736f 6e2e 6c6f 6164  append(json.load
-00045c80: 7328 6627 227b 6172 677d 2227 2929 0a20  s(f'"{arg}"')). 
-00045c90: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00045ca0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00045cb0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00045cc0: 200a 2020 2020 2020 2020 7370 6c20 3d20   .        spl = 
-00045cd0: 6172 672e 7374 7269 7028 272d 2d27 292e  arg.strip('--').
-00045ce0: 7370 6c69 7428 273d 2729 0a20 2020 2020  split('=').     
-00045cf0: 2020 2069 6620 6c65 6e28 7370 6c29 203e     if len(spl) >
-00045d00: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00045d10: 2320 5061 7261 6d65 7465 7220 7661 6c75  # Parameter valu
-00045d20: 6573 0a20 2020 2020 2020 2020 2020 206b  es.            k
-00045d30: 6579 2c20 7661 6c20 3d20 7370 6c0a 2020  ey, val = spl.  
-00045d40: 2020 2020 2020 2020 2020 7661 6c20 3d20            val = 
-00045d50: 7661 6c2e 7265 706c 6163 6528 2754 7275  val.replace('Tru
-00045d60: 6527 2c27 7472 7565 2729 2e72 6570 6c61  e','true').repla
-00045d70: 6365 2827 4661 6c73 6527 2c27 6661 6c73  ce('False','fals
-00045d80: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-00045d90: 7661 6c20 3d20 7661 6c2e 7265 706c 6163  val = val.replac
-00045da0: 6528 274e 6f6e 6527 2c27 6e75 6c6c 2729  e('None','null')
-00045db0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00045dc0: 2020 2020 2020 2020 2020 2023 2050 6172             # Par
-00045dd0: 616d 6574 6572 732c 2073 6574 2074 6f20  ameters, set to 
-00045de0: 7472 7565 2c20 652e 672e 2c20 2d73 6574  true, e.g., -set
-00045df0: 5f66 6c61 670a 2020 2020 2020 2020 2020  _flag.          
-00045e00: 2020 6b65 792c 2076 616c 203d 2073 706c    key, val = spl
-00045e10: 5b30 5d2c 2027 7472 7565 270a 2020 2020  [0], 'true'.    
-00045e20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00045e30: 2020 2020 2023 2073 696e 676c 6520 2d0a       # single -.
-00045e40: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00045e50: 6579 2e73 7461 7274 7377 6974 6828 272d  ey.startswith('-
-00045e60: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00045e70: 2020 2020 6b65 7920 3d20 6b65 795b 313a      key = key[1:
-00045e80: 5d0a 2020 2020 2020 2020 0a20 2020 2020  ].        .     
-00045e90: 2020 2023 204c 6973 7420 7661 6c75 6573     # List values
-00045ea0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00045eb0: 2069 6620 272c 2720 696e 2076 616c 3a0a   if ',' in val:.
-00045ec0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00045ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045ee0: 2023 2054 7279 2070 6172 7369 6e67 2077   # Try parsing w
-00045ef0: 6974 6820 4a53 4f4e 0a20 2020 2020 2020  ith JSON.       
-00045f00: 2020 2020 2020 2020 206a 7661 6c20 3d20           jval = 
-00045f10: 6a73 6f6e 2e6c 6f61 6473 2866 275b 7b76  json.loads(f'[{v
-00045f20: 616c 7d5d 2729 0a20 2020 2020 2020 2020  al}]').         
-00045f30: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00045f40: 2020 2020 2020 2020 2020 2023 2041 7373             # Ass
-00045f50: 756d 6520 7374 7269 6e67 730a 2020 2020  ume strings.    
-00045f60: 2020 2020 2020 2020 2020 2020 7374 725f              str_
-00045f70: 7661 6c20 3d20 272c 272e 6a6f 696e 285b  val = ','.join([
-00045f80: 6627 227b 767d 2227 2066 6f72 2076 2069  f'"{v}"' for v i
-00045f90: 6e20 7661 6c2e 7370 6c69 7428 272c 2729  n val.split(',')
-00045fa0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00045fb0: 2020 206a 7661 6c20 3d20 6a73 6f6e 2e6c     jval = json.l
-00045fc0: 6f61 6473 2866 275b 7b73 7472 5f76 616c  oads(f'[{str_val
-00045fd0: 7d5d 2729 0a20 2020 2020 2020 2065 6c73  }]').        els
-00045fe0: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00045ff0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00046000: 2020 2020 6a76 616c 203d 206a 736f 6e2e      jval = json.
-00046010: 6c6f 6164 7328 7661 6c29 0a20 2020 2020  loads(val).     
-00046020: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-00046030: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00046040: 2053 7472 696e 670a 2020 2020 2020 2020   String.        
-00046050: 2020 2020 2020 2020 6a76 616c 203d 2076          jval = v
-00046060: 616c 0a20 2020 2020 2020 200a 2020 2020  al.        .    
-00046070: 2020 2020 2320 4469 6374 206b 6579 732c      # Dict keys,
-00046080: 2070 6f74 656e 7469 616c 6c79 206e 6573   potentially nes
-00046090: 7465 6420 2020 2020 2020 200a 2020 2020  ted        .    
-000460a0: 2020 2020 6966 2064 6f74 5f64 6963 7420      if dot_dict 
-000460b0: 2620 2827 2e27 2069 6e20 6b65 7929 3a0a  & ('.' in key):.
-000460c0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-000460d0: 203d 206b 6579 2e73 706c 6974 2827 2e27   = key.split('.'
-000460e0: 290a 2020 2020 2020 2020 2020 2020 6420  ).            d 
-000460f0: 3d20 6b77 6172 6773 0a20 2020 2020 2020  = kwargs.       
-00046100: 2020 2020 2066 6f72 206b 2069 6e20 6b65       for k in ke
-00046110: 7973 5b3a 2d31 5d3a 0a20 2020 2020 2020  ys[:-1]:.       
-00046120: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
-00046130: 7420 696e 2064 3a0a 2020 2020 2020 2020  t in d:.        
-00046140: 2020 2020 2020 2020 2020 2020 645b 6b5d              d[k]
-00046150: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-00046160: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-00046170: 2020 2020 2020 2064 203d 2064 5b6b 5d0a         d = d[k].
-00046180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046190: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-000461a0: 2064 5b6b 6579 735b 2d31 5d5d 203d 206a   d[keys[-1]] = j
-000461b0: 7661 6c0a 2020 2020 2020 2020 656c 7365  val.        else
-000461c0: 3a20 2020 2020 2020 2020 2020 200a 2020  :            .  
-000461d0: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
-000461e0: 5b6b 6579 5d20 3d20 6a76 616c 0a20 2020  [key] = jval.   
-000461f0: 2020 2020 2020 2020 200a 2020 2020 0a20           .    . 
-00046200: 2020 2072 6574 7572 6e20 6172 6773 2c20     return args, 
-00046210: 6b77 6172 6773 0a0a 0a63 6c61 7373 2055  kwargs...class U
-00046220: 6e69 7175 6528 6f62 6a65 6374 293a 0a20  nique(object):. 
-00046230: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00046240: 7365 6c66 2c20 6172 7261 792c 2076 6572  self, array, ver
-00046250: 626f 7365 3d54 7275 6529 3a0a 2020 2020  bose=True):.    
-00046260: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00046270: 4865 6c70 6572 2066 6f72 2075 6e69 7175  Helper for uniqu
-00046280: 6520 6974 656d 7320 696e 2061 6e20 6172  e items in an ar
-00046290: 7261 790a 2020 2020 2020 2020 0a20 2020  ray.        .   
-000462a0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-000462b0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000462c0: 2d2d 0a20 2020 2020 2020 2061 7272 6179  --.        array
-000462d0: 203a 2061 7272 6179 2d6c 696b 650a 2020   : array-like.  
-000462e0: 2020 2020 2020 2020 2020 4461 7461 2074            Data t
-000462f0: 6f20 7061 7273 652c 2067 656e 6572 616c  o parse, general
-00046300: 6c79 2073 7472 696e 6773 2062 7574 2063  ly strings but c
-00046310: 616e 2062 6520 616e 7974 6869 6e67 2074  an be anything t
-00046320: 6861 7420 6361 6e20 0a20 2020 2020 2020  hat can .       
-00046330: 2020 2020 2062 6520 7061 7273 6564 2062       be parsed b
-00046340: 7920 606e 756d 7079 2e75 6e69 7175 6560  y `numpy.unique`
-00046350: 0a0a 0a20 2020 2020 2020 2041 7474 7269  ...        Attri
-00046360: 6275 7465 730a 2020 2020 2020 2020 2d2d  butes.        --
-00046370: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00046380: 2064 696d 203a 2069 6e74 0a20 2020 2020   dim : int.     
-00046390: 2020 2020 2020 2060 6073 697a 6560 6020         ``size`` 
-000463a0: 6f66 2069 6e70 7574 2060 6061 7272 6179  of input ``array
-000463b0: 6060 0a20 2020 2020 2020 200a 2020 2020  ``.        .    
-000463c0: 2020 2020 7661 6c75 6573 203a 206c 6973      values : lis
-000463d0: 740a 2020 2020 2020 2020 2020 2020 556e  t.            Un
-000463e0: 6971 7565 2065 6c65 6d65 6e74 7320 6f66  ique elements of
-000463f0: 2060 6061 7272 6179 6060 0a20 2020 2020   ``array``.     
-00046400: 2020 200a 2020 2020 2020 2020 696e 6469     .        indi
-00046410: 6365 7320 3a20 6c69 7374 0a20 2020 2020  ces : list.     
-00046420: 2020 2020 2020 2049 6e74 6567 6572 206c         Integer l
-00046430: 6973 7420 6c65 6e67 7468 206f 6620 6060  ist length of ``
-00046440: 6172 7261 7960 6020 7769 7468 2074 6865  array`` with the
-00046450: 2069 6e64 6963 6573 206f 6620 6060 7661   indices of ``va
-00046460: 6c75 6573 6060 0a20 2020 2020 2020 2020  lues``.         
-00046470: 2020 2066 6f72 2065 6163 6820 656c 656d     for each elem
-00046480: 656e 740a 2020 2020 2020 2020 0a20 2020  ent.        .   
-00046490: 2020 2020 2063 6f75 6e74 7320 3a20 6c69       counts : li
-000464a0: 7374 0a20 2020 2020 2020 2020 2020 2043  st.            C
-000464b0: 6f75 6e74 7320 6f66 2065 6163 6820 656c  ounts of each el
-000464c0: 656d 656e 7420 6f66 2060 6076 616c 7565  ement of ``value
-000464d0: 7360 600a 2020 2020 2020 2020 0a0a 2020  s``.        ..  
-000464e0: 2020 2020 2020 4d65 7468 6f64 730a 2020        Methods.  
-000464f0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
-00046500: 2020 2020 2020 5f5f 6765 745f 5f28 6b65        __get__(ke
-00046510: 7929 0a20 2020 2020 2020 2020 2020 2052  y).            R
-00046520: 6574 7572 6e20 6120 6062 6f6f 6c60 2061  eturn a `bool` a
-00046530: 7272 6179 2077 6865 7265 2065 6e74 7269  rray where entri
-00046540: 6573 206f 6620 6060 6172 7261 7960 6020  es of ``array`` 
-00046550: 6d61 7463 6820 7468 6520 0a20 2020 2020  match the .     
-00046560: 2020 2020 2020 2073 7065 6369 6669 6564         specified
-00046570: 2060 606b 6579 6060 0a20 2020 2020 2020   ``key``.       
-00046580: 200a 2020 2020 2020 2020 5f5f 6974 6572   .        __iter
-00046590: 5f5f 0a20 2020 2020 2020 2020 2020 2049  __.            I
-000465a0: 7465 7261 746f 7220 6f76 6572 2060 6076  terator over ``v
-000465b0: 616c 7565 7360 600a 2020 2020 2020 2020  alues``.        
-000465c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000465d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-000465e0: 6365 2861 7272 6179 2c20 6c69 7374 293a  ce(array, list):
-000465f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00046600: 662e 6172 7261 7920 3d20 6e70 2e61 7272  f.array = np.arr
-00046610: 6179 2861 7272 6179 290a 2020 2020 2020  ay(array).      
-00046620: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00046630: 2020 2020 7365 6c66 2e61 7272 6179 203d      self.array =
-00046640: 2061 7272 6179 0a20 2020 2020 2020 200a   array.        .
-00046650: 2020 2020 2020 2020 5f20 3d20 6e70 2e75          _ = np.u
-00046660: 6e69 7175 6528 7365 6c66 2e61 7272 6179  nique(self.array
-00046670: 2c20 7265 7475 726e 5f63 6f75 6e74 733d  , return_counts=
-00046680: 5472 7565 2c20 7265 7475 726e 5f69 6e76  True, return_inv
-00046690: 6572 7365 3d54 7275 6529 0a20 2020 2020  erse=True).     
-000466a0: 2020 2073 656c 662e 6469 6d20 3d20 7365     self.dim = se
-000466b0: 6c66 2e61 7272 6179 2e73 697a 650a 2020  lf.array.size.  
-000466c0: 2020 2020 2020 7365 6c66 2e7a 6572 6f73        self.zeros
-000466d0: 203d 206e 702e 7a65 726f 7328 7365 6c66   = np.zeros(self
-000466e0: 2e61 7272 6179 2e73 6861 7065 2c20 6474  .array.shape, dt
-000466f0: 7970 653d 626f 6f6c 290a 2020 2020 2020  ype=bool).      
-00046700: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-00046710: 7661 6c75 6573 203d 205b 6c20 666f 7220  values = [l for 
-00046720: 6c20 696e 205f 5b30 5d5d 0a20 2020 2020  l in _[0]].     
-00046730: 2020 2073 656c 662e 696e 6469 6365 7320     self.indices 
-00046740: 3d20 5f5b 315d 0a20 2020 2020 2020 2073  = _[1].        s
-00046750: 656c 662e 636f 756e 7473 203d 205f 5b32  elf.counts = _[2
-00046760: 5d0a 2020 2020 2020 2020 6966 2076 6572  ].        if ver
-00046770: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00046780: 2020 7365 6c66 2e69 6e66 6f28 736f 7274    self.info(sort
-00046790: 5f63 6f75 6e74 733d 7665 7262 6f73 6529  _counts=verbose)
-000467a0: 0a20 2020 200a 2020 2020 0a20 2020 2040  .    .    .    @
-000467b0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000467c0: 204e 2873 656c 6629 3a0a 2020 2020 2020   N(self):.      
-000467d0: 2020 2222 220a 2020 2020 2020 2020 4e75    """.        Nu
-000467e0: 6d62 6572 206f 6620 756e 6971 7565 2060  mber of unique `
-000467f0: 6076 616c 7565 7360 600a 2020 2020 2020  `values``.      
-00046800: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-00046810: 7475 726e 206c 656e 2873 656c 662e 7661  turn len(self.va
-00046820: 6c75 6573 290a 0a0a 2020 2020 6465 6620  lues)...    def 
-00046830: 696e 666f 2873 656c 662c 2073 6f72 745f  info(self, sort_
-00046840: 636f 756e 7473 3d2d 3129 3a0a 2020 2020  counts=-1):.    
-00046850: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00046860: 5072 696e 7420 6120 7375 6d6d 6172 790a  Print a summary.
-00046870: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00046880: 2020 2020 7072 696e 7428 6627 7b22 4e22      print(f'{"N"
-00046890: 3a3e 347d 2020 7b22 7661 6c75 6522 3a31  :>4}  {"value":1
-000468a0: 307d 2729 0a20 2020 2020 2020 2070 7269  0}').        pri
-000468b0: 6e74 2827 3d3d 3d3d 2020 3d3d 3d3d 3d3d  nt('====  ======
-000468c0: 3d3d 3d3d 2729 0a20 2020 2020 2020 2069  ====').        i
-000468d0: 6620 736f 7274 5f63 6f75 6e74 733a 0a20  f sort_counts:. 
-000468e0: 2020 2020 2020 2020 2020 2073 6f20 3d20             so = 
-000468f0: 6e70 2e61 7267 736f 7274 2873 656c 662e  np.argsort(self.
-00046900: 636f 756e 7473 295b 3a3a 696e 7428 736f  counts)[::int(so
-00046910: 7274 5f63 6f75 6e74 7329 5d0a 2020 2020  rt_counts)].    
-00046920: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00046930: 2020 2020 2020 736f 203d 206e 702e 6172        so = np.ar
-00046940: 616e 6765 2873 656c 662e 4e29 0a20 2020  ange(self.N).   
-00046950: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00046960: 2020 666f 7220 6920 696e 2073 6f3a 0a20    for i in so:. 
-00046970: 2020 2020 2020 2020 2020 2076 2c20 6320             v, c 
-00046980: 3d20 7365 6c66 2e76 616c 7565 735b 695d  = self.values[i]
-00046990: 2c20 7365 6c66 2e63 6f75 6e74 735b 695d  , self.counts[i]
-000469a0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-000469b0: 6e74 2866 277b 633a 3e34 7d20 207b 763a  nt(f'{c:>4}  {v:
-000469c0: 3130 7d27 290a 0a0a 2020 2020 6465 6620  10}')...    def 
-000469d0: 636f 756e 7428 7365 6c66 2c20 6b65 7929  count(self, key)
-000469e0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000469f0: 2020 2020 2020 4765 7420 6f63 6375 7272        Get occurr
-00046a00: 656e 6365 7320 636f 756e 7420 6f66 2061  ences count of a
-00046a10: 2070 6172 7469 6375 6c61 7220 6060 7661   particular ``va
-00046a20: 6c75 6560 600a 2020 2020 2020 2020 2222  lue``.        ""
-00046a30: 220a 2020 2020 2020 2020 6966 206b 6579  ".        if key
-00046a40: 2069 6e20 7365 6c66 2e76 616c 7565 733a   in self.values:
-00046a50: 0a20 2020 2020 2020 2020 2020 2069 7820  .            ix 
-00046a60: 3d20 7365 6c66 2e76 616c 7565 732e 696e  = self.values.in
-00046a70: 6465 7828 6b65 7929 0a20 2020 2020 2020  dex(key).       
-00046a80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00046a90: 2e63 6f75 6e74 735b 6978 5d0a 2020 2020  .counts[ix].    
-00046aa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00046ab0: 2020 2020 2020 7265 7475 726e 2030 0a20        return 0. 
-00046ac0: 2020 200a 2020 2020 0a20 2020 2040 7072     .    .    @pr
-00046ad0: 6f70 6572 7479 0a20 2020 2064 6566 206c  operty.    def l
-00046ae0: 6973 745f 696e 6469 6365 7328 7365 6c66  ist_indices(self
-00046af0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00046b00: 2020 2020 2020 2042 7569 6c64 206c 6973         Build lis
-00046b10: 7420 6f66 206c 6973 7473 206f 6620 696e  t of lists of in
-00046b20: 6469 6365 7320 7468 6174 2065 6163 6820  dices that each 
-00046b30: 756e 6971 7565 2076 616c 7565 0a20 2020  unique value.   
-00046b40: 2020 2020 2022 2222 0a20 2020 200a 2020       """.    .  
-00046b50: 2020 2020 2020 696e 6473 203d 205b 5b5d        inds = [[]
-00046b60: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00046b70: 7365 6c66 2e4e 295d 2020 2020 0a20 2020  self.N)]    .   
-00046b80: 2020 2020 2073 6f20 3d20 6e70 2e61 7267       so = np.arg
-00046b90: 736f 7274 2873 656c 662e 696e 6469 6365  sort(self.indice
-00046ba0: 7329 0a20 2020 200a 2020 2020 2020 2020  s).    .        
-00046bb0: 666f 7220 692c 2069 6920 696e 207a 6970  for i, ii in zip
-00046bc0: 2873 6f2c 2073 656c 662e 696e 6469 6365  (so, self.indice
-00046bd0: 735b 736f 5d29 3a0a 2020 2020 2020 2020  s[so]):.        
-00046be0: 2020 2020 696e 6473 5b69 695d 2e61 7070      inds[ii].app
-00046bf0: 656e 6428 6929 0a20 2020 2020 2020 200a  end(i).        .
-00046c00: 2020 2020 2020 2020 2320 536f 7274 2074          # Sort t
-00046c10: 6865 2073 7562 6c69 7374 730a 2020 2020  he sublists.    
-00046c20: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00046c30: 6765 2873 656c 662e 4e29 3a0a 2020 2020  ge(self.N):.    
-00046c40: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00046c50: 636f 756e 7473 5b69 5d20 3e20 313a 0a20  counts[i] > 1:. 
-00046c60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00046c70: 6e64 735b 695d 2e73 6f72 7428 290a 2020  nds[i].sort().  
-00046c80: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
-00046c90: 6e20 696e 6473 0a20 2020 200a 2020 2020  n inds.    .    
-00046ca0: 0a20 2020 2064 6566 2075 6e69 7175 655f  .    def unique_
-00046cb0: 696e 6465 7828 7365 6c66 2c20 696e 6465  index(self, inde
-00046cc0: 783d 3029 3a0a 2020 2020 2020 2020 2222  x=0):.        ""
-00046cd0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
-00046ce0: 2061 7272 6179 206f 6620 696e 6469 6365   array of indice
-00046cf0: 7320 6f66 2074 6865 2070 6172 656e 7420  s of the parent 
-00046d00: 6172 7261 7920 7468 6174 206d 616b 6573  array that makes
-00046d10: 2061 2075 6e69 7175 6520 6f75 7470 7574   a unique output
-00046d20: 2061 7272 6179 0a20 2020 2020 2020 200a   array.        .
-00046d30: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-00046d40: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-00046d50: 2020 2020 2020 2020 7569 7820 3a20 6c69          uix : li
-00046d60: 7374 0a20 2020 2020 2020 2020 2020 204c  st.            L
-00046d70: 6973 7420 6f66 2075 6e69 7175 6520 696e  ist of unique in
-00046d80: 6469 6365 730a 2020 2020 2020 2020 2222  dices.        ""
-00046d90: 220a 2020 2020 2020 2020 7569 7820 3d20  ".        uix = 
-00046da0: 5b69 6e64 5b69 6e64 6578 5d20 666f 7220  [ind[index] for 
-00046db0: 696e 6420 696e 2073 656c 662e 6c69 7374  ind in self.list
-00046dc0: 5f69 6e64 6963 6573 5d0a 2020 2020 2020  _indices].      
-00046dd0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00046de0: 2020 2020 2020 2072 6574 7572 6e20 7569         return ui
-00046df0: 780a 2020 2020 0a20 2020 200a 2020 2020  x.    .    .    
-00046e00: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
-00046e10: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-00046e20: 2020 2020 2020 2020 4974 6572 6162 6c65          Iterable
-00046e30: 206f 7665 7220 6076 616c 7565 7360 2061   over `values` a
-00046e40: 7474 7269 6275 7465 0a20 2020 2020 2020  ttribute.       
-00046e50: 200a 2020 2020 2020 2020 5265 7475 726e   .        Return
-00046e60: 7320 6120 7475 706c 6520 6f66 2074 6865  s a tuple of the
-00046e70: 2076 616c 7565 2061 6e64 2074 6865 2062   value and the b
-00046e80: 6f6f 6c65 616e 2073 656c 6563 7469 6f6e  oolean selection
-00046e90: 2061 7272 6179 2066 6f72 2074 6861 7420   array for that 
-00046ea0: 0a20 2020 2020 2020 2076 616c 7565 2e0a  .        value..
-00046eb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00046ec0: 2020 2020 6920 3d20 300a 2020 2020 2020      i = 0.      
-00046ed0: 2020 7768 696c 6520 6920 3c20 7365 6c66    while i < self
-00046ee0: 2e4e 3a0a 2020 2020 2020 2020 2020 2020  .N:.            
-00046ef0: 7669 203d 2073 656c 662e 7661 6c75 6573  vi = self.values
-00046f00: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
-00046f10: 7969 656c 6420 2876 692c 2073 656c 665b  yield (vi, self[
-00046f20: 7669 5d29 0a20 2020 2020 2020 2020 2020  vi]).           
-00046f30: 2069 202b 3d20 310a 0a0a 2020 2020 6465   i += 1...    de
-00046f40: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
-00046f50: 6c66 2c20 6b65 7929 3a0a 2020 2020 2020  lf, key):.      
-00046f60: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-00046f70: 2e76 616c 7565 733a 0a20 2020 2020 2020  .values:.       
-00046f80: 2020 2020 2069 7820 3d20 7365 6c66 2e76       ix = self.v
-00046f90: 616c 7565 732e 696e 6465 7828 6b65 7929  alues.index(key)
-00046fa0: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-00046fb0: 7420 3d20 7365 6c66 2e69 6e64 6963 6573  t = self.indices
-00046fc0: 203d 3d20 6978 0a20 2020 2020 2020 2020   == ix.         
-00046fd0: 2020 2072 6574 7572 6e20 7465 7374 0a20     return test. 
-00046fe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00046ff0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00047000: 7365 6c66 2e7a 6572 6f73 0a0a 0a20 2020  self.zeros...   
-00047010: 2064 6566 205f 5f6c 656e 5f5f 2873 656c   def __len__(sel
-00047020: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-00047030: 726e 2073 656c 662e 4e0a 0a0a 636c 6173  rn self.N...clas
-00047040: 7320 4875 6262 6c65 5859 5a28 6f62 6a65  s HubbleXYZ(obje
-00047050: 6374 293a 0a20 2020 2064 6566 205f 5f69  ct):.    def __i
-00047060: 6e69 745f 5f28 7365 6c66 2c20 7370 745f  nit__(self, spt_
-00047070: 6669 6c65 3d27 272c 2070 6172 616d 5f64  file='', param_d
-00047080: 6963 743d 7b7d 293a 0a20 2020 2020 2020  ict={}):.       
-00047090: 2022 2222 0a20 2020 2020 2020 2048 656c   """.        Hel
-000470a0: 7065 7220 746f 2063 6f6d 7075 7465 2048  per to compute H
-000470b0: 5354 2067 656f 6365 6e74 7269 6320 636f  ST geocentric co
-000470c0: 6f72 6469 6e61 7465 7320 6672 6f6d 206f  ordinates from o
-000470d0: 7262 6974 616c 2070 6172 616d 6574 6572  rbital parameter
-000470e0: 730a 2020 2020 2020 2020 0a20 2020 2020  s.        .     
-000470f0: 2020 2028 7465 7374 696e 6729 0a20 2020     (testing).   
-00047100: 2020 2020 200a 2020 2020 2020 2020 4261       .        Ba
-00047110: 7365 6420 6f6e 2068 7474 703a 2f2f 6172  sed on http://ar
-00047120: 7469 636c 6573 2e61 6473 6162 732e 6861  ticles.adsabs.ha
-00047130: 7276 6172 642e 6564 752f 2f66 756c 6c2f  rvard.edu//full/
-00047140: 3139 3935 4153 5043 2e2e 2e37 372e 2e34  1995ASPC...77..4
-00047150: 3634 412f 0a20 2020 2020 2020 2022 2222  64A/.        """
-00047160: 0a20 2020 2020 2020 2069 6620 7370 745f  .        if spt_
-00047170: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00047180: 2020 7365 6c66 2e70 6172 616d 5f64 6963    self.param_dic
-00047190: 7420 3d20 7365 6c66 2e70 6172 7365 5f66  t = self.parse_f
-000471a0: 726f 6d5f 7370 7428 7370 745f 6669 6c65  rom_spt(spt_file
-000471b0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-000471c0: 2020 2065 6c69 6620 7061 7261 6d5f 6469     elif param_di
-000471d0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-000471e0: 7365 6c66 2e70 6172 616d 5f64 6963 7420  self.param_dict 
-000471f0: 3d20 7061 7261 6d5f 6469 6374 0a20 2020  = param_dict.   
-00047200: 2020 2020 200a 2020 2020 2020 2020 656c       .        el
-00047210: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00047220: 7365 6c66 2e70 6172 616d 5f64 6963 7420  self.param_dict 
-00047230: 3d20 7b7d 0a20 2020 2020 2020 200a 2020  = {}.        .  
-00047240: 2020 2020 2020 7365 6c66 2e63 6f6d 7075        self.compu
-00047250: 7465 6420 3d20 7b7d 0a0a 0a20 2020 2040  ted = {}...    @
-00047260: 7072 6f70 6572 7479 200a 2020 2020 6465  property .    de
-00047270: 6620 5f74 3139 3835 2873 656c 6629 3a0a  f _t1985(self):.
-00047280: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00047290: 2020 2020 5265 6665 7265 6e63 6520 7469      Reference ti
-000472a0: 6d65 0a20 2020 2020 2020 2022 2222 0a20  me.        """. 
-000472b0: 2020 2020 2020 2069 6d70 6f72 7420 6173         import as
-000472c0: 7472 6f70 792e 7469 6d65 0a20 2020 2020  tropy.time.     
-000472d0: 2020 2074 3020 3d20 6173 7472 6f70 792e     t0 = astropy.
-000472e0: 7469 6d65 2e54 696d 6528 2731 3938 352d  time.Time('1985-
-000472f0: 3031 2d30 3154 3030 3a30 303a 3030 5a27  01-01T00:00:00Z'
-00047300: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00047310: 2074 300a 0a0a 2020 2020 6465 6620 5f5f   t0...    def __
-00047320: 6361 6c6c 5f5f 2873 656c 662c 2074 5f69  call__(self, t_i
-00047330: 6e2c 202a 2a6b 7761 7267 7329 3a0a 2020  n, **kwargs):.  
-00047340: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00047350: 2020 436f 6e76 6572 7420 696e 7075 7420    Convert input 
-00047360: 7469 6d65 2060 6074 5f69 6e60 6020 746f  time ``t_in`` to
-00047370: 2073 6563 6f6e 6473 2073 696e 6365 2031   seconds since 1
-00047380: 2f31 2f38 3520 616e 6420 6060 6576 616c  /1/85 and ``eval
-00047390: 7561 7465 6060 2e0a 2020 2020 2020 2020  uate``..        
-000473a0: 2222 220a 2020 2020 2020 2020 696d 706f  """.        impo
-000473b0: 7274 2061 7374 726f 7079 2e74 696d 650a  rt astropy.time.
-000473c0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-000473d0: 7369 6e73 7461 6e63 6528 745f 696e 2c20  sinstance(t_in, 
-000473e0: 6173 7472 6f70 792e 7469 6d65 2e54 696d  astropy.time.Tim
-000473f0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00047400: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00047410: 2827 745f 696e 206d 7573 7420 6265 2061  ('t_in must be a
-00047420: 7374 726f 7079 2e74 696d 652e 5469 6d65  stropy.time.Time
-00047430: 206f 626a 6563 7427 290a 0a20 2020 2020   object')..     
-00047440: 2020 2064 7420 3d20 745f 696e 202d 2073     dt = t_in - s
-00047450: 656c 662e 5f74 3139 3835 0a20 2020 2020  elf._t1985.     
-00047460: 2020 2078 797a 203d 2073 656c 662e 6576     xyz = self.ev
-00047470: 616c 7561 7465 2864 742e 7365 632c 202a  aluate(dt.sec, *
-00047480: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00047490: 2069 6620 2761 735f 7461 626c 6527 2069   if 'as_table' i
-000474a0: 6e20 6b77 6172 6773 3a0a 2020 2020 2020  n kwargs:.      
-000474b0: 2020 2020 2020 6966 206b 7761 7267 735b        if kwargs[
-000474c0: 2761 735f 7461 626c 6527 5d3a 0a20 2020  'as_table']:.   
-000474d0: 2020 2020 2020 2020 2020 2020 2078 797a               xyz
-000474e0: 5b27 7469 6d65 275d 203d 2074 5f69 6e0a  ['time'] = t_in.
-000474f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047500: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047510: 7879 7a0a 0a0a 2020 2020 6465 6620 5f5f  xyz...    def __
-00047520: 6765 7469 7465 6d5f 5f28 7365 6c66 2c20  getitem__(self, 
-00047530: 6b65 7929 3a0a 2020 2020 2020 2020 7265  key):.        re
-00047540: 7475 726e 2073 656c 662e 7061 7261 6d5f  turn self.param_
-00047550: 6469 6374 5b6b 6579 5d0a 0a0a 2020 2020  dict[key]...    
-00047560: 6465 6620 6576 616c 7561 7465 2873 656c  def evaluate(sel
-00047570: 662c 2064 742c 2075 6e69 743d 4e6f 6e65  f, dt, unit=None
-00047580: 2c20 6173 5f74 6162 6c65 3d46 616c 7365  , as_table=False
-00047590: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-000475a0: 2020 2020 2020 2045 7661 6c75 6174 6520         Evaluate 
-000475b0: 6571 7561 7469 6f6e 7320 746f 2067 6574  equations to get
-000475c0: 2070 6f73 6974 696f 6e73 0a20 2020 2020   positions.     
-000475d0: 2020 200a 2020 2020 2020 2020 5265 7475     .        Retu
-000475e0: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
-000475f0: 2d2d 2d0a 2020 2020 2020 2020 782c 2079  ---.        x, y
-00047600: 2c20 7a2c 2072 3a20 666c 6f61 740a 2020  , z, r: float.  
-00047610: 2020 2020 2020 2020 2020 436f 6f72 6469            Coordi
-00047620: 6e61 7465 732c 2069 6e20 6b6d 206f 7220  nates, in km or 
-00047630: 6060 756e 6974 6060 2e0a 2020 2020 2020  ``unit``..      
-00047640: 2020 2020 2020 0a20 2020 2020 2020 2022        .        "
-00047650: 2222 0a20 2020 2020 2020 200a 2020 2020  "".        .    
-00047660: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00047670: 7061 7261 6d5f 6469 6374 3a0a 2020 2020  param_dict:.    
-00047680: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00047690: 6c75 6545 7272 6f72 2827 4f72 6269 7461  lueError('Orbita
-000476a0: 6c20 7061 7261 6d65 7465 7273 206e 6f74  l parameters not
-000476b0: 2064 6566 696e 6564 2069 6e20 270a 2020   defined in '.  
-000476c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000476d0: 2020 2020 2020 2020 2020 2027 7365 6c66             'self
-000476e0: 2e70 6172 616d 5f64 6963 7427 290a 2020  .param_dict').  
-000476f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047700: 2020 0a20 2020 2020 2020 2070 203d 2073    .        p = s
-00047710: 656c 662e 7061 7261 6d5f 6469 6374 0a20  elf.param_dict. 
-00047720: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047730: 7420 3d20 6e70 2e61 746c 6561 7374 5f31  t = np.atleast_1
-00047740: 6428 6474 290a 2020 2020 2020 2020 0a20  d(dt).        . 
-00047750: 2020 2020 2020 2023 2045 712e 2031 0a20         # Eq. 1. 
-00047760: 2020 2020 2020 2062 7261 636b 6574 203d         bracket =
-00047770: 2070 5b27 4d2e 275d 2a28 742d 705b 2774   p['M.']*(t-p['t
-00047780: 6175 275d 2920 2b20 302e 352a 705b 274d  au']) + 0.5*p['M
-00047790: 2e2e 275d 2a28 742d 705b 2774 6175 275d  ..']*(t-p['tau']
-000477a0: 292a 2a32 0a20 2020 2020 2020 204d 203d  )**2.        M =
-000477b0: 2070 5b27 4d30 275d 202b 2032 2a6e 702e   p['M0'] + 2*np.
-000477c0: 7069 2a62 7261 636b 6574 0a20 2020 2020  pi*bracket.     
-000477d0: 2020 200a 2020 2020 2020 2020 2320 4571     .        # Eq
-000477e0: 2e20 320a 2020 2020 2020 2020 7369 6e4d  . 2.        sinM
-000477f0: 203d 206e 702e 7369 6e28 4d29 0a20 2020   = np.sin(M).   
-00047800: 2020 2020 2063 6f73 4d20 3d20 6e70 2e63       cosM = np.c
-00047810: 6f73 284d 290a 2020 2020 2020 2020 6520  os(M).        e 
-00047820: 3d20 705b 2765 275d 0a20 2020 2020 2020  = p['e'].       
-00047830: 206e 7520 3d20 4d20 2b20 7369 6e4d 2a28   nu = M + sinM*(
-00047840: 322a 6520 2b20 332a 652a 2a33 2a63 6f73  2*e + 3*e**3*cos
-00047850: 4d2a 2a32 202d 2034 2e2f 332a 652a 2a33  M**2 - 4./3*e**3
-00047860: 2a73 696e 4d2a 2a32 200a 2020 2020 2020  *sinM**2 .      
-00047870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047880: 202b 2035 2e2f 322a 652a 2a32 2a63 6f73   + 5./2*e**2*cos
-00047890: 4d29 0a20 2020 2020 2020 200a 2020 2020  M).        .    
-000478a0: 2020 2020 2320 4571 2e20 330a 2020 2020      # Eq. 3.    
-000478b0: 2020 2020 7220 3d20 705b 2761 2831 2d65      r = p['a(1-e
-000478c0: 2a2a 3229 275d 2f28 312b 652a 6e70 2e63  **2)']/(1+e*np.c
-000478d0: 6f73 286e 7529 290a 2020 2020 2020 2020  os(nu)).        
-000478e0: 2320 546f 206b 6d0a 2020 2020 2020 2020  # To km.        
-000478f0: 7220 2f3d 2031 3030 302e 0a20 2020 2020  r /= 1000..     
-00047900: 2020 200a 2020 2020 2020 2020 2320 4571     .        # Eq
-00047910: 2e20 340a 2020 2020 2020 2020 4f6d 203d  . 4.        Om =
-00047920: 2032 2a6e 702e 7069 2a28 705b 274f 6d30   2*np.pi*(p['Om0
-00047930: 275d 202b 2070 5b27 4f6d 2e27 5d2a 2874  '] + p['Om.']*(t
-00047940: 2d70 5b27 7461 7527 5d29 290a 2020 2020  -p['tau'])).    
-00047950: 2020 2020 0a20 2020 2020 2020 2023 2045      .        # E
-00047960: 712e 2035 0a20 2020 2020 2020 2077 203d  q. 5.        w =
-00047970: 2032 2a6e 702e 7069 2a28 705b 2777 3027   2*np.pi*(p['w0'
-00047980: 5d20 2b20 705b 2777 2e27 5d2a 2874 2d70  ] + p['w.']*(t-p
-00047990: 5b27 7461 7527 5d29 290a 2020 2020 2020  ['tau'])).      
-000479a0: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-000479b0: 6361 6c63 5f64 6963 7420 3d20 7b27 4d27  calc_dict = {'M'
-000479c0: 3a4d 2c20 276e 7527 3a6e 752c 200a 2020  :M, 'nu':nu, .  
-000479d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000479e0: 2020 2020 2020 2020 2761 273a 705b 2761          'a':p['a
-000479f0: 275d 2c20 0a20 2020 2020 2020 2020 2020  '], .           
-00047a00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00047a10: 6927 3a6e 702e 6172 6373 696e 2870 5b27  i':np.arcsin(p['
-00047a20: 7369 6e69 275d 292c 200a 2020 2020 2020  sini']), .      
-00047a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a40: 2020 2020 274f 6d27 3a4f 6d2c 0a20 2020      'Om':Om,.   
-00047a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a60: 2020 2020 2020 2027 7727 3a77 7d0a 2020         'w':w}.  
-00047a70: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-00047a80: 2045 712e 2036 0a20 2020 2020 2020 2063   Eq. 6.        c
-00047a90: 6f73 4f6d 203d 206e 702e 636f 7328 4f6d  osOm = np.cos(Om
-00047aa0: 290a 2020 2020 2020 2020 7369 6e4f 6d20  ).        sinOm 
-00047ab0: 3d20 6e70 2e73 696e 284f 6d29 0a20 2020  = np.sin(Om).   
-00047ac0: 2020 2020 2063 6f73 7776 203d 206e 702e       coswv = np.
-00047ad0: 636f 7328 772b 6e75 290a 2020 2020 2020  cos(w+nu).      
-00047ae0: 2020 7369 6e77 7620 3d20 6e70 2e73 696e    sinwv = np.sin
-00047af0: 2877 2b6e 7529 0a20 2020 2020 2020 200a  (w+nu).        .
-00047b00: 2020 2020 2020 2020 6966 2075 6e69 7420          if unit 
-00047b10: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00047b20: 2020 2020 2020 2020 2072 203d 2028 722a           r = (r*
-00047b30: 752e 6b6d 292e 746f 2875 6e69 7429 0a20  u.km).to(unit). 
-00047b40: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00047b50: 2020 2020 7820 3d20 722a 2863 6f73 4f6d      x = r*(cosOm
-00047b60: 2a63 6f73 7776 202d 2070 5b27 636f 7369  *coswv - p['cosi
-00047b70: 275d 2a73 696e 4f6d 2a73 696e 7776 290a  ']*sinOm*sinwv).
-00047b80: 2020 2020 2020 2020 7920 3d20 722a 2873          y = r*(s
-00047b90: 696e 4f6d 2a63 6f73 7776 202b 2070 5b27  inOm*coswv + p['
-00047ba0: 636f 7369 275d 2a63 6f73 4f6d 2a73 696e  cosi']*cosOm*sin
-00047bb0: 7776 290a 2020 2020 2020 2020 7a20 3d20  wv).        z = 
-00047bc0: 722a 705b 2773 696e 6927 5d2a 7369 6e77  r*p['sini']*sinw
-00047bd0: 760a 2020 2020 2020 2020 0a20 2020 2020  v.        .     
-00047be0: 2020 2069 6620 6173 5f74 6162 6c65 3a0a     if as_table:.
-00047bf0: 2020 2020 2020 2020 2020 2020 7461 6220              tab 
-00047c00: 3d20 4754 6162 6c65 2829 0a20 2020 2020  = GTable().     
-00047c10: 2020 2020 2020 2074 6162 5b27 6474 275d         tab['dt']
-00047c20: 203d 2074 0a20 2020 2020 2020 2020 2020   = t.           
-00047c30: 2074 6162 5b27 7827 5d20 3d20 780a 2020   tab['x'] = x.  
-00047c40: 2020 2020 2020 2020 2020 7461 625b 2779            tab['y
-00047c50: 275d 203d 2079 0a20 2020 2020 2020 2020  '] = y.         
-00047c60: 2020 2074 6162 5b27 7a27 5d20 3d20 7a0a     tab['z'] = z.
-00047c70: 2020 2020 2020 2020 2020 2020 7461 625b              tab[
-00047c80: 2772 275d 203d 2072 0a20 2020 2020 2020  'r'] = r.       
-00047c90: 2020 2020 2072 6574 7572 6e20 7461 620a       return tab.
-00047ca0: 2020 2020 2020 2020 656c 7365 3a20 0a20          else: . 
-00047cb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00047cc0: 6e20 782c 2079 2c20 7a2c 2072 0a0a 0a20  n x, y, z, r... 
-00047cd0: 2020 2064 6566 2066 726f 6d5f 666c 7428     def from_flt(
-00047ce0: 7365 6c66 2c20 666c 745f 6669 6c65 2c20  self, flt_file, 
-00047cf0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00047d00: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-00047d10: 6f6d 7075 7465 2070 6f73 6974 696f 6e73  ompute positions
-00047d20: 2061 7420 6578 7073 7461 7274 2c20 6578   at expstart, ex
-00047d30: 706d 6964 2c20 6578 7065 6e64 0a20 2020  pmid, expend.   
-00047d40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00047d50: 2069 6d70 6f72 7420 6173 7472 6f70 792e   import astropy.
-00047d60: 7469 6d65 0a20 2020 2020 2020 200a 2020  time.        .  
-00047d70: 2020 2020 2020 666c 7420 3d20 7079 6669        flt = pyfi
-00047d80: 7473 2e6f 7065 6e28 666c 745f 6669 6c65  ts.open(flt_file
-00047d90: 290a 2020 2020 2020 2020 6578 7073 7461  ).        expsta
-00047da0: 7274 203d 2066 6c74 5b30 5d2e 6865 6164  rt = flt[0].head
-00047db0: 6572 5b27 4558 5053 5441 5254 275d 0a20  er['EXPSTART']. 
-00047dc0: 2020 2020 2020 2065 7870 656e 6420 3d20         expend = 
-00047dd0: 666c 745b 305d 2e68 6561 6465 725b 2745  flt[0].header['E
-00047de0: 5850 454e 4427 5d0a 2020 2020 2020 2020  XPEND'].        
-00047df0: 6578 706d 6964 203d 2028 6578 7073 7461  expmid = (expsta
-00047e00: 7274 2b65 7870 656e 6429 2f32 2e0a 2020  rt+expend)/2..  
-00047e10: 2020 2020 2020 0a20 2020 2020 2020 2074        .        t
-00047e20: 5f69 6e20 3d20 6173 7472 6f70 792e 7469  _in = astropy.ti
-00047e30: 6d65 2e54 696d 6528 5b65 7870 7374 6172  me.Time([expstar
-00047e40: 742c 2065 7870 6d69 642c 2065 7870 656e  t, expmid, expen
-00047e50: 645d 2c20 666f 726d 6174 3d27 6d6a 6427  d], format='mjd'
-00047e60: 290a 2020 2020 2020 2020 666c 742e 636c  ).        flt.cl
-00047e70: 6f73 6528 290a 2020 2020 2020 2020 0a20  ose().        . 
-00047e80: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00047e90: 6c66 2874 5f69 6e2c 202a 2a6b 7761 7267  lf(t_in, **kwarg
-00047ea0: 7329 0a0a 0a20 2020 2064 6566 2064 656c  s)...    def del
-00047eb0: 7461 7428 7365 6c66 2c20 6474 293a 0a20  tat(self, dt):. 
-00047ec0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00047ed0: 2020 2043 6f6e 7665 7274 2061 2074 696d     Convert a tim
-00047ee0: 6520 6060 7460 6020 696e 2073 6563 6f6e  e ``t`` in secon
-00047ef0: 6473 2066 726f 6d20 312f 312f 3835 2074  ds from 1/1/85 t
-00047f00: 6f20 616e 2049 534f 2074 696d 650a 2020  o an ISO time.  
-00047f10: 2020 2020 2020 2222 2220 2020 200a 2020        """    .  
-00047f20: 2020 2020 2020 6966 206e 6f74 2068 6173        if not has
-00047f30: 6174 7472 2864 742c 2027 756e 6974 2729  attr(dt, 'unit')
-00047f40: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
-00047f50: 7365 6320 3d20 6474 2a75 2e73 6563 6f6e  sec = dt*u.secon
-00047f60: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
-00047f70: 2020 2020 2020 2020 2020 2020 6474 7365              dtse
-00047f80: 6320 3d20 6474 0a20 2020 2020 2020 2020  c = dt.         
-00047f90: 2020 200a 2020 2020 2020 2020 7420 3d20     .        t = 
-00047fa0: 7365 6c66 2e5f 7431 3938 3520 2b20 6474  self._t1985 + dt
-00047fb0: 7365 630a 2020 2020 2020 2020 7265 7475  sec.        retu
-00047fc0: 726e 2074 0a0a 0a20 2020 2064 6566 2070  rn t...    def p
-00047fd0: 6172 7365 5f66 726f 6d5f 7370 7428 7365  arse_from_spt(se
-00047fe0: 6c66 2c20 7370 745f 6669 6c65 293a 0a20  lf, spt_file):. 
-00047ff0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00048000: 2020 2047 6574 206f 7262 6974 616c 2065     Get orbital e
-00048010: 6c65 6d65 6e74 7320 6672 6f6d 2053 5054  lements from SPT
-00048020: 2068 6561 6465 720a 2020 2020 2020 2020   header.        
-00048030: 2222 220a 2020 2020 2020 2020 696d 706f  """.        impo
-00048040: 7274 2061 7374 726f 7079 2e69 6f2e 6669  rt astropy.io.fi
-00048050: 7473 2061 7320 7079 6669 7473 0a20 2020  ts as pyfits.   
-00048060: 2020 2020 2069 6d70 6f72 7420 6173 7472       import astr
-00048070: 6f70 792e 7469 6d65 0a20 2020 2020 2020  opy.time.       
-00048080: 200a 2020 2020 2020 2020 7769 7468 2070   .        with p
-00048090: 7966 6974 732e 6f70 656e 2873 7074 5f66  yfits.open(spt_f
-000480a0: 696c 6529 2061 7320 5f69 6d3a 0a20 2020  ile) as _im:.   
-000480b0: 2020 2020 2020 2020 2073 7074 203d 205f           spt = _
-000480c0: 696d 5b30 5d2e 6865 6164 6572 2e63 6f70  im[0].header.cop
-000480d0: 7928 290a 2020 2020 2020 2020 0a20 2020  y().        .   
-000480e0: 2020 2020 2070 6172 616d 5f64 6963 7420       param_dict 
-000480f0: 3d20 7b7d 0a20 2020 2020 2020 2070 6172  = {}.        par
-00048100: 616d 5f64 6963 745b 2774 6175 275d 203d  am_dict['tau'] =
-00048110: 2073 7074 5b27 4550 4348 5449 4d45 275d   spt['EPCHTIME']
-00048120: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
-00048130: 6963 745b 274d 3027 5d20 3d20 7370 745b  ict['M0'] = spt[
-00048140: 274d 4541 4e41 4e4f 4d27 5d0a 2020 2020  'MEANANOM'].    
-00048150: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
-00048160: 4d2e 275d 203d 2073 7074 5b27 4644 4d45  M.'] = spt['FDME
-00048170: 414e 414e 275d 0a20 2020 2020 2020 2070  ANAN'].        p
-00048180: 6172 616d 5f64 6963 745b 274d 2e2e 275d  aram_dict['M..']
-00048190: 203d 2073 7074 5b27 5344 4d45 414e 414e   = spt['SDMEANAN
-000481a0: 275d 0a20 2020 2020 2020 2070 6172 616d  '].        param
-000481b0: 5f64 6963 745b 2765 275d 203d 2073 7074  _dict['e'] = spt
-000481c0: 5b27 4543 4345 4e54 5259 275d 0a20 2020  ['ECCENTRY'].   
-000481d0: 2020 2020 2070 6172 616d 5f64 6963 745b       param_dict[
-000481e0: 2761 2831 2d65 2a2a 3229 275d 203d 2073  'a(1-e**2)'] = s
-000481f0: 7074 5b27 5345 4d49 4c52 4543 275d 0a20  pt['SEMILREC']. 
-00048200: 2020 2020 2020 2070 6172 616d 5f64 6963         param_dic
-00048210: 745b 2761 275d 203d 2070 6172 616d 5f64  t['a'] = param_d
-00048220: 6963 745b 2761 2831 2d65 2a2a 3229 275d  ict['a(1-e**2)']
-00048230: 202f 2028 312d 7061 7261 6d5f 6469 6374   / (1-param_dict
-00048240: 5b27 6527 5d2a 2a32 290a 2020 2020 2020  ['e']**2).      
-00048250: 2020 7061 7261 6d5f 6469 6374 5b27 4f6d    param_dict['Om
-00048260: 3027 5d20 3d20 7370 745b 2752 4153 4341  0'] = spt['RASCA
-00048270: 5343 4e27 5d0a 2020 2020 2020 2020 7061  SCN'].        pa
-00048280: 7261 6d5f 6469 6374 5b27 4f6d 2e27 5d20  ram_dict['Om.'] 
-00048290: 3d20 7370 745b 2752 4341 5343 4e52 5627  = spt['RCASCNRV'
-000482a0: 5d0a 2020 2020 2020 2020 7061 7261 6d5f  ].        param_
-000482b0: 6469 6374 5b27 7730 275d 203d 2073 7074  dict['w0'] = spt
-000482c0: 5b27 4152 4750 4552 4947 275d 0a20 2020  ['ARGPERIG'].   
-000482d0: 2020 2020 2070 6172 616d 5f64 6963 745b       param_dict[
-000482e0: 2777 2e27 5d20 3d20 7370 745b 2752 4341  'w.'] = spt['RCA
-000482f0: 5247 5045 5227 5d0a 2020 2020 2020 2020  RGPER'].        
-00048300: 7061 7261 6d5f 6469 6374 5b27 636f 7369  param_dict['cosi
-00048310: 275d 203d 2073 7074 5b27 434f 5349 4e43  '] = spt['COSINC
-00048320: 4c49 275d 0a20 2020 2020 2020 2070 6172  LI'].        par
-00048330: 616d 5f64 6963 745b 2773 696e 6927 5d20  am_dict['sini'] 
-00048340: 3d20 7370 745b 2753 494e 4549 4e43 4c27  = spt['SINEINCL'
-00048350: 5d0a 2020 2020 2020 2020 7061 7261 6d5f  ].        param_
-00048360: 6469 6374 5b27 5663 275d 203d 2073 7074  dict['Vc'] = spt
-00048370: 5b27 4349 5256 454c 4f43 275d 0a20 2020  ['CIRVELOC'].   
-00048380: 2020 2020 2070 6172 616d 5f64 6963 745b       param_dict[
-00048390: 2774 696d 6566 6665 6327 5d20 3d20 7370  'timeffec'] = sp
-000483a0: 745b 2754 494d 4546 4645 4327 5d0a 2020  t['TIMEFFEC'].  
-000483b0: 2020 2020 2020 7061 7261 6d5f 6469 6374        param_dict
-000483c0: 5b27 546f 7262 275d 203d 2073 7074 5b27  ['Torb'] = spt['
-000483d0: 4853 5448 4f52 4227 5d2a 320a 2020 2020  HSTHORB']*2.    
-000483e0: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
-000483f0: 7473 7461 7274 275d 203d 2073 7074 5b27  tstart'] = spt['
-00048400: 4f42 5353 5452 5454 275d 0a20 2020 2020  OBSSTRTT'].     
-00048410: 2020 200a 2020 2020 2020 2020 7061 7261     .        para
-00048420: 6d5f 6469 6374 5b27 7461 755f 7469 6d65  m_dict['tau_time
-00048430: 275d 203d 2073 656c 662e 6465 6c74 6174  '] = self.deltat
-00048440: 2870 6172 616d 5f64 6963 745b 2774 6175  (param_dict['tau
-00048450: 275d 290a 2020 2020 2020 2020 7061 7261  ']).        para
-00048460: 6d5f 6469 6374 5b27 7473 7461 7274 5f74  m_dict['tstart_t
-00048470: 696d 6527 5d20 3d20 7365 6c66 2e64 656c  ime'] = self.del
-00048480: 7461 7428 7061 7261 6d5f 6469 6374 5b27  tat(param_dict['
-00048490: 7473 7461 7274 275d 290a 2020 2020 2020  tstart']).      
-000484a0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-000484b0: 2020 2072 6574 7572 6e20 7061 7261 6d5f     return param_
-000484c0: 6469 6374 0a20 2020 200a 2020 2020 4073  dict.    .    @s
-000484d0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-000484e0: 6465 6620 7879 7a5f 746f 5f6c 6f6e 6c61  def xyz_to_lonla
-000484f0: 7428 7365 6c66 2c20 782c 2079 2c20 7a2c  t(self, x, y, z,
-00048500: 2072 6164 6961 6e73 3d46 616c 7365 293a   radians=False):
-00048510: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00048520: 2020 2020 2043 6f6d 7075 7465 2073 7562       Compute sub
-00048530: 6c6f 6e2c 2073 7562 6c61 742c 2061 6c74  lon, sublat, alt
-00048540: 2066 726f 6d20 7879 7a20 636f 6f72 6473   from xyz coords
-00048550: 2077 6974 6820 7079 7072 6f6a 0a20 2020   with pyproj.   
-00048560: 2020 2020 200a 2020 2020 2020 2020 7879       .        xy
-00048570: 7a20 6d75 7374 2062 6520 696e 206d 6574  z must be in met
-00048580: 6572 730a 2020 2020 2020 2020 0a20 2020  ers.        .   
-00048590: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000485a0: 2069 6d70 6f72 7420 7079 7072 6f6a 0a20   import pyproj. 
-000485b0: 2020 2020 2020 2065 6365 6620 3d20 7079         ecef = py
-000485c0: 7072 6f6a 2e50 726f 6a28 7072 6f6a 3d27  proj.Proj(proj='
-000485d0: 6765 6f63 656e 7427 2c20 656c 6c70 733d  geocent', ellps=
-000485e0: 2757 4753 3834 272c 2064 6174 756d 3d27  'WGS84', datum='
-000485f0: 5747 5338 3427 290a 2020 2020 2020 2020  WGS84').        
-00048600: 6c6c 6120 3d20 7079 7072 6f6a 2e50 726f  lla = pyproj.Pro
-00048610: 6a28 7072 6f6a 3d27 6c61 746c 6f6e 6727  j(proj='latlong'
-00048620: 2c20 656c 6c70 733d 2757 4753 3834 272c  , ellps='WGS84',
-00048630: 2064 6174 756d 3d27 5747 5338 3427 290a   datum='WGS84').
-00048640: 2020 2020 2020 2020 6c6f 6e2c 206c 6174          lon, lat
-00048650: 2c20 616c 7420 3d20 7079 7072 6f6a 2e74  , alt = pyproj.t
-00048660: 7261 6e73 666f 726d 2865 6365 662c 206c  ransform(ecef, l
-00048670: 6c61 2c20 782c 2079 2c20 7a2c 2072 6164  la, x, y, z, rad
-00048680: 6961 6e73 3d72 6164 6961 6e73 290a 2020  ians=radians).  
-00048690: 2020 2020 2020 7265 7475 726e 206c 6f6e        return lon
-000486a0: 2c20 6c61 742c 2061 6c74 0a0a 0a64 6566  , lat, alt...def
-000486b0: 2070 6174 6368 5f70 686f 7475 7469 6c73   patch_photutils
-000486c0: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
-000486d0: 5061 7463 6820 746f 2066 6978 2069 6e63  Patch to fix inc
-000486e0: 6f6e 7369 7374 656e 6379 2077 6974 6820  onsistency with 
-000486f0: 6472 697a 7a6c 6570 6163 3d33 2e32 2e31  drizzlepac=3.2.1
-00048700: 2061 6e64 2070 686f 7475 7469 6c73 3e31   and photutils>1
-00048710: 2e30 2c20 7768 6572 6520 0a20 2020 2054  .0, where .    T
-00048720: 6865 206c 6174 7465 7220 6973 206e 6565  he latter is nee
-00048730: 6465 6420 666f 7220 6a77 7374 3d31 2e33  ded for jwst=1.3
-00048740: 2e32 0a20 2020 2022 2222 0a20 2020 2069  .2.    """.    i
-00048750: 6d70 6f72 7420 6f73 0a0a 2020 2020 7472  mport os..    tr
-00048760: 793a 0a20 2020 2020 2020 2069 6d70 6f72  y:.        impor
-00048770: 7420 6472 697a 7a6c 6570 6163 0a20 2020  t drizzlepac.   
-00048780: 2065 7863 6570 7420 4174 7472 6962 7574   except Attribut
-00048790: 6545 7272 6f72 3a0a 2020 2020 0a20 2020  eError:.    .   
-000487a0: 2020 2020 2069 6d70 6f72 7420 7068 6f74       import phot
-000487b0: 7574 696c 730a 2020 2020 2020 2020 7369  utils.        si
-000487c0: 7465 5f70 6163 6b61 6765 7320 3d20 6f73  te_packages = os
-000487d0: 2e70 6174 682e 6469 726e 616d 6528 7068  .path.dirname(ph
-000487e0: 6f74 7574 696c 732e 5f5f 6669 6c65 5f5f  otutils.__file__
-000487f0: 290a 2020 2020 2020 2020 2320 6d61 6e75  ).        # manu
-00048800: 616c 2061 7070 6c79 2070 6174 6368 0a20  al apply patch. 
-00048810: 2020 2020 2020 2074 6865 5f66 696c 6520         the_file 
-00048820: 3d20 6627 7b73 6974 655f 7061 636b 6167  = f'{site_packag
-00048830: 6573 7d2f 2e2e 2f64 7269 7a7a 6c65 7061  es}/../drizzlepa
-00048840: 632f 6861 7075 7469 6c73 2f61 6c69 676e  c/haputils/align
-00048850: 5f75 7469 6c73 2e70 7927 0a20 2020 2020  _utils.py'.     
-00048860: 2020 2077 6974 6820 6f70 656e 2874 6865     with open(the
-00048870: 5f66 696c 652c 2772 2729 2061 7320 6670  _file,'r') as fp
-00048880: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
-00048890: 6e65 7320 3d20 6670 2e72 6561 646c 696e  nes = fp.readlin
-000488a0: 6573 2829 0a20 2020 200a 2020 2020 2020  es().    .      
-000488b0: 2020 7072 696e 7428 7369 7465 5f70 6163    print(site_pac
-000488c0: 6b61 6765 732c 206c 656e 286c 696e 6573  kages, len(lines
-000488d0: 2929 0a20 2020 2020 2020 2066 6f72 2069  )).        for i
-000488e0: 2c20 6c69 6e65 2069 6e20 656e 756d 6572  , line in enumer
-000488f0: 6174 6528 6c69 6e65 7329 3a0a 2020 2020  ate(lines):.    
-00048900: 2020 2020 2020 2020 6966 206c 696e 652e          if line.
-00048910: 7374 6172 7473 7769 7468 2827 4e6f 4465  startswith('NoDe
-00048920: 7465 6374 696f 6e73 5761 726e 696e 6727  tectionsWarning'
-00048930: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00048940: 2020 2062 7265 616b 0a20 2020 200a 2020     break.    .  
-00048950: 2020 2020 2020 6966 2027 6861 7361 7474        if 'hasatt
-00048960: 7228 7068 6f74 7574 696c 732e 6669 6e64  r(photutils.find
-00048970: 7374 6172 7327 2069 6e20 6c69 6e65 735b  stars' in lines[
-00048980: 692b 315d 3a0a 2020 2020 2020 2020 2020  i+1]:.          
-00048990: 2020 7072 696e 7428 6627 4920 666f 756e    print(f'I foun
-000489a0: 6420 7468 6520 7072 6f62 6c65 6d20 6f6e  d the problem on
-000489b0: 206c 696e 6573 207b 697d 2d7b 692b 327d   lines {i}-{i+2}
-000489c0: 3a20 2729 0a20 2020 2020 2020 2065 6c73  : ').        els
-000489d0: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-000489e0: 7367 203d 2022 2222 0a4c 696e 6573 207b  sg = """.Lines {
-000489f0: 307d 2d7b 317d 2069 6e20 7b32 7d20 696d  0}-{1} in {2} im
-00048a00: 706f 7274 696e 6720 7068 6f74 7574 696c  porting photutil
-00048a10: 7320 7765 7265 206e 6f74 2061 7320 6578  s were not as ex
-00048a20: 7065 6374 6564 2e20 2049 2066 6f75 6e64  pected.  I found
-00048a30: 200a 0a7b 337d 0a0a 6275 7420 6578 7065   ..{3}..but expe
-00048a40: 6374 6564 200a 0a20 2020 4e6f 4465 7465  cted ..   NoDete
-00048a50: 6374 696f 6e73 5761 726e 696e 6720 3d20  ctionsWarning = 
-00048a60: 7068 6f74 7574 696c 732e 6669 6e64 7374  photutils.findst
-00048a70: 6172 732e 4e6f 4465 7465 6374 696f 6e73  ars.NoDetections
-00048a80: 5761 726e 696e 6720 6966 205c 5c0a 2020  Warning if \\.  
-00048a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048aa0: 2020 2020 2020 2020 2068 6173 6174 7472           hasattr
-00048ab0: 2870 686f 7475 7469 6c73 2e66 696e 6473  (photutils.finds
-00048ac0: 7461 7273 2c20 274e 6f44 6574 6563 7469  tars, 'NoDetecti
-00048ad0: 6f6e 7357 6172 6e69 6e67 2729 2065 6c73  onsWarning') els
-00048ae0: 6520 5c5c 0a20 2020 2020 2020 2020 2020  e \\.           
-00048af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048b00: 7068 6f74 7574 696c 732e 7574 696c 732e  photutils.utils.
-00048b10: 4e6f 4465 7465 6374 696f 6e73 5761 726e  NoDetectionsWarn
-00048b20: 696e 670a 0a0a 2020 2020 2222 222e 666f  ing...    """.fo
-00048b30: 726d 6174 2869 2c20 692b 322c 2074 6865  rmat(i, i+2, the
-00048b40: 5f66 696c 652c 206c 696e 6573 5b69 3a69  _file, lines[i:i
-00048b50: 2b33 5d29 0a20 2020 2020 2020 200a 2020  +3]).        .  
-00048b60: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00048b70: 5661 6c75 6545 7272 6f72 286d 7367 290a  ValueError(msg).
-00048b80: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00048b90: 2062 6164 203d 205b 2720 2020 272b 6c69   bad = ['   '+li
-00048ba0: 6e65 732e 706f 7028 692b 322d 6a29 2066  nes.pop(i+2-j) f
-00048bb0: 6f72 206a 2069 6e20 7261 6e67 6528 3329  or j in range(3)
-00048bc0: 5d0a 2020 2020 2020 2020 7072 696e 7428  ].        print(
-00048bd0: 2727 2e6a 6f69 6e28 6261 645b 3a3a 2d31  ''.join(bad[::-1
-00048be0: 5d29 290a 0a20 2020 2020 2020 2023 2049  ]))..        # I
-00048bf0: 6e73 6572 7420 7468 6520 6669 780a 2020  nsert the fix.  
-00048c00: 2020 2020 2020 6c69 6e65 735b 695d 203d        lines[i] =
-00048c10: 2027 6672 6f6d 2070 686f 7475 7469 6c73   'from photutils
-00048c20: 2e75 7469 6c73 2e65 7863 6570 7469 6f6e  .utils.exception
-00048c30: 7320 696d 706f 7274 204e 6f44 6574 6563  s import NoDetec
-00048c40: 7469 6f6e 7357 6172 6e69 6e67 5c6e 5c6e  tionsWarning\n\n
-00048c50: 270a 2020 2020 2020 2020 2320 5265 7772  '.        # Rewr
-00048c60: 6974 6520 7468 6520 6669 650a 2020 2020  ite the fie.    
-00048c70: 2020 2020 7769 7468 206f 7065 6e28 6627      with open(f'
-00048c80: 7b73 6974 655f 7061 636b 6167 6573 7d2f  {site_packages}/
-00048c90: 2e2e 2f64 7269 7a7a 6c65 7061 632f 6861  ../drizzlepac/ha
-00048ca0: 7075 7469 6c73 2f61 6c69 676e 5f75 7469  putils/align_uti
-00048cb0: 6c73 2e70 7927 2c27 7727 2920 6173 2066  ls.py','w') as f
-00048cc0: 703a 0a20 2020 2020 2020 2020 2020 2066  p:.            f
-00048cd0: 702e 7772 6974 656c 696e 6573 286c 696e  p.writelines(lin
-00048ce0: 6573 290a 2020 2020 0a20 2020 2020 2020  es).    .       
-00048cf0: 2070 7269 6e74 2866 2750 6174 6368 2061   print(f'Patch a
-00048d00: 7070 6c69 6564 2074 6f20 7b74 6865 5f66  pplied to {the_f
-00048d10: 696c 657d 2127 290a                      ile}!').
+0003f340: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0003f350: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
+0003f360: 5f72 6f77 732e 6170 7065 6e64 2872 6f77  _rows.append(row
+0003f370: 5f69 202b 2064 6573 6372 290a 2020 2020  _i + descr).    
+0003f380: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0003f390: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
+0003f3a0: 696e 7075 7420 3d20 2222 220a 0a3c 6469  input = """..<di
+0003f3b0: 7620 7374 796c 653d 2262 6f72 6465 723a  v style="border:
+0003f3c0: 3170 7820 736f 6c69 6420 626c 6163 6b3b  1px solid black;
+0003f3d0: 2070 6164 6469 6e67 3a31 3070 783b 206d   padding:10px; m
+0003f3e0: 6172 6769 6e3a 3130 7078 223e 0a3c 623e  argin:10px">.<b>
+0003f3f0: 2046 696c 7465 723a 203c 2f62 3e0a 2020   Filter: </b>.  
+0003f400: 2020 3c74 6162 6c65 3e0a 2020 2020 2020    <table>.      
+0003f410: 7b30 7d0a 2020 2020 3c2f 7461 626c 653e  {0}.    </table>
+0003f420: 0a3c 2f64 6976 3e0a 0a22 2222 2e66 6f72  .</div>..""".for
+0003f430: 6d61 7428 275c 6e27 2e6a 6f69 6e28 6669  mat('\n'.join(fi
+0003f440: 6c74 6572 5f72 6f77 7329 290a 0a20 2020  lter_rows))..   
+0003f450: 2020 2020 2020 2020 206c 696e 6573 2e69           lines.i
+0003f460: 6e73 6572 7428 696c 2b31 2c20 6669 6c74  nsert(il+1, filt
+0003f470: 6572 5f69 6e70 7574 290a 0a20 2020 2020  er_input)..     
+0003f480: 2020 2020 2020 2023 204a 6176 6173 6372         # Javascr
+0003f490: 6970 7420 7075 7368 2066 756e 6374 696f  ipt push functio
+0003f4a0: 6e0a 2020 2020 2020 2020 2020 2020 6865  n.            he
+0003f4b0: 6164 6572 5f6c 696e 6573 203d 2022 220a  ader_lines = "".
+0003f4c0: 2020 2020 2020 2020 2020 2020 7465 7374              test
+0003f4d0: 6572 203d 205b 5d0a 0a20 2020 2020 2020  er = []..       
+0003f4e0: 2020 2020 2066 6f72 2069 6320 696e 2069       for ic in i
+0003f4f0: 635f 6c69 7374 3a0a 2020 2020 2020 2020  c_list:.        
+0003f500: 2020 2020 2020 2020 6865 6164 6572 5f6c          header_l
+0003f510: 696e 6573 202b 3d20 2222 220a 2020 2020  ines += """.    
+0003f520: 2020 2020 7661 7220 6d69 6e5f 7b30 7d20      var min_{0} 
+0003f530: 3d20 7061 7273 6546 6c6f 6174 2820 2428  = parseFloat( $(
+0003f540: 2723 7b30 7d5f 6d69 6e27 292e 7661 6c28  '#{0}_min').val(
+0003f550: 2929 207c 7c20 2d31 6533 303b 0a20 2020  )) || -1e30;.   
+0003f560: 2020 2020 2076 6172 206d 6178 5f7b 307d       var max_{0}
+0003f570: 203d 2070 6172 7365 466c 6f61 7428 2024   = parseFloat( $
+0003f580: 2827 237b 307d 5f6d 6178 2729 2e76 616c  ('#{0}_max').val
+0003f590: 2829 2920 7c7c 2020 3165 3330 3b0a 2020  ()) ||  1e30;.  
+0003f5a0: 2020 2020 2020 7661 7220 6461 7461 5f7b        var data_{
+0003f5b0: 307d 203d 2070 6172 7365 466c 6f61 7428  0} = parseFloat(
+0003f5c0: 2064 6174 615b 7b31 7d5d 2029 207c 7c20   data[{1}] ) || 
+0003f5d0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0003f5e0: 2020 2022 2222 2e66 6f72 6d61 7428 7365     """.format(se
+0003f5f0: 6c66 2e63 6f6c 6e61 6d65 735b 6963 5d2c  lf.colnames[ic],
+0003f600: 2069 6329 0a0a 2020 2020 2020 2020 2020   ic)..          
+0003f610: 2020 2020 2020 7465 7374 6572 2e61 7070        tester.app
+0003f620: 656e 6428 2222 2228 2028 2069 734e 614e  end("""( ( isNaN
+0003f630: 2820 6d69 6e5f 7b30 7d20 2920 2626 2069  ( min_{0} ) && i
+0003f640: 734e 614e 2820 6d61 785f 7b30 7d20 2920  sNaN( max_{0} ) 
+0003f650: 2920 7c7c 2028 2069 734e 614e 2820 6d69  ) || ( isNaN( mi
+0003f660: 6e5f 7b30 7d20 2920 2626 2064 6174 615f  n_{0} ) && data_
+0003f670: 7b30 7d20 3c3d 206d 6178 5f7b 307d 2029  {0} <= max_{0} )
+0003f680: 207c 7c20 2820 6d69 6e5f 7b30 7d20 3c3d   || ( min_{0} <=
+0003f690: 2064 6174 615f 7b30 7d20 2026 2620 6973   data_{0}  && is
+0003f6a0: 4e61 4e28 206d 6178 5f7b 307d 2029 2029  NaN( max_{0} ) )
+0003f6b0: 207c 7c20 2820 6d69 6e5f 7b30 7d20 3c3d   || ( min_{0} <=
+0003f6c0: 2064 6174 615f 7b30 7d20 2026 2620 6461   data_{0}  && da
+0003f6d0: 7461 5f7b 307d 203c 3d20 6d61 785f 7b30  ta_{0} <= max_{0
+0003f6e0: 7d20 2920 2922 2222 2e66 6f72 6d61 7428  } ) )""".format(
+0003f6f0: 7365 6c66 2e63 6f6c 6e61 6d65 735b 6963  self.colnames[ic
+0003f700: 5d29 290a 0a20 2020 2020 2020 2020 2020  ]))..           
+0003f710: 2023 204a 6176 6173 6372 6970 7420 6669   # Javascript fi
+0003f720: 6c74 6572 2066 756e 6374 696f 6e0a 2020  lter function.  
+0003f730: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
+0003f740: 5f66 756e 6374 696f 6e20 3d20 2222 220a  _function = """.
+0003f750: 0a2f 2f2f 2f20 5061 7273 6572 0a2f 2f20  .//// Parser.// 
+0003f760: 6874 7470 733a 2f2f 7374 6163 6b6f 7665  https://stackove
+0003f770: 7266 6c6f 772e 636f 6d2f 7175 6573 7469  rflow.com/questi
+0003f780: 6f6e 732f 3139 3439 3133 3336 2f67 6574  ons/19491336/get
+0003f790: 2d75 726c 2d70 6172 616d 6574 6572 2d6a  -url-parameter-j
+0003f7a0: 7175 6572 792d 6f72 2d68 6f77 2d74 6f2d  query-or-how-to-
+0003f7b0: 6765 742d 7175 6572 792d 7374 7269 6e67  get-query-string
+0003f7c0: 2d76 616c 7565 732d 696e 2d6a 7320 4020  -values-in-js @ 
+0003f7d0: 5265 7a61 2042 6172 6164 6172 616e 0a24  Reza Baradaran.$
+0003f7e0: 2e75 726c 5061 7261 6d20 3d20 6675 6e63  .urlParam = func
+0003f7f0: 7469 6f6e 286e 616d 6529 7b7b 0a20 2020  tion(name){{.   
+0003f800: 2076 6172 2072 6573 756c 7473 203d 206e   var results = n
+0003f810: 6577 2052 6567 4578 7028 275b 5c3f 265d  ew RegExp('[\?&]
+0003f820: 2720 2b20 6e61 6d65 202b 2027 3d28 5b5e  ' + name + '=([^
+0003f830: 2623 5d2a 2927 292e 6578 6563 2877 696e  &#]*)').exec(win
+0003f840: 646f 772e 6c6f 6361 7469 6f6e 2e68 7265  dow.location.hre
+0003f850: 6629 3b0a 2020 2020 6966 2028 7265 7375  f);.    if (resu
+0003f860: 6c74 733d 3d6e 756c 6c29 7b7b 0a20 2020  lts==null){{.   
+0003f870: 2020 2020 7265 7475 726e 206e 756c 6c3b      return null;
+0003f880: 0a20 2020 207d 7d0a 2020 2020 656c 7365  .    }}.    else
+0003f890: 7b7b 0a20 2020 2020 2020 7265 7475 726e  {{.       return
+0003f8a0: 2064 6563 6f64 6555 5249 2872 6573 756c   decodeURI(resul
+0003f8b0: 7473 5b31 5d29 207c 7c20 303b 0a20 2020  ts[1]) || 0;.   
+0003f8c0: 207d 7d0a 7d7d 0a0a 242e 666e 2e64 6174   }}.}}..$.fn.dat
+0003f8d0: 6154 6162 6c65 2e65 7874 2e73 6561 7263  aTable.ext.searc
+0003f8e0: 682e 7075 7368 280a 2020 2020 6675 6e63  h.push(.    func
+0003f8f0: 7469 6f6e 2820 7365 7474 696e 6773 2c20  tion( settings, 
+0003f900: 6461 7461 2c20 6461 7461 496e 6465 7820  data, dataIndex 
+0003f910: 2920 7b7b 0a7b 307d 0a0a 2020 2020 2020  ) {{.{0}..      
+0003f920: 2020 6966 2028 207b 317d 2029 0a20 2020    if ( {1} ).   
+0003f930: 2020 2020 207b 7b0a 2020 2020 2020 2020       {{.        
+0003f940: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
+0003f950: 0a20 2020 2020 2020 207d 7d0a 2020 2020  .        }}.    
+0003f960: 2020 2020 7265 7475 726e 2066 616c 7365      return false
+0003f970: 3b0a 2020 2020 7d7d 0a29 3b0a 0a2f 2f2f  ;.    }}.);..///
+0003f980: 2f20 5570 6461 7465 2055 524c 2077 6974  / Update URL wit
+0003f990: 6820 6669 6c74 6572 2070 6172 616d 6574  h filter paramet
+0003f9a0: 6572 730a 7661 7220 6669 6c74 6572 5f70  ers.var filter_p
+0003f9b0: 6172 616d 7320 3d20 7b32 7d3b 0a0a 242e  arams = {2};..$.
+0003f9c0: 5570 6461 7465 4669 6c74 6572 5552 4c20  UpdateFilterURL 
+0003f9d0: 3d20 6675 6e63 7469 6f6e 2028 2920 7b7b  = function () {{
+0003f9e0: 0a20 2020 2076 6172 2069 3b0a 2020 2020  .    var i;.    
+0003f9f0: 7661 7220 6669 6c74 6572 5f75 726c 203d  var filter_url =
+0003fa00: 2022 223b 0a20 2020 2066 6f72 2028 6920   "";.    for (i 
+0003fa10: 3d20 303b 2069 203c 2066 696c 7465 725f  = 0; i < filter_
+0003fa20: 7061 7261 6d73 2e6c 656e 6774 683b 2069  params.length; i
+0003fa30: 2b2b 2920 7b7b 0a20 2020 2020 2020 2069  ++) {{.        i
+0003fa40: 6620 2824 2827 2327 2b66 696c 7465 725f  f ($('#'+filter_
+0003fa50: 7061 7261 6d73 5b69 5d2b 275f 6d69 6e27  params[i]+'_min'
+0003fa60: 292e 7661 6c28 2920 213d 2022 2229 207b  ).val() != "") {
+0003fa70: 7b0a 2020 2020 2020 2020 2020 2020 6669  {.            fi
+0003fa80: 6c74 6572 5f75 726c 202b 3d20 2726 272b  lter_url += '&'+
+0003fa90: 6669 6c74 6572 5f70 6172 616d 735b 695d  filter_params[i]
+0003faa0: 2b27 5f6d 696e 3d27 2b0a 2020 2020 2020  +'_min='+.      
+0003fab0: 2020 2020 2020 2020 2020 2020 2020 2428                $(
+0003fac0: 2723 272b 6669 6c74 6572 5f70 6172 616d  '#'+filter_param
+0003fad0: 735b 695d 2b27 5f6d 696e 2729 2e76 616c  s[i]+'_min').val
+0003fae0: 2829 3b0a 2020 2020 2020 2020 7d7d 0a20  ();.        }}. 
+0003faf0: 2020 2020 2020 2069 6620 2824 2827 2327         if ($('#'
+0003fb00: 2b66 696c 7465 725f 7061 7261 6d73 5b69  +filter_params[i
+0003fb10: 5d2b 275f 6d61 7827 292e 7661 6c28 2920  ]+'_max').val() 
+0003fb20: 213d 2022 2229 207b 7b0a 2020 2020 2020  != "") {{.      
+0003fb30: 2020 2020 2020 6669 6c74 6572 5f75 726c        filter_url
+0003fb40: 202b 3d20 2726 272b 6669 6c74 6572 5f70   += '&'+filter_p
+0003fb50: 6172 616d 735b 695d 2b27 5f6d 6178 3d27  arams[i]+'_max='
+0003fb60: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+0003fb70: 2020 2020 2020 2428 2723 272b 6669 6c74        $('#'+filt
+0003fb80: 6572 5f70 6172 616d 735b 695d 2b27 5f6d  er_params[i]+'_m
+0003fb90: 6178 2729 2e76 616c 2829 3b0a 2020 2020  ax').val();.    
+0003fba0: 2020 2020 7d7d 0a20 2020 207d 7d0a 0a20      }}.    }}.. 
+0003fbb0: 2020 2069 6620 2866 696c 7465 725f 7572     if (filter_ur
+0003fbc0: 6c20 213d 2022 2229 207b 7b0a 2020 2020  l != "") {{.    
+0003fbd0: 2020 2020 7661 7220 6669 6c74 6572 6564      var filtered
+0003fbe0: 5f75 726c 203d 2077 696e 646f 772e 6c6f  _url = window.lo
+0003fbf0: 6361 7469 6f6e 2e68 7265 662e 7370 6c69  cation.href.spli
+0003fc00: 7428 273f 2729 5b30 5d20 2b20 273f 2720  t('?')[0] + '?' 
+0003fc10: 2b20 6669 6c74 6572 5f75 726c 3b0a 2020  + filter_url;.  
+0003fc20: 2020 2020 2020 7769 6e64 6f77 2e68 6973        window.his
+0003fc30: 746f 7279 2e70 7573 6853 7461 7465 2827  tory.pushState('
+0003fc40: 272c 2027 272c 2066 696c 7465 7265 645f  ', '', filtered_
+0003fc50: 7572 6c29 3b0a 2020 2020 7d7d 0a7d 7d5c  url);.    }}.}}\
+0003fc60: 6e5c 6e22 2222 2e66 6f72 6d61 7428 6865  n\n""".format(he
+0003fc70: 6164 6572 5f6c 696e 6573 2c20 225c 6e20  ader_lines, "\n 
+0003fc80: 2626 2022 2e6a 6f69 6e28 7465 7374 6572  && ".join(tester
+0003fc90: 292c 205b 7365 6c66 2e63 6f6c 6e61 6d65  ), [self.colname
+0003fca0: 735b 6963 5d20 666f 7220 6963 2069 6e20  s[ic] for ic in 
+0003fcb0: 6963 5f6c 6973 745d 2e5f 5f72 6570 725f  ic_list].__repr_
+0003fcc0: 5f28 2929 0a0a 2020 2020 2020 2020 2020  _())..          
+0003fcd0: 2020 666f 7220 692c 206c 696e 6520 696e    for i, line in
+0003fce0: 2065 6e75 6d65 7261 7465 286c 696e 6573   enumerate(lines
+0003fcf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003fd00: 2020 2069 6620 2224 2864 6f63 756d 656e     if "$(documen
+0003fd10: 7429 2e72 6561 6479 2866 756e 6374 696f  t).ready(functio
+0003fd20: 6e28 2922 2069 6e20 6c69 6e65 3a0a 2020  n()" in line:.  
+0003fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd40: 2020 6973 7461 7274 203d 2069 0a20 2020    istart = i.   
+0003fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd60: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+0003fd70: 2020 2020 6c69 6e65 732e 696e 7365 7274      lines.insert
+0003fd80: 2869 7374 6172 742c 2066 696c 7465 725f  (istart, filter_
+0003fd90: 6675 6e63 7469 6f6e 290a 0a20 2020 2020  function)..     
+0003fda0: 2020 2020 2020 2023 2050 6172 7365 2061         # Parse a
+0003fdb0: 6464 7265 7373 2062 6172 0a20 2020 2020  ddress bar.     
+0003fdc0: 2020 2020 2020 206c 696e 6573 2e69 6e73         lines.ins
+0003fdd0: 6572 7428 6973 7461 7274 2b32 2c20 225c  ert(istart+2, "\
+0003fde0: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
+0003fdf0: 666f 7220 6963 2069 6e20 6963 5f6c 6973  for ic in ic_lis
+0003fe00: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0003fe10: 2020 206c 696e 6573 2e69 6e73 6572 7428     lines.insert(
+0003fe20: 6973 7461 7274 2b32 2c20 227b 317d 2428  istart+2, "{1}$(
+0003fe30: 2723 7b30 7d5f 6d61 7827 292e 7661 6c28  '#{0}_max').val(
+0003fe40: 242e 7572 6c50 6172 616d 2827 7b30 7d5f  $.urlParam('{0}_
+0003fe50: 6d61 7827 2929 3b5c 6e22 2e66 6f72 6d61  max'));\n".forma
+0003fe60: 7428 7365 6c66 2e63 6f6c 6e61 6d65 735b  t(self.colnames[
+0003fe70: 6963 5d2c 2027 2027 2a33 2929 0a20 2020  ic], ' '*3)).   
+0003fe80: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+0003fe90: 6573 2e69 6e73 6572 7428 6973 7461 7274  es.insert(istart
+0003fea0: 2b32 2c20 227b 317d 2428 2723 7b30 7d5f  +2, "{1}$('#{0}_
+0003feb0: 6d69 6e27 292e 7661 6c28 242e 7572 6c50  min').val($.urlP
+0003fec0: 6172 616d 2827 7b30 7d5f 6d69 6e27 2929  aram('{0}_min'))
+0003fed0: 3b5c 6e22 2e66 6f72 6d61 7428 7365 6c66  ;\n".format(self
+0003fee0: 2e63 6f6c 6e61 6d65 735b 6963 5d2c 2027  .colnames[ic], '
+0003fef0: 2027 2a33 2929 0a20 2020 2020 2020 2020   '*3)).         
+0003ff00: 2020 206c 696e 6573 2e69 6e73 6572 7428     lines.insert(
+0003ff10: 6973 7461 7274 2b32 2c20 225c 6e22 290a  istart+2, "\n").
+0003ff20: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+0003ff30: 6e70 7574 206c 6973 7465 6e65 720a 2020  nput listener.  
+0003ff40: 2020 2020 2020 2020 2020 6c69 7374 656e            listen
+0003ff50: 6572 203d 2022 2222 0a20 2020 202f 2f20  er = """.    // 
+0003ff60: 4576 656e 7420 6c69 7374 656e 6572 2074  Event listener t
+0003ff70: 6f20 7468 6520 7477 6f20 7261 6e67 6520  o the two range 
+0003ff80: 6669 6c74 6572 696e 6720 696e 7075 7473  filtering inputs
+0003ff90: 2074 6f20 7265 6472 6177 206f 6e20 696e   to redraw on in
+0003ffa0: 7075 740a 2020 2020 2428 277b 307d 2729  put.    $('{0}')
+0003ffb0: 2e6b 6579 7570 2820 6675 6e63 7469 6f6e  .keyup( function
+0003ffc0: 2829 207b 7b0a 2020 2020 2020 2020 7461  () {{.        ta
+0003ffd0: 626c 652e 6472 6177 2829 3b0a 2020 2020  ble.draw();.    
+0003ffe0: 2020 2020 242e 5570 6461 7465 4669 6c74      $.UpdateFilt
+0003fff0: 6572 5552 4c28 293b 0a20 2020 207d 7d20  erURL();.    }} 
+00040000: 293b 0a20 2020 2020 2020 2020 2020 2022  );.            "
+00040010: 2222 2e66 6f72 6d61 7428 272c 2027 2e6a  "".format(', '.j
+00040020: 6f69 6e28 5b27 237b 307d 5f6d 696e 2c20  oin(['#{0}_min, 
+00040030: 237b 307d 5f6d 6178 272e 666f 726d 6174  #{0}_max'.format
+00040040: 2873 656c 662e 636f 6c6e 616d 6573 5b69  (self.colnames[i
+00040050: 635d 2920 666f 7220 6963 2069 6e20 6963  c]) for ic in ic
+00040060: 5f6c 6973 745d 2929 0a0a 2020 2020 2020  _list]))..      
+00040070: 2020 2020 2020 666f 7220 696c 2c20 6c69        for il, li
+00040080: 6e65 2069 6e20 656e 756d 6572 6174 6528  ne in enumerate(
+00040090: 6c69 6e65 7329 3a0a 2020 2020 2020 2020  lines):.        
+000400a0: 2020 2020 2020 2020 6966 2027 7d20 293b          if '} );
+000400b0: 2020 3c2f 7363 7269 7074 3e27 2069 6e20    </script>' in 
+000400c0: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
+000400d0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+000400e0: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+000400f0: 6573 2e69 6e73 6572 7428 696c 2c20 6c69  es.insert(il, li
+00040100: 7374 656e 6572 290a 0a20 2020 2020 2020  stener)..       
+00040110: 2020 2020 2066 7020 3d20 6f70 656e 286f       fp = open(o
+00040120: 7574 7075 742c 2027 7727 290a 2020 2020  utput, 'w').    
+00040130: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
+00040140: 6c69 6e65 7328 6c69 6e65 7329 0a20 2020  lines(lines).   
+00040150: 2020 2020 2020 2020 2066 702e 636c 6f73           fp.clos
+00040160: 6528 290a 0a20 2020 2020 2020 2069 6620  e()..        if 
+00040170: 746f 6767 6c65 3a0a 2020 2020 2020 2020  toggle:.        
+00040180: 2020 2020 6c69 6e65 7320 3d20 6f70 656e      lines = open
+00040190: 286f 7574 7075 7429 2e72 6561 646c 696e  (output).readlin
+000401a0: 6573 2829 0a0a 2020 2020 2020 2020 2020  es()..          
+000401b0: 2020 2320 4368 616e 6765 2063 616c 6c20    # Change call 
+000401c0: 746f 2044 6174 6154 6162 6c65 0a20 2020  to DataTable.   
+000401d0: 2020 2020 2020 2020 2066 6f72 2069 6c2c           for il,
+000401e0: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
+000401f0: 7465 286c 696e 6573 293a 0a20 2020 2020  te(lines):.     
+00040200: 2020 2020 2020 2020 2020 2069 6620 2764             if 'd
+00040210: 6174 6154 6162 6c65 2827 2069 6e20 6c69  ataTable(' in li
+00040220: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00040230: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+00040240: 2020 2020 2020 2020 2020 206c 696e 6573             lines
+00040250: 5b69 6c5d 203d 2022 2020 2076 6172 2074  [il] = "   var t
+00040260: 6162 6c65 203d 207b 307d 5c6e 222e 666f  able = {0}\n".fo
+00040270: 726d 6174 286c 696e 6573 5b69 6c5d 2e73  rmat(lines[il].s
+00040280: 7472 6970 2829 2e72 6570 6c61 6365 2827  trip().replace('
+00040290: 6461 7461 5461 626c 6527 2c20 2744 6174  dataTable', 'Dat
+000402a0: 6154 6162 6c65 2729 290a 0a20 2020 2020  aTable'))..     
+000402b0: 2020 2020 2020 2023 2041 6464 2066 756e         # Add fun
+000402c0: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
+000402d0: 2020 666f 7220 696c 2c20 6c69 6e65 2069    for il, line i
+000402e0: 6e20 656e 756d 6572 6174 6528 6c69 6e65  n enumerate(line
+000402f0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00040300: 2020 2020 6966 2027 7d20 293b 2020 3c2f      if '} );  </
+00040310: 7363 7269 7074 3e27 2069 6e20 6c69 6e65  script>' in line
+00040320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040330: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
+00040340: 2020 2020 2020 2020 2074 6f67 676c 6572           toggler
+00040350: 203d 2022 2222 0a20 2020 2024 2827 612e   = """.    $('a.
+00040360: 746f 6767 6c65 2d76 6973 2729 2e6f 6e28  toggle-vis').on(
+00040370: 2027 636c 6963 6b27 2c20 6675 6e63 7469   'click', functi
+00040380: 6f6e 2028 6529 207b 0a20 2020 2020 2020  on (e) {.       
+00040390: 2065 2e70 7265 7665 6e74 4465 6661 756c   e.preventDefaul
+000403a0: 7428 293b 0a0a 2020 2020 2020 2020 2f2f  t();..        //
+000403b0: 2047 6574 2074 6865 2063 6f6c 756d 6e20   Get the column 
+000403c0: 4150 4920 6f62 6a65 6374 0a20 2020 2020  API object.     
+000403d0: 2020 2076 6172 2063 6f6c 756d 6e20 3d20     var column = 
+000403e0: 7461 626c 652e 636f 6c75 6d6e 2820 2428  table.column( $(
+000403f0: 7468 6973 292e 6174 7472 2827 6461 7461  this).attr('data
+00040400: 2d63 6f6c 756d 6e27 2920 293b 0a0a 2020  -column') );..  
+00040410: 2020 2020 2020 2f2f 2054 6f67 676c 6520        // Toggle 
+00040420: 7468 6520 7669 7369 6269 6c69 7479 0a20  the visibility. 
+00040430: 2020 2020 2020 2063 6f6c 756d 6e2e 7669         column.vi
+00040440: 7369 626c 6528 2021 2063 6f6c 756d 6e2e  sible( ! column.
+00040450: 7669 7369 626c 6528 2920 293b 0a20 2020  visible() );.   
+00040460: 207d 2029 3b0a 0a20 2020 2020 2020 2020   } );..         
+00040470: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+00040480: 2020 206c 696e 6573 2e69 6e73 6572 7428     lines.insert(
+00040490: 696c 2c20 746f 6767 6c65 7229 0a0a 2020  il, toggler)..  
+000404a0: 2020 2020 2020 2020 2020 746f 6767 6c65            toggle
+000404b0: 5f64 6976 203d 2022 2222 0a3c 6469 7620  _div = """.<div 
+000404c0: 7374 796c 653d 2262 6f72 6465 723a 3170  style="border:1p
+000404d0: 7820 736f 6c69 6420 626c 6163 6b3b 2070  x solid black; p
+000404e0: 6164 6469 6e67 3a31 3070 783b 206d 6172  adding:10px; mar
+000404f0: 6769 6e3a 3130 7078 223e 0a20 2020 203c  gin:10px">.    <
+00040500: 623e 546f 6767 6c65 2063 6f6c 756d 6e3a  b>Toggle column:
+00040510: 3c2f 623e 3c2f 6272 3e20 7b30 7d0a 3c2f  </b></br> {0}.</
+00040520: 6469 763e 0a0a 2020 2020 2020 2020 2020  div>..          
+00040530: 2020 2222 222e 666f 726d 6174 2827 203c    """.format(' <
+00040540: 623e 2f3c 2f62 3e20 272e 6a6f 696e 285b  b>/</b> '.join([
+00040550: 273c 6120 636c 6173 733d 2274 6f67 676c  '<a class="toggl
+00040560: 652d 7669 7322 2064 6174 612d 636f 6c75  e-vis" data-colu
+00040570: 6d6e 3d22 7b30 7d22 3e20 3c74 743e 7b31  mn="{0}"> <tt>{1
+00040580: 7d3c 2f74 743e 203c 2f61 3e27 2e66 6f72  }</tt> </a>'.for
+00040590: 6d61 7428 6963 2c20 636f 6c29 2066 6f72  mat(ic, col) for
+000405a0: 2069 632c 2063 6f6c 2069 6e20 656e 756d   ic, col in enum
+000405b0: 6572 6174 6528 7365 6c66 2e63 6f6c 6e61  erate(self.colna
+000405c0: 6d65 7329 5d29 290a 0a20 2020 2020 2020  mes)]))..       
+000405d0: 2020 2020 206c 696e 6573 2e69 6e73 6572       lines.inser
+000405e0: 7428 696c 2b32 2c20 746f 6767 6c65 5f64  t(il+2, toggle_d
+000405f0: 6976 290a 0a20 2020 2020 2020 2020 2020  iv)..           
+00040600: 2066 7020 3d20 6f70 656e 286f 7574 7075   fp = open(outpu
+00040610: 742c 2027 7727 290a 2020 2020 2020 2020  t, 'w').        
+00040620: 2020 2020 6670 2e77 7269 7465 6c69 6e65      fp.writeline
+00040630: 7328 6c69 6e65 7329 0a20 2020 2020 2020  s(lines).       
+00040640: 2020 2020 2066 702e 636c 6f73 6528 290a       fp.close().
+00040650: 0a20 2020 2020 2020 2069 6620 7573 655f  .        if use_
+00040660: 6a73 6f6e 3a0a 2020 2020 2020 2020 2020  json:.          
+00040670: 2020 2320 5772 6974 6520 6173 206a 736f    # Write as jso
+00040680: 6e0a 0a20 2020 2020 2020 2020 2020 2023  n..            #
+00040690: 2057 6f72 6b61 726f 756e 6420 746f 2067   Workaround to g
+000406a0: 6574 2061 7363 6969 2066 6f72 6d61 7474  et ascii formatt
+000406b0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+000406c0: 2370 6420 3d20 7365 6c66 2e74 6f5f 7061  #pd = self.to_pa
+000406d0: 6e64 6173 2829 0a20 2020 2020 2020 2020  ndas().         
+000406e0: 2020 206e 6577 203d 2047 5461 626c 6528     new = GTable(
+000406f0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00040700: 7220 6320 696e 2073 656c 662e 636f 6c6e  r c in self.coln
+00040710: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+00040720: 2020 2020 2020 6e65 775b 635d 203d 2073        new[c] = s
+00040730: 656c 665b 635d 0a0a 2020 2020 2020 2020  elf[c]..        
+00040740: 2020 2020 6966 2027 616c 6164 696e 2720      if 'aladin' 
+00040750: 696e 2073 656c 662e 636f 6c6e 616d 6573  in self.colnames
+00040760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040770: 2020 7064 203d 2047 5461 626c 6528 6e65    pd = GTable(ne
+00040780: 7729 2e74 6f5f 7061 6e64 6173 2829 0a20  w).to_pandas(). 
+00040790: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000407a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000407b0: 206e 6577 2e77 7269 7465 2827 2f74 6d70   new.write('/tmp
+000407c0: 2f74 6162 6c65 2e63 7376 272c 2066 6f72  /table.csv', for
+000407d0: 6d61 743d 2763 7376 272c 206f 7665 7277  mat='csv', overw
+000407e0: 7269 7465 3d54 7275 6529 0a20 2020 2020  rite=True).     
+000407f0: 2020 2020 2020 2020 2020 2070 6420 3d20             pd = 
+00040800: 4754 6162 6c65 2e67 7265 6164 2827 2f74  GTable.gread('/t
+00040810: 6d70 2f74 6162 6c65 2e63 7376 2729 2e74  mp/table.csv').t
+00040820: 6f5f 7061 6e64 6173 2829 0a0a 2020 2020  o_pandas()..    
+00040830: 2020 2020 2020 2020 2320 5265 666f 726d          # Reform
+00040840: 6174 2074 6f20 6a73 6f6e 0a20 2020 2020  at to json.     
+00040850: 2020 2020 2020 206a 736f 6e5f 6461 7461         json_data
+00040860: 203d 2027 2020 2020 2020 2020 2720 2b20   = '        ' + 
+00040870: 7064 2e74 6f5f 6a73 6f6e 286f 7269 656e  pd.to_json(orien
+00040880: 743d 2776 616c 7565 7327 292e 7265 706c  t='values').repl
+00040890: 6163 6528 275d 2c5b 272c 2027 5c6e 2020  ace('],[', '\n  
+000408a0: 2020 5d78 7878 7878 785c 6e20 2020 205b    ]xxxxxx\n    [
+000408b0: 5c6e 2020 2020 2020 2020 2729 2e72 6570  \n        ').rep
+000408c0: 6c61 6365 2827 2c20 272c 2027 7863 6f6d  lace(', ', 'xcom
+000408d0: 6d61 7370 6163 6578 2729 2e72 6570 6c61  maspacex').repla
+000408e0: 6365 2827 2c27 2c20 272c 5c6e 2020 2020  ce(',', ',\n    
+000408f0: 2020 2020 2729 2e72 6570 6c61 6365 2827      ').replace('
+00040900: 7878 7878 7878 272c 2027 2c27 292e 7265  xxxxxx', ',').re
+00040910: 706c 6163 6528 2778 636f 6d6d 6173 7061  place('xcommaspa
+00040920: 6365 7827 2c20 272c 2027 290a 2020 2020  cex', ', ').    
+00040930: 2020 2020 2020 2020 6a73 6f6e 5f73 7472          json_str
+00040940: 203d 2022 2222 7b7b 0a20 2022 6461 7461   = """{{.  "data
+00040950: 223a 0a7b 307d 0a0a 7d7d 0a22 2222 2e66  ":.{0}..}}.""".f
+00040960: 6f72 6d61 7428 6a73 6f6e 5f64 6174 612e  ormat(json_data.
+00040970: 7265 706c 6163 6528 275c 5c22 2227 2c20  replace('\\""', 
+00040980: 2722 2729 290a 0a20 2020 2020 2020 2020  '"'))..         
+00040990: 2020 2066 7020 3d20 6f70 656e 286f 7574     fp = open(out
+000409a0: 7075 742e 7265 706c 6163 6528 272e 6874  put.replace('.ht
+000409b0: 6d6c 272c 2027 2e6a 736f 6e27 292c 2027  ml', '.json'), '
+000409c0: 7727 290a 2020 2020 2020 2020 2020 2020  w').            
+000409d0: 6670 2e77 7269 7465 286a 736f 6e5f 7374  fp.write(json_st
+000409e0: 7229 0a20 2020 2020 2020 2020 2020 2066  r).            f
+000409f0: 702e 636c 6f73 6528 290a 0a20 2020 2020  p.close()..     
+00040a00: 2020 2020 2020 2023 2045 6469 7420 4854         # Edit HT
+00040a10: 4d4c 2066 696c 650a 2020 2020 2020 2020  ML file.        
+00040a20: 2020 2020 6c69 6e65 7320 3d20 6f70 656e      lines = open
+00040a30: 286f 7574 7075 7429 2e72 6561 646c 696e  (output).readlin
+00040a40: 6573 2829 0a0a 2020 2020 2020 2020 2020  es()..          
+00040a50: 2020 2320 4164 6420 616a 6178 2063 616c    # Add ajax cal
+00040a60: 6c20 746f 2044 6174 6154 6162 6c65 0a20  l to DataTable. 
+00040a70: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00040a80: 6c2c 206c 696e 6520 696e 2065 6e75 6d65  l, line in enume
+00040a90: 7261 7465 286c 696e 6573 293a 0a20 2020  rate(lines):.   
+00040aa0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00040ab0: 2770 6167 654c 656e 6774 6827 2069 6e20  'pageLength' in 
+00040ac0: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
+00040ad0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00040ae0: 0a20 2020 2020 2020 2020 2020 2061 6a61  .            aja
+00040af0: 785f 6361 6c6c 203d 2027 7b73 7061 6365  x_call = '{space
+00040b00: 727d 2261 6a61 7822 3a20 227b 6a73 6f6e  r}"ajax": "{json
+00040b10: 7d22 2c5c 6e7b 7370 6163 6572 7d22 6465  }",\n{spacer}"de
+00040b20: 6665 7252 656e 6465 7222 3a20 7472 7565  ferRender": true
+00040b30: 2c5c 6e27 2e66 6f72 6d61 7428 7370 6163  ,\n'.format(spac
+00040b40: 6572 3d27 2027 2a38 2c20 6a73 6f6e 3d6f  er=' '*8, json=o
+00040b50: 7574 7075 742e 7265 706c 6163 6528 272e  utput.replace('.
+00040b60: 6874 6d6c 272c 2027 2e6a 736f 6e27 2929  html', '.json'))
+00040b70: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+00040b80: 6573 2e69 6e73 6572 7428 696c 2b31 2c20  es.insert(il+1, 
+00040b90: 616a 6178 5f63 616c 6c29 0a0a 2020 2020  ajax_call)..    
+00040ba0: 2020 2020 2020 2020 2320 5374 7269 7020          # Strip 
+00040bb0: 6f75 7420 7461 626c 6520 626f 6479 0a20  out table body. 
+00040bc0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00040bd0: 6865 6164 2c20 6c69 6e65 2069 6e20 656e  head, line in en
+00040be0: 756d 6572 6174 6528 6c69 6e65 7329 3a0a  umerate(lines):.
+00040bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040c00: 6966 2027 3c2f 7468 6561 643e 2720 696e  if '</thead>' in
+00040c10: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
+00040c20: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00040c30: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00040c40: 7220 6974 6169 6c2c 206c 696e 6520 696e  r itail, line in
+00040c50: 2065 6e75 6d65 7261 7465 286c 696e 6573   enumerate(lines
+00040c60: 5b3a 3a2d 315d 293a 0a20 2020 2020 2020  [::-1]):.       
+00040c70: 2020 2020 2020 2020 2069 6620 273c 2f74           if '</t
+00040c80: 723e 2720 696e 206c 696e 653a 0a20 2020  r>' in line:.   
+00040c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ca0: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+00040cb0: 2020 2020 6670 203d 206f 7065 6e28 6f75      fp = open(ou
+00040cc0: 7470 7574 2c20 2777 2729 0a20 2020 2020  tput, 'w').     
+00040cd0: 2020 2020 2020 2066 702e 7772 6974 656c         fp.writel
+00040ce0: 696e 6573 286c 696e 6573 5b3a 6968 6561  ines(lines[:ihea
+00040cf0: 642b 315d 290a 2020 2020 2020 2020 2020  d+1]).          
+00040d00: 2020 6670 2e77 7269 7465 6c69 6e65 7328    fp.writelines(
+00040d10: 6c69 6e65 735b 2d69 7461 696c 3a5d 290a  lines[-itail:]).
+00040d20: 2020 2020 2020 2020 2020 2020 6670 2e63              fp.c
+00040d30: 6c6f 7365 2829 0a0a 0a64 6566 2063 6f6c  lose()...def col
+00040d40: 756d 6e5f 7374 7269 6e67 5f6f 7065 7261  umn_string_opera
+00040d50: 7469 6f6e 2863 6f6c 2c20 7465 7374 2c20  tion(col, test, 
+00040d60: 6d65 7468 6f64 3d27 636f 6e74 6169 6e73  method='contains
+00040d70: 272c 206c 6f67 6963 616c 3d27 6f72 2729  ', logical='or')
+00040d80: 3a0a 2020 2020 2222 220a 2020 2020 416e  :.    """.    An
+00040d90: 616c 6f67 6f75 7320 746f 2060 6073 7472  alogous to ``str
+00040da0: 2e63 6f6e 7461 696e 7360 6020 6275 7420  .contains`` but 
+00040db0: 666f 7220 7461 626c 6520 636f 6c75 6d6e  for table column
+00040dc0: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00040dd0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00040de0: 0a20 2020 2063 6f6c 203a 2069 7465 7261  .    col : itera
+00040df0: 626c 6520 6c69 7374 206f 6620 7374 7269  ble list of stri
+00040e00: 6e67 730a 2020 2020 2020 2020 4c69 7374  ngs.        List
+00040e10: 206f 6620 7374 7269 6e67 7320 746f 2074   of strings to t
+00040e20: 6573 742e 2020 416e 7974 6869 6e67 2069  est.  Anything i
+00040e30: 7465 7261 626c 652c 2065 2e67 2e2c 206c  terable, e.g., l
+00040e40: 6973 7420 6f72 200a 2020 2020 2020 2020  ist or .        
+00040e50: 607e 6173 7472 6f70 792e 7461 626c 652e  `~astropy.table.
+00040e60: 636f 6c75 6d6e 2e43 6f6c 756d 6e60 2e0a  column.Column`..
+00040e70: 0a20 2020 2074 6573 7420 3a20 7374 722c  .    test : str,
+00040e80: 206c 6973 7420 6f66 2073 7472 696e 6773   list of strings
+00040e90: 2c20 4e6f 6e65 2c20 6f72 2073 6c69 6365  , None, or slice
+00040ea0: 0a0a 2020 2020 2020 2020 4966 2060 6074  ..        If ``t
+00040eb0: 6573 7460 6020 6973 2061 2073 7472 696e  est`` is a strin
+00040ec0: 672c 206f 7220 6c69 7374 206f 6620 7374  g, or list of st
+00040ed0: 7269 6e67 732c 2074 6865 6e20 7275 6e20  rings, then run 
+00040ee0: 7468 6520 7374 7269 6e67 0a20 2020 2020  the string.     
+00040ef0: 2020 2060 606d 6574 686f 6460 6020 6f6e     ``method`` on
+00040f00: 2065 6163 6820 656e 7472 7920 6f66 2060   each entry of `
+00040f10: 6063 6f6c 6060 2077 6974 6820 6060 7465  `col`` with ``te
+00040f20: 7374 6060 2061 7320 7468 6520 6172 6775  st`` as the argu
+00040f30: 6d65 6e74 206f 720a 2020 2020 2020 2020  ment or.        
+00040f40: 6561 6368 2065 6c65 6d65 6e74 206f 6620  each element of 
+00040f50: 7468 6520 6060 7465 7374 6060 206c 6973  the ``test`` lis
+00040f60: 7420 6173 2061 7267 756d 656e 7473 2e0a  t as arguments..
+00040f70: 0a20 2020 2020 2020 2049 6620 6060 7465  .        If ``te
+00040f80: 7374 6060 2069 7320 4e6f 6e65 2c20 7275  st`` is None, ru
+00040f90: 6e20 606d 6574 686f 6460 206f 6e20 6561  n `method` on ea
+00040fa0: 6368 2065 6e74 7279 2077 6974 6820 6e6f  ch entry with no
+00040fb0: 2061 7267 756d 656e 7473 2c20 0a20 2020   arguments, .   
+00040fc0: 2020 2020 2065 2e67 2e2c 2027 7570 7065       e.g., 'uppe
+00040fd0: 7227 2e0a 0a20 2020 2020 2020 2049 6620  r'...        If 
+00040fe0: 6060 7465 7374 6060 2069 7320 6120 6060  ``test`` is a ``
+00040ff0: 736c 6963 6560 602c 2072 6574 7572 6e20  slice``, return 
+00041000: 736c 6963 6564 2073 7472 696e 6773 2066  sliced strings f
+00041010: 6f72 2065 6163 6820 656e 7472 792e 0a0a  or each entry...
+00041020: 2020 2020 6d65 7468 6f64 203a 2073 7472      method : str
+00041030: 0a20 2020 2020 2020 2053 7472 696e 6720  .        String 
+00041040: 6d65 7468 6f64 2074 6f20 6170 706c 7920  method to apply 
+00041050: 746f 2065 6163 6820 656e 7472 7920 6f66  to each entry of
+00041060: 2060 6063 6f6c 6060 2e20 2045 2e67 2e2c   ``col``.  E.g.,
+00041070: 2027 636f 6e74 6169 6e73 272c 0a20 2020   'contains',.   
+00041080: 2020 2020 2027 7374 6172 7473 7769 7468       'startswith
+00041090: 272c 2027 656e 6473 7769 7468 272c 2027  ', 'endswith', '
+000410a0: 696e 6465 7827 2e0a 0a20 2020 206c 6f67  index'...    log
+000410b0: 6963 616c 203a 205b 276f 7227 2c27 616e  ical : ['or','an
+000410c0: 6427 2c27 6e6f 7427 5d0a 2020 2020 2020  d','not'].      
+000410d0: 2020 4c6f 6769 6361 6c20 7465 7374 2074    Logical test t
+000410e0: 6f20 7573 6520 7768 656e 2060 6074 6573  o use when ``tes
+000410f0: 7460 6020 6973 2061 206c 6973 7420 6f66  t`` is a list of
+00041100: 2073 7472 696e 6773 2e20 2046 6f72 2065   strings.  For e
+00041110: 7861 6d70 6c65 2c0a 2020 2020 2020 2020  xample,.        
+00041120: 6966 2079 6f75 2077 616e 7420 746f 2074  if you want to t
+00041130: 6573 7420 6966 2074 6865 2063 6f6c 756d  est if the colum
+00041140: 6e20 6861 7320 7661 6c75 6573 2074 6861  n has values tha
+00041150: 7420 6d61 7463 6820 6569 7468 6572 0a20  t match either. 
+00041160: 2020 2020 2020 2027 7661 6c75 6531 2720         'value1' 
+00041170: 6f72 2027 7661 6c75 6532 272c 2074 6865  or 'value2', the
+00041180: 6e20 7275 6e20 7769 7468 0a0a 2020 2020  n run with..    
+00041190: 2020 2020 2020 2020 3e3e 3e20 7265 7320          >>> res 
+000411a0: 3d20 636f 6c75 6d6e 5f74 6f5f 7374 7269  = column_to_stri
+000411b0: 6e67 5f6f 7065 7261 7469 6f6e 2863 6f6c  ng_operation(col
+000411c0: 2c20 5b27 7661 6c75 6531 272c 2776 616c  , ['value1','val
+000411d0: 7565 3227 5d2c 206d 6574 686f 643d 2763  ue2'], method='c
+000411e0: 6f6e 7461 696e 7327 2c20 6c6f 6769 6361  ontains', logica
+000411f0: 6c3d 276f 7227 290a 0a20 2020 2052 6574  l='or')..    Ret
+00041200: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00041210: 0a20 2020 2072 6573 756c 7420 3a20 6c69  .    result : li
+00041220: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+00041230: 6f66 2069 7465 7261 7465 6420 7265 7375  of iterated resu
+00041240: 6c74 7320 6f6e 2074 6865 2065 6e74 7269  lts on the entri
+00041250: 6573 206f 6620 6060 636f 6c60 602c 2065  es of ``col``, e
+00041260: 2e67 2e2c 206c 6973 7420 6f66 200a 2020  .g., list of .  
+00041270: 2020 2020 2020 6060 626f 6f6c 6060 206f        ``bool`` o
+00041280: 7220 6060 7374 7269 6e67 6060 2e0a 0a20  r ``string``... 
+00041290: 2020 2022 2222 0a20 2020 2069 6620 6973     """.    if is
+000412a0: 696e 7374 616e 6365 2874 6573 742c 206c  instance(test, l
+000412b0: 6973 7429 3a0a 2020 2020 2020 2020 7465  ist):.        te
+000412c0: 7374 5f6c 6973 7420 3d20 7465 7374 0a20  st_list = test. 
+000412d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000412e0: 2074 6573 745f 6c69 7374 203d 205b 7465   test_list = [te
+000412f0: 7374 5d0a 0a20 2020 206f 7574 5f74 6573  st]..    out_tes
+00041300: 7420 3d20 5b5d 0a0a 2020 2020 666f 7220  t = []..    for 
+00041310: 692c 2063 5f69 2069 6e20 656e 756d 6572  i, c_i in enumer
+00041320: 6174 6528 636f 6c29 3a0a 2020 2020 2020  ate(col):.      
+00041330: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00041340: 7465 7374 2c20 736c 6963 6529 3a0a 2020  test, slice):.  
+00041350: 2020 2020 2020 2020 2020 6f75 745f 7465            out_te
+00041360: 7374 2e61 7070 656e 6428 635f 695b 7465  st.append(c_i[te
+00041370: 7374 5d29 0a20 2020 2020 2020 2020 2020  st]).           
+00041380: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+00041390: 2020 2066 756e 6320 3d20 6765 7461 7474     func = getatt
+000413a0: 7228 635f 692c 206d 6574 686f 6429 0a20  r(c_i, method). 
+000413b0: 2020 2020 2020 2069 6620 7465 7374 2069         if test i
+000413c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000413d0: 2020 2020 6f75 745f 7465 7374 2e61 7070      out_test.app
+000413e0: 656e 6428 6675 6e63 2829 290a 2020 2020  end(func()).    
+000413f0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00041400: 0a0a 2020 2020 2020 2020 6c69 7374 5f69  ..        list_i
+00041410: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+00041420: 7220 745f 6920 696e 2074 6573 745f 6c69  r t_i in test_li
+00041430: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00041440: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00041450: 2020 2020 206c 6973 745f 692e 6170 7065       list_i.appe
+00041460: 6e64 2866 756e 6328 745f 6929 290a 2020  nd(func(t_i)).  
+00041470: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00041480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00041490: 2020 6c69 7374 5f69 2e61 7070 656e 6428    list_i.append(
+000414a0: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
+000414b0: 6f75 745f 7465 7374 2e61 7070 656e 6428  out_test.append(
+000414c0: 6c69 7374 5f69 290a 0a20 2020 2061 7272  list_i)..    arr
+000414d0: 203d 206e 702e 6172 7261 7928 6f75 745f   = np.array(out_
+000414e0: 7465 7374 290a 2020 2020 7368 203d 2061  test).    sh = a
+000414f0: 7272 2e73 6861 7065 0a0a 2020 2020 6966  rr.shape..    if
+00041500: 206c 6f67 6963 616c 2069 7320 4e6f 6e65   logical is None
+00041510: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00041520: 206e 702e 7371 7565 657a 6528 6172 7229   np.squeeze(arr)
+00041530: 0a20 2020 2065 6c69 6620 6c6f 6769 6361  .    elif logica
+00041540: 6c2e 7570 7065 7228 2920 3d3d 2027 414e  l.upper() == 'AN
+00041550: 4427 3a0a 2020 2020 2020 2020 7265 7475  D':.        retu
+00041560: 726e 206e 702e 7375 6d28 6172 722c 2061  rn np.sum(arr, a
+00041570: 7869 733d 3129 203e 3d20 7368 5b31 5d0a  xis=1) >= sh[1].
+00041580: 2020 2020 656c 6966 206c 6f67 6963 616c      elif logical
+00041590: 2e75 7070 6572 2829 203d 3d20 274e 4f54  .upper() == 'NOT
+000415a0: 273a 0a20 2020 2020 2020 2072 6574 7572  ':.        retur
+000415b0: 6e20 6e70 2e73 756d 2861 7272 2c20 6178  n np.sum(arr, ax
+000415c0: 6973 3d31 2920 3d3d 2030 0a20 2020 2065  is=1) == 0.    e
+000415d0: 6c73 653a 2020 2320 4f52 0a20 2020 2020  lse:  # OR.     
+000415e0: 2020 2072 6574 7572 6e20 6e70 2e73 756d     return np.sum
+000415f0: 2861 7272 2c20 6178 6973 3d31 2920 3e20  (arr, axis=1) > 
+00041600: 300a 0a0a 6465 6620 636f 6c75 6d6e 5f76  0...def column_v
+00041610: 616c 7565 735f 696e 5f6c 6973 7428 636f  alues_in_list(co
+00041620: 6c2c 2074 6573 745f 6c69 7374 293a 0a20  l, test_list):. 
+00041630: 2020 2022 2222 5465 7374 2069 6620 636f     """Test if co
+00041640: 6c75 6d6e 2065 6c65 6d65 6e74 7320 2269  lumn elements "i
+00041650: 6e22 2061 6e20 6974 6572 6162 6c65 2028  n" an iterable (
+00041660: 652e 672e 2c20 6120 6c69 7374 206f 6620  e.g., a list of 
+00041670: 7374 7269 6e67 7329 0a0a 2020 2020 5061  strings)..    Pa
+00041680: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00041690: 2d2d 2d2d 2d2d 2d0a 2020 2020 636f 6c20  -------.    col 
+000416a0: 3a20 6061 7374 726f 7079 2e74 6162 6c65  : `astropy.table
+000416b0: 2e43 6f6c 756d 6e60 206f 7220 6f74 6865  .Column` or othe
+000416c0: 7220 6974 6572 6162 6c65 0a20 2020 2020  r iterable.     
+000416d0: 2020 2047 726f 7570 206f 6620 656e 7472     Group of entr
+000416e0: 6965 7320 746f 2074 6573 740a 0a20 2020  ies to test..   
+000416f0: 2074 6573 745f 6c69 7374 203a 2069 7465   test_list : ite
+00041700: 7261 626c 650a 2020 2020 2020 2020 4c69  rable.        Li
+00041710: 7374 206f 6620 7661 6c75 6573 2074 6f20  st of values to 
+00041720: 7365 6172 6368 0a0a 2020 2020 5265 7475  search..    Retu
+00041730: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00041740: 2020 2020 7465 7374 203a 2062 6f6f 6c20      test : bool 
+00041750: 6172 7261 790a 2020 2020 2020 2020 5369  array.        Si
+00041760: 6d70 6c65 2074 6573 743a 0a20 2020 2020  mple test:.     
+00041770: 2020 2020 2020 203e 3e3e 205b 635f 6920         >>> [c_i 
+00041780: 696e 2074 6573 745f 6c69 7374 2066 6f72  in test_list for
+00041790: 2063 5f69 2069 6e20 636f 6c5d 0a20 2020   c_i in col].   
+000417a0: 2022 2222 0a20 2020 2074 6573 7420 3d20   """.    test = 
+000417b0: 6e70 2e61 7272 6179 285b 635f 6920 696e  np.array([c_i in
+000417c0: 2074 6573 745f 6c69 7374 2066 6f72 2063   test_list for c
+000417d0: 5f69 2069 6e20 636f 6c5d 290a 2020 2020  _i in col]).    
+000417e0: 7265 7475 726e 2074 6573 740a 0a0a 6465  return test...de
+000417f0: 6620 6669 6c6c 5f62 6574 7765 656e 5f73  f fill_between_s
+00041800: 7465 7073 2878 2c20 7930 2c20 7931 2c20  teps(x, y0, y1, 
+00041810: 6178 3d4e 6f6e 652c 202a 6172 6773 2c20  ax=None, *args, 
+00041820: 2a2a 6b77 6172 6773 293a 0a20 2020 2022  **kwargs):.    "
+00041830: 2222 0a20 2020 204d 616b 6520 6066 696c  "".    Make `fil
+00041840: 6c5f 6265 7477 6565 6e60 2077 6f72 6b20  l_between` work 
+00041850: 6c69 6b65 206c 696e 6573 7479 6c65 3d27  like linestyle='
+00041860: 7374 6570 732d 6d69 6427 2e0a 2020 2020  steps-mid'..    
+00041870: 2222 220a 2020 2020 696d 706f 7274 206d  """.    import m
+00041880: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
+00041890: 2061 7320 706c 740a 2020 2020 0a20 2020   as plt.    .   
+000418a0: 2073 6f20 3d20 6e70 2e61 7267 736f 7274   so = np.argsort
+000418b0: 2878 290a 2020 2020 6478 203d 206e 702e  (x).    dx = np.
+000418c0: 6469 6666 2878 5b73 6f5d 292f 322e 0a20  diff(x[so])/2.. 
+000418d0: 2020 206d 6964 203d 2078 5b73 6f5d 5b3a     mid = x[so][:
+000418e0: 2d31 5d20 2b20 6478 0a20 2020 200a 2020  -1] + dx.    .  
+000418f0: 2020 7866 756c 6c20 3d20 6e70 2e68 7374    xfull = np.hst
+00041900: 6163 6b28 5b78 5b73 6f5d 5b30 5d2d 6478  ack([x[so][0]-dx
+00041910: 5b30 5d2c 206d 6964 2c20 6d69 642b 6478  [0], mid, mid+dx
+00041920: 2a32 2f31 2e65 362c 2078 5b73 6f5d 5b2d  *2/1.e6, x[so][-
+00041930: 315d 2b64 785b 2d31 5d5d 290a 2020 2020  1]+dx[-1]]).    
+00041940: 7930 6675 6c6c 203d 206e 702e 6873 7461  y0full = np.hsta
+00041950: 636b 285b 7930 5b30 5d2c 2079 305b 3a2d  ck([y0[0], y0[:-
+00041960: 315d 2c20 7930 5b31 3a5d 2c20 7930 5b2d  1], y0[1:], y0[-
+00041970: 315d 5d29 0a20 2020 2079 3166 756c 6c20  1]]).    y1full 
+00041980: 3d20 6e70 2e68 7374 6163 6b28 5b79 315b  = np.hstack([y1[
+00041990: 305d 2c20 7931 5b3a 2d31 5d2c 2079 315b  0], y1[:-1], y1[
+000419a0: 313a 5d2c 2079 315b 2d31 5d5d 290a 2020  1:], y1[-1]]).  
+000419b0: 2020 0a20 2020 2023 2078 6675 6c6c 203d    .    # xfull =
+000419c0: 206e 702e 6170 7065 6e64 286e 702e 6170   np.append(np.ap
+000419d0: 7065 6e64 2878 2c20 6d69 6429 2c20 6d69  pend(x, mid), mi
+000419e0: 642b 6e70 2e64 6966 6628 785b 736f 5d29  d+np.diff(x[so])
+000419f0: 2f31 2e65 3629 0a20 2020 2023 2079 3066  /1.e6).    # y0f
+00041a00: 756c 6c20 3d20 6e70 2e61 7070 656e 6428  ull = np.append(
+00041a10: 6e70 2e61 7070 656e 6428 7930 2c20 7930  np.append(y0, y0
+00041a20: 5b3a 2d31 5d29 2c20 7930 5b31 3a5d 290a  [:-1]), y0[1:]).
+00041a30: 2020 2020 2320 7931 6675 6c6c 203d 206e      # y1full = n
+00041a40: 702e 6170 7065 6e64 286e 702e 6170 7065  p.append(np.appe
+00041a50: 6e64 2879 312c 2079 315b 3a2d 315d 292c  nd(y1, y1[:-1]),
+00041a60: 2079 315b 313a 5d29 0a0a 2020 2020 736f   y1[1:])..    so
+00041a70: 203d 206e 702e 6172 6773 6f72 7428 7866   = np.argsort(xf
+00041a80: 756c 6c29 0a20 2020 2069 6620 6178 2069  ull).    if ax i
+00041a90: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00041aa0: 6178 203d 2070 6c74 2e67 6361 2829 0a0a  ax = plt.gca()..
+00041ab0: 2020 2020 6178 2e66 696c 6c5f 6265 7477      ax.fill_betw
+00041ac0: 6565 6e28 7866 756c 6c5b 736f 5d2c 2079  een(xfull[so], y
+00041ad0: 3066 756c 6c5b 736f 5d2c 2079 3166 756c  0full[so], y1ful
+00041ae0: 6c5b 736f 5d2c 202a 6172 6773 2c20 2a2a  l[so], *args, **
+00041af0: 6b77 6172 6773 290a 0a0a 6465 6620 6669  kwargs)...def fi
+00041b00: 6c6c 5f6d 6173 6b65 645f 636f 7661 7228  ll_masked_covar(
+00041b10: 636f 7661 722c 206d 6173 6b29 3a0a 2020  covar, mask):.  
+00041b20: 2020 2222 2246 696c 6c20 6120 636f 7661    """Fill a cova
+00041b30: 7269 616e 6365 206d 6174 7269 7820 696e  riance matrix in
+00041b40: 2061 206c 6172 6765 7220 6172 7261 7920   a larger array 
+00041b50: 7468 6174 2068 6164 206d 6173 6b65 6420  that had masked 
+00041b60: 7661 6c75 6573 0a0a 2020 2020 5061 7261  values..    Para
+00041b70: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00041b80: 2d2d 2d2d 2d0a 2020 2020 636f 7661 7220  -----.    covar 
+00041b90: 3a20 6028 4d2c 4d29 6020 7371 7561 7265  : `(M,M)` square
+00041ba0: 2060 7e6e 702e 6e64 6172 7261 7960 0a20   `~np.ndarray`. 
+00041bb0: 2020 2020 2020 204d 6173 6b65 6420 636f         Masked co
+00041bc0: 7661 7269 616e 6365 2061 7272 6179 2e0a  variance array..
+00041bd0: 0a20 2020 206d 6173 6b20 3a20 626f 6f6c  .    mask : bool
+00041be0: 206d 6173 6b2c 2060 4e3e 4d60 0a20 2020   mask, `N>M`.   
+00041bf0: 2020 2020 2054 6865 206f 7269 6769 6e61       The origina
+00041c00: 6c20 6d61 736b 2e0a 0a20 2020 2052 6574  l mask...    Ret
+00041c10: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00041c20: 0a20 2020 2063 6f76 6172 5f66 756c 6c20  .    covar_full 
+00041c30: 3a20 607e 6e70 2e6e 6461 7272 6179 600a  : `~np.ndarray`.
+00041c40: 2020 2020 2020 2020 4675 6c6c 2063 6f76          Full cov
+00041c50: 6172 6961 6e63 6520 6172 7261 7920 7769  ariance array wi
+00041c60: 7468 2064 696d 656e 7369 6f6e 7320 6028  th dimensions `(
+00041c70: 4e2c 4e29 602e 0a0a 2020 2020 2222 220a  N,N)`...    """.
+00041c80: 2020 2020 4e20 3d20 6d61 736b 2e73 6861      N = mask.sha
+00041c90: 7065 5b30 5d0a 2020 2020 6964 7820 3d20  pe[0].    idx = 
+00041ca0: 6e70 2e61 7261 6e67 6528 4e29 5b6d 6173  np.arange(N)[mas
+00041cb0: 6b5d 0a20 2020 2063 6f76 6172 5f66 756c  k].    covar_ful
+00041cc0: 6c20 3d20 6e70 2e7a 6572 6f73 2828 4e2c  l = np.zeros((N,
+00041cd0: 204e 292c 2064 7479 7065 3d63 6f76 6172   N), dtype=covar
+00041ce0: 2e64 7479 7065 290a 2020 2020 666f 7220  .dtype).    for 
+00041cf0: 692c 2069 6920 696e 2065 6e75 6d65 7261  i, ii in enumera
+00041d00: 7465 2869 6478 293a 0a20 2020 2020 2020  te(idx):.       
+00041d10: 2066 6f72 206a 2c20 6a6a 2069 6e20 656e   for j, jj in en
+00041d20: 756d 6572 6174 6528 6964 7829 3a0a 2020  umerate(idx):.  
+00041d30: 2020 2020 2020 2020 2020 636f 7661 725f            covar_
+00041d40: 6675 6c6c 5b69 692c 206a 6a5d 203d 2063  full[ii, jj] = c
+00041d50: 6f76 6172 5b69 2c20 6a5d 0a0a 2020 2020  ovar[i, j]..    
+00041d60: 7265 7475 726e 2063 6f76 6172 5f66 756c  return covar_ful
+00041d70: 6c0a 0a0a 6465 6620 6c6f 675f 7363 616c  l...def log_scal
+00041d80: 655f 6473 3928 696d 2c20 6c65 7870 3d31  e_ds9(im, lexp=1
+00041d90: 2e65 3132 2c20 636d 6170 3d5b 372e 3937  .e12, cmap=[7.97
+00041da0: 3931 372c 2030 2e38 3738 3034 3933 5d2c  917, 0.8780493],
+00041db0: 2073 6361 6c65 3d5b 2d30 2e31 2c20 3130   scale=[-0.1, 10
+00041dc0: 5d29 3a0a 2020 2020 2222 220a 2020 2020  ]):.    """.    
+00041dd0: 5363 616c 6520 616e 2061 7272 6179 206c  Scale an array l
+00041de0: 696b 6520 6473 3920 6c6f 6720 7363 616c  ike ds9 log scal
+00041df0: 696e 670a 2020 2020 2222 220a 2020 2020  ing.    """.    
+00041e00: 696d 706f 7274 206e 756d 7079 2061 7320  import numpy as 
+00041e10: 6e70 0a0a 2020 2020 636f 6e74 7261 7374  np..    contrast
+00041e20: 2c20 6269 6173 203d 2063 6d61 700a 2020  , bias = cmap.  
+00041e30: 2020 636c 6970 203d 2028 6e70 2e63 6c69    clip = (np.cli
+00041e40: 7028 696d 2c20 7363 616c 655b 305d 2c20  p(im, scale[0], 
+00041e50: 7363 616c 655b 315d 292d 7363 616c 655b  scale[1])-scale[
+00041e60: 305d 292f 2873 6361 6c65 5b31 5d2d 7363  0])/(scale[1]-sc
+00041e70: 616c 655b 305d 290a 2020 2020 636c 6970  ale[0]).    clip
+00041e80: 5f6c 6f67 203d 206e 702e 636c 6970 2828  _log = np.clip((
+00041e90: 6e70 2e6c 6f67 3130 286c 6578 702a 636c  np.log10(lexp*cl
+00041ea0: 6970 2b31 292f 6e70 2e6c 6f67 3130 286c  ip+1)/np.log10(l
+00041eb0: 6578 7029 2d62 6961 7329 2a63 6f6e 7472  exp)-bias)*contr
+00041ec0: 6173 742b 302e 352c 2030 2c20 3129 0a0a  ast+0.5, 0, 1)..
+00041ed0: 2020 2020 7265 7475 726e 2063 6c69 705f      return clip_
+00041ee0: 6c6f 670a 0a0a 6465 6620 6d6f 6465 5f73  log...def mode_s
+00041ef0: 7461 7469 7374 6963 2864 6174 612c 2070  tatistic(data, p
+00041f00: 6572 6365 6e74 696c 6573 3d72 616e 6765  ercentiles=range
+00041f10: 2831 302c 2039 312c 2031 3029 293a 0a20  (10, 91, 10)):. 
+00041f20: 2020 2022 2222 0a20 2020 2047 6574 206d     """.    Get m
+00041f30: 6f64 616c 2076 616c 7565 206f 6620 6120  odal value of a 
+00041f40: 6469 7374 7269 6275 7469 6f6e 206f 6620  distribution of 
+00041f50: 6461 7461 2066 6f6c 6c6f 7769 6e67 2043  data following C
+00041f60: 6f6e 6e6f 7220 6574 2061 6c2e 2032 3031  onnor et al. 201
+00041f70: 370a 2020 2020 6874 7470 733a 2f2f 6172  7.    https://ar
+00041f80: 7869 762e 6f72 672f 7064 662f 3137 3039  xiv.org/pdf/1709
+00041f90: 2e30 3139 3235 2e70 6466 0a0a 2020 2020  .01925.pdf..    
+00041fa0: 4865 7265 2077 6520 6669 7420 6120 7370  Here we fit a sp
+00041fb0: 6c69 6e65 2074 6f20 7468 6520 6375 6d75  line to the cumu
+00041fc0: 6c61 7469 7665 2064 6973 7472 6962 7574  lative distribut
+00041fd0: 696f 6e20 6576 616c 7561 7465 6420 6174  ion evaluated at
+00041fe0: 206b 6e6f 7473 0a20 2020 2073 6574 2074   knots.    set t
+00041ff0: 6f20 7468 6520 6070 6572 6365 6e74 696c  o the `percentil
+00042000: 6573 6020 6f66 2074 6865 2064 6973 7472  es` of the distr
+00042010: 6962 7574 696f 6e20 746f 2069 6d70 726f  ibution to impro
+00042020: 7665 2073 6d6f 6f74 686e 6573 732e 0a20  ve smoothness.. 
+00042030: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
+00042040: 7363 6970 792e 696e 7465 7270 6f6c 6174  scipy.interpolat
+00042050: 6520 696d 706f 7274 2055 6e69 7661 7269  e import Univari
+00042060: 6174 6553 706c 696e 652c 204c 5351 556e  ateSpline, LSQUn
+00042070: 6976 6172 6961 7465 5370 6c69 6e65 0a0a  ivariateSpline..
+00042080: 2020 2020 736f 203d 206e 702e 6172 6773      so = np.args
+00042090: 6f72 7428 6461 7461 290a 2020 2020 6f72  ort(data).    or
+000420a0: 6465 7220 3d20 6e70 2e61 7261 6e67 6528  der = np.arange(
+000420b0: 6c65 6e28 6461 7461 2929 0a20 2020 2023  len(data)).    #
+000420c0: 7370 6c20 3d20 556e 6976 6172 6961 7465  spl = Univariate
+000420d0: 5370 6c69 6e65 2864 6174 615b 736f 5d2c  Spline(data[so],
+000420e0: 206f 7264 6572 290a 0a20 2020 206b 6e6f   order)..    kno
+000420f0: 7473 203d 206e 702e 7065 7263 656e 7469  ts = np.percenti
+00042100: 6c65 2864 6174 612c 2070 6572 6365 6e74  le(data, percent
+00042110: 696c 6573 290a 2020 2020 6478 203d 206e  iles).    dx = n
+00042120: 702e 6469 6666 286b 6e6f 7473 290a 2020  p.diff(knots).  
+00042130: 2020 6d61 736b 203d 2028 6461 7461 5b73    mask = (data[s
+00042140: 6f5d 203e 3d20 6b6e 6f74 735b 305d 2d64  o] >= knots[0]-d
+00042150: 785b 305d 2920 2620 2864 6174 615b 736f  x[0]) & (data[so
+00042160: 5d20 3c3d 206b 6e6f 7473 5b2d 315d 2b64  ] <= knots[-1]+d
+00042170: 785b 2d31 5d29 0a20 2020 2073 706c 203d  x[-1]).    spl =
+00042180: 204c 5351 556e 6976 6172 6961 7465 5370   LSQUnivariateSp
+00042190: 6c69 6e65 2864 6174 615b 736f 5d5b 6d61  line(data[so][ma
+000421a0: 736b 5d2c 206f 7264 6572 5b6d 6173 6b5d  sk], order[mask]
+000421b0: 2c20 6b6e 6f74 732c 2065 7874 3d27 7a65  , knots, ext='ze
+000421c0: 726f 7327 290a 0a20 2020 206d 6173 6b20  ros')..    mask 
+000421d0: 3d20 2864 6174 615b 736f 5d20 3e3d 206b  = (data[so] >= k
+000421e0: 6e6f 7473 5b30 5d29 2026 2028 6461 7461  nots[0]) & (data
+000421f0: 5b73 6f5d 203c 3d20 6b6e 6f74 735b 2d31  [so] <= knots[-1
+00042200: 5d29 0a20 2020 2069 7820 3d20 2873 706c  ]).    ix = (spl
+00042210: 2864 6174 615b 736f 5d2c 206e 753d 312c  (data[so], nu=1,
+00042220: 2065 7874 3d27 7a65 726f 7327 292a 6d61   ext='zeros')*ma
+00042230: 736b 292e 6172 676d 6178 2829 0a20 2020  sk).argmax().   
+00042240: 206d 6f64 6520 3d20 6461 7461 5b73 6f5d   mode = data[so]
+00042250: 5b69 785d 0a20 2020 2072 6574 7572 6e20  [ix].    return 
+00042260: 6d6f 6465 0a0a 0a64 6566 206d 616b 655f  mode...def make_
+00042270: 616c 665f 7465 6d70 6c61 7465 2829 3a0a  alf_template():.
+00042280: 2020 2020 2222 220a 2020 2020 4d61 6b65      """.    Make
+00042290: 2041 6c66 202b 2046 5350 5320 7465 6d70   Alf + FSPS temp
+000422a0: 6c61 7465 0a20 2020 2022 2222 0a20 2020  late.    """.   
+000422b0: 2069 6d70 6f72 7420 616c 662e 616c 660a   import alf.alf.
+000422c0: 2020 2020 696d 706f 7274 2066 7370 730a      import fsps.
+000422d0: 0a20 2020 2073 7370 203d 2061 6c66 2e61  .    ssp = alf.a
+000422e0: 6c66 2e41 6c66 2829 0a0a 2020 2020 7370  lf.Alf()..    sp
+000422f0: 203d 2066 7370 732e 5374 656c 6c61 7250   = fsps.StellarP
+00042300: 6f70 756c 6174 696f 6e28 7a63 6f6e 7469  opulation(zconti
+00042310: 6e75 6f75 733d 3129 0a20 2020 2073 702e  nuous=1).    sp.
+00042320: 7061 7261 6d73 5b27 6c6f 677a 736f 6c27  params['logzsol'
+00042330: 5d20 3d20 302e 320a 0a20 2020 2023 2041  ] = 0.2..    # A
+00042340: 6c66 0a20 2020 206d 203d 2073 7370 2e67  lf.    m = ssp.g
+00042350: 6574 5f6d 6f64 656c 2869 6e5f 706c 6163  et_model(in_plac
+00042360: 653d 4661 6c73 652c 206c 6f67 6167 653d  e=False, logage=
+00042370: 302e 3936 2c20 7a68 3d30 2e32 2c20 6d67  0.96, zh=0.2, mg
+00042380: 683d 302e 3229 0a0a 2020 2020 2320 4653  h=0.2)..    # FS
+00042390: 5053 0a20 2020 2077 2c20 7370 6563 203d  PS.    w, spec =
+000423a0: 2073 702e 6765 745f 7370 6563 7472 756d   sp.get_spectrum
+000423b0: 2874 6167 653d 3130 2a2a 302e 3936 2c20  (tage=10**0.96, 
+000423c0: 7065 7261 613d 5472 7565 290a 0a20 2020  peraa=True)..   
+000423d0: 2023 2062 6c75 650a 2020 2020 626c 7565   # blue.    blue
+000423e0: 5f6e 6f72 6d20 3d20 7370 6563 5b77 203e  _norm = spec[w >
+000423f0: 2033 3630 305d 5b30 5d20 2f20 6d5b 7373   3600][0] / m[ss
+00042400: 702e 7761 7665 203e 2033 3630 305d 5b30  p.wave > 3600][0
+00042410: 5d0a 2020 2020 7265 645f 6e6f 726d 203d  ].    red_norm =
+00042420: 2073 7065 635b 7720 3e20 312e 3765 345d   spec[w > 1.7e4]
+00042430: 5b30 5d20 2f20 6d5b 7373 702e 7761 7665  [0] / m[ssp.wave
+00042440: 203e 2031 2e37 6534 5d5b 305d 0a0a 2020   > 1.7e4][0]..  
+00042450: 2020 7465 6d70 6c78 203d 206e 702e 6873    templx = np.hs
+00042460: 7461 636b 285b 775b 7720 3c20 3336 3030  tack([w[w < 3600
+00042470: 5d2c 2073 7370 2e77 6176 655b 2873 7370  ], ssp.wave[(ssp
+00042480: 2e77 6176 6520 3e20 3336 3030 2920 2620  .wave > 3600) & 
+00042490: 2873 7370 2e77 6176 6520 3c20 312e 3765  (ssp.wave < 1.7e
+000424a0: 3429 5d2c 2077 5b77 203e 2031 2e37 6534  4)], w[w > 1.7e4
+000424b0: 5d5d 290a 2020 2020 7465 6d70 6c79 203d  ]]).    temply =
+000424c0: 206e 702e 6873 7461 636b 285b 7370 6563   np.hstack([spec
+000424d0: 5b77 203c 2033 3630 305d 2f62 6c75 655f  [w < 3600]/blue_
+000424e0: 6e6f 726d 2c20 6d5b 2873 7370 2e77 6176  norm, m[(ssp.wav
+000424f0: 6520 3e20 3336 3030 2920 2620 2873 7370  e > 3600) & (ssp
+00042500: 2e77 6176 6520 3c20 312e 3765 3429 5d2c  .wave < 1.7e4)],
+00042510: 2073 7065 635b 7720 3e20 312e 3765 345d   spec[w > 1.7e4]
+00042520: 2f72 6564 5f6e 6f72 6d5d 290a 0a20 2020  /red_norm])..   
+00042530: 206e 702e 7361 7665 7478 7428 2761 6c66   np.savetxt('alf
+00042540: 5f53 5350 2e64 6174 272c 206e 702e 6172  _SSP.dat', np.ar
+00042550: 7261 7928 5b74 656d 706c 782c 2074 656d  ray([templx, tem
+00042560: 706c 795d 292e 542c 2066 6d74 3d27 252e  ply]).T, fmt='%.
+00042570: 3565 272c 2068 6561 6465 723d 2777 6176  5e', header='wav
+00042580: 6520 666c 7578 5c6e 6c6f 6761 6765 203d  e flux\nlogage =
+00042590: 2030 2e39 365c 6e7a 683d 302e 325c 6e6d   0.96\nzh=0.2\nm
+000425a0: 6768 3d30 2e32 5c6e 6673 7073 3a20 7720  gh=0.2\nfsps: w 
+000425b0: 3c20 3336 3030 2c20 7720 3e20 312e 3765  < 3600, w > 1.7e
+000425c0: 3427 290a 0a0a 6465 6620 6361 7461 6c6f  4')...def catalo
+000425d0: 675f 6172 6561 2872 613d 5b5d 2c20 6465  g_area(ra=[], de
+000425e0: 633d 5b5d 2c20 6d61 6b65 5f70 6c6f 743d  c=[], make_plot=
+000425f0: 5472 7565 2c20 4e4d 4158 3d35 3030 302c  True, NMAX=5000,
+00042600: 2062 7566 663d 302e 382c 2076 6572 626f   buff=0.8, verbo
+00042610: 7365 3d54 7275 6529 3a0a 2020 2020 2222  se=True):.    ""
+00042620: 2243 6f6d 7075 7465 2074 6865 2073 7572  "Compute the sur
+00042630: 6661 6365 2061 7265 6120 6f66 2061 206c  face area of a l
+00042640: 6973 7420 6f66 2052 412f 4445 4320 636f  ist of RA/DEC co
+00042650: 6f72 6469 6e61 7465 730a 0a20 2020 2050  ordinates..    P
+00042660: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00042670: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 612c  --------.    ra,
+00042680: 2064 6563 203a 2060 7e6e 756d 7079 2e6e   dec : `~numpy.n
+00042690: 6461 7272 6179 600a 2020 2020 2020 2020  darray`.        
+000426a0: 5241 2061 6e64 2044 6563 2e20 636f 6f72  RA and Dec. coor
+000426b0: 6469 6e61 7465 7320 696e 2064 6563 696d  dinates in decim
+000426c0: 616c 2064 6567 7265 6573 0a0a 2020 2020  al degrees..    
+000426d0: 6d61 6b65 5f70 6c6f 7420 3a20 626f 6f6c  make_plot : bool
+000426e0: 0a20 2020 2020 2020 204d 616b 6520 6120  .        Make a 
+000426f0: 6669 6775 7265 2e0a 0a20 2020 204e 4d41  figure...    NMA
+00042700: 5820 3a20 696e 740a 2020 2020 2020 2020  X : int.        
+00042710: 4966 2074 6865 2063 6174 616c 6f67 2068  If the catalog h
+00042720: 6173 206d 6f72 6520 7468 656e 2060 4e4d  as more then `NM
+00042730: 4158 6020 656e 7472 6965 732c 2064 7261  AX` entries, dra
+00042740: 7720 604e 4d41 5860 2072 616e 646f 6d0a  w `NMAX` random.
+00042750: 2020 2020 2020 2020 7361 6d70 6c65 732e          samples.
+00042760: 0a0a 2020 2020 6275 6666 203a 2066 6c6f  ..    buff : flo
+00042770: 6174 0a20 2020 2020 2020 2042 7566 6665  at.        Buffe
+00042780: 7220 696e 2061 7263 6d69 6e20 746f 2061  r in arcmin to a
+00042790: 6464 2061 726f 756e 6420 6561 6368 2063  dd around each c
+000427a0: 6174 616c 6f67 2070 6f69 6e74 2e0a 0a0a  atalog point....
+000427b0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+000427c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6172 6561  -------.    area
+000427d0: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+000427e0: 2043 6f6d 7075 7465 6420 6361 7461 6c6f   Computed catalo
+000427f0: 6720 6172 6561 2069 6e20 7371 7561 7265  g area in square
+00042800: 2061 7263 6d69 6e75 7465 730a 0a20 2020   arcminutes..   
+00042810: 2066 6967 203a 2060 7e6d 6174 706c 6f74   fig : `~matplot
+00042820: 6c69 622e 6669 6775 7265 2e46 6967 7572  lib.figure.Figur
+00042830: 6560 0a20 2020 2020 2020 2046 6967 7572  e`.        Figur
+00042840: 6520 6f62 6a65 6374 2072 6574 7572 6e65  e object returne
+00042850: 6420 6966 2060 6d61 6b65 5f70 6c6f 743d  d if `make_plot=
+00042860: 3d54 7275 6560 2e0a 0a20 2020 2022 2222  =True`...    """
+00042870: 0a20 2020 2069 6d70 6f72 7420 6d61 7470  .    import matp
+00042880: 6c6f 746c 6962 2e70 7970 6c6f 7420 6173  lotlib.pyplot as
+00042890: 2070 6c74 0a20 2020 2066 726f 6d20 7368   plt.    from sh
+000428a0: 6170 656c 792e 6765 6f6d 6574 7279 2069  apely.geometry i
+000428b0: 6d70 6f72 7420 506f 6c79 676f 6e2c 2050  mport Polygon, P
+000428c0: 6f69 6e74 2c20 4d75 6c74 6950 6f6c 7967  oint, MultiPolyg
+000428d0: 6f6e 2c20 4d75 6c74 694c 696e 6553 7472  on, MultiLineStr
+000428e0: 696e 670a 2020 2020 6672 6f6d 2073 6369  ing.    from sci
+000428f0: 7079 2069 6d70 6f72 7420 7370 6174 6961  py import spatia
+00042900: 6c0a 0a20 2020 2070 6f69 6e74 7320 3d20  l..    points = 
+00042910: 6e70 2e61 7272 6179 285b 7261 2c20 6465  np.array([ra, de
+00042920: 635d 292a 312e 0a20 2020 2063 656e 7465  c])*1..    cente
+00042930: 7220 3d20 6e70 2e6d 6561 6e28 706f 696e  r = np.mean(poin
+00042940: 7473 2c20 6178 6973 3d31 290a 2020 2020  ts, axis=1).    
+00042950: 706f 696e 7473 203d 2028 706f 696e 7473  points = (points
+00042960: 2e54 202d 2063 656e 7465 7229 2a36 302e  .T - center)*60.
+00042970: 2020 2320 6172 636d 696e 0a20 2020 2070    # arcmin.    p
+00042980: 6f69 6e74 735b 3a2c 2030 5d20 2a3d 206e  oints[:, 0] *= n
+00042990: 702e 636f 7328 6365 6e74 6572 5b31 5d2f  p.cos(center[1]/
+000429a0: 3138 302a 6e70 2e70 6929 0a0a 2020 2020  180*np.pi)..    
+000429b0: 6875 6c6c 203d 2073 7061 7469 616c 2e43  hull = spatial.C
+000429c0: 6f6e 7665 7848 756c 6c28 706f 696e 7473  onvexHull(points
+000429d0: 290a 2020 2020 6564 6765 203d 2070 6f69  ).    edge = poi
+000429e0: 6e74 735b 6875 6c6c 2e76 6572 7469 6365  nts[hull.vertice
+000429f0: 732c 203a 5d0a 0a20 2020 2023 7062 7566  s, :]..    #pbuf
+00042a00: 6620 3d20 310a 0a20 2020 2069 6620 6c65  f = 1..    if le
+00042a10: 6e28 7261 2920 3e20 4e4d 4158 3a0a 2020  n(ra) > NMAX:.  
+00042a20: 2020 2020 2020 726e 645f 6964 7820 3d20        rnd_idx = 
+00042a30: 6e70 2e75 6e69 7175 6528 6e70 2e63 6173  np.unique(np.cas
+00042a40: 745b 696e 745d 286e 702e 726f 756e 6428  t[int](np.round(
+00042a50: 6e70 2e72 616e 646f 6d2e 7261 6e64 284e  np.random.rand(N
+00042a60: 4d41 5829 2a6c 656e 2872 6129 2929 290a  MAX)*len(ra)))).
+00042a70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00042a80: 2020 726e 645f 6964 7820 3d20 6e70 2e61    rnd_idx = np.a
+00042a90: 7261 6e67 6528 6c65 6e28 7261 2929 0a0a  range(len(ra))..
+00042aa0: 2020 2020 706f 6c79 203d 2050 6f69 6e74      poly = Point
+00042ab0: 2870 6f69 6e74 735b 726e 645f 6964 785b  (points[rnd_idx[
+00042ac0: 305d 2c20 3a5d 292e 6275 6666 6572 2862  0], :]).buffer(b
+00042ad0: 7566 6629 0a20 2020 2066 6f72 2069 2c20  uff).    for i, 
+00042ae0: 6978 2069 6e20 656e 756d 6572 6174 6528  ix in enumerate(
+00042af0: 726e 645f 6964 7829 3a0a 2020 2020 2020  rnd_idx):.      
+00042b00: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00042b10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00042b20: 4e4f 5f4e 4557 4c49 4e45 202b 2027 7b30  NO_NEWLINE + '{0
+00042b30: 7d20 7b31 7d27 2e66 6f72 6d61 7428 692c  } {1}'.format(i,
+00042b40: 2069 7829 290a 0a20 2020 2020 2020 2070   ix))..        p
+00042b50: 6f6c 7920 3d20 706f 6c79 2e75 6e69 6f6e  oly = poly.union
+00042b60: 2850 6f69 6e74 2870 6f69 6e74 735b 6978  (Point(points[ix
+00042b70: 2c20 3a5d 292e 6275 6666 6572 2862 7566  , :]).buffer(buf
+00042b80: 6629 290a 0a20 2020 2023 2046 696e 616c  f))..    # Final
+00042b90: 2028 6d75 6c74 6929 506f 6c79 676f 6e0a   (multi)Polygon.
+00042ba0: 2020 2020 706a 6f69 6e20 3d20 706f 6c79      pjoin = poly
+00042bb0: 2e62 7566 6665 7228 2d62 7566 6629 0a0a  .buffer(-buff)..
+00042bc0: 2020 2020 6966 206d 616b 655f 706c 6f74      if make_plot
+00042bd0: 3a0a 0a20 2020 2020 2020 2066 6967 203d  :..        fig =
+00042be0: 2070 6c74 2e66 6967 7572 6528 290a 2020   plt.figure().  
+00042bf0: 2020 2020 2020 6178 203d 2066 6967 2e61        ax = fig.a
+00042c00: 6464 5f73 7562 706c 6f74 2831 3131 290a  dd_subplot(111).
+00042c10: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00042c20: 7374 616e 6365 2870 6a6f 696e 2c20 4d75  stance(pjoin, Mu
+00042c30: 6c74 6950 6f6c 7967 6f6e 293a 0a20 2020  ltiPolygon):.   
+00042c40: 2020 2020 2020 2020 2066 6f72 2070 5f69           for p_i
+00042c50: 2069 6e20 706a 6f69 6e3a 0a20 2020 2020   in pjoin:.     
+00042c60: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00042c70: 696e 7374 616e 6365 2870 5f69 2e62 6f75  instance(p_i.bou
+00042c80: 6e64 6172 792c 204d 756c 7469 4c69 6e65  ndary, MultiLine
+00042c90: 5374 7269 6e67 293a 0a20 2020 2020 2020  String):.       
+00042ca0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00042cb0: 2073 2069 6e20 705f 692e 626f 756e 6461   s in p_i.bounda
+00042cc0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00042cd0: 2020 2020 2020 2020 2020 2020 7020 3d20              p = 
+00042ce0: 732e 7879 0a20 2020 2020 2020 2020 2020  s.xy.           
+00042cf0: 2020 2020 2020 2020 2020 2020 2061 782e               ax.
+00042d00: 706c 6f74 2870 5b30 5d2c 2070 5b31 5d29  plot(p[0], p[1])
+00042d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042d20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00042d30: 2020 2020 2020 2020 2020 2070 203d 2070             p = p
+00042d40: 5f69 2e62 6f75 6e64 6172 792e 7879 0a20  _i.boundary.xy. 
+00042d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042d60: 2020 2061 782e 706c 6f74 2870 5b30 5d2c     ax.plot(p[0],
+00042d70: 2070 5b31 5d29 0a20 2020 2020 2020 2065   p[1]).        e
+00042d80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00042d90: 2070 5f69 203d 2070 6a6f 696e 0a20 2020   p_i = pjoin.   
+00042da0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00042db0: 7374 616e 6365 2870 5f69 2e62 6f75 6e64  stance(p_i.bound
+00042dc0: 6172 792c 204d 756c 7469 4c69 6e65 5374  ary, MultiLineSt
+00042dd0: 7269 6e67 293a 0a20 2020 2020 2020 2020  ring):.         
+00042de0: 2020 2020 2020 2066 6f72 2073 2069 6e20         for s in 
+00042df0: 705f 692e 626f 756e 6461 7279 3a0a 2020  p_i.boundary:.  
+00042e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042e10: 2020 7020 3d20 732e 7879 0a20 2020 2020    p = s.xy.     
+00042e20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00042e30: 782e 706c 6f74 2870 5b30 5d2c 2070 5b31  x.plot(p[0], p[1
+00042e40: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
+00042e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00042e60: 2020 2020 2070 203d 2070 5f69 2e62 6f75       p = p_i.bou
+00042e70: 6e64 6172 792e 7879 0a20 2020 2020 2020  ndary.xy.       
+00042e80: 2020 2020 2020 2020 2061 782e 706c 6f74           ax.plot
+00042e90: 2870 5b30 5d2c 2070 5b31 5d29 0a0a 2020  (p[0], p[1])..  
+00042ea0: 2020 2020 2020 6178 2e73 6361 7474 6572        ax.scatter
+00042eb0: 2870 6f69 6e74 735b 726e 645f 6964 782c  (points[rnd_idx,
+00042ec0: 2030 5d2c 2070 6f69 6e74 735b 726e 645f   0], points[rnd_
+00042ed0: 6964 782c 2031 5d2c 2061 6c70 6861 3d30  idx, 1], alpha=0
+00042ee0: 2e31 2c20 6d61 726b 6572 3d27 2b27 290a  .1, marker='+').
+00042ef0: 0a20 2020 2020 2020 2061 782e 7365 745f  .        ax.set_
+00042f00: 786c 696d 2861 782e 6765 745f 786c 696d  xlim(ax.get_xlim
+00042f10: 2829 5b3a 3a2d 315d 290a 2020 2020 2020  ()[::-1]).      
+00042f20: 2020 6178 2e73 6574 5f78 6c61 6265 6c28    ax.set_xlabel(
+00042f30: 7227 245c 4465 6c74 6124 5241 2028 7b30  r'$\Delta$RA ({0
+00042f40: 3a2e 3566 7d29 272e 666f 726d 6174 2863  :.5f})'.format(c
+00042f50: 656e 7465 725b 305d 2929 0a20 2020 2020  enter[0])).     
+00042f60: 2020 2061 782e 7365 745f 796c 6162 656c     ax.set_ylabel
+00042f70: 2872 2724 5c44 656c 7461 2444 6563 2e20  (r'$\Delta$Dec. 
+00042f80: 287b 303a 2e35 667d 2927 2e66 6f72 6d61  ({0:.5f})'.forma
+00042f90: 7428 6365 6e74 6572 5b31 5d29 290a 2020  t(center[1])).  
+00042fa0: 2020 2020 2020 6178 2e73 6574 5f74 6974        ax.set_tit
+00042fb0: 6c65 2827 546f 7461 6c20 6172 6561 3a20  le('Total area: 
+00042fc0: 7b30 3a2e 3166 7d20 6172 636d 696e 245e  {0:.1f} arcmin$^
+00042fd0: 3224 272e 666f 726d 6174 2870 6a6f 696e  2$'.format(pjoin
+00042fe0: 2e61 7265 6129 290a 2020 2020 2020 2020  .area)).        
+00042ff0: 6178 2e67 7269 6428 290a 2020 2020 2020  ax.grid().      
+00043000: 2020 6669 672e 7469 6768 745f 6c61 796f    fig.tight_layo
+00043010: 7574 2870 6164 3d30 2e31 290a 0a20 2020  ut(pad=0.1)..   
+00043020: 2020 2020 2072 6574 7572 6e20 706a 6f69       return pjoi
+00043030: 6e2e 6172 6561 2c20 6669 670a 0a20 2020  n.area, fig..   
+00043040: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+00043050: 6574 7572 6e20 706a 6f69 6e2e 6172 6561  eturn pjoin.area
+00043060: 0a0a 0a64 6566 2066 6978 5f66 6c74 5f6e  ...def fix_flt_n
+00043070: 616e 2866 6c74 5f66 696c 652c 2062 6164  an(flt_file, bad
+00043080: 5f62 6974 3d34 3039 362c 2076 6572 626f  _bit=4096, verbo
+00043090: 7365 3d54 7275 6529 3a0a 2020 2020 2222  se=True):.    ""
+000430a0: 220a 2020 2020 4669 7820 4e61 4e20 7661  ".    Fix NaN va
+000430b0: 6c75 6573 2069 6e20 464c 5420 6669 6c65  lues in FLT file
+000430c0: 730a 2020 2020 2222 220a 2020 2020 696d  s.    """.    im
+000430d0: 203d 2070 7966 6974 732e 6f70 656e 2866   = pyfits.open(f
+000430e0: 6c74 5f66 696c 652c 206d 6f64 653d 2775  lt_file, mode='u
+000430f0: 7064 6174 6527 290a 2020 2020 666f 7220  pdate').    for 
+00043100: 6578 7420 696e 2072 616e 6765 2831 2c20  ext in range(1, 
+00043110: 3529 3a0a 2020 2020 2020 2020 6966 2028  5):.        if (
+00043120: 2753 4349 272c 2065 7874 2920 696e 2069  'SCI', ext) in i
+00043130: 6d3a 0a20 2020 2020 2020 2020 2020 206d  m:.            m
+00043140: 6173 6b20 3d20 7e6e 702e 6973 6669 6e69  ask = ~np.isfini
+00043150: 7465 2869 6d5b 2753 4349 272c 2065 7874  te(im['SCI', ext
+00043160: 5d2e 6461 7461 290a 2020 2020 2020 2020  ].data).        
+00043170: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+00043180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043190: 6c61 6265 6c20 3d20 2775 7469 6c73 2e66  label = 'utils.f
+000431a0: 6978 5f66 6c74 5f6e 616e 3a20 7b30 7d5b  ix_flt_nan: {0}[
+000431b0: 5343 492c 7b31 7d5d 204e 614e 5069 7865  SCI,{1}] NaNPixe
+000431c0: 6c73 3d7b 327d 270a 2020 2020 2020 2020  ls={2}'.        
+000431d0: 2020 2020 2020 2020 7072 696e 7428 6c61          print(la
+000431e0: 6265 6c2e 666f 726d 6174 2866 6c74 5f66  bel.format(flt_f
+000431f0: 696c 652c 2065 7874 2c20 6d61 736b 2e73  ile, ext, mask.s
+00043200: 756d 2829 2929 0a0a 2020 2020 2020 2020  um()))..        
+00043210: 2020 2020 6966 206d 6173 6b2e 7375 6d28      if mask.sum(
+00043220: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00043230: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00043240: 0a0a 2020 2020 2020 2020 2020 2020 696d  ..            im
+00043250: 5b27 5343 4927 2c20 6578 745d 2e64 6174  ['SCI', ext].dat
+00043260: 615b 6d61 736b 5d20 3d20 300a 2020 2020  a[mask] = 0.    
+00043270: 2020 2020 2020 2020 696d 5b27 4451 272c          im['DQ',
+00043280: 2065 7874 5d2e 6461 7461 5b6d 6173 6b5d   ext].data[mask]
+00043290: 207c 3d20 6261 645f 6269 740a 0a20 2020   |= bad_bit..   
+000432a0: 2069 6d2e 666c 7573 6828 290a 2020 2020   im.flush().    
+000432b0: 696d 2e63 6c6f 7365 2829 0a0a 0a64 6566  im.close()...def
+000432c0: 2064 756d 705f 666c 745f 6471 2866 696c   dump_flt_dq(fil
+000432d0: 656e 616d 652c 2072 6570 6c61 6365 3d28  ename, replace=(
+000432e0: 272e 6669 7473 272c 2027 2e64 712e 6669  '.fits', '.dq.fi
+000432f0: 7473 2e67 7a27 292c 2076 6572 626f 7365  ts.gz'), verbose
+00043300: 3d54 7275 6529 3a0a 2020 2020 2222 2244  =True):.    """D
+00043310: 756d 7020 464c 542f 464c 4320 6865 6164  ump FLT/FLC head
+00043320: 6572 2026 2044 5120 6578 7465 6e73 696f  er & DQ extensio
+00043330: 6e73 2074 6f20 6120 636f 6d70 6163 7420  ns to a compact 
+00043340: 6669 6c65 0a0a 2020 2020 5061 7261 6d65  file..    Parame
+00043350: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00043360: 2d2d 2d0a 2020 2020 6669 6c65 6e61 6d65  ---.    filename
+00043370: 203a 2073 7472 0a20 2020 2020 2020 2046   : str.        F
+00043380: 4c54 2f46 4c43 2066 696c 656e 616d 652e  LT/FLC filename.
+00043390: 0a0a 2020 2020 7265 706c 6163 6520 3a20  ..    replace : 
+000433a0: 2873 7472 2c20 7374 7229 0a20 2020 2020  (str, str).     
+000433b0: 2020 2052 6570 6c61 6365 2061 7267 756d     Replace argum
+000433c0: 656e 7473 2066 6f72 206f 7574 7075 7420  ents for output 
+000433d0: 6669 6c65 6e61 6d65 3a0a 0a20 2020 2020  filename:..     
+000433e0: 2020 203e 3e3e 206f 7574 7075 745f 6669     >>> output_fi
+000433f0: 6c65 6e61 6d65 203d 2066 696c 656e 616d  lename = filenam
+00043400: 652e 7265 706c 6163 6528 7265 706c 6163  e.replace(replac
+00043410: 655b 305d 2c20 7265 706c 6163 655b 315d  e[0], replace[1]
+00043420: 290a 0a20 2020 2052 6574 7572 6e73 0a20  )..    Returns. 
+00043430: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2057     -------.    W
+00043440: 7269 7465 7320 6865 6164 6572 2061 6e64  rites header and
+00043450: 2063 6f6d 7061 6374 2044 5120 6172 7261   compact DQ arra
+00043460: 7920 746f 2060 6f75 7470 7574 5f66 696c  y to `output_fil
+00043470: 656e 616d 6560 2e0a 0a20 2020 2022 2222  ename`...    """
+00043480: 0a20 2020 2069 6d20 3d20 7079 6669 7473  .    im = pyfits
+00043490: 2e6f 7065 6e28 6669 6c65 6e61 6d65 290a  .open(filename).
+000434a0: 2020 2020 6864 7573 203d 205b 5d0a 2020      hdus = [].  
+000434b0: 2020 666f 7220 6920 696e 205b 312c 2032    for i in [1, 2
+000434c0: 2c20 332c 2034 5d3a 0a20 2020 2020 2020  , 3, 4]:.       
+000434d0: 2069 6620 2827 5343 4927 2c20 6929 2069   if ('SCI', i) i
+000434e0: 6e20 696d 3a0a 2020 2020 2020 2020 2020  n im:.          
+000434f0: 2020 6865 6164 6572 203d 2069 6d5b 2753    header = im['S
+00043500: 4349 272c 2069 5d2e 6865 6164 6572 0a20  CI', i].header. 
+00043510: 2020 2020 2020 2020 2020 2064 7120 3d20             dq = 
+00043520: 696d 5b27 4451 272c 2069 5d2e 6461 7461  im['DQ', i].data
+00043530: 0a20 2020 2020 2020 2020 2020 206e 7a20  .            nz 
+00043540: 3d20 6e70 2e77 6865 7265 2864 7120 3e20  = np.where(dq > 
+00043550: 3029 0a20 2020 2020 2020 2020 2020 2064  0).            d
+00043560: 715f 6461 7461 203d 206e 702e 6172 7261  q_data = np.arra
+00043570: 7928 5b6e 7a5b 305d 2c20 6e7a 5b31 5d2c  y([nz[0], nz[1],
+00043580: 2064 715b 6471 203e 2030 5d5d 2c20 6474   dq[dq > 0]], dt
+00043590: 7970 653d 6e70 2e69 6e74 3136 290a 2020  ype=np.int16).  
+000435a0: 2020 2020 2020 2020 2020 6864 7520 3d20            hdu = 
+000435b0: 7079 6669 7473 2e49 6d61 6765 4844 5528  pyfits.ImageHDU(
+000435c0: 6865 6164 6572 3d68 6561 6465 722c 2064  header=header, d
+000435d0: 6174 613d 6471 5f64 6174 6129 0a20 2020  ata=dq_data).   
+000435e0: 2020 2020 2020 2020 2068 6475 732e 6170           hdus.ap
+000435f0: 7065 6e64 2868 6475 290a 0a20 2020 206f  pend(hdu)..    o
+00043600: 7574 7075 745f 6669 6c65 6e61 6d65 203d  utput_filename =
+00043610: 2066 696c 656e 616d 652e 7265 706c 6163   filename.replac
+00043620: 6528 7265 706c 6163 655b 305d 2c20 7265  e(replace[0], re
+00043630: 706c 6163 655b 315d 290a 0a20 2020 206d  place[1])..    m
+00043640: 7367 203d 2027 2320 6475 6d70 5f66 6c74  sg = '# dump_flt
+00043650: 5f64 713a 207b 307d 203e 207b 317d 272e  _dq: {0} > {1}'.
+00043660: 666f 726d 6174 2866 696c 656e 616d 652c  format(filename,
+00043670: 206f 7574 7075 745f 6669 6c65 6e61 6d65   output_filename
+00043680: 290a 2020 2020 6c6f 675f 636f 6d6d 656e  ).    log_commen
+00043690: 7428 4c4f 4746 494c 452c 206d 7367 2c20  t(LOGFILE, msg, 
+000436a0: 7665 7262 6f73 653d 7665 7262 6f73 652c  verbose=verbose,
+000436b0: 2073 686f 775f 6461 7465 3d54 7275 6529   show_date=True)
+000436c0: 0a0a 2020 2020 7079 6669 7473 2e48 4455  ..    pyfits.HDU
+000436d0: 4c69 7374 2868 6475 7329 2e77 7269 7465  List(hdus).write
+000436e0: 746f 286f 7574 7075 745f 6669 6c65 6e61  to(output_filena
+000436f0: 6d65 2c20 6f76 6572 7772 6974 653d 5472  me, overwrite=Tr
+00043700: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00043710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043720: 2020 2020 206f 7574 7075 745f 7665 7269       output_veri
+00043730: 6679 3d27 6669 7827 290a 2020 2020 0a20  fy='fix').    . 
+00043740: 2020 2069 6d2e 636c 6f73 6528 290a 0a0a     im.close()...
+00043750: 6465 6620 6170 706c 795f 666c 745f 6471  def apply_flt_dq
+00043760: 2866 696c 656e 616d 652c 2072 6570 6c61  (filename, repla
+00043770: 6365 3d28 272e 6669 7473 272c 2027 2e64  ce=('.fits', '.d
+00043780: 712e 6669 7473 2e67 7a27 292c 2076 6572  q.fits.gz'), ver
+00043790: 626f 7365 3d54 7275 652c 206f 725f 636f  bose=True, or_co
+000437a0: 6d62 696e 653d 4661 6c73 6529 3a0a 2020  mbine=False):.  
+000437b0: 2020 2222 220a 2020 2020 5265 6164 2061    """.    Read a
+000437c0: 6e64 2061 7070 6c79 2074 6865 2063 6f6d  nd apply the com
+000437d0: 7061 6374 2065 7870 6f73 7572 6520 696e  pact exposure in
+000437e0: 666f 726d 6174 696f 6e20 6669 6c65 0a0a  formation file..
+000437f0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00043800: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00043810: 2020 6669 6c65 6e61 6d65 203a 2073 7472    filename : str
+00043820: 0a20 2020 2020 2020 2046 4c54 2f46 4c43  .        FLT/FLC
+00043830: 2066 696c 656e 616d 652e 0a0a 2020 2020   filename...    
+00043840: 7265 706c 6163 6520 3a20 2873 7472 2c20  replace : (str, 
+00043850: 7374 7229 0a20 2020 2020 2020 2052 6570  str).        Rep
+00043860: 6c61 6365 2061 7267 756d 656e 7473 2066  lace arguments f
+00043870: 6f72 206f 7574 7075 7420 4451 2066 696c  or output DQ fil
+00043880: 656e 616d 653a 0a0a 2020 2020 2020 2020  ename:..        
+00043890: 3e3e 3e20 6f75 7470 7574 5f66 696c 656e  >>> output_filen
+000438a0: 616d 6520 3d20 6669 6c65 6e61 6d65 2e72  ame = filename.r
+000438b0: 6570 6c61 6365 2872 6570 6c61 6365 5b30  eplace(replace[0
+000438c0: 5d2c 2072 6570 6c61 6365 5b31 5d29 0a0a  ], replace[1])..
+000438d0: 2020 2020 6f72 5f63 6f6d 6269 6e65 203a      or_combine :
+000438e0: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+000438f0: 2054 7275 652c 2074 6865 6e20 6170 706c   True, then appl
+00043900: 7920 4451 2064 6174 6120 696e 2060 6f75  y DQ data in `ou
+00043910: 7470 7574 5f66 696c 656e 616d 6560 2077  tput_filename` w
+00043920: 6974 6820 4f52 206c 6f67 6963 2e0a 0a20  ith OR logic... 
+00043930: 2020 2020 2020 2049 6620 4661 6c73 652c         If False,
+00043940: 2074 6865 6e20 7265 7365 7420 7468 6520   then reset the 
+00043950: 4451 2065 7874 656e 7369 6f6e 7320 746f  DQ extensions to
+00043960: 2062 6520 6578 6163 746c 7920 7468 6f73   be exactly thos
+00043970: 6520 696e 0a20 2020 2020 2020 2060 6f75  e in.        `ou
+00043980: 7470 7574 5f66 696c 656e 616d 6560 2e0a  tput_filename`..
+00043990: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+000439a0: 202d 2d2d 2d2d 2d2d 0a20 2020 2057 7269   -------.    Wri
+000439b0: 7465 7320 6865 6164 6572 2061 6e64 2063  tes header and c
+000439c0: 6f6d 7061 6374 2044 5120 6172 7261 7920  ompact DQ array 
+000439d0: 746f 2060 6f75 7470 7574 5f66 696c 656e  to `output_filen
+000439e0: 616d 6560 2e0a 0a20 2020 2022 2222 0a0a  ame`...    """..
+000439f0: 2020 2020 6f75 7470 7574 5f66 696c 656e      output_filen
+00043a00: 616d 6520 3d20 6669 6c65 6e61 6d65 2e72  ame = filename.r
+00043a10: 6570 6c61 6365 2872 6570 6c61 6365 5b30  eplace(replace[0
+00043a20: 5d2c 2072 6570 6c61 6365 5b31 5d29 0a0a  ], replace[1])..
+00043a30: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
+00043a40: 7468 2e65 7869 7374 7328 6f75 7470 7574  th.exists(output
+00043a50: 5f66 696c 656e 616d 6529 3a0a 2020 2020  _filename):.    
+00043a60: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00043a70: 0a0a 2020 2020 696d 203d 2070 7966 6974  ..    im = pyfit
+00043a80: 732e 6f70 656e 2866 696c 656e 616d 652c  s.open(filename,
+00043a90: 206d 6f64 653d 2775 7064 6174 6527 290a   mode='update').
+00043aa0: 0a20 2020 206d 7367 203d 2027 2320 6170  .    msg = '# ap
+00043ab0: 706c 795f 666c 745f 6471 3a20 7b31 7d20  ply_flt_dq: {1} 
+00043ac0: 3e20 7b30 7d27 2e66 6f72 6d61 7428 6669  > {0}'.format(fi
+00043ad0: 6c65 6e61 6d65 2c20 6f75 7470 7574 5f66  lename, output_f
+00043ae0: 696c 656e 616d 6529 0a20 2020 206c 6f67  ilename).    log
+00043af0: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
+00043b00: 2c20 6d73 672c 2076 6572 626f 7365 3d76  , msg, verbose=v
+00043b10: 6572 626f 7365 2c20 7368 6f77 5f64 6174  erbose, show_dat
+00043b20: 653d 5472 7565 290a 0a20 2020 2064 7120  e=True)..    dq 
+00043b30: 3d20 7079 6669 7473 2e6f 7065 6e28 6f75  = pyfits.open(ou
+00043b40: 7470 7574 5f66 696c 656e 616d 6529 0a20  tput_filename). 
+00043b50: 2020 2066 6f72 2065 7874 2069 6e20 5b31     for ext in [1
+00043b60: 2c20 322c 2033 2c20 345d 3a0a 2020 2020  , 2, 3, 4]:.    
+00043b70: 2020 2020 6966 2028 2827 5343 4927 2c20      if (('SCI', 
+00043b80: 6578 7429 2069 6e20 696d 2920 2620 2828  ext) in im) & ((
+00043b90: 2753 4349 272c 2065 7874 2920 696e 2064  'SCI', ext) in d
+00043ba0: 7129 3a0a 2020 2020 2020 2020 2020 2020  q):.            
+00043bb0: 7368 203d 2064 715b 2753 4349 272c 2065  sh = dq['SCI', e
+00043bc0: 7874 5d2e 6461 7461 2e73 6861 7065 0a20  xt].data.shape. 
+00043bd0: 2020 2020 2020 2020 2020 2069 6620 7368             if sh
+00043be0: 5b30 5d20 3d3d 2033 3a0a 2020 2020 2020  [0] == 3:.      
+00043bf0: 2020 2020 2020 2020 2020 692c 206a 2c20            i, j, 
+00043c00: 6471 5f69 203d 2064 715b 2753 4349 272c  dq_i = dq['SCI',
+00043c10: 2065 7874 5d2e 6461 7461 0a20 2020 2020   ext].data.     
+00043c20: 2020 2020 2020 2065 6c69 6620 7368 5b31         elif sh[1
+00043c30: 5d20 3d3d 2032 3a0a 2020 2020 2020 2020  ] == 2:.        
+00043c40: 2020 2020 2020 2020 6e7a 2c20 6471 5f69          nz, dq_i
+00043c50: 203d 2064 715b 2753 4349 272c 2065 7874   = dq['SCI', ext
+00043c60: 5d2e 6461 7461 0a20 2020 2020 2020 2020  ].data.         
+00043c70: 2020 2020 2020 2069 2c20 6a20 3d20 6e70         i, j = np
+00043c80: 2e75 6e72 6176 656c 5f69 6e64 6578 286e  .unravel_index(n
+00043c90: 7a2c 2073 6829 0a20 2020 2020 2020 2020  z, sh).         
+00043ca0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00043cb0: 2020 2020 2020 2020 2072 6169 7365 2049           raise I
+00043cc0: 4f45 7272 6f72 2827 6471 5b7b 307d 5d20  OError('dq[{0}] 
+00043cd0: 7368 6170 6520 7b31 7d20 6e6f 7420 7265  shape {1} not re
+00043ce0: 636f 676e 697a 6564 272e 666f 726d 6174  cognized'.format
+00043cf0: 2865 7874 2c20 7368 2929 0a20 2020 2020  (ext, sh)).     
+00043d00: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00043d10: 2020 2020 2020 2020 2320 4170 706c 7920          # Apply 
+00043d20: 4451 0a20 2020 2020 2020 2020 2020 2069  DQ.            i
+00043d30: 6620 6f72 5f63 6f6d 6269 6e65 3a0a 2020  f or_combine:.  
+00043d40: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00043d50: 5b27 4451 272c 2065 7874 5d2e 6461 7461  ['DQ', ext].data
+00043d60: 5b69 2c20 6a5d 2021 3d20 6471 5f69 0a20  [i, j] != dq_i. 
+00043d70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00043d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043d90: 2069 6d5b 2744 5127 2c20 6578 745d 2e64   im['DQ', ext].d
+00043da0: 6174 6120 2a3d 2030 0a20 2020 2020 2020  ata *= 0.       
+00043db0: 2020 2020 2020 2020 2069 6d5b 2744 5127           im['DQ'
+00043dc0: 2c20 6578 745d 2e64 6174 615b 692c 206a  , ext].data[i, j
+00043dd0: 5d20 3d20 6471 5f69 0a0a 2020 2020 2020  ] = dq_i..      
+00043de0: 2020 2020 2020 2320 436f 7079 2068 6561        # Copy hea
+00043df0: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
+00043e00: 6861 735f 626c 6f74 736b 7920 3d20 2742  has_blotsky = 'B
+00043e10: 4c4f 5453 4b59 2720 696e 2069 6d5b 2753  LOTSKY' in im['S
+00043e20: 4349 272c 2065 7874 5d2e 6865 6164 6572  CI', ext].header
+00043e30: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00043e40: 206b 2069 6e20 6471 5b27 5343 4927 2c20   k in dq['SCI', 
+00043e50: 6578 745d 2e68 6561 6465 723a 0a20 2020  ext].header:.   
+00043e60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00043e70: 6b20 696e 205b 2742 4954 5049 5827 2c20  k in ['BITPIX', 
+00043e80: 274e 4158 4953 3127 2c20 274e 4158 4953  'NAXIS1', 'NAXIS
+00043e90: 3227 2c20 2727 2c20 2748 4953 544f 5259  2', '', 'HISTORY
+00043ea0: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+00043eb0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00043ec0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00043ed0: 2020 696d 5b27 5343 4927 2c20 6578 745d    im['SCI', ext]
+00043ee0: 2e68 6561 6465 725b 6b5d 203d 2064 715b  .header[k] = dq[
+00043ef0: 2753 4349 272c 2065 7874 5d2e 6865 6164  'SCI', ext].head
+00043f00: 6572 5b6b 5d0a 0a20 2020 2020 2020 2020  er[k]..         
+00043f10: 2020 2069 6620 286e 6f74 2068 6173 5f62     if (not has_b
+00043f20: 6c6f 7473 6b79 2920 2620 2827 424c 4f54  lotsky) & ('BLOT
+00043f30: 534b 5927 2069 6e20 6471 5b27 5343 4927  SKY' in dq['SCI'
+00043f40: 2c20 6578 745d 2e68 6561 6465 7229 3a0a  , ext].header):.
+00043f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043f60: 696d 5b27 5343 4927 2c20 6578 745d 2e68  im['SCI', ext].h
+00043f70: 6561 6465 725b 2742 4c4f 5453 4b59 275d  eader['BLOTSKY']
+00043f80: 203d 2046 616c 7365 0a0a 2020 2020 696d   = False..    im
+00043f90: 2e66 6c75 7368 2829 0a20 2020 2069 6d2e  .flush().    im.
+00043fa0: 636c 6f73 6528 290a 0a0a 6465 6620 5247  close()...def RG
+00043fb0: 4274 6f48 6578 2876 616c 732c 2072 6762  BtoHex(vals, rgb
+00043fc0: 7479 7065 3d31 293a 0a20 2020 2022 2222  type=1):.    """
+00043fd0: 436f 6e76 6572 7473 2052 4742 2076 616c  Converts RGB val
+00043fe0: 7565 7320 696e 2061 2076 6172 6965 7479  ues in a variety
+00043ff0: 206f 6620 666f 726d 6174 7320 746f 2048   of formats to H
+00044000: 6578 2076 616c 7565 732e 0a0a 2020 2020  ex values...    
+00044010: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00044020: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7661  ---------.    va
+00044030: 6c73 203a 2074 7570 6c65 0a20 2020 2020  ls : tuple.     
+00044040: 2020 2020 416e 2052 4742 2f52 4742 4120      An RGB/RGBA 
+00044050: 7475 706c 650a 0a20 2020 2072 6762 5f74  tuple..    rgb_t
+00044060: 7970 6520 3a20 696e 740a 2020 2020 2020  ype : int.      
+00044070: 2020 5661 6c69 6420 7661 6c75 7320 6172    Valid valus ar
+00044080: 653a 0a20 2020 2020 2020 2020 2d20 3120  e:.         - 1 
+00044090: 3d20 496e 7075 7473 2061 7265 2069 6e20  = Inputs are in 
+000440a0: 7468 6520 7261 6e67 6520 3020 746f 2031  the range 0 to 1
+000440b0: 0a20 2020 2020 2020 2020 2d20 3235 3620  .         - 256 
+000440c0: 3d20 496e 7075 7473 2061 7265 2069 6e20  = Inputs are in 
+000440d0: 7468 6520 7261 6e67 6520 3020 746f 2032  the range 0 to 2
+000440e0: 3535 0a20 0a20 2020 2052 6574 7572 6e73  55. .    Returns
+000440f0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00044100: 2068 6578 7473 7472 203a 2073 7472 0a20   hextstr : str. 
+00044110: 2020 2020 2020 2041 2068 6578 2073 7472         A hex str
+00044120: 696e 6720 696e 2074 6865 2066 6f72 6d20  ing in the form 
+00044130: 2723 5252 4747 4242 2720 6f72 2027 2352  '#RRGGBB' or '#R
+00044140: 5247 4742 4241 4127 0a0a 2020 2020 5265  RGGBBAA'..    Re
+00044150: 6665 7265 6e63 6573 0a20 2020 202d 2d2d  ferences.    ---
+00044160: 2d2d 2d2d 2d2d 2d0a 2020 2020 2863 7265  -------.    (cre
+00044170: 6469 743a 2052 7963 6861 7264 2040 2068  dit: Rychard @ h
+00044180: 7474 7073 3a2f 2f73 7461 636b 6f76 6572  ttps://stackover
+00044190: 666c 6f77 2e63 6f6d 2f61 2f34 3832 3838  flow.com/a/48288
+000441a0: 3137 3329 0a0a 2020 2020 2222 220a 0a20  173)..    """.. 
+000441b0: 2020 206d 7367 203d 2022 5247 4220 6f72     msg = "RGB or
+000441c0: 2052 4742 4120 696e 7075 7473 2074 6f20   RGBA inputs to 
+000441d0: 5247 4274 6f48 6578 206d 7573 7420 6861  RGBtoHex must ha
+000441e0: 7665 2074 6872 6565 206f 7220 666f 7572  ve three or four
+000441f0: 2065 6c65 6d65 6e74 7321 220a 2020 2020   elements!".    
+00044200: 6966 2028 6c65 6e28 7661 6c73 2920 213d  if (len(vals) !=
+00044210: 2033 2920 2620 286c 656e 2876 616c 7329   3) & (len(vals)
+00044220: 2021 3d20 3429 3a0a 2020 2020 2020 2020   != 4):.        
+00044230: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+00044240: 6d73 6729 0a0a 2020 2020 6966 2028 7267  msg)..    if (rg
+00044250: 6274 7970 6520 213d 2031 2920 2620 2872  btype != 1) & (r
+00044260: 6762 7479 7065 2021 3d20 3235 3629 3a0a  gbtype != 256):.
+00044270: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+00044280: 6365 7074 696f 6e28 2272 6762 7479 7065  ception("rgbtype
+00044290: 206d 7573 7420 6265 2031 206f 7220 3235   must be 1 or 25
+000442a0: 3621 2229 0a0a 2020 2020 2320 436f 6e76  6!")..    # Conv
+000442b0: 6572 7420 6672 6f6d 2030 2d31 2052 4742  ert from 0-1 RGB
+000442c0: 2f52 4742 4120 746f 2030 2d32 3535 2052  /RGBA to 0-255 R
+000442d0: 4742 2f52 4742 410a 2020 2020 6966 2072  GB/RGBA.    if r
+000442e0: 6762 7479 7065 203d 3d20 313a 0a20 2020  gbtype == 1:.   
+000442f0: 2020 2020 2076 616c 7320 3d20 5b32 3535       vals = [255
+00044300: 2a78 2066 6f72 2078 2069 6e20 7661 6c73  *x for x in vals
+00044310: 5b3a 335d 5d0a 0a20 2020 2023 2045 6e73  [:3]]..    # Ens
+00044320: 7572 6520 7661 6c75 6573 2061 7265 2072  ure values are r
+00044330: 6f75 6e64 6564 2069 6e74 6567 6572 732c  ounded integers,
+00044340: 2063 6f6e 7665 7274 2074 6f20 6865 782c   convert to hex,
+00044350: 2061 6e64 2063 6f6e 6361 7465 6e61 7465   and concatenate
+00044360: 0a20 2020 2072 6574 7572 6e20 2723 2720  .    return '#' 
+00044370: 2b20 2727 2e6a 6f69 6e28 5b27 7b3a 3032  + ''.join(['{:02
+00044380: 587d 272e 666f 726d 6174 2869 6e74 2872  X}'.format(int(r
+00044390: 6f75 6e64 2878 2929 2920 666f 7220 7820  ound(x))) for x 
+000443a0: 696e 2076 616c 735d 290a 0a0a 6465 6620  in vals])...def 
+000443b0: 6361 7461 6c6f 675f 6d61 736b 2863 6174  catalog_mask(cat
+000443c0: 2c20 6563 6f6c 3d27 464c 5558 4552 525f  , ecol='FLUXERR_
+000443d0: 4150 4552 5f30 272c 206d 6178 5f65 7272  APER_0', max_err
+000443e0: 5f70 6572 6365 6e74 696c 653d 3930 2c20  _percentile=90, 
+000443f0: 7061 643d 302e 3035 2c20 7061 645f 6973  pad=0.05, pad_is
+00044400: 5f61 6273 6f6c 7574 653d 4661 6c73 652c  _absolute=False,
+00044410: 206d 696e 5f66 6c75 785f 7261 6469 7573   min_flux_radius
+00044420: 3d31 2e29 3a0a 2020 2020 2222 220a 2020  =1.):.    """.  
+00044430: 2020 436f 6d70 7574 6520 6120 6361 7461    Compute a cata
+00044440: 6c6f 6720 6d61 736b 2066 6f72 0a20 2020  log mask for.   
+00044450: 2020 2031 2920 4f62 6a65 6374 7320 7769     1) Objects wi
+00044460: 7468 696e 2060 7061 6460 206f 6620 7468  thin `pad` of th
+00044470: 6520 6564 6765 206f 6620 7468 6520 6361  e edge of the ca
+00044480: 7461 6c6f 6720 636f 6e76 6578 2068 756c  talog convex hul
+00044490: 6c0a 2020 2020 2020 3229 2055 6e63 6572  l.      2) Uncer
+000444a0: 7461 696e 7469 6573 203c 2060 6d61 785f  tainties < `max_
+000444b0: 6572 725f 7065 7263 656e 7469 6c65 600a  err_percentile`.
+000444c0: 0a20 2020 2022 2222 0a20 2020 2074 6573  .    """.    tes
+000444d0: 7420 3d20 6e70 2e69 7366 696e 6974 6528  t = np.isfinite(
+000444e0: 6361 745b 2746 4c55 585f 4155 544f 275d  cat['FLUX_AUTO']
+000444f0: 290a 2020 2020 6966 2027 464c 5558 5f52  ).    if 'FLUX_R
+00044500: 4144 4955 5327 2069 6e20 6361 742e 636f  ADIUS' in cat.co
+00044510: 6c6e 616d 6573 3a0a 2020 2020 2020 2020  lnames:.        
+00044520: 7465 7374 2026 3d20 6361 745b 2746 4c55  test &= cat['FLU
+00044530: 585f 5241 4449 5553 275d 203e 206d 696e  X_RADIUS'] > min
+00044540: 5f66 6c75 785f 7261 6469 7573 0a0a 2020  _flux_radius..  
+00044550: 2020 7465 7374 2026 3d20 2863 6174 5b27    test &= (cat['
+00044560: 5448 5245 5348 275d 203e 2030 2920 2620  THRESH'] > 0) & 
+00044570: 2863 6174 5b27 5448 5245 5348 275d 203c  (cat['THRESH'] <
+00044580: 2031 6532 3829 0a0a 2020 2020 6e6f 745f   1e28)..    not_
+00044590: 6564 6765 203d 2068 756c 6c5f 6564 6765  edge = hull_edge
+000445a0: 5f6d 6173 6b28 6361 745b 2758 5f49 4d41  _mask(cat['X_IMA
+000445b0: 4745 275d 2c20 6361 745b 2759 5f49 4d41  GE'], cat['Y_IMA
+000445c0: 4745 275d 2c0a 2020 2020 2020 2020 2020  GE'],.          
+000445d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000445e0: 2020 2020 7061 643d 7061 642c 2070 6164      pad=pad, pad
+000445f0: 5f69 735f 6162 736f 6c75 7465 3d70 6164  _is_absolute=pad
+00044600: 5f69 735f 6162 736f 6c75 7465 290a 0a20  _is_absolute).. 
+00044610: 2020 2074 6573 7420 263d 206e 6f74 5f65     test &= not_e
+00044620: 6467 650a 0a20 2020 2069 6620 6563 6f6c  dge..    if ecol
+00044630: 2069 6e20 6361 742e 636f 6c6e 616d 6573   in cat.colnames
+00044640: 3a0a 2020 2020 2020 2020 7661 6c69 6420  :.        valid 
+00044650: 3d20 6e70 2e69 7366 696e 6974 6528 6361  = np.isfinite(ca
+00044660: 745b 6563 6f6c 5d29 0a20 2020 2020 2020  t[ecol]).       
+00044670: 2069 6620 6d61 785f 6572 725f 7065 7263   if max_err_perc
+00044680: 656e 7469 6c65 203c 2031 3030 3a0a 2020  entile < 100:.  
+00044690: 2020 2020 2020 2020 2020 7465 7374 2026            test &
+000446a0: 3d20 6361 745b 6563 6f6c 5d20 3c20 6e70  = cat[ecol] < np
+000446b0: 2e70 6572 6365 6e74 696c 6528 6361 745b  .percentile(cat[
+000446c0: 6563 6f6c 5d5b 287e 6e6f 745f 6564 6765  ecol][(~not_edge
+000446d0: 2920 2620 7661 6c69 645d 2c0a 2020 2020  ) & valid],.    
+000446e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000446f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044700: 2020 2020 2020 6d61 785f 6572 725f 7065        max_err_pe
+00044710: 7263 656e 7469 6c65 290a 0a20 2020 2072  rcentile)..    r
+00044720: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
+00044730: 2068 756c 6c5f 6564 6765 5f6d 6173 6b28   hull_edge_mask(
+00044740: 782c 2079 2c20 7061 643d 3130 302c 2070  x, y, pad=100, p
+00044750: 6164 5f69 735f 6162 736f 6c75 7465 3d54  ad_is_absolute=T
+00044760: 7275 652c 206d 6173 6b3d 4e6f 6e65 293a  rue, mask=None):
+00044770: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
+00044780: 7075 7465 2067 656f 6d65 7472 6963 616c  pute geometrical
+00044790: 2065 6467 6520 6d61 736b 2066 6f72 2070   edge mask for p
+000447a0: 6f69 6e74 7320 7769 7468 696e 2061 2063  oints within a c
+000447b0: 6f6e 7665 7820 6875 6c6c 0a0a 2020 2020  onvex hull..    
+000447c0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+000447d0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 782c  ---------.    x,
+000447e0: 2079 203a 2061 7272 6179 0a20 2020 2020   y : array.     
+000447f0: 2020 2043 6f6f 7264 696e 6174 6573 206f     Coordinates o
+00044800: 6620 7468 6520 6361 7461 6c6f 670a 0a20  f the catalog.. 
+00044810: 2020 2070 6164 203a 2066 6c6f 6174 0a20     pad : float. 
+00044820: 2020 2020 2020 2042 7566 6665 7220 7061         Buffer pa
+00044830: 6464 696e 670a 0a20 2020 2070 6164 5f69  dding..    pad_i
+00044840: 735f 6162 736f 6c75 7465 203a 2062 6f6f  s_absolute : boo
+00044850: 6c0a 2020 2020 2020 2020 4966 2054 7275  l.        If Tru
+00044860: 652c 2074 6865 6e20 7468 6520 6275 6666  e, then the buff
+00044870: 6572 2069 7320 7461 6b65 6e20 6672 6f6d  er is taken from
+00044880: 2060 7061 6460 2028 652e 672e 2c20 7069   `pad` (e.g., pi
+00044890: 7865 6c73 292e 2020 4966 0a20 2020 2020  xels).  If.     
+000448a0: 2020 2046 616c 7365 2c20 7468 656e 2060     False, then `
+000448b0: 7061 6460 2069 7320 7472 6561 7465 6420  pad` is treated 
+000448c0: 6173 2061 2066 7261 6374 696f 6e20 6f66  as a fraction of
+000448d0: 2074 6865 206c 696e 6561 7220 6469 6d65   the linear dime
+000448e0: 6e73 696f 6e0a 2020 2020 2020 2020 6f66  nsion.        of
+000448f0: 2074 6865 2063 6174 616c 6f67 2028 607e   the catalog (`~
+00044900: 7371 7274 2868 756c 6c20 6172 6561 2960  sqrt(hull area)`
+00044910: 292e 0a0a 2020 2020 6d61 736b 203a 2062  )...    mask : b
+00044920: 6f6f 6c20 6172 7261 790a 2020 2020 2020  ool array.      
+00044930: 2020 4d61 736b 2074 6f20 6170 706c 7920    Mask to apply 
+00044940: 746f 2078 2f79 2062 6566 6f72 6520 636f  to x/y before co
+00044950: 6d70 7574 696e 6720 7468 6520 636f 6e76  mputing the conv
+00044960: 6578 2068 756c 6c0a 0a20 2020 2052 6574  ex hull..    Ret
+00044970: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00044980: 0a20 2020 206d 6173 6b20 3a20 626f 6f6c  .    mask : bool
+00044990: 2061 7272 6179 0a20 2020 2020 2020 2054   array.        T
+000449a0: 7275 6520 6966 2070 6f69 6e74 7320 7769  rue if points wi
+000449b0: 7468 696e 2074 6865 2062 7566 6665 7265  thin the buffere
+000449c0: 6420 6875 6c6c 0a0a 2020 2020 2222 220a  d hull..    """.
+000449d0: 0a20 2020 2066 726f 6d20 7363 6970 792e  .    from scipy.
+000449e0: 7370 6174 6961 6c20 696d 706f 7274 2043  spatial import C
+000449f0: 6f6e 7665 7848 756c 6c0a 2020 2020 6672  onvexHull.    fr
+00044a00: 6f6d 2073 6861 7065 6c79 2e67 656f 6d65  om shapely.geome
+00044a10: 7472 7920 696d 706f 7274 2050 6f6c 7967  try import Polyg
+00044a20: 6f6e 2c20 506f 696e 740a 0a20 2020 2078  on, Point..    x
+00044a30: 7920 3d20 6e70 2e61 7272 6179 285b 782c  y = np.array([x,
+00044a40: 2079 5d29 2e54 0a0a 2020 2020 6966 206d   y]).T..    if m
+00044a50: 6173 6b20 6973 204e 6f6e 653a 0a20 2020  ask is None:.   
+00044a60: 2020 2020 2068 756c 6c20 3d20 436f 6e76       hull = Conv
+00044a70: 6578 4875 6c6c 2878 7929 0a20 2020 2065  exHull(xy).    e
+00044a80: 6c73 653a 0a20 2020 2020 2020 2068 756c  lse:.        hul
+00044a90: 6c20 3d20 436f 6e76 6578 4875 6c6c 2878  l = ConvexHull(x
+00044aa0: 795b 6d61 736b 2c20 3a5d 290a 0a20 2020  y[mask, :])..   
+00044ab0: 2070 7879 203d 2078 795b 6875 6c6c 2e76   pxy = xy[hull.v
+00044ac0: 6572 7469 6365 732c 203a 5d0a 2020 2020  ertices, :].    
+00044ad0: 706f 6c79 203d 2050 6f6c 7967 6f6e 2870  poly = Polygon(p
+00044ae0: 7879 290a 0a20 2020 2069 6620 7061 645f  xy)..    if pad_
+00044af0: 6973 5f61 6273 6f6c 7574 653a 0a20 2020  is_absolute:.   
+00044b00: 2020 2020 2062 7566 6620 3d20 2d70 6164       buff = -pad
+00044b10: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00044b20: 2020 2023 206c 696e 6561 7220 6469 6d65     # linear dime
+00044b30: 6e73 696f 6e20 7e20 7371 7274 2861 7265  nsion ~ sqrt(are
+00044b40: 6129 0a20 2020 2020 2020 2062 7566 6620  a).        buff 
+00044b50: 3d20 2d70 6164 2a6e 702e 7371 7274 2870  = -pad*np.sqrt(p
+00044b60: 6f6c 792e 6172 6561 290a 0a20 2020 2070  oly.area)..    p
+00044b70: 6275 6666 203d 2070 6f6c 792e 6275 6666  buff = poly.buff
+00044b80: 6572 2862 7566 6629 0a20 2020 2069 6e5f  er(buff).    in_
+00044b90: 6275 6666 203d 206e 702e 6172 7261 7928  buff = np.array(
+00044ba0: 5b70 6275 6666 2e63 6f6e 7461 696e 7328  [pbuff.contains(
+00044bb0: 506f 696e 7428 5b78 5b69 5d2c 2079 5b69  Point([x[i], y[i
+00044bc0: 5d5d 2929 2066 6f72 2069 2069 6e20 7261  ]])) for i in ra
+00044bd0: 6e67 6528 6c65 6e28 7829 295d 290a 0a20  nge(len(x))]).. 
+00044be0: 2020 2072 6574 7572 6e20 696e 5f62 7566     return in_buf
+00044bf0: 660a 0a0a 6465 6620 636f 6e76 6578 5f68  f...def convex_h
+00044c00: 756c 6c5f 7772 6170 7065 7228 782c 2079  ull_wrapper(x, y
+00044c10: 293a 0a20 2020 2022 2222 0a20 2020 2047  ):.    """.    G
+00044c20: 656e 6572 6174 6520 6120 636f 6e76 6578  enerate a convex
+00044c30: 2068 756c 6c20 6672 6f6d 2061 206c 6973   hull from a lis
+00044c40: 7420 6f66 2070 6f69 6e74 730a 2020 2020  t of points.    
+00044c50: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00044c60: 2020 0a20 2020 2070 7879 203a 2028 6172    .    pxy : (ar
+00044c70: 7261 792c 2061 7272 6179 290a 2020 2020  ray, array).    
+00044c80: 2020 2020 5475 706c 6520 6f66 2068 756c      Tuple of hul
+00044c90: 6c20 7665 7274 6963 6573 0a20 2020 200a  l vertices.    .
+00044ca0: 2020 2020 706f 6c79 203a 2060 7e73 6861      poly : `~sha
+00044cb0: 7065 6c79 2e67 656f 6d65 7472 792e 506f  pely.geometry.Po
+00044cc0: 6c79 676f 6e60 0a20 2020 2020 2020 2050  lygon`.        P
+00044cd0: 6f6c 7967 6f6e 206f 626a 6563 742e 0a20  olygon object.. 
+00044ce0: 2020 200a 2020 2020 6875 6c6c 203a 2060     .    hull : `
+00044cf0: 7e73 6369 7079 2e73 7061 7469 616c 2e43  ~scipy.spatial.C
+00044d00: 6f6e 7665 7848 756c 6c60 0a20 2020 2020  onvexHull`.     
+00044d10: 2020 2054 6865 2068 756c 6c20 6f62 6a65     The hull obje
+00044d20: 6374 2e0a 2020 2020 2020 2020 0a20 2020  ct..        .   
+00044d30: 2022 2222 0a20 2020 2066 726f 6d20 7363   """.    from sc
+00044d40: 6970 792e 7370 6174 6961 6c20 696d 706f  ipy.spatial impo
+00044d50: 7274 2043 6f6e 7665 7848 756c 6c0a 2020  rt ConvexHull.  
+00044d60: 2020 6672 6f6d 2073 6861 7065 6c79 2e67    from shapely.g
+00044d70: 656f 6d65 7472 7920 696d 706f 7274 2050  eometry import P
+00044d80: 6f6c 7967 6f6e 2c20 506f 696e 740a 0a20  olygon, Point.. 
+00044d90: 2020 2078 7920 3d20 6e70 2e61 7272 6179     xy = np.array
+00044da0: 285b 782c 2079 5d29 2e54 0a20 2020 2068  ([x, y]).T.    h
+00044db0: 756c 6c20 3d20 436f 6e76 6578 4875 6c6c  ull = ConvexHull
+00044dc0: 2878 7929 0a20 2020 2070 7879 203d 2078  (xy).    pxy = x
+00044dd0: 795b 6875 6c6c 2e76 6572 7469 6365 732c  y[hull.vertices,
+00044de0: 203a 5d0a 2020 2020 706f 6c79 203d 2050   :].    poly = P
+00044df0: 6f6c 7967 6f6e 2870 7879 290a 2020 2020  olygon(pxy).    
+00044e00: 0a20 2020 2072 6574 7572 6e20 7078 792c  .    return pxy,
+00044e10: 2070 6f6c 792c 2068 756c 6c0a 0a0a 6465   poly, hull...de
+00044e20: 6620 6875 6c6c 5f61 7265 6128 782c 2079  f hull_area(x, y
+00044e30: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
+00044e40: 6574 7572 6e20 7468 6520 6172 6561 206f  eturn the area o
+00044e50: 6620 6120 636f 6e76 6578 2068 756c 6c20  f a convex hull 
+00044e60: 6f66 2061 206c 6973 7420 6f66 2070 6f69  of a list of poi
+00044e70: 6e74 730a 2020 2020 2222 220a 2020 2020  nts.    """.    
+00044e80: 7078 792c 2070 6f6c 792c 2068 756c 6c20  pxy, poly, hull 
+00044e90: 3d20 636f 6e76 6578 5f68 756c 6c5f 7772  = convex_hull_wr
+00044ea0: 6170 7065 7228 782c 2079 290a 0a20 2020  apper(x, y)..   
+00044eb0: 2072 6574 7572 6e20 706f 6c79 2e61 7265   return poly.are
+00044ec0: 610a 2020 2020 0a20 2020 200a 6465 6620  a.    .    .def 
+00044ed0: 7265 6d6f 7665 5f74 6578 745f 6c61 6265  remove_text_labe
+00044ee0: 6c73 2866 6967 293a 0a20 2020 2022 2222  ls(fig):.    """
+00044ef0: 0a20 2020 2052 656d 6f76 6520 616c 6c20  .    Remove all 
+00044f00: 5465 7874 2061 6e6e 6f74 6174 696f 6e73  Text annotations
+00044f10: 2066 726f 6d20 6060 6669 672e 6178 6573   from ``fig.axes
+00044f20: 6060 2e0a 2020 2020 2222 220a 2020 2020  ``..    """.    
+00044f30: 696d 706f 7274 206d 6174 706c 6f74 6c69  import matplotli
+00044f40: 620a 2020 2020 0a20 2020 2066 6f72 2061  b.    .    for a
+00044f50: 7820 696e 2066 6967 2e61 7865 733a 0a20  x in fig.axes:. 
+00044f60: 2020 2020 2020 2066 6f72 2063 6869 6c64         for child
+00044f70: 2069 6e20 6178 2e67 6574 5f63 6869 6c64   in ax.get_child
+00044f80: 7265 6e28 293a 0a20 2020 2020 2020 2020  ren():.         
+00044f90: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00044fa0: 2863 6869 6c64 2c20 6d61 7470 6c6f 746c  (child, matplotl
+00044fb0: 6962 2e74 6578 742e 5465 7874 293a 0a20  ib.text.Text):. 
+00044fc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00044fd0: 6620 6368 696c 642e 6765 745f 7465 7874  f child.get_text
+00044fe0: 2829 3a20 2320 446f 6e27 7420 7265 6d6f  (): # Don't remo
+00044ff0: 7665 2065 6d70 7479 206c 6162 656c 730a  ve empty labels.
+00045000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045010: 2020 2020 6368 696c 642e 7365 745f 7669      child.set_vi
+00045020: 7369 626c 6528 4661 6c73 6529 0a0a 2020  sible(False)..  
+00045030: 2020 0a4c 4f47 4649 4c45 203d 2027 2f74    .LOGFILE = '/t
+00045040: 6d70 2f67 7269 7a6c 692e 6c6f 6727 0a0a  mp/grizli.log'..
+00045050: 0a64 6566 206c 6f67 5f66 756e 6374 696f  .def log_functio
+00045060: 6e5f 6172 6775 6d65 6e74 7328 4c4f 4746  n_arguments(LOGF
+00045070: 494c 452c 2066 7261 6d65 2c20 6675 6e63  ILE, frame, func
+00045080: 3d27 6675 6e63 272c 2069 676e 6f72 653d  ='func', ignore=
+00045090: 5b5d 2c20 7665 7262 6f73 653d 5472 7565  [], verbose=True
+000450a0: 293a 0a20 2020 2022 2222 0a20 2020 204c  ):.    """.    L
+000450b0: 6f67 206c 6f63 616c 2076 6172 6961 626c  og local variabl
+000450c0: 6573 2c20 652e 672e 2c20 7061 7261 6d65  es, e.g., parame
+000450d0: 7465 7220 6172 6775 656d 656e 7473 2074  ter arguements t
+000450e0: 6f20 6120 6669 6c65 0a0a 2020 2020 5061  o a file..    Pa
+000450f0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00045100: 2d2d 2d2d 2d2d 2d0a 2020 2020 4c4f 4746  -------.    LOGF
+00045110: 494c 4520 3a20 7374 7220 6f72 204e 6f6e  ILE : str or Non
+00045120: 650a 2020 2020 2020 2020 4f75 7470 7574  e.        Output
+00045130: 2066 696c 652e 2020 4966 2060 4e6f 6e65   file.  If `None
+00045140: 602c 2074 6865 6e20 666f 7263 6520 6076  `, then force `v
+00045150: 6572 626f 7365 3d54 7275 6560 2e0a 0a20  erbose=True`... 
+00045160: 2020 2066 7261 6d65 203a 2060 7e69 6e73     frame : `~ins
+00045170: 7065 6374 2e63 7572 7265 6e74 6672 616d  pect.currentfram
+00045180: 6528 2960 0a20 2020 2020 2020 204e 616d  e()`.        Nam
+00045190: 6573 7061 6365 206f 626a 6563 742e 0a0a  espace object...
+000451a0: 2020 2020 6675 6e63 203a 2073 7472 0a20      func : str. 
+000451b0: 2020 2020 2020 2046 756e 6374 696f 6e20         Function 
+000451c0: 6e61 6d65 2074 6f20 7573 650a 2020 2020  name to use.    
+000451d0: 0a20 2020 2069 676e 6f72 6520 3a20 6c69  .    ignore : li
+000451e0: 7374 0a20 2020 2020 2020 2056 6172 6961  st.        Varia
+000451f0: 626c 6520 6e61 6d65 7320 746f 2069 676e  ble names to ign
+00045200: 6f72 650a 2020 2020 0a20 2020 2076 6572  ore.    .    ver
+00045210: 626f 7365 203a 2062 6f6f 6c0a 2020 2020  bose : bool.    
+00045220: 2020 2020 5072 696e 7420 6d65 7373 6161      Print messaa
+00045230: 6765 2074 6f20 7374 646f 7574 2e0a 0a20  ge to stdout... 
+00045240: 2020 2022 2222 0a20 2020 2061 7267 7320     """.    args 
+00045250: 3d20 696e 7370 6563 742e 6765 7461 7267  = inspect.getarg
+00045260: 7661 6c75 6573 2866 7261 6d65 292e 6c6f  values(frame).lo
+00045270: 6361 6c73 0a20 2020 2061 7267 732e 706f  cals.    args.po
+00045280: 7028 2766 7261 6d65 2729 0a20 2020 2066  p('frame').    f
+00045290: 6f72 206b 2069 6e20 6c69 7374 2861 7267  or k in list(arg
+000452a0: 732e 6b65 7973 2829 293a 0a20 2020 2020  s.keys()):.     
+000452b0: 2020 2069 6620 6861 7361 7474 7228 6172     if hasattr(ar
+000452c0: 6773 5b6b 5d2c 2027 5f5f 6275 696c 7469  gs[k], '__builti
+000452d0: 6e73 5f5f 2729 3a0a 2020 2020 2020 2020  ns__'):.        
+000452e0: 2020 2020 6172 6773 2e70 6f70 286b 290a      args.pop(k).
+000452f0: 2020 2020 0a20 2020 2066 6f72 206b 2069      .    for k i
+00045300: 6e20 6967 6e6f 7265 3a0a 2020 2020 2020  n ignore:.      
+00045310: 2020 6966 206b 2069 6e20 6172 6773 3a0a    if k in args:.
+00045320: 2020 2020 2020 2020 2020 2020 6172 6773              args
+00045330: 2e70 6f70 286b 290a 2020 2020 2020 2020  .pop(k).        
+00045340: 2020 2020 0a20 2020 2069 6620 6675 6e63      .    if func
+00045350: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00045360: 2020 2020 2020 6c6f 6773 7472 203d 2027        logstr = '
+00045370: 5c6e 7b30 7d28 2a2a 7b31 7d29 5c6e 270a  \n{0}(**{1})\n'.
+00045380: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00045390: 2020 6c6f 6773 7472 203d 2027 5c6e 7b31    logstr = '\n{1
+000453a0: 7d27 0a0a 2020 2020 6c6f 6773 7472 203d  }'..    logstr =
+000453b0: 206c 6f67 7374 722e 666f 726d 6174 2866   logstr.format(f
+000453c0: 756e 632c 2061 7267 7329 0a20 2020 206d  unc, args).    m
+000453d0: 7367 203d 206c 6f67 5f63 6f6d 6d65 6e74  sg = log_comment
+000453e0: 284c 4f47 4649 4c45 2c20 6c6f 6773 7472  (LOGFILE, logstr
+000453f0: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
+00045400: 652c 2073 686f 775f 6461 7465 3d54 7275  e, show_date=Tru
+00045410: 6529 0a0a 2020 2020 7265 7475 726e 206d  e)..    return m
+00045420: 7367 0a0a 0a64 6566 2063 7469 6d65 5f74  sg...def ctime_t
+00045430: 6f5f 6973 6f28 6d74 696d 652c 2066 6f72  o_iso(mtime, for
+00045440: 6d61 743d 2725 6120 2562 2025 6420 2548  mat='%a %b %d %H
+00045450: 3a25 4d3a 2553 2025 5927 2c20 7374 7269  :%M:%S %Y', stri
+00045460: 705f 6465 6369 6d61 6c3d 5472 7565 2c20  p_decimal=True, 
+00045470: 7665 7262 6f73 653d 5472 7565 293a 0a20  verbose=True):. 
+00045480: 2020 2022 2222 0a20 2020 2043 6f6e 7665     """.    Conve
+00045490: 7274 2060 7469 6d65 2e63 7469 6d65 6020  rt `time.ctime` 
+000454a0: 7374 7269 6e67 7320 746f 2049 534f 2064  strings to ISO d
+000454b0: 6174 6573 0a0a 2020 2020 5061 7261 6d65  ates..    Parame
+000454c0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+000454d0: 2d2d 2d0a 2020 2020 6d74 696d 6520 3a20  ---.    mtime : 
+000454e0: 7374 720a 2020 2020 2020 2020 5469 6d65  str.        Time
+000454f0: 2073 7472 696e 672c 2067 656e 6572 616c   string, general
+00045500: 6c79 2061 7320 6f75 7470 7574 2066 726f  ly as output fro
+00045510: 6d20 6074 696d 652e 6374 696d 6560 2c20  m `time.ctime`, 
+00045520: 652e 672e 2c20 0a20 2020 2020 2020 2060  e.g., .        `
+00045530: 6027 4d6f 6e20 5365 7020 3136 2031 313a  `'Mon Sep 16 11:
+00045540: 3233 3a32 3720 3230 3139 2760 600a 0a20  23:27 2019'``.. 
+00045550: 2020 2066 6f72 6d61 7420 3a20 7374 720a     format : str.
+00045560: 2020 2020 2020 2020 6064 6174 6574 696d          `datetim
+00045570: 652e 7374 7270 7469 6d65 6020 666f 726d  e.strptime` form
+00045580: 6174 2073 7472 696e 672c 2063 6f64 6573  at string, codes
+00045590: 2061 7420 0a20 2020 2020 2020 2068 7474   at .        htt
+000455a0: 7073 3a2f 2f77 7777 2e70 726f 6772 616d  ps://www.program
+000455b0: 697a 2e63 6f6d 2f70 7974 686f 6e2d 7072  iz.com/python-pr
+000455c0: 6f67 7261 6d6d 696e 672f 6461 7465 7469  ogramming/dateti
+000455d0: 6d65 2f73 7472 7074 696d 650a 0a20 2020  me/strptime..   
+000455e0: 2073 7472 6970 5f64 6563 696d 616c 203a   strip_decimal :
+000455f0: 2062 6f6f 6c0a 2020 2020 2020 2020 5374   bool.        St
+00045600: 7269 7020 6465 6369 6d61 6c20 7365 636f  rip decimal seco
+00045610: 6e64 7320 6672 6f6d 2065 6e64 206f 6620  nds from end of 
+00045620: 4953 4f20 7374 7269 6e67 0a0a 2020 2020  ISO string..    
+00045630: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
+00045640: 2020 2020 2020 2050 7269 6e74 2061 206d         Print a m
+00045650: 6573 7361 6765 2069 6620 636f 6e76 6572  essage if conver
+00045660: 7369 6f6e 2066 6169 6c73 0a0a 2020 2020  sion fails..    
+00045670: 5265 7475 726e 7320 0a20 2020 202d 2d2d  Returns .    ---
+00045680: 2d2d 2d2d 0a20 2020 2069 736f 203a 2073  ----.    iso : s
+00045690: 7472 0a20 2020 2020 2020 2053 7472 696e  tr.        Strin
+000456a0: 6720 696e 2028 736f 7274 6162 6c65 2920  g in (sortable) 
+000456b0: 4953 4f20 666f 726d 6174 2c20 652e 672e  ISO format, e.g.
+000456c0: 2c20 6060 2732 3031 392d 3039 2d31 3620  , ``'2019-09-16 
+000456d0: 3131 3a32 333a 3237 2e30 3030 2760 600a  11:23:27.000'``.
+000456e0: 0a20 2020 2022 2222 0a20 2020 2066 726f  .    """.    fro
+000456f0: 6d20 6173 7472 6f70 792e 7469 6d65 2069  m astropy.time i
+00045700: 6d70 6f72 7420 5469 6d65 0a20 2020 2066  mport Time.    f
+00045710: 726f 6d20 6461 7465 7469 6d65 2069 6d70  rom datetime imp
+00045720: 6f72 7420 6461 7465 7469 6d65 0a0a 2020  ort datetime..  
+00045730: 2020 2320 4973 2061 6c72 6561 6479 2049    # Is already I
+00045740: 534f 2066 6f72 6d61 740a 2020 2020 6966  SO format.    if
+00045750: 206d 7469 6d65 2e63 6f75 6e74 2827 2d27   mtime.count('-'
+00045760: 2920 3d3d 2032 3a0a 2020 2020 2020 2020  ) == 2:.        
+00045770: 6973 6f20 3d20 6d74 696d 6520 2b20 2727  iso = mtime + ''
+00045780: 0a0a 2020 2020 656c 7365 3a0a 2020 2020  ..    else:.    
+00045790: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000457a0: 2020 2020 2069 736f 203d 2054 696d 6528       iso = Time(
+000457b0: 6461 7465 7469 6d65 2e73 7472 7074 696d  datetime.strptim
+000457c0: 6528 6d74 696d 652c 2066 6f72 6d61 7429  e(mtime, format)
+000457d0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+000457e0: 2020 2020 2020 2020 2020 666f 726d 6174            format
+000457f0: 3d27 6461 7465 7469 6d65 2729 2e69 736f  ='datetime').iso
+00045800: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00045810: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+00045820: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00045830: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00045840: 2020 2020 7072 696e 7428 6627 436f 756c      print(f'Coul
+00045850: 646e 5c27 7420 636f 6e76 6572 7420 5c27  dn\'t convert \'
+00045860: 7b6d 7469 6d65 7d5c 2720 7769 7468 2027  {mtime}\' with '
+00045870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045880: 2020 2020 2020 2066 2766 6f72 6d61 7420         f'format 
+00045890: 5c27 7b66 6f72 6d61 747d 5c27 2729 0a0a  \'{format}\'')..
+000458a0: 2020 2020 2020 2020 2020 2020 6973 6f20              iso 
+000458b0: 3d20 6d74 696d 6520 2b20 2727 0a0a 2020  = mtime + ''..  
+000458c0: 2020 6966 2073 7472 6970 5f64 6563 696d    if strip_decim
+000458d0: 616c 3a0a 2020 2020 2020 2020 6973 6f20  al:.        iso 
+000458e0: 3d20 6973 6f2e 7370 6c69 7428 272e 2729  = iso.split('.')
+000458f0: 5b30 5d0a 0a20 2020 2072 6574 7572 6e20  [0]..    return 
+00045900: 6973 6f0a 0a0a 6465 6620 6e6f 7774 696d  iso...def nowtim
+00045910: 6528 6973 6f3d 5472 7565 293a 0a20 2020  e(iso=True):.   
+00045920: 2022 2222 0a20 2020 2057 7261 7070 6572   """.    Wrapper
+00045930: 2066 6f72 2060 6173 7472 6f70 792e 7469   for `astropy.ti
+00045940: 6d65 2e6e 6f77 600a 0a20 2020 2050 6172  me.now`..    Par
+00045950: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00045960: 2d2d 2d2d 2d2d 0a20 2020 2069 736f 203a  ------.    iso :
+00045970: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+00045980: 2054 7275 652c 2072 6574 7572 6e20 7469   True, return ti
+00045990: 6d65 2069 6e20 4953 4f20 7374 7269 6e67  me in ISO string
+000459a0: 2c20 656c 7365 2072 6574 7572 6e20 5469  , else return Ti
+000459b0: 6d65 206f 626a 6563 740a 0a20 2020 2052  me object..    R
+000459c0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+000459d0: 2d2d 0a20 2020 2074 6e6f 7720 3a20 7374  --.    tnow : st
+000459e0: 720a 2020 2020 2020 2020 5365 6520 6069  r.        See `i
+000459f0: 736f 600a 0a20 2020 2022 2222 0a20 2020  so`..    """.   
+00045a00: 2066 726f 6d20 6173 7472 6f70 792e 7469   from astropy.ti
+00045a10: 6d65 2069 6d70 6f72 7420 5469 6d65 0a20  me import Time. 
+00045a20: 2020 2074 6e6f 7720 3d20 5469 6d65 2e6e     tnow = Time.n
+00045a30: 6f77 2829 0a20 2020 2069 6620 6973 6f3a  ow().    if iso:
+00045a40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00045a50: 746e 6f77 2e69 736f 0a20 2020 2065 6c73  tnow.iso.    els
+00045a60: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00045a70: 6e20 746e 6f77 0a0a 0a64 6566 206c 6f67  n tnow...def log
+00045a80: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
+00045a90: 2c20 636f 6d6d 656e 742c 2076 6572 626f  , comment, verbo
+00045aa0: 7365 3d46 616c 7365 2c20 7368 6f77 5f64  se=False, show_d
+00045ab0: 6174 653d 4661 6c73 652c 206d 6f64 653d  ate=False, mode=
+00045ac0: 2761 2729 3a0a 2020 2020 2222 220a 2020  'a'):.    """.  
+00045ad0: 2020 4c6f 6720 6120 6d65 7373 6167 6520    Log a message 
+00045ae0: 746f 2061 2066 696c 652c 206f 7074 696f  to a file, optio
+00045af0: 6e61 6c6c 7920 696e 636c 7564 696e 6720  nally including 
+00045b00: 6120 6461 7465 2074 6167 0a20 2020 2022  a date tag.    "
+00045b10: 2222 0a20 2020 2069 6d70 6f72 7420 7469  "".    import ti
+00045b20: 6d65 0a0a 2020 2020 6966 2073 686f 775f  me..    if show_
+00045b30: 6461 7465 3a0a 2020 2020 2020 2020 6d73  date:.        ms
+00045b40: 6720 3d20 2723 2028 7b30 7d29 5c6e 272e  g = '# ({0})\n'.
+00045b50: 666f 726d 6174 286e 6f77 7469 6d65 2829  format(nowtime()
+00045b60: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00045b70: 2020 2020 6d73 6720 3d20 2727 0a0a 2020      msg = ''..  
+00045b80: 2020 6d73 6720 2b3d 2027 7b30 7d5c 6e27    msg += '{0}\n'
+00045b90: 2e66 6f72 6d61 7428 636f 6d6d 656e 7429  .format(comment)
+00045ba0: 0a0a 2020 2020 6966 204c 4f47 4649 4c45  ..    if LOGFILE
+00045bb0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00045bc0: 2020 2020 2020 6670 203d 206f 7065 6e28        fp = open(
+00045bd0: 4c4f 4746 494c 452c 206d 6f64 6529 0a20  LOGFILE, mode). 
+00045be0: 2020 2020 2020 2066 702e 7772 6974 6528         fp.write(
+00045bf0: 6d73 6729 0a20 2020 2020 2020 2066 702e  msg).        fp.
+00045c00: 636c 6f73 6528 290a 0a20 2020 2069 6620  close()..    if 
+00045c10: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00045c20: 2070 7269 6e74 286d 7367 5b3a 2d31 5d29   print(msg[:-1])
+00045c30: 0a0a 2020 2020 7265 7475 726e 206d 7367  ..    return msg
+00045c40: 0a0a 0a64 6566 206c 6f67 5f65 7863 6570  ...def log_excep
+00045c50: 7469 6f6e 284c 4f47 4649 4c45 2c20 7472  tion(LOGFILE, tr
+00045c60: 6163 6562 6163 6b2c 2076 6572 626f 7365  aceback, verbose
+00045c70: 3d54 7275 652c 206d 6f64 653d 2761 2729  =True, mode='a')
+00045c80: 3a0a 2020 2020 2222 220a 2020 2020 4c6f  :.    """.    Lo
+00045c90: 6720 6578 6365 7074 696f 6e20 696e 666f  g exception info
+00045ca0: 726d 6174 696f 6e20 746f 2061 2066 696c  rmation to a fil
+00045cb0: 652c 206f 7220 7072 696e 7420 746f 2073  e, or print to s
+00045cc0: 6372 6565 6e0a 0a20 2020 2050 6172 616d  creen..    Param
+00045cd0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00045ce0: 2d2d 2d2d 0a20 2020 204c 4f47 4649 4c45  ----.    LOGFILE
+00045cf0: 203a 2073 7472 206f 7220 4e6f 6e65 0a20   : str or None. 
+00045d00: 2020 2020 2020 204f 7574 7075 7420 6669         Output fi
+00045d10: 6c65 2e20 2049 6620 604e 6f6e 6560 2c20  le.  If `None`, 
+00045d20: 7468 656e 2066 6f72 6365 2060 7665 7262  then force `verb
+00045d30: 6f73 653d 5472 7565 602e 0a0a 2020 2020  ose=True`...    
+00045d40: 7472 6163 6562 6163 6b20 3a20 6275 696c  traceback : buil
+00045d50: 7469 6e20 7472 6163 6562 6163 6b20 6d6f  tin traceback mo
+00045d60: 6475 6c65 0a20 2020 2020 2020 2045 7863  dule.        Exc
+00045d70: 6570 7469 6f6e 2074 7261 6365 6261 636b  eption traceback
+00045d80: 2c20 6672 6f6d 2067 6c6f 6261 6c20 6069  , from global `i
+00045d90: 6d70 6f72 7420 7472 6163 6562 6163 6b60  mport traceback`
+00045da0: 2e0a 0a20 2020 2076 6572 626f 7365 203a  ...    verbose :
+00045db0: 2062 6f6f 6c0a 2020 2020 2020 2020 5072   bool.        Pr
+00045dc0: 696e 7420 6578 6365 7074 696f 6e20 746f  int exception to
+00045dd0: 2073 7464 6f75 742e 0a0a 2020 2020 6d6f   stdout...    mo
+00045de0: 6465 203a 2027 6127 2c20 2777 270a 2020  de : 'a', 'w'.  
+00045df0: 2020 2020 2020 4669 6c65 206d 6f64 6520        File mode 
+00045e00: 6f6e 2060 6f70 656e 284c 4f47 4649 4c45  on `open(LOGFILE
+00045e10: 2c20 6d6f 6465 2960 2c20 692e 652e 2c20  , mode)`, i.e., 
+00045e20: 6170 7065 6e64 206f 7220 7772 6974 652e  append or write.
+00045e30: 0a0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
+00045e40: 706f 7274 2074 696d 650a 0a20 2020 2074  port time..    t
+00045e50: 7261 6365 203d 2074 7261 6365 6261 636b  race = traceback
+00045e60: 2e66 6f72 6d61 745f 6578 6328 6c69 6d69  .format_exc(limi
+00045e70: 743d 3229 0a20 2020 206c 6f67 203d 2027  t=2).    log = '
+00045e80: 5c6e 2323 2323 2323 2323 2323 2323 2323  \n##############
+00045e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00045ea0: 2323 2323 2323 2323 2323 2323 205c 6e27  ############ \n'
+00045eb0: 0a20 2020 206c 6f67 202b 3d20 2723 2021  .    log += '# !
+00045ec0: 2045 7863 6570 7469 6f6e 2028 7b30 7d29   Exception ({0})
+00045ed0: 5c6e 272e 666f 726d 6174 286e 6f77 7469  \n'.format(nowti
+00045ee0: 6d65 2829 290a 2020 2020 6c6f 6720 2b3d  me()).    log +=
+00045ef0: 2027 235c 6e23 2021 272b 275c 6e23 2021   '#\n# !'+'\n# !
+00045f00: 272e 6a6f 696e 2874 7261 6365 2e73 706c  '.join(trace.spl
+00045f10: 6974 2827 5c6e 2729 290a 2020 2020 6c6f  it('\n')).    lo
+00045f20: 6720 2b3d 2027 5c6e 2323 2323 2323 2323  g += '\n########
+00045f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00045f40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00045f50: 2320 5c6e 5c6e 270a 2020 2020 6966 2076  # \n\n'.    if v
+00045f60: 6572 626f 7365 207c 2028 4c4f 4746 494c  erbose | (LOGFIL
+00045f70: 4520 6973 204e 6f6e 6529 3a0a 2020 2020  E is None):.    
+00045f80: 2020 2020 7072 696e 7428 6c6f 6729 0a0a      print(log)..
+00045f90: 2020 2020 6966 204c 4f47 4649 4c45 2069      if LOGFILE i
+00045fa0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00045fb0: 2020 2020 6670 203d 206f 7065 6e28 4c4f      fp = open(LO
+00045fc0: 4746 494c 452c 206d 6f64 6529 0a20 2020  GFILE, mode).   
+00045fd0: 2020 2020 2066 702e 7772 6974 6528 6c6f       fp.write(lo
+00045fe0: 6729 0a20 2020 2020 2020 2066 702e 636c  g).        fp.cl
+00045ff0: 6f73 6528 290a 0a64 6566 2073 696d 706c  ose()..def simpl
+00046000: 655f 4c43 444d 284f 6d30 3d30 2e33 2c20  e_LCDM(Om0=0.3, 
+00046010: 4f64 6530 3d30 2e37 2c20 4830 3d37 302c  Ode0=0.7, H0=70,
+00046020: 204f 6230 3d30 2e30 3436 332c 2054 636d   Ob0=0.0463, Tcm
+00046030: 6230 3d32 2e37 3235 2c20 6e61 6d65 3d4e  b0=2.725, name=N
+00046040: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
+00046050: 2020 5369 6d70 6c65 204c 616d 6264 6143    Simple LambdaC
+00046060: 444d 2063 6f73 6d6f 6c6f 6779 0a20 2020  DM cosmology.   
+00046070: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
+00046080: 2061 7265 2064 6566 696e 6564 2061 7320   are defined as 
+00046090: 696e 2060 7e61 7374 726f 7079 2e63 6f73  in `~astropy.cos
+000460a0: 6d6f 6c6f 6779 2e4c 616d 6264 6143 444d  mology.LambdaCDM
+000460b0: 602e 0a20 2020 200a 2020 2020 2222 220a  `..    .    """.
+000460c0: 2020 2020 6672 6f6d 2061 7374 726f 7079      from astropy
+000460d0: 2e63 6f73 6d6f 6c6f 6779 2069 6d70 6f72  .cosmology impor
+000460e0: 7420 4c61 6d62 6461 4344 4d0a 2020 2020  t LambdaCDM.    
+000460f0: 636f 736d 6f6c 6f67 7920 3d20 4c61 6d62  cosmology = Lamb
+00046100: 6461 4344 4d28 4830 2c20 4f6d 302c 204f  daCDM(H0, Om0, O
+00046110: 6465 302c 2054 636d 6230 3d54 636d 6230  de0, Tcmb0=Tcmb0
+00046120: 2c20 6e61 6d65 3d6e 616d 6529 0a20 2020  , name=name).   
+00046130: 2072 6574 7572 6e20 636f 736d 6f6c 6f67   return cosmolog
+00046140: 790a 0a0a 6465 6620 7069 7865 6c5f 706f  y...def pixel_po
+00046150: 6c79 676f 6e5f 6d61 736b 2870 6f6c 7967  lygon_mask(polyg
+00046160: 6f6e 2c20 7368 6170 652c 2077 6373 3d4e  on, shape, wcs=N
+00046170: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
+00046180: 2020 4d61 6b65 2061 206d 6173 6b20 706f    Make a mask po
+00046190: 696e 7473 2069 6e20 6120 3244 2061 7272  ints in a 2D arr
+000461a0: 6179 2069 6e73 6964 6520 6120 706f 6c79  ay inside a poly
+000461b0: 676f 6e0a 2020 2020 0a20 2020 2050 6172  gon.    .    Par
+000461c0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+000461d0: 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c 7967  ------.    polyg
+000461e0: 6f6e 203a 2073 7472 2c20 2832 2c4d 2920  on : str, (2,M) 
+000461f0: 6172 7261 790a 2020 2020 2020 2020 536f  array.        So
+00046200: 6d65 7468 696e 6720 7468 6174 2060 6772  mething that `gr
+00046210: 697a 6c69 2e75 7469 6c73 2e53 5265 6769  izli.utils.SRegi
+00046220: 6f6e 6020 6361 6e20 7061 7273 6520 6173  on` can parse as
+00046230: 2061 2070 6f6c 7967 6f6e 0a20 2020 200a   a polygon.    .
+00046240: 2020 2020 7368 6170 6520 3a20 7475 706c      shape : tupl
+00046250: 650a 2020 2020 2020 2020 322d 7475 706c  e.        2-tupl
+00046260: 6520 6f66 2069 6d61 6765 2064 696d 656e  e of image dimen
+00046270: 7369 6f6e 730a 2020 2020 0a20 2020 2077  sions.    .    w
+00046280: 6373 203a 2060 6173 7472 6f70 792e 7763  cs : `astropy.wc
+00046290: 732e 5743 5360 0a20 2020 2020 2020 2049  s.WCS`.        I
+000462a0: 6620 7370 6563 6966 6965 642c 2061 7373  f specified, ass
+000462b0: 756d 6520 6060 706f 6c79 676f 6e60 6020  ume ``polygon`` 
+000462c0: 6973 2073 6b79 2063 6f6f 7264 696e 6174  is sky coordinat
+000462d0: 6573 2061 6e64 2074 7261 6e73 666f 726d  es and transform
+000462e0: 2074 6f0a 2020 2020 2020 2020 696d 6167   to.        imag
+000462f0: 652e 0a20 2020 200a 2020 2020 5265 7475  e..    .    Retu
+00046300: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00046310: 2020 2020 6d61 736b 203a 2061 7272 6179      mask : array
+00046320: 0a20 2020 2020 2020 2060 6062 6f6f 6c60  .        ``bool`
+00046330: 6020 6172 7261 7920 7769 7468 2060 6073  ` array with ``s
+00046340: 6861 7065 6060 2074 6861 7420 6973 2060  hape`` that is `
+00046350: 5472 7565 6020 696e 7369 6465 2060 706f  True` inside `po
+00046360: 6c79 676f 6e60 0a20 2020 2022 2222 0a20  lygon`.    """. 
+00046370: 2020 2073 7220 3d20 5352 6567 696f 6e28     sr = SRegion(
+00046380: 706f 6c79 676f 6e2c 2077 7261 703d 4661  polygon, wrap=Fa
+00046390: 6c73 6529 0a20 2020 200a 2020 2020 7970  lse).    .    yp
+000463a0: 2c20 7870 203d 206e 702e 696e 6469 6365  , xp = np.indice
+000463b0: 7328 7368 6170 6529 0a20 2020 2070 7473  s(shape).    pts
+000463c0: 203d 206e 702e 6172 7261 7928 5b78 702e   = np.array([xp.
+000463d0: 666c 6174 7465 6e28 292c 2079 702e 666c  flatten(), yp.fl
+000463e0: 6174 7465 6e28 295d 292e 540a 2020 2020  atten()]).T.    
+000463f0: 0a20 2020 2069 6620 7763 7320 6973 206e  .    if wcs is n
+00046400: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00046410: 2070 7473 203d 2077 6373 2e61 6c6c 5f70   pts = wcs.all_p
+00046420: 6978 3277 6f72 6c64 2870 7473 2c20 3029  ix2world(pts, 0)
+00046430: 0a20 2020 2020 2020 200a 2020 2020 6d61  .        .    ma
+00046440: 736b 203d 206e 702e 7a65 726f 7328 7368  sk = np.zeros(sh
+00046450: 6170 652c 2064 7479 7065 3d62 6f6f 6c29  ape, dtype=bool)
+00046460: 2e66 6c61 7474 656e 2829 0a20 2020 2066  .flatten().    f
+00046470: 6f72 2070 2069 6e20 7372 2e70 6174 683a  or p in sr.path:
+00046480: 0a20 2020 2020 2020 206d 6173 6b20 7c3d  .        mask |=
+00046490: 2070 2e63 6f6e 7461 696e 735f 706f 696e   p.contains_poin
+000464a0: 7473 2870 7473 290a 2020 2020 0a20 2020  ts(pts).    .   
+000464b0: 2072 6574 7572 6e20 6d61 736b 2e72 6573   return mask.res
+000464c0: 6861 7065 2873 6861 7065 290a 0a0a 6465  hape(shape)...de
+000464d0: 6620 6d61 6b65 5f66 696c 7465 725f 666f  f make_filter_fo
+000464e0: 6f74 7072 696e 7428 6669 6c74 6572 5f73  otprint(filter_s
+000464f0: 697a 653d 3731 2c20 6669 6c74 6572 5f63  ize=71, filter_c
+00046500: 656e 7472 616c 3d30 2c20 2a2a 6b77 6172  entral=0, **kwar
+00046510: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
+00046520: 204d 616b 6520 6120 666f 6f74 7072 696e   Make a footprin
+00046530: 7420 666f 7220 696d 6167 6520 6669 6c74  t for image filt
+00046540: 6572 696e 670a 2020 2020 2222 220a 2020  ering.    """.  
+00046550: 2020 6669 6c74 6572 5f66 6f6f 7470 7269    filter_footpri
+00046560: 6e74 203d 206e 702e 6f6e 6573 2866 696c  nt = np.ones(fil
+00046570: 7465 725f 7369 7a65 2c20 6474 7970 653d  ter_size, dtype=
+00046580: 696e 7429 0a20 2020 200a 2020 2020 6966  int).    .    if
+00046590: 2066 696c 7465 725f 6365 6e74 7261 6c20   filter_central 
+000465a0: 3e20 303a 0a20 2020 2020 2020 2066 3020  > 0:.        f0 
+000465b0: 3d20 2866 696c 7465 725f 7369 7a65 2d31  = (filter_size-1
+000465c0: 292f 2f32 0a20 2020 2020 2020 2066 696c  )//2.        fil
+000465d0: 7465 725f 666f 6f74 7072 696e 745b 6630  ter_footprint[f0
+000465e0: 2d66 696c 7465 725f 6365 6e74 7261 6c3a  -filter_central:
+000465f0: 6630 2b66 696c 7465 725f 6365 6e74 7261  f0+filter_centra
+00046600: 6c5d 203d 2030 0a20 2020 200a 2020 2020  l] = 0.    .    
+00046610: 7265 7475 726e 2066 696c 7465 725f 666f  return filter_fo
+00046620: 6f74 7072 696e 740a 0a0a 6465 6620 7361  otprint...def sa
+00046630: 6665 5f6e 616e 6d65 6469 616e 5f66 696c  fe_nanmedian_fil
+00046640: 7465 7228 6461 7461 2c20 6669 6c74 6572  ter(data, filter
+00046650: 5f6b 7761 7267 733d 7b7d 2c20 6669 6c74  _kwargs={}, filt
+00046660: 6572 5f66 6f6f 7470 7269 6e74 3d4e 6f6e  er_footprint=Non
+00046670: 652c 2061 7869 733d 312c 2063 6c65 616e  e, axis=1, clean
+00046680: 3d54 7275 652c 2063 7661 6c3d 302e 3029  =True, cval=0.0)
+00046690: 3a0a 2020 2020 2222 220a 2020 2020 5275  :.    """.    Ru
+000466a0: 6e20 6e61 6e6d 6564 6961 6e20 6669 6c74  n nanmedian filt
+000466b0: 6572 206f 6e20 6064 6174 6160 0a20 2020  er on `data`.   
+000466c0: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
+000466d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000466e0: 2020 2020 6461 7461 203a 2061 7272 6179      data : array
+000466f0: 2d6c 696b 650a 2020 2020 2020 2020 5468  -like.        Th
+00046700: 6520 3244 2064 6174 6120 746f 2066 696c  e 2D data to fil
+00046710: 7465 720a 2020 2020 0a20 2020 2066 696c  ter.    .    fil
+00046720: 7465 725f 6b77 6172 6773 203a 2064 6963  ter_kwargs : dic
+00046730: 740a 2020 2020 2020 2020 4172 6775 6d65  t.        Argume
+00046740: 6e74 7320 746f 2060 7e67 7269 7a6c 692e  nts to `~grizli.
+00046750: 7574 696c 732e 6d61 6b65 5f66 696c 7465  utils.make_filte
+00046760: 725f 666f 6f74 7072 696e 7460 2074 6f20  r_footprint` to 
+00046770: 6d61 6b65 2061 2031 4420 6669 6c74 6572  make a 1D filter
+00046780: 0a20 2020 200a 2020 2020 6669 6c74 6572  .    .    filter
+00046790: 5f66 6f6f 7470 7269 6e74 203a 2061 7272  _footprint : arr
+000467a0: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
+000467b0: 5370 6563 6966 7920 7468 6520 6669 6c74  Specify the filt
+000467c0: 6572 2065 7870 6c69 6369 746c 792e 2020  er explicitly.  
+000467d0: 4966 2031 442c 2074 6865 6e20 7769 6c6c  If 1D, then will
+000467e0: 2061 7070 6c79 2074 6865 2066 696c 7465   apply the filte
+000467f0: 7220 6f76 6572 0a20 2020 2020 2020 2060  r over.        `
+00046800: 6178 6973 3d31 6020 2869 2e65 2e2c 2060  axis=1` (i.e., `
+00046810: 7860 2920 6f66 2060 6064 6174 6160 600a  x`) of ``data``.
+00046820: 2020 2020 0a20 2020 2061 7869 7320 3a20      .    axis : 
+00046830: 3020 6f72 2031 0a20 2020 2020 2020 2020  0 or 1.         
+00046840: 4178 6973 206f 7665 7220 7768 6963 6820  Axis over which 
+00046850: 746f 2061 7070 6c79 2074 6865 2066 696c  to apply the fil
+00046860: 7465 7220 2860 6061 7869 733d 3160 6020  ter (``axis=1`` 
+00046870: 6669 6c74 6572 7320 6f6e 2072 6f77 7329  filters on rows)
+00046880: 0a20 2020 200a 2020 2020 636c 6561 6e2c  .    .    clean,
+00046890: 2063 7661 6c20 3a20 626f 6f6c 2c20 7363   cval : bool, sc
+000468a0: 616c 6172 0a20 2020 2020 2020 2052 6570  alar.        Rep
+000468b0: 6c61 6365 2060 7e6e 756d 7079 2e6e 616e  lace `~numpy.nan
+000468c0: 6020 696e 2074 6865 206f 7574 7075 7420  ` in the output 
+000468d0: 7769 7468 2060 6063 7661 6c60 600a 2020  with ``cval``.  
+000468e0: 2020 0a20 2020 2052 6574 7572 6e73 0a20    .    Returns. 
+000468f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2066     -------.    f
+00046900: 696c 7465 725f 6461 7461 203a 2061 7272  ilter_data : arr
+00046910: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
+00046920: 4669 6c74 6572 6564 2064 6174 610a 2020  Filtered data.  
+00046930: 2020 0a20 2020 2066 696c 7465 725f 6e61    .    filter_na
+00046940: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
+00046950: 2054 6865 2074 7970 6520 6f66 2066 696c   The type of fil
+00046960: 7465 7220 7468 6174 2077 6173 2061 7070  ter that was app
+00046970: 6c69 6564 3a20 606e 6275 7469 6c73 2e6e  lied: `nbutils.n
+00046980: 616e 6d65 6469 616e 6020 6966 200a 2020  anmedian` if .  
+00046990: 2020 2020 2020 607e 6772 697a 6c69 2e6e        `~grizli.n
+000469a0: 6275 7469 6c73 2e6e 616e 6d65 6469 616e  butils.nanmedian
+000469b0: 6020 7761 7320 696d 706f 7274 6564 2073  ` was imported s
+000469c0: 7563 6365 7373 6675 6c6c 7920 616e 6420  uccessfully and 
+000469d0: 0a20 2020 2020 2020 2060 6d65 6469 616e  .        `median
+000469e0: 5f66 696c 7465 7260 2066 6f72 2074 6865  _filter` for the
+000469f0: 2066 616c 6c62 6163 6b20 746f 2060 7363   fallback to `sc
+00046a00: 6970 2e6e 6469 6d61 6765 2e6d 6564 6961  ip.ndimage.media
+00046a10: 6e5f 6669 6c74 6572 6020 0a20 2020 2020  n_filter` .     
+00046a20: 2020 206f 7468 6572 7769 7365 2e0a 2020     otherwise..  
+00046a30: 2020 2222 220a 2020 2020 696d 706f 7274    """.    import
+00046a40: 2073 6369 7079 2e6e 6469 6d61 6765 2061   scipy.ndimage a
+00046a50: 7320 6e64 0a20 2020 200a 2020 2020 7472  s nd.    .    tr
+00046a60: 793a 0a20 2020 2020 2020 2066 726f 6d20  y:.        from 
+00046a70: 2e20 696d 706f 7274 206e 6275 7469 6c73  . import nbutils
+00046a80: 0a20 2020 2020 2020 205f 6669 6c74 6572  .        _filter
+00046a90: 5f6e 616d 6520 3d20 276e 6275 7469 6c73  _name = 'nbutils
+00046aa0: 2e6e 616e 6d65 6469 616e 270a 2020 2020  .nanmedian'.    
+00046ab0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00046ac0: 6e62 7574 696c 7320 3d20 4e6f 6e65 0a20  nbutils = None. 
+00046ad0: 2020 2020 2020 205f 6669 6c74 6572 5f6e         _filter_n
+00046ae0: 616d 6520 3d20 276d 6564 6961 6e5f 6669  ame = 'median_fi
+00046af0: 6c74 6572 270a 2020 2020 0a20 2020 2069  lter'.    .    i
+00046b00: 6620 6669 6c74 6572 5f66 6f6f 7470 7269  f filter_footpri
+00046b10: 6e74 2069 7320 4e6f 6e65 3a0a 2020 2020  nt is None:.    
+00046b20: 2020 2020 5f66 696c 7465 725f 666f 6f74      _filter_foot
+00046b30: 7072 696e 7420 3d20 6d61 6b65 5f66 696c  print = make_fil
+00046b40: 7465 725f 666f 6f74 7072 696e 7428 2a2a  ter_footprint(**
+00046b50: 6669 6c74 6572 5f6b 7761 7267 7329 0a20  filter_kwargs). 
+00046b60: 2020 2020 2020 2069 6620 6178 6973 203d         if axis =
+00046b70: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00046b80: 205f 6669 6c74 6572 5f66 6f6f 7470 7269   _filter_footpri
+00046b90: 6e74 203d 205f 6669 6c74 6572 5f66 6f6f  nt = _filter_foo
+00046ba0: 7470 7269 6e74 5b4e 6f6e 652c 3a5d 0a20  tprint[None,:]. 
+00046bb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00046bc0: 2020 2020 2020 2020 205f 6669 6c74 6572           _filter
+00046bd0: 5f66 6f6f 7470 7269 6e74 203d 205f 6669  _footprint = _fi
+00046be0: 6c74 6572 5f66 6f6f 7470 7269 6e74 5b3a  lter_footprint[:
+00046bf0: 2c4e 6f6e 655d 0a20 2020 2065 6c73 653a  ,None].    else:
+00046c00: 0a20 2020 2020 2020 2069 6620 6669 6c74  .        if filt
+00046c10: 6572 5f66 6f6f 7470 7269 6e74 2e6e 6469  er_footprint.ndi
+00046c20: 6d20 3d3d 2031 3a0a 2020 2020 2020 2020  m == 1:.        
+00046c30: 2020 2020 6966 2061 7869 7320 3d3d 2031      if axis == 1
+00046c40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00046c50: 2020 5f66 696c 7465 725f 666f 6f74 7072    _filter_footpr
+00046c60: 696e 7420 3d20 6669 6c74 6572 5f66 6f6f  int = filter_foo
+00046c70: 7470 7269 6e74 5b4e 6f6e 652c 3a5d 0a20  tprint[None,:]. 
+00046c80: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00046c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046ca0: 205f 6669 6c74 6572 5f66 6f6f 7470 7269   _filter_footpri
+00046cb0: 6e74 203d 2066 696c 7465 725f 666f 6f74  nt = filter_foot
+00046cc0: 7072 696e 745b 3a2c 4e6f 6e65 5d0a 2020  print[:,None].  
+00046cd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00046ce0: 2020 2020 2020 2020 5f66 696c 7465 725f          _filter_
+00046cf0: 666f 6f74 7072 696e 7420 3d20 6669 6c74  footprint = filt
+00046d00: 6572 5f66 6f6f 7470 7269 6e74 0a20 2020  er_footprint.   
+00046d10: 200a 2020 2020 6966 206e 6275 7469 6c73   .    if nbutils
+00046d20: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00046d30: 2020 6669 6c74 6572 5f64 6174 6120 3d20    filter_data = 
+00046d40: 6e64 2e6d 6564 6961 6e5f 6669 6c74 6572  nd.median_filter
+00046d50: 2864 6174 612c 2066 6f6f 7470 7269 6e74  (data, footprint
+00046d60: 3d5f 6669 6c74 6572 5f66 6f6f 7470 7269  =_filter_footpri
+00046d70: 6e74 290a 2020 2020 656c 7365 3a0a 2020  nt).    else:.  
+00046d80: 2020 2020 2020 6669 6c74 6572 5f64 6174        filter_dat
+00046d90: 6120 3d20 6e64 2e67 656e 6572 6963 5f66  a = nd.generic_f
+00046da0: 696c 7465 7228 6461 7461 2c20 6e62 7574  ilter(data, nbut
+00046db0: 696c 732e 6e61 6e6d 6564 6961 6e2c 0a20  ils.nanmedian,. 
+00046dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046de0: 2020 2020 2020 2066 6f6f 7470 7269 6e74         footprint
+00046df0: 3d5f 6669 6c74 6572 5f66 6f6f 7470 7269  =_filter_footpri
+00046e00: 6e74 290a 2020 2020 2020 2020 6966 2063  nt).        if c
+00046e10: 6c65 616e 3a0a 2020 2020 2020 2020 2020  lean:.          
+00046e20: 2020 6669 6c74 6572 5f64 6174 615b 7e6e    filter_data[~n
+00046e30: 702e 6973 6669 6e69 7465 2866 696c 7465  p.isfinite(filte
+00046e40: 725f 6461 7461 295d 203d 2063 7661 6c0a  r_data)] = cval.
+00046e50: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00046e60: 2072 6574 7572 6e20 6669 6c74 6572 5f64   return filter_d
+00046e70: 6174 612c 205f 6669 6c74 6572 5f6e 616d  ata, _filter_nam
+00046e80: 650a 0a0a 6465 6620 6172 6776 5f74 6f5f  e...def argv_to_
+00046e90: 6469 6374 2861 7267 762c 2064 6566 6175  dict(argv, defau
+00046ea0: 6c74 733d 7b7d 2c20 646f 745f 6469 6374  lts={}, dot_dict
+00046eb0: 3d54 7275 6529 3a0a 2020 2020 2222 220a  =True):.    """.
+00046ec0: 2020 2020 436f 6e76 6572 7420 6120 6c69      Convert a li
+00046ed0: 7374 206f 6620 2873 696d 706c 6529 2063  st of (simple) c
+00046ee0: 6f6d 6d61 6e64 2d6c 696e 6520 6172 6775  ommand-line argu
+00046ef0: 6d65 6e74 7320 746f 2061 2064 6963 7469  ments to a dicti
+00046f00: 6f6e 6172 792e 0a20 2020 200a 2020 2020  onary..    .    
+00046f10: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00046f20: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6172  ---------.    ar
+00046f30: 6776 203a 206c 6973 7420 6f66 2073 7472  gv : list of str
+00046f40: 696e 6773 0a20 2020 2020 2020 2045 2e67  ings.        E.g
+00046f50: 2e2c 2060 6073 7973 2e61 7267 765b 313a  ., ``sys.argv[1:
+00046f60: 5d60 602e 0a20 2020 200a 2020 2020 6465  ]``..    .    de
+00046f70: 6661 756c 7473 203a 2064 6963 740a 2020  faults : dict.  
+00046f80: 2020 2020 2020 4465 6661 756c 7420 6469        Default di
+00046f90: 6374 696f 6e61 7279 0a20 2020 200a 2020  ctionary.    .  
+00046fa0: 2020 646f 745f 6469 6374 203a 2062 6f6f    dot_dict : boo
+00046fb0: 6c0a 2020 2020 2020 2020 4966 2074 7275  l.        If tru
+00046fc0: 652c 2074 6865 6e20 696e 7465 7072 6574  e, then intepret
+00046fd0: 206b 6579 776f 7264 7320 7769 7468 2027   keywords with '
+00046fe0: 2e27 2061 7320 6e65 7374 6564 2064 6963  .' as nested dic
+00046ff0: 7469 6f6e 6172 7920 6b65 7973 2c20 0a20  tionary keys, . 
+00047000: 2020 2020 2020 2065 2e67 2e2c 2060 602d         e.g., ``-
+00047010: 2d64 2e6b 6579 3d76 616c 6060 203e 3e20  -d.key=val`` >> 
+00047020: 7b27 6427 3a20 7b27 6b65 7927 3a20 2776  {'d': {'key': 'v
+00047030: 616c 277d 7d0a 2020 2020 2020 2020 0a20  al'}}.        . 
+00047040: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
+00047050: 2d2d 2d2d 2d2d 2d2d 0a20 2020 200a 2020  --------.    .  
+00047060: 2020 2020 2020 2320 2420 6d79 6675 6e63        # $ myfunc
+00047070: 2061 7267 3120 2d2d 7031 3d31 202d 2d6c   arg1 --p1=1 --l
+00047080: 313d 312c 322c 3320 2d2d 7064 6963 742e  1=1,2,3 --pdict.
+00047090: 6b31 3d31 202d 666c 6167 0a20 2020 2020  k1=1 -flag.     
+000470a0: 2020 203e 3e3e 2061 7267 7620 3d20 2761     >>> argv = 'a
+000470b0: 7267 3120 2d2d 7031 3d31 202d 2d6c 313d  rg1 --p1=1 --l1=
+000470c0: 312c 322c 3320 2d2d 7064 6963 742e 6b31  1,2,3 --pdict.k1
+000470d0: 3d31 202d 666c 6167 272e 7370 6c69 7428  =1 -flag'.split(
+000470e0: 290a 2020 2020 2020 2020 3e3e 3e20 6172  ).        >>> ar
+000470f0: 6773 2c20 6b77 6172 6773 203d 2061 7267  gs, kwargs = arg
+00047100: 765f 746f 5f64 6963 7428 6172 6776 290a  v_to_dict(argv).
+00047110: 2020 2020 2020 2020 3e3e 3e20 7072 696e          >>> prin
+00047120: 7428 6172 6773 290a 2020 2020 2020 2020  t(args).        
+00047130: 5b27 6172 6731 275d 0a20 2020 2020 2020  ['arg1'].       
+00047140: 203e 3e3e 2070 7269 6e74 286b 7761 7267   >>> print(kwarg
+00047150: 7329 0a20 2020 2020 2020 207b 2770 3127  s).        {'p1'
+00047160: 3a20 312c 2027 6c31 273a 205b 312c 2032  : 1, 'l1': [1, 2
+00047170: 2c20 335d 2c20 2770 6469 6374 273a 207b  , 3], 'pdict': {
+00047180: 276b 3127 3a20 317d 2c20 2766 6c61 6727  'k1': 1}, 'flag'
+00047190: 3a20 5472 7565 7d0a 2020 2020 2020 2020  : True}.        
+000471a0: 0a20 2020 2020 2020 2023 2057 6974 6820  .        # With 
+000471b0: 6465 6661 756c 7473 0a20 2020 2020 2020  defaults.       
+000471c0: 2064 6566 6175 6c74 7320 3d20 7b27 7064   defaults = {'pd
+000471d0: 6963 7427 3a7b 276b 3227 3a32 2e30 7d2c  ict':{'k2':2.0},
+000471e0: 2027 7032 273a 322e 307d 0a20 2020 2020   'p2':2.0}.     
+000471f0: 2020 203e 3e3e 2061 7267 732c 206b 7761     >>> args, kwa
+00047200: 7267 7320 3d20 6172 6776 5f74 6f5f 6469  rgs = argv_to_di
+00047210: 6374 2861 7267 762c 2064 6566 6175 6c74  ct(argv, default
+00047220: 733d 6465 6661 756c 7473 290a 2020 2020  s=defaults).    
+00047230: 2020 2020 3e3e 3e20 7072 696e 7428 6b77      >>> print(kw
+00047240: 6172 6773 290a 2020 2020 2020 2020 7b27  args).        {'
+00047250: 7064 6963 7427 3a20 7b27 6b32 273a 2032  pdict': {'k2': 2
+00047260: 2e30 2c20 276b 3127 3a20 317d 2c20 2770  .0, 'k1': 1}, 'p
+00047270: 3227 3a20 322e 302c 2027 7031 273a 2031  2': 2.0, 'p1': 1
+00047280: 2c20 276c 3127 3a20 5b31 2c20 322c 2033  , 'l1': [1, 2, 3
+00047290: 5d2c 2027 666c 6167 273a 2054 7275 657d  ], 'flag': True}
+000472a0: 0a20 2020 2020 2020 200a 2020 2020 2222  .        .    ""
+000472b0: 220a 2020 2020 696d 706f 7274 2063 6f70  ".    import cop
+000472c0: 790a 2020 2020 696d 706f 7274 206a 736f  y.    import jso
+000472d0: 6e0a 2020 2020 0a20 2020 206b 7761 7267  n.    .    kwarg
+000472e0: 7320 3d20 636f 7079 2e64 6565 7063 6f70  s = copy.deepcop
+000472f0: 7928 6465 6661 756c 7473 290a 2020 2020  y(defaults).    
+00047300: 6172 6773 203d 205b 5d0a 2020 2020 0a20  args = [].    . 
+00047310: 2020 2066 6f72 2069 2c20 6172 6720 696e     for i, arg in
+00047320: 2065 6e75 6d65 7261 7465 2861 7267 7629   enumerate(argv)
+00047330: 3a20 2020 2020 2020 200a 2020 2020 2020  :        .      
+00047340: 2020 6966 206e 6f74 2061 7267 2e73 7461    if not arg.sta
+00047350: 7274 7377 6974 6828 272d 2729 3a0a 2020  rtswith('-'):.  
+00047360: 2020 2020 2020 2020 2020 2320 4172 6775            # Argu
+00047370: 6d65 6e74 730a 2020 2020 2020 2020 2020  ments.          
+00047380: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00047390: 2020 2020 2020 2061 7267 732e 6170 7065         args.appe
+000473a0: 6e64 286a 736f 6e2e 6c6f 6164 7328 6172  nd(json.loads(ar
+000473b0: 6729 290a 2020 2020 2020 2020 2020 2020  g)).            
+000473c0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+000473d0: 2020 2020 2020 2020 6172 6773 2e61 7070          args.app
+000473e0: 656e 6428 6a73 6f6e 2e6c 6f61 6473 2866  end(json.loads(f
+000473f0: 2722 7b61 7267 7d22 2729 290a 2020 2020  '"{arg}"')).    
+00047400: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00047410: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00047420: 650a 2020 2020 2020 2020 2020 2020 0a20  e.            . 
+00047430: 2020 2020 2020 2073 706c 203d 2061 7267         spl = arg
+00047440: 2e73 7472 6970 2827 2d2d 2729 2e73 706c  .strip('--').spl
+00047450: 6974 2827 3d27 290a 2020 2020 2020 2020  it('=').        
+00047460: 6966 206c 656e 2873 706c 2920 3e20 313a  if len(spl) > 1:
+00047470: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00047480: 6172 616d 6574 6572 2076 616c 7565 730a  arameter values.
+00047490: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+000474a0: 2076 616c 203d 2073 706c 0a20 2020 2020   val = spl.     
+000474b0: 2020 2020 2020 2076 616c 203d 2076 616c         val = val
+000474c0: 2e72 6570 6c61 6365 2827 5472 7565 272c  .replace('True',
+000474d0: 2774 7275 6527 292e 7265 706c 6163 6528  'true').replace(
+000474e0: 2746 616c 7365 272c 2766 616c 7365 2729  'False','false')
+000474f0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+00047500: 203d 2076 616c 2e72 6570 6c61 6365 2827   = val.replace('
+00047510: 4e6f 6e65 272c 276e 756c 6c27 290a 2020  None','null').  
+00047520: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00047530: 2020 2020 2020 2020 2320 5061 7261 6d65          # Parame
+00047540: 7465 7273 2c20 7365 7420 746f 2074 7275  ters, set to tru
+00047550: 652c 2065 2e67 2e2c 202d 7365 745f 666c  e, e.g., -set_fl
+00047560: 6167 0a20 2020 2020 2020 2020 2020 206b  ag.            k
+00047570: 6579 2c20 7661 6c20 3d20 7370 6c5b 305d  ey, val = spl[0]
+00047580: 2c20 2774 7275 6527 0a20 2020 2020 2020  , 'true'.       
+00047590: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000475a0: 2020 2320 7369 6e67 6c65 202d 0a20 2020    # single -.   
+000475b0: 2020 2020 2020 2020 2069 6620 6b65 792e           if key.
+000475c0: 7374 6172 7473 7769 7468 2827 2d27 293a  startswith('-'):
+000475d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000475e0: 206b 6579 203d 206b 6579 5b31 3a5d 0a20   key = key[1:]. 
+000475f0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00047600: 2320 4c69 7374 2076 616c 7565 7320 2020  # List values   
+00047610: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00047620: 2027 2c27 2069 6e20 7661 6c3a 0a20 2020   ',' in val:.   
+00047630: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00047640: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00047650: 5472 7920 7061 7273 696e 6720 7769 7468  Try parsing with
+00047660: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
+00047670: 2020 2020 2020 6a76 616c 203d 206a 736f        jval = jso
+00047680: 6e2e 6c6f 6164 7328 6627 5b7b 7661 6c7d  n.loads(f'[{val}
+00047690: 5d27 290a 2020 2020 2020 2020 2020 2020  ]').            
+000476a0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+000476b0: 2020 2020 2020 2020 2320 4173 7375 6d65          # Assume
+000476c0: 2073 7472 696e 6773 0a20 2020 2020 2020   strings.       
+000476d0: 2020 2020 2020 2020 2073 7472 5f76 616c           str_val
+000476e0: 203d 2027 2c27 2e6a 6f69 6e28 5b66 2722   = ','.join([f'"
+000476f0: 7b76 7d22 2720 666f 7220 7620 696e 2076  {v}"' for v in v
+00047700: 616c 2e73 706c 6974 2827 2c27 295d 290a  al.split(',')]).
+00047710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047720: 6a76 616c 203d 206a 736f 6e2e 6c6f 6164  jval = json.load
+00047730: 7328 6627 5b7b 7374 725f 7661 6c7d 5d27  s(f'[{str_val}]'
+00047740: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00047750: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00047760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047770: 206a 7661 6c20 3d20 6a73 6f6e 2e6c 6f61   jval = json.loa
+00047780: 6473 2876 616c 290a 2020 2020 2020 2020  ds(val).        
+00047790: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+000477a0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+000477b0: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
+000477c0: 2020 2020 206a 7661 6c20 3d20 7661 6c0a       jval = val.
+000477d0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000477e0: 2023 2044 6963 7420 6b65 7973 2c20 706f   # Dict keys, po
+000477f0: 7465 6e74 6961 6c6c 7920 6e65 7374 6564  tentially nested
+00047800: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00047810: 2069 6620 646f 745f 6469 6374 2026 2028   if dot_dict & (
+00047820: 272e 2720 696e 206b 6579 293a 0a20 2020  '.' in key):.   
+00047830: 2020 2020 2020 2020 206b 6579 7320 3d20           keys = 
+00047840: 6b65 792e 7370 6c69 7428 272e 2729 0a20  key.split('.'). 
+00047850: 2020 2020 2020 2020 2020 2064 203d 206b             d = k
+00047860: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+00047870: 2020 666f 7220 6b20 696e 206b 6579 735b    for k in keys[
+00047880: 3a2d 315d 3a0a 2020 2020 2020 2020 2020  :-1]:.          
+00047890: 2020 2020 2020 6966 206b 206e 6f74 2069        if k not i
+000478a0: 6e20 643a 0a20 2020 2020 2020 2020 2020  n d:.           
+000478b0: 2020 2020 2020 2020 2064 5b6b 5d20 3d20           d[k] = 
+000478c0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
+000478d0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+000478e0: 2020 2020 6420 3d20 645b 6b5d 0a20 2020      d = d[k].   
+000478f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047900: 200a 2020 2020 2020 2020 2020 2020 645b   .            d[
+00047910: 6b65 7973 5b2d 315d 5d20 3d20 6a76 616c  keys[-1]] = jval
+00047920: 0a20 2020 2020 2020 2065 6c73 653a 2020  .        else:  
+00047930: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00047940: 2020 2020 2020 206b 7761 7267 735b 6b65         kwargs[ke
+00047950: 795d 203d 206a 7661 6c0a 2020 2020 2020  y] = jval.      
+00047960: 2020 2020 2020 0a20 2020 200a 2020 2020        .    .    
+00047970: 7265 7475 726e 2061 7267 732c 206b 7761  return args, kwa
+00047980: 7267 730a 0a0a 636c 6173 7320 556e 6971  rgs...class Uniq
+00047990: 7565 286f 626a 6563 7429 3a0a 2020 2020  ue(object):.    
+000479a0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000479b0: 662c 2061 7272 6179 2c20 7665 7262 6f73  f, array, verbos
+000479c0: 653d 5472 7565 293a 0a20 2020 2020 2020  e=True):.       
+000479d0: 2022 2222 0a20 2020 2020 2020 2048 656c   """.        Hel
+000479e0: 7065 7220 666f 7220 756e 6971 7565 2069  per for unique i
+000479f0: 7465 6d73 2069 6e20 616e 2061 7272 6179  tems in an array
+00047a00: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00047a10: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00047a20: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+00047a30: 2020 2020 2020 2020 6172 7261 7920 3a20          array : 
+00047a40: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+00047a50: 2020 2020 2020 2044 6174 6120 746f 2070         Data to p
+00047a60: 6172 7365 2c20 6765 6e65 7261 6c6c 7920  arse, generally 
+00047a70: 7374 7269 6e67 7320 6275 7420 6361 6e20  strings but can 
+00047a80: 6265 2061 6e79 7468 696e 6720 7468 6174  be anything that
+00047a90: 2063 616e 200a 2020 2020 2020 2020 2020   can .          
+00047aa0: 2020 6265 2070 6172 7365 6420 6279 2060    be parsed by `
+00047ab0: 6e75 6d70 792e 756e 6971 7565 600a 0a0a  numpy.unique`...
+00047ac0: 2020 2020 2020 2020 4174 7472 6962 7574          Attribut
+00047ad0: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
+00047ae0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6469  -----.        di
+00047af0: 6d20 3a20 696e 740a 2020 2020 2020 2020  m : int.        
+00047b00: 2020 2020 6060 7369 7a65 6060 206f 6620      ``size`` of 
+00047b10: 696e 7075 7420 6060 6172 7261 7960 600a  input ``array``.
+00047b20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00047b30: 2076 616c 7565 7320 3a20 6c69 7374 0a20   values : list. 
+00047b40: 2020 2020 2020 2020 2020 2055 6e69 7175             Uniqu
+00047b50: 6520 656c 656d 656e 7473 206f 6620 6060  e elements of ``
+00047b60: 6172 7261 7960 600a 2020 2020 2020 2020  array``.        
+00047b70: 0a20 2020 2020 2020 2069 6e64 6963 6573  .        indices
+00047b80: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00047b90: 2020 2020 496e 7465 6765 7220 6c69 7374      Integer list
+00047ba0: 206c 656e 6774 6820 6f66 2060 6061 7272   length of ``arr
+00047bb0: 6179 6060 2077 6974 6820 7468 6520 696e  ay`` with the in
+00047bc0: 6469 6365 7320 6f66 2060 6076 616c 7565  dices of ``value
+00047bd0: 7360 600a 2020 2020 2020 2020 2020 2020  s``.            
+00047be0: 666f 7220 6561 6368 2065 6c65 6d65 6e74  for each element
+00047bf0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00047c00: 2020 636f 756e 7473 203a 206c 6973 740a    counts : list.
+00047c10: 2020 2020 2020 2020 2020 2020 436f 756e              Coun
+00047c20: 7473 206f 6620 6561 6368 2065 6c65 6d65  ts of each eleme
+00047c30: 6e74 206f 6620 6060 7661 6c75 6573 6060  nt of ``values``
+00047c40: 0a20 2020 2020 2020 200a 0a20 2020 2020  .        ..     
+00047c50: 2020 204d 6574 686f 6473 0a20 2020 2020     Methods.     
+00047c60: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00047c70: 2020 205f 5f67 6574 5f5f 286b 6579 290a     __get__(key).
+00047c80: 2020 2020 2020 2020 2020 2020 5265 7475              Retu
+00047c90: 726e 2061 2060 626f 6f6c 6020 6172 7261  rn a `bool` arra
+00047ca0: 7920 7768 6572 6520 656e 7472 6965 7320  y where entries 
+00047cb0: 6f66 2060 6061 7272 6179 6060 206d 6174  of ``array`` mat
+00047cc0: 6368 2074 6865 200a 2020 2020 2020 2020  ch the .        
+00047cd0: 2020 2020 7370 6563 6966 6965 6420 6060      specified ``
+00047ce0: 6b65 7960 600a 2020 2020 2020 2020 0a20  key``.        . 
+00047cf0: 2020 2020 2020 205f 5f69 7465 725f 5f0a         __iter__.
+00047d00: 2020 2020 2020 2020 2020 2020 4974 6572              Iter
+00047d10: 6174 6f72 206f 7665 7220 6060 7661 6c75  ator over ``valu
+00047d20: 6573 6060 0a20 2020 2020 2020 200a 2020  es``.        .  
+00047d30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00047d40: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00047d50: 6172 7261 792c 206c 6973 7429 3a0a 2020  array, list):.  
+00047d60: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00047d70: 7272 6179 203d 206e 702e 6172 7261 7928  rray = np.array(
+00047d80: 6172 7261 7929 0a20 2020 2020 2020 2065  array).        e
+00047d90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00047da0: 2073 656c 662e 6172 7261 7920 3d20 6172   self.array = ar
+00047db0: 7261 790a 2020 2020 2020 2020 0a20 2020  ray.        .   
+00047dc0: 2020 2020 205f 203d 206e 702e 756e 6971       _ = np.uniq
+00047dd0: 7565 2873 656c 662e 6172 7261 792c 2072  ue(self.array, r
+00047de0: 6574 7572 6e5f 636f 756e 7473 3d54 7275  eturn_counts=Tru
+00047df0: 652c 2072 6574 7572 6e5f 696e 7665 7273  e, return_invers
+00047e00: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
+00047e10: 7365 6c66 2e64 696d 203d 2073 656c 662e  self.dim = self.
+00047e20: 6172 7261 792e 7369 7a65 0a20 2020 2020  array.size.     
+00047e30: 2020 2073 656c 662e 7a65 726f 7320 3d20     self.zeros = 
+00047e40: 6e70 2e7a 6572 6f73 2873 656c 662e 6172  np.zeros(self.ar
+00047e50: 7261 792e 7368 6170 652c 2064 7479 7065  ray.shape, dtype
+00047e60: 3d62 6f6f 6c29 0a20 2020 2020 2020 200a  =bool).        .
+00047e70: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
+00047e80: 7565 7320 3d20 5b6c 2066 6f72 206c 2069  ues = [l for l i
+00047e90: 6e20 5f5b 305d 5d0a 2020 2020 2020 2020  n _[0]].        
+00047ea0: 7365 6c66 2e69 6e64 6963 6573 203d 205f  self.indices = _
+00047eb0: 5b31 5d0a 2020 2020 2020 2020 7365 6c66  [1].        self
+00047ec0: 2e63 6f75 6e74 7320 3d20 5f5b 325d 0a20  .counts = _[2]. 
+00047ed0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00047ee0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00047ef0: 656c 662e 696e 666f 2873 6f72 745f 636f  elf.info(sort_co
+00047f00: 756e 7473 3d76 6572 626f 7365 290a 2020  unts=verbose).  
+00047f10: 2020 0a20 2020 200a 2020 2020 4070 726f    .    .    @pro
+00047f20: 7065 7274 790a 2020 2020 6465 6620 4e28  perty.    def N(
+00047f30: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00047f40: 2222 0a20 2020 2020 2020 204e 756d 6265  "".        Numbe
+00047f50: 7220 6f66 2075 6e69 7175 6520 6060 7661  r of unique ``va
+00047f60: 6c75 6573 6060 0a20 2020 2020 2020 2022  lues``.        "
+00047f70: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00047f80: 6e20 6c65 6e28 7365 6c66 2e76 616c 7565  n len(self.value
+00047f90: 7329 0a0a 0a20 2020 2064 6566 2069 6e66  s)...    def inf
+00047fa0: 6f28 7365 6c66 2c20 736f 7274 5f63 6f75  o(self, sort_cou
+00047fb0: 6e74 733d 2d31 293a 0a20 2020 2020 2020  nts=-1):.       
+00047fc0: 2022 2222 0a20 2020 2020 2020 2050 7269   """.        Pri
+00047fd0: 6e74 2061 2073 756d 6d61 7279 0a20 2020  nt a summary.   
+00047fe0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00047ff0: 2070 7269 6e74 2866 277b 224e 223a 3e34   print(f'{"N":>4
+00048000: 7d20 207b 2276 616c 7565 223a 3130 7d27  }  {"value":10}'
+00048010: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+00048020: 273d 3d3d 3d20 203d 3d3d 3d3d 3d3d 3d3d  '====  =========
+00048030: 3d27 290a 2020 2020 2020 2020 6966 2073  =').        if s
+00048040: 6f72 745f 636f 756e 7473 3a0a 2020 2020  ort_counts:.    
+00048050: 2020 2020 2020 2020 736f 203d 206e 702e          so = np.
+00048060: 6172 6773 6f72 7428 7365 6c66 2e63 6f75  argsort(self.cou
+00048070: 6e74 7329 5b3a 3a69 6e74 2873 6f72 745f  nts)[::int(sort_
+00048080: 636f 756e 7473 295d 0a20 2020 2020 2020  counts)].       
+00048090: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000480a0: 2020 2073 6f20 3d20 6e70 2e61 7261 6e67     so = np.arang
+000480b0: 6528 7365 6c66 2e4e 290a 2020 2020 2020  e(self.N).      
+000480c0: 2020 2020 2020 0a20 2020 2020 2020 2066        .        f
+000480d0: 6f72 2069 2069 6e20 736f 3a0a 2020 2020  or i in so:.    
+000480e0: 2020 2020 2020 2020 762c 2063 203d 2073          v, c = s
+000480f0: 656c 662e 7661 6c75 6573 5b69 5d2c 2073  elf.values[i], s
+00048100: 656c 662e 636f 756e 7473 5b69 5d0a 2020  elf.counts[i].  
+00048110: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00048120: 6627 7b63 3a3e 347d 2020 7b76 3a31 307d  f'{c:>4}  {v:10}
+00048130: 2729 0a0a 0a20 2020 2064 6566 2063 6f75  ')...    def cou
+00048140: 6e74 2873 656c 662c 206b 6579 293a 0a20  nt(self, key):. 
+00048150: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00048160: 2020 2047 6574 206f 6363 7572 7265 6e63     Get occurrenc
+00048170: 6573 2063 6f75 6e74 206f 6620 6120 7061  es count of a pa
+00048180: 7274 6963 756c 6172 2060 6076 616c 7565  rticular ``value
+00048190: 6060 0a20 2020 2020 2020 2022 2222 0a20  ``.        """. 
+000481a0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
+000481b0: 2073 656c 662e 7661 6c75 6573 3a0a 2020   self.values:.  
+000481c0: 2020 2020 2020 2020 2020 6978 203d 2073            ix = s
+000481d0: 656c 662e 7661 6c75 6573 2e69 6e64 6578  elf.values.index
+000481e0: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
+000481f0: 2020 7265 7475 726e 2073 656c 662e 636f    return self.co
+00048200: 756e 7473 5b69 785d 0a20 2020 2020 2020  unts[ix].       
+00048210: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00048220: 2020 2072 6574 7572 6e20 300a 2020 2020     return 0.    
+00048230: 0a20 2020 200a 2020 2020 4070 726f 7065  .    .    @prope
+00048240: 7274 790a 2020 2020 6465 6620 6c69 7374  rty.    def list
+00048250: 5f69 6e64 6963 6573 2873 656c 6629 3a0a  _indices(self):.
+00048260: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00048270: 2020 2020 4275 696c 6420 6c69 7374 206f      Build list o
+00048280: 6620 6c69 7374 7320 6f66 2069 6e64 6963  f lists of indic
+00048290: 6573 2074 6861 7420 6561 6368 2075 6e69  es that each uni
+000482a0: 7175 6520 7661 6c75 650a 2020 2020 2020  que value.      
+000482b0: 2020 2222 220a 2020 2020 0a20 2020 2020    """.    .     
+000482c0: 2020 2069 6e64 7320 3d20 5b5b 5d20 666f     inds = [[] fo
+000482d0: 7220 6920 696e 2072 616e 6765 2873 656c  r i in range(sel
+000482e0: 662e 4e29 5d20 2020 200a 2020 2020 2020  f.N)]    .      
+000482f0: 2020 736f 203d 206e 702e 6172 6773 6f72    so = np.argsor
+00048300: 7428 7365 6c66 2e69 6e64 6963 6573 290a  t(self.indices).
+00048310: 2020 2020 0a20 2020 2020 2020 2066 6f72      .        for
+00048320: 2069 2c20 6969 2069 6e20 7a69 7028 736f   i, ii in zip(so
+00048330: 2c20 7365 6c66 2e69 6e64 6963 6573 5b73  , self.indices[s
+00048340: 6f5d 293a 0a20 2020 2020 2020 2020 2020  o]):.           
+00048350: 2069 6e64 735b 6969 5d2e 6170 7065 6e64   inds[ii].append
+00048360: 2869 290a 2020 2020 2020 2020 0a20 2020  (i).        .   
+00048370: 2020 2020 2023 2053 6f72 7420 7468 6520       # Sort the 
+00048380: 7375 626c 6973 7473 0a20 2020 2020 2020  sublists.       
+00048390: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+000483a0: 7365 6c66 2e4e 293a 0a20 2020 2020 2020  self.N):.       
+000483b0: 2020 2020 2069 6620 7365 6c66 2e63 6f75       if self.cou
+000483c0: 6e74 735b 695d 203e 2031 3a0a 2020 2020  nts[i] > 1:.    
+000483d0: 2020 2020 2020 2020 2020 2020 696e 6473              inds
+000483e0: 5b69 5d2e 736f 7274 2829 0a20 2020 200a  [i].sort().    .
+000483f0: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+00048400: 6e64 730a 2020 2020 0a20 2020 200a 2020  nds.    .    .  
+00048410: 2020 6465 6620 756e 6971 7565 5f69 6e64    def unique_ind
+00048420: 6578 2873 656c 662c 2069 6e64 6578 3d30  ex(self, index=0
+00048430: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00048440: 2020 2020 2020 2052 6574 7572 6e20 6172         Return ar
+00048450: 7261 7920 6f66 2069 6e64 6963 6573 206f  ray of indices o
+00048460: 6620 7468 6520 7061 7265 6e74 2061 7272  f the parent arr
+00048470: 6179 2074 6861 7420 6d61 6b65 7320 6120  ay that makes a 
+00048480: 756e 6971 7565 206f 7574 7075 7420 6172  unique output ar
+00048490: 7261 790a 2020 2020 2020 2020 0a20 2020  ray.        .   
+000484a0: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+000484b0: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+000484c0: 2020 2020 2075 6978 203a 206c 6973 740a       uix : list.
+000484d0: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+000484e0: 206f 6620 756e 6971 7565 2069 6e64 6963   of unique indic
+000484f0: 6573 0a20 2020 2020 2020 2022 2222 0a20  es.        """. 
+00048500: 2020 2020 2020 2075 6978 203d 205b 696e         uix = [in
+00048510: 645b 696e 6465 785d 2066 6f72 2069 6e64  d[index] for ind
+00048520: 2069 6e20 7365 6c66 2e6c 6973 745f 696e   in self.list_in
+00048530: 6469 6365 735d 0a20 2020 2020 2020 2020  dices].         
+00048540: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00048550: 2020 2020 7265 7475 726e 2075 6978 0a20      return uix. 
+00048560: 2020 200a 2020 2020 0a20 2020 2064 6566     .    .    def
+00048570: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
+00048580: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00048590: 2020 2020 2049 7465 7261 626c 6520 6f76       Iterable ov
+000485a0: 6572 2060 7661 6c75 6573 6020 6174 7472  er `values` attr
+000485b0: 6962 7574 650a 2020 2020 2020 2020 0a20  ibute.        . 
+000485c0: 2020 2020 2020 2052 6574 7572 6e73 2061         Returns a
+000485d0: 2074 7570 6c65 206f 6620 7468 6520 7661   tuple of the va
+000485e0: 6c75 6520 616e 6420 7468 6520 626f 6f6c  lue and the bool
+000485f0: 6561 6e20 7365 6c65 6374 696f 6e20 6172  ean selection ar
+00048600: 7261 7920 666f 7220 7468 6174 200a 2020  ray for that .  
+00048610: 2020 2020 2020 7661 6c75 652e 0a20 2020        value..   
+00048620: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00048630: 2069 203d 2030 0a20 2020 2020 2020 2077   i = 0.        w
+00048640: 6869 6c65 2069 203c 2073 656c 662e 4e3a  hile i < self.N:
+00048650: 0a20 2020 2020 2020 2020 2020 2076 6920  .            vi 
+00048660: 3d20 7365 6c66 2e76 616c 7565 735b 695d  = self.values[i]
+00048670: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00048680: 6c64 2028 7669 2c20 7365 6c66 5b76 695d  ld (vi, self[vi]
+00048690: 290a 2020 2020 2020 2020 2020 2020 6920  ).            i 
+000486a0: 2b3d 2031 0a0a 0a20 2020 2064 6566 205f  += 1...    def _
+000486b0: 5f67 6574 6974 656d 5f5f 2873 656c 662c  _getitem__(self,
+000486c0: 206b 6579 293a 0a20 2020 2020 2020 2069   key):.        i
+000486d0: 6620 6b65 7920 696e 2073 656c 662e 7661  f key in self.va
+000486e0: 6c75 6573 3a0a 2020 2020 2020 2020 2020  lues:.          
+000486f0: 2020 6978 203d 2073 656c 662e 7661 6c75    ix = self.valu
+00048700: 6573 2e69 6e64 6578 286b 6579 290a 2020  es.index(key).  
+00048710: 2020 2020 2020 2020 2020 7465 7374 203d            test =
+00048720: 2073 656c 662e 696e 6469 6365 7320 3d3d   self.indices ==
+00048730: 2069 780a 2020 2020 2020 2020 2020 2020   ix.            
+00048740: 7265 7475 726e 2074 6573 740a 2020 2020  return test.    
+00048750: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00048760: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00048770: 662e 7a65 726f 730a 0a0a 2020 2020 6465  f.zeros...    de
+00048780: 6620 5f5f 6c65 6e5f 5f28 7365 6c66 293a  f __len__(self):
+00048790: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000487a0: 7365 6c66 2e4e 0a0a 0a63 6c61 7373 2048  self.N...class H
+000487b0: 7562 626c 6558 595a 286f 626a 6563 7429  ubbleXYZ(object)
+000487c0: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+000487d0: 5f5f 2873 656c 662c 2073 7074 5f66 696c  __(self, spt_fil
+000487e0: 653d 2727 2c20 7061 7261 6d5f 6469 6374  e='', param_dict
+000487f0: 3d7b 7d29 3a0a 2020 2020 2020 2020 2222  ={}):.        ""
+00048800: 220a 2020 2020 2020 2020 4865 6c70 6572  ".        Helper
+00048810: 2074 6f20 636f 6d70 7574 6520 4853 5420   to compute HST 
+00048820: 6765 6f63 656e 7472 6963 2063 6f6f 7264  geocentric coord
+00048830: 696e 6174 6573 2066 726f 6d20 6f72 6269  inates from orbi
+00048840: 7461 6c20 7061 7261 6d65 7465 7273 0a20  tal parameters. 
+00048850: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00048860: 2874 6573 7469 6e67 290a 2020 2020 2020  (testing).      
+00048870: 2020 0a20 2020 2020 2020 2042 6173 6564    .        Based
+00048880: 206f 6e20 6874 7470 3a2f 2f61 7274 6963   on http://artic
+00048890: 6c65 732e 6164 7361 6273 2e68 6172 7661  les.adsabs.harva
+000488a0: 7264 2e65 6475 2f2f 6675 6c6c 2f31 3939  rd.edu//full/199
+000488b0: 3541 5350 432e 2e2e 3737 2e2e 3436 3441  5ASPC...77..464A
+000488c0: 2f0a 2020 2020 2020 2020 2222 220a 2020  /.        """.  
+000488d0: 2020 2020 2020 6966 2073 7074 5f66 696c        if spt_fil
+000488e0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000488f0: 656c 662e 7061 7261 6d5f 6469 6374 203d  elf.param_dict =
+00048900: 2073 656c 662e 7061 7273 655f 6672 6f6d   self.parse_from
+00048910: 5f73 7074 2873 7074 5f66 696c 6529 0a20  _spt(spt_file). 
+00048920: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00048930: 656c 6966 2070 6172 616d 5f64 6963 743a  elif param_dict:
+00048940: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00048950: 662e 7061 7261 6d5f 6469 6374 203d 2070  f.param_dict = p
+00048960: 6172 616d 5f64 6963 740a 2020 2020 2020  aram_dict.      
+00048970: 2020 0a20 2020 2020 2020 2065 6c73 653a    .        else:
+00048980: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00048990: 662e 7061 7261 6d5f 6469 6374 203d 207b  f.param_dict = {
+000489a0: 7d0a 2020 2020 2020 2020 0a20 2020 2020  }.        .     
+000489b0: 2020 2073 656c 662e 636f 6d70 7574 6564     self.computed
+000489c0: 203d 207b 7d0a 0a0a 2020 2020 4070 726f   = {}...    @pro
+000489d0: 7065 7274 7920 0a20 2020 2064 6566 205f  perty .    def _
+000489e0: 7431 3938 3528 7365 6c66 293a 0a20 2020  t1985(self):.   
+000489f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00048a00: 2052 6566 6572 656e 6365 2074 696d 650a   Reference time.
+00048a10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00048a20: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
+00048a30: 7079 2e74 696d 650a 2020 2020 2020 2020  py.time.        
+00048a40: 7430 203d 2061 7374 726f 7079 2e74 696d  t0 = astropy.tim
+00048a50: 652e 5469 6d65 2827 3139 3835 2d30 312d  e.Time('1985-01-
+00048a60: 3031 5430 303a 3030 3a30 305a 2729 0a20  01T00:00:00Z'). 
+00048a70: 2020 2020 2020 2072 6574 7572 6e20 7430         return t0
+00048a80: 0a0a 0a20 2020 2064 6566 205f 5f63 616c  ...    def __cal
+00048a90: 6c5f 5f28 7365 6c66 2c20 745f 696e 2c20  l__(self, t_in, 
+00048aa0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00048ab0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+00048ac0: 6f6e 7665 7274 2069 6e70 7574 2074 696d  onvert input tim
+00048ad0: 6520 6060 745f 696e 6060 2074 6f20 7365  e ``t_in`` to se
+00048ae0: 636f 6e64 7320 7369 6e63 6520 312f 312f  conds since 1/1/
+00048af0: 3835 2061 6e64 2060 6065 7661 6c75 6174  85 and ``evaluat
+00048b00: 6560 602e 0a20 2020 2020 2020 2022 2222  e``..        """
+00048b10: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+00048b20: 6173 7472 6f70 792e 7469 6d65 0a20 2020  astropy.time.   
+00048b30: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00048b40: 7374 616e 6365 2874 5f69 6e2c 2061 7374  stance(t_in, ast
+00048b50: 726f 7079 2e74 696d 652e 5469 6d65 293a  ropy.time.Time):
+00048b60: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00048b70: 7365 2056 616c 7565 4572 726f 7228 2774  se ValueError('t
+00048b80: 5f69 6e20 6d75 7374 2062 6520 6173 7472  _in must be astr
+00048b90: 6f70 792e 7469 6d65 2e54 696d 6520 6f62  opy.time.Time ob
+00048ba0: 6a65 6374 2729 0a0a 2020 2020 2020 2020  ject')..        
+00048bb0: 6474 203d 2074 5f69 6e20 2d20 7365 6c66  dt = t_in - self
+00048bc0: 2e5f 7431 3938 350a 2020 2020 2020 2020  ._t1985.        
+00048bd0: 7879 7a20 3d20 7365 6c66 2e65 7661 6c75  xyz = self.evalu
+00048be0: 6174 6528 6474 2e73 6563 2c20 2a2a 6b77  ate(dt.sec, **kw
+00048bf0: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+00048c00: 2027 6173 5f74 6162 6c65 2720 696e 206b   'as_table' in k
+00048c10: 7761 7267 733a 0a20 2020 2020 2020 2020  wargs:.         
+00048c20: 2020 2069 6620 6b77 6172 6773 5b27 6173     if kwargs['as
+00048c30: 5f74 6162 6c65 275d 3a0a 2020 2020 2020  _table']:.      
+00048c40: 2020 2020 2020 2020 2020 7879 7a5b 2774            xyz['t
+00048c50: 696d 6527 5d20 3d20 745f 696e 0a20 2020  ime'] = t_in.   
+00048c60: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+00048c70: 2020 2020 2020 7265 7475 726e 2078 797a        return xyz
+00048c80: 0a0a 0a20 2020 2064 6566 205f 5f67 6574  ...    def __get
+00048c90: 6974 656d 5f5f 2873 656c 662c 206b 6579  item__(self, key
+00048ca0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00048cb0: 6e20 7365 6c66 2e70 6172 616d 5f64 6963  n self.param_dic
+00048cc0: 745b 6b65 795d 0a0a 0a20 2020 2064 6566  t[key]...    def
+00048cd0: 2065 7661 6c75 6174 6528 7365 6c66 2c20   evaluate(self, 
+00048ce0: 6474 2c20 756e 6974 3d4e 6f6e 652c 2061  dt, unit=None, a
+00048cf0: 735f 7461 626c 653d 4661 6c73 6529 3a0a  s_table=False):.
+00048d00: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00048d10: 2020 2020 4576 616c 7561 7465 2065 7175      Evaluate equ
+00048d20: 6174 696f 6e73 2074 6f20 6765 7420 706f  ations to get po
+00048d30: 7369 7469 6f6e 730a 2020 2020 2020 2020  sitions.        
+00048d40: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00048d50: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00048d60: 0a20 2020 2020 2020 2078 2c20 792c 207a  .        x, y, z
+00048d70: 2c20 723a 2066 6c6f 6174 0a20 2020 2020  , r: float.     
+00048d80: 2020 2020 2020 2043 6f6f 7264 696e 6174         Coordinat
+00048d90: 6573 2c20 696e 206b 6d20 6f72 2060 6075  es, in km or ``u
+00048da0: 6e69 7460 602e 0a20 2020 2020 2020 2020  nit``..         
+00048db0: 2020 200a 2020 2020 2020 2020 2222 220a     .        """.
+00048dc0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00048dd0: 2069 6620 6e6f 7420 7365 6c66 2e70 6172   if not self.par
+00048de0: 616d 5f64 6963 743a 0a20 2020 2020 2020  am_dict:.       
+00048df0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00048e00: 4572 726f 7228 274f 7262 6974 616c 2070  Error('Orbital p
+00048e10: 6172 616d 6574 6572 7320 6e6f 7420 6465  arameters not de
+00048e20: 6669 6e65 6420 696e 2027 0a20 2020 2020  fined in '.     
+00048e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048e40: 2020 2020 2020 2020 2773 656c 662e 7061          'self.pa
+00048e50: 7261 6d5f 6469 6374 2729 0a20 2020 2020  ram_dict').     
+00048e60: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00048e70: 2020 2020 2020 2020 7020 3d20 7365 6c66          p = self
+00048e80: 2e70 6172 616d 5f64 6963 740a 2020 2020  .param_dict.    
+00048e90: 2020 2020 0a20 2020 2020 2020 2074 203d      .        t =
+00048ea0: 206e 702e 6174 6c65 6173 745f 3164 2864   np.atleast_1d(d
+00048eb0: 7429 0a20 2020 2020 2020 200a 2020 2020  t).        .    
+00048ec0: 2020 2020 2320 4571 2e20 310a 2020 2020      # Eq. 1.    
+00048ed0: 2020 2020 6272 6163 6b65 7420 3d20 705b      bracket = p[
+00048ee0: 274d 2e27 5d2a 2874 2d70 5b27 7461 7527  'M.']*(t-p['tau'
+00048ef0: 5d29 202b 2030 2e35 2a70 5b27 4d2e 2e27  ]) + 0.5*p['M..'
+00048f00: 5d2a 2874 2d70 5b27 7461 7527 5d29 2a2a  ]*(t-p['tau'])**
+00048f10: 320a 2020 2020 2020 2020 4d20 3d20 705b  2.        M = p[
+00048f20: 274d 3027 5d20 2b20 322a 6e70 2e70 692a  'M0'] + 2*np.pi*
+00048f30: 6272 6163 6b65 740a 2020 2020 2020 2020  bracket.        
+00048f40: 0a20 2020 2020 2020 2023 2045 712e 2032  .        # Eq. 2
+00048f50: 0a20 2020 2020 2020 2073 696e 4d20 3d20  .        sinM = 
+00048f60: 6e70 2e73 696e 284d 290a 2020 2020 2020  np.sin(M).      
+00048f70: 2020 636f 734d 203d 206e 702e 636f 7328    cosM = np.cos(
+00048f80: 4d29 0a20 2020 2020 2020 2065 203d 2070  M).        e = p
+00048f90: 5b27 6527 5d0a 2020 2020 2020 2020 6e75  ['e'].        nu
+00048fa0: 203d 204d 202b 2073 696e 4d2a 2832 2a65   = M + sinM*(2*e
+00048fb0: 202b 2033 2a65 2a2a 332a 636f 734d 2a2a   + 3*e**3*cosM**
+00048fc0: 3220 2d20 342e 2f33 2a65 2a2a 332a 7369  2 - 4./3*e**3*si
+00048fd0: 6e4d 2a2a 3220 0a20 2020 2020 2020 2020  nM**2 .         
+00048fe0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00048ff0: 352e 2f32 2a65 2a2a 322a 636f 734d 290a  5./2*e**2*cosM).
+00049000: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00049010: 2023 2045 712e 2033 0a20 2020 2020 2020   # Eq. 3.       
+00049020: 2072 203d 2070 5b27 6128 312d 652a 2a32   r = p['a(1-e**2
+00049030: 2927 5d2f 2831 2b65 2a6e 702e 636f 7328  )']/(1+e*np.cos(
+00049040: 6e75 2929 0a20 2020 2020 2020 2023 2054  nu)).        # T
+00049050: 6f20 6b6d 0a20 2020 2020 2020 2072 202f  o km.        r /
+00049060: 3d20 3130 3030 2e0a 2020 2020 2020 2020  = 1000..        
+00049070: 0a20 2020 2020 2020 2023 2045 712e 2034  .        # Eq. 4
+00049080: 0a20 2020 2020 2020 204f 6d20 3d20 322a  .        Om = 2*
+00049090: 6e70 2e70 692a 2870 5b27 4f6d 3027 5d20  np.pi*(p['Om0'] 
+000490a0: 2b20 705b 274f 6d2e 275d 2a28 742d 705b  + p['Om.']*(t-p[
+000490b0: 2774 6175 275d 2929 0a20 2020 2020 2020  'tau'])).       
+000490c0: 200a 2020 2020 2020 2020 2320 4571 2e20   .        # Eq. 
+000490d0: 350a 2020 2020 2020 2020 7720 3d20 322a  5.        w = 2*
+000490e0: 6e70 2e70 692a 2870 5b27 7730 275d 202b  np.pi*(p['w0'] +
+000490f0: 2070 5b27 772e 275d 2a28 742d 705b 2774   p['w.']*(t-p['t
+00049100: 6175 275d 2929 0a20 2020 2020 2020 200a  au'])).        .
+00049110: 2020 2020 2020 2020 7365 6c66 2e63 616c          self.cal
+00049120: 635f 6469 6374 203d 207b 274d 273a 4d2c  c_dict = {'M':M,
+00049130: 2027 6e75 273a 6e75 2c20 0a20 2020 2020   'nu':nu, .     
+00049140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049150: 2020 2020 2027 6127 3a70 5b27 6127 5d2c       'a':p['a'],
+00049160: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00049170: 2020 2020 2020 2020 2020 2020 2769 273a              'i':
+00049180: 6e70 2e61 7263 7369 6e28 705b 2773 696e  np.arcsin(p['sin
+00049190: 6927 5d29 2c20 0a20 2020 2020 2020 2020  i']), .         
+000491a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000491b0: 2027 4f6d 273a 4f6d 2c0a 2020 2020 2020   'Om':Om,.      
+000491c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000491d0: 2020 2020 2777 273a 777d 0a20 2020 2020      'w':w}.     
+000491e0: 2020 200a 2020 2020 2020 2020 2320 4571     .        # Eq
+000491f0: 2e20 360a 2020 2020 2020 2020 636f 734f  . 6.        cosO
+00049200: 6d20 3d20 6e70 2e63 6f73 284f 6d29 0a20  m = np.cos(Om). 
+00049210: 2020 2020 2020 2073 696e 4f6d 203d 206e         sinOm = n
+00049220: 702e 7369 6e28 4f6d 290a 2020 2020 2020  p.sin(Om).      
+00049230: 2020 636f 7377 7620 3d20 6e70 2e63 6f73    coswv = np.cos
+00049240: 2877 2b6e 7529 0a20 2020 2020 2020 2073  (w+nu).        s
+00049250: 696e 7776 203d 206e 702e 7369 6e28 772b  inwv = np.sin(w+
+00049260: 6e75 290a 2020 2020 2020 2020 0a20 2020  nu).        .   
+00049270: 2020 2020 2069 6620 756e 6974 2069 7320       if unit is 
+00049280: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00049290: 2020 2020 2020 7220 3d20 2872 2a75 2e6b        r = (r*u.k
+000492a0: 6d29 2e74 6f28 756e 6974 290a 2020 2020  m).to(unit).    
+000492b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000492c0: 2078 203d 2072 2a28 636f 734f 6d2a 636f   x = r*(cosOm*co
+000492d0: 7377 7620 2d20 705b 2763 6f73 6927 5d2a  swv - p['cosi']*
+000492e0: 7369 6e4f 6d2a 7369 6e77 7629 0a20 2020  sinOm*sinwv).   
+000492f0: 2020 2020 2079 203d 2072 2a28 7369 6e4f       y = r*(sinO
+00049300: 6d2a 636f 7377 7620 2b20 705b 2763 6f73  m*coswv + p['cos
+00049310: 6927 5d2a 636f 734f 6d2a 7369 6e77 7629  i']*cosOm*sinwv)
+00049320: 0a20 2020 2020 2020 207a 203d 2072 2a70  .        z = r*p
+00049330: 5b27 7369 6e69 275d 2a73 696e 7776 0a20  ['sini']*sinwv. 
+00049340: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00049350: 6966 2061 735f 7461 626c 653a 0a20 2020  if as_table:.   
+00049360: 2020 2020 2020 2020 2074 6162 203d 2047           tab = G
+00049370: 5461 626c 6528 290a 2020 2020 2020 2020  Table().        
+00049380: 2020 2020 7461 625b 2764 7427 5d20 3d20      tab['dt'] = 
+00049390: 740a 2020 2020 2020 2020 2020 2020 7461  t.            ta
+000493a0: 625b 2778 275d 203d 2078 0a20 2020 2020  b['x'] = x.     
+000493b0: 2020 2020 2020 2074 6162 5b27 7927 5d20         tab['y'] 
+000493c0: 3d20 790a 2020 2020 2020 2020 2020 2020  = y.            
+000493d0: 7461 625b 277a 275d 203d 207a 0a20 2020  tab['z'] = z.   
+000493e0: 2020 2020 2020 2020 2074 6162 5b27 7227           tab['r'
+000493f0: 5d20 3d20 720a 2020 2020 2020 2020 2020  ] = r.          
+00049400: 2020 7265 7475 726e 2074 6162 0a20 2020    return tab.   
+00049410: 2020 2020 2065 6c73 653a 200a 2020 2020       else: .    
+00049420: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+00049430: 2c20 792c 207a 2c20 720a 0a0a 2020 2020  , y, z, r...    
+00049440: 6465 6620 6672 6f6d 5f66 6c74 2873 656c  def from_flt(sel
+00049450: 662c 2066 6c74 5f66 696c 652c 202a 2a6b  f, flt_file, **k
+00049460: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00049470: 2222 220a 2020 2020 2020 2020 436f 6d70  """.        Comp
+00049480: 7574 6520 706f 7369 7469 6f6e 7320 6174  ute positions at
+00049490: 2065 7870 7374 6172 742c 2065 7870 6d69   expstart, expmi
+000494a0: 642c 2065 7870 656e 640a 2020 2020 2020  d, expend.      
+000494b0: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
+000494c0: 706f 7274 2061 7374 726f 7079 2e74 696d  port astropy.tim
+000494d0: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
+000494e0: 2020 2066 6c74 203d 2070 7966 6974 732e     flt = pyfits.
+000494f0: 6f70 656e 2866 6c74 5f66 696c 6529 0a20  open(flt_file). 
+00049500: 2020 2020 2020 2065 7870 7374 6172 7420         expstart 
+00049510: 3d20 666c 745b 305d 2e68 6561 6465 725b  = flt[0].header[
+00049520: 2745 5850 5354 4152 5427 5d0a 2020 2020  'EXPSTART'].    
+00049530: 2020 2020 6578 7065 6e64 203d 2066 6c74      expend = flt
+00049540: 5b30 5d2e 6865 6164 6572 5b27 4558 5045  [0].header['EXPE
+00049550: 4e44 275d 0a20 2020 2020 2020 2065 7870  ND'].        exp
+00049560: 6d69 6420 3d20 2865 7870 7374 6172 742b  mid = (expstart+
+00049570: 6578 7065 6e64 292f 322e 0a20 2020 2020  expend)/2..     
+00049580: 2020 200a 2020 2020 2020 2020 745f 696e     .        t_in
+00049590: 203d 2061 7374 726f 7079 2e74 696d 652e   = astropy.time.
+000495a0: 5469 6d65 285b 6578 7073 7461 7274 2c20  Time([expstart, 
+000495b0: 6578 706d 6964 2c20 6578 7065 6e64 5d2c  expmid, expend],
+000495c0: 2066 6f72 6d61 743d 276d 6a64 2729 0a20   format='mjd'). 
+000495d0: 2020 2020 2020 2066 6c74 2e63 6c6f 7365         flt.close
+000495e0: 2829 0a20 2020 2020 2020 200a 2020 2020  ().        .    
+000495f0: 2020 2020 7265 7475 726e 2073 656c 6628      return self(
+00049600: 745f 696e 2c20 2a2a 6b77 6172 6773 290a  t_in, **kwargs).
+00049610: 0a0a 2020 2020 6465 6620 6465 6c74 6174  ..    def deltat
+00049620: 2873 656c 662c 2064 7429 3a0a 2020 2020  (self, dt):.    
+00049630: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00049640: 436f 6e76 6572 7420 6120 7469 6d65 2060  Convert a time `
+00049650: 6074 6060 2069 6e20 7365 636f 6e64 7320  `t`` in seconds 
+00049660: 6672 6f6d 2031 2f31 2f38 3520 746f 2061  from 1/1/85 to a
+00049670: 6e20 4953 4f20 7469 6d65 0a20 2020 2020  n ISO time.     
+00049680: 2020 2022 2222 2020 2020 0a20 2020 2020     """    .     
+00049690: 2020 2069 6620 6e6f 7420 6861 7361 7474     if not hasatt
+000496a0: 7228 6474 2c20 2775 6e69 7427 293a 0a20  r(dt, 'unit'):. 
+000496b0: 2020 2020 2020 2020 2020 2064 7473 6563             dtsec
+000496c0: 203d 2064 742a 752e 7365 636f 6e64 0a20   = dt*u.second. 
+000496d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000496e0: 2020 2020 2020 2020 2064 7473 6563 203d           dtsec =
+000496f0: 2064 740a 2020 2020 2020 2020 2020 2020   dt.            
+00049700: 0a20 2020 2020 2020 2074 203d 2073 656c  .        t = sel
+00049710: 662e 5f74 3139 3835 202b 2064 7473 6563  f._t1985 + dtsec
+00049720: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00049730: 740a 0a0a 2020 2020 6465 6620 7061 7273  t...    def pars
+00049740: 655f 6672 6f6d 5f73 7074 2873 656c 662c  e_from_spt(self,
+00049750: 2073 7074 5f66 696c 6529 3a0a 2020 2020   spt_file):.    
+00049760: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00049770: 4765 7420 6f72 6269 7461 6c20 656c 656d  Get orbital elem
+00049780: 656e 7473 2066 726f 6d20 5350 5420 6865  ents from SPT he
+00049790: 6164 6572 0a20 2020 2020 2020 2022 2222  ader.        """
+000497a0: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+000497b0: 6173 7472 6f70 792e 696f 2e66 6974 7320  astropy.io.fits 
+000497c0: 6173 2070 7966 6974 730a 2020 2020 2020  as pyfits.      
+000497d0: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
+000497e0: 2e74 696d 650a 2020 2020 2020 2020 0a20  .time.        . 
+000497f0: 2020 2020 2020 2077 6974 6820 7079 6669         with pyfi
+00049800: 7473 2e6f 7065 6e28 7370 745f 6669 6c65  ts.open(spt_file
+00049810: 2920 6173 205f 696d 3a0a 2020 2020 2020  ) as _im:.      
+00049820: 2020 2020 2020 7370 7420 3d20 5f69 6d5b        spt = _im[
+00049830: 305d 2e68 6561 6465 722e 636f 7079 2829  0].header.copy()
+00049840: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00049850: 2020 7061 7261 6d5f 6469 6374 203d 207b    param_dict = {
+00049860: 7d0a 2020 2020 2020 2020 7061 7261 6d5f  }.        param_
+00049870: 6469 6374 5b27 7461 7527 5d20 3d20 7370  dict['tau'] = sp
+00049880: 745b 2745 5043 4854 494d 4527 5d0a 2020  t['EPCHTIME'].  
+00049890: 2020 2020 2020 7061 7261 6d5f 6469 6374        param_dict
+000498a0: 5b27 4d30 275d 203d 2073 7074 5b27 4d45  ['M0'] = spt['ME
+000498b0: 414e 414e 4f4d 275d 0a20 2020 2020 2020  ANANOM'].       
+000498c0: 2070 6172 616d 5f64 6963 745b 274d 2e27   param_dict['M.'
+000498d0: 5d20 3d20 7370 745b 2746 444d 4541 4e41  ] = spt['FDMEANA
+000498e0: 4e27 5d0a 2020 2020 2020 2020 7061 7261  N'].        para
+000498f0: 6d5f 6469 6374 5b27 4d2e 2e27 5d20 3d20  m_dict['M..'] = 
+00049900: 7370 745b 2753 444d 4541 4e41 4e27 5d0a  spt['SDMEANAN'].
+00049910: 2020 2020 2020 2020 7061 7261 6d5f 6469          param_di
+00049920: 6374 5b27 6527 5d20 3d20 7370 745b 2745  ct['e'] = spt['E
+00049930: 4343 454e 5452 5927 5d0a 2020 2020 2020  CCENTRY'].      
+00049940: 2020 7061 7261 6d5f 6469 6374 5b27 6128    param_dict['a(
+00049950: 312d 652a 2a32 2927 5d20 3d20 7370 745b  1-e**2)'] = spt[
+00049960: 2753 454d 494c 5245 4327 5d0a 2020 2020  'SEMILREC'].    
+00049970: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
+00049980: 6127 5d20 3d20 7061 7261 6d5f 6469 6374  a'] = param_dict
+00049990: 5b27 6128 312d 652a 2a32 2927 5d20 2f20  ['a(1-e**2)'] / 
+000499a0: 2831 2d70 6172 616d 5f64 6963 745b 2765  (1-param_dict['e
+000499b0: 275d 2a2a 3229 0a20 2020 2020 2020 2070  ']**2).        p
+000499c0: 6172 616d 5f64 6963 745b 274f 6d30 275d  aram_dict['Om0']
+000499d0: 203d 2073 7074 5b27 5241 5343 4153 434e   = spt['RASCASCN
+000499e0: 275d 0a20 2020 2020 2020 2070 6172 616d  '].        param
+000499f0: 5f64 6963 745b 274f 6d2e 275d 203d 2073  _dict['Om.'] = s
+00049a00: 7074 5b27 5243 4153 434e 5256 275d 0a20  pt['RCASCNRV']. 
+00049a10: 2020 2020 2020 2070 6172 616d 5f64 6963         param_dic
+00049a20: 745b 2777 3027 5d20 3d20 7370 745b 2741  t['w0'] = spt['A
+00049a30: 5247 5045 5249 4727 5d0a 2020 2020 2020  RGPERIG'].      
+00049a40: 2020 7061 7261 6d5f 6469 6374 5b27 772e    param_dict['w.
+00049a50: 275d 203d 2073 7074 5b27 5243 4152 4750  '] = spt['RCARGP
+00049a60: 4552 275d 0a20 2020 2020 2020 2070 6172  ER'].        par
+00049a70: 616d 5f64 6963 745b 2763 6f73 6927 5d20  am_dict['cosi'] 
+00049a80: 3d20 7370 745b 2743 4f53 494e 434c 4927  = spt['COSINCLI'
+00049a90: 5d0a 2020 2020 2020 2020 7061 7261 6d5f  ].        param_
+00049aa0: 6469 6374 5b27 7369 6e69 275d 203d 2073  dict['sini'] = s
+00049ab0: 7074 5b27 5349 4e45 494e 434c 275d 0a20  pt['SINEINCL']. 
+00049ac0: 2020 2020 2020 2070 6172 616d 5f64 6963         param_dic
+00049ad0: 745b 2756 6327 5d20 3d20 7370 745b 2743  t['Vc'] = spt['C
+00049ae0: 4952 5645 4c4f 4327 5d0a 2020 2020 2020  IRVELOC'].      
+00049af0: 2020 7061 7261 6d5f 6469 6374 5b27 7469    param_dict['ti
+00049b00: 6d65 6666 6563 275d 203d 2073 7074 5b27  meffec'] = spt['
+00049b10: 5449 4d45 4646 4543 275d 0a20 2020 2020  TIMEFFEC'].     
+00049b20: 2020 2070 6172 616d 5f64 6963 745b 2754     param_dict['T
+00049b30: 6f72 6227 5d20 3d20 7370 745b 2748 5354  orb'] = spt['HST
+00049b40: 484f 5242 275d 2a32 0a20 2020 2020 2020  HORB']*2.       
+00049b50: 2070 6172 616d 5f64 6963 745b 2774 7374   param_dict['tst
+00049b60: 6172 7427 5d20 3d20 7370 745b 274f 4253  art'] = spt['OBS
+00049b70: 5354 5254 5427 5d0a 2020 2020 2020 2020  STRTT'].        
+00049b80: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
+00049b90: 6963 745b 2774 6175 5f74 696d 6527 5d20  ict['tau_time'] 
+00049ba0: 3d20 7365 6c66 2e64 656c 7461 7428 7061  = self.deltat(pa
+00049bb0: 7261 6d5f 6469 6374 5b27 7461 7527 5d29  ram_dict['tau'])
+00049bc0: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
+00049bd0: 6963 745b 2774 7374 6172 745f 7469 6d65  ict['tstart_time
+00049be0: 275d 203d 2073 656c 662e 6465 6c74 6174  '] = self.deltat
+00049bf0: 2870 6172 616d 5f64 6963 745b 2774 7374  (param_dict['tst
+00049c00: 6172 7427 5d29 0a20 2020 2020 2020 2020  art']).         
+00049c10: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00049c20: 7265 7475 726e 2070 6172 616d 5f64 6963  return param_dic
+00049c30: 740a 2020 2020 0a20 2020 2040 7374 6174  t.    .    @stat
+00049c40: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00049c50: 2078 797a 5f74 6f5f 6c6f 6e6c 6174 2873   xyz_to_lonlat(s
+00049c60: 656c 662c 2078 2c20 792c 207a 2c20 7261  elf, x, y, z, ra
+00049c70: 6469 616e 733d 4661 6c73 6529 3a0a 2020  dians=False):.  
+00049c80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00049c90: 2020 436f 6d70 7574 6520 7375 626c 6f6e    Compute sublon
+00049ca0: 2c20 7375 626c 6174 2c20 616c 7420 6672  , sublat, alt fr
+00049cb0: 6f6d 2078 797a 2063 6f6f 7264 7320 7769  om xyz coords wi
+00049cc0: 7468 2070 7970 726f 6a0a 2020 2020 2020  th pyproj.      
+00049cd0: 2020 0a20 2020 2020 2020 2078 797a 206d    .        xyz m
+00049ce0: 7573 7420 6265 2069 6e20 6d65 7465 7273  ust be in meters
+00049cf0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00049d00: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
+00049d10: 706f 7274 2070 7970 726f 6a0a 2020 2020  port pyproj.    
+00049d20: 2020 2020 6563 6566 203d 2070 7970 726f      ecef = pypro
+00049d30: 6a2e 5072 6f6a 2870 726f 6a3d 2767 656f  j.Proj(proj='geo
+00049d40: 6365 6e74 272c 2065 6c6c 7073 3d27 5747  cent', ellps='WG
+00049d50: 5338 3427 2c20 6461 7475 6d3d 2757 4753  S84', datum='WGS
+00049d60: 3834 2729 0a20 2020 2020 2020 206c 6c61  84').        lla
+00049d70: 203d 2070 7970 726f 6a2e 5072 6f6a 2870   = pyproj.Proj(p
+00049d80: 726f 6a3d 276c 6174 6c6f 6e67 272c 2065  roj='latlong', e
+00049d90: 6c6c 7073 3d27 5747 5338 3427 2c20 6461  llps='WGS84', da
+00049da0: 7475 6d3d 2757 4753 3834 2729 0a20 2020  tum='WGS84').   
+00049db0: 2020 2020 206c 6f6e 2c20 6c61 742c 2061       lon, lat, a
+00049dc0: 6c74 203d 2070 7970 726f 6a2e 7472 616e  lt = pyproj.tran
+00049dd0: 7366 6f72 6d28 6563 6566 2c20 6c6c 612c  sform(ecef, lla,
+00049de0: 2078 2c20 792c 207a 2c20 7261 6469 616e   x, y, z, radian
+00049df0: 733d 7261 6469 616e 7329 0a20 2020 2020  s=radians).     
+00049e00: 2020 2072 6574 7572 6e20 6c6f 6e2c 206c     return lon, l
+00049e10: 6174 2c20 616c 740a 0a0a 6465 6620 7061  at, alt...def pa
+00049e20: 7463 685f 7068 6f74 7574 696c 7328 293a  tch_photutils():
+00049e30: 0a20 2020 2022 2222 0a20 2020 2050 6174  .    """.    Pat
+00049e40: 6368 2074 6f20 6669 7820 696e 636f 6e73  ch to fix incons
+00049e50: 6973 7465 6e63 7920 7769 7468 2064 7269  istency with dri
+00049e60: 7a7a 6c65 7061 633d 332e 322e 3120 616e  zzlepac=3.2.1 an
+00049e70: 6420 7068 6f74 7574 696c 733e 312e 302c  d photutils>1.0,
+00049e80: 2077 6865 7265 200a 2020 2020 5468 6520   where .    The 
+00049e90: 6c61 7474 6572 2069 7320 6e65 6564 6564  latter is needed
+00049ea0: 2066 6f72 206a 7773 743d 312e 332e 320a   for jwst=1.3.2.
+00049eb0: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
+00049ec0: 7274 206f 730a 0a20 2020 2074 7279 3a0a  rt os..    try:.
+00049ed0: 2020 2020 2020 2020 696d 706f 7274 2064          import d
+00049ee0: 7269 7a7a 6c65 7061 630a 2020 2020 6578  rizzlepac.    ex
+00049ef0: 6365 7074 2041 7474 7269 6275 7465 4572  cept AttributeEr
+00049f00: 726f 723a 0a20 2020 200a 2020 2020 2020  ror:.    .      
+00049f10: 2020 696d 706f 7274 2070 686f 7475 7469    import photuti
+00049f20: 6c73 0a20 2020 2020 2020 2073 6974 655f  ls.        site_
+00049f30: 7061 636b 6167 6573 203d 206f 732e 7061  packages = os.pa
+00049f40: 7468 2e64 6972 6e61 6d65 2870 686f 7475  th.dirname(photu
+00049f50: 7469 6c73 2e5f 5f66 696c 655f 5f29 0a20  tils.__file__). 
+00049f60: 2020 2020 2020 2023 206d 616e 7561 6c20         # manual 
+00049f70: 6170 706c 7920 7061 7463 680a 2020 2020  apply patch.    
+00049f80: 2020 2020 7468 655f 6669 6c65 203d 2066      the_file = f
+00049f90: 277b 7369 7465 5f70 6163 6b61 6765 737d  '{site_packages}
+00049fa0: 2f2e 2e2f 6472 697a 7a6c 6570 6163 2f68  /../drizzlepac/h
+00049fb0: 6170 7574 696c 732f 616c 6967 6e5f 7574  aputils/align_ut
+00049fc0: 696c 732e 7079 270a 2020 2020 2020 2020  ils.py'.        
+00049fd0: 7769 7468 206f 7065 6e28 7468 655f 6669  with open(the_fi
+00049fe0: 6c65 2c27 7227 2920 6173 2066 703a 0a20  le,'r') as fp:. 
+00049ff0: 2020 2020 2020 2020 2020 206c 696e 6573             lines
+0004a000: 203d 2066 702e 7265 6164 6c69 6e65 7328   = fp.readlines(
+0004a010: 290a 2020 2020 0a20 2020 2020 2020 2070  ).    .        p
+0004a020: 7269 6e74 2873 6974 655f 7061 636b 6167  rint(site_packag
+0004a030: 6573 2c20 6c65 6e28 6c69 6e65 7329 290a  es, len(lines)).
+0004a040: 2020 2020 2020 2020 666f 7220 692c 206c          for i, l
+0004a050: 696e 6520 696e 2065 6e75 6d65 7261 7465  ine in enumerate
+0004a060: 286c 696e 6573 293a 0a20 2020 2020 2020  (lines):.       
+0004a070: 2020 2020 2069 6620 6c69 6e65 2e73 7461       if line.sta
+0004a080: 7274 7377 6974 6828 274e 6f44 6574 6563  rtswith('NoDetec
+0004a090: 7469 6f6e 7357 6172 6e69 6e67 2729 3a0a  tionsWarning'):.
+0004a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a0b0: 6272 6561 6b0a 2020 2020 0a20 2020 2020  break.    .     
+0004a0c0: 2020 2069 6620 2768 6173 6174 7472 2870     if 'hasattr(p
+0004a0d0: 686f 7475 7469 6c73 2e66 696e 6473 7461  hotutils.findsta
+0004a0e0: 7273 2720 696e 206c 696e 6573 5b69 2b31  rs' in lines[i+1
+0004a0f0: 5d3a 0a20 2020 2020 2020 2020 2020 2070  ]:.            p
+0004a100: 7269 6e74 2866 2749 2066 6f75 6e64 2074  rint(f'I found t
+0004a110: 6865 2070 726f 626c 656d 206f 6e20 6c69  he problem on li
+0004a120: 6e65 7320 7b69 7d2d 7b69 2b32 7d3a 2027  nes {i}-{i+2}: '
+0004a130: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0004a140: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0004a150: 3d20 2222 220a 4c69 6e65 7320 7b30 7d2d  = """.Lines {0}-
+0004a160: 7b31 7d20 696e 207b 327d 2069 6d70 6f72  {1} in {2} impor
+0004a170: 7469 6e67 2070 686f 7475 7469 6c73 2077  ting photutils w
+0004a180: 6572 6520 6e6f 7420 6173 2065 7870 6563  ere not as expec
+0004a190: 7465 642e 2020 4920 666f 756e 6420 0a0a  ted.  I found ..
+0004a1a0: 7b33 7d0a 0a62 7574 2065 7870 6563 7465  {3}..but expecte
+0004a1b0: 6420 0a0a 2020 204e 6f44 6574 6563 7469  d ..   NoDetecti
+0004a1c0: 6f6e 7357 6172 6e69 6e67 203d 2070 686f  onsWarning = pho
+0004a1d0: 7475 7469 6c73 2e66 696e 6473 7461 7273  tutils.findstars
+0004a1e0: 2e4e 6f44 6574 6563 7469 6f6e 7357 6172  .NoDetectionsWar
+0004a1f0: 6e69 6e67 2069 6620 5c5c 0a20 2020 2020  ning if \\.     
+0004a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a210: 2020 2020 2020 6861 7361 7474 7228 7068        hasattr(ph
+0004a220: 6f74 7574 696c 732e 6669 6e64 7374 6172  otutils.findstar
+0004a230: 732c 2027 4e6f 4465 7465 6374 696f 6e73  s, 'NoDetections
+0004a240: 5761 726e 696e 6727 2920 656c 7365 205c  Warning') else \
+0004a250: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+0004a260: 2020 2020 2020 2020 2020 2020 2070 686f               pho
+0004a270: 7475 7469 6c73 2e75 7469 6c73 2e4e 6f44  tutils.utils.NoD
+0004a280: 6574 6563 7469 6f6e 7357 6172 6e69 6e67  etectionsWarning
+0004a290: 0a0a 0a20 2020 2022 2222 2e66 6f72 6d61  ...    """.forma
+0004a2a0: 7428 692c 2069 2b32 2c20 7468 655f 6669  t(i, i+2, the_fi
+0004a2b0: 6c65 2c20 6c69 6e65 735b 693a 692b 335d  le, lines[i:i+3]
+0004a2c0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+0004a2d0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0004a2e0: 7565 4572 726f 7228 6d73 6729 0a20 2020  ueError(msg).   
+0004a2f0: 2020 2020 200a 2020 2020 2020 2020 6261       .        ba
+0004a300: 6420 3d20 5b27 2020 2027 2b6c 696e 6573  d = ['   '+lines
+0004a310: 2e70 6f70 2869 2b32 2d6a 2920 666f 7220  .pop(i+2-j) for 
+0004a320: 6a20 696e 2072 616e 6765 2833 295d 0a20  j in range(3)]. 
+0004a330: 2020 2020 2020 2070 7269 6e74 2827 272e         print(''.
+0004a340: 6a6f 696e 2862 6164 5b3a 3a2d 315d 2929  join(bad[::-1]))
+0004a350: 0a0a 2020 2020 2020 2020 2320 496e 7365  ..        # Inse
+0004a360: 7274 2074 6865 2066 6978 0a20 2020 2020  rt the fix.     
+0004a370: 2020 206c 696e 6573 5b69 5d20 3d20 2766     lines[i] = 'f
+0004a380: 726f 6d20 7068 6f74 7574 696c 732e 7574  rom photutils.ut
+0004a390: 696c 732e 6578 6365 7074 696f 6e73 2069  ils.exceptions i
+0004a3a0: 6d70 6f72 7420 4e6f 4465 7465 6374 696f  mport NoDetectio
+0004a3b0: 6e73 5761 726e 696e 675c 6e5c 6e27 0a20  nsWarning\n\n'. 
+0004a3c0: 2020 2020 2020 2023 2052 6577 7269 7465         # Rewrite
+0004a3d0: 2074 6865 2066 6965 0a20 2020 2020 2020   the fie.       
+0004a3e0: 2077 6974 6820 6f70 656e 2866 277b 7369   with open(f'{si
+0004a3f0: 7465 5f70 6163 6b61 6765 737d 2f2e 2e2f  te_packages}/../
+0004a400: 6472 697a 7a6c 6570 6163 2f68 6170 7574  drizzlepac/haput
+0004a410: 696c 732f 616c 6967 6e5f 7574 696c 732e  ils/align_utils.
+0004a420: 7079 272c 2777 2729 2061 7320 6670 3a0a  py','w') as fp:.
+0004a430: 2020 2020 2020 2020 2020 2020 6670 2e77              fp.w
+0004a440: 7269 7465 6c69 6e65 7328 6c69 6e65 7329  ritelines(lines)
+0004a450: 0a20 2020 200a 2020 2020 2020 2020 7072  .    .        pr
+0004a460: 696e 7428 6627 5061 7463 6820 6170 706c  int(f'Patch appl
+0004a470: 6965 6420 746f 207b 7468 655f 6669 6c65  ied to {the_file
+0004a480: 7d21 2729 0a                             }!').
```

### Comparing `grizli-1.8.9/grizli/utils_c/disperse.c` & `grizli-1.9/grizli/utils_c/disperse.c`

 * *Files 3% similar despite different names*

```diff
@@ -1,27 +1,27 @@
-/* Generated by Cython 0.29.34 */
+/* Generated by Cython 0.29.36 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "define_macros": [
             [
                 "NPY_NO_DEPRECATED_API",
                 "NPY_1_7_API_VERSION"
             ]
         ],
         "depends": [
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
         ],
         "include_dirs": [
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include"
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include"
         ],
         "libraries": [
             "m"
         ],
         "name": "grizli.utils_c.disperse",
         "sources": [
             "grizli/utils_c/disperse.pyx"
@@ -36,16 +36,16 @@
 #endif /* PY_SSIZE_T_CLEAN */
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_34"
-#define CYTHON_HEX_VERSION 0x001D22F0
+#define CYTHON_ABI "0_29_36"
+#define CYTHON_HEX_VERSION 0x001D24F0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -105,18 +105,22 @@
   #define CYTHON_ASSUME_SAFE_MACROS 0
   #undef CYTHON_UNPACK_METHODS
   #define CYTHON_UNPACK_METHODS 0
   #undef CYTHON_FAST_THREAD_STATE
   #define CYTHON_FAST_THREAD_STATE 0
   #undef CYTHON_FAST_PYCALL
   #define CYTHON_FAST_PYCALL 0
-  #undef CYTHON_PEP489_MULTI_PHASE_INIT
-  #define CYTHON_PEP489_MULTI_PHASE_INIT 0
+  #if PY_VERSION_HEX < 0x03090000
+    #undef CYTHON_PEP489_MULTI_PHASE_INIT
+    #define CYTHON_PEP489_MULTI_PHASE_INIT 0
+  #elif !defined(CYTHON_PEP489_MULTI_PHASE_INIT)
+    #define CYTHON_PEP489_MULTI_PHASE_INIT 1
+  #endif
   #undef CYTHON_USE_TP_FINALIZE
-  #define CYTHON_USE_TP_FINALIZE 0
+  #define CYTHON_USE_TP_FINALIZE (PY_VERSION_HEX >= 0x030400a1 && PYPY_VERSION_NUM >= 0x07030C00)
   #undef CYTHON_USE_DICT_VERSIONS
   #define CYTHON_USE_DICT_VERSIONS 0
   #undef CYTHON_USE_EXC_INFO_STACK
   #define CYTHON_USE_EXC_INFO_STACK 0
   #ifndef CYTHON_UPDATE_DESCRIPTOR_DOC
     #define CYTHON_UPDATE_DESCRIPTOR_DOC 0
   #endif
@@ -392,17 +396,14 @@
   #elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L
     #define CYTHON_INLINE inline
   #else
     #define CYTHON_INLINE
   #endif
 #endif
 
-#if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX < 0x02070600 && !defined(Py_OptimizeFlag)
-  #define Py_OptimizeFlag 0
-#endif
 #define __PYX_BUILD_PY_SSIZE_T "n"
 #define CYTHON_FORMAT_SSIZE_T "z"
 #if PY_MAJOR_VERSION < 3
   #define __Pyx_BUILTIN_MODULE_NAME "__builtin__"
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a+k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
   #define __Pyx_DefaultClassType PyClass_Type
@@ -472,14 +473,19 @@
     }
 #else
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
 #endif
   #define __Pyx_DefaultClassType PyType_Type
 #endif
+#if PY_VERSION_HEX >= 0x030900F0 && !CYTHON_COMPILING_IN_PYPY
+  #define __Pyx_PyObject_GC_IsFinalized(o) PyObject_GC_IsFinalized(o)
+#else
+  #define __Pyx_PyObject_GC_IsFinalized(o) _PyGC_FINALIZED(o)
+#endif
 #ifndef Py_TPFLAGS_CHECKTYPES
   #define Py_TPFLAGS_CHECKTYPES 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_INDEX
   #define Py_TPFLAGS_HAVE_INDEX 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_NEWBUFFER
@@ -1051,195 +1057,195 @@
   char enc_type;
   char new_packmode;
   char enc_packmode;
   char is_valid_array;
 } __Pyx_BufFmt_Context;
 
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":690
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":690
  * # in Cython to enable them only on the right systems.
  * 
  * ctypedef npy_int8       int8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  */
 typedef npy_int8 __pyx_t_5numpy_int8_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":691
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":691
  * 
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t
  */
 typedef npy_int16 __pyx_t_5numpy_int16_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":692
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":692
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int64      int64_t
  * #ctypedef npy_int96      int96_t
  */
 typedef npy_int32 __pyx_t_5numpy_int32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":693
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":693
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_int96      int96_t
  * #ctypedef npy_int128     int128_t
  */
 typedef npy_int64 __pyx_t_5numpy_int64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":697
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":697
  * #ctypedef npy_int128     int128_t
  * 
  * ctypedef npy_uint8      uint8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  */
 typedef npy_uint8 __pyx_t_5numpy_uint8_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":698
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":698
  * 
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t
  */
 typedef npy_uint16 __pyx_t_5numpy_uint16_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":699
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":699
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint64     uint64_t
  * #ctypedef npy_uint96     uint96_t
  */
 typedef npy_uint32 __pyx_t_5numpy_uint32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":700
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":700
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_uint96     uint96_t
  * #ctypedef npy_uint128    uint128_t
  */
 typedef npy_uint64 __pyx_t_5numpy_uint64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":704
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":704
  * #ctypedef npy_uint128    uint128_t
  * 
  * ctypedef npy_float32    float32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_float64    float64_t
  * #ctypedef npy_float80    float80_t
  */
 typedef npy_float32 __pyx_t_5numpy_float32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":705
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":705
  * 
  * ctypedef npy_float32    float32_t
  * ctypedef npy_float64    float64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_float80    float80_t
  * #ctypedef npy_float128   float128_t
  */
 typedef npy_float64 __pyx_t_5numpy_float64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":714
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":714
  * # The int types are mapped a bit surprising --
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t
  */
 typedef npy_long __pyx_t_5numpy_int_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":715
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":715
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   longlong_t
  * 
  */
 typedef npy_longlong __pyx_t_5numpy_long_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":716
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":716
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_ulong      uint_t
  */
 typedef npy_longlong __pyx_t_5numpy_longlong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":718
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":718
  * ctypedef npy_longlong   longlong_t
  * 
  * ctypedef npy_ulong      uint_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t
  */
 typedef npy_ulong __pyx_t_5numpy_uint_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":719
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":719
  * 
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":720
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":720
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_intp       intp_t
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulonglong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":722
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":722
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  * ctypedef npy_intp       intp_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uintp      uintp_t
  * 
  */
 typedef npy_intp __pyx_t_5numpy_intp_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":723
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":723
  * 
  * ctypedef npy_intp       intp_t
  * ctypedef npy_uintp      uintp_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_double     float_t
  */
 typedef npy_uintp __pyx_t_5numpy_uintp_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":725
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":725
  * ctypedef npy_uintp      uintp_t
  * 
  * ctypedef npy_double     float_t             # <<<<<<<<<<<<<<
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t
  */
 typedef npy_double __pyx_t_5numpy_float_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":726
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":726
  * 
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longdouble longdouble_t
  * 
  */
 typedef npy_double __pyx_t_5numpy_double_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":727
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":727
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cfloat      cfloat_t
  */
 typedef npy_longdouble __pyx_t_5numpy_longdouble_t;
@@ -1320,42 +1326,42 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 
 /*--- Type declarations ---*/
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":729
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":729
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
  */
 typedef npy_cfloat __pyx_t_5numpy_cfloat_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":730
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":730
  * 
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t             # <<<<<<<<<<<<<<
  * ctypedef npy_clongdouble clongdouble_t
  * 
  */
 typedef npy_cdouble __pyx_t_5numpy_cdouble_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":731
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":731
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cdouble     complex_t
  */
 typedef npy_clongdouble __pyx_t_5numpy_clongdouble_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":733
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":733
  * ctypedef npy_clongdouble clongdouble_t
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
@@ -1550,30 +1556,30 @@
 #define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
 #endif
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
 /* TypeImport.proto */
-#ifndef __PYX_HAVE_RT_ImportType_proto
-#define __PYX_HAVE_RT_ImportType_proto
+#ifndef __PYX_HAVE_RT_ImportType_proto_0_29_36
+#define __PYX_HAVE_RT_ImportType_proto_0_29_36
 #if __STDC_VERSION__ >= 201112L
 #include <stdalign.h>
 #endif
 #if __STDC_VERSION__ >= 201112L || __cplusplus >= 201103L
-#define __PYX_GET_STRUCT_ALIGNMENT(s) alignof(s)
+#define __PYX_GET_STRUCT_ALIGNMENT_0_29_36(s) alignof(s)
 #else
-#define __PYX_GET_STRUCT_ALIGNMENT(s) sizeof(void*)
+#define __PYX_GET_STRUCT_ALIGNMENT_0_29_36(s) sizeof(void*)
 #endif
-enum __Pyx_ImportType_CheckSize {
-   __Pyx_ImportType_CheckSize_Error = 0,
-   __Pyx_ImportType_CheckSize_Warn = 1,
-   __Pyx_ImportType_CheckSize_Ignore = 2
+enum __Pyx_ImportType_CheckSize_0_29_36 {
+   __Pyx_ImportType_CheckSize_Error_0_29_36 = 0,
+   __Pyx_ImportType_CheckSize_Warn_0_29_36 = 1,
+   __Pyx_ImportType_CheckSize_Ignore_0_29_36 = 2
 };
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size);
+static PyTypeObject *__Pyx_ImportType_0_29_36(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize_0_29_36 check_size);
 #endif
 
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* PyDictVersioning.proto */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
@@ -3498,15 +3504,15 @@
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ysens.rcbuffer->pybuffer);
   __pyx_L2:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":735
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -3515,29 +3521,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew1", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":736
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":736
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 736, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":735
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -3548,15 +3554,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":738
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -3565,29 +3571,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew2", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":739
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":739
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 739, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":738
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -3598,15 +3604,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":741
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -3615,29 +3621,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew3", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":742
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":742
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 742, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":741
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -3648,15 +3654,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":744
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -3665,29 +3671,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew4", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":745
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":745
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 745, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":744
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -3698,15 +3704,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":747
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -3715,29 +3721,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew5", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":748
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":748
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 748, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":747
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -3748,212 +3754,212 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":750
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyDataType_SHAPE(PyArray_Descr *__pyx_v_d) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("PyDataType_SHAPE", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":751
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   __pyx_t_1 = (PyDataType_HASSUBARRAY(__pyx_v_d) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":752
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":752
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape             # <<<<<<<<<<<<<<
  *     else:
  *         return ()
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(((PyObject*)__pyx_v_d->subarray->shape));
     __pyx_r = ((PyObject*)__pyx_v_d->subarray->shape);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":751
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":754
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":754
  *         return <tuple>d.subarray.shape
  *     else:
  *         return ()             # <<<<<<<<<<<<<<
  * 
  * 
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(__pyx_empty_tuple);
     __pyx_r = __pyx_empty_tuple;
     goto __pyx_L0;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":750
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":929
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
 static CYTHON_INLINE void __pyx_f_5numpy_set_array_base(PyArrayObject *__pyx_v_arr, PyObject *__pyx_v_base) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("set_array_base", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":930
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":930
  * 
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!             # <<<<<<<<<<<<<<
  *     PyArray_SetBaseObject(arr, base)
  * 
  */
   Py_INCREF(__pyx_v_base);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":931
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":931
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object get_array_base(ndarray arr):
  */
   (void)(PyArray_SetBaseObject(__pyx_v_arr, __pyx_v_base));
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":929
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":933
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_get_array_base(PyArrayObject *__pyx_v_arr) {
   PyObject *__pyx_v_base;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("get_array_base", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":934
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":934
  * 
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)             # <<<<<<<<<<<<<<
  *     if base is NULL:
  *         return None
  */
   __pyx_v_base = PyArray_BASE(__pyx_v_arr);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":935
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   __pyx_t_1 = ((__pyx_v_base == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":936
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":936
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  *         return None             # <<<<<<<<<<<<<<
  *     return <object>base
  * 
  */
     __Pyx_XDECREF(__pyx_r);
     __pyx_r = Py_None; __Pyx_INCREF(Py_None);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":935
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":937
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":937
  *     if base is NULL:
  *         return None
  *     return <object>base             # <<<<<<<<<<<<<<
  * 
  * # Versions of the import_* functions which are more suitable for
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_base));
   __pyx_r = ((PyObject *)__pyx_v_base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":933
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":941
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -3969,15 +3975,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_array", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
   {
@@ -3985,53 +3991,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":943
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":943
  * cdef inline int import_array() except -1:
  *     try:
  *         __pyx_import_array()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")
  */
       __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 943, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":944
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":944
  *     try:
  *         __pyx_import_array()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 944, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":945
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 945, __pyx_L5_except_error)
@@ -4039,30 +4045,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 945, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":941
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -4077,15 +4083,15 @@
   __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":947
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4101,15 +4107,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_umath", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -4117,53 +4123,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":949
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":949
  * cdef inline int import_umath() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 949, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":950
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":950
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 950, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":951
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 951, __pyx_L5_except_error)
@@ -4171,30 +4177,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 951, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":947
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4209,15 +4215,15 @@
   __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":953
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4233,15 +4239,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_ufunc", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -4249,53 +4255,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":955
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":955
  * cdef inline int import_ufunc() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 955, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":956
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":956
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 956, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":957
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":957
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef extern from *:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 957, __pyx_L5_except_error)
@@ -4303,30 +4309,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 957, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":953
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4341,176 +4347,176 @@
   __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":967
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_timedelta64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_timedelta64_object", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":979
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":979
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyTimedeltaArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyTimedeltaArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":967
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":982
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_datetime64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_datetime64_object", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":994
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":994
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyDatetimeArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyDatetimeArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":982
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":997
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
 static CYTHON_INLINE npy_datetime __pyx_f_5numpy_get_datetime64_value(PyObject *__pyx_v_obj) {
   npy_datetime __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1004
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1004
  *     also needed.  That can be found using `get_datetime64_unit`.
  *     """
  *     return (<PyDatetimeScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyDatetimeScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":997
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
 static CYTHON_INLINE npy_timedelta __pyx_f_5numpy_get_timedelta64_value(PyObject *__pyx_v_obj) {
   npy_timedelta __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1011
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1011
  *     returns the int64 value underlying scalar numpy timedelta64 object
  *     """
  *     return (<PyTimedeltaScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyTimedeltaScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
 static CYTHON_INLINE NPY_DATETIMEUNIT __pyx_f_5numpy_get_datetime64_unit(PyObject *__pyx_v_obj) {
   NPY_DATETIMEUNIT __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1018
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1018
  *     returns the unit part of the dtype for a numpy datetime64 object.
  *     """
  *     return <NPY_DATETIMEUNIT>(<PyDatetimeScalarObject*>obj).obmeta.base             # <<<<<<<<<<<<<<
  */
   __pyx_r = ((NPY_DATETIMEUNIT)((PyDatetimeScalarObject *)__pyx_v_obj)->obmeta.base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -4625,26 +4631,26 @@
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":945
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
   __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple_)) __PYX_ERR(1, 945, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple_);
   __Pyx_GIVEREF(__pyx_tuple_);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":951
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
   __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(1, 951, __pyx_L1_error)
@@ -4745,70 +4751,39 @@
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
   __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
+  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType_0_29_36(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
   #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
-  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyTypeObject),
+  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyTypeObject),
   #else
-  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyHeapTypeObject),
+  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyHeapTypeObject),
   #endif
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
+  __Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 200, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT(PyArray_Descr),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
-  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayIterObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
-  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayMultiIterObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
-  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
-  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
-  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
-  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
-  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
-  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
-  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
-  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
-  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
-  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
-  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
-  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT(PyUFuncObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
+  __pyx_ptype_5numpy_dtype = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArray_Descr),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
+  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayIterObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
+  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayMultiIterObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
+  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
+  __pyx_ptype_5numpy_generic = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
+  __pyx_ptype_5numpy_number = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
+  __pyx_ptype_5numpy_integer = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
+  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
+  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
+  __pyx_ptype_5numpy_inexact = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
+  __pyx_ptype_5numpy_floating = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
+  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
+  __pyx_ptype_5numpy_flexible = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
+  __pyx_ptype_5numpy_character = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
+  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyUFuncObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
   return -1;
@@ -5115,15 +5090,15 @@
  * import numpy as np
  */
   __pyx_t_1 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_1) < 0) __PYX_ERR(0, 2, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -6276,18 +6251,18 @@
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
 /* TypeImport */
-  #ifndef __PYX_HAVE_RT_ImportType
-#define __PYX_HAVE_RT_ImportType
-static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size)
+  #ifndef __PYX_HAVE_RT_ImportType_0_29_36
+#define __PYX_HAVE_RT_ImportType_0_29_36
+static PyTypeObject *__Pyx_ImportType_0_29_36(PyObject *module, const char *module_name, const char *class_name,
+    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize_0_29_36 check_size)
 {
     PyObject *result = 0;
     char warning[200];
     Py_ssize_t basicsize;
     Py_ssize_t itemsize;
 #ifdef Py_LIMITED_API
     PyObject *py_basicsize;
@@ -6333,22 +6308,22 @@
     if ((size_t)(basicsize + itemsize) < size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
-    if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
+    if (check_size == __Pyx_ImportType_CheckSize_Error_0_29_36 && (size_t)basicsize != size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
-    else if (check_size == __Pyx_ImportType_CheckSize_Warn && (size_t)basicsize > size) {
+    else if (check_size == __Pyx_ImportType_CheckSize_Warn_0_29_36 && (size_t)basicsize > size) {
         PyOS_snprintf(warning, sizeof(warning),
             "%s.%s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         if (PyErr_WarnEx(NULL, warning, 0) < 0) goto bad;
     }
     return (PyTypeObject *)result;
@@ -7119,15 +7094,15 @@
                         } else if (8 * sizeof(int) >= 4 * PyLong_SHIFT) {
                             return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -7391,15 +7366,15 @@
                         } else if (8 * sizeof(unsigned int) >= 4 * PyLong_SHIFT) {
                             return (unsigned int) (((((((((unsigned int)digits[3]) << PyLong_SHIFT) | (unsigned int)digits[2]) << PyLong_SHIFT) | (unsigned int)digits[1]) << PyLong_SHIFT) | (unsigned int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -7663,15 +7638,15 @@
                         } else if (8 * sizeof(long) >= 4 * PyLong_SHIFT) {
                             return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
```

### Comparing `grizli-1.8.9/grizli/utils_c/disperse.pyx` & `grizli-1.9/grizli/utils_c/disperse.pyx`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli/utils_c/interp.c` & `grizli-1.9/grizli/utils_c/interp.c`

 * *Files 0% similar despite different names*

```diff
@@ -1,27 +1,27 @@
-/* Generated by Cython 0.29.34 */
+/* Generated by Cython 0.29.36 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "define_macros": [
             [
                 "NPY_NO_DEPRECATED_API",
                 "NPY_1_7_API_VERSION"
             ]
         ],
         "depends": [
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
         ],
         "include_dirs": [
-            "/tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/core/include"
+            "/tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/core/include"
         ],
         "libraries": [
             "m"
         ],
         "name": "grizli.utils_c.interp",
         "sources": [
             "grizli/utils_c/interp.pyx"
@@ -36,16 +36,16 @@
 #endif /* PY_SSIZE_T_CLEAN */
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_34"
-#define CYTHON_HEX_VERSION 0x001D22F0
+#define CYTHON_ABI "0_29_36"
+#define CYTHON_HEX_VERSION 0x001D24F0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -105,18 +105,22 @@
   #define CYTHON_ASSUME_SAFE_MACROS 0
   #undef CYTHON_UNPACK_METHODS
   #define CYTHON_UNPACK_METHODS 0
   #undef CYTHON_FAST_THREAD_STATE
   #define CYTHON_FAST_THREAD_STATE 0
   #undef CYTHON_FAST_PYCALL
   #define CYTHON_FAST_PYCALL 0
-  #undef CYTHON_PEP489_MULTI_PHASE_INIT
-  #define CYTHON_PEP489_MULTI_PHASE_INIT 0
+  #if PY_VERSION_HEX < 0x03090000
+    #undef CYTHON_PEP489_MULTI_PHASE_INIT
+    #define CYTHON_PEP489_MULTI_PHASE_INIT 0
+  #elif !defined(CYTHON_PEP489_MULTI_PHASE_INIT)
+    #define CYTHON_PEP489_MULTI_PHASE_INIT 1
+  #endif
   #undef CYTHON_USE_TP_FINALIZE
-  #define CYTHON_USE_TP_FINALIZE 0
+  #define CYTHON_USE_TP_FINALIZE (PY_VERSION_HEX >= 0x030400a1 && PYPY_VERSION_NUM >= 0x07030C00)
   #undef CYTHON_USE_DICT_VERSIONS
   #define CYTHON_USE_DICT_VERSIONS 0
   #undef CYTHON_USE_EXC_INFO_STACK
   #define CYTHON_USE_EXC_INFO_STACK 0
   #ifndef CYTHON_UPDATE_DESCRIPTOR_DOC
     #define CYTHON_UPDATE_DESCRIPTOR_DOC 0
   #endif
@@ -392,17 +396,14 @@
   #elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L
     #define CYTHON_INLINE inline
   #else
     #define CYTHON_INLINE
   #endif
 #endif
 
-#if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX < 0x02070600 && !defined(Py_OptimizeFlag)
-  #define Py_OptimizeFlag 0
-#endif
 #define __PYX_BUILD_PY_SSIZE_T "n"
 #define CYTHON_FORMAT_SSIZE_T "z"
 #if PY_MAJOR_VERSION < 3
   #define __Pyx_BUILTIN_MODULE_NAME "__builtin__"
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a+k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
   #define __Pyx_DefaultClassType PyClass_Type
@@ -472,14 +473,19 @@
     }
 #else
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
 #endif
   #define __Pyx_DefaultClassType PyType_Type
 #endif
+#if PY_VERSION_HEX >= 0x030900F0 && !CYTHON_COMPILING_IN_PYPY
+  #define __Pyx_PyObject_GC_IsFinalized(o) PyObject_GC_IsFinalized(o)
+#else
+  #define __Pyx_PyObject_GC_IsFinalized(o) _PyGC_FINALIZED(o)
+#endif
 #ifndef Py_TPFLAGS_CHECKTYPES
   #define Py_TPFLAGS_CHECKTYPES 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_INDEX
   #define Py_TPFLAGS_HAVE_INDEX 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_NEWBUFFER
@@ -1051,195 +1057,195 @@
   char enc_type;
   char new_packmode;
   char enc_packmode;
   char is_valid_array;
 } __Pyx_BufFmt_Context;
 
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":690
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":690
  * # in Cython to enable them only on the right systems.
  * 
  * ctypedef npy_int8       int8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  */
 typedef npy_int8 __pyx_t_5numpy_int8_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":691
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":691
  * 
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t
  */
 typedef npy_int16 __pyx_t_5numpy_int16_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":692
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":692
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int64      int64_t
  * #ctypedef npy_int96      int96_t
  */
 typedef npy_int32 __pyx_t_5numpy_int32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":693
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":693
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_int96      int96_t
  * #ctypedef npy_int128     int128_t
  */
 typedef npy_int64 __pyx_t_5numpy_int64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":697
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":697
  * #ctypedef npy_int128     int128_t
  * 
  * ctypedef npy_uint8      uint8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  */
 typedef npy_uint8 __pyx_t_5numpy_uint8_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":698
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":698
  * 
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t
  */
 typedef npy_uint16 __pyx_t_5numpy_uint16_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":699
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":699
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint64     uint64_t
  * #ctypedef npy_uint96     uint96_t
  */
 typedef npy_uint32 __pyx_t_5numpy_uint32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":700
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":700
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_uint96     uint96_t
  * #ctypedef npy_uint128    uint128_t
  */
 typedef npy_uint64 __pyx_t_5numpy_uint64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":704
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":704
  * #ctypedef npy_uint128    uint128_t
  * 
  * ctypedef npy_float32    float32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_float64    float64_t
  * #ctypedef npy_float80    float80_t
  */
 typedef npy_float32 __pyx_t_5numpy_float32_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":705
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":705
  * 
  * ctypedef npy_float32    float32_t
  * ctypedef npy_float64    float64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_float80    float80_t
  * #ctypedef npy_float128   float128_t
  */
 typedef npy_float64 __pyx_t_5numpy_float64_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":714
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":714
  * # The int types are mapped a bit surprising --
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t
  */
 typedef npy_long __pyx_t_5numpy_int_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":715
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":715
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   longlong_t
  * 
  */
 typedef npy_longlong __pyx_t_5numpy_long_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":716
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":716
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_ulong      uint_t
  */
 typedef npy_longlong __pyx_t_5numpy_longlong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":718
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":718
  * ctypedef npy_longlong   longlong_t
  * 
  * ctypedef npy_ulong      uint_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t
  */
 typedef npy_ulong __pyx_t_5numpy_uint_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":719
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":719
  * 
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":720
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":720
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_intp       intp_t
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulonglong_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":722
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":722
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  * ctypedef npy_intp       intp_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uintp      uintp_t
  * 
  */
 typedef npy_intp __pyx_t_5numpy_intp_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":723
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":723
  * 
  * ctypedef npy_intp       intp_t
  * ctypedef npy_uintp      uintp_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_double     float_t
  */
 typedef npy_uintp __pyx_t_5numpy_uintp_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":725
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":725
  * ctypedef npy_uintp      uintp_t
  * 
  * ctypedef npy_double     float_t             # <<<<<<<<<<<<<<
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t
  */
 typedef npy_double __pyx_t_5numpy_float_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":726
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":726
  * 
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longdouble longdouble_t
  * 
  */
 typedef npy_double __pyx_t_5numpy_double_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":727
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":727
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cfloat      cfloat_t
  */
 typedef npy_longdouble __pyx_t_5numpy_longdouble_t;
@@ -1293,42 +1299,42 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 
 /*--- Type declarations ---*/
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":729
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":729
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
  */
 typedef npy_cfloat __pyx_t_5numpy_cfloat_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":730
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":730
  * 
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t             # <<<<<<<<<<<<<<
  * ctypedef npy_clongdouble clongdouble_t
  * 
  */
 typedef npy_cdouble __pyx_t_5numpy_cdouble_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":731
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":731
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cdouble     complex_t
  */
 typedef npy_clongdouble __pyx_t_5numpy_clongdouble_t;
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":733
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":733
  * ctypedef npy_clongdouble clongdouble_t
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
@@ -1698,30 +1704,30 @@
 static int __Pyx_GetException(PyObject **type, PyObject **value, PyObject **tb);
 #endif
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
 /* TypeImport.proto */
-#ifndef __PYX_HAVE_RT_ImportType_proto
-#define __PYX_HAVE_RT_ImportType_proto
+#ifndef __PYX_HAVE_RT_ImportType_proto_0_29_36
+#define __PYX_HAVE_RT_ImportType_proto_0_29_36
 #if __STDC_VERSION__ >= 201112L
 #include <stdalign.h>
 #endif
 #if __STDC_VERSION__ >= 201112L || __cplusplus >= 201103L
-#define __PYX_GET_STRUCT_ALIGNMENT(s) alignof(s)
+#define __PYX_GET_STRUCT_ALIGNMENT_0_29_36(s) alignof(s)
 #else
-#define __PYX_GET_STRUCT_ALIGNMENT(s) sizeof(void*)
+#define __PYX_GET_STRUCT_ALIGNMENT_0_29_36(s) sizeof(void*)
 #endif
-enum __Pyx_ImportType_CheckSize {
-   __Pyx_ImportType_CheckSize_Error = 0,
-   __Pyx_ImportType_CheckSize_Warn = 1,
-   __Pyx_ImportType_CheckSize_Ignore = 2
+enum __Pyx_ImportType_CheckSize_0_29_36 {
+   __Pyx_ImportType_CheckSize_Error_0_29_36 = 0,
+   __Pyx_ImportType_CheckSize_Warn_0_29_36 = 1,
+   __Pyx_ImportType_CheckSize_Ignore_0_29_36 = 2
 };
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size);
+static PyTypeObject *__Pyx_ImportType_0_29_36(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize_0_29_36 check_size);
 #endif
 
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* CLineInTraceback.proto */
 #ifdef CYTHON_CLINE_IN_TRACEBACK
@@ -9106,15 +9112,15 @@
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_zgrid.rcbuffer->pybuffer);
   __pyx_L2:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":735
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -9123,29 +9129,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew1", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":736
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":736
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 736, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":735
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -9156,15 +9162,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":738
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -9173,29 +9179,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew2", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":739
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":739
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 739, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":738
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -9206,15 +9212,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":741
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -9223,29 +9229,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew3", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":742
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":742
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 742, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":741
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -9256,15 +9262,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":744
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -9273,29 +9279,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew4", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":745
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":745
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 745, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":744
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -9306,15 +9312,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":747
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -9323,29 +9329,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew5", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":748
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":748
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 748, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":747
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -9356,212 +9362,212 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":750
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyDataType_SHAPE(PyArray_Descr *__pyx_v_d) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("PyDataType_SHAPE", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":751
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   __pyx_t_1 = (PyDataType_HASSUBARRAY(__pyx_v_d) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":752
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":752
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape             # <<<<<<<<<<<<<<
  *     else:
  *         return ()
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(((PyObject*)__pyx_v_d->subarray->shape));
     __pyx_r = ((PyObject*)__pyx_v_d->subarray->shape);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":751
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":754
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":754
  *         return <tuple>d.subarray.shape
  *     else:
  *         return ()             # <<<<<<<<<<<<<<
  * 
  * 
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(__pyx_empty_tuple);
     __pyx_r = __pyx_empty_tuple;
     goto __pyx_L0;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":750
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":929
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
 static CYTHON_INLINE void __pyx_f_5numpy_set_array_base(PyArrayObject *__pyx_v_arr, PyObject *__pyx_v_base) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("set_array_base", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":930
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":930
  * 
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!             # <<<<<<<<<<<<<<
  *     PyArray_SetBaseObject(arr, base)
  * 
  */
   Py_INCREF(__pyx_v_base);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":931
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":931
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object get_array_base(ndarray arr):
  */
   (void)(PyArray_SetBaseObject(__pyx_v_arr, __pyx_v_base));
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":929
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":933
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_get_array_base(PyArrayObject *__pyx_v_arr) {
   PyObject *__pyx_v_base;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("get_array_base", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":934
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":934
  * 
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)             # <<<<<<<<<<<<<<
  *     if base is NULL:
  *         return None
  */
   __pyx_v_base = PyArray_BASE(__pyx_v_arr);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":935
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   __pyx_t_1 = ((__pyx_v_base == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":936
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":936
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  *         return None             # <<<<<<<<<<<<<<
  *     return <object>base
  * 
  */
     __Pyx_XDECREF(__pyx_r);
     __pyx_r = Py_None; __Pyx_INCREF(Py_None);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":935
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":937
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":937
  *     if base is NULL:
  *         return None
  *     return <object>base             # <<<<<<<<<<<<<<
  * 
  * # Versions of the import_* functions which are more suitable for
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_base));
   __pyx_r = ((PyObject *)__pyx_v_base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":933
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":941
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -9577,15 +9583,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_array", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
   {
@@ -9593,53 +9599,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":943
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":943
  * cdef inline int import_array() except -1:
  *     try:
  *         __pyx_import_array()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")
  */
       __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 943, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":944
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":944
  *     try:
  *         __pyx_import_array()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 944, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":945
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 945, __pyx_L5_except_error)
@@ -9647,30 +9653,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 945, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":942
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":941
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -9685,15 +9691,15 @@
   __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":947
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9709,15 +9715,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_umath", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -9725,53 +9731,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":949
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":949
  * cdef inline int import_umath() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 949, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":950
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":950
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 950, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":951
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 951, __pyx_L5_except_error)
@@ -9779,30 +9785,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 951, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":948
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":947
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9817,15 +9823,15 @@
   __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":953
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9841,15 +9847,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_ufunc", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -9857,53 +9863,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":955
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":955
  * cdef inline int import_ufunc() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 955, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":956
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":956
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 956, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":957
+      /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":957
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef extern from *:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 957, __pyx_L5_except_error)
@@ -9911,30 +9917,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 957, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":954
+    /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":953
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9949,176 +9955,176 @@
   __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":967
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_timedelta64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_timedelta64_object", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":979
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":979
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyTimedeltaArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyTimedeltaArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":967
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":982
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_datetime64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_datetime64_object", 0);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":994
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":994
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyDatetimeArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyDatetimeArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":982
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":997
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
 static CYTHON_INLINE npy_datetime __pyx_f_5numpy_get_datetime64_value(PyObject *__pyx_v_obj) {
   npy_datetime __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1004
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1004
  *     also needed.  That can be found using `get_datetime64_unit`.
  *     """
  *     return (<PyDatetimeScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyDatetimeScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":997
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
 static CYTHON_INLINE npy_timedelta __pyx_f_5numpy_get_timedelta64_value(PyObject *__pyx_v_obj) {
   npy_timedelta __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1011
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1011
  *     returns the int64 value underlying scalar numpy timedelta64 object
  *     """
  *     return (<PyTimedeltaScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyTimedeltaScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+/* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
 static CYTHON_INLINE NPY_DATETIMEUNIT __pyx_f_5numpy_get_datetime64_unit(PyObject *__pyx_v_obj) {
   NPY_DATETIMEUNIT __pyx_r;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1018
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1018
  *     returns the unit part of the dtype for a numpy datetime64 object.
  *     """
  *     return <NPY_DATETIMEUNIT>(<PyDatetimeScalarObject*>obj).obmeta.base             # <<<<<<<<<<<<<<
  */
   __pyx_r = ((NPY_DATETIMEUNIT)((PyDatetimeScalarObject *)__pyx_v_obj)->obmeta.base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -10332,26 +10338,26 @@
   __pyx_slice_ = PySlice_New(__pyx_int_1, Py_None, Py_None); if (unlikely(!__pyx_slice_)) __PYX_ERR(0, 121, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_slice_);
   __Pyx_GIVEREF(__pyx_slice_);
   __pyx_slice__2 = PySlice_New(Py_None, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__2)) __PYX_ERR(0, 121, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_slice__2);
   __Pyx_GIVEREF(__pyx_slice__2);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":945
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
   __pyx_tuple__3 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple__3)) __PYX_ERR(1, 945, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__3);
   __Pyx_GIVEREF(__pyx_tuple__3);
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":951
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
   __pyx_tuple__4 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(1, 951, __pyx_L1_error)
@@ -10566,70 +10572,39 @@
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
   __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
+  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType_0_29_36(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
   #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
-  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyTypeObject),
+  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyTypeObject),
   #else
-  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyHeapTypeObject),
+  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyHeapTypeObject),
   #endif
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
+  __Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 200, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT(PyArray_Descr),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
-  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayIterObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
-  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayMultiIterObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
-  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
-  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
-  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
-  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
-  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
-  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
-  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
-  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
-  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
-  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
-  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
-  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT(PyUFuncObject),
-  __Pyx_ImportType_CheckSize_Ignore);
-   if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
+  __pyx_ptype_5numpy_dtype = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArray_Descr),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
+  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayIterObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
+  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayMultiIterObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
+  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyArrayObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
+  __pyx_ptype_5numpy_generic = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
+  __pyx_ptype_5numpy_number = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
+  __pyx_ptype_5numpy_integer = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
+  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
+  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
+  __pyx_ptype_5numpy_inexact = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
+  __pyx_ptype_5numpy_floating = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
+  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
+  __pyx_ptype_5numpy_flexible = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
+  __pyx_ptype_5numpy_character = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyObject),__Pyx_ImportType_CheckSize_Warn_0_29_36); if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
+  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType_0_29_36(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT_0_29_36(PyUFuncObject),__Pyx_ImportType_CheckSize_Ignore_0_29_36); if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
   return -1;
@@ -11030,15 +11005,15 @@
  */
   __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_t_2, __pyx_kp_u_run_nmf_line_454, __pyx_kp_u_run_nmf_flux_variance_templates) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "../../../../../tmp/build-env-li2cf0ks/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-84denjl2/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -12921,18 +12896,18 @@
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
 /* TypeImport */
-    #ifndef __PYX_HAVE_RT_ImportType
-#define __PYX_HAVE_RT_ImportType
-static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size)
+    #ifndef __PYX_HAVE_RT_ImportType_0_29_36
+#define __PYX_HAVE_RT_ImportType_0_29_36
+static PyTypeObject *__Pyx_ImportType_0_29_36(PyObject *module, const char *module_name, const char *class_name,
+    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize_0_29_36 check_size)
 {
     PyObject *result = 0;
     char warning[200];
     Py_ssize_t basicsize;
     Py_ssize_t itemsize;
 #ifdef Py_LIMITED_API
     PyObject *py_basicsize;
@@ -12978,22 +12953,22 @@
     if ((size_t)(basicsize + itemsize) < size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
-    if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
+    if (check_size == __Pyx_ImportType_CheckSize_Error_0_29_36 && (size_t)basicsize != size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
-    else if (check_size == __Pyx_ImportType_CheckSize_Warn && (size_t)basicsize > size) {
+    else if (check_size == __Pyx_ImportType_CheckSize_Warn_0_29_36 && (size_t)basicsize > size) {
         PyOS_snprintf(warning, sizeof(warning),
             "%s.%s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         if (PyErr_WarnEx(NULL, warning, 0) < 0) goto bad;
     }
     return (PyTypeObject *)result;
@@ -13703,15 +13678,15 @@
                         } else if (8 * sizeof(short) >= 4 * PyLong_SHIFT) {
                             return (short) (((((((((short)digits[3]) << PyLong_SHIFT) | (short)digits[2]) << PyLong_SHIFT) | (short)digits[1]) << PyLong_SHIFT) | (short)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -13899,15 +13874,15 @@
                         } else if (8 * sizeof(int) >= 4 * PyLong_SHIFT) {
                             return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -14095,15 +14070,15 @@
                         } else if (8 * sizeof(long) >= 4 * PyLong_SHIFT) {
                             return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -14329,15 +14304,15 @@
                         } else if (8 * sizeof(unsigned long) >= 4 * PyLong_SHIFT) {
                             return (unsigned long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
@@ -14563,15 +14538,15 @@
                         } else if (8 * sizeof(unsigned int) >= 4 * PyLong_SHIFT) {
                             return (unsigned int) (((((((((unsigned int)digits[3]) << PyLong_SHIFT) | (unsigned int)digits[2]) << PyLong_SHIFT) | (unsigned int)digits[1]) << PyLong_SHIFT) | (unsigned int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
-#if CYTHON_COMPILING_IN_CPYTHON
+#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030C00A7
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
```

### Comparing `grizli-1.8.9/grizli/utils_c/interp.pyx` & `grizli-1.9/grizli/utils_c/interp.pyx`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/grizli.egg-info/PKG-INFO` & `grizli-1.9/grizli.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: grizli
-Version: 1.8.9
+Version: 1.9
 Summary: Grism redshift and line analysis software
 Home-page: https://github.com/gbrammer/grizli
 Author: G. Brammer
 Author-email: gbrammer@gmail.com
 License: MIT
 Project-URL: Documentation, https://grizli.readthedocs.io/
 Project-URL: Source, https://github.com/gbrammer/grizli
```

### Comparing `grizli-1.8.9/grizli.egg-info/SOURCES.txt` & `grizli-1.9/grizli.egg-info/SOURCES.txt`

 * *Files 2% similar despite different names*

```diff
@@ -74,16 +74,21 @@
 grizli/aws/visit_processor.py
 grizli/data/auto_script_defaults.yml
 grizli/data/db.yml
 grizli/data/gaia_dr2_vizier_columns.txt
 grizli/data/hst_encircled_energy.fits
 grizli/data/jwst_bp_info.yml
 grizli/data/nircam_wisp.yml
+grizli/data/nis_badpix_20230710.fits.gz
+grizli/data/nrc_badpix_20230710_NRCALONG.fits.gz
+grizli/data/nrc_badpix_20230710_NRCBLONG.fits.gz
 grizli/data/nrc_badpix_230120_NRCALONG.fits.gz
 grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz
+grizli/data/nrc_badpix_230701_NRCALONG.fits.gz
+grizli/data/nrc_badpix_230701_NRCBLONG.fits.gz
 grizli/data/nrc_lowpix_0916_NRCA1.fits.gz
 grizli/data/nrc_lowpix_0916_NRCA2.fits.gz
 grizli/data/nrc_lowpix_0916_NRCA3.fits.gz
 grizli/data/nrc_lowpix_0916_NRCA4.fits.gz
 grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz
 grizli/data/nrc_lowpix_0916_NRCB1.fits.gz
 grizli/data/nrc_lowpix_0916_NRCB2.fits.gz
```

### Comparing `grizli-1.8.9/setup.cfg` & `grizli-1.9/setup.cfg`

 * *Files 5% similar despite different names*

```diff
@@ -19,15 +19,15 @@
 
 [options]
 python_requires = >=3.7
 install_requires = 
 	astro-prospector
 	astropy
 	astroquery
-	eazy
+	eazy==0.6.5
 	extinction
 	mastquery>=1.7.1
 	matplotlib
 	numpy
 	peakutils
 	regions
 	scikit-image
```

### Comparing `grizli-1.8.9/setup.py` & `grizli-1.9/setup.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.9/test_pipeline_hst.py` & `grizli-1.9/test_pipeline_hst.py`

 * *Files identical despite different names*

